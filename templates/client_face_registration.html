
<!-- Face Registration Modal -->
<div class="modal fade" id="faceRegistrationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i data-feather="camera" class="me-2"></i>
                    Register Face for Check-In
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i data-feather="info" class="me-2"></i>
                    Position your face in the circle and click capture when ready
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="camera-container" style="position: relative; min-height: 400px; background: #f8f9fa; border-radius: 10px; overflow: hidden;">
                            <video id="faceRegVideo" autoplay playsinline style="width: 100%; height: 400px; object-fit: cover; display: none;"></video>
                            <div id="faceRegPlaceholder" class="text-center py-5">
                                <i data-feather="camera" style="width: 80px; height: 80px;" class="text-muted mb-3"></i>
                                <p class="text-muted">Click "Start Camera" to begin</p>
                            </div>
                            <div id="faceRegOverlay" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 6px solid #667eea; border-radius: 50%; width: 280px; height: 280px; pointer-events: none; z-index: 100; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5), 0 0 20px rgba(102, 126, 234, 0.6);"></div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="button" id="startFaceCamera" class="btn btn-success">
                                <i data-feather="play" class="me-1"></i> Start Camera
                            </button>
                            <button type="button" id="captureFaceBtn" class="btn btn-primary" disabled>
                                <i data-feather="camera" class="me-1"></i> Capture Face
                            </button>
                            <button type="button" id="stopFaceCamera" class="btn btn-secondary" disabled>
                                <i data-feather="stop-circle" class="me-1"></i> Stop
                            </button>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <h6>Preview</h6>
                        <div id="facePreviewContainer" style="display: none;">
                            <img id="facePreview" style="width: 100%; max-height: 400px; object-fit: cover; border-radius: 10px; border: 3px solid #28a745;">
                            <div class="mt-3">
                                <button type="button" id="saveFaceBtn" class="btn btn-success w-100">
                                    <i data-feather="save" class="me-1"></i> Save Face Registration
                                </button>
                                <button type="button" id="retakeFaceBtn" class="btn btn-warning w-100 mt-2">
                                    <i data-feather="refresh-cw" class="me-1"></i> Retake Photo
                                </button>
                            </div>
                        </div>
                        <div id="faceStatusMsg" class="alert alert-secondary mt-3">
                            <small>Camera not started</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let faceRegStream = null;
let currentCustomerId = null;

function openFaceRegistration(customerId) {
    currentCustomerId = customerId;
    const modal = new bootstrap.Modal(document.getElementById('faceRegistrationModal'));
    modal.show();
    feather.replace();
}

document.getElementById('startFaceCamera').addEventListener('click', async () => {
    try {
        faceRegStream = await navigator.mediaDevices.getUserMedia({ 
            video: { width: 640, height: 480, facingMode: 'user' } 
        });
        
        const video = document.getElementById('faceRegVideo');
        video.srcObject = faceRegStream;
        video.style.display = 'block';
        
        document.getElementById('faceRegPlaceholder').style.display = 'none';
        document.getElementById('faceRegOverlay').style.display = 'block';
        document.getElementById('startFaceCamera').disabled = true;
        document.getElementById('captureFaceBtn').disabled = false;
        document.getElementById('stopFaceCamera').disabled = false;
        document.getElementById('faceStatusMsg').innerHTML = '<small class="text-success">Camera ready - Position your face in circle</small>';
        
    } catch (err) {
        console.error('Camera error:', err);
        document.getElementById('faceStatusMsg').innerHTML = '<small class="text-danger">Camera access denied</small>';
    }
});

document.getElementById('captureFaceBtn').addEventListener('click', () => {
    const video = document.getElementById('faceRegVideo');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    
    const imageData = canvas.toDataURL('image/jpeg', 0.9);
    document.getElementById('facePreview').src = imageData;
    document.getElementById('facePreviewContainer').style.display = 'block';
    
    // Stop camera
    if (faceRegStream) {
        faceRegStream.getTracks().forEach(track => track.stop());
    }
    video.style.display = 'none';
    document.getElementById('faceRegOverlay').style.display = 'none';
    document.getElementById('captureFaceBtn').disabled = true;
    document.getElementById('stopFaceCamera').disabled = true;
});

document.getElementById('saveFaceBtn').addEventListener('click', async () => {
    const imageData = document.getElementById('facePreview').src;
    
    document.getElementById('faceStatusMsg').innerHTML = '<small class="text-info">Saving face registration...</small>';
    
    try {
        const response = await fetch('/api/face-registration/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                customer_id: currentCustomerId,
                face_image: imageData
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.duplicate_warning) {
                let warning = 'Face saved but duplicates found:\n\n';
                result.duplicates.forEach(d => {
                    warning += `- ${d.name} (${d.similarity} match)\n`;
                });
                alert(warning);
            }
            
            document.getElementById('faceStatusMsg').innerHTML = '<small class="text-success">✅ Face registered successfully!</small>';
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('faceRegistrationModal')).hide();
                location.reload();
            }, 1500);
        } else {
            document.getElementById('faceStatusMsg').innerHTML = `<small class="text-danger">❌ ${result.error}</small>`;
        }
    } catch (err) {
        document.getElementById('faceStatusMsg').innerHTML = '<small class="text-danger">Network error</small>';
    }
});

document.getElementById('retakeFaceBtn').addEventListener('click', () => {
    document.getElementById('facePreviewContainer').style.display = 'none';
    document.getElementById('startFaceCamera').disabled = false;
    document.getElementById('faceStatusMsg').innerHTML = '<small>Click "Start Camera" to retake</small>';
});

document.getElementById('stopFaceCamera').addEventListener('click', () => {
    if (faceRegStream) {
        faceRegStream.getTracks().forEach(track => track.stop());
        faceRegStream = null;
    }
    document.getElementById('faceRegVideo').style.display = 'none';
    document.getElementById('faceRegPlaceholder').style.display = 'block';
    document.getElementById('faceRegOverlay').style.display = 'none';
    document.getElementById('startFaceCamera').disabled = false;
    document.getElementById('captureFaceBtn').disabled = true;
    document.getElementById('stopFaceCamera').disabled = true;
});
</script>
