{% extends "base.html" %}

{% block title %}Staff Availability - Quick Booking{% endblock %}

{% block extra_head %}
<style>
.availability-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}

.staff-availability-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

.staff-header {
    background: #f8f9fa;
    padding: 1rem;
    text-align: center;
    border: 1px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    vertical-align: top;
    min-width: 200px;
}

.staff-photo {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 0.5rem;
    background: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    margin: 0 auto 0.5rem;
}

.time-slot {
    padding: 0.75rem;
    text-align: center;
    border: 1px solid #dee2e6;
    cursor: pointer;
    transition: all 0.3s ease;
    min-height: 60px;
    position: relative;
}

.time-label {
    background: #343a40;
    color: white;
    padding: 0.75rem;
    text-align: center;
    font-weight: 600;
    border: 1px solid #dee2e6;
    min-width: 100px;
}

.slot-available {
    background: #d4edda;
    color: #155724;
    border-color: #c3e6cb;
}

.slot-available:hover {
    background: #c3e6cb;
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.slot-booked {
    background: #f8d7da;
    color: #721c24;
    border-color: #f5c6cb;
    cursor: default;
}

.slot-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
}

.available-indicator {
    font-size: 1.2rem;
    margin-bottom: 0.25rem;
}

.booked-details {
    font-size: 0.8rem;
    font-weight: 600;
}

.client-name {
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.service-name {
    font-size: 0.75rem;
    opacity: 0.8;
}

.quick-book-modal .modal-content {
    border-radius: 20px;
    border: none;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.quick-book-modal .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px 20px 0 0;
    border-bottom: none;
}

.legend {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin: 1rem 0;
    padding: 1rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

.refresh-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.refresh-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 2rem;
}

@media (max-width: 768px) {
    .staff-availability-table {
        font-size: 0.85rem;
    }

    .staff-header {
        min-width: 150px;
        padding: 0.75rem 0.5rem;
    }

    .time-slot {
        padding: 0.5rem;
        min-height: 50px;
    }

    .legend {
        flex-direction: column;
        gap: 1rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="availability-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-1">
                    <i class="fas fa-users-cog me-3"></i>Staff Availability - Quick Booking
                </h2>
                <p class="mb-0 opacity-75">Double-click on available slots to book appointments instantly</p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn refresh-btn" onclick="refreshAvailability()">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Date Selection -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body py-3">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <strong>Selected Date:</strong>
                        </div>
                        <div class="col-auto">
                            <input type="date" id="selectedDate" class="form-control" 
                                   value="{{ selected_date.strftime('%Y-%m-%d') }}" 
                                   onchange="changeDate(this.value)">
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-primary btn-sm" onclick="goToToday()">
                                <i class="fas fa-calendar-day me-1"></i>Today
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <!-- Legend -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #d4edda;"></div>
                    <span>Available</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f8d7da;"></div>
                    <span>Booked</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading staff availability...</p>
    </div>

    <!-- Staff Availability Table -->
    <div class="row">
        <div class="col-12">
            <div class="table-responsive">
                <table class="staff-availability-table" id="availabilityTable">
                    <thead>
                        <tr>
                            <th class="time-label">Time</th>
                            {% for staff in staff_members %}
                            <th class="staff-header">
                                <div class="staff-photo">
                                    {% if staff.profile_photo_url %}
                                        <img src="{{ staff.profile_photo_url }}" alt="{{ staff.full_name }}" class="staff-photo">
                                    {% else %}
                                        {{ staff.first_name[0] }}{{ staff.last_name[0] if staff.last_name else '' }}
                                    {% endif %}
                                </div>
                                <div class="staff-name">{{ staff.full_name }}</div>
                                <small class="text-muted">{{ staff.designation or staff.role.title() }}</small>
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for time_slot in time_slots %}
                        <tr>
                            <td class="time-label">
                                {{ time_slot.start_time.strftime('%I:%M %p') }}
                            </td>
                            {% for staff in staff_members %}
                            <td class="time-slot {% set slot_key = (staff.id, time_slot.start_time) %}{% if staff_availability.get(slot_key) and staff_availability[slot_key].status == 'booked' %}slot-booked{% else %}slot-available{% endif %}"
                                data-staff-id="{{ staff.id }}"
                                data-staff-name="{{ staff.full_name }}"
                                data-time="{{ time_slot.start_time.strftime('%H:%M') }}"
                                data-datetime="{{ time_slot.start_time.strftime('%Y-%m-%d %H:%M') }}"
                                {% if not (staff_availability.get(slot_key) and staff_availability[slot_key].status == 'booked') %}
                                ondblclick="quickBookSlot(this)"
                                {% endif %}>

                                <div class="slot-content">
                                    {% set availability = staff_availability.get(slot_key) %}
                                    {% if availability and availability.status == 'booked' %}
                                        <div class="booked-details">
                                            <div class="client-name">{{ availability.client_name }}</div>
                                            <div class="service-name">{{ availability.service_name }}</div>
                                        </div>
                                    {% else %}
                                        <div class="available-indicator">
                                            <i class="fas fa-plus text-success"></i>
                                        </div>
                                        <small>Available</small>
                                    {% endif %}
                                </div>
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Quick Booking Modal -->
<div class="modal fade quick-book-modal" id="quickBookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-lightning-bolt me-2"></i>Quick Book Appointment
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickBookForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"><strong>Staff Member</strong></label>
                                <input type="text" id="modalStaffName" class="form-control" readonly>
                                <input type="hidden" id="modalStaffId">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"><strong>Time Slot</strong></label>
                                <input type="text" id="modalTimeSlot" class="form-control" readonly>
                                <input type="hidden" id="modalDateTime">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalClient" class="form-label"><strong>Select Client *</strong></label>
                                <select id="modalClient" class="form-select" required>
                                    <option value="">Choose a client...</option>
                                    {% for client in clients %}
                                    <option value="{{ client.id }}">{{ client.full_name }} - {{ client.phone }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="modalService" class="form-label"><strong>Select Service *</strong></label>
                                <select id="modalService" class="form-select" required>
                                    <option value="">Choose a service...</option>
                                    {% for service in services %}
                                    <option value="{{ service.id }}" data-price="{{ service.price }}" data-duration="{{ service.duration }}">
                                        {{ service.name }} - ${{ "%.2f"|format(service.price) }} ({{ service.duration }}min)
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="modalNotes" class="form-label">Notes (Optional)</label>
                        <textarea id="modalNotes" class="form-control" rows="2" placeholder="Any special requests or notes..."></textarea>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        This appointment will be scheduled immediately and marked as confirmed.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmQuickBooking()">
                    <i class="fas fa-check me-2"></i>Book Appointment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Button to trigger fetching all appointments -->
<div class="container mt-4">
    <button class="btn btn-outline-primary" onclick="getAllAppointments()">View All Appointments</button>
</div>

<!-- Container for displaying all appointments list (will be populated by JS) -->
<div id="appointmentsListContainer" class="mt-4"></div>

<script>
let quickBookModal;

document.addEventListener('DOMContentLoaded', function() {
    quickBookModal = new bootstrap.Modal(document.getElementById('quickBookModal'));
    console.log('Staff Availability view loaded successfully');
});

function quickBookSlot(element) {
    const staffId = element.dataset.staffId;
    const staffName = element.dataset.staffName;
    const time = element.dataset.time;
    const datetime = element.dataset.datetime;

    // Populate modal
    document.getElementById('modalStaffId').value = staffId;
    document.getElementById('modalStaffName').value = staffName;
    document.getElementById('modalTimeSlot').value = time;
    document.getElementById('modalDateTime').value = datetime;

    // Clear previous selections
    document.getElementById('modalClient').value = '';
    document.getElementById('modalService').value = '';
    document.getElementById('modalNotes').value = '';

    // Show modal
    quickBookModal.show();
}

function confirmQuickBooking() {
    const staffId = document.getElementById('modalStaffId').value;
    const clientId = document.getElementById('modalClient').value;
    const serviceId = document.getElementById('modalService').value;
    const datetime = document.getElementById('modalDateTime').value;
    const notes = document.getElementById('modalNotes').value;

    if (!clientId || !serviceId) {
        showNotification('Please select both client and service', 'error');
        return;
    }

    const bookingData = {
        staff_id: parseInt(staffId),
        client_id: parseInt(clientId),
        service_id: parseInt(serviceId),
        appointment_date: datetime.split(' ')[0],
        appointment_time: datetime.split(' ')[1],
        notes: notes
    };

    // Show loading
    const bookBtn = document.querySelector('#quickBookModal .btn-primary'); // Target the booking button within the modal
    const originalText = bookBtn.innerHTML;
    bookBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Booking...';
    bookBtn.disabled = true;

    fetch('/appointments/book', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(bookingData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Appointment booked successfully!', 'success');
            quickBookModal.hide();
            refreshAvailability();
        } else {
            showNotification(data.error || 'Failed to book appointment', 'error');
        }
    })
    .catch(error => {
        console.error('Booking error:', error);
        showNotification('Error booking appointment. Please try again.', 'error');
    })
    .finally(() => {
        bookBtn.innerHTML = originalText;
        bookBtn.disabled = false;
    });
}

function refreshAvailability() {
    const selectedDate = document.getElementById('selectedDate').value;

    // Show loading
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('availabilityTable').style.opacity = '0.5';

    // Reload page with current date
    window.location.href = `{{ url_for('staff_availability') }}?date=${selectedDate}`;
}

function changeDate(newDate) {
    window.location.href = `{{ url_for('staff_availability') }}?date=${newDate}`;
}

function goToToday() {
    const today = new Date().toISOString().split('T')[0];
    window.location.href = `{{ url_for('staff_availability') }}?date=${today}`;
}

// Notification system
function showNotification(message, type = 'info', duration = 5000) {
    const notificationContainer = document.getElementById('notificationContainer') || createNotificationContainer();

    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    };

    const iconClass = {
        'success': 'fas fa-check-circle',
        'error': 'fas fa-exclamation-triangle',
        'warning': 'fas fa-exclamation-circle',
        'info': 'fas fa-info-circle'
    };

    const notification = document.createElement('div');
    notification.className = `alert ${alertClass[type] || 'alert-info'} alert-dismissible fade show`;
    notification.innerHTML = `
        <i class="${iconClass[type] || 'fas fa-info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    notificationContainer.appendChild(notification);

    if (duration > 0) {
        setTimeout(() => {
            if (notification && notification.parentNode) {
                notification.remove();
            }
        }, duration);
    }
}

function createNotificationContainer() {
    const container = document.createElement('div');
    container.id = 'notificationContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '9999';
    document.body.appendChild(container);
    return container;
}

// Book appointment function
function bookAppointment(staffId, timeSlot, date) {
    console.log('Booking appointment:', { staffId, timeSlot, date });

    // Get form data
    const clientId = document.getElementById('clientSelect').value;
    const serviceId = document.getElementById('serviceSelect').value;
    const notes = document.getElementById('notesInput').value;

    if (!clientId || !serviceId) {
        alert('Please select both client and service');
        return;
    }

    const bookingData = {
        client_id: parseInt(clientId),
        service_id: parseInt(serviceId),
        staff_id: parseInt(staffId),
        appointment_date: date,
        appointment_time: timeSlot,
        notes: notes
    };

    console.log('Sending booking data:', bookingData);

    // Show loading state
    const bookButton = document.querySelector('.btn-book');
    const originalText = bookButton.innerHTML;
    bookButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Booking...';
    bookButton.disabled = true;

    // Send booking request
    fetch('/appointments/book', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(bookingData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Booking response:', data);

        if (data.success) {
            alert('Appointment booked successfully!');
            // Clear form
            document.getElementById('clientSelect').value = '';
            document.getElementById('serviceSelect').value = '';
            document.getElementById('notesInput').value = '';

            // Refresh the page to show the new booking
            window.location.reload();
        } else {
            alert('Error booking appointment: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error booking appointment: ' + error.message);
    })
    .finally(() => {
        // Restore button
        bookButton.innerHTML = originalText;
        bookButton.disabled = false;
    });
}

// Cancel appointment function
function cancelAppointment(appointmentId, staffId, timeSlot, date) {
    if (!confirm('Are you sure you want to cancel this appointment?')) {
        return;
    }

    const reason = prompt('Please enter cancellation reason (optional):');

    fetch(`/appointments/cancel/${appointmentId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ reason: reason || '' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Appointment cancelled successfully!');
            window.location.reload();
        } else {
            alert('Error cancelling appointment: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error cancelling appointment: ' + error.message);
    });
}

// Get all appointments function
function getAllAppointments(filters = {}) {
    const params = new URLSearchParams(filters);

    fetch(`/api/appointments?${params.toString()}`)
    .then(response => response.json())
    .then(data => {
        if (data.appointments) {
            console.log('All appointments:', data.appointments);
            displayAppointmentsList(data.appointments);
        } else {
            console.error('Error fetching appointments:', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Display appointments in a list
function displayAppointmentsList(appointments) {
    let html = '<div class="appointments-list"><h4>All Appointments</h4>';

    if (appointments.length === 0) {
        html += '<p>No appointments found.</p>';
    } else {
        appointments.forEach(appointment => {
            const statusClass = appointment.status === 'cancelled' ? 'text-danger' : 
                              appointment.status === 'completed' ? 'text-success' : 'text-primary';

            html += `
                <div class="appointment-item border p-2 mb-2 rounded">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>${appointment.client ? appointment.client.name : 'Unknown Client'}</strong>
                        </div>
                        <div class="col-md-3">
                            ${appointment.service ? appointment.service.name : 'Unknown Service'}
                        </div>
                        <div class="col-md-2">
                            ${appointment.staff ? appointment.staff.name : 'Unknown Staff'}
                        </div>
                        <div class="col-md-2">
                            ${appointment.appointment_date}
                        </div>
                        <div class="col-md-2">
                            <span class="${statusClass}">${appointment.status}</span>
                        </div>
                    </div>
                    ${appointment.notes ? `<div class="mt-1"><small>Notes: ${appointment.notes}</small></div>` : ''}
                </div>
            `;
        });
    }

    html += '</div>';

    // Display in a modal or dedicated container
    const container = document.getElementById('appointmentsListContainer');
    if (container) {
        container.innerHTML = html;
    } else {
        // Create modal to display appointments
        const modal = document.createElement('div');
        modal.innerHTML = `
            <div class="modal fade" id="appointmentsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">All Appointments</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${html}
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        // Show the modal
        new bootstrap.Modal(document.getElementById('appointmentsModal')).show();
    }
}
</script>
{% endblock %}