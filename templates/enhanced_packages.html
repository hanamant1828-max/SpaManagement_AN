{% extends "base.html" %}

{% block title %}✅ Package Subscription Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">✅ Package Subscription Management</h1>
                    <p class="text-muted">Professional package creation with service discounts and session tracking</p>
                </div>
                <div>
                    <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addPackageModal">
                        <i class="fas fa-plus"></i> Add New Package
                    </button>
                    <a href="{{ url_for('export_packages') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-download"></i> Export Packages
                    </a>
                </div>
            </div>

            <!-- Package Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary">{{ packages|length }}</h5>
                            <p class="card-text">Total Packages</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">{{ packages|selectattr('is_active')|list|length }}</h5>
                            <p class="card-text">Active Packages</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-info">{{ client_packages|length }}</h5>
                            <p class="card-text">Assigned to Clients</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">{{ services|length }}</h5>
                            <p class="card-text">Available Services</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Packages Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">📦 Package Management</h5>
                </div>
                <div class="card-body">
                    {% if packages %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Package Name</th>
                                        <th>Services Included</th>
                                        <th>Validity</th>
                                        <th>Price</th>
                                        <th>Discount</th>
                                        <th>Active Clients</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for package in packages %}
                                    <tr>
                                        <td>
                                            <strong>{{ package.name }}</strong>
                                            {% if package.description %}
                                                <br><small class="text-muted">{{ package.description[:50] }}...</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% for ps in package.services %}
                                                <span class="badge bg-info me-1 mb-1">
                                                    {{ ps.service.name }} ({{ ps.sessions_included }}x)
                                                    {% if ps.service_discount > 0 %}
                                                        <small>-{{ ps.service_discount }}%</small>
                                                    {% endif %}
                                                </span>
                                            {% endfor %}
                                        </td>
                                        <td>{{ package.validity_days }} days</td>
                                        <td>₹{{ "%.2f"|format(package.total_price) }}</td>
                                        <td>
                                            {% if package.discount_percentage > 0 %}
                                                <span class="badge bg-warning">{{ package.discount_percentage }}%</span>
                                            {% else %}
                                                <span class="text-muted">No discount</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% set active_count = client_packages|selectattr('package_id', 'equalto', package.id)|selectattr('is_active')|list|length %}
                                            <span class="badge bg-primary">{{ active_count }}</span>
                                        </td>
                                        <td>
                                            {% if package.is_active %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-success btn-sm" onclick="assignPackage({{ package.id }}, '{{ package.name }}')">
                                                    <i class="fas fa-user-plus"></i> Assign
                                                </button>
                                                <button class="btn btn-outline-primary btn-sm" onclick="editPackage({{ package.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                {% if active_count == 0 %}
                                                    <button class="btn btn-outline-danger btn-sm" onclick="deletePackage({{ package.id }}, '{{ package.name }}')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-gift fa-3x text-muted mb-3"></i>
                            <h5>No packages found</h5>
                            <p class="text-muted">Create your first subscription package to get started.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Client Package Usage Tracking -->
            {% if client_packages %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">🧾 Client Package Usage Tracking</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Package</th>
                                    <th>Sessions Remaining</th>
                                    <th>Expiry Date</th>
                                    <th>Amount Paid</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cp in client_packages %}
                                <tr>
                                    <td>{{ cp.client.full_name }}</td>
                                    <td>{{ cp.package.name }}</td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            {% set remaining_percent = ((cp.total_sessions - cp.sessions_used) / cp.total_sessions * 100) if cp.total_sessions > 0 else 0 %}
                                            <div class="progress-bar {% if remaining_percent > 50 %}bg-success{% elif remaining_percent > 20 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 style="width: {{ remaining_percent }}%">
                                                {{ cp.total_sessions - cp.sessions_used }}/{{ cp.total_sessions }}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {{ cp.expiry_date.strftime('%Y-%m-%d') }}
                                        {% set now = moment().utc() %}
                                        {% set days_left = (cp.expiry_date.timestamp() - now.timestamp()) // 86400 %}
                                        {% if days_left <= 7 and days_left >= 0 %}
                                            <br><small class="text-danger">{{ days_left|int }} days left</small>
                                        {% elif days_left <= 30 and days_left >= 0 %}
                                            <br><small class="text-warning">{{ days_left|int }} days left</small>
                                        {% elif days_left < 0 %}
                                            <br><small class="text-danger">Expired</small>
                                        {% endif %}
                                    </td>
                                    <td>₹{{ "%.2f"|format(cp.amount_paid) }}</td>
                                    <td>
                                        {% if cp.is_active %}
                                            {% if days_left >= 0 %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-danger">Expired</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-info btn-sm" onclick="viewUsageDetails({{ cp.id }})">
                                            <i class="fas fa-eye"></i> Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Package Modal -->
<div class="modal fade" id="addPackageModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">➕ Create New Package</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_package_route') }}" id="packageForm">
                {{ package_form.hidden_tag() }}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ package_form.name.label(class="form-label") }}
                                {{ package_form.name(class="form-control", placeholder="e.g., Bridal Glow Package") }}
                                <small class="form-text text-muted">{{ package_form.name.description }}</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ package_form.validity_days.label(class="form-label") }}
                                {{ package_form.validity_days(class="form-control") }}
                                <small class="form-text text-muted">{{ package_form.validity_days.description }}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ package_form.description.label(class="form-label") }}
                        {{ package_form.description(class="form-control", rows="2", placeholder="Short summary for clients and admin reference") }}
                    </div>

                    <!-- Service Selection Section -->
                    <div class="mb-4">
                        <h6 class="mb-3">🛍️ Included Services (Select multiple services and set individual discounts)</h6>
                        <div class="border rounded p-3 bg-light">
                            <div class="row">
                                {% for service in services %}
                                <div class="col-md-6 mb-3">
                                    <div class="card service-card" data-service-id="{{ service.id }}" data-service-name="{{ service.name }}" data-service-price="{{ service.price }}">
                                        <div class="card-body p-3">
                                            <div class="form-check">
                                                <input class="form-check-input service-checkbox" type="checkbox" id="service_{{ service.id }}" value="{{ service.id }}">
                                                <label class="form-check-label" for="service_{{ service.id }}">
                                                    <strong>{{ service.name }}</strong>
                                                    <br><small class="text-muted">₹{{ service.price }} per session</small>
                                                </label>
                                            </div>
                                            <div class="service-options mt-2" style="display: none;">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label">Sessions:</label>
                                                        <input type="number" class="form-control form-control-sm service-sessions" min="1" value="1">
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label">Discount (%):</label>
                                                        <input type="number" class="form-control form-control-sm service-discount" min="0" max="100" value="0">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ package_form.total_price.label(class="form-label") }}
                                {{ package_form.total_price(class="form-control", step="0.01") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ package_form.discount_percentage.label(class="form-label") }}
                                {{ package_form.discount_percentage(class="form-control", step="0.01") }}
                                <small class="form-text text-muted">{{ package_form.discount_percentage.description }}</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-check">
                        {{ package_form.is_active(class="form-check-input") }}
                        {{ package_form.is_active.label(class="form-check-label") }}
                        <small class="form-text text-muted">{{ package_form.is_active.description }}</small>
                    </div>

                    {{ package_form.selected_services }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Package</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign Package Modal -->
<div class="modal fade" id="assignPackageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">📈 Assign Package to Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignPackageForm">
                    <input type="hidden" id="assign_package_id">
                    <div class="mb-3">
                        <label class="form-label">Select Client</label>
                        <select class="form-select" id="assign_client_id" required>
                            <option value="">Choose client...</option>
                            {% for client in clients %}
                                <option value="{{ client.id }}">{{ client.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Custom Price (Optional)</label>
                        <input type="number" class="form-control" id="assign_custom_price" step="0.01" placeholder="Leave empty for package price">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="assign_notes" rows="2" placeholder="Assignment notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAssignPackage()">Assign Package</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Service selection handling
    const serviceCheckboxes = document.querySelectorAll('.service-checkbox');
    const selectedServicesInput = document.getElementById('id_selected_services');
    
    serviceCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const serviceCard = this.closest('.service-card');
            const serviceOptions = serviceCard.querySelector('.service-options');
            
            if (this.checked) {
                serviceOptions.style.display = 'block';
            } else {
                serviceOptions.style.display = 'none';
            }
            
            updateSelectedServices();
        });
    });
    
    // Update sessions and discount inputs
    document.querySelectorAll('.service-sessions, .service-discount').forEach(input => {
        input.addEventListener('change', updateSelectedServices);
    });
    
    function updateSelectedServices() {
        const selectedServices = [];
        
        serviceCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const serviceCard = checkbox.closest('.service-card');
                const sessions = serviceCard.querySelector('.service-sessions').value;
                const discount = serviceCard.querySelector('.service-discount').value;
                
                selectedServices.push({
                    service_id: parseInt(checkbox.value),
                    sessions: parseInt(sessions),
                    discount: parseFloat(discount) || 0
                });
            }
        });
        
        selectedServicesInput.value = JSON.stringify(selectedServices);
    }
});

function assignPackage(packageId, packageName) {
    document.getElementById('assign_package_id').value = packageId;
    document.querySelector('#assignPackageModal .modal-title').textContent = `📈 Assign "${packageName}" to Client`;
    new bootstrap.Modal(document.getElementById('assignPackageModal')).show();
}

function submitAssignPackage() {
    const packageId = document.getElementById('assign_package_id').value;
    const clientId = document.getElementById('assign_client_id').value;
    const customPrice = document.getElementById('assign_custom_price').value;
    const notes = document.getElementById('assign_notes').value;
    
    if (!clientId) {
        alert('Please select a client');
        return;
    }
    
    fetch(`/packages/${packageId}/assign`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            client_id: parseInt(clientId),
            custom_price: customPrice ? parseFloat(customPrice) : null,
            notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error assigning package: ' + error);
    });
}

function editPackage(packageId) {
    // Implement edit functionality
    alert('Edit functionality will be implemented based on requirements');
}

function deletePackage(packageId, packageName) {
    if (confirm(`Are you sure you want to delete package "${packageName}"?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/packages/${packageId}/delete`;
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrf_token';
        csrfToken.value = '{{ csrf_token() }}';
        form.appendChild(csrfToken);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function viewUsageDetails(clientPackageId) {
    // Implement usage details view
    alert('Usage details view will be implemented');
}
</script>

<style>
.service-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.service-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.service-card.selected {
    border-color: #007bff;
    background-color: #f8f9ff;
}

.progress {
    background-color: #e9ecef;
}
</style>
{% endblock %}