{% extends "base.html" %}

{% block title %}Customer Management - Spa & Salon Management Suite{% endblock %}
{% block body_class %}customers-page{% endblock %}

{% block extra_css %}
<style>
/* Customer Management - Using Centralized Theme Tokens */
.customer-management-header {
    background: linear-gradient(135deg, var(--spa-primary), var(--spa-primary-darker));
    color: var(--text-inverse);
    padding: var(--space-8) 0;
    margin-bottom: var(--space-8);
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
}

.stats-overview {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.stat-item {
    text-align: center;
    padding: 1rem;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--spa-primary);
    display: block;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.professional-card {
    background: white;
    border: none;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    overflow: hidden;
}

.professional-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.15);
}

.card-header-gradient {
    background: linear-gradient(135deg, var(--spa-primary-light), var(--spa-danger));
    color: white;
    border: none;
    padding: 1.5rem;
    font-weight: 600;
}

.search-section {
    background: linear-gradient(135deg, var(--spa-warning-light), var(--spa-warning));
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.search-input-group {
    position: relative;
    max-width: 600px;
    margin: 0 auto;
}

.search-input-group input {
    border-radius: 50px;
    padding: 15px 60px 15px 25px;
    border: none;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    font-size: 1.1rem;
}

.search-input-group .search-icon {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--spa-primary);
}

.customer-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--spa-primary), var(--spa-primary-darker));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 1.2rem;
    margin-right: 15px;
    border: 3px solid #f8f9fa;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.customer-info h5 {
    margin: 0;
    color: var(--text-primary);
    font-weight: 600;
}

.customer-meta {
    color: var(--text-tertiary);
    font-size: 0.9rem;
    margin-top: 5px;
}

.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.action-buttons {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}

.btn-action {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    transition: all 0.3s ease;
    position: relative;
}

.btn-action:hover {
    transform: scale(1.1);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-action[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--spa-dark);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 0.8rem;
    white-space: nowrap;
    z-index: 1000;
}

.table-enhanced {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
}

.table-enhanced thead {
    background: linear-gradient(135deg, var(--spa-info), var(--spa-info-light));
    color: white;
}

.table-enhanced th {
    border: none;
    padding: 1.5rem 1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.85rem;
}

.table-enhanced td {
    border: none;
    padding: 1.5rem 1rem;
    vertical-align: middle;
    border-bottom: 1px solid #f1f3f4;
}

.table-enhanced tbody tr:hover {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 10%);
    transform: scale(1.01);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.face-management-section {
    background: linear-gradient(135deg, var(--spa-info-light), var(--spa-danger-light));
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.camera-container {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    text-align: center;
    position: relative;
    overflow: hidden;
}

.camera-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    background: linear-gradient(90deg, var(--spa-primary), var(--spa-primary-darker), var(--spa-primary-light), var(--spa-danger));
}

.face-preview {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid #667eea;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.face-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-tertiary);
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.floating-add-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--spa-primary), var(--spa-primary-darker));
    border: none;
    color: white;
    font-size: 1.5rem;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
    z-index: 1000;
}

.floating-add-button:hover {
    transform: scale(1.1) rotate(90deg);
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
}

.modal-modern .modal-content {
    border: none;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    overflow: hidden;
}

.modal-modern .modal-header {
    background: linear-gradient(135deg, var(--spa-primary), var(--spa-primary-darker));
    color: white;
    border: none;
    padding: 2rem;
}

.modal-modern .modal-body {
    padding: 2rem;
}

.form-floating-modern {
    position: relative;
    margin-bottom: 1.5rem;
}

.form-floating-modern input,
.form-floating-modern select,
.form-floating-modern textarea {
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 1rem;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.form-floating-modern input:focus,
.form-floating-modern select:focus,
.form-floating-modern textarea:focus {
    border-color: var(--spa-primary);
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    background: white;
}

.form-floating-modern label {
    color: var(--text-tertiary);
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.tabs-modern .nav-tabs {
    border: none;
    background: #f8f9fa;
    border-radius: 15px;
    padding: 0.5rem;
}

.tabs-modern .nav-link {
    border: none;
    border-radius: 10px;
    padding: 1rem 2rem;
    margin: 0 0.25rem;
    color: var(--text-tertiary);
    font-weight: 600;
    transition: all 0.3s ease;
}

.tabs-modern .nav-link.active {
    background: linear-gradient(135deg, var(--spa-primary), var(--spa-primary-darker));
    color: white;
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

@media (max-width: 768px) {
    .customer-avatar {
        width: 45px;
        height: 45px;
        font-size: 1rem;
    }

    .action-buttons {
        justify-content: center;
    }

    .floating-add-button {
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
    }

    .stats-overview {
        padding: 1rem;
    }

    .stat-number {
        font-size: 2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Enhanced Header -->
    <div class="customer-management-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0 display-6">
                        <i class="fas fa-users me-3"></i>Customer Management
                    </h1>
                    <p class="mb-0 mt-2 opacity-75">Manage your valued customers with ease and professionalism</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="d-flex align-items-center justify-content-end">
                        <div class="me-3">
                            <small class="text-light opacity-75">Total Customers</small>
                            <div class="h3 mb-0">{{ customers|length if customers else 0 }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="row mb-3">
                <div class="col-12">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'warning' else 'times-circle' if category == 'danger' else 'info-circle' }} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    {% endwith %}

    <!-- Enhanced Stats Overview -->
    {% if customers %}
    <div class="stats-overview">
        <div class="row">
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-number">{{ customers|length }}</span>
                    <span class="stat-label">Total Customers</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-number">{{ customers|selectattr("status", "equalto", "Loyal Customer")|list|length }}</span>
                    <span class="stat-label">Loyal Customers</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-number">{{ customers|selectattr("total_visits", "gt", 0)|list|length }}</span>
                    <span class="stat-label">Active Customers</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-item">
                    <span class="stat-number">{{ customers|selectattr("is_vip", "equalto", true)|list|length }}</span>
                    <span class="stat-label">VIP Customers</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modern Tab Navigation -->
    <div class="tabs-modern mb-4">
        <ul class="nav nav-tabs" id="customerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="management-tab" data-bs-toggle="tab" data-bs-target="#management" type="button" role="tab">
                    <i class="fas fa-users-cog me-2"></i>Customer Directory
                </button>
            </li>
            {% if current_user.has_permission('face_recognition') %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="face-capture-tab" data-bs-toggle="tab" data-bs-target="#face-capture" type="button" role="tab">
                    <i class="fas fa-camera me-2"></i>Face Recognition
                </button>
            </li>
            {% endif %}
        </ul>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="customerTabsContent">
        <!-- Customer Management Tab -->
        <div class="tab-pane fade show active" id="management" role="tabpanel">

            <!-- Enhanced Search Section -->
            <div class="search-section">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-3 text-center">Find Your Customers</h4>
                        <form method="GET" action="{{ url_for('customers') }}" id="customerSearchForm">
                            <div class="search-input-group">
                                <input type="text" class="form-control" id="customerSearch" name="search"
                                       placeholder="Search by name, phone, or email..."
                                       value="{{ search_query }}"
                                       autocomplete="off">
                                <i class="fas fa-search search-icon" onclick="document.getElementById('customerSearchForm').submit()" style="cursor: pointer;"></i>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-4 text-center mt-3 mt-md-0">
                        {% if current_user.has_permission('clients_create') %}
                        <button type="button" class="btn btn-lg btn-primary px-4 py-3"
                                data-bs-toggle="modal" data-bs-target="#addCustomerModal"
                                style="border-radius: 25px; background: linear-gradient(135deg, var(--spa-primary), var(--spa-primary-darker)); border: none;">
                            <i class="fas fa-user-plus me-2"></i>Add New Customer
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Enhanced Customers Table -->
            <div class="professional-card">
                <div class="card-header-gradient">
                    <h5 class="mb-0">
                        <i class="fas fa-address-book me-2"></i>
                        Customer Directory
                        {% if search_query %}
                            <small class="opacity-75 ms-2">(Search results for "{{ search_query }}")</small>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if customers %}
                        <div class="spa-table-responsive">
                            <table class="spa-table mb-0">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Contact Information</th>
                                        <th>Visit History</th>
                                        <th class="text-center">Face Data</th>
                                        <th>Status</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for customer in customers %}
                                    <tr data-customer-id="{{ customer.id }}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="customer-avatar">
                                                    {{ customer.first_name[0] }}{{ customer.last_name[0] }}
                                                </div>
                                                <div class="customer-info">
                                                    <h5>{{ customer.full_name }}</h5>
                                                    <div class="customer-meta">
                                                        {% if customer.date_of_birth %}
                                                            <i class="fas fa-birthday-cake me-1"></i>
                                                            Age: {{ utils.calculate_age(customer.date_of_birth) }}
                                                        {% endif %}
                                                        {% if customer.is_vip %}
                                                            <span class="badge bg-warning ms-2">
                                                                <i class="fas fa-crown"></i> VIP
                                                            </span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div>
                                                <i class="fas fa-phone me-2 text-primary"></i>
                                                <strong>{{ customer.phone }}</strong>
                                            </div>
                                            {% if customer.email %}
                                            <div class="mt-1">
                                                <i class="fas fa-envelope me-2 text-info"></i>
                                                <span class="text-muted">{{ customer.email }}</span>
                                            </div>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="mb-2">
                                                <strong class="text-success">{{ customer.total_visits }}</strong> visits
                                            </div>
                                            <div class="small text-muted">
                                                {% if customer.last_visit %}
                                                    Last: {{ utils.format_date(customer.last_visit.date()) }}
                                                {% else %}
                                                    Never visited
                                                {% endif %}
                                            </div>
                                            <div class="small">
                                                <strong>{{ utils.format_currency(customer.total_spent) }}</strong> spent
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            {% if customer.face_encoding or customer.face_image_url %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check-circle me-1"></i>Registered
                                                </span>
                                                <button class="btn btn-sm btn-danger ms-2" onclick="deleteFaceImage({{ customer.id }}, '{{ (customer.first_name ~ ' ' ~ customer.last_name)|replace("'", "\\'") }}')"
                                                        title="Delete Face Image">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-times-circle me-1"></i>Not Registered
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="status-badge bg-{{ utils.get_status_badge_class(customer.status.lower().replace(' ', '_')) }}">
                                                {{ customer.status }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="action-buttons justify-content-center">
                                                <button class="btn btn-action btn-outline-primary"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#viewCustomerModal"
                                                        onclick="viewCustomer({{ customer.id }})"
                                                        title="View Details">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                {# The "Book Appointment" button has been removed as requested #}
                                                {% if current_user.has_permission('clients_edit') %}
                                                <button class="btn btn-action btn-outline-warning"
                                                        data-bs-toggle="modal"
                                                        data-bs-target="#editCustomerModal"
                                                        onclick="editCustomer({{ customer.id }})"
                                                        title="Edit Customer">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                {% endif %}
                                                {% if current_user.has_permission('clients_delete') %}
                                                <button class="btn btn-action btn-outline-danger"
                                                        onclick="deleteCustomer({{ customer.id }}, '{{ (customer.first_name ~ ' ' ~ customer.last_name)|replace("'", "\\'") }}')"
                                                        title="Delete Customer">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4 class="mt-3">
                                {% if search_query %}
                                    No customers found matching your search
                                {% else %}
                                    No customers yet
                                {% endif %}
                            </h4>
                            <p class="text-muted">
                                {% if search_query %}
                                    Try adjusting your search terms or <a href="{{ url_for('customers') }}" class="text-decoration-none">view all customers</a>.
                                {% else %}
                                    Start building your customer base by adding your first customer.
                                {% endif %}
                            </p>
                            {% if not search_query and current_user.has_permission('clients_create') %}
                            <button type="button" class="btn btn-primary btn-lg mt-3"
                                    data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                                <i class="fas fa-user-plus me-2"></i>Add Your First Customer
                            </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Face Management Tab -->
        <div class="tab-pane fade" id="face-capture" role="tabpanel">
            {% if current_user.has_permission('face_recognition') %}
            <div class="face-management-section">
                <h3 class="text-center mb-4">
                    <i class="fas fa-camera me-2"></i>Face Recognition Management
                </h3>

                <div class="row">
                    <!-- Customer Selection -->
                    <div class="col-md-6 mb-4">
                        <div class="professional-card">
                            <div class="card-header-gradient">
                                <h6 class="mb-0"><i class="fas fa-user-check me-2"></i>Select Customer</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-floating-modern">
                                    <label for="faceClientSelect">Choose Customer</label>
                                    <select class="form-select" id="faceClientSelect">
                                        <option value="">Select a customer...</option>
                                        {% for customer in customers %}
                                        <option value="{{ customer.id }}" data-name="{{ customer.full_name }}" data-phone="{{ customer.phone }}">
                                            {{ customer.full_name }} - {{ customer.phone }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div id="selectedFaceClientInfo" class="alert alert-info d-none mt-3">
                                    <strong>Selected Customer:</strong>
                                    <div id="selectedFaceClientDetails"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Face Capture -->
                    <div class="col-md-6 mb-4">
                        <div class="professional-card">
                            <div class="card-header-gradient">
                                <h6 class="mb-0"><i class="fas fa-camera me-2"></i>Face Capture</h6>
                            </div>
                            <div class="card-body">
                                <div class="camera-container mb-4">
                                    <video id="faceVideo" width="300" height="200" autoplay playsinline style="border-radius: 10px; display: none; background: #000;"></video>
                                    <canvas id="faceCanvas" width="300" height="200" style="border-radius: 10px; display: none;"></canvas>
                                    <div id="faceCameraPlaceholder" class="d-flex align-items-center justify-content-center" style="height: 200px;">
                                        <div>
                                            <i class="fas fa-camera fa-4x text-muted mb-3"></i>
                                            <p class="text-muted mb-0">Select customer and start camera</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-grid gap-3">
                                    <button id="startFaceCamera" class="btn btn-success btn-lg" onclick="startFaceCameraForTab()">
                                        <i class="fas fa-video me-2"></i>Start Camera
                                    </button>
                                    <button id="captureFacePhoto" class="btn btn-primary btn-lg" onclick="captureFacePhoto()" disabled>
                                        <i class="fas fa-camera me-2"></i>Capture Photo
                                    </button>
                                    <button id="saveFaceData" class="btn btn-warning btn-lg" onclick="saveFaceData()" disabled>
                                        <i class="fas fa-save me-2"></i>Save Face Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Face Data Table -->
                <div class="professional-card mt-4">
                    <div class="card-header-gradient">
                        <h5 class="mb-0"><i class="fas fa-id-card-alt me-2"></i>Registered Face Data</h5>
                    </div>
                    <div class="card-body p-0" id="faceTableContainer">
                        <!-- Face data will be loaded here by JavaScript -->
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                            <p class="text-muted mt-2">Loading face data...</p>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="professional-card mt-3">
                <div class="card-body text-center py-5">
                    <i class="fas fa-lock fa-3x text-muted mb-3"></i>
                    <h4>Access Restricted</h4>
                    <p class="text-muted">You don't have permission to access face recognition features.</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Floating Add Button -->
{% if current_user.has_permission('clients_create') %}
<button type="button" class="floating-add-button" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
    <i class="fas fa-plus"></i>
</button>
{% endif %}

<!-- Enhanced Add Customer Modal -->
<div class="modal fade modal-modern" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Add New Customer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_customer_route') }}" novalidate>
                <div class="modal-body">
                    {{ form.hidden_tag() }}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="first_name">First Name *</label>
                                {{ form.first_name(class="form-control") }}
                                {% if form.first_name.errors %}
                                    <div class="text-danger small mt-1">{{ form.first_name.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="last_name">Last Name *</label>
                                {{ form.last_name(class="form-control") }}
                                {% if form.last_name.errors %}
                                    <div class="text-danger small mt-1">{{ form.last_name.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="phone">Phone Number *</label>
                                {{ form.phone(class="form-control") }}
                                {% if form.phone.errors %}
                                    <div class="text-danger small mt-1">{{ form.phone.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="email">Email Address</label>
                                {{ form.email(class="form-control") }}
                                {% if form.email.errors %}
                                    <div class="text-danger small mt-1">{{ form.email.errors[0] }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="date_of_birth">Date of Birth</label>
                                {{ advanced_form.date_of_birth(class="form-control") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="gender">Gender *</label>
                                {{ advanced_form.gender(class="form-select", required=true) }}
                                <div class="form-text text-muted">Required field</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating-modern">
                        <label for="address">Address</label>
                        {{ form.address(class="form-control", rows="2") }}
                    </div>

                    <div class="form-floating-modern">
                        <label for="emergency_contact">Emergency Contact</label>
                        {{ advanced_form.emergency_contact(class="form-control", placeholder="Emergency contact name") }}
                    </div>

                    <div class="form-floating-modern">
                        <label for="allergies">Allergies & Sensitivities</label>
                        {{ advanced_form.allergies(class="form-control", rows="2", placeholder="Any known allergies or sensitivities") }}
                    </div>

                    <div class="form-floating-modern">
                        <label for="notes">Additional Notes</label>
                        {{ form.notes(class="form-control", rows="3", placeholder="Additional notes about the customer") }}
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Add Customer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Enhanced Edit Customer Modal -->
<div class="modal fade modal-modern" id="editCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-edit me-2"></i>Edit Customer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCustomerForm" method="POST" action="">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="edit_first_name">First Name *</label>
                                <input type="text" class="form-control" name="first_name" id="edit_first_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="edit_last_name">Last Name *</label>
                                <input type="text" class="form-control" name="last_name" id="edit_last_name" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="edit_phone">Phone Number *</label>
                                <input type="tel" class="form-control" name="phone" id="edit_phone" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="edit_email">Email Address</label>
                                <input type="email" class="form-control" name="email" id="edit_email">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="edit_date_of_birth">Date of Birth</label>
                                <input type="date" class="form-control" name="date_of_birth" id="edit_date_of_birth">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating-modern">
                                <label for="edit_gender">Gender *</label>
                                <select class="form-select" name="gender" id="edit_gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                                <div class="form-text text-muted">Required field</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-floating-modern">
                        <label for="edit_address">Address</label>
                        <textarea class="form-control" name="address" id="edit_address" rows="2"></textarea>
                    </div>

                    <div class="form-floating-modern">
                        <label for="edit_emergency_contact">Emergency Contact</label>
                        <input type="text" class="form-control" name="emergency_contact" id="edit_emergency_contact">
                    </div>

                    <div class="form-floating-modern">
                        <label for="edit_allergies">Allergies & Sensitivities</label>
                        <textarea class="form-control" name="allergies" id="edit_allergies" rows="2" placeholder="Any known allergies or sensitivities"></textarea>
                    </div>

                    <div class="form-floating-modern">
                        <label for="edit_notes">Additional Notes</label>
                        <textarea class="form-control" name="notes" id="edit_notes" rows="3" placeholder="Additional notes about the customer"></textarea>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Update Customer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Enhanced View Customer Modal -->
<div class="modal fade modal-modern" id="viewCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>Customer Profile
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="customerDetails">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-primary"></i>
                    <p class="text-muted mt-2">Loading...</p>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary btn-lg" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Close
                </button>
                <button type="button" class="btn btn-primary btn-lg" onclick="bookAppointmentFromModal()">
                    <i class="fas fa-calendar-plus me-2"></i>Book Appointment
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ============================================
// CUSTOMER MANAGEMENT SYSTEM - COMPLETE
// ============================================

// Global Variables
let currentEditCustomerId = null;
let currentCustomerId = null;
let faceVideo = null;
let faceCanvas = null;
let faceStream = null;
let capturedImageData = null;

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('Customer Management: Initializing...');

    // Validate all customer action buttons
    validateCustomerActionButtons();

    // Populate customer select for face capture
    populateCustomerSelect();

    // Setup face capture tab with lazy loading
    const faceTab = document.getElementById('face-capture-tab');
    if (faceTab) {
        faceTab.addEventListener('shown.bs.tab', function() {
            if (!this.dataset.initialized) {
                console.log('Face Recognition: First activation');
                initializeFaceCaptureOnce();
                this.dataset.initialized = 'true';
            }
        });
    }

    // Attach search event listener
    const searchInput = document.getElementById('customerSearch');
    if (searchInput) {
        searchInput.addEventListener('keyup', searchCustomers);
        console.log('Search event listener attached');
    }

    console.log('Customer Management: Ready');
});

// ============================================
// CUSTOMER MANAGEMENT FUNCTIONS
// ============================================

function validateCustomerId(customerId, operation) {
    if (!customerId || customerId === 'null' || customerId === null || customerId === undefined || isNaN(customerId)) {
        console.error(`Invalid customer ID for ${operation}:`, customerId);
        showNotification('Error: Invalid customer data. Please refresh the page.', 'danger');
        return false;
    }
    return true;
}

function validateCustomerActionButtons() {
    console.log('Validating customer action buttons...');

    const actionButtons = document.querySelectorAll('[onclick*="viewCustomer"], [onclick*="editCustomer"], [onclick*="deleteCustomer"], [onclick*="bookAppointment"]');
    let invalidCount = 0;

    actionButtons.forEach((button, index) => {
        const onclick = button.getAttribute('onclick');
        if (onclick && (onclick.includes('undefined') || onclick.includes('null') || onclick.includes('Customer(null'))) {
            console.error(`Invalid button found: ${onclick}`);
            button.disabled = true;
            button.title = 'Error: Invalid customer data';
            button.style.opacity = '0.5';
            invalidCount++;
        }
    });

    if (invalidCount > 0) {
        console.warn(`Found ${invalidCount} invalid buttons`);
        showNotification(`Found ${invalidCount} invalid customer buttons. Please refresh.`, 'warning');
    } else {
        console.log('All customer buttons validated successfully');
    }
}

function viewCustomer(customerId) {
    console.log('View customer:', customerId);

    if (!validateCustomerId(customerId, 'viewCustomer')) return;

    const modal = new bootstrap.Modal(document.getElementById('viewCustomerModal'));
    const details = document.getElementById('customerDetails');

    details.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="text-muted mt-2">Loading customer details...</p></div>';
    modal.show();

    fetch(`/api/customers/${customerId}`)
        .then(response => {
            if (!response.ok) throw new Error('Customer not found');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                renderCustomerDetails(data.customer, details);
                currentEditCustomerId = customerId;
            } else {
                throw new Error(data.error || 'Failed to load customer');
            }
        })
        .catch(error => {
            console.error('Error loading customer:', error);
            details.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading customer: ${error.message}
                </div>
            `;
        });
}

function renderCustomerDetails(customer, container) {
    const initials = `${customer.first_name[0]}${customer.last_name[0]}`;
    const age = customer.date_of_birth ? calculateAge(customer.date_of_birth) : 'N/A';

    container.innerHTML = `
        <div class="row">
            <div class="col-md-3 text-center">
                <div class="customer-avatar mx-auto mb-3" style="width: 80px; height: 80px; font-size: 1.5rem;">
                    ${initials}
                </div>
                ${customer.is_vip ? '<span class="badge bg-warning"><i class="fas fa-crown"></i> VIP</span>' : ''}
                <span class="badge ${customer.is_active ? 'bg-success' : 'bg-secondary'} mt-2">
                    ${customer.is_active ? 'Active' : 'Inactive'}
                </span>
            </div>
            <div class="col-md-9">
                <h4 class="mb-1">${customer.full_name}</h4>
                <p class="text-muted mb-3">${customer.status}</p>

                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Phone:</strong><br>
                        <a href="tel:${customer.phone}" class="text-decoration-none">
                            <i class="fas fa-phone me-1"></i>${customer.phone}
                        </a>
                    </div>
                    <div class="col-sm-6">
                        <strong>Email:</strong><br>
                        ${customer.email ? `<a href="mailto:${customer.email}" class="text-decoration-none"><i class="fas fa-envelope me-1"></i>${customer.email}</a>` : 'Not provided'}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Date of Birth:</strong><br>
                        ${customer.date_of_birth ? new Date(customer.date_of_birth).toLocaleDateString() + ` (${age} years)` : 'Not provided'}
                    </div>
                    <div class="col-sm-6">
                        <strong>Gender:</strong><br>
                        ${customer.gender ? customer.gender.charAt(0).toUpperCase() + customer.gender.slice(1) : 'Not specified'}
                    </div>
                </div>

                ${customer.address ? `
                    <div class="mb-3">
                        <strong>Address:</strong><br>
                        <span class="text-muted">${customer.address.replace(/\n/g, '<br>')}</span>
                    </div>
                ` : ''}

                <div class="row mb-3">
                    <div class="col-sm-4">
                        <div class="text-center p-3 bg-light rounded">
                            <strong class="text-primary h4">${customer.total_visits}</strong><br>
                            <small class="text-muted">Total Visits</small>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="text-center p-3 bg-light rounded">
                            <strong class="text-success h4">â‚¹${customer.total_spent.toFixed(2)}</strong><br>
                            <small class="text-muted">Total Spent</small>
                        </div>
                    </div>
                    <div class="col-sm-4">
                        <div class="text-center p-3 bg-light rounded">
                            <strong class="text-info h6">${customer.last_visit ? new Date(customer.last_visit).toLocaleDateString() : 'Never'}</strong><br>
                            <small class="text-muted">Last Visit</small>
                        </div>
                    </div>
                </div>

                ${customer.emergency_contact ? `
                    <div class="mb-3">
                        <strong>Emergency Contact:</strong><br>
                        <span class="text-muted">${customer.emergency_contact}</span>
                    </div>
                ` : ''}

                ${customer.allergies ? `
                    <div class="alert alert-warning mb-3">
                        <strong><i class="fas fa-exclamation-triangle me-2"></i>Allergies:</strong><br>
                        ${customer.allergies}
                    </div>
                ` : ''}

                ${customer.notes ? `
                    <div class="mb-3">
                        <strong>Notes:</strong><br>
                        <span class="text-muted">${customer.notes}</span>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function calculateAge(dateString) {
    const today = new Date();
    const birthDate = new Date(dateString);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();

    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }

    return age;
}

function editCustomer(customerId) {
    console.log('Edit customer:', customerId);

    if (!validateCustomerId(customerId, 'editCustomer')) return;

    currentEditCustomerId = customerId;

    fetch(`/api/customers/${customerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateEditForm(data.customer);
                const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
                modal.show();
            } else {
                showNotification('Error loading customer data', 'danger');
            }
        })
        .catch(error => {
            console.error('Edit error:', error);
            showNotification('Failed to load customer data', 'danger');
        });
}

function populateEditForm(customer) {
    console.log('Populating edit form:', customer);

    const form = document.getElementById('editCustomerForm');
    form.action = `/clients/update/${customer.id}`;

    const fields = {
        'edit_first_name': customer.first_name,
        'edit_last_name': customer.last_name,
        'edit_phone': customer.phone,
        'edit_email': customer.email,
        'edit_address': customer.address,
        'edit_date_of_birth': customer.date_of_birth,
        'edit_gender': customer.gender,
        'edit_emergency_contact': customer.emergency_contact,
        'edit_allergies': customer.allergies,
        'edit_notes': customer.notes
    };

    Object.entries(fields).forEach(([id, value]) => {
        const field = document.getElementById(id);
        if (field && value !== null && value !== undefined && value !== '') {
            field.value = value;
        }
    });
}

function deleteCustomer(customerId, customerName) {
    console.log('Delete customer:', customerId, customerName);

    if (!validateCustomerId(customerId, 'deleteCustomer')) return;

    const safeName = customerName || 'this customer';

    if (confirm(`Are you sure you want to delete "${safeName}"?\n\nThis will deactivate the customer but preserve their data.`)) {
        showNotification('Deleting customer...', 'info');

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/clients/delete/${customerId}`;
        form.style.display = 'none';

        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }
}

function bookAppointment(customerId) {
    console.log('Book appointment for customer:', customerId);

    if (!validateCustomerId(customerId, 'bookAppointment')) return;

    window.location.href = `/bookings?customer_id=${customerId}`;
}

function bookAppointmentFromModal() {
    if (currentEditCustomerId) {
        bookAppointment(currentEditCustomerId);
    } else {
        showNotification('No customer selected', 'warning');
    }
}

// ============================================
// FACE CAPTURE FUNCTIONS
// ============================================

function initializeFaceCaptureOnce() {
    console.log('Initializing face capture...');

    faceVideo = document.getElementById('faceVideo');
    faceCanvas = document.getElementById('faceCanvas');

    const faceClientSelect = document.getElementById('faceClientSelect');
    if (faceClientSelect && !faceClientSelect.dataset.listenerAttached) {
        faceClientSelect.addEventListener('change', (e) => selectCustomerForFace(e.target.value));
        faceClientSelect.dataset.listenerAttached = 'true';
    }

    loadFaceDataTable();
    console.log('Face capture initialized');
}

function selectCustomerForFace(customerId) {
    console.log('Customer selected for face capture:', customerId);
    currentCustomerId = customerId;

    const selectedInfo = document.getElementById('selectedFaceClientInfo');
    const selectedDetails = document.getElementById('selectedFaceClientDetails');

    if (!customerId) {
        if (selectedInfo) selectedInfo.classList.add('d-none');
        return;
    }

    const select = document.getElementById('faceClientSelect');
    const selectedOption = select?.options[select.selectedIndex];

    if (selectedOption && selectedDetails && selectedInfo) {
        selectedDetails.textContent = selectedOption.textContent;
        selectedInfo.classList.remove('d-none');
    }
}

async function startFaceCameraForTab() { // Renamed to avoid conflict with potential global function
    console.log('Starting face camera...');

    if (!currentCustomerId) {
        showNotification('Please select a customer first', 'warning');
        return;
    }

    try {
        if (faceStream) {
            faceStream.getTracks().forEach(track => track.stop());
        }

        faceStream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: { ideal: 640 },
                height: { ideal: 480 },
                facingMode: 'user'
            }
        });

        faceVideo.srcObject = faceStream;
        await faceVideo.play();
        faceVideo.style.display = 'block';

        document.getElementById('faceCameraPlaceholder').style.display = 'none';

        const startBtn = document.getElementById('startFaceCamera'); // Corrected ID
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-circle text-danger me-2"></i>Camera Active';
        startBtn.classList.remove('btn-success');
        startBtn.classList.add('btn-secondary');

        document.getElementById('captureFacePhoto').disabled = false;

        showNotification('Camera started successfully!', 'success');

    } catch (error) {
        console.error('Camera error:', error);

        const messages = {
            'NotAllowedError': 'Please allow camera access and try again.',
            'NotFoundError': 'No camera found on this device.',
            'default': 'Please check your camera and permissions.'
        };

        showNotification('Camera access failed. ' + (messages[error.name] || messages.default), 'danger');
    }
}

function captureFacePhoto() {
    console.log('Capturing face photo...');

    if (!currentCustomerId || !faceVideo) {
        showNotification('Please select customer and start camera first', 'warning');
        return;
    }

    faceCanvas.width = faceVideo.videoWidth || 640;
    faceCanvas.height = faceVideo.videoHeight || 480;

    const ctx = faceCanvas.getContext('2d');
    ctx.drawImage(faceVideo, 0, 0, faceCanvas.width, faceCanvas.height);

    capturedImageData = faceCanvas.toDataURL('image/jpeg', 0.8);

    faceVideo.style.display = 'none';
    faceCanvas.style.display = 'block';

    document.getElementById('captureFacePhoto').style.display = 'none';

    const saveBtn = document.getElementById('saveFaceData');
    saveBtn.disabled = false;
    saveBtn.style.display = 'inline-block';

    showNotification('Photo captured! Click "Save Face Data" to store it.', 'success');
}

function saveFaceData() {
    console.log('Saving face data...');

    if (!currentCustomerId || !capturedImageData) {
        showNotification('No customer selected or photo captured', 'warning');
        return;
    }

    const saveBtn = document.getElementById('saveFaceData');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

    fetch('/api/save_face', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            client_id: currentCustomerId,
            face_image: capturedImageData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Face data saved successfully!', 'success');
            resetFaceCapture();
            loadFaceDataTable();
        } else {
            throw new Error(data.error || 'Save failed');
        }
    })
    .catch(error => {
        console.error('Save error:', error);
        showNotification('Error saving face data: ' + error.message, 'danger');
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Face Data';
    });
}

function resetFaceCapture() {
    console.log('Resetting face capture...');

    if (faceStream) {
        faceStream.getTracks().forEach(track => track.stop());
        faceStream = null;
    }

    if (faceVideo) {
        faceVideo.style.display = 'none';
        if (faceVideo.srcObject) {
            faceVideo.srcObject.getTracks().forEach(track => track.stop());
            faceVideo.srcObject = null;
        }
    }

    if (faceCanvas) faceCanvas.style.display = 'none';

    const placeholder = document.getElementById('faceCameraPlaceholder');
    if (placeholder) placeholder.style.display = 'flex';

    const startBtn = document.getElementById('startFaceCamera'); // Corrected ID
    startBtn.disabled = false;
    startBtn.innerHTML = '<i class="fas fa-video me-2"></i>Start Camera';
    startBtn.classList.remove('btn-secondary');
    startBtn.classList.add('btn-success');

    document.getElementById('captureFacePhoto').disabled = true;

    const saveBtn = document.getElementById('saveFaceData');
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>Save Face Data';

    capturedImageData = null;
    currentCustomerId = null;

    document.getElementById('faceClientSelect').value = '';
    document.getElementById('selectedFaceClientInfo').classList.add('d-none');
}

function loadFaceDataTable() {
    console.log('Loading face data table...');

    const container = document.getElementById('faceTableContainer');
    if (!container) return;

    container.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="text-muted mt-2">Loading face data...</p></div>';

    fetch('/api/customers_with_faces')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.customers && data.customers.length > 0) {
                renderFaceTable(data.customers, container);
            } else {
                showEmptyFaceState(container);
            }
        })
        .catch(error => {
            console.error('Load error:', error);
            showEmptyFaceState(container);
        });
}

function renderFaceTable(customers, container) {
    let html = `
        <table class="table table-enhanced mb-0">
            <thead>
                <tr>
                    <th>Customer</th>
                    <th>Phone</th>
                    <th>Registration Date</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
    `;

    customers.forEach(customer => {
        const date = customer.face_registration_date ? new Date(customer.face_registration_date).toLocaleDateString() : 'Unknown';
        html += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        <div class="face-preview me-3">
                            <div class="face-image bg-primary d-flex align-items-center justify-content-center text-white">
                                ${customer.full_name.charAt(0)}
                            </div>
                        </div>
                        <div>
                            <strong>${customer.full_name}</strong><br>
                            <small class="text-muted">${customer.email || 'No email'}</small>
                        </div>
                    </div>
                </td>
                <td>${customer.phone}</td>
                <td>${date}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-warning me-1" onclick="updateFace(${customer.id})" title="Update Face">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteFaceData(${customer.id})"
                            title="Delete Face Data">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
}

function showEmptyFaceState(container) {
    container.innerHTML = `
        <div class="empty-state">
            <i class="fas fa-user-friends"></i>
            <h4 class="mt-3">No registered faces yet</h4>
            <p class="text-muted">Start capturing customer faces using the section above.</p>
            <div class="mt-3">
                <small class="text-info">
                    <i class="fas fa-info-circle me-1"></i>
                    Face recognition data will appear here once you capture and save customer faces
                </small>
            </div>
        </div>
    `;
}

function refreshFaceTable() {
    console.log('Refreshing face table...');
    loadFaceDataTable();
}

function searchFaceData() {
    console.log('Searching face data...');
    loadFaceDataTable();
}

function updateFace(customerId) {
    if (confirm('Update face data for this customer?')) {
        const captureTab = document.getElementById('face-capture-tab');
        if (captureTab) {
            const tab = new bootstrap.Tab(captureTab);
            tab.show();
        }

        const select = document.getElementById('faceClientSelect');
        if (select) {
            select.value = customerId;
            selectCustomerForFace(customerId);
        }

        showNotification('Select customer and capture new photo', 'info');
    }
}

function deleteFaceData(customerId) {
    if (confirm(`Are you sure you want to delete face data for this customer?\n\nThis will remove their facial recognition data permanently.`)) {
        fetch(`/api/delete_face/${customerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                loadFaceDataTable(); // Refresh the table
            } else {
                showNotification('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            showNotification('Error deleting face data. Please try again.', 'danger');
        });
    }
}

function deleteFaceImage(customerId, customerName) {
    if (confirm(`Are you sure you want to delete the face image for ${customerName}?\n\nThis action cannot be undone.`)) {
        fetch(`/api/delete_face_image/${customerId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                // Reload the page or specifically update the row if possible
                window.location.reload();
            } else {
                showNotification('Error: ' + data.error, 'danger');
            }
        })
        .catch(error => {
            console.error('Delete image error:', error);
            showNotification('Error deleting face image. Please try again.', 'danger');
        });
    }
}

function populateCustomerSelect() {
    const select = document.getElementById('faceClientSelect');
    if (!select) return;

    try {
        const customersData = {{ customers|tojson|safe }};
        if (customersData && customersData.length > 0) {
            select.innerHTML = '<option value="">Select a customer...</option>';
            customersData.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.full_name} - ${customer.phone}`;
                select.appendChild(option);
            });
            console.log(`Populated ${customersData.length} customers`);
        }
    } catch (error) {
        console.error('Error populating select:', error);
    }
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function showNotification(message, type = 'info') {
    const icons = {
        success: 'check-circle',
        warning: 'exclamation-triangle',
        danger: 'times-circle',
        info: 'info-circle'
    };

    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alert.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
    alert.innerHTML = `
        <i class="fas fa-${icons[type]} me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alert);
    setTimeout(() => {
        if (alert.parentNode) alert.remove();
    }, 5000);
}

// Global error handler
window.addEventListener('error', function(e) {
    console.error('JavaScript error:', e.error);
    if (e.error && e.error.message && e.error.message.includes('missing ) after argument list')) {
        showNotification('Page error detected. Please refresh the page.', 'danger');
    }
});

// Search customers function
function searchCustomers() {
    console.log('ðŸ” searchCustomers() called');
    
    const searchInput = document.getElementById('customerSearch');
    if (!searchInput) {
        console.error('âŒ Search input not found');
        return;
    }

    const filter = searchInput.value.toLowerCase().trim();
    console.log('ðŸ” Search filter:', filter);
    
    const table = document.querySelector('.spa-table tbody');
    if (!table) {
        console.error('âŒ Table not found');
        return;
    }

    const rows = table.getElementsByTagName('tr');
    let visibleCount = 0;
    console.log('ðŸ” Total rows to search:', rows.length);

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];

        // Skip the "no results" row if it exists
        if (row.id === 'noResultsRow') {
            continue;
        }

        // Get all text content from the row
        let rowText = '';
        
        // Get customer name from the first cell
        const nameCell = row.cells[0];
        if (nameCell) {
            const nameElement = nameCell.querySelector('.customer-info h5');
            if (nameElement) {
                rowText += nameElement.textContent || nameElement.innerText;
            }
        }

        // Get contact info from the second cell (phone and email)
        const contactCell = row.cells[1];
        if (contactCell) {
            // Get all text from this cell (includes phone and email)
            rowText += ' ' + (contactCell.textContent || contactCell.innerText);
        }

        // Clean and search
        rowText = rowText.toLowerCase().replace(/\s+/g, ' ').trim();

        // Show/hide row based on match
        const isMatch = filter === '' || rowText.includes(filter);
        row.style.display = isMatch ? '' : 'none';
        
        if (isMatch) {
            visibleCount++;
        }
    }

    // Show/hide "no results" message
    let noResultsRow = document.getElementById('noResultsRow');
    if (visibleCount === 0 && filter !== '') {
        if (!noResultsRow) {
            noResultsRow = table.insertRow();
            noResultsRow.id = 'noResultsRow';
            const cell = noResultsRow.insertCell(0);
            cell.colSpan = 6; // Match the number of columns
            cell.className = 'text-center text-muted py-4';
            cell.innerHTML = '<i class="fas fa-search fa-2x mb-2 d-block"></i>No customers found matching "' + filter + '"';
        } else {
            // Update the message with current search term
            const cell = noResultsRow.cells[0];
            cell.innerHTML = '<i class="fas fa-search fa-2x mb-2 d-block"></i>No customers found matching "' + filter + '"';
        }
        noResultsRow.style.display = '';
    } else if (noResultsRow) {
        noResultsRow.style.display = 'none';
    }

    console.log('âœ… Search completed. Visible rows:', visibleCount, 'Filter:', filter);
}

// Initialize search functionality - Multiple attempts to ensure it works
function initializeSearch() {
    const searchInput = document.getElementById('customerSearch');
    if (searchInput) {
        console.log('âœ… Search input found, attaching listeners');
        
        // Remove any existing event listeners by cloning
        const newSearchInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
        
        // Add input event listener for real-time search
        newSearchInput.addEventListener('input', function() {
            console.log('ðŸ” Search triggered:', this.value);
            searchCustomers();
        });

        // Also support Enter key
        newSearchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                console.log('ðŸ” Search triggered via Enter key');
                searchCustomers();
            }
        });

        // Support search icon click if it exists
        const searchIcon = document.querySelector('.search-icon');
        if (searchIcon) {
            searchIcon.style.cursor = 'pointer';
            searchIcon.addEventListener('click', function() {
                console.log('ðŸ” Search triggered via icon click');
                searchCustomers();
            });
        }

        // Trigger initial search if there's a pre-filled value
        if (newSearchInput.value) {
            console.log('ðŸ” Initial search with pre-filled value:', newSearchInput.value);
            searchCustomers();
        }

        console.log('âœ… Search functionality initialized successfully');
        return true;
    } else {
        console.error('âŒ customerSearch input not found');
        return false;
    }
}

// Initialize on DOM ready - with multiple attempts
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ” Initializing customer search...');
    
    // Try immediately
    if (!initializeSearch()) {
        // If it fails, try again after a short delay
        setTimeout(function() {
            console.log('ðŸ”„ Retrying search initialization...');
            if (!initializeSearch()) {
                // Try one more time after page is fully loaded
                setTimeout(function() {
                    console.log('ðŸ”„ Final retry for search initialization...');
                    initializeSearch();
                }, 1000);
            }
        }, 500);
    }
    
    // Also attach directly to the input if it exists
    const directSearch = document.getElementById('customerSearch');
    if (directSearch && !directSearch.dataset.listenerAttached) {
        directSearch.addEventListener('input', searchCustomers);
        directSearch.dataset.listenerAttached = 'true';
        console.log('âœ… Direct search listener attached as backup');
    }
});

// Clear search function
function clearSearch() {
    document.getElementById('customerSearch').value = '';
    searchCustomers();
}

// Focus search on Ctrl+F or Cmd+F
document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        const searchInput = document.getElementById('customerSearch');
        if (searchInput) {
            searchInput.focus();
        }
    }
});

console.log('Customer Management System: All scripts loaded');
</script>
{% endblock %}