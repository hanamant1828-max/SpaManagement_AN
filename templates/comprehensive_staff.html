{% extends "base.html" %}

{% block title %}Staff Management - Spa & Salon Management Suite{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-users-cog me-2"></i>Staff Management
                </h1>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staffModal" onclick="showAddModal()">
                        <i class="fas fa-plus me-2"></i>Add New Staff
                    </button>
                    <button type="button" class="btn btn-success" onclick="exportStaffData()">
                        <i class="fas fa-download me-2"></i>Export Data
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="refreshStaffData()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Total Staff</h5>
                            <h3 class="mb-0" id="totalStaffCount">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Active Staff</h5>
                            <h3 class="mb-0" id="activeStaffCount">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Departments</h5>
                            <h3 class="mb-0" id="departmentCount">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-building fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Roles</h5>
                            <h3 class="mb-0" id="roleCount">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-tag fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Search Staff</label>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Search by name, email, code..." 
                                   onkeyup="filterStaff()">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="roleFilter" onchange="filterStaff()">
                                <option value="">All Roles</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Department</label>
                            <select class="form-select" id="departmentFilter" onchange="filterStaff()">
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="statusFilter" onchange="filterStaff()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-outline-secondary d-block w-100" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Staff Members</h5>
                </div>
                <div class="card-body">
                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading staff data...</p>
                    </div>

                    <!-- Staff Table -->
                    <div id="staffTableContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Staff Info</th>
                                        <th>Role & Department</th>
                                        <th>Contact</th>
                                        <th>Work Details</th>
                                        <th>Performance</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="staffTableBody">
                                    <!-- Staff rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No staff members found</h5>
                        <p class="text-muted">Add your first staff member to get started.</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staffModal" onclick="showAddModal()">
                            <i class="fas fa-plus me-2"></i>Add Staff Member
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Staff Add/Edit Modal -->
<div class="modal fade" id="staffModal" tabindex="-1" aria-labelledby="staffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffModalLabel">Add New Staff Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="staffForm">
                <div class="modal-body">
                    <input type="hidden" id="staffId" value="">
                    <input type="hidden" id="formMode" value="add">

                    <div class="row g-3">
                        <!-- Basic Information -->
                        <div class="col-md-6">
                            <h6 class="text-primary border-bottom pb-2">Basic Information</h6>
                            <div class="mb-3">
                                <label class="form-label">Username *</label>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">First Name *</label>
                                        <input type="text" class="form-control" id="firstName" required>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Last Name *</label>
                                        <input type="text" class="form-control" id="lastName" required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Phone</label>
                                <input type="text" class="form-control" id="phone">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Password</label>
                                <input type="password" class="form-control" id="password">
                                <small class="form-text text-muted" id="passwordHelp">Leave blank to keep current password</small>
                            </div>
                        </div>

                        <!-- Role & Department -->
                        <div class="col-md-6">
                            <h6 class="text-primary border-bottom pb-2">Role & Department</h6>
                            <div class="mb-3">
                                <label class="form-label">Role</label>
                                <select class="form-select" id="roleId">
                                    <option value="">Select Role</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Department</label>
                                <select class="form-select" id="departmentId">
                                    <option value="">Select Department</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Designation</label>
                                <input type="text" class="form-control" id="designation">
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Commission Rate (%)</label>
                                        <input type="number" class="form-control" id="commissionRate" min="0" max="100" step="0.1">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Hourly Rate ($)</label>
                                        <input type="number" class="form-control" id="hourlyRate" min="0" step="0.01">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Personal Details -->
                        <div class="col-md-6">
                            <h6 class="text-primary border-bottom pb-2">Personal Details</h6>
                            <div class="mb-3">
                                <label class="form-label">Gender</label>
                                <select class="form-select" id="gender">
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Date of Birth</label>
                                        <input type="date" class="form-control" id="dateOfBirth">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Date of Joining</label>
                                        <input type="date" class="form-control" id="dateOfJoining">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Work Schedule -->
                        <div class="col-md-6">
                            <h6 class="text-primary border-bottom pb-2">Work Schedule</h6>
                            <div class="row">
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Shift Start</label>
                                        <input type="time" class="form-control" id="shiftStart">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-3">
                                        <label class="form-label">Shift End</label>
                                        <input type="time" class="form-control" id="shiftEnd">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Working Days</label>
                                <input type="text" class="form-control" id="workingDays" 
                                       placeholder="1111100 (Mon-Sun, 1=working, 0=off)">
                                <small class="form-text text-muted">Example: 1111100 = Monday to Friday working</small>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="enableFaceCheckin" checked>
                                <label class="form-check-label" for="enableFaceCheckin">
                                    Enable Face Check-in
                                </label>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2">Additional Information</h6>
                            <div class="mb-3">
                                <label class="form-label">Notes/Bio</label>
                                <textarea class="form-control" id="notesBio" rows="3" 
                                          placeholder="Additional notes or biography"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save me-1"></i>Save Staff
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5>Are you sure?</h5>
                    <p id="deleteMessage">This action cannot be undone.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Performance Modal -->
<div class="modal fade" id="performanceModal" tabindex="-1" aria-labelledby="performanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="performanceModalLabel">Staff Performance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="performanceContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading performance data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
    <!-- Alerts will be dynamically added here -->
</div>

<script>
// Global Variables
let allStaff = [];
let filteredStaff = [];
let rolesData = [];
let departmentsData = [];
let isEditing = false;
let currentDeleteId = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Bootstrap Modal Staff Management loaded');
    loadStaffData();
    setupFormHandlers();
    setupModalHandlers();
});

// Setup modal handlers
function setupModalHandlers() {
    // Clear form when modal is hidden
    document.getElementById('staffModal').addEventListener('hidden.bs.modal', function() {
        clearForm();
    });

    // Setup delete confirmation
    document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
        if (currentDeleteId) {
            performDelete(currentDeleteId);
        }
    });
}

// Load all staff data from API
async function loadStaffData() {
    try {
        showLoading(true);

        const response = await fetch('/api/staff');
        const data = await response.json();

        if (data.success) {
            allStaff = data.staff;
            rolesData = data.roles;
            departmentsData = data.departments;

            populateDropdowns();
            updateStats();
            renderStaffTable();
            showAlert('Staff data loaded successfully', 'success');
        } else {
            throw new Error(data.error || 'Failed to load staff data');
        }
    } catch (error) {
        console.error('Error loading staff data:', error);
        showAlert('Error loading staff data: ' + error.message, 'danger');
        showEmptyState();
    } finally {
        showLoading(false);
    }
}

// Populate dropdown menus
function populateDropdowns() {
    // Populate role dropdowns
    const roleSelects = ['roleFilter', 'roleId'];
    roleSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            // Clear existing options (except first)
            const firstOption = select.firstElementChild;
            select.innerHTML = '';
            select.appendChild(firstOption);

            rolesData.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.display_name;
                select.appendChild(option);
            });
        }
    });

    // Populate department dropdowns
    const deptSelects = ['departmentFilter', 'departmentId'];
    deptSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            // Clear existing options (except first)
            const firstOption = select.firstElementChild;
            select.innerHTML = '';
            select.appendChild(firstOption);

            departmentsData.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.display_name;
                select.appendChild(option);
            });
        }
    });
}

// Update statistics cards
function updateStats() {
    const totalStaff = allStaff.length;
    const activeStaff = allStaff.filter(s => s.is_active).length;

    document.getElementById('totalStaffCount').textContent = totalStaff;
    document.getElementById('activeStaffCount').textContent = activeStaff;
    document.getElementById('departmentCount').textContent = departmentsData.length;
    document.getElementById('roleCount').textContent = rolesData.length;
}

// Render staff table
function renderStaffTable() {
    filteredStaff = [...allStaff];
    filterStaff();

    const tbody = document.getElementById('staffTableBody');
    tbody.innerHTML = '';

    if (filteredStaff.length === 0) {
        showEmptyState();
        return;
    }

    filteredStaff.forEach(staff => {
        const row = createStaffRow(staff);
        tbody.appendChild(row);
    });

    showTable(true);
}

// Create staff table row
function createStaffRow(staff) {
    const row = document.createElement('tr');
    row.setAttribute('data-staff-id', staff.id);

    // Generate initials
    const initials = (staff.first_name?.[0] || 'S') + (staff.last_name?.[0] || 'M');

    row.innerHTML = `
        <td>
            <div class="d-flex align-items-center">
                <div class="avatar-circle me-3" style="width: 40px; height: 40px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                    ${initials}
                </div>
                <div>
                    <strong>${staff.full_name}</strong>
                    <br><small class="text-muted">${staff.staff_code || ''}</small>
                    <br><small class="text-muted">${staff.username}</small>
                </div>
            </div>
        </td>
        <td>
            <div><strong>${staff.role_display}</strong></div>
            <div><small class="text-muted">${staff.department_display}</small></div>
            <div><span class="badge bg-secondary">${staff.designation || 'No Designation'}</span></div>
        </td>
        <td>
            <div>${staff.email || 'No email'}</div>
            <div><small class="text-muted">${staff.phone || 'No phone'}</small></div>
            ${staff.gender ? `<div><small class="text-muted">${staff.gender.charAt(0).toUpperCase() + staff.gender.slice(1)}</small></div>` : ''}
        </td>
        <td>
            <div><strong>Commission:</strong> ${staff.commission_rate}%</div>
            <div><strong>Hourly:</strong> $${staff.hourly_rate}</div>
            ${staff.shift_start_time && staff.shift_end_time ? 
                `<div><small>Shift: ${staff.shift_start_time} - ${staff.shift_end_time}</small></div>` : 
                '<div><small>No shift set</small></div>'
            }
        </td>
        <td>
            <div><strong>Revenue:</strong> $${staff.total_revenue_generated.toFixed(2)}</div>
            <div><small>Clients: ${staff.total_clients_served}</small></div>
            ${staff.average_rating > 0 ? `<div><small>Rating: ‚≠ê${staff.average_rating.toFixed(1)}</small></div>` : ''}
        </td>
        <td>
            <span class="badge bg-${staff.is_active ? 'success' : 'danger'}">
                ${staff.is_active ? 'Active' : 'Inactive'}
            </span>
            ${staff.verification_status ? '<br><span class="badge bg-info mt-1">Verified</span>' : ''}
            ${staff.enable_face_checkin ? '<br><span class="badge bg-primary mt-1">Face ID</span>' : ''}
        </td>
        <td>
            <div class="btn-group-vertical btn-group-sm">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="editStaff(${staff.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="viewPerformance(${staff.id})" title="Performance">
                    <i class="fas fa-chart-line"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="showDeleteModal(${staff.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;

    return row;
}

// Filter staff based on search and filters
function filterStaff() {
    let filtered = [...allStaff];

    // Search filter
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    if (searchTerm) {
        filtered = filtered.filter(staff => 
            staff.full_name.toLowerCase().includes(searchTerm) ||
            staff.email.toLowerCase().includes(searchTerm) ||
            staff.staff_code.toLowerCase().includes(searchTerm) ||
            staff.username.toLowerCase().includes(searchTerm) ||
            staff.phone.includes(searchTerm)
        );
    }

    // Role filter
    const roleFilter = document.getElementById('roleFilter').value;
    if (roleFilter) {
        filtered = filtered.filter(staff => staff.role_id == roleFilter);
    }

    // Department filter
    const deptFilter = document.getElementById('departmentFilter').value;
    if (deptFilter) {
        filtered = filtered.filter(staff => staff.department_id == deptFilter);
    }

    // Status filter
    const statusFilter = document.getElementById('statusFilter').value;
    if (statusFilter === 'active') {
        filtered = filtered.filter(staff => staff.is_active);
    } else if (statusFilter === 'inactive') {
        filtered = filtered.filter(staff => !staff.is_active);
    }

    filteredStaff = filtered;
    renderFilteredStaff();
}

// Render filtered staff
function renderFilteredStaff() {
    const tbody = document.getElementById('staffTableBody');
    tbody.innerHTML = '';

    if (filteredStaff.length === 0) {
        showEmptyState();
        return;
    }

    filteredStaff.forEach(staff => {
        const row = createStaffRow(staff);
        tbody.appendChild(row);
    });

    showTable(true);
}

// Clear all filters
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('roleFilter').value = '';
    document.getElementById('departmentFilter').value = '';
    document.getElementById('statusFilter').value = '';
    filterStaff();
}

// Show/hide loading state
function showLoading(show) {
    document.getElementById('loadingState').style.display = show ? 'block' : 'none';
    document.getElementById('staffTableContainer').style.display = show ? 'none' : 'block';
    document.getElementById('emptyState').style.display = 'none';
}

// Show/hide table
function showTable(show) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('staffTableContainer').style.display = show ? 'block' : 'none';
    document.getElementById('emptyState').style.display = show ? 'none' : 'block';
}

// Show empty state
function showEmptyState() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('staffTableContainer').style.display = 'none';
    document.getElementById('emptyState').style.display = 'block';
}

// Show add modal
function showAddModal() {
    isEditing = false;
    document.getElementById('formMode').value = 'add';
    document.getElementById('staffModalLabel').textContent = 'Add New Staff Member';
    document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save me-1"></i>Add Staff';
    document.getElementById('passwordHelp').textContent = 'Password is required for new staff';
    document.getElementById('password').required = true;

    clearForm();
}

// Edit staff
async function editStaff(staffId) {
    try {
        isEditing = true;
        document.getElementById('formMode').value = 'edit';
        document.getElementById('staffModalLabel').textContent = 'Edit Staff Member';
        document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save me-1"></i>Update Staff';
        document.getElementById('passwordHelp').textContent = 'Leave blank to keep current password';
        document.getElementById('password').required = false;

        // Load staff data
        const response = await fetch(`/api/staff/${staffId}`);
        const data = await response.json();

        if (data.success) {
            populateForm(data.staff);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('staffModal'));
            modal.show();
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showAlert('Error loading staff data: ' + error.message, 'danger');
    }
}

// Populate form with staff data
function populateForm(staff) {
    document.getElementById('staffId').value = staff.id;
    document.getElementById('username').value = staff.username || '';
    document.getElementById('firstName').value = staff.first_name || '';
    document.getElementById('lastName').value = staff.last_name || '';
    document.getElementById('email').value = staff.email || '';
    document.getElementById('phone').value = staff.phone || '';
    document.getElementById('roleId').value = staff.role_id || '';
    document.getElementById('departmentId').value = staff.department_id || '';
    document.getElementById('designation').value = staff.designation || '';
    document.getElementById('commissionRate').value = staff.commission_rate || '';
    document.getElementById('hourlyRate').value = staff.hourly_rate || '';
    document.getElementById('gender').value = staff.gender || '';
    document.getElementById('dateOfBirth').value = staff.date_of_birth || '';
    document.getElementById('dateOfJoining').value = staff.date_of_joining || '';
    document.getElementById('shiftStart').value = staff.shift_start_time || '';
    document.getElementById('shiftEnd').value = staff.shift_end_time || '';
    document.getElementById('workingDays').value = staff.working_days || '';
    document.getElementById('enableFaceCheckin').checked = staff.enable_face_checkin;
    document.getElementById('notesBio').value = staff.notes_bio || '';
}

// Clear form
function clearForm() {
    document.getElementById('staffForm').reset();
    document.getElementById('staffId').value = '';
    // Clear any validation messages
    const invalidFields = document.querySelectorAll('.is-invalid');
    invalidFields.forEach(field => field.classList.remove('is-invalid'));
    const validationErrors = document.querySelectorAll('.validation-error');
    validationErrors.forEach(error => error.remove());
}

// Setup form handlers
function setupFormHandlers() {
    const form = document.getElementById('staffForm');

    // Form submission handler
    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        // Before submitting, perform a final validation check on all fields
        let isFormValid = true;
        const requiredFields = ['username', 'firstName', 'lastName', 'email'];
        requiredFields.forEach(fieldId => {
            if (!validateSingleField(fieldId)) {
                isFormValid = false;
            }
        });

        // Additional check for password if it's a new staff member
        if (!isEditing) {
            const passwordField = document.getElementById('password');
            if (!passwordField.value.trim()) {
                isFormValid = false;
                validateSingleField('password'); // Trigger validation message for password
            }
        }

        if (!isFormValid) {
            showAlert('Please correct the errors before submitting.', 'warning');
            return; // Stop submission if form is invalid
        }

        // Disable submit button to prevent double submission
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

        try {
            await saveStaff();
        } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });

    // Real-time validation for required fields
    const requiredFields = ['username', 'firstName', 'lastName', 'email'];
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('blur', function() {
                validateSingleField(fieldId);
            });

            field.addEventListener('input', function() {
                // Clear validation error on input
                this.classList.remove('is-invalid');
                const errorElement = this.parentNode.querySelector('.validation-error');
                if (errorElement) {
                    errorElement.remove();
                }
            });
        }
    });

    // Email validation on blur
    const emailField = document.getElementById('email');
    if (emailField) {
        emailField.addEventListener('blur', function() {
            const email = this.value.trim();
            if (email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    this.classList.add('is-invalid');
                    const existingError = this.parentNode.querySelector('.validation-error');
                    if (!existingError) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'validation-error text-danger small mt-1';
                        errorDiv.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>Please enter a valid email address';
                        this.parentNode.insertBefore(errorDiv, this.nextSibling);
                    }
                } else {
                    // If email is valid and correct, remove error classes
                    this.classList.remove('is-invalid');
                    const errorElement = this.parentNode.querySelector('.validation-error');
                    if (errorElement) {
                        errorElement.remove();
                    }
                }
            } else {
                // If email field is empty on blur, remove error classes if they exist
                this.classList.remove('is-invalid');
                this.classList.remove('is-valid');
                const errorElement = this.parentNode.querySelector('.validation-error');
                if (errorElement) {
                    errorElement.remove();
                }
            }
        });
    }

    // Password validation for new staff
    const passwordField = document.getElementById('password');
    if (passwordField) {
        passwordField.addEventListener('blur', function() {
            // Only validate if it's a new staff member and the field is empty
            if (!isEditing && !this.value.trim()) {
                this.classList.add('is-invalid');
                const existingError = this.parentNode.querySelector('.validation-error');
                if (!existingError) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'validation-error text-danger small mt-1';
                    errorDiv.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>Password is required for new staff members';
                    this.parentNode.insertBefore(errorDiv, this.nextSibling);
                }
            } else if (!isEditing && this.value.trim()) {
                 // If it's a new staff member and password is provided, clear any potential prior error
                this.classList.remove('is-invalid');
                const errorElement = this.parentNode.querySelector('.validation-error');
                if (errorElement) {
                    errorElement.remove();
                }
            }
        });
    }
}

// Validate single field
function validateSingleField(fieldId) {
    const field = document.getElementById(fieldId);
    if (!field) return false; // Return false if field doesn't exist

    const value = field.value.trim();
    let isValid = true;
    let errorMessage = '';

    switch (fieldId) {
        case 'username':
            if (!value) {
                isValid = false;
                errorMessage = 'Username is required';
            } else if (value.length < 3) {
                isValid = false;
                errorMessage = 'Username must be at least 3 characters';
            } else if (!/^[a-zA-Z0-9_]+$/.test(value)) {
                isValid = false;
                errorMessage = 'Username can only contain letters, numbers, and underscores';
            }
            break;
        case 'firstName':
            if (!value) {
                isValid = false;
                errorMessage = 'First name is required';
            } else if (value.length > 50) {
                isValid = false;
                errorMessage = 'First name cannot exceed 50 characters';
            }
            break;
        case 'lastName':
            if (!value) {
                isValid = false;
                errorMessage = 'Last name is required';
            } else if (value.length > 50) {
                isValid = false;
                errorMessage = 'Last name cannot exceed 50 characters';
            }
            break;
        case 'email':
            if (!value) {
                isValid = false;
                errorMessage = 'Email is required';
            } else {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(value)) {
                    isValid = false;
                    errorMessage = 'Please enter a valid email address';
                }
            }
            break;
        case 'password': // Specific validation for password if needed elsewhere
            if (!isEditing && !value) {
                isValid = false;
                errorMessage = 'Password is required for new staff members';
            }
            break;
    }

    // Update field visual state
    if (isValid) {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        const errorElement = field.parentNode.querySelector('.validation-error');
        if (errorElement) {
            errorElement.remove();
        }
    } else {
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        const existingError = field.parentNode.querySelector('.validation-error');
        if (!existingError) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'validation-error text-danger small mt-1';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i>${errorMessage}`;
            field.parentNode.insertBefore(errorDiv, field.nextSibling);
        } else {
            // Update existing error message if it's different
            existingError.innerHTML = `<i class="fas fa-exclamation-circle me-1"></i>${errorMessage}`;
        }
    }

    return isValid;
}