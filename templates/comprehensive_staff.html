{% extends "base.html" %} 

{% block title %}Staff Management - Spa & Salon Management Suite{% endblock %} 

{% block body_class %}page-staff-management{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-users-cog me-2"></i>Staff Management
                </h1>
                <div class="btn-group">
                    <button
                        type="button"
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#staffModal"
                        onclick="showAddModal()"
                    >
                        <i class="fas fa-plus me-2"></i>Add New Staff
                    </button>
                    <button
                        type="button"
                        class="btn btn-success"
                        onclick="exportStaffData()"
                    >
                        <i class="fas fa-download me-2"></i>Export Data
                    </button>
                    <button
                        type="button"
                        class="btn btn-outline-secondary"
                        onclick="refreshStaffData()"
                    >
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Total Staff</h5>
                            <h3 class="mb-0" id="totalStaffCount">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Active Staff</h5>
                            <h3 class="mb-0" id="activeStaffCount">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Departments</h5>
                            <h3 class="mb-0" id="departmentCount">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-building fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title">Total Staff</h5>
                            <h3 class="mb-0" id="roleCount">0</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Search Staff</label>
                            <input
                                type="text"
                                class="form-control"
                                id="searchInput"
                                placeholder="Search by name, email, code..."
                                onkeyup="filterStaff()"
                            />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Department</label>
                            <select
                                class="form-select"
                                id="departmentFilter"
                                onchange="filterStaff()"
                            >
                                <option value="">All Departments</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Status</label>
                            <select
                                class="form-select"
                                id="statusFilter"
                                onchange="filterStaff()"
                            >
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button
                                type="button"
                                class="btn btn-outline-secondary d-block w-100"
                                onclick="clearFilters()"
                            >
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Staff Members</h5>
                </div>
                <div class="card-body">
                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading staff data...</p>
                    </div>

                    <!-- Staff Table -->
                    <div id="staffTableContainer" style="display: none">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Staff Info</th>
                                        <th>Department & Designation</th>
                                        <th>Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="staffTableBody">
                                    <!-- Staff rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div
                        id="emptyState"
                        class="text-center py-5"
                        style="display: none"
                    >
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No staff members found</h5>
                        <p class="text-muted">
                            No staff available. Please add new staff to get started.
                        </p>
                        <button
                            type="button"
                            class="btn btn-primary btn-lg"
                            data-bs-toggle="modal"
                            data-bs-target="#staffModal"
                            onclick="showAddModal()"
                        >
                            <i class="fas fa-plus me-2"></i>Add Your First Staff Member
                        </button>
                        <div class="mt-3">
                            <small class="text-muted">
                                Staff members will appear here once added
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Staff Add/Edit Modal - Enhanced UI/UX -->
<div
    class="modal fade"
    id="staffModal"
    tabindex="-1"
    aria-labelledby="staffModalLabel"
    aria-hidden="true"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
>
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title d-flex align-items-center" id="staffModalLabel">
                    <i class="fas fa-user-plus me-2"></i>
                    <span id="modalTitleText">Add New Staff Member</span>
                </h5>
                <span class="badge bg-light text-primary ms-auto me-3">
                    <i class="fas fa-users me-1"></i>Staff Management
                </span>
            </div>
            <form id="staffFormComprehensive">
                <div class="modal-body" style="background-color: #f8f9fa; max-height: calc(100vh - 250px); overflow-y: auto;">
                    <input type="hidden" id="staffId" value="" />
                    <input type="hidden" id="formMode" value="add" />

                    <!-- Progress Indicator -->
                    <div class="alert alert-info mb-4 d-flex align-items-center">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>
                            <strong>Required Fields:</strong> Fields marked with <span class="text-danger">*</span> are mandatory.
                            <span id="editModeIndicator" class="ms-3 badge bg-warning" style="display: none;">
                                <i class="fas fa-edit me-1"></i>Edit Mode
                            </span>
                        </div>
                    </div>

                    <!-- Form Sections with Cards -->
                    <div class="row g-4">
                        <!-- Left Column -->
                        <div class="col-lg-6">
                            <!-- Basic Information Card -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white border-bottom">
                                    <h6 class="mb-0 text-primary">
                                        <i class="fas fa-user-circle me-2"></i>Basic Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">
                                            Username <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-user"></i>
                                            </span>
                                            <input
                                                type="text"
                                                class="form-control"
                                                id="username"
                                                placeholder="Enter unique username"
                                                required
                                            />
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-lightbulb me-1"></i>Used for login access
                                        </small>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    First Name <span class="text-danger">*</span>
                                                </label>
                                                <input
                                                    type="text"
                                                    class="form-control"
                                                    id="firstName"
                                                    placeholder="Enter first name"
                                                    required
                                                />
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">
                                                    Last Name <span class="text-danger">*</span>
                                                </label>
                                                <input
                                                    type="text"
                                                    class="form-control"
                                                    id="lastName"
                                                    placeholder="Enter last name"
                                                    required
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">
                                            Email Address
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-envelope"></i>
                                            </span>
                                            <input
                                                type="email"
                                                class="form-control"
                                                id="email"
                                                placeholder="staff@example.com"
                                            />
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">
                                            Phone Number
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-phone"></i>
                                            </span>
                                            <input
                                                type="tel"
                                                class="form-control"
                                                id="phone"
                                                placeholder="Enter phone number"
                                                maxlength="15"
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Security Card -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white border-bottom">
                                    <h6 class="mb-0 text-primary">
                                        <i class="fas fa-lock me-2"></i>Security
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">
                                            Password
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-key"></i>
                                            </span>
                                            <input
                                                type="password"
                                                class="form-control"
                                                id="password"
                                                placeholder="Enter password"
                                            />
                                            <button
                                                class="btn btn-outline-secondary"
                                                type="button"
                                                id="togglePassword"
                                                onclick="togglePasswordVisibilityInForm()"
                                            >
                                                <i class="fas fa-eye" id="passwordIcon"></i>
                                            </button>
                                        </div>
                                        <small class="form-text text-muted" id="passwordHelp">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Leave blank for auto-generated password
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-lg-6">
                            <!-- Department & Work Info Card -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white border-bottom">
                                    <h6 class="mb-0 text-primary">
                                        <i class="fas fa-building me-2"></i>Department & Work Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">
                                            Department
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-sitemap"></i>
                                            </span>
                                            <select class="form-select" id="departmentId">
                                                <option value="">Select Department</option>
                                            </select>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-lightbulb me-1"></i>Assign staff to a department
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Personal Details Card -->
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white border-bottom">
                                    <h6 class="mb-0 text-primary">
                                        <i class="fas fa-id-card me-2"></i>Personal Details
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">
                                                Gender
                                            </label>
                                            <select class="form-select" id="gender">
                                                <option value="">Select Gender</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                                <option value="other">Other</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">
                                                Date of Birth <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">
                                                    <i class="fas fa-calendar"></i>
                                                </span>
                                                <input
                                                    type="date"
                                                    class="form-control"
                                                    id="dateOfBirth"
                                                    required
                                                />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">
                                            Date of Joining <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-calendar-check"></i>
                                            </span>
                                            <input
                                                type="date"
                                                class="form-control"
                                                id="dateOfJoining"
                                                required
                                            />
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-lightbulb me-1"></i>When the staff member joined
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Full Width Notes Section -->
                        <div class="col-12">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white border-bottom">
                                    <h6 class="mb-0 text-primary">
                                        <i class="fas fa-sticky-note me-2"></i>Additional Information
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-0">
                                        <label class="form-label fw-bold">
                                            Notes / Biography
                                        </label>
                                        <textarea
                                            class="form-control"
                                            id="notesBio"
                                            rows="3"
                                            placeholder="Add any additional notes, biography, or special instructions..."
                                        ></textarea>
                                        <small class="text-muted">
                                            <i class="fas fa-lightbulb me-1"></i>Optional information about the staff member
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-white border-top d-flex justify-content-between" style="position: sticky; bottom: 0; z-index: 1040; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
                    <button
                        type="button"
                        class="btn btn-secondary btn-lg"
                        id="btnStaffClose"
                        data-bs-dismiss="modal"
                    >
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button
                        type="submit"
                        class="btn btn-primary btn-lg px-4"
                        id="btnStaffSave"
                    >
                        <i class="fas fa-save me-2"></i>
                        <span id="saveButtonText">Save Staff Member</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div
    class="modal fade"
    id="deleteModal"
    tabindex="-1"
    aria-labelledby="deleteModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    Confirm Delete
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i
                        class="fas fa-exclamation-triangle fa-3x text-warning mb-3"
                    ></i>
                    <h5>Are you sure?</h5>
                    <p id="deleteMessage">This action cannot be undone.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Cancel
                </button>
                <button
                    type="button"
                    class="btn btn-danger"
                    id="confirmDeleteBtn"
                >
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Performance Modal -->
<div
    class="modal fade"
    id="performanceModal"
    tabindex="-1"
    aria-labelledby="performanceModalLabel"
    aria-hidden="true"
>
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="performanceModalLabel">
                    Staff Performance
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                ></button>
            </div>
            <div class="modal-body">
                <div id="performanceContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading performance data...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div
    id="alertContainer"
    class="position-fixed top-0 end-0 p-3"
    style="z-index: 1050"
>
    <!-- Alerts will be dynamically added here -->
</div>

<script>
    // Basic staff management JavaScript
    let allStaff = []; // Renamed from staffList to avoid conflict with filteredStaff
    let filteredStaff = []; // Declare filteredStaff variable
    let rolesData = []; // Renamed from roles
    let departmentsData = []; // Renamed from departments
    let services = []; // Assuming this is intended to be used elsewhere or is a placeholder
    let currentStaffId = null;
    let staffModal;
    let isEditing = false; // Added to track edit mode
    let currentDeleteId = null; // Added for delete confirmation
    let hasUnsavedChanges = false; // Track unsaved changes
    let authorizedCloseSource = null; // Track authorized close source

    document.addEventListener("DOMContentLoaded", function () {
        console.log("Bootstrap Modal Staff Management loaded");

        try {
            // Initialize modal with comprehensive protection
            const modalElement = document.getElementById("staffModal");
            if (modalElement) {
                staffModal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',  // Prevent backdrop close
                    keyboard: false      // Prevent Esc key close
                });

                // Set up comprehensive modal protection
                setupModalProtection(modalElement);
            } else {
                console.error("Staff modal element not found");
            }

            // Load initial data immediately on page load
            console.log("Starting initial staff data load...");
            loadStaffData();
            loadMetadata();

            // Setup form submission
            const staffForm = document.getElementById("staffFormComprehensive");
            if (staffForm) {
                staffForm.addEventListener("submit", handleFormSubmission);
                // Track form changes for unsaved changes detection
                trackFormChanges(staffForm);
            } else {
                console.error("Staff form not found");
            }

            // Setup authorized close buttons
            setupAuthorizedCloseButtons();

            // Setup delete confirmation button
            const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener("click", () => {
                    performDelete(currentDeleteId);
                });
            }

        } catch (error) {
            console.error("Error initializing staff management:", error);
            showNotification("Error initializing staff management. Please refresh the page.", "error");
        }
    });

    // Comprehensive modal protection system
    // Only Close/Save/Update buttons can close the modal as per requirements
    function setupModalProtection(modalElement) {
        console.log("Setting up comprehensive modal protection");

        // Intercept all hide attempts
        modalElement.addEventListener('hide.bs.modal', function(event) {
            console.log("Modal hide attempt detected, source:", authorizedCloseSource);

            // Only allow authorized close sources
            if (!isAuthorizedClose()) {
                console.log("Unauthorized close attempt blocked");
                event.preventDefault();
                event.stopPropagation();
                return false;
            }

            // Reset authorization after successful close
            authorizedCloseSource = null;
        });

        // Block any programmatic hide attempts
        const originalHide = staffModal.hide;
        staffModal.hide = function() {
            if (!isAuthorizedClose()) {
                console.log("Programmatic hide blocked - unauthorized source");
                return;
            }
            originalHide.call(this);
        };

        // Reset form state when modal is fully hidden
        modalElement.addEventListener('hidden.bs.modal', function() {
            hasUnsavedChanges = false;
            authorizedCloseSource = null;
        });
    }

    // Check if the current close attempt is from an authorized source
    function isAuthorizedClose() {
        return authorizedCloseSource === 'btnStaffClose' ||
               authorizedCloseSource === 'btnStaffSave';
    }

    // Setup event listeners for authorized close buttons
    function setupAuthorizedCloseButtons() {
        // Close button with unsaved changes confirmation
        const closeBtn = document.getElementById("btnStaffClose");
        if (closeBtn) {
            closeBtn.addEventListener("click", handleCloseButton);
        }

        // Save button (form submission will trigger close)
        const saveBtn = document.getElementById("btnStaffSave");
        if (saveBtn) {
            // The form submission will handle the close after successful save
            console.log("Save button found and ready");
        }
    }

    // Handle Close button click with unsaved changes confirmation
    async function handleCloseButton() {
        if (hasUnsavedChanges) {
            const confirmClose = await showUnsavedChangesDialog();
            if (!confirmClose) {
                return; // User chose to cancel
            }
        }

        // Authorize the close and close the modal
        authorizedCloseSource = 'btnStaffClose';
        staffModal.hide();
    }

    // Show unsaved changes confirmation dialog
    function showUnsavedChangesDialog() {
        return new Promise((resolve) => {
            const result = confirm("You have unsaved changes. Do you want to discard them and close?");
            resolve(result);
        });
    }

    // Track form changes to detect unsaved modifications
    function trackFormChanges(form) {
        const inputs = form.querySelectorAll('input, select, textarea');

        inputs.forEach(input => {
            input.addEventListener('input', () => {
                hasUnsavedChanges = true;
            });

            input.addEventListener('change', () => {
                hasUnsavedChanges = true;
            });
        });
    }

    async function handleFormSubmission(e) {
        e.preventDefault();

        const formMode = document.getElementById("formMode");
        
        if (!formMode) {
            console.error("Form mode element not found");
            showNotification("Form elements not found. Please refresh the page.", "error");
            return;
        }

        const mode = formMode.value;
        
        // Get the correct submit button based on mode
        const submitBtn = document.getElementById("btnStaffSave");
        
        if (!submitBtn) {
            console.error("Submit button not found");
            showNotification("Form elements not found. Please refresh the page.", "error");
            return;
        }

        const originalText = submitBtn.innerHTML;

        try {
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            const formData = collectFormData();

            // Validate required fields
            const validation = validateFormData(formData);
            if (!validation.isValid) {
                showNotification(validation.message, "error");
                // Reset button state immediately on validation failure
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                return;
            }

            let response;
            if (mode === "edit") {
                response = await updateStaff(currentStaffId, formData);
            } else {
                response = await createStaff(formData);
            }

            if (response && response.success) {
                // Show user-friendly success message
                const successMsg = mode === "edit"
                    ? `âœ“ Staff member updated successfully! Changes have been saved.`
                    : `âœ“ New staff member added successfully! Welcome to the team.`;
                showNotification(successMsg, "success");

                // Authorize close from Save button and close modal
                authorizedCloseSource = 'btnStaffSave';
                hasUnsavedChanges = false; // Clear unsaved changes flag

                // Close modal safely
                if (staffModal) {
                    staffModal.hide();
                } else {
                    console.error("Staff modal not available for closing");
                }

                // Reload staff list with error handling
                try {
                    await loadStaffData();
                } catch (loadError) {
                    console.error("Error reloading staff data:", loadError);
                    showNotification("âš  Staff saved successfully, but the list couldn't refresh. Please refresh the page to see updates.", "warning");
                }
            } else {
                const errorMsg = response?.error || "Unable to save staff member. Please try again.";
                showNotification(`âœ— Error: ${errorMsg}`, "error");
            }
        } catch (error) {
            console.error("Form submission error:", error);
            showNotification(`âœ— Unable to save: ${error.message}. Please check your connection and try again.`, "error");
        } finally {
            // Reset button state safely
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }
    }

    function validateFormData(data) {
        // Helper function to format field names properly
        const formatFieldName = (field) => {
            const names = {
                'username': 'Username',
                'first_name': 'First Name',
                'last_name': 'Last Name',
                'email': 'Email Address',
                'phone': 'Phone Number',
                'date_of_birth': 'Date of Birth',
                'date_of_joining': 'Date of Joining',
                'department_id': 'Department',
                'designation': 'Designation'
            };
            return names[field] || field.replace("_", " ");
        };

        // Required fields validation
        const required = ["username", "first_name", "last_name"];
        for (const field of required) {
            if (!data[field] || data[field].trim() === "") {
                return {
                    isValid: false,
                    message: `${formatFieldName(field)} is required. Please enter a ${formatFieldName(field).toLowerCase()}.`,
                };
            }
        }

        // Username format validation
        if (data.username) {
            if (data.username.length < 3) {
                return {
                    isValid: false,
                    message: "Username must be at least 3 characters long.",
                };
            }
            if (!/^[a-zA-Z0-9_]+$/.test(data.username)) {
                return {
                    isValid: false,
                    message: "Username can only contain letters, numbers, and underscores.",
                };
            }
        }

        // Email validation (only if email is provided)
        if (data.email && data.email.trim() !== "") {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(data.email)) {
                return {
                    isValid: false,
                    message: "Please enter a valid email address (e.g., name@example.com).",
                };
            }
        }

        // Phone validation (only if phone is provided)
        if (data.phone && data.phone.trim() !== "") {
            const phoneRegex = /^[+]?[\d\s\-()]+$/;
            if (!phoneRegex.test(data.phone)) {
                return {
                    isValid: false,
                    message: "Please enter a valid phone number.",
                };
            }
            if (data.phone.replace(/\D/g, '').length < 10) {
                return {
                    isValid: false,
                    message: "Phone number must be at least 10 digits.",
                };
            }
        }

        // Date of Birth validation
        if (!data.date_of_birth) {
            return {
                isValid: false,
                message: "Date of Birth is required. Please select the staff member's birth date.",
            };
        } else {
            const birthDate = new Date(data.date_of_birth);
            const today = new Date();
            const age = today.getFullYear() - birthDate.getFullYear();
            if (age < 16) {
                return {
                    isValid: false,
                    message: "Staff member must be at least 16 years old.",
                };
            }
            if (age > 100) {
                return {
                    isValid: false,
                    message: "Please enter a valid Date of Birth.",
                };
            }
        }

        // Date of Joining validation
        if (!data.date_of_joining) {
            return {
                isValid: false,
                message: "Date of Joining is required. Please select when the staff member joined.",
            };
        } else {
            const joiningDate = new Date(data.date_of_joining);
            const today = new Date();
            if (joiningDate > today) {
                return {
                    isValid: false,
                    message: "Date of Joining cannot be in the future.",
                };
            }
            const birthDate = new Date(data.date_of_birth);
            if (joiningDate < birthDate) {
                return {
                    isValid: false,
                    message: "Date of Joining cannot be before Date of Birth.",
                };
            }
        }

        // Shift time validation (if both are provided)
        if (data.shift_start_time && data.shift_end_time) {
            const [startHour, startMin] = data.shift_start_time.split(':').map(Number);
            const [endHour, endMin] = data.shift_end_time.split(':').map(Number);
            const startMinutes = startHour * 60 + startMin;
            const endMinutes = endHour * 60 + endMin;

            if (startMinutes >= endMinutes) {
                return {
                    isValid: false,
                    message: "Shift end time must be after shift start time.",
                };
            }
        }

        return { isValid: true };
    }

    async function createStaff(staffData) {
        try {
            console.log("Creating staff with data:", staffData);

            const response = await fetch("/api/staff", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(staffData),
            });

            const result = await response.json();

            console.log("API Response:", result);

            if (!response.ok) {
                // Provide user-friendly error messages based on HTTP status
                let errorMsg = result.error || "Unable to add staff member";

                if (response.status === 409) {
                    errorMsg = "Username or email already exists. Please use a different one.";
                } else if (response.status === 400) {
                    errorMsg = result.error || "Invalid data provided. Please check all fields.";
                } else if (response.status === 403) {
                    errorMsg = "You don't have permission to add staff members.";
                } else if (response.status === 500) {
                    errorMsg = "Server error. Please try again or contact support.";
                }

                throw new Error(errorMsg);
            }

            return result;
        } catch (error) {
            console.error("Error creating staff:", error);
            return {
                success: false,
                error: error.message || "Failed to create staff member. Please try again.",
            };
        }
    }

    function collectFormData() {
        const data = {
            username: getFieldValue("username"),
            first_name: getFieldValue("firstName"),
            last_name: getFieldValue("lastName"),
            email: getFieldValue("email") || '',  // Use empty string instead of null
            phone: getFieldValue("phone") || null,
            password: getFieldValue("password"),
            role: 'staff',  // Always set to staff
            role_id: null,  // No dynamic role needed
            department_id: getFieldValue("departmentId") || null,
            gender: getFieldValue("gender") || "other",
            date_of_birth: getFieldValue("dateOfBirth") || null,
            date_of_joining: getFieldValue("dateOfJoining") || null,
            shift_start_time: getFieldValue("shiftStart", true) || null,
            shift_end_time: getFieldValue("shiftEnd", true) || null,

            notes_bio: getFieldValue("notesBio") || "",
            enable_face_checkin: getCheckboxValue("enableFaceCheckin"),
            is_active: true
        };

        console.log("Collected form data:", data);
        return data;
    }

    function getFieldValue(fieldId, optional = false) {
        const field = document.getElementById(fieldId);
        if (!field) {
            // Only warn about missing required fields
            if (!optional) {
                console.warn(`Field ${fieldId} not found`);
            }
            return "";
        }
        return field.value?.trim() || "";
    }

    function getCheckboxValue(fieldId, defaultValue = false) {
        const element = document.getElementById(fieldId);
        return element ? element.checked : defaultValue;
    }

    // Load metadata (roles, departments, services)
    async function loadMetadata() {
        // This function loads dropdown data and is called from loadStaffData
        // The actual loading is handled in loadStaffData for efficiency
        console.log("Metadata loading handled in loadStaffData");
    }

    // Load all staff data from API with comprehensive error handling
    async function loadStaffData() {
        try {
            console.log("ðŸ“Š Loading staff data from API...");
            showLoading(true);

            const response = await fetch("/api/staff");

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.success) {
                // Safely assign data with fallbacks
                allStaff = Array.isArray(data.staff) ? data.staff : [];
                filteredStaff = [...allStaff]; // Initialize filtered staff
                rolesData = Array.isArray(data.roles) ? data.roles : [];
                departmentsData = Array.isArray(data.departments) ? data.departments : [];

                console.log("âœ… Staff data loaded:", allStaff.length, "staff members");
                console.log("âœ… Roles data received:", rolesData.length, "roles");
                console.log("âœ… Departments data received:", departmentsData.length, "departments");

                // Hide loading state before updating UI
                showLoading(false);

                // Update UI components safely
                try {
                    populateDropdowns();
                    updateStats();
                    renderStaffTable();
                } catch (uiError) {
                    console.error("âŒ Error updating UI components:", uiError);
                    showNotification("Data loaded but UI update failed", "warning");
                }

                // Decide what to show based on data
                if (allStaff.length > 0) {
                    console.log("âœ… Showing staff table with", allStaff.length, "members");
                    showTable(true);
                    showNotification(`${allStaff.length} staff members loaded successfully`, "success", 3000);
                } else {
                    console.log("âš ï¸ No staff members found, showing empty state");
                    showEmptyState();
                    showNotification("No staff members found", "info", 3000);
                }

            } else {
                throw new Error(data.error || "Failed to load staff data");
            }
        } catch (error) {
            console.error("Error loading staff data:", error);

            // Hide loading state before showing error
            showLoading(false);

            // Provide user-friendly error messages
            let errorMessage = "Error loading staff data";
            if (error.message.includes("fetch")) {
                errorMessage = "Network error - please check your connection";
            } else if (error.message.includes("JSON")) {
                errorMessage = "Server response error - please try refreshing";
            } else {
                errorMessage = `Error: ${error.message}`;
            }

            showNotification(errorMessage, "error");
            showEmptyState();

            // Initialize with empty data to prevent null reference errors
            allStaff = [];
            filteredStaff = [];
            rolesData = [];
            departmentsData = [];
        }
    }

    // Populate dropdown menus
    function populateDropdowns() {
        console.log("Populating dropdowns with departments:", departmentsData.length);

        // Populate department dropdowns
        const deptSelects = ["departmentFilter", "departmentId"];
        deptSelects.forEach((selectId) => {
            const select = document.getElementById(selectId);
            if (select) {
                // Clear existing options (except first)
                const firstOption = select.firstElementChild;
                select.innerHTML = "";
                if (firstOption) {
                    select.appendChild(firstOption);
                }

                console.log(`Populating ${selectId} with ${departmentsData.length} departments`);
                departmentsData.forEach((dept) => {
                    const option = document.createElement("option");
                    option.value = dept.id;
                    option.textContent = dept.display_name || dept.name;
                    select.appendChild(option);
                    console.log(`Added department option: ${dept.display_name || dept.name} (ID: ${dept.id})`);
                });
            }
        });
    }

    // Update statistics cards
    function updateStats() {
        const totalStaff = allStaff.length;
        const activeStaff = allStaff.filter((s) => s.is_active).length;

        document.getElementById("totalStaffCount").textContent = totalStaff;
        document.getElementById("activeStaffCount").textContent = activeStaff;
        document.getElementById("departmentCount").textContent =
            departmentsData.length;
        document.getElementById("roleCount").textContent = totalStaff;
    }

    // Render staff table
    function renderStaffTable() {
        console.log("ðŸŽ¨ Rendering staff table with", allStaff.length, "staff members");
        // Initialize filteredStaff with all staff data, sorted by ID descending (latest first)
        filteredStaff = [...allStaff].sort((a, b) => b.id - a.id);
        console.log("ðŸ“‹ Initializing table display with", filteredStaff.length, "staff members (sorted latest first)");

        // Force table visibility immediately
        const tableContainer = document.getElementById("staffTableContainer");
        const loadingState = document.getElementById("loadingState");
        const emptyState = document.getElementById("emptyState");

        if (loadingState) loadingState.style.display = "none";
        if (emptyState) emptyState.style.display = "none";
        if (tableContainer) tableContainer.style.display = "block";

        // Immediately render the filtered staff (which is all staff initially)
        renderFilteredStaff();
    }

    // Create staff table row
    function createStaffRow(staff) {
        const row = document.createElement("tr");
        row.setAttribute("data-staff-id", staff.id);

        // Generate initials
        const initials =
            (staff.first_name?.[0] || "S") + (staff.last_name?.[0] || "M");

        row.innerHTML = `
        <td>
            <div class="d-flex align-items-center">
                <div class="avatar-circle me-3" style="width: 40px; height: 40px; background: #007bff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                    ${initials}
                </div>
                <div>
                    <strong>${staff.full_name}</strong>
                    <br><small class="text-muted">${staff.staff_code || ""}</small>
                    <br><small class="text-muted">${staff.username}</small>
                </div>
            </div>
        </td>
        <td>
            <div><strong>${staff.department_display}</strong></div>
        </td>
        <td>
            <div>${staff.email || "No email"}</div>
            <div><small class="text-muted">${staff.phone || "No phone"}</small></div>
            ${staff.gender ? `<div><small class="text-muted">${staff.gender.charAt(0).toUpperCase() + staff.gender.slice(1)}</small></div>` : ""}
        </td>
        <td>
            <div class="btn-group-vertical btn-group-sm">
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="editStaff(${staff.id})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button type="button" class="btn btn-outline-info btn-sm" onclick="viewStaff(${staff.id})" title="View">
                    <i class="fas fa-eye"></i>
                </button>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="showDeleteModal(${staff.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    `;

        return row;
    }

    // Filter staff based on search and filters
    function filterStaff() {
        console.log("Filtering staff. Total staff:", allStaff.length);
        let filtered = [...allStaff];

        // Search filter
        const searchTerm = document
            .getElementById("searchInput")
            .value.toLowerCase();
        if (searchTerm) {
            filtered = filtered.filter(
                (staff) =>
                    staff.full_name.toLowerCase().includes(searchTerm) ||
                    staff.email.toLowerCase().includes(searchTerm) ||
                    (staff.staff_code &&
                        staff.staff_code.toLowerCase().includes(searchTerm)) ||
                    staff.username.toLowerCase().includes(searchTerm) ||
                    (staff.phone && staff.phone.includes(searchTerm)),
            );
            console.log("After search filter:", filtered.length);
        }

        // Department filter
        const deptFilter = document.getElementById("departmentFilter").value;
        if (deptFilter) {
            filtered = filtered.filter(
                (staff) => staff.department_id == deptFilter,
            );
            console.log("After department filter:", filtered.length);
        }

        // Status filter
        const statusFilter = document.getElementById("statusFilter").value;
        if (statusFilter === "active") {
            filtered = filtered.filter((staff) => staff.is_active);
            console.log("After status filter (active):", filtered.length);
        } else if (statusFilter === "inactive") {
            filtered = filtered.filter((staff) => !staff.is_active);
            console.log("After status filter (inactive):", filtered.length);
        }

        // Sort by ID descending (latest added first)
        filtered.sort((a, b) => b.id - a.id);

        // Update the global filteredStaff array
        filteredStaff = filtered;
        console.log("Final filtered staff count:", filteredStaff.length, "(sorted latest first)");
        renderFilteredStaff(); // Render the filtered list
    }

    // Render filtered staff with comprehensive null checks
    function renderFilteredStaff() {
        console.log("Starting renderFilteredStaff with", filteredStaff?.length || 0, "staff members");

        const tbody = document.getElementById("staffTableBody");
        const loadingState = document.getElementById("loadingState");
        const tableContainer = document.getElementById("staffTableContainer");
        const emptyState = document.getElementById("emptyState");

        // Comprehensive element checks
        if (!tbody) {
            console.error("Critical error: Staff table body element not found");
            showEmptyState();
            return;
        }

        // Hide loading state first
        if (loadingState) {
            loadingState.style.display = "none";
        }

        // Clear existing content safely
        try {
            tbody.innerHTML = "";
        } catch (error) {
            console.error("Error clearing table body:", error);
            showEmptyState();
            return;
        }

        // Check if we have staff data to render
        if (!filteredStaff || !Array.isArray(filteredStaff) || filteredStaff.length === 0) {
            console.log("No filtered staff to display - showing empty state");
            showEmptyState();
            return;
        }

        console.log("Rendering", filteredStaff.length, "staff members");

        try {
            let successfulRenders = 0;

            filteredStaff.forEach((staff, index) => {
                try {
                    const row = createStaffRow(staff);
                    if (row) {
                        tbody.appendChild(row);
                        successfulRenders++;
                    } else {
                        console.warn(`Failed to create row for staff ${staff.id}`);
                    }
                } catch (rowError) {
                    console.error(`Error creating row for staff ${staff.id}:`, rowError);
                }
            });

            if (successfulRenders > 0) {
                console.log(`âœ… Successfully rendered ${successfulRenders} staff members, showing table`);
                showTable(true);
            } else {
                console.error("No staff rows could be rendered");
                showEmptyState();
            }

        } catch (error) {
            console.error("Error in renderFilteredStaff:", error);
            showEmptyState();
        }
    }

    // Clear all filters
    function clearFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("departmentFilter").value = "";
        document.getElementById("statusFilter").value = "";
        filterStaff(); // Re-apply filters (which will now be empty)
    }

    // Show/hide loading state
    function showLoading(show) {
        document.getElementById("loadingState").style.display = show
            ? "block"
            : "none";
        document.getElementById("staffTableContainer").style.display = "none"; // Hide table while loading
        document.getElementById("emptyState").style.display = "none"; // Hide empty state while loading
    }

    // Show/hide table with comprehensive checks and fallback messages
    function showTable(show) {
        const loadingState = document.getElementById("loadingState");
        const tableContainer = document.getElementById("staffTableContainer");
        const emptyState = document.getElementById("emptyState");

        // Always hide loading state
        if (loadingState) {
            loadingState.style.display = "none";
        }

        if (show) {
            // Show table, hide empty state
            if (tableContainer) {
                tableContainer.style.display = "block";
            } else {
                console.error("Table container not found - cannot show table");
                return;
            }

            if (emptyState) {
                emptyState.style.display = "none";
            }

            console.log("Staff table displayed successfully");
        } else {
            // Hide table, potentially show empty state
            if (tableContainer) {
                tableContainer.style.display = "none";
            }
            console.log("Staff table hidden");
        }

        // Ensure main navigation buttons are always visible
        ensureNavigationVisible();
    }

    // Show empty state with fallback message
    function showEmptyState() {
        const loadingState = document.getElementById("loadingState");
        const tableContainer = document.getElementById("staffTableContainer");
        const emptyState = document.getElementById("emptyState");

        // Hide other states
        if (loadingState) {
            loadingState.style.display = "none";
        }

        if (tableContainer) {
            tableContainer.style.display = "none";
        }

        // Show empty state
        if (emptyState) {
            emptyState.style.display = "block";
            console.log("Empty state displayed");

            // Update empty state content to ensure it's helpful
            const emptyStateContent = emptyState.querySelector('h5');
            if (emptyStateContent && !emptyStateContent.textContent.includes('No staff')) {
                emptyStateContent.textContent = 'No staff members found';
            }

            const emptyStateDescription = emptyState.querySelector('p');
            if (emptyStateDescription && !emptyStateDescription.textContent.includes('available')) {
                emptyStateDescription.textContent = 'No staff available. Please add new staff to get started.';
            }
        } else {
            console.error("Empty state element not found - creating fallback");
            createFallbackEmptyMessage();
        }

        // Ensure main navigation buttons are always visible
        ensureNavigationVisible();
    }

    // Ensure navigation and add buttons are always visible
    function ensureNavigationVisible() {
        // Main header Add button
        const headerAddBtn = document.querySelector('[data-bs-target="#staffModal"]');
        if (headerAddBtn) {
            headerAddBtn.style.display = "inline-block";
            headerAddBtn.style.visibility = "visible";
        }

        // Empty state Add button
        const emptyAddBtn = document.querySelector('#emptyState [data-bs-target="#staffModal"]');
        if (emptyAddBtn) {
            emptyAddBtn.style.display = "inline-block";
            emptyAddBtn.style.visibility = "visible";
        }

        // Header navigation
        const headerNav = document.querySelector('.d-flex.justify-content-between.align-items-center');
        if (headerNav) {
            headerNav.style.display = "flex";
            headerNav.style.visibility = "visible";
        }
    }

    // Create fallback empty message if empty state element is missing
    function createFallbackEmptyMessage() {
        const cardBody = document.querySelector('.card-body');
        if (cardBody) {
            const fallbackDiv = document.createElement('div');
            fallbackDiv.id = 'fallbackEmptyState';
            fallbackDiv.className = 'text-center py-5';
            fallbackDiv.innerHTML = `
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No staff members found</h5>
                <p class="text-muted">No staff available. Please add new staff to get started.</p>
                <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#staffModal" onclick="showAddModal()">
                    <i class="fas fa-plus me-2"></i>Add Your First Staff Member
                </button>
            `;

            cardBody.appendChild(fallbackDiv);
            console.log("Fallback empty state created");
        }
    }

    // Toggle password visibility
    function togglePasswordVisibilityInForm() {
        const passwordField = document.getElementById("password");
        const passwordIcon = document.getElementById("passwordIcon");

        if (passwordField && passwordIcon) {
            if (passwordField.type === "password") {
                passwordField.type = "text";
                passwordIcon.classList.remove("fa-eye");
                passwordIcon.classList.add("fa-eye-slash");
            } else {
                passwordField.type = "password";
                passwordIcon.classList.remove("fa-eye-slash");
                passwordIcon.classList.add("fa-eye");
            }
        }
    }

    // Show add modal
    function showAddModal() {
        isEditing = false; // Ensure we are in add mode

        // Safe element updates with null checks
        const formMode = document.getElementById("formMode");
        const modalTitleText = document.getElementById("modalTitleText");
        const saveBtn = document.getElementById("btnStaffSave");
        const saveButtonText = document.getElementById("saveButtonText");
        const passwordHelp = document.getElementById("passwordHelp");
        const passwordField = document.getElementById("password");
        const editModeIndicator = document.getElementById("editModeIndicator");

        if (formMode) formMode.value = "add";
        if (modalTitleText) modalTitleText.textContent = "Add New Staff Member";
        if (saveBtn) saveBtn.className = "btn btn-primary btn-lg px-4";
        if (saveButtonText) saveButtonText.textContent = "Save Staff Member";
        if (passwordHelp) passwordHelp.innerHTML = '<i class="fas fa-info-circle me-1"></i>Leave blank for auto-generated password';
        if (passwordField) passwordField.required = false;
        if (editModeIndicator) editModeIndicator.style.display = "none";

        clearForm(); // Clear any previous data
        if (staffModal) staffModal.show(); // Show the modal
    }

    // Edit staff with comprehensive error handling and null checks
    async function editStaff(staffId) {
        try {
            console.log("Editing staff with ID:", staffId);

            // Validate staff ID
            if (!staffId || staffId <= 0) {
                throw new Error("Invalid staff ID provided");
            }

            isEditing = true; // Set editing mode
            currentStaffId = staffId; // Store the ID of the staff being edited

            // Safely update form elements with null checks
            const formMode = document.getElementById("formMode");
            const modalTitleText = document.getElementById("modalTitleText");
            const saveBtn = document.getElementById("btnStaffSave");
            const saveButtonText = document.getElementById("saveButtonText");
            const passwordHelp = document.getElementById("passwordHelp");
            const passwordField = document.getElementById("password");
            const editModeIndicator = document.getElementById("editModeIndicator");

            if (formMode) formMode.value = "edit";
            if (modalTitleText) modalTitleText.textContent = "Edit Staff Member";
            if (saveBtn) saveBtn.className = "btn btn-success btn-lg px-4";
            if (saveButtonText) saveButtonText.textContent = "Update Staff Member";
            if (passwordHelp) passwordHelp.innerHTML = '<i class="fas fa-info-circle me-1"></i>Leave blank to keep current password';
            if (passwordField) passwordField.required = false;
            if (editModeIndicator) editModeIndicator.style.display = "inline-block";

            // Load staff data from API first
            console.log(`Fetching staff data from /api/staff/${staffId}`);
            const response = await fetch(`/api/staff/${staffId}`);

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.success && data.staff) {
                populateForm(data.staff); // Populate form with fetched data

                // Show modal safely
                if (staffModal) {
                    staffModal.show();
                } else {
                    console.error("Staff modal not initialized");
                    throw new Error("Modal not available");
                }
            } else {
                // Fallback: If API fails, try to get from local data (allStaff)
                console.log("API failed, trying local data fallback");
                const staff = allStaff.find((s) => s.id == staffId);
                if (staff) {
                    populateForm(staff);
                    if (staffModal) {
                        staffModal.show();
                    } else {
                        throw new Error("Modal not available");
                    }
                } else {
                    throw new Error(data.error || "Staff member not found via API or local data");
                }
            }
        } catch (error) {
            console.error("Error editing staff:", error);

            // Provide user-friendly error message
            let errorMessage = "Error loading staff data for editing";
            if (error.message.includes("Invalid staff ID")) {
                errorMessage = "Invalid staff member selected";
            } else if (error.message.includes("HTTP")) {
                errorMessage = "Server error loading staff data";
            } else if (error.message.includes("Modal")) {
                errorMessage = "Interface error - please refresh the page";
            } else {
                errorMessage = `Error: ${error.message}`;
            }

            showNotification(errorMessage, "error");
        }
    }

    // Populate form with staff data
    function populateForm(staff) {
        console.log("Populating form with staff data:", staff);

        const fields = {
            "staffId": staff.id || "",
            "username": staff.username || "",
            "firstName": staff.first_name || "",
            "lastName": staff.last_name || "",
            "email": staff.email || "",
            "phone": staff.phone || "",
            "gender": staff.gender || "",
            "dateOfBirth": staff.date_of_birth || "",
            "dateOfJoining": staff.date_of_joining || "",
            "shiftStart": staff.shift_start_time || "",
            "shiftEnd": staff.shift_end_time || "",
            "workingDays": staff.working_days || "",
            "notesBio": staff.notes_bio || ""
        };

        // Optional fields that may not exist in the form
        const optionalFields = ["shiftStart", "shiftEnd", "workingDays"];

        // Safely populate text fields
        Object.entries(fields).forEach(([fieldId, value]) => {
            const element = document.getElementById(fieldId);
            if (element) {
                element.value = value;
            } else if (!optionalFields.includes(fieldId)) {
                // Only warn about missing required fields
                console.warn(`Field ${fieldId} not found in form`);
            }
        });

        // Set password field (show default password if available)
    const passwordField = document.getElementById("password");
    if (passwordField) {
        if (staff.default_password && staff.default_password.trim() !== '') {
            passwordField.value = staff.default_password;
            passwordField.placeholder = "Current password shown - change if needed";
            console.log("Password populated:", staff.default_password);
        } else {
            passwordField.value = '';
            passwordField.placeholder = "Leave blank to keep current password";
            console.log("No password available to populate");
        }
    }


        // Handle department dropdown - set the value explicitly
        const deptSelect = document.getElementById("departmentId");
        if (deptSelect && staff.department_id) {
            deptSelect.value = staff.department_id;
            console.log("Set department dropdown to:", staff.department_id);
        } else {
            console.log("Department select element or staff.department_id not found");
        }

        // Handle checkbox separately
        const faceCheckinField = document.getElementById("enableFaceCheckin");
        if (faceCheckinField) {
            faceCheckinField.checked = staff.enable_face_checkin || false;
        }
    }

    // Clear form fields and reset state
    function clearForm() {
        const staffForm = document.getElementById("staffFormComprehensive");
        const staffId = document.getElementById("staffId");
        const formMode = document.getElementById("formMode");
        const modalTitleText = document.getElementById("modalTitleText");
        const saveBtn = document.getElementById("btnStaffSave");
        const saveButtonText = document.getElementById("saveButtonText");
        const passwordHelp = document.getElementById("passwordHelp");
        const passwordField = document.getElementById("password");
        const editModeIndicator = document.getElementById("editModeIndicator");

        if (staffForm) {
            try {
                staffForm.reset();
            } catch (error) {
                console.warn("Error resetting form:", error);
            }
        }

        if (staffId) staffId.value = "";
        if (formMode) formMode.value = "add";
        if (modalTitleText) modalTitleText.textContent = "Add New Staff Member";
        if (saveBtn) saveBtn.className = "btn btn-primary btn-lg px-4";
        if (saveButtonText) saveButtonText.textContent = "Save Staff Member";
        if (passwordHelp) passwordHelp.innerHTML = '<i class="fas fa-info-circle me-1"></i>Leave blank for auto-generated password';
        if (passwordField) passwordField.required = false;
        if (editModeIndicator) editModeIndicator.style.display = "none";

        // Clear any previous validation states
        if (staffForm) {
            const inputs = staffForm.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
        }
    }

    // Save staff (add or update)
    async function saveStaff() {
        try {
            const formData = {
                username: getFieldValue("username"),
                first_name: getFieldValue("firstName"),
                last_name: getFieldValue("lastName"),
                email: getFieldValue("email"),
                phone: getFieldValue("phone"),
                role_id: parseInt(getFieldValue("roleId")) || null,
                department_id: parseInt(getFieldValue("departmentId")) || null,
                designation: getFieldValue("designation"),
                commission_rate:
                    parseFloat(getFieldValue("commissionRate")) || 0,
                hourly_rate: parseFloat(getFieldValue("hourlyRate")) || 0,
                gender: getFieldValue("gender"),
                date_of_birth: getFieldValue("dateOfBirth"),
                date_of_joining: getFieldValue("dateOfJoining"),
                shift_start_time: getFieldValue("shiftStart", true),
                shift_end_time: getFieldValue("shiftEnd", true),
                working_days: getFieldValue("workingDays", true),
                enable_face_checkin: getCheckboxValue("enableFaceCheckin"),
                notes_bio: getFieldValue("notesBio"),
            };

            // Add password only if it's provided (for edit mode) or required (for add mode)
            const passwordField = document.getElementById("password");
            if (passwordField && passwordField.value) {
                formData.password = passwordField.value;
            } else if (
                document.getElementById("formMode").value === "add" &&
                !formData.password
            ) {
                // If in add mode and password is not provided, this will be caught by validation
                // Or we can explicitly check here if needed.
            }

            let url, method;
            if (isEditing) {
                // Use the isEditing flag
                const staffId = document.getElementById("staffId").value;
                url = `/api/staff/${staffId}`;
                method = "PUT";
            } else {
                url = "/api/staff";
                method = "POST";
            }

            const response = await fetch(url, {
                method: method,
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
            });

            const data = await response.json();

            if (data.success) {
                showAlert(data.message, "success");

                // Hide modal
                staffModal.hide(); // Use the globally initialized modal instance

                loadStaffData(); // Refresh data
            } else {
                throw new Error(data.error || "An unknown error occurred");
            }
        } catch (error) {
            console.error("Error saving staff:", error);
            showAlert("Error saving staff: " + error.message, "danger");
        }
    }

    // Show delete modal with confirmation message
    function showDeleteModal(staffId) {
        const staff = allStaff.find((s) => s.id === staffId);
        if (!staff) {
            showNotification("âœ— Staff member not found. Please refresh the page and try again.", "error");
            return;
        }

        currentDeleteId = staffId; // Store the ID for confirmation
        const deleteMsg = document.getElementById("deleteMessage");
        if (deleteMsg) {
            deleteMsg.innerHTML = `
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Are you sure you want to delete this staff member?</strong>
                    <div class="mt-2">
                        <strong>Name:</strong> ${staff.full_name}<br>
                        <strong>Username:</strong> ${staff.username}
                    </div>
                    <div class="mt-3 text-danger">
                        <i class="fas fa-info-circle me-1"></i>
                        <small>This action cannot be undone. All related data will be permanently removed.</small>
                    </div>
                </div>
            `;
        }

        const modal = new bootstrap.Modal(
            document.getElementById("deleteModal"),
        );
        modal.show();
    }

    // Perform delete operation with comprehensive error handling
    async function performDelete(staffId) {
        if (!staffId) {
            console.error("No staff ID provided for deletion.");
            showNotification("No staff member selected for deletion", "error");
            return;
        }

        console.log("Deleting staff member:", staffId);

        try {
            const response = await fetch(`/api/staff/${staffId}`, {
                method: "DELETE",
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (data.success) {
                showNotification("âœ“ Staff member deleted successfully. The record has been permanently removed.", "success");

                // Hide modal safely
                const deleteModal = document.getElementById("deleteModal");
                if (deleteModal) {
                    const modal = bootstrap.Modal.getInstance(deleteModal);
                    if (modal) {
                        modal.hide();
                    } else {
                        console.warn("Modal instance not found, hiding directly");
                        deleteModal.style.display = "none";
                        // Clean up backdrop
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                        document.body.classList.remove('modal-open');
                    }
                } else {
                    console.error("Delete modal not found");
                }

                currentDeleteId = null; // Clear the stored ID

                // Refresh data with error handling
                try {
                    await loadStaffData();
                } catch (loadError) {
                    console.error("Error reloading data after delete:", loadError);
                    showNotification("âš  Staff member deleted, but the list couldn't refresh. Please reload the page to see updates.", "warning");
                }
            } else {
                throw new Error(data.error || "Unable to delete staff member. Please try again.");
            }
        } catch (error) {
            console.error("Error deleting staff:", error);

            let errorMessage = "âœ— Unable to delete staff member";
            if (error.message.includes("HTTP 404")) {
                errorMessage = "âœ— Staff member not found. They may have already been deleted.";
            } else if (error.message.includes("HTTP 403")) {
                errorMessage = "âœ— Access denied. You don't have permission to delete this staff member.";
            } else if (error.message.includes("HTTP 500")) {
                errorMessage = "âœ— Server error. The staff member might have active appointments or other data. Please contact support.";
            } else if (error.message.includes("network") || error.message.includes("fetch")) {
                errorMessage = "âœ— Network error. Please check your connection and try again.";
            } else {
                errorMessage = `âœ— Delete failed: ${error.message}`;
            }

            showNotification(errorMessage, "error");
        }
    }

    // View staff details
    function viewStaff(staffId) {
        const staff = allStaff.find((s) => s.id === staffId);
        if (!staff) {
            showNotification("Staff member not found.", "error");
            return;
        }

        document.getElementById("performanceModalLabel").textContent =
            `${staff.full_name} - Staff Details`;
        document.getElementById("performanceContent").innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card border-primary mb-3">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">Basic Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2"><strong>Staff Code:</strong> ${staff.staff_code || "N/A"}</div>
                        <div class="mb-2"><strong>Username:</strong> ${staff.username}</div>
                        <div class="mb-2">
                            <strong>Password:</strong> 
                            <span class="d-inline-flex align-items-center gap-2">
                                <span id="passwordDisplay" class="font-monospace">${staff.default_password ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : 'N/A'}</span>
                                ${staff.default_password ? `
                                <button class="btn btn-sm btn-outline-secondary" 
                                        onclick="toggleViewPasswordVisibility()" 
                                        id="togglePasswordBtn"
                                        type="button"
                                        title="Show/Hide Password">
                                    <i class="fas fa-eye" id="passwordIconView"></i>
                                </button>
                                <input type="hidden" id="actualPassword" value="${staff.default_password}">
                                ` : ''}
                            </span>
                        </div>
                        <div class="mb-2"><strong>Email:</strong> ${staff.email || "N/A"}</div>
                        <div class="mb-2"><strong>Phone:</strong> ${staff.phone || "N/A"}</div>
                        <div class="mb-2"><strong>Gender:</strong> ${staff.gender ? staff.gender.charAt(0).toUpperCase() + staff.gender.slice(1) : "N/A"}</div>
                        <div class="mb-2"><strong>Status:</strong> <span class="badge bg-${staff.is_active ? "success" : "danger"}">${staff.is_active ? "Active" : "Inactive"}</span></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-info mb-3">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">Department & Work Info</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2"><strong>Department:</strong> ${staff.department_display}</div>
                        <div class="mb-2"><strong>Designation:</strong> ${staff.designation || "Staff Member"}</div>
                        <div class="mb-2"><strong>Date of Joining:</strong> ${staff.date_of_joining ? new Date(staff.date_of_joining).toLocaleDateString() : "N/A"}</div>
                    </div>
                </div>
            </div>
        </div>
        ${staff.notes_bio ? `
        <div class="row mt-3">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">Notes/Bio</h6>
                    </div>
                    <div class="card-body">
                        <p>${staff.notes_bio}</p>
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
    `;

        const modal = new bootstrap.Modal(
            document.getElementById("performanceModal"),
        );
        modal.show();
    }

    // Toggle password visibility in staff details modal
    function toggleViewPasswordVisibility() {
        const passwordDisplay = document.getElementById('passwordDisplay');
        const passwordIcon = document.getElementById('passwordIconView'); // Corrected ID for the view icon
        const actualPassword = document.getElementById('actualPassword');

        if (!passwordDisplay || !passwordIcon || !actualPassword) {
            console.error('Password elements not found for view modal');
            return;
        }

        const isCurrentlyHidden = passwordDisplay.textContent === 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';

        if (isCurrentlyHidden) {
            passwordDisplay.textContent = actualPassword.value;
            passwordIcon.classList.remove('fa-eye'); // Use font-awesome classes
            passwordIcon.classList.add('fa-eye-slash');
        } else {
            passwordDisplay.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            passwordIcon.classList.remove('fa-eye-slash');
            passwordIcon.classList.add('fa-eye');
        }
    }

    // Refresh staff data and show notification
    async function refreshStaffData() {
        showAlert("Refreshing staff data...", "info");
        await loadStaffData();
    }

    // Export staff data to Excel
    function exportStaffData() {
        console.log("Export button clicked");

        // Check if XLSX library is loaded
        if (typeof XLSX === 'undefined') {
            console.error("SheetJS library not loaded");
            showNotification("âœ— Excel export library not loaded. Please refresh the page and try again.", "error");
            return;
        }

        // Use allStaff if filteredStaff is empty
        const dataSource = (filteredStaff && filteredStaff.length > 0) ? filteredStaff : allStaff;

        if (!dataSource || dataSource.length === 0) {
            showNotification("No staff data available to export.", "warning");
            return;
        }

        showNotification("Preparing Excel export...", "info", 2000);

        try {
            // Prepare data for Excel with comprehensive fields
            const dataToExport = dataSource.map((staff, index) => ({
                "Sr No": index + 1,
                "Staff Code": staff.staff_code || "N/A",
                "Username": staff.username || "",
                "Full Name": staff.full_name || `${staff.first_name || ''} ${staff.last_name || ''}`.trim(),
                "Email": staff.email || "N/A",
                "Phone": staff.phone || "N/A",
                "Role": staff.role_display || staff.role || "N/A",
                "Department": staff.department_display || "N/A",
                "Designation": staff.designation || "N/A",
                "Gender": staff.gender ? staff.gender.charAt(0).toUpperCase() + staff.gender.slice(1) : "N/A",
                "Date of Birth": staff.date_of_birth ? new Date(staff.date_of_birth).toLocaleDateString('en-IN') : "N/A",
                "Date of Joining": staff.date_of_joining ? new Date(staff.date_of_joining).toLocaleDateString('en-IN') : "N/A",
                "Shift Start": staff.shift_start_time || "N/A",
                "Shift End": staff.shift_end_time || "N/A",
                "Working Days": staff.working_days || "N/A",
                "Status": staff.is_active ? "Active" : "Inactive",
                "Verified": staff.verification_status ? "Yes" : "No",
                "Face Check-in": staff.enable_face_checkin ? "Enabled" : "Disabled",
                "Notes": staff.notes_bio || "N/A"
            }));

            console.log("Data prepared for export:", dataToExport.length, "records");

            // Create worksheet from JSON data
            const ws = XLSX.utils.json_to_sheet(dataToExport);

            // Auto-size columns
            const columnWidths = [
                { wch: 6 },  // Sr No
                { wch: 12 }, // Staff Code
                { wch: 15 }, // Username
                { wch: 25 }, // Full Name
                { wch: 30 }, // Email
                { wch: 15 }, // Phone
                { wch: 15 }, // Role
                { wch: 20 }, // Department
                { wch: 20 }, // Designation
                { wch: 10 }, // Gender
                { wch: 15 }, // DOB
                { wch: 15 }, // DOJ
                { wch: 12 }, // Shift Start
                { wch: 12 }, // Shift End
                { wch: 15 }, // Working Days
                { wch: 10 }, // Status
                { wch: 10 }, // Verified
                { wch: 15 }, // Face Check-in
                { wch: 40 }  // Notes
            ];
            ws['!cols'] = columnWidths;

            // Create a new workbook
            const wb = XLSX.utils.book_new();

            // Append worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, "Staff Data");

            // Generate filename with current date and time
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const filename = `Staff_Data_${year}${month}${day}_${hours}${minutes}.xlsx`;

            console.log("Writing Excel file:", filename);

            // Write file and trigger download
            XLSX.writeFile(wb, filename);

            showNotification(`âœ“ Staff data exported successfully!\n${dataToExport.length} records saved as ${filename}`, "success", 5000);
            console.log("Export completed successfully");

        } catch (error) {
            console.error("Error exporting to Excel:", error);
            console.error("Error details:", {
                message: error.message,
                stack: error.stack,
                dataSource: dataSource
            });
            showNotification(`âœ— Export failed: ${error.message}.\nPlease try refreshing the page.`, "error");
        }
    }

    // Show notification with comprehensive error handling
    function showNotification(message, type = "info", duration = 5000) {
        console.log(`Showing notification: ${message} (${type})`);

        let alertContainer = document.getElementById("alertContainer");

        // Create alert container if it doesn't exist
        if (!alertContainer) {
            console.log("Alert container not found, creating one");
            alertContainer = document.createElement("div");
            alertContainer.id = "alertContainer";
            alertContainer.className = "position-fixed top-0 end-0 p-3";
            alertContainer.style.zIndex = "1050";
            document.body.appendChild(alertContainer);
        }

        const alertId = "alert-" + Date.now(); // Unique ID for each alert

        // Map types for Bootstrap classes
        const typeMap = {
            'success': 'success',
            'error': 'danger',
            'danger': 'danger',
            'warning': 'warning',
            'info': 'info'
        };

        const bootstrapType = typeMap[type] || 'info';

        const alertHtml = `
        <div class="alert alert-${bootstrapType} alert-dismissible fade show" id="${alertId}" role="alert">
            <i class="fas fa-${getNotificationIcon(type)} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        `;

        try {
            alertContainer.insertAdjacentHTML("beforeend", alertHtml);
        } catch (error) {
            console.error("Error showing alert:", error);
            // Fallback: console log and basic alert
            console.log(`NOTIFICATION: ${message}`);
            return;
        }

        // Automatically remove the alert after specified duration
        setTimeout(() => {
            const alertElement = document.getElementById(alertId);
            if (alertElement) {
                try {
                    // Use bootstrap's alert dismissal for proper animation
                    const alert = new bootstrap.Alert(alertElement);
                    alert.close();
                } catch (error) {
                    console.warn("Error closing alert:", error);
                    // Fallback: remove element directly
                    if (alertElement.parentNode) {
                        alertElement.parentNode.removeChild(alertElement);
                    }
                }
            }
        }, duration);
    }

    // Get notification icon for different types
    function getNotificationIcon(type) {
        const icons = {
            'success': 'check-circle',
            'error': 'exclamation-circle',
            'danger': 'exclamation-circle',
            'warning': 'exclamation-triangle',
            'info': 'info-circle'
        };
        return icons[type] || 'info-circle';
    }

    // Legacy function for compatibility
    function showAlert(message, type = "info") {
        showNotification(message, type);
    }

    // Global error handler
    window.addEventListener('error', function(event) {
        console.error('Global JavaScript Error:', {
            message: event.message,
            filename: event.filename,
            lineno: event.lineno,
            colno: event.colno,
            error: event.error
        });

        // Show user-friendly message for critical errors
        if (event.message.includes('Cannot set properties of null') ||
            event.message.includes('Cannot read properties of null')) {
            showNotification('Interface update error. Please refresh the page if issues persist.', 'warning');
        }
    });

    // Helper function to update staff data via API
    async function updateStaff(staffId, staffData) {
        try {
            console.log("Updating staff with data:", staffData);

            // Validate staffId
            if (!staffId || staffId <= 0) {
                throw new Error('Invalid staff ID. Please refresh the page and try again.');
            }

            // Ensure required fields are present
            if (!staffData.first_name || !staffData.last_name) {
                throw new Error('First name and last name are required to update staff member.');
            }

            const response = await fetch(`/api/staff/${staffId}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Accept": "application/json"
                },
                body: JSON.stringify(staffData),
            });

            console.log("Update response status:", response.status);

            let result;
            try {
                result = await response.json();
            } catch (jsonError) {
                throw new Error(`Server returned invalid response. Please try again.`);
            }

            console.log("Update API Response:", result);

            if (!response.ok) {
                // Provide user-friendly error messages based on HTTP status
                let errorMsg = result.error || "Unable to update staff member";

                if (response.status === 404) {
                    errorMsg = "Staff member not found. They may have been deleted.";
                } else if (response.status === 409) {
                    errorMsg = "Username or email already exists. Please use a different one.";
                } else if (response.status === 400) {
                    errorMsg = result.error || "Invalid data provided. Please check all fields.";
                } else if (response.status === 403) {
                    errorMsg = "You don't have permission to update this staff member.";
                } else if (response.status === 500) {
                    errorMsg = "Server error. Please try again or contact support.";
                }

                throw new Error(errorMsg);
            }

            if (!result.success) {
                throw new Error(result.error || "Update failed. Please try again.");
            }

            return result;
        } catch (error) {
            console.error("Error updating staff:", error);
            return {
                success: false,
                error: error.message || "Failed to update staff member. Please try again.",
            };
        }
    }
</script>

<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script>
    // Verify SheetJS is loaded with retry mechanism
    function checkXLSXLibrary(retries = 3) {
        if (typeof XLSX !== 'undefined') {
            console.log('âœ“ SheetJS library loaded successfully');
            return true;
        } else if (retries > 0) {
            console.log('Waiting for SheetJS library... retries left:', retries);
            setTimeout(() => checkXLSXLibrary(retries - 1), 500);
        } else {
            console.error('âœ— SheetJS library failed to load after multiple attempts');
            showNotification("Excel export library not available. Please refresh the page.", "error");
        }
    }

    window.addEventListener('load', function() {
        setTimeout(() => checkXLSXLibrary(), 100);
    });
</script>
{% endblock %}