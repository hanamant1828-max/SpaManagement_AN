
{% extends "base.html" %}
{% block title %}Category Master Data Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-tags mr-2"></i>Category Master Data Management
        </h1>
        <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
            <i class="fas fa-plus fa-sm text-white-50"></i> Add New Category
        </button>
    </div>

    <!-- Categories Statistics -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Categories</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalCategories">{{ categories|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-tags fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Active Categories</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ categories|selectattr("is_active")|list|length }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Categories Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Category Master List</h6>
            <div class="dropdown no-arrow">
                <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                </a>
                <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in">
                    <div class="dropdown-header">Actions:</div>
                    <a class="dropdown-item" href="#" onclick="refreshCategories()">
                        <i class="fas fa-sync fa-sm fa-fw mr-2 text-gray-400"></i>
                        Refresh
                    </a>
                    <a class="dropdown-item" href="#" onclick="exportCategories()">
                        <i class="fas fa-download fa-sm fa-fw mr-2 text-gray-400"></i>
                        Export
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="spa-table-container">
                <div class="spa-table-responsive">
                    <table class="spa-table" id="categoriesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Category Name</th>
                                <th>Display Name</th>
                                <th>Description</th>
                                <th>Color/Icon</th>
                                <th>Sort Order</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for category in categories %}
                        <tr>
                            <td>{{ category.id }}</td>
                            <td>{{ category.name }}</td>
                            <td>
                                <span class="badge" style="background-color: {{ category.color or '#007bff' }}">
                                    <i class="{{ category.icon or 'fas fa-boxes' }}"></i> {{ category.display_name }}
                                </span>
                            </td>
                            <td>{{ category.description or '-' }}</td>
                            <td>
                                <span class="color-preview" style="background-color: {{ category.color or '#007bff' }}; width: 20px; height: 20px; display: inline-block; border-radius: 3px; margin-right: 5px;"></span>
                                <i class="{{ category.icon or 'fas fa-boxes' }}"></i>
                            </td>
                            <td>{{ category.sort_order or 0 }}</td>
                            <td>
                                {% if category.is_active %}
                                    <span class="badge badge-success">Active</span>
                                {% else %}
                                    <span class="badge badge-secondary">Inactive</span>
                                {% endif %}
                            </td>
                            <td>{{ category.created_at.strftime('%Y-%m-%d') if category.created_at else '-' }}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-info" onclick="editCategory({{ category.id }})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-warning" onclick="toggleCategory({{ category.id }})" title="Toggle Status">
                                        <i class="fas fa-toggle-on"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteCategory({{ category.id }})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus mr-2"></i>Add New Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCategoryForm" onsubmit="submitAddCategory(event)">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="display_name" class="form-label">Display Name *</label>
                                <input type="text" class="form-control" name="display_name" id="display_name" required>
                                <small class="form-text text-muted">This is what users will see</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="category_name" class="form-label">Category Name</label>
                                <input type="text" class="form-control" name="category_name" id="category_name" readonly>
                                <small class="form-text text-muted">Auto-generated from display name</small>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="color" class="form-label">Color</label>
                                <input type="color" class="form-control" name="color" id="color" value="#007bff">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="icon" class="form-label">Icon (Font Awesome)</label>
                                <input type="text" class="form-control" name="icon" id="icon" value="fas fa-boxes">
                                <small class="form-text text-muted">e.g., fas fa-boxes, fas fa-flask</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="sort_order" class="form-label">Sort Order</label>
                                <input type="number" class="form-control" name="sort_order" id="sort_order" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="is_active" id="is_active" checked>
                        <label class="form-check-label" for="is_active">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>Add Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit mr-2"></i>Edit Category
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCategoryForm" onsubmit="submitEditCategory(event)">
                <input type="hidden" id="edit_category_id" name="category_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="edit_category_name" class="form-label">Category Name *</label>
                                <input type="text" class="form-control" name="category_name" id="edit_category_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="edit_display_name" class="form-label">Display Name *</label>
                                <input type="text" class="form-control" name="display_name" id="edit_display_name" required>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="edit_description" class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="edit_description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="edit_color" class="form-label">Color</label>
                                <input type="color" class="form-control" name="color" id="edit_color">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="edit_icon" class="form-label">Icon (Font Awesome)</label>
                                <input type="text" class="form-control" name="icon" id="edit_icon">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group mb-3">
                                <label for="edit_sort_order" class="form-label">Sort Order</label>
                                <input type="number" class="form-control" name="sort_order" id="edit_sort_order">
                            </div>
                        </div>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" name="is_active" id="edit_is_active">
                        <label class="form-check-label" for="edit_is_active">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-2"></i>Update Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Initialize DataTable
$(document).ready(function() {
    $('#categoriesTable').DataTable({
        "pageLength": 25,
        "order": [[ 5, "asc" ], [ 1, "asc" ]],
        "responsive": true,
        "language": {
            "search": "Search categories:",
            "lengthMenu": "Show _MENU_ categories per page",
            "info": "Showing _START_ to _END_ of _TOTAL_ categories"
        }
    });
});

// Auto-generate category name from display name
document.getElementById('display_name').addEventListener('input', function() {
    const displayName = this.value;
    const categoryName = displayName.toLowerCase()
        .replace(/[^a-z0-9\s]/g, '')
        .replace(/\s+/g, '_')
        .trim();
    document.getElementById('category_name').value = categoryName;
});

// Initialize category name when modal opens
document.getElementById('addCategoryModal').addEventListener('shown.bs.modal', function() {
    // Clear the form
    document.getElementById('addCategoryForm').reset();
    document.getElementById('category_name').value = '';
    document.getElementById('display_name').focus();
});

// Add Category Function
function submitAddCategory(event) {
    event.preventDefault();
    
    // Validate required fields
    const displayName = document.getElementById('display_name').value.trim();
    if (!displayName) {
        showAlert('Display name is required', 'danger');
        return;
    }

    // Ensure category_name is generated if empty
    const categoryNameField = document.getElementById('category_name');
    if (!categoryNameField.value.trim()) {
        const categoryName = displayName.toLowerCase()
            .replace(/[^a-z0-9\s]/g, '')
            .replace(/\s+/g, '_')
            .trim();
        categoryNameField.value = categoryName;
    }
    
    const formData = new FormData(event.target);
    
    console.log('Submitting category with data:', {
        display_name: formData.get('display_name'),
        category_name: formData.get('category_name'),
        description: formData.get('description'),
        color: formData.get('color'),
        icon: formData.get('icon'),
        sort_order: formData.get('sort_order'),
        is_active: formData.get('is_active')
    });
    
    fetch('/inventory/category/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Category added successfully!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
            modal.hide();
            document.getElementById('addCategoryForm').reset();
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error || 'Error adding category', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error adding category', 'danger');
    });
}

// Edit Category Function
function editCategory(categoryId) {
    fetch(`/api/inventory/category/${categoryId}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showAlert(data.error, 'danger');
            return;
        }
        
        document.getElementById('edit_category_id').value = categoryId;
        document.getElementById('edit_category_name').value = data.name;
        document.getElementById('edit_display_name').value = data.display_name;
        document.getElementById('edit_description').value = data.description || '';
        document.getElementById('edit_color').value = data.color || '#007bff';
        document.getElementById('edit_icon').value = data.icon || 'fas fa-boxes';
        document.getElementById('edit_sort_order').value = data.sort_order || 0;
        document.getElementById('edit_is_active').checked = data.is_active;
        
        const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error loading category:', error);
        showAlert('Error loading category data', 'danger');
    });
}

// Submit Edit Category
function submitEditCategory(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const categoryId = formData.get('category_id');
    
    fetch(`/api/inventory/category/edit/${categoryId}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Category updated successfully!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert(data.error || 'Error updating category', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error updating category', 'danger');
    });
}

// Toggle Category Status
function toggleCategory(categoryId) {
    if (confirm('Are you sure you want to toggle this category status?')) {
        fetch(`/inventory-categories/${categoryId}/toggle`, {
            method: 'POST'
        })
        .then(() => {
            showAlert('Category status updated successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error updating category status', 'danger');
        });
    }
}

// Delete Category
function deleteCategory(categoryId) {
    if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
        fetch(`/inventory-categories/${categoryId}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Category deleted successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(data.error || 'Error deleting category', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error deleting category', 'danger');
        });
    }
}

// Utility Functions
function refreshCategories() {
    location.reload();
}

function exportCategories() {
    showAlert('Export functionality coming soon!', 'info');
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>

{% endblock %}
