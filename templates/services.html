{% extends "base.html" %}

{% block title %}Service Management - Spa Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-spa me-2"></i>Service Management</h2>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="serviceManagementTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="services-tab" data-bs-toggle="tab" data-bs-target="#services-pane" type="button" role="tab">
                <i class="fas fa-spa me-2"></i>Services
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories-pane" type="button" role="tab">
                <i class="fas fa-tags me-2"></i>Categories
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="serviceManagementTabContent">

        <!-- Services Tab -->
        <div class="tab-pane fade show active" id="services-pane" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center">
                    <select class="form-select me-3" id="categoryFilter" onchange="filterServices()" style="width: 200px;">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.name }}" {{ 'selected' if category_filter == category.name else '' }}>
                            {{ category.display_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#exportModal" title="Export services to CSV file">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addServiceModal" title="Create a new service offering">
                        <i class="fas fa-plus me-2"></i>Add New Service
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    {% if services %}
                    <div class="spa-table-container">
                        <div class="spa-table-responsive">
                            <table class="spa-table">
                                <thead>
                                    <tr>
                                        <th>Service Name</th>
                                        <th>Category</th>
                                        <th>Duration</th>
                                        <th>Price</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for service in services %}
                                    <tr>
                                    <td>
                                        <strong>{{ service.name }}</strong>
                                        {% if service.service_category %}
                                        <br><span class="badge" style="background-color: {{ service.service_category.color }}; font-size: 0.7rem;">
                                            {{ service.service_category.display_name }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if service.service_category %}
                                        <span class="badge" style="background-color: {{ service.service_category.color }}">
                                            {{ service.service_category.display_name }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">No Category</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ service.duration }} min</td>
                                    <td>${{ "%.2f"|format(service.price) }}</td>
                                    <td>{{ (service.description[:50] + '...') if service.description and service.description|length > 50 else (service.description or '-') }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if service.is_active else 'secondary' }}">
                                            {{ 'Active' if service.is_active else 'Inactive' }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editService({{ service.id }})" data-bs-toggle="tooltip" title="Edit service details" type="button">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning me-1" onclick="toggleService({{ service.id }})" data-bs-toggle="tooltip" title="{{ 'Deactivate service' if service.is_active else 'Activate service' }}" type="button">
                                            <i class="fas fa-{{ 'eye-slash' if service.is_active else 'eye' }}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteService({{ service.id }})" data-bs-toggle="tooltip" title="Delete service permanently" type="button">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% else %}
                    <div class="spa-table-container">
                        <div class="spa-table-empty">
                            <i class="fas fa-spa"></i>
                            <h5>No services found</h5>
                            <p class="text-muted">Create your first service to get started.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div class="tab-pane fade" id="categories-pane" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Service Categories</h5>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal" title="Create a new service category">
                    <i class="fas fa-plus me-2"></i>Add New Category
                </button>
            </div>

            <div class="card">
                <div class="card-body">
                    {% if categories %}
                    <div class="spa-table-responsive">
                        <table class="spa-table">
                            <thead>
                                <tr>
                                    <th>Category Name</th>
                                    <th>Description</th>
                                    <th>Color</th>
                                    <th>Sort Order</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in categories %}
                                <tr>
                                    <td>
                                        <span class="badge" style="background-color: {{ category.color }}">
                                            {{ category.display_name }}
                                        </span>
                                    </td>
                                    <td>{{ category.description or '-' }}</td>
                                    <td>
                                        <span class="color-preview" style="background-color: {{ category.color }}; width: 20px; height: 20px; display: inline-block; border-radius: 3px;"></span>
                                        {{ category.color }}
                                    </td>
                                    <td>{{ category.sort_order }}</td>
                                    <td>
                                        <span class="badge badge-status bg-{{ 'success' if category.is_active else 'secondary' }}">
                                            {{ 'Active' if category.is_active else 'Inactive' }}
                                        </span>
                                    </td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory({{ category.id }})" data-bs-toggle="tooltip" title="Edit category details">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning me-1" onclick="toggleCategory({{ category.id }})" data-bs-toggle="tooltip" title="{{ 'Deactivate category' if category.is_active else 'Activate category' }}">
                                            <i class="fas fa-{{ 'eye-slash' if category.is_active else 'eye' }}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory({{ category.id }})" data-bs-toggle="tooltip" title="Delete category permanently">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
</old_str>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                        <h5>No categories found</h5>
                        <p class="text-muted">Create your first service category to organize services.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Service Modal -->
<div class="modal fade" id="addServiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_service_route') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Service Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category <span class="text-danger">*</span></label>
                                <select class="form-select" name="category_id" required>
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.display_name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Category is required for the service</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Duration (minutes) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="duration" min="15" step="15" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Price <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="is_active" checked>
                            <label class="form-check-label" for="is_active">
                                Active Service
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Service Modal -->
<div class="modal fade" id="editServiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editServiceForm" action="#">
                <input type="hidden" id="editServiceId" name="service_id"/>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Service Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editServiceName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="editServiceCategory" name="category_id">
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editServiceDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Duration (minutes) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editServiceDuration" name="duration" min="15" step="15" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Price <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editServicePrice" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editServiceActive" name="is_active">
                            <label class="form-check-label" for="editServiceActive">
                                Active Service
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Services</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="GET" action="{{ url_for('export_services') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Category Filter</label>
                        <select class="form-select" name="category">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.name }}">{{ category.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Export CSV</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Service Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_service_category') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Category Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" placeholder="e.g., facial, massage" required>
                        <small class="text-muted">This will be used internally (lowercase, underscores)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Display Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="display_name" placeholder="e.g., Facial Treatments" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Brief description of this category"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Color</label>
                                <input type="color" class="form-control form-control-color" name="color" value="#007bff">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sort Order</label>
                                <input type="number" class="form-control" name="sort_order" value="0" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="addCategoryActive" checked>
                            <label class="form-check-label" for="addCategoryActive">
                                Active Category
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Service Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editCategoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Display Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editCategoryDisplayName" name="display_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editCategoryDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Color</label>
                                <input type="color" class="form-control form-control-color" id="editCategoryColor" name="color">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sort Order</label>
                                <input type="number" class="form-control" id="editCategorySortOrder" name="sort_order" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editCategoryIsActive" name="is_active">
                            <label class="form-check-label" for="editCategoryIsActive">
                                Active Category
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Handle edit form submission
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"], [title]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    const editForm = document.getElementById('editServiceForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const serviceId = document.getElementById('editServiceId').value;
            
            // Create FormData from the form
            const formData = new FormData(this);
            
            fetch(`/services/${serviceId}/edit`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Hide modal and reload
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editServiceModal'));
                    modal.hide();
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the service');
            });
        });
    }
});
function filterServices() {
    const categoryFilter = document.getElementById('categoryFilter').value;
    const url = new URL(window.location);
    if (categoryFilter) {
        url.searchParams.set('category', categoryFilter);
    } else {
        url.searchParams.delete('category');
    }
    window.location.href = url;
}

function editService(serviceId) {
    console.log('Editing service:', serviceId);
    
    if (!serviceId) {
        alert('Invalid service ID');
        return;
    }
    
    // Get service data and populate edit modal
    fetch(`/api/services/${serviceId}`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(service => {
            console.log('Service data received:', service);
            if (!service || service.error) {
                throw new Error(service?.error || 'Service not found');
            }
            
            // Show modal first
            const modalElement = document.getElementById('editServiceModal');
            if (!modalElement) {
                throw new Error('Edit modal not found in page');
            }
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
            
            // Wait a moment for modal to be fully rendered in DOM
            setTimeout(() => {
                try {
                    // Populate edit modal with robust null checks
                    const setFieldValue = (fieldId, value) => {
                        try {
                            const field = document.getElementById(fieldId);
                            if (field && field !== null) {
                                field.value = value ?? '';
                            } else {
                                console.warn(`Field ${fieldId} not found in edit modal`);
                            }
                        } catch (e) {
                            console.error(`Error setting field ${fieldId}:`, e);
                        }
                    };
                    
                    const setCheckboxValue = (fieldId, checked) => {
                        try {
                            const field = document.getElementById(fieldId);
                            if (field && field !== null) {
                                field.checked = Boolean(checked);
                            } else {
                                console.warn(`Checkbox ${fieldId} not found in edit modal`);
                            }
                        } catch (e) {
                            console.error(`Error setting checkbox ${fieldId}:`, e);
                        }
                    };
                    
                    setFieldValue('editServiceId', serviceId);
                    setFieldValue('editServiceName', service.name);
                    setFieldValue('editServiceDescription', service.description);
                    setFieldValue('editServiceDuration', service.duration ?? 60);
                    setFieldValue('editServicePrice', service.price ?? 0);
                    setFieldValue('editServiceCategory', service.category_id);
                    setCheckboxValue('editServiceActive', service.is_active);
                    
                    console.log('Edit form populated successfully');
                } catch (e) {
                    console.error('Error populating form:', e);
                    modal.hide();
                    throw e;
                }
            }, 100);
        })
        .catch(error => {
            console.error('Error in editService:', error);
            alert('Error loading service data: ' + (error.message || 'Unknown error'));
        });
}

function toggleService(serviceId) {
    if (!serviceId) {
        alert('Invalid service ID');
        return;
    }
    
    console.log('Toggling service:', serviceId);
    
    fetch(`/services/${serviceId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => {
        console.log('Toggle response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Toggle response:', data);
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred: ' + error.message);
    });
}

function deleteService(serviceId) {
    if (!serviceId) {
        alert('Invalid service ID');
        return;
    }
    
    if (confirm('Are you sure you want to delete this service? This action cannot be undone.')) {
        console.log('Deleting service:', serviceId);
        
        fetch(`/services/${serviceId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => {
            console.log('Delete response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Delete response:', data);
            if (data.success) {
                alert(data.message || 'Service deleted successfully');
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred: ' + error.message);
        });
    }
}

function editCategory(categoryId) {
    // Fetch category data and populate edit modal
    fetch(`/api/categories/${categoryId}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }
        
        // Populate modal fields
        document.getElementById('editCategoryDisplayName').value = data.display_name || '';
        document.getElementById('editCategoryDescription').value = data.description || '';
        document.getElementById('editCategoryColor').value = data.color || '#007bff';
        document.getElementById('editCategorySortOrder').value = data.sort_order || 0;
        document.getElementById('editCategoryIsActive').checked = data.is_active;
        
        // Set form action
        document.getElementById('editCategoryForm').action = `/service-categories/${categoryId}/edit`;
        
        // Show modal
        new bootstrap.Modal(document.getElementById('editCategoryModal')).show();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while fetching category data');
    });
}

function toggleCategory(categoryId) {
    fetch(`/service-categories/${categoryId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

function deleteCategory(categoryId) {
    if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
        fetch(`/service-categories/${categoryId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}
</script>

{% endblock %}