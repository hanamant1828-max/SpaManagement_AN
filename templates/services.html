{% extends "base.html" %}

{% block title %}Service Management - Spa & Salon Management Suite{% endblock %}

{% block body_class %}page-service-management{% endblock %}

{% block extra_css %}
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
{% endblock %}

{% block extra_js %}
<!-- DataTables JavaScript - Must load before our custom scripts -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<style>
/* Stats Cards - Same as Staff Management */
.stats-card {
    background: #ffffff;
    border: 1px solid #E0E0E0;
    border-radius: 8px;
    border-left: 4px solid;
    transition: box-shadow 0.2s ease;
}
.stats-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.stats-card.total-staff {
    border-left-color: #4A90E2;
}
.stats-card.active-staff {
    border-left-color: #7CB342;
}
.stats-card.departments {
    border-left-color: #FDB45C;
}
.stats-card .card-body {
    padding: 1.25rem;
}
.stats-card .card-title {
    color: #757575;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
}
.stats-card .stats-value {
    color: #333333;
    font-size: 1.75rem;
    font-weight: 600;
}
.stats-card .stats-icon {
    color: #757575;
    opacity: 0.7;
}

/* Table Card Styling */
.staff-table-card {
    background: #ffffff;
    border: 1px solid #E0E0E0;
    border-radius: 8px;
    overflow: hidden;
}
.staff-table-card .card-header {
    background: #ffffff;
    border-bottom: 1px solid #E0E0E0;
    padding: 1rem 1.25rem;
}
.staff-table-card .card-header h5 {
    color: #333333;
    font-weight: 600;
    margin: 0;
}

/* DataTables Styling - Clean Bootstrap Style */
.dataTables_wrapper {
    padding: 15px 0;
}

.dataTables_wrapper .dataTables_paginate .paginate_button {
    background: #ffffff !important;
    color: #0d6efd !important;
    border: 1px solid #dee2e6 !important;
    border-radius: 0 !important;
    min-width: 40px;
    padding: 8px 14px !important;
    margin: 0 !important;
    margin-left: -1px !important;
    font-weight: 400;
    font-size: 0.95rem;
    transition: all 0.15s ease;
}
.dataTables_wrapper .dataTables_paginate .paginate_button:first-child {
    border-radius: 6px 0 0 6px !important;
    margin-left: 0 !important;
}
.dataTables_wrapper .dataTables_paginate .paginate_button:last-child {
    border-radius: 0 6px 6px 0 !important;
}
.dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    background: #e9ecef !important;
    border-color: #dee2e6 !important;
    color: #0a58ca !important;
}
.dataTables_wrapper .dataTables_paginate .paginate_button.current,
.dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
    background: #0d6efd !important;
    border-color: #0d6efd !important;
    color: #ffffff !important;
    font-weight: 500;
    z-index: 3;
    position: relative;
}

.dataTables_wrapper .dataTables_filter input {
    border: 1px solid #ced4da !important;
    border-radius: 6px;
    padding: 8px 14px;
    background: #ffffff;
    color: #495057;
    font-size: 0.95rem;
}
.dataTables_wrapper .dataTables_filter input:focus {
    border-color: #86b7fe !important;
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.25);
    outline: none;
}

.dataTables_wrapper .dataTables_length select {
    border: 1px solid #ced4da !important;
    border-radius: 6px;
    padding: 8px 30px 8px 14px;
    background: #ffffff;
    color: #495057;
}

/* Text colors */
.text-primary-dark {
    color: #333333;
}
.text-secondary-gray {
    color: #757575;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-spa me-2"></i>Service Management
                </h1>
                <div class="btn-group gap-2">
                    <button
                        type="button"
                        class="btn btn-success"
                        data-bs-toggle="modal"
                        data-bs-target="#addServiceModal"
                    >
                        <i class="fas fa-plus me-2"></i>Add New Service
                    </button>
                    <button
                        type="button"
                        class="btn btn-warning"
                        data-bs-toggle="modal"
                        data-bs-target="#exportModal"
                    >
                        <i class="fas fa-download me-2"></i>Export Data
                    </button>
                    <button
                        type="button"
                        class="btn btn-primary"
                        onclick="refreshServiceData()"
                    >
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card total-staff">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Total Services</h6>
                            <h3 class="stats-value mb-0" id="totalServiceCount">0</h3>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-concierge-bell fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card active-staff">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Active Services</h6>
                            <h3 class="stats-value mb-0" id="activeServiceCount">0</h3>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card departments">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Categories</h6>
                            <h3 class="stats-value mb-0" id="categoryCount">0</h3>
                        </div>
                        <div class="stats-icon">
                            <i class="fas fa-tags fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="serviceManagementTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="services-tab" data-bs-toggle="tab" data-bs-target="#services-pane" type="button" role="tab">
                <i class="fas fa-spa me-2"></i>Services
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories-pane" type="button" role="tab">
                <i class="fas fa-tags me-2"></i>Categories
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="serviceManagementTabContent">

        <!-- Services Tab -->
        <div class="tab-pane fade show active" id="services-pane" role="tabpanel">
            <!-- Service List -->
            <div class="row">
                <div class="col-12">
                    <div class="card staff-table-card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Service List</h5>
                        </div>
                        <div class="card-body">
                            <!-- Loading State -->
                            <div id="loadingState" class="text-center py-5">
                                <div class="spinner-border" style="color: #4A90E2;" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-secondary-gray">Loading service data...</p>
                            </div>

                            <!-- Services Table with DataTables -->
                            <div id="servicesTableContainer" style="display: none">
                                <div class="table-responsive">
                                    <table id="servicesTable" class="table table-hover w-100">
                                        <thead>
                                            <tr>
                                                <th>Service Info</th>
                                                <th>Category & Duration</th>
                                                <th>Price</th>
                                                <th class="text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="servicesTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div
                                id="emptyState"
                                class="text-center py-5"
                                style="display: none"
                            >
                                <i class="fas fa-concierge-bell fa-3x mb-3" style="color: #757575;"></i>
                                <h5 class="text-primary-dark">No services found</h5>
                                <p class="text-secondary-gray">
                                    No services available. Please add new services to get started.
                                </p>
                                <button
                                    type="button"
                                    class="btn btn-success btn-lg"
                                    data-bs-toggle="modal"
                                    data-bs-target="#addServiceModal"
                                >
                                    <i class="fas fa-plus me-2"></i>Add Your First Service
                                </button>
                                <div class="mt-3">
                                    <small class="text-secondary-gray">
                                        Services will appear here once added
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hidden filter elements for compatibility -->
            <div style="display: none;">
                <select id="categoryFilter"><option value="">All Categories</option></select>
                <select id="statusFilter"><option value="">All Status</option></select>
                <input type="text" id="serviceSearch" />
            </div>
        </div>

        <!-- Categories Tab -->
        <div class="tab-pane fade" id="categories-pane" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Service Categories</h5>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCategoryModal" title="Create a new service category">
                    <i class="fas fa-plus me-2"></i>Add New Category
                </button>
            </div>

            <div class="card">
                <div class="card-body">
                    {% if categories %}
                    <div class="spa-table-responsive">
                        <table class="spa-table">
                            <thead>
                                <tr>
                                    <th>Category Name</th>
                                    <th>Description</th>
                                    <th>Color</th>
                                    <th>Sort Order</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in categories %}
                                <tr>
                                    <td>
                                        <span class="badge" style="background-color: {{ category.color }}">
                                            {{ category.display_name }}
                                        </span>
                                    </td>
                                    <td>{{ category.description or '-' }}</td>
                                    <td>
                                        <span class="color-preview" style="background-color: {{ category.color }}; width: 20px; height: 20px; display: inline-block; border-radius: 3px;"></span>
                                        {{ category.color }}
                                    </td>
                                    <td>{{ category.sort_order }}</td>
                                    <td>
                                        <span class="badge badge-status bg-{{ 'success' if category.is_active else 'secondary' }}">
                                            {{ 'Active' if category.is_active else 'Inactive' }}
                                        </span>
                                    </td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-primary me-1" onclick="editCategory({{ category.id }})" data-bs-toggle="tooltip" title="Edit category details">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning me-1" onclick="toggleCategory({{ category.id }})" data-bs-toggle="tooltip" title="{{ 'Deactivate category' if category.is_active else 'Activate category' }}">
                                            <i class="fas fa-{{ 'eye-slash' if category.is_active else 'eye' }}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteCategory({{ category.id }})" data-bs-toggle="tooltip" title="Delete category permanently">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                        <h5>No categories found</h5>
                        <p class="text-muted">Create your first service category to organize services.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Service Modal -->
<div class="modal fade" id="addServiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_service_route') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Service Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category <span class="text-danger">*</span></label>
                                <select class="form-select" name="category_id" required>
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.display_name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Category is required for the service</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Duration (minutes) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="duration" min="15" step="15" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Price <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="is_active" checked>
                            <label class="form-check-label" for="is_active">
                                Active Service
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Service Modal -->
<div class="modal fade" id="editServiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editServiceForm" action="#">
                <input type="hidden" id="editServiceId" name="service_id"/>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Service Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editServiceName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="editServiceCategory" name="category_id">
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editServiceDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Duration (minutes) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editServiceDuration" name="duration" min="15" step="15" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Price <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editServicePrice" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editServiceActive" name="is_active">
                            <label class="form-check-label" for="editServiceActive">
                                Active Service
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Services</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="GET" action="{{ url_for('export_services') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Category Filter</label>
                        <select class="form-select" name="category">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.name }}">{{ category.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Export CSV</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Service Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_service_category') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Category Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" placeholder="e.g., facial, massage" required>
                        <small class="text-muted">This will be used internally (lowercase, underscores)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Display Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="display_name" placeholder="e.g., Facial Treatments" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Brief description of this category"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Color</label>
                                <input type="color" class="form-control form-control-color" name="color" value="#007bff">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sort Order</label>
                                <input type="number" class="form-control" name="sort_order" value="0" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="addCategoryActive" value="on" checked>
                            <label class="form-check-label" for="addCategoryActive">
                                Active Category
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Service Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editCategoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Display Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editCategoryDisplayName" name="display_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editCategoryDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Color</label>
                                <input type="color" class="form-control form-control-color" id="editCategoryColor" name="color">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sort Order</label>
                                <input type="number" class="form-control" id="editCategorySortOrder" name="sort_order" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editCategoryIsActive" name="is_active">
                            <label class="form-check-label" for="editCategoryIsActive">
                                Active Category
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global variables for data management
let allServices = [];
let allCategories = [];
let filteredServices = [];
let serviceStats = { total: 0, active: 0, inactive: 0 };
let servicesDataTable = null;

// Utility function to show notifications
function showNotification(message, type = "info", duration = 5000) {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toastId = `toast-${Date.now()}`;
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
    toastElement.id = toastId;
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'assertive');
    toastElement.setAttribute('data-bs-autohide', 'true');
    toastElement.setAttribute('data-bs-delay', duration);
    toastElement.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    toastContainer.appendChild(toastElement);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1060';
    document.body.appendChild(container);
    return container;
}

// Utility function to show/hide loading indicator
function showLoading(isLoading) {
    const loadingState = document.getElementById("loadingState");
    const servicesTableContainer = document.getElementById("servicesTableContainer");
    const emptyState = document.getElementById("emptyState");

    if (loadingState) {
        loadingState.style.display = isLoading ? "block" : "none";
    }
    if (servicesTableContainer) {
        servicesTableContainer.style.display = isLoading ? "none" : "block";
    }
    if (emptyState) {
        emptyState.style.display = "none";
    }
}

// Update statistics and display them
function updateStats() {
    serviceStats.total = allServices.length;
    serviceStats.active = allServices.filter(s => s.is_active).length;
    serviceStats.inactive = allServices.length - serviceStats.active;

    // Update stats cards
    document.getElementById('totalServiceCount').textContent = serviceStats.total;
    document.getElementById('activeServiceCount').textContent = serviceStats.active;
    document.getElementById('categoryCount').textContent = allCategories.length;
}

// Refresh service data
function refreshServiceData() {
    console.log("Refreshing service data...");
    loadServicesData();
}

// Update category filter options
function updateCategoryFilter() {
    const categoryFilter = document.getElementById('categoryFilter');
    if (!categoryFilter) return;

    // Clear existing options except the first one
    categoryFilter.innerHTML = '<option value="">All Categories</option>';

    // Add categories from the loaded data with safe sorting
    const sortedCategories = [...allCategories].sort((a, b) => {
        const nameA = (a.display_name || a.name || '').toLowerCase();
        const nameB = (b.display_name || b.name || '').toLowerCase();
        return nameA.localeCompare(nameB);
    });

    sortedCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.display_name || category.name || 'Unknown';
        categoryFilter.appendChild(option);
    });
}


// Render the services table based on filteredServices
function renderServicesTable() {
    console.log("Rendering services table with", allServices.length, "services");
    const tbody = document.getElementById("servicesTableBody");
    const emptyState = document.getElementById("emptyState");
    const tableContainer = document.getElementById("servicesTableContainer");
    const loadingState = document.getElementById("loadingState");

    // Hide loading state
    if (loadingState) {
        loadingState.style.display = "none";
    }

    if (!tbody) {
        console.error("Table body not found");
        return;
    }

    // Clear existing data
    tbody.innerHTML = "";

    if (allServices.length === 0) {
        console.log("No services to display, showing empty state");
        if (tableContainer) tableContainer.style.display = "none";
        if (emptyState) emptyState.style.display = "block";
        return;
    }

    console.log("Showing table with", allServices.length, "services");
    if (tableContainer) tableContainer.style.display = "block";
    if (emptyState) emptyState.style.display = "none";

    // Render each service row
    allServices.forEach((service) => {
        const category = allCategories.find(cat => cat.id === service.category_id);
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>
                <div>
                    <strong class="d-block">${service.name}</strong>
                    ${service.description ? `<small class="text-muted d-block">${service.description.substring(0, 60)}${service.description.length > 60 ? '...' : ''}</small>` : ''}
                </div>
            </td>
            <td>
                ${category ? `
                    <span class="badge" style="background-color: ${category.color}; font-size: 0.75rem;">
                        ${category.display_name}
                    </span>
                    <div class="text-muted small mt-1">
                        <i class="fas fa-clock me-1"></i>${service.duration || 0} min
                    </div>
                ` : `
                    <span class="text-muted">No Category</span>
                    <div class="text-muted small mt-1">
                        <i class="fas fa-clock me-1"></i>${service.duration || 0} min
                    </div>
                `}
            </td>
            <td>
                <strong>$${service.price !== null && service.price !== undefined ? service.price.toFixed(2) : '0.00'}</strong>
            </td>
            <td class="text-center">
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-primary" onclick="editService(${service.id})" title="Edit service">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-${service.is_active ? 'warning' : 'success'}" onclick="toggleService(${service.id})" title="${service.is_active ? 'Deactivate' : 'Activate'} service">
                        <i class="fas fa-${service.is_active ? 'toggle-off' : 'toggle-on'}"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteService(${service.id})" title="Delete service">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Initialize or refresh DataTable with error handling
    try {
        if (typeof $.fn.DataTable === 'undefined') {
            console.error("DataTables library not loaded");
            return;
        }
        
        if (servicesDataTable) {
            servicesDataTable.destroy();
        }

        servicesDataTable = $('#servicesTable').DataTable({
            pageLength: 10,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
            order: [[0, 'asc']],
            language: {
                search: "Search services:",
                lengthMenu: "Show _MENU_ services per page",
                info: "Showing _START_ to _END_ of _TOTAL_ services",
                infoEmpty: "No services available",
                infoFiltered: "(filtered from _MAX_ total services)"
            }
        });

        console.log("âœ… DataTables initialized successfully");
    } catch (error) {
        console.error("Error initializing DataTables:", error);
    }
}


// Filter services based on search term, category, and status
function filterServices() {
        console.log("Filtering services...");
        const searchTerm = document
            .getElementById("serviceSearch")
            .value.toLowerCase().trim();
        const categoryFilter = document.getElementById("categoryFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;

        const filtered = allServices.filter((service) => {
            const matchesSearch =
                !searchTerm ||
                service.name.toLowerCase().includes(searchTerm) ||
                (service.service_code &&
                    service.service_code.toLowerCase().includes(searchTerm)) ||
                (service.description &&
                    service.description.toLowerCase().includes(searchTerm)) ||
                (service.category_name &&
                    service.category_name.toLowerCase().includes(searchTerm));

            const matchesCategory =
                !categoryFilter ||
                service.category_id == categoryFilter;

            const matchesStatus =
                !statusFilter ||
                (statusFilter === "active" && service.is_active) ||
                (statusFilter === "inactive" && !service.is_active);

            return matchesSearch && matchesCategory && matchesStatus;
        });

        console.log(`Filtered ${filtered.length} services from ${allServices.length} total`);
        filteredServices = filtered;
        renderServicesTable();

        // Update search results count
        updateSearchResultsCount(filtered.length, searchTerm);
    }

    function updateSearchResultsCount(count, searchTerm) {
        const statsElement = document.getElementById('serviceStats');
        if (statsElement) {
            if (searchTerm) {
                statsElement.innerHTML = `<i class="fas fa-search me-1"></i>Found ${count} service${count !== 1 ? 's' : ''} matching "${searchTerm}"`;
                statsElement.style.color = count > 0 ? '#28a745' : '#dc3545';
            } else if (count < allServices.length) {
                statsElement.innerHTML = `Showing ${count} of ${allServices.length} services`;
                statsElement.style.color = '#6c757d';
            } else {
                statsElement.innerHTML = `${count} Total Services`;
                statsElement.style.color = '#6c757d';
            }
        }
    }

    function clearServiceFilters() {
        document.getElementById("serviceSearch").value = "";
        document.getElementById("categoryFilter").value = "";
        document.getElementById("statusFilter").value = "";
        filterServices();
    }

// Clear the search input and re-filter
function clearSearch() {
    document.getElementById('serviceSearch').value = '';
    filterServices();
}


// Load initial data for services and categories
async function loadServicesData() {
        try {
            console.log("Loading services data...");
            showLoading(true);
            const response = await fetch("/api/services");

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log("Received data:", data);

            if (data.success) {
                allServices = data.services || [];
                allCategories = data.categories || [];

                // Enrich services with category names for easier searching
                allServices = allServices.map(service => {
                    const category = allCategories.find(cat => cat.id === service.category_id);
                    return {
                        ...service,
                        category_name: category ? category.display_name : 'Uncategorized'
                    };
                });

                filteredServices = [...allServices];

                console.log(`Loaded ${allServices.length} services and ${allCategories.length} categories`);

                updateStats();
                renderServicesTable();
                updateCategoryFilter();

                if (allServices.length > 0) {
                    showNotification(`${allServices.length} services loaded successfully`, "success", 3000);
                }
            } else {
                throw new Error(data.error || "Failed to load services");
            }
        } catch (error) {
            console.error("Error loading services:", error);
            showNotification("Error loading services: " + error.message, "error");
            // Show empty state on error
            const emptyState = document.getElementById("emptyState");
            const tableContainer = document.getElementById("servicesTableContainer");
            if (tableContainer) tableContainer.style.display = "none";
            if (emptyState) emptyState.style.display = "block";
        } finally {
            showLoading(false);
        }
    }

// Fetch and populate the edit service modal
function editService(serviceId) {
    console.log('Editing service:', serviceId);

    if (!serviceId) {
        showNotification('Invalid service ID', 'error');
        return;
    }

    fetch(`/api/services/${serviceId}`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(service => {
            console.log('Service data received:', service);
            if (!service || service.error) {
                throw new Error(service?.error || 'Service not found');
            }

            const modalElement = document.getElementById('editServiceModal');
            if (!modalElement) {
                throw new Error('Edit modal element not found');
            }
            
            // Get or create modal instance
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            
            // Populate form fields BEFORE showing the modal to avoid timing issues
            try {
                const editServiceId = document.getElementById('editServiceId');
                const editServiceName = document.getElementById('editServiceName');
                const editServiceDescription = document.getElementById('editServiceDescription');
                const editServiceDuration = document.getElementById('editServiceDuration');
                const editServicePrice = document.getElementById('editServicePrice');
                const editServiceCategory = document.getElementById('editServiceCategory');
                const editServiceActive = document.getElementById('editServiceActive');
                const editForm = document.getElementById('editServiceForm');
                
                if (editServiceId) editServiceId.value = service.id || '';
                if (editServiceName) editServiceName.value = service.name || '';
                if (editServiceDescription) editServiceDescription.value = service.description || '';
                if (editServiceDuration) editServiceDuration.value = service.duration ?? 60;
                if (editServicePrice) editServicePrice.value = service.price ?? 0;
                
                // Handle category select - check for Select2
                if (editServiceCategory) {
                    editServiceCategory.value = service.category_id || '';
                    // If Select2 is initialized on this element, trigger change
                    if (typeof $ !== 'undefined' && $(editServiceCategory).hasClass('select2-hidden-accessible')) {
                        $(editServiceCategory).val(service.category_id || '').trigger('change');
                    }
                }
                
                if (editServiceActive) editServiceActive.checked = Boolean(service.is_active);
                
                // Update form action
                if (editForm) {
                    editForm.action = `/services/${service.id}/edit`;
                }
                
                console.log('Edit form populated successfully');
            } catch (populateError) {
                console.error('Error populating form:', populateError);
            }
            
            // Show the modal after populating
            modal.show();
        })
        .catch(error => {
            console.error('Error in editService:', error);
            showNotification('Error loading service data: ' + (error.message || 'Unknown error'), 'error');
        });
}

// Handle the submission of the edit service form
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"], [title]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    const editForm = document.getElementById('editServiceForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const serviceId = document.getElementById('editServiceId').value;

            const formData = new FormData(this);

            fetch(`/services/${serviceId}/edit`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editServiceModal'));
                    modal.hide();
                    showNotification('Service updated successfully', 'success');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the service');
            });
        });
    }

    // Initial data load when the page is ready - delay to ensure DataTables library loads
    setTimeout(function() {
        if (typeof $.fn.DataTable !== 'undefined') {
            loadServicesData();
        } else {
            console.error("DataTables not available, retrying...");
            setTimeout(loadServicesData, 500);
        }
    }, 100);
});

// Toggle service active status
function toggleService(serviceId) {
    if (!serviceId) {
        alert('Invalid service ID');
        return;
    }

    console.log('Toggling service:', serviceId);

    fetch(`/services/${serviceId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Toggle response:', data);
        if (data.success) {
            showNotification(data.message, 'success');
            location.reload();
        } else {
            alert('Error: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred: ' + error.message);
    });
}

// Delete a service
function deleteService(serviceId) {
    if (!serviceId) {
        alert('Invalid service ID');
        return;
    }

    if (confirm('Are you sure you want to delete this service? This action cannot be undone.')) {
        console.log('Deleting service:', serviceId);

        fetch(`/services/${serviceId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Delete response:', data);
            if (data.success) {
                showNotification(data.message || 'Service deleted successfully', 'success');
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred: ' + error.message);
        });
    }
}

// Fetch and populate the edit category modal
function editCategory(categoryId) {
    fetch(`/api/categories/${categoryId}`)
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }

        document.getElementById('editCategoryDisplayName').value = data.display_name || '';
        document.getElementById('editCategoryDescription').value = data.description || '';
        document.getElementById('editCategoryColor').value = data.color || '#007bff';
        document.getElementById('editCategorySortOrder').value = data.sort_order || 0;
        document.getElementById('editCategoryIsActive').checked = data.is_active;

        document.getElementById('editCategoryForm').action = `/service-categories/${categoryId}/edit`;

        new bootstrap.Modal(document.getElementById('editCategoryModal')).show();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while fetching category data');
    });
}

// Toggle category active status
function toggleCategory(categoryId) {
    fetch(`/service-categories/${categoryId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification('Category status updated', 'success');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

// Delete a category
function deleteCategory(categoryId) {
    if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
        fetch(`/service-categories/${categoryId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showNotification('Category deleted', 'success');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}
</script>
{% endblock %}