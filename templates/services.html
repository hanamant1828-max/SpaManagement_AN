{% extends "base.html" %}

{% block title %}Service Management - Spa Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-spa me-2"></i>Service Management</h2>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="serviceManagementTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="services-tab" data-bs-toggle="tab" data-bs-target="#services-pane" type="button" role="tab">
                <i class="fas fa-spa me-2"></i>Services
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories-pane" type="button" role="tab">
                <i class="fas fa-tags me-2"></i>Categories
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="serviceManagementTabContent">

        <!-- Services Tab -->
        <div class="tab-pane fade show active" id="services-pane" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center">
                    <div class="input-group me-3" style="width: 300px;">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="serviceSearch" placeholder="Search services..." onkeyup="filterServices()">
                        <button class="btn btn-secondary" type="button" onclick="clearSearch()" title="Clear search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <select class="form-select me-3" id="categoryFilter" onchange="filterServices()" style="width: 200px;">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}" {{ 'selected' if category_filter == category.id else '' }}>
                            {{ category.display_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <button class="btn btn-warning me-2" data-bs-toggle="modal" data-bs-target="#exportModal" title="Export services to CSV file">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addServiceModal" title="Create a new service offering">
                        <i class="fas fa-plus me-2"></i>Add New Service
                    </button>
                </div>
            </div>

            <!-- Search and Filter Section -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input
                            type="text"
                            class="form-control"
                            id="serviceSearch"
                            placeholder="Search services by name, code, or description..."
                            onkeyup="filterServices()"
                        />
                    </div>
                    <div class="col-md-3">
                        <select
                            class="form-select"
                            id="categoryFilter"
                            onchange="filterServices()"
                        >
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">
                                {{ category.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select
                            class="form-select"
                            id="statusFilter"
                            onchange="filterServices()"
                        >
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button
                            type="button"
                            class="btn btn-secondary w-100"
                            onclick="clearServiceFilters()"
                        >
                            <i class="fas fa-times me-1"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>

            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">All Services</h5>
                        <span id="serviceStats" class="text-muted"></span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="servicesTableContainer">
                        <div class="spa-table-container">
                            <table class="spa-table">
                                <thead>
                                    <tr>
                                        <th>Service Name</th>
                                        <th>Category</th>
                                        <th>Duration</th>
                                        <th>Price</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="servicesTableBody">
                                    <!-- Service rows will be rendered here by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-2">Loading services...</p>
                    </div>

                    <!-- Empty State -->
                    <div
                        id="emptyState"
                        class="text-center py-5"
                        style="display: none"
                    >
                        <i class="fas fa-concierge-bell fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No services found</h5>
                        <p class="text-muted">
                            No services available. Click 'Add New Service' to get started.
                        </p>
                        <button
                            type="button"
                            class="btn btn-primary btn-lg"
                            data-bs-toggle="modal"
                            data-bs-target="#addServiceModal"
                            onclick="showAddModal()"
                        >
                            <i class="fas fa-plus me-2"></i>Add Your First Service
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Tab -->
        <div class="tab-pane fade" id="categories-pane" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Service Categories</h5>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCategoryModal" title="Create a new service category">
                    <i class="fas fa-plus me-2"></i>Add New Category
                </button>
            </div>

            <div class="card">
                <div class="card-body">
                    {% if categories %}
                    <div class="spa-table-responsive">
                        <table class="spa-table">
                            <thead>
                                <tr>
                                    <th>Category Name</th>
                                    <th>Description</th>
                                    <th>Color</th>
                                    <th>Sort Order</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for category in categories %}
                                <tr>
                                    <td>
                                        <span class="badge" style="background-color: {{ category.color }}">
                                            {{ category.display_name }}
                                        </span>
                                    </td>
                                    <td>{{ category.description or '-' }}</td>
                                    <td>
                                        <span class="color-preview" style="background-color: {{ category.color }}; width: 20px; height: 20px; display: inline-block; border-radius: 3px;"></span>
                                        {{ category.color }}
                                    </td>
                                    <td>{{ category.sort_order }}</td>
                                    <td>
                                        <span class="badge badge-status bg-{{ 'success' if category.is_active else 'secondary' }}">
                                            {{ 'Active' if category.is_active else 'Inactive' }}
                                        </span>
                                    </td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-primary me-1" onclick="editCategory({{ category.id }})" data-bs-toggle="tooltip" title="Edit category details">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning me-1" onclick="toggleCategory({{ category.id }})" data-bs-toggle="tooltip" title="{{ 'Deactivate category' if category.is_active else 'Activate category' }}">
                                            <i class="fas fa-{{ 'eye-slash' if category.is_active else 'eye' }}"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteCategory({{ category.id }})" data-bs-toggle="tooltip" title="Delete category permanently">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                        <h5>No categories found</h5>
                        <p class="text-muted">Create your first service category to organize services.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Service Modal -->
<div class="modal fade" id="addServiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_service_route') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Service Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category <span class="text-danger">*</span></label>
                                <select class="form-select" name="category_id" required>
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.display_name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Category is required for the service</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Duration (minutes) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="duration" min="15" step="15" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Price <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="is_active" checked>
                            <label class="form-check-label" for="is_active">
                                Active Service
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Service Modal -->
<div class="modal fade" id="editServiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editServiceForm" action="#">
                <input type="hidden" id="editServiceId" name="service_id"/>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Service Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editServiceName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="editServiceCategory" name="category_id">
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editServiceDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Duration (minutes) <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editServiceDuration" name="duration" min="15" step="15" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Price <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="editServicePrice" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editServiceActive" name="is_active">
                            <label class="form-check-label" for="editServiceActive">
                                Active Service
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Service</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Services</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="GET" action="{{ url_for('export_services') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Category Filter</label>
                        <select class="form-select" name="category">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.name }}">{{ category.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Export CSV</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Service Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_service_category') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Category Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" placeholder="e.g., facial, massage" required>
                        <small class="text-muted">This will be used internally (lowercase, underscores)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Display Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="display_name" placeholder="e.g., Facial Treatments" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Brief description of this category"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Color</label>
                                <input type="color" class="form-control form-control-color" name="color" value="#007bff">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sort Order</label>
                                <input type="number" class="form-control" name="sort_order" value="0" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="addCategoryActive" value="on" checked>
                            <label class="form-check-label" for="addCategoryActive">
                                Active Category
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Service Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editCategoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Display Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editCategoryDisplayName" name="display_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="editCategoryDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Color</label>
                                <input type="color" class="form-control form-control-color" id="editCategoryColor" name="color">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Sort Order</label>
                                <input type="number" class="form-control" id="editCategorySortOrder" name="sort_order" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editCategoryIsActive" name="is_active">
                            <label class="form-check-label" for="editCategoryIsActive">
                                Active Category
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Global variables for data management
let allServices = [];
let allCategories = [];
let filteredServices = [];
let serviceStats = { total: 0, active: 0, inactive: 0 };

// Utility function to show notifications
function showNotification(message, type = "info", duration = 5000) {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toastId = `toast-${Date.now()}`;
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
    toastElement.id = toastId;
    toastElement.setAttribute('role', 'alert');
    toastElement.setAttribute('aria-live', 'assertive');
    toastElement.setAttribute('data-bs-autohide', 'true');
    toastElement.setAttribute('data-bs-delay', duration);
    toastElement.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    toastContainer.appendChild(toastElement);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.style.zIndex = '1060'; // Ensure it's above other elements
    document.body.appendChild(container);
    return container;
}

// Utility function to show/hide loading indicator
function showLoading(isLoading) {
    const loadingState = document.getElementById("loadingState");
    const servicesTableContainer = document.getElementById("servicesTableContainer");
    const emptyState = document.getElementById("emptyState");

    if (loadingState) {
        loadingState.style.display = isLoading ? "block" : "none";
    }
    if (servicesTableContainer) {
        servicesTableContainer.style.display = isLoading ? "none" : "block";
    }
    if (emptyState) {
        emptyState.style.display = "none"; // Always hide empty state when loading
    }
}

// Update statistics and display them
function updateStats() {
    serviceStats.total = allServices.length;
    serviceStats.active = allServices.filter(s => s.is_active).length;
    serviceStats.inactive = allServices.length - serviceStats.active;

    const statsElement = document.getElementById('serviceStats');
    if (statsElement) {
        statsElement.innerHTML = `Total: ${serviceStats.total}, Active: ${serviceStats.active}, Inactive: ${serviceStats.inactive}`;
    }
}

// Update category filter options
function updateCategoryFilter() {
    const categoryFilter = document.getElementById('categoryFilter');
    if (!categoryFilter) return;

    // Clear existing options except the first one
    categoryFilter.innerHTML = '<option value="">All Categories</option>';

    // Add categories from the loaded data with safe sorting
    const sortedCategories = [...allCategories].sort((a, b) => {
        const nameA = (a.display_name || a.name || '').toLowerCase();
        const nameB = (b.display_name || b.name || '').toLowerCase();
        return nameA.localeCompare(nameB);
    });

    sortedCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.display_name || category.name || 'Unknown';
        categoryFilter.appendChild(option);
    });
}


// Create a single row for the services table
function createServiceRow(service) {
    const row = document.createElement('tr');
    const category = allCategories.find(cat => cat.id === service.category_id);

    row.innerHTML = `
        <td>
            <strong>${service.name}</strong>
            ${category ? `<br><span class="badge" style="background-color: ${category.color}; font-size: 0.7rem;">${category.display_name}</span>` : ''}
        </td>
        <td>
            ${category ? `<span class="badge" style="background-color: ${category.color}">${category.display_name}</span>` : '<span class="text-muted">No Category</span>'}
        </td>
        <td>${service.duration || '-'} min</td>
        <td>$${service.price !== null && service.price !== undefined ? service.price.toFixed(2) : '-.--'}</td>
        <td>${(service.description && service.description.length > 50) ? service.description.substring(0, 50) + '...' : (service.description || '-')}</td>
        <td>
            <span class="badge bg-${service.is_active ? 'success' : 'secondary'}">
                ${service.is_active ? 'Active' : 'Inactive'}
            </span>
        </td>
        <td>
            <button class="btn btn-sm btn-primary me-1" onclick="editService(${service.id})" data-bs-toggle="tooltip" title="Edit service details" type="button">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-${service.is_active ? 'warning' : 'success'} me-1" onclick="toggleService(${service.id})" data-bs-toggle="tooltip" title="${service.is_active ? 'Deactivate' : 'Activate'} service" type="button">
                <i class="fas fa-${service.is_active ? 'toggle-off' : 'toggle-on'}"></i>
                <span class="ms-1">${service.is_active ? 'Deactivate' : 'Activate'}</span>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteService(${service.id})" data-bs-toggle="tooltip" title="Delete service permanently" type="button">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;
    return row;
}

// Render the services table based on filteredServices
function renderServicesTable() {
        console.log("Rendering services table with", filteredServices.length, "services");
        const tbody = document.getElementById("servicesTableBody");
        const emptyState = document.getElementById("emptyState");
        const tableContainer = document.getElementById("servicesTableContainer");
        const loadingState = document.getElementById("loadingState");

        // Hide loading state
        if (loadingState) {
            loadingState.style.display = "none";
        }

        if (!tbody) {
            console.error("Table body not found");
            return;
        }

        tbody.innerHTML = "";

        if (filteredServices.length === 0) {
            console.log("No services to display, showing empty state");
            if (tableContainer) tableContainer.style.display = "none";
            if (emptyState) {
                emptyState.style.display = "block";
                // Update empty state message based on whether filters are active
                const hasActiveFilters =
                    document.getElementById("serviceSearch").value ||
                    document.getElementById("categoryFilter").value ||
                    document.getElementById("statusFilter").value;

                const emptyMessage = emptyState.querySelector("p");
                if (emptyMessage) {
                    if (hasActiveFilters) {
                        emptyMessage.textContent = "No services match your search criteria. Try adjusting your filters.";
                    } else {
                        emptyMessage.textContent = "No services available. Click 'Add New Service' to get started.";
                    }
                }
            }
            return;
        }

        console.log("Showing table with", filteredServices.length, "services");
        if (tableContainer) tableContainer.style.display = "block";
        if (emptyState) emptyState.style.display = "none";

        filteredServices.forEach((service) => {
            const row = createServiceRow(service);
            tbody.appendChild(row);
        });
    }


// Filter services based on search term, category, and status
function filterServices() {
        console.log("Filtering services...");
        const searchTerm = document
            .getElementById("serviceSearch")
            .value.toLowerCase().trim();
        const categoryFilter = document.getElementById("categoryFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;

        const filtered = allServices.filter((service) => {
            const matchesSearch =
                !searchTerm ||
                service.name.toLowerCase().includes(searchTerm) ||
                (service.service_code &&
                    service.service_code.toLowerCase().includes(searchTerm)) ||
                (service.description &&
                    service.description.toLowerCase().includes(searchTerm)) ||
                (service.category_name &&
                    service.category_name.toLowerCase().includes(searchTerm));

            const matchesCategory =
                !categoryFilter ||
                service.category_id == categoryFilter;

            const matchesStatus =
                !statusFilter ||
                (statusFilter === "active" && service.is_active) ||
                (statusFilter === "inactive" && !service.is_active);

            return matchesSearch && matchesCategory && matchesStatus;
        });

        console.log(`Filtered ${filtered.length} services from ${allServices.length} total`);
        filteredServices = filtered;
        renderServicesTable();

        // Update search results count
        updateSearchResultsCount(filtered.length, searchTerm);
    }

    function updateSearchResultsCount(count, searchTerm) {
        const statsElement = document.getElementById('serviceStats');
        if (statsElement) {
            if (searchTerm) {
                statsElement.innerHTML = `<i class="fas fa-search me-1"></i>Found ${count} service${count !== 1 ? 's' : ''} matching "${searchTerm}"`;
                statsElement.style.color = count > 0 ? '#28a745' : '#dc3545';
            } else if (count < allServices.length) {
                statsElement.innerHTML = `Showing ${count} of ${allServices.length} services`;
                statsElement.style.color = '#6c757d';
            } else {
                statsElement.innerHTML = `${count} Total Services`;
                statsElement.style.color = '#6c757d';
            }
        }
    }

    function clearServiceFilters() {
        document.getElementById("serviceSearch").value = "";
        document.getElementById("categoryFilter").value = "";
        document.getElementById("statusFilter").value = "";
        filterServices();
    }

// Clear the search input and re-filter
function clearSearch() {
    document.getElementById('serviceSearch').value = '';
    filterServices();
}


// Load initial data for services and categories
async function loadServicesData() {
        try {
            console.log("Loading services data...");
            showLoading(true);
            const response = await fetch("/api/services");

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            console.log("Received data:", data);

            if (data.success) {
                allServices = data.services || [];
                allCategories = data.categories || [];

                // Enrich services with category names for easier searching
                allServices = allServices.map(service => {
                    const category = allCategories.find(cat => cat.id === service.category_id);
                    return {
                        ...service,
                        category_name: category ? category.display_name : 'Uncategorized'
                    };
                });

                filteredServices = [...allServices];

                console.log(`Loaded ${allServices.length} services and ${allCategories.length} categories`);

                updateStats();
                renderServicesTable();
                updateCategoryFilter();

                if (allServices.length > 0) {
                    showNotification(`${allServices.length} services loaded successfully`, "success", 3000);
                }
            } else {
                throw new Error(data.error || "Failed to load services");
            }
        } catch (error) {
            console.error("Error loading services:", error);
            showNotification("Error loading services: " + error.message, "error");
            // Show empty state on error
            const emptyState = document.getElementById("emptyState");
            const tableContainer = document.getElementById("servicesTableContainer");
            if (tableContainer) tableContainer.style.display = "none";
            if (emptyState) emptyState.style.display = "block";
        } finally {
            showLoading(false);
        }
    }

// Fetch and populate the edit service modal
function editService(serviceId) {
    console.log('Editing service:', serviceId);

    if (!serviceId) {
        alert('Invalid service ID');
        return;
    }

    fetch(`/api/services/${serviceId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(service => {
            if (!service || service.error) {
                throw new Error(service?.error || 'Service not found');
            }

            const modalElement = document.getElementById('editServiceModal');
            if (!modalElement) {
                throw new Error('Edit modal element not found');
            }
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            // Use setTimeout to ensure modal is fully rendered before populating
            setTimeout(() => {
                const setFieldValue = (fieldId, value) => {
                    const field = document.getElementById(fieldId);
                    if (field) field.value = value ?? '';
                    else console.warn(`Field ${fieldId} not found in edit modal.`);
                };

                const setCheckboxValue = (fieldId, checked) => {
                    const field = document.getElementById(fieldId);
                    if (field) field.checked = Boolean(checked);
                    else console.warn(`Checkbox ${fieldId} not found in edit modal.`);
                };

                setFieldValue('editServiceId', service.id);
                setFieldValue('editServiceName', service.name);
                setFieldValue('editServiceDescription', service.description);
                setFieldValue('editServiceDuration', service.duration ?? 60);
                setFieldValue('editServicePrice', service.price ?? 0);
                setFieldValue('editServiceCategory', service.category_id);
                setCheckboxValue('editServiceActive', service.is_active);

                // Update form action dynamically
                const editForm = document.getElementById('editServiceForm');
                if (editForm) {
                    editForm.action = `/services/${service.id}/edit`;
                } else {
                    console.error('Edit form element not found.');
                }

                console.log('Edit form populated successfully');
            }, 150); // A small delay to allow the modal to transition
        })
        .catch(error => {
            console.error('Error in editService:', error);
            alert('Error loading service data: ' + (error.message || 'Unknown error'));
        });
}

// Handle the submission of the edit service form
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"], [title]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    const editForm = document.getElementById('editServiceForm');
    if (editForm) {
        editForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const serviceId = document.getElementById('editServiceId').value;

            const formData = new FormData(this);

            fetch(`/services/${serviceId}/edit`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editServiceModal'));
                    modal.hide();
                    showNotification('Service updated successfully', 'success');
                    location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating the service');
            });
        });
    }

    // Initial data load when the page is ready
    loadServicesData();
});

// Toggle service active status
function toggleService(serviceId) {
    if (!serviceId) {
        alert('Invalid service ID');
        return;
    }

    console.log('Toggling service:', serviceId);

    fetch(`/services/${serviceId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Toggle response:', data);
        if (data.success) {
            showNotification(data.message, 'success');
            location.reload();
        } else {
            alert('Error: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred: ' + error.message);
    });
}

// Delete a service
function deleteService(serviceId) {
    if (!serviceId) {
        alert('Invalid service ID');
        return;
    }

    if (confirm('Are you sure you want to delete this service? This action cannot be undone.')) {
        console.log('Deleting service:', serviceId);

        fetch(`/services/${serviceId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Delete response:', data);
            if (data.success) {
                showNotification(data.message || 'Service deleted successfully', 'success');
                location.reload();
            } else {
                alert('Error: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred: ' + error.message);
        });
    }
}

// Fetch and populate the edit category modal
function editCategory(categoryId) {
    fetch(`/api/categories/${categoryId}`)
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
            return;
        }

        document.getElementById('editCategoryDisplayName').value = data.display_name || '';
        document.getElementById('editCategoryDescription').value = data.description || '';
        document.getElementById('editCategoryColor').value = data.color || '#007bff';
        document.getElementById('editCategorySortOrder').value = data.sort_order || 0;
        document.getElementById('editCategoryIsActive').checked = data.is_active;

        document.getElementById('editCategoryForm').action = `/service-categories/${categoryId}/edit`;

        new bootstrap.Modal(document.getElementById('editCategoryModal')).show();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while fetching category data');
    });
}

// Toggle category active status
function toggleCategory(categoryId) {
    fetch(`/service-categories/${categoryId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showNotification('Category status updated', 'success');
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred');
    });
}

// Delete a category
function deleteCategory(categoryId) {
    if (confirm('Are you sure you want to delete this category? This action cannot be undone.')) {
        fetch(`/service-categories/${categoryId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showNotification('Category deleted', 'success');
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred');
        });
    }
}
</script>

{% endblock %}