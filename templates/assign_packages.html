{% extends 'base.html' %}
{% block title %}Assign Package with Payment{% endblock %}

{% block content %}
<div class="container-fluid">
    <ul class="nav nav-tabs mb-3" id="assignTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-assign-tab" data-bs-toggle="tab" data-bs-target="#tab-assign" type="button" role="tab">
                <i class="fas fa-receipt me-1"></i> Assign & Collect Payment
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-assigned-tab" data-bs-toggle="tab" data-bs-target="#tab-assigned" type="button" role="tab">
                <i class="fas fa-clipboard-list me-1"></i> Assigned Packages
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-assign" role="tabpanel">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4><i class="fas fa-box-open"></i> Assign Package & Collect Payment</h4>
                        </div>
                        <div class="card-body">

                            <div class="form-group mb-3">
                                <label for="customerId">Customer *</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="customerSearch" class="form-control" placeholder="Search by name or phone...">
                                </div>
                                <select id="customerId" class="form-control mt-2" required>
                                    <option value="">Select Customer...</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}" data-phone="{{ customer.phone }}" data-email="{{ customer.email }}">
                                        {{ customer.name }} ({{ customer.phone }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="packageType">Package Type *</label>
                                <select id="packageType" class="form-control" required>
                                    <option value="">Select Package Type...</option>
                                    <option value="prepaid">Prepaid Package</option>
                                    <option value="service_package">Service Package</option>
                                    <option value="membership">Membership</option>
                                    <option value="student_offer">Student Offer</option>
                                    <option value="yearly">Yearly Membership</option>
                                    <option value="kitty">Kitty Party</option>
                                </select>
                            </div>

                            <div class="form-group" id="packageSelectGroup" style="display:none;">
                                <label for="packageId">Select Package *</label>
                                <select id="packageId" class="form-control">
                                    <option value="">Select Package...</option>
                                </select>
                            </div>

                            <div class="form-group" id="serviceSelectGroup" style="display:none;">
                                <label for="serviceId">Select Service *</label>
                                <select id="serviceId" class="form-control">
                                    <option value="">Select Service...</option>
                                    {% for service in services %}
                                    <option value="{{ service.id }}" data-price="{{ service.price }}">
                                        {{ service.name }} - ₹{{ service.price }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="expiresOn">Expiry Date</label>
                                <input type="date" id="expiresOn" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="notes">Notes</label>
                                <textarea id="notes" class="form-control" rows="2"></textarea>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5>Payment Summary</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <td>Package Price (incl. GST):</td>
                                    <td class="text-right" id="displaySubtotal">₹0.00</td>
                                </tr>
                                <tr class="text-muted">
                                    <td>&nbsp;&nbsp;└ Net Price (excl. GST):</td>
                                    <td class="text-right" id="displayNetPrice">₹0.00</td>
                                </tr>
                                <tr class="text-muted">
                                    <td>&nbsp;&nbsp;└ GST Amount (18%):</td>
                                    <td class="text-right" id="displayTax">₹0.00</td>
                                </tr>
                                <tr>
                                    <td>Discount:</td>
                                    <td class="text-right text-danger" id="displayDiscount">₹0.00</td>
                                </tr>
                                <tr class="font-weight-bold border-top">
                                    <td>Grand Total:</td>
                                    <td class="text-right text-success" id="displayGrandTotal">₹0.00</td>
                                </tr>
                            </table>

                            <hr>

                            <h6>Payment Details</h6>

                            <div class="form-group">
                                <label>Payment Method *</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="methodCash" value="cash" checked>
                                        <label class="form-check-label" for="methodCash">Cash</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="methodCard" value="card">
                                        <label class="form-check-label" for="methodCard">Card</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="methodUPI" value="upi">
                                        <label class="form-check-label" for="methodUPI">UPI</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="methodWallet" value="wallet">
                                        <label class="form-check-label" for="methodWallet">Wallet</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="paymentAmount">Amount *</label>
                                <input type="number" id="paymentAmount" class="form-control" step="0.01" min="0" value="0">
                            </div>

                            <div class="form-group">
                                <label for="paymentReference">Reference (Optional)</label>
                                <input type="text" id="paymentReference" class="form-control" placeholder="UPI ID, Last 4 digits, etc.">
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="generateReceipt" checked>
                                <label class="form-check-label" for="generateReceipt">
                                    Generate Receipt (PDF)
                                </label>
                            </div>

                            <button type="button" id="btnAssignAndPay" class="btn btn-primary btn-lg btn-block" disabled>
                                <i class="fas fa-check-circle"></i> Assign & Collect Payment
                            </button>

                            <div id="statusMessage" class="mt-3" style="display:none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-assigned" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex flex-wrap align-items-center justify-content-between">
                        <h5 class="mb-2 mb-md-0"><i class="fas fa-clipboard-list me-2"></i>Assigned Packages</h5>
                        <div class="input-group" style="max-width:360px;">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input id="apSearch" class="form-control" placeholder="Search customer / phone / package">
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" id="packageTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-package-type="" type="button">
                                <i class="fas fa-th-large me-1"></i>All Types
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="prepaid" type="button">
                                <i class="fas fa-wallet me-1"></i>Prepaid
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="service_package" type="button">
                                <i class="fas fa-spa me-1"></i>Service Package
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="membership" type="button">
                                <i class="fas fa-id-card me-1"></i>Membership
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="student_offer" type="button">
                                <i class="fas fa-graduation-cap me-1"></i>Student Offer
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="yearly" type="button">
                                <i class="fas fa-calendar-alt me-1"></i>Yearly
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="kitty" type="button">
                                <i class="fas fa-users me-1"></i>Kitty Party
                            </button>
                        </li>
                    </ul>

                    <ul class="nav nav-pills mb-3" id="statusPills">
                        <li class="nav-item"><button class="nav-link active" data-status="">All</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="active">Active</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="expiring" data-expiring="30">Expiring (30d)</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="completed">Completed</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="expired">Expired</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="paused">Paused</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="pending">Pending</button></li>
                    </ul>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="apTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Customer</th>
                                    <th>Package</th>
                                    <th>Assigned</th>
                                    <th>Expires</th>
                                    <th>Status</th>
                                    <th>Balance</th>
                                    <th>Paid / Savings</th>
                                    <th>Last Used</th>
                                    <th style="width:140px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="apInfo" class="small text-muted"></div>
                        <nav><ul class="pagination pagination-sm mb-0" id="apPager"></ul></nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="apUsageModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-history me-2"></i>Usage History</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div id="apUsageSummary" class="mb-3"></div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead><tr>
                        <th>Date</th><th>Service</th><th>Type</th><th>Sessions</th><th>Amount</th><th>Invoice</th><th>User</th><th>Notes</th>
                    </tr></thead>
                    <tbody id="apUsageRows"></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
    </div></div>
</div>

<style>
        .customer-search {
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 10px;
            font-size: 14px;
        }

        .customer-search:focus {
            outline: none;
            border-color: #45a049;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        .package-card {
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }
</style>

<script>
const packages = {
    prepaid: {{ prepaid_packages | tojson }},
    service_package: {{ service_packages | tojson }},
    membership: {{ memberships | tojson }},
    student_offer: {{ student_offers | tojson }},
    yearly: {{ yearly_memberships | tojson }},
    kitty: {{ kitty_parties | tojson }}
};

let currentPackage = null;
let currentService = null;

document.getElementById('packageType').addEventListener('change', function() {
    const type = this.value;
    const packageSelect = document.getElementById('packageId');
    const packageGroup = document.getElementById('packageSelectGroup');
    const serviceGroup = document.getElementById('serviceSelectGroup');

    packageSelect.innerHTML = '<option value="">Select Package...</option>';

    if (type && packages[type]) {
        packages[type].forEach(pkg => {
            const option = document.createElement('option');
            option.value = pkg.id;
            option.textContent = `${pkg.name} - ₹${pkg.price || pkg.actual_price || 0}`;
            option.dataset.package = JSON.stringify(pkg);
            packageSelect.appendChild(option);
        });
        packageGroup.style.display = 'block';
    } else {
        packageGroup.style.display = 'none';
    }

    serviceGroup.style.display = (type === 'service_package') ? 'block' : 'none';
    recalculateTotals();
});

document.getElementById('packageId').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    currentPackage = option.dataset.package ? JSON.parse(option.dataset.package) : null;
    recalculateTotals();
    validateForm();
});

document.getElementById('serviceId').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    currentService = option.value ? {
        id: option.value,
        price: parseFloat(option.dataset.price || 0)
    } : null;
    recalculateTotals();
});

document.getElementById('customerId').addEventListener('change', validateForm);

// Customer search functionality
document.getElementById('customerSearch').addEventListener('input', function() {
    const searchValue = this.value.toLowerCase().trim();
    const customerSelect = document.getElementById('customerId');
    const options = customerSelect.querySelectorAll('option');

    options.forEach(option => {
        if (option.value === '') {
            option.style.display = 'block';
            return;
        }

        const phone = option.getAttribute('data-phone') || '';
        const name = option.textContent.toLowerCase();

        if (phone.includes(searchValue) || name.includes(searchValue)) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });

    // Auto-select if only one match
    const visibleOptions = Array.from(options).filter(opt => opt.value !== '' && opt.style.display !== 'none');
    if (visibleOptions.length === 1) {
        customerSelect.value = visibleOptions[0].value;
        validateForm();
    }
});


function recalculateTotals() {
    let subtotal = 0;
    let discount = 0;

    if (currentPackage) {
        const packageType = document.getElementById('packageType').value;

        if (packageType === 'prepaid') {
            subtotal = currentPackage.actual_price || 0;
        } else if (packageType === 'service_package' && currentService) {
            const payFor = currentPackage.pay_for || 0;
            const free = currentPackage.free_sessions || 0;
            subtotal = payFor * currentService.price;
            discount = free * currentService.price;
        } else if (packageType === 'student_offer') {
            // Student offers have a price of 0 in the `packages` data,
            // but the actual price might be stored elsewhere or handled by backend.
            // For now, we assume they are free or handled by backend logic.
            // If a specific price needs to be displayed, it would need to be fetched or calculated.
            subtotal = 0; // Student offers are typically free or heavily discounted.
            discount = 0; // No explicit discount to show here.
        }
        else {
            subtotal = currentPackage.price || currentPackage.actual_price || 0;
        }
    }

    const taxable = Math.max(subtotal - discount, 0);
    const tax = taxable * 0.18;
    const grandTotal = taxable + tax;

    const netPrice = taxable; // Net price is the subtotal after discount but before tax
    const gstAmount = tax;

    document.getElementById('displaySubtotal').textContent = `₹${grandTotal.toFixed(2)}`; // Displaying total incl GST here as per the user's example
    document.getElementById('displayNetPrice').textContent = `₹${netPrice.toFixed(2)}`;
    document.getElementById('displayTax').textContent = `₹${gstAmount.toFixed(2)}`;
    document.getElementById('displayDiscount').textContent = `₹${discount.toFixed(2)}`;
    document.getElementById('displayGrandTotal').textContent = `₹${grandTotal.toFixed(2)}`;
    document.getElementById('paymentAmount').value = grandTotal.toFixed(2);
}

function validateForm() {
    const customerId = document.getElementById('customerId').value;
    const packageType = document.getElementById('packageType').value;
    let packageId = document.getElementById('packageId').value;
    const serviceId = document.getElementById('serviceId').value;

    let isValid = customerId && packageType;

    if (packageType === 'student_offer') {
        // For student offers, we don't necessarily need a specific packageId from the dropdown
        // if it's handled as a distinct type. However, if there are different *types* of student offers
        // that need selection, this logic might need adjustment.
        // For now, assuming selecting "Student Offer" is enough to proceed if other fields are valid.
        // If a specific student offer *must* be selected, uncomment the next line:
        // isValid = isValid && packageId;
    } else {
        isValid = isValid && packageId;
    }


    if (packageType === 'service_package') {
        isValid = isValid && serviceId;
    }

    const btn = document.getElementById('btnAssignAndPay');
    if (btn) {
        btn.disabled = !isValid;
        console.log('Validation:', { customerId, packageType, packageId, serviceId, isValid });
    }
}

// Add event listeners
document.getElementById('customerId').addEventListener('change', validateForm);
document.getElementById('packageType').addEventListener('change', validateForm);
document.getElementById('packageId').addEventListener('change', validateForm);
document.getElementById('serviceId').addEventListener('change', validateForm);

// Validate on page load in case values are pre-filled
document.addEventListener('DOMContentLoaded', function() {
    validateForm();
});

document.getElementById('btnAssignAndPay').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

    const statusDiv = document.getElementById('statusMessage');
    statusDiv.style.display = 'none';

    const customerId = document.getElementById('customerId').value;
    const packageType = document.getElementById('packageType').value;
    const packageId = document.getElementById('packageId').value;
    const serviceId = document.getElementById('serviceId').value;
    const expiresOn = document.getElementById('expiresOn').value;
    const notes = document.getElementById('notes').value;
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
    const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
    const paymentReference = document.getElementById('paymentReference').value;
    const generateReceipt = document.getElementById('generateReceipt').checked;

    const grandTotal = parseFloat(document.getElementById('displayGrandTotal').textContent.replace('₹', ''));
    const discount = parseFloat(document.getElementById('displayDiscount').textContent.replace('₹', ''));
    const netPrice = parseFloat(document.getElementById('displayNetPrice').textContent.replace('₹', ''));
    const gstAmount = parseFloat(document.getElementById('displayTax').textContent.replace('₹', ''));

    const payload = {
        assignment: {
            customer_id: parseInt(customerId),
            package_type: packageType,
            // For student offers, package_id might not be directly applicable if it's a general type.
            // Backend should handle this, potentially by not requiring package_id for student_offer type.
            package_id: (packageType === 'student_offer' && !packageId) ? null : parseInt(packageId),
            service_id: serviceId ? parseInt(serviceId) : null,
            price_paid: grandTotal,
            discount: discount,
            expires_on: expiresOn || null,
            notes: notes,
            // Include net price and GST amount for clarity in backend if needed
            net_price: netPrice,
            gst_amount: gstAmount
        },
        payment: {
            collect: true,
            method: paymentMethod,
            amount: paymentAmount,
            reference: paymentReference
        },
        invoice: {
            create: true,
            tax_rate: 18.0,
            rounding: 'nearest'
        },
        receipt: {
            generate: generateReceipt,
            pdf: true
        }
    };

    try {
        const response = await fetch('/packages/api/assign-and-pay', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Idempotency-Key': generateUUID()
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.success) {
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = `
                <h6>Success!</h6>
                <p>Package assigned and payment collected successfully.</p>
                ${result.receipt_url ? `
                    <a href="${result.receipt_url}" target="_blank" class="btn btn-sm btn-primary">
                        <i class="fas fa-print"></i> View Receipt
                    </a>
                ` : ''}
            `;
            statusDiv.style.display = 'block';

            if (result.receipt_url) {
                window.open(result.receipt_url, '_blank');
            }

            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            throw new Error(result.error || 'Unknown error');
        }
    } catch (error) {
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
        statusDiv.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Assign & Collect Payment';
    }
});

function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

const S = { loaded:false, page:1, per:20, q:'', status:'', expiring:'', packageType:'', sort:'expires_on:asc' };

const $ = (id) => document.getElementById(id);
const fmtMoney = n => '₹' + (n||0).toLocaleString(undefined,{maximumFractionDigits:0});
const fmtDate = s => { if(!s) return '—'; const d=new Date(s); return d.toLocaleDateString()+' '+d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); };
const badge = (t,c) => `<span class="badge ${c}">${t}</span>`;
const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };

document.addEventListener('shown.bs.tab', (e)=>{
    if(e.target.id === 'tab-assigned-tab' && !S.loaded){
        S.loaded = true;
        hookAssignedUI();
        fetchAssignments();
    }
});

function hookAssignedUI(){
    document.querySelectorAll('#packageTypeTabs .nav-link').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            document.querySelectorAll('#packageTypeTabs .nav-link').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            S.page=1;
            S.packageType = btn.getAttribute('data-package-type')||'';
            fetchAssignments();
        });
    });

    document.querySelectorAll('#statusPills .nav-link').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            document.querySelectorAll('#statusPills .nav-link').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            S.page=1; S.expiring=''; S.status='';
            const st = btn.getAttribute('data-status')||'';
            const ex = btn.getAttribute('data-expiring')||'';
            if(st==='expiring') { S.expiring = ex||'30'; } else { S.status = st; }
            fetchAssignments();
        });
    });
    $('apSearch').addEventListener('input', debounce(()=>{
        S.q = $('apSearch').value.trim(); S.page=1; fetchAssignments();
    }, 350));
}

function fetchAssignments(){
    const p = new URLSearchParams({
        q: S.q, status: (S.status==='expiring'?'':S.status), expiring_in: S.expiring,
        package_type: S.packageType, page: S.page, per_page: S.per, sort: S.sort
    }).toString();
    fetch(`/packages/api/assignments?${p}`)
        .then(r=>r.json())
        .then(j=>{
            if(!j.success){ alert(j.error||'Failed to load assignments'); return; }
            renderRows(j.items||[]);
            renderPager(j.page, j.per_page, j.total);
        })
        .catch(()=>alert('Error loading assignments'));
}

function renderRows(items){
    const tb = document.querySelector('#apTable tbody');
    tb.innerHTML = '';
    if(!items.length){ tb.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4">No assignments</td></tr>`; return; }

    items.forEach(x=>{
        const statusCls = {
            active:'bg-success', pending:'bg-warning', paused:'bg-secondary',
            completed:'bg-primary', expired:'bg-danger'
        }[x.status] || 'bg-light text-dark';

        let balanceHtml = '';
        if(x.package.type==='service_package' && x.sessions){
            const total = x.sessions.total || 0;
            const used = x.sessions.used || 0;
            const remaining = x.sessions.remaining || total;
            const pct = total > 0 ? Math.min(100, Math.round((used / total)*100)) : 0;
            balanceHtml = `
                <div class="small"><strong>${used}/${total}</strong> used</div>
                <div class="progress" style="height:6px;"><div class="progress-bar bg-success" style="width:${pct}%"></div></div>
                <div class="small text-muted">${remaining} remaining</div>`;
        } else if(x.package.type==='prepaid' && x.credit){
            const total = x.credit.total || 0;
            const used = x.credit.used || 0;
            const remaining = x.credit.remaining || total;
            balanceHtml = `
                <div class="small"><strong>${fmtMoney(remaining)}</strong> / ${fmtMoney(total)}</div>
                <div class="small text-success">Used: ${fmtMoney(used)}</div>`;
        } else {
            balanceHtml = `<span class="text-muted">Unlimited</span>`;
        }

        const expChip = x.expires_on
            ? (x.expiring_in_days<0 ? badge('Expired','bg-danger') : badge(`${x.expiring_in_days} days`,'bg-info'))
            : '<span class="text-muted">—</span>';

        const savings = (x.savings_to_date && x.savings_to_date>0) ? `<div class="small text-success">Saved ${fmtMoney(x.savings_to_date)}</div>` : '';

        tb.insertAdjacentHTML('beforeend', `
            <tr>
                <td><strong>${x.customer.name}</strong><br><small class="text-muted">${x.customer.phone||''}</small></td>
                <td>
                    ${x.package.name} <span class="badge bg-light text-dark ms-1">${x.package.type}</span>
                    ${x.package.service_name ? `<div class="small text-muted">Service: ${x.package.service_name}</div>`:''}
                </td>
                <td>${fmtDate(x.assigned_on)}</td>
                <td>${x.expires_on||'—'}<br>${expChip}</td>
                <td>${badge(x.status, statusCls)}</td>
                <td>${balanceHtml}</td>
                <td>${fmtMoney(x.price_paid||0)}${savings}</td>
                <td>${fmtDate(x.last_used_at)||'—'}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" title="Usage" onclick="AP_openUsage(${x.id})"><i class="fas fa-history"></i></button>
                        <a class="btn btn-outline-secondary" title="Receipt" href="/receipts/${x.id}" target="_blank">
                            <i class="fas fa-file-invoice"></i>
                        </a>
                    </div>
                </td>
            </tr>
        `);
    });
}

function renderPager(page, per, total){
    const pg = $('apPager'); const info = $('apInfo');
    info.textContent = total ? `Showing ${(page-1)*per+1}–${Math.min(page*per,total)} of ${total}` : 'No results';
    pg.innerHTML = '';
    const pages = Math.max(1, Math.ceil(total/per));
    const mk = (p,txt,dis=false,act=false)=>`<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
        <a class="page-link" href="#" onclick="AP_goto(${p});return false;">${txt}</a></li>`;
    pg.insertAdjacentHTML('beforeend', mk(Math.max(1,page-1),'«', page<=1));
    for(let i=Math.max(1,page-2); i<=Math.min(pages,page+2); i++) pg.insertAdjacentHTML('beforeend', mk(i, i, false, i===page));
    pg.insertAdjacentHTML('beforeend', mk(Math.min(pages,page+1),'»', page>=pages));
}

window.AP_goto = (p)=>{ S.page=p; fetchAssignments(); };
window.AP_openUsage = (assignmentId)=>{
    fetch(`/packages/api/assignments/${assignmentId}/usage`)
        .then(r=>r.json()).then(j=>{
            if(!j.success){ alert('Failed to load usage'); return; }
            const s = j.summary||{};
            $('apUsageSummary').innerHTML = `
                <div class="row g-2">
                    <div class="col"><div class="card card-body py-2">Sessions Used: <strong>${s.sessions_used||0}</strong></div></div>
                    <div class="col"><div class="card card-body py-2">Sessions Left: <strong>${s.sessions_remaining||0}</strong></div></div>
                    <div class="col"><div class="card card-body py-2">Credit Used: <strong>${fmtMoney(s.credit_used||0)}</strong></div></div>
                    <div class="col"><div class="card card-body py-2">Credit Left: <strong>${fmtMoney(s.credit_remaining||0)}</strong></div></div>
                </div>`;
            const tbody = $('apUsageRows');
            tbody.innerHTML = '';
            (j.usage||[]).forEach(u=>{
                tbody.insertAdjacentHTML('beforeend',`<tr>
                    <td>${fmtDate(u.date)}</td>
                    <td>${u.service}</td>
                    <td><span class="badge bg-secondary">${u.type}</span></td>
                    <td>${u.sessions||0}</td>
                    <td>${fmtMoney(u.amount||0)}</td>
                    <td>${u.invoice_id||'—'}</td>
                    <td>${u.user||'—'}</td>
                    <td>${u.notes||'—'}</td>
                </tr>`);
            });
            new bootstrap.Modal($('apUsageModal')).show();
        })
        .catch(()=>alert('Error loading usage'));
};

function updatePaymentSummary() {
    const packageType = document.getElementById('packageType').value; // Corrected ID
    const packageSelect = document.getElementById('packageId'); // Corrected ID
    const discountInput = document.getElementById('assign_discount'); // Assuming this ID is correct from context
    const pricePaidInput = document.getElementById('assign_price_paid'); // Assuming this ID is correct from context
    const paymentMethodSelect = document.getElementById('assign_payment_method'); // Assuming this ID is correct from context

    // Add null checks for all required elements
    if (!packageSelect || !discountInput || !pricePaidInput || !paymentMethodSelect) {
        console.log('Payment summary update skipped - missing required elements');
        return;
    }

    const selectedOption = packageSelect.selectedOptions[0];
    let packagePrice = 0;

    if (packageType === 'student_offer') {
        packagePrice = 0; // Student offers are typically free or handled differently
    } else if (selectedOption) {
        packagePrice = parseFloat(selectedOption.dataset.price || 0);
    }


    const discount = parseFloat(discountInput.value || 0);
    const finalPrice = Math.max(0, packagePrice - discount);

    pricePaidInput.value = finalPrice.toFixed(2);
}

function handlePaymentStatusChange() {
    const paymentStatusElement = document.getElementById('asPaymentStatus'); // Assuming this ID is correct from context
    const amountPaidInput = document.getElementById('asAmountPaid'); // Assuming this ID is correct from context
    const amountPaidSection = document.getElementById('asAmountPaidSection'); // Assuming this ID is correct from context
    const summaryTotalElement = document.getElementById('summaryTotal'); // Assuming this ID is correct from context

    if (!paymentStatusElement || !amountPaidInput || !amountPaidSection) {
        return;
    }

    const paymentStatus = paymentStatusElement.value;

    if (paymentStatus === 'paid' || paymentStatus === 'pending') {
        const totalPayable = summaryTotalElement
            ? parseFloat(summaryTotalElement.textContent.replace('₹', '')) || 0
            : 0;
        amountPaidInput.value = totalPayable.toFixed(2);
        amountPaidInput.readOnly = true;
        amountPaidSection.style.display = 'block';
    } else if (paymentStatus === 'partial') {
        amountPaidInput.readOnly = false;
        amountPaidInput.value = parseFloat(amountPaidInput.value) || 0;
        amountPaidSection.style.display = 'block';
    } else {
        amountPaidSection.style.display = 'none';
    }
    updatePaymentSummary();
}

// Initial call to set the summary on page load
document.addEventListener('DOMContentLoaded', () => {
    validateForm(); // Ensure form is validated on load
    updatePaymentSummary();
    handlePaymentStatusChange(); // Also handle initial payment status display
});
</script>
{% endblock %}