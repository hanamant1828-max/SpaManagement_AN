{% extends 'base.html' %}
{% block title %}Assign Package with Payment{% endblock %}

{% block extra_css %}
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
{% endblock %}

{% block extra_js %}
<!-- Ensure jQuery is loaded first (should be in base.html) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <ul class="nav nav-tabs mb-3" id="assignTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-assign-tab" data-bs-toggle="tab" data-bs-target="#tab-assign" type="button" role="tab">
                <i class="fas fa-receipt me-1"></i> Assign & Collect Payment
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-assigned-tab" data-bs-toggle="tab" data-bs-target="#tab-assigned" type="button" role="tab">
                <i class="fas fa-clipboard-list me-1"></i> Assigned Packages
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-assign" role="tabpanel">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h4><i class="fas fa-box-open"></i> Assign Package & Collect Payment</h4>
                        </div>
                        <div class="card-body">

                            <div class="form-group">
                                <label class="form-label required">Customer</label>
                                <select class="form-select" id="customerId" name="customerId" required>
                                    <option value="">Select Customer...</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}" 
                                            {% if selected_customer_id and customer.id == selected_customer_id %}selected{% endif %}
                                            data-phone="{{ customer.phone }}">
                                        {{ customer.first_name }} {{ customer.last_name }} - {{ customer.phone }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if selected_customer_id %}
                                <small class="text-success mt-1 d-block">
                                    <i class="fas fa-check-circle"></i> Customer pre-selected from appointment
                                </small>
                                {% endif %}
                            </div>

                            <div class="form-group">
                                <label for="packageType">Package Type *</label>
                                <select id="packageType" class="form-control" required>
                                    <option value="">Select Package Type...</option>
                                    <option value="prepaid" {% if selected_package_type == 'prepaid' %}selected{% endif %}>Prepaid Package</option>
                                    <option value="service_package" {% if selected_package_type == 'service_package' %}selected{% endif %}>Service Package</option>
                                    <option value="membership" {% if selected_package_type == 'membership' %}selected{% endif %}>Membership</option>
                                    <option value="student_offer" {% if selected_package_type == 'student_offer' %}selected{% endif %}>Student Offer</option>
                                    <option value="yearly" {% if selected_package_type == 'yearly' %}selected{% endif %}>Yearly Membership</option>
                                    <option value="kitty" {% if selected_package_type == 'kitty' %}selected{% endif %}>Kitty Party</option>
                                </select>
                            </div>

                            <div class="form-group" id="packageSelectGroup" style="display:none;">
                                <label for="packageId">Select Package *</label>
                                <select id="packageId" class="form-control">
                                    <option value="">Select Package...</option>
                                </select>
                            </div>

                            <div class="form-group" id="serviceSelectGroup" style="display:none;">
                                <label for="serviceId">Select Service *</label>
                                <select id="serviceId" class="form-control">
                                    <option value="">Select Service...</option>
                                    {% for service in services %}
                                    <option value="{{ service.id }}" data-price="{{ service.price }}">
                                        {{ service.name }} - ‚Çπ{{ service.price }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="expiresOn">Expiry Date</label>
                                <input type="date" id="expiresOn" class="form-control">
                            </div>

                            <div class="form-group">
                                <label for="notes">Notes</label>
                                <textarea id="notes" class="form-control" rows="2"></textarea>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5>Payment Summary</h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm">
                                <tr>
                                    <td>Package Price:</td>
                                    <td class="text-right" id="displaySubtotal">‚Çπ0.00</td>
                                </tr>
                                <tr>
                                    <td>Discount:</td>
                                    <td class="text-right text-danger" id="displayDiscount">‚Çπ0.00</td>
                                </tr>
                                <tr>
                                    <td>Net Price:</td>
                                    <td class="text-right" id="displayNetPrice">‚Çπ0.00</td>
                                </tr>
                                <tr>
                                    <td>GST (18%):</td>
                                    <td class="text-right" id="displayGST">‚Çπ0.00</td>
                                </tr>
                                <tr class="font-weight-bold border-top">
                                    <td>Grand Total:</td>
                                    <td class="text-right text-success" id="displayGrandTotal">‚Çπ0.00</td>
                                </tr>
                            </table>

                            <hr>

                            <h6>Payment Details</h6>

                            <div class="form-group">
                                <label>Payment Method *</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="methodCash" value="cash" checked>
                                        <label class="form-check-label" for="methodCash">Cash</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="methodCard" value="card">
                                        <label class="form-check-label" for="methodCard">Card</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="methodUPI" value="upi">
                                        <label class="form-check-label" for="methodUPI">UPI</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="paymentMethod" id="methodWallet" value="wallet">
                                        <label class="form-check-label" for="methodWallet">Wallet</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="paymentAmount">Amount *</label>
                                <input type="number" id="paymentAmount" class="form-control" step="0.01" min="0" value="0">
                            </div>

                            <div class="form-group">
                                <label for="paymentReference">Reference (Optional)</label>
                                <input type="text" id="paymentReference" class="form-control" placeholder="UPI ID, Last 4 digits, etc.">
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="generateReceipt" checked>
                                <label class="form-check-label" for="generateReceipt">
                                    Generate Receipt (PDF)
                                </label>
                            </div>

                            <button type="button" id="btnAssignAndPay" class="btn btn-primary btn-lg btn-block" disabled>
                                <i class="fas fa-check-circle"></i> Assign & Collect Payment
                            </button>

                            <div id="statusMessage" class="mt-3" style="display:none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-assigned" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Assigned Packages</h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" id="packageTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" data-package-type="" type="button">
                                <i class="fas fa-th-large me-1"></i>All Types
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="prepaid" type="button">
                                <i class="fas fa-wallet me-1"></i>Prepaid
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="service_package" type="button">
                                <i class="fas fa-spa me-1"></i>Service Package
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="membership" type="button">
                                <i class="fas fa-id-card me-1"></i>Membership
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="student_offer" type="button">
                                <i class="fas fa-graduation-cap me-1"></i>Student Offer
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="yearly" type="button">
                                <i class="fas fa-calendar-alt me-1"></i>Yearly
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" data-package-type="kitty" type="button">
                                <i class="fas fa-users me-1"></i>Kitty Party
                            </button>
                        </li>
                    </ul>

                    <ul class="nav nav-pills mb-3" id="statusPills">
                        <li class="nav-item"><button class="nav-link active" data-status="">All</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="active">Active</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="expiring" data-expiring="30">Expiring (30d)</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="completed">Completed</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="expired">Expired</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="paused">Paused</button></li>
                        <li class="nav-item"><button class="nav-link" data-status="pending">Pending</button></li>
                    </ul>

                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="apTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Customer</th>
                                    <th>Package</th>
                                    <th>Assigned</th>
                                    <th>Expires</th>
                                    <th>Status</th>
                                    <th>Balance</th>
                                    <th>Paid / Savings</th>
                                    <th>Last Used</th>
                                    <th style="width:140px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="apUsageModal" tabindex="-1">
    <div class="modal-dialog modal-lg"><div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-history me-2"></i>Usage History</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <div id="apUsageSummary" class="mb-3"></div>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead><tr>
                        <th>Date</th><th>Service</th><th>Type</th><th>Sessions</th><th>Amount</th><th>Invoice</th><th>User</th><th>Notes</th>
                    </tr></thead>
                    <tbody id="apUsageRows"></tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
    </div></div>
</div>

<style>
        .package-card {
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
        }
</style>

<script>
// ============================================================================
// ASSIGN & COLLECT PAYMENT - JavaScript
// ============================================================================

// Package data from backend
const packages = {
    prepaid: {{ prepaid_packages | tojson }},
    service_package: {{ service_packages | tojson }},
    membership: {{ memberships | tojson }},
    student_offer: {{ student_offers | tojson }},
    yearly: {{ yearly_memberships | tojson }},
    kitty: {{ kitty_parties | tojson }}
};

// State variables
let currentPackage = null;
let currentService = null;

// ============================================================================
// PACKAGE SELECTION HANDLERS
// ============================================================================

// Handle package type change
document.getElementById('packageType').addEventListener('change', function() {
    const type = this.value;
    const packageSelect = document.getElementById('packageId');
    const packageGroup = document.getElementById('packageSelectGroup');
    const serviceGroup = document.getElementById('serviceSelectGroup');

    // Reset dropdown
    packageSelect.innerHTML = '<option value="">Select Package...</option>';

    // Clear current selections
    currentPackage = null;
    currentService = null;

    // Populate package dropdown based on type
    if (type && packages[type]) {
        packages[type].forEach(pkg => {
            const option = document.createElement('option');
            option.value = pkg.id;
            option.textContent = `${pkg.name} - ‚Çπ${pkg.price || pkg.actual_price || 0}`;
            option.dataset.package = JSON.stringify(pkg);
            packageSelect.appendChild(option);
        });
        packageGroup.style.display = 'block';
    } else {
        packageGroup.style.display = 'none';
    }

    // Show/hide service dropdown for service packages
    serviceGroup.style.display = (type === 'service_package') ? 'block' : 'none';

    // Recalculate pricing
    recalculateTotals();
    validateAssignForm();
});

// Handle package selection
document.getElementById('packageId').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    if (option.dataset.package) {
        currentPackage = JSON.parse(option.dataset.package);
    } else {
        currentPackage = null;
    }
    recalculateTotals();
    validateAssignForm();
});

// Handle service selection (for service packages)
document.getElementById('serviceId').addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    currentService = option.value ? {
        id: option.value,
        price: parseFloat(option.dataset.price || 0)
    } : null;
    recalculateTotals();
    validateAssignForm();
});

// Handle customer selection
document.getElementById('customerId').addEventListener('change', validateAssignForm);

// ============================================================================
// PRICE CALCULATION
// ============================================================================

/**
 * Get package price based on package type and data structure
 * Different package types store price in different fields
 */
function getPackagePrice(packageType, packageData) {
    if (!packageData) return 0;

    let price = 0;

    switch(packageType) {
        case 'prepaid':
            // Prepaid: actual_price or price or after_value
            price = parseFloat(packageData.actual_price || packageData.price || packageData.after_value || 0);
            break;

        case 'membership':
            // Membership: price or actual_price or amount
            price = parseFloat(packageData.price || packageData.actual_price || packageData.amount || 0);
            break;

        case 'student_offer':
            // Student offer: price or actual_price (must have price field)
            price = parseFloat(packageData.price || packageData.actual_price || 0);
            console.log('Student offer price:', price, 'from data:', packageData);
            break;

        case 'yearly':
            // Yearly membership: price or actual_price or annual_fee
            price = parseFloat(packageData.price || packageData.actual_price || packageData.annual_fee || 0);
            break;

        case 'kitty':
            // Kitty party: price or actual_price or package_price
            price = parseFloat(packageData.price || packageData.actual_price || packageData.package_price || 0);
            break;

        default:
            // Generic fallback: try common field names
            price = parseFloat(packageData.price || packageData.actual_price || packageData.amount || 0);
    }

    if (price === 0 && packageData) {
        console.warn(`Warning: Package price is 0 for type ${packageType}. Package data:`, packageData);
    }

    return price;
}

function recalculateTotals() {
    let subtotal = 0;
    let discount = 0;
    let netPrice = 0;
    let tax = 0;
    let grandTotal = 0;

    if (currentPackage) {
        const packageType = document.getElementById('packageType').value;

        // GST Calculation Rules (Must Match Backend):
        // 1. Service Packages: 18% GST on net amount (after discount)
        // 2. All Other Packages: NO GST (price is final)

        if (packageType === 'service_package') {
            // Service packages: Calculate price, apply discount, then add 18% GST
            if (currentService) {
                const payFor = parseInt(currentPackage.payFor || 0);
                const free = parseInt(currentPackage.freeServices || 0);
                const servicePrice = parseFloat(currentService.price || 0);

                // Calculate gross and discount
                const pricePerSession = servicePrice;
                const paidSessionsPrice = payFor * pricePerSession;
                const discountAmount = free * pricePerSession;

                // Net price after discount
                netPrice = Math.max(paidSessionsPrice - discountAmount, 0);

                // Apply 18% GST (9% CGST + 9% SGST)
                tax = netPrice * 0.18;
                grandTotal = netPrice + tax;

                subtotal = paidSessionsPrice;
                discount = discountAmount;

                console.log('‚úÖ Service Package (WITH 18% GST):', {
                    packageType,
                    payFor,
                    free,
                    servicePrice,
                    subtotal: subtotal.toFixed(2),
                    discount: discount.toFixed(2),
                    netPrice: netPrice.toFixed(2),
                    gst: tax.toFixed(2),
                    grandTotal: grandTotal.toFixed(2)
                });
            } else {
                console.warn('‚ö†Ô∏è Service package selected but no service chosen yet');
            }
        } else {
            // All other packages: NO GST (prepaid, membership, student_offer, yearly, kitty)
            subtotal = getPackagePrice(packageType, currentPackage);
            netPrice = subtotal;
            tax = 0;  // NO GST
            grandTotal = netPrice;  // Final price = net price (no tax)
            discount = 0;

            console.log(`‚úÖ ${packageType.toUpperCase()} Package (NO GST):`, {
                packageType,
                subtotal: subtotal.toFixed(2),
                netPrice: netPrice.toFixed(2),
                gst: '0.00',
                grandTotal: grandTotal.toFixed(2)
            });
        }
    } else {
        // No package selected yet - reset all values
        console.log('‚ö†Ô∏è No package selected');
    }

    // Update display
    document.getElementById('displaySubtotal').textContent = `‚Çπ${subtotal.toFixed(2)}`;
    document.getElementById('displayDiscount').textContent = `‚Çπ${discount.toFixed(2)}`;
    document.getElementById('displayNetPrice').textContent = `‚Çπ${netPrice.toFixed(2)}`;
    document.getElementById('displayGST').textContent = `‚Çπ${tax.toFixed(2)}`;
    document.getElementById('displayGrandTotal').textContent = `‚Çπ${grandTotal.toFixed(2)}`;

    // Update hidden payment amount field
    document.getElementById('paymentAmount').value = grandTotal.toFixed(2);
}

// ============================================================================
// FORM VALIDATION
// ============================================================================

// Enable assign button when all required fields are filled
function validateAssignForm() {
    const customerSelect = document.getElementById('customerId');
    const customer = customerSelect?.value;
    const packageType = document.getElementById('packageType').value;
    const packageId = document.getElementById('packageId').value;
    const serviceId = document.getElementById('serviceId').value;

    const btn = document.getElementById('btnAssignAndPay');
    if (!btn) return;

    console.log('Validation Check:', {
        customer: customer,
        packageType: packageType,
        packageId: packageId,
        serviceId: serviceId
    });

    // Customer must be selected and not be the placeholder option
    const hasValidCustomer = customer && customer !== '' && customer !== 'Select Customer...';

    // Base validation: must have customer and package type
    let isValid = hasValidCustomer && packageType;

    // Package type specific validation
    if (packageType) {
        // All package types need a package selected
        isValid = isValid && packageId;

        // Service packages ALSO need a service selected
        if (packageType === 'service_package') {
            isValid = isValid && serviceId && serviceId !== '';
        }
    }

    console.log('Form Valid:', isValid);
    btn.disabled = !isValid;
}

// ============================================================================
// INITIALIZATION
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    validateAssignForm();
});

document.getElementById('btnAssignAndPay').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

    const statusDiv = document.getElementById('statusMessage');
    statusDiv.style.display = 'none';

    const customerId = document.getElementById('customerId').value;
    const packageType = document.getElementById('packageType').value;
    const packageId = document.getElementById('packageId').value;
    const serviceId = document.getElementById('serviceId').value;
    const expiresOn = document.getElementById('expiresOn').value;
    const notes = document.getElementById('notes').value;
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
    const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);
    const paymentReference = document.getElementById('paymentReference').value;
    const generateReceipt = document.getElementById('generateReceipt').checked;

    const subtotal = parseFloat(document.getElementById('displaySubtotal').textContent.replace('‚Çπ', ''));
    const grandTotal = parseFloat(document.getElementById('displayGrandTotal').textContent.replace('‚Çπ', ''));
    const discount = parseFloat(document.getElementById('displayDiscount').textContent.replace('‚Çπ', ''));
    const netPrice = parseFloat(document.getElementById('displayNetPrice').textContent.replace('‚Çπ', ''));
    const gstAmount = parseFloat(document.getElementById('displayGST').textContent.replace('‚Çπ', ''));


    const payload = {
        assignment: {
            customer_id: parseInt(customerId),
            package_type: packageType,
            package_id: packageId ? parseInt(packageId) : null,
            service_id: serviceId ? parseInt(serviceId) : null,
            price_paid: grandTotal > 0 ? grandTotal : subtotal, // Use grandTotal or fallback to subtotal
            discount: discount,
            expires_on: expiresOn || null,
            notes: notes,
            // Include net price and GST amount for clarity in backend if needed
            net_price: netPrice > 0 ? netPrice : subtotal,
            gst_amount: gstAmount
        },
        payment: {
            collect: true,
            method: paymentMethod,
            amount: paymentAmount,
            reference: paymentReference
        },
        invoice: {
            create: true,
            tax_rate: 18.0, // Assuming a fixed tax rate for simplicity, adjust if dynamic
            rounding: 'nearest'
        },
        receipt: {
            generate: generateReceipt,
            pdf: true
        }
    };

    try {
        const response = await fetch('/packages/api/assign-and-pay', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Idempotency-Key': generateUUID()
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (result.success) {
            statusDiv.className = 'alert alert-success';
            statusDiv.innerHTML = `
                <h6>Success!</h6>
                <p>Package assigned and payment collected successfully.</p>
                ${result.receipt_url ? `
                    <a href="${result.receipt_url}" target="_blank" class="btn btn-sm btn-primary">
                        <i class="fas fa-print"></i> View Receipt
                    </a>
                ` : ''}
            `;
            statusDiv.style.display = 'block';

            if (result.receipt_url) {
                window.open(result.receipt_url, '_blank');
            }

            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            throw new Error(result.error || 'Unknown error');
        }
    } catch (error) {
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
        statusDiv.style.display = 'block';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Assign & Collect Payment';
    }
});

function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

const S = { loaded:false, status:'', expiring:'', packageType:'' };
let apDataTable = null;

const $ = (id) => document.getElementById(id);
const fmtMoney = n => '‚Çπ' + (n||0).toLocaleString(undefined,{maximumFractionDigits:0});
const fmtDate = s => { if(!s) return '‚Äî'; const d=new Date(s); const day = String(d.getDate()).padStart(2, '0'); const month = String(d.getMonth() + 1).padStart(2, '0'); const year = d.getFullYear(); const hours = d.getHours(); const minutes = String(d.getMinutes()).padStart(2, '0'); const ampm = hours >= 12 ? 'PM' : 'AM'; const hour12 = hours % 12 || 12; return `${day}-${month}-${year} ${hour12}:${minutes} ${ampm}`; };
const badge = (t,c) => `<span class="badge ${c}">${t}</span>`;

document.addEventListener('shown.bs.tab', (e)=>{
    if(e.target.id === 'tab-assigned-tab' && !S.loaded){
        S.loaded = true;
        initAssignedDataTable();
        hookAssignedUI();
        fetchAssignments();
    }
});

function initAssignedDataTable() {
    if (apDataTable) return;
    
    const tableElement = document.getElementById('apTable');
    if (!tableElement) {
        console.warn('Table element #apTable not found, skipping DataTable initialization');
        return;
    }
    
    // Use jQuery if available, otherwise skip
    if (typeof jQuery === 'undefined' || typeof jQuery.fn.DataTable === 'undefined') {
        console.warn('jQuery DataTables not loaded, skipping initialization');
        return;
    }
    
    try {
        apDataTable = $('#apTable').DataTable({
            pageLength: 10,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
            order: [[3, 'asc']],
            language: {
                search: "Search customer / phone / package:",
                lengthMenu: "Show _MENU_ packages per page",
                info: "Showing _START_ to _END_ of _TOTAL_ assigned packages",
                infoEmpty: "No assigned packages available",
                infoFiltered: "(filtered from _MAX_ total packages)",
                zeroRecords: "No matching packages found"
            },
            columnDefs: [
                { orderable: false, targets: -1 }
            ],
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip'
        });
    } catch (error) {
        console.error('Error initializing DataTable:', error);
    }
}

function hookAssignedUI(){
    document.querySelectorAll('#packageTypeTabs .nav-link').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            document.querySelectorAll('#packageTypeTabs .nav-link').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            S.packageType = btn.getAttribute('data-package-type')||'';
            fetchAssignments();
        });
    });

    document.querySelectorAll('#statusPills .nav-link').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            document.querySelectorAll('#statusPills .nav-link').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            S.expiring=''; S.status='';
            const st = btn.getAttribute('data-status')||'';
            const ex = btn.getAttribute('data-expiring')||'';
            if(st==='expiring') { S.expiring = ex||'30'; } else { S.status = st; }
            fetchAssignments();
        });
    });
}

function fetchAssignments(){
    const p = new URLSearchParams({
        q: '', status: (S.status==='expiring'?'':S.status), expiring_in: S.expiring,
        package_type: S.packageType, page: 1, per_page: 1000, sort: 'expires_on:asc'
    }).toString();
    fetch(`/packages/api/assignments?${p}`)
        .then(r=>r.json())
        .then(j=>{
            if(!j.success){ alert(j.error||'Failed to load assignments'); return; }
            renderDataTableRows(j.items||[]);
        })
        .catch(()=>alert('Error loading assignments'));
}

function renderDataTableRows(items){
    if (!apDataTable) return;
    apDataTable.clear();

    items.forEach(x=>{
        const statusCls = {
            active:'bg-success', pending:'bg-warning', paused:'bg-secondary',
            completed:'bg-primary', expired:'bg-danger'
        }[x.status] || 'bg-light text-dark';

        let balanceHtml = '';
        if(x.package.type==='service_package' && x.sessions){
            const total = x.sessions.total || 0;
            const used = x.sessions.used || 0;
            const remaining = x.sessions.remaining || total;
            const pct = total > 0 ? Math.min(100, Math.round((used / total)*100)) : 0;
            balanceHtml = `
                <div class="small"><strong>${used}/${total}</strong> used</div>
                <div class="progress" style="height:6px;"><div class="progress-bar bg-success" style="width:${pct}%"></div></div>
                <div class="small text-muted">${remaining} remaining</div>`;
        } else if(x.package.type==='prepaid' && x.credit){
            const total = x.credit.total || 0;
            const used = x.credit.used || 0;
            const remaining = x.credit.remaining || total;
            balanceHtml = `
                <div class="small"><strong>${fmtMoney(remaining)}</strong> / ${fmtMoney(total)}</div>
                <div class="small text-success">Used: ${fmtMoney(used)}</div>`;
        } else {
            balanceHtml = `<span class="text-muted">Unlimited</span>`;
        }

        const expChip = x.expires_on
            ? (x.expiring_in_days<0 ? badge('Expired','bg-danger') : badge(`${x.expiring_in_days} days`,'bg-info'))
            : '<span class="text-muted">‚Äî</span>';

        const savings = (x.savings_to_date && x.savings_to_date>0) ? `<div class="small text-success">Saved ${fmtMoney(x.savings_to_date)}</div>` : '';

        apDataTable.row.add([
            `<strong>${x.customer.name}</strong><br><small class="text-muted">${x.customer.phone||''}</small>`,
            `${x.package.name} <span class="badge bg-light text-dark ms-1">${x.package.type}</span>
                ${x.package.service_name ? `<div class="small text-muted">Service: ${x.package.service_name}</div>`:''}`,
            fmtDate(x.assigned_on),
            `${x.expires_on||'‚Äî'}<br>${expChip}`,
            badge(x.status, statusCls),
            balanceHtml,
            `${fmtMoney(x.price_paid||0)}${savings}`,
            fmtDate(x.last_used_at)||'‚Äî',
            `<div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" title="Usage" onclick="AP_openUsage(${x.id})"><i class="fas fa-history"></i></button>
                ${x.receipt_id ? `<a class="btn btn-outline-secondary" title="Receipt" href="/receipts/${x.receipt_id}" target="_blank">
                    <i class="fas fa-file-invoice"></i>
                </a>` : '<button class="btn btn-outline-secondary" disabled title="No receipt"><i class="fas fa-file-invoice"></i></button>'}
            </div>`
        ]);
    });

    apDataTable.draw();
}
window.AP_openUsage = (assignmentId)=>{
    fetch(`/packages/api/assignments/${assignmentId}/usage`)
        .then(r=>r.json()).then(j=>{
            if(!j.success){ alert('Failed to load usage'); return; }
            const s = j.summary||{};
            $('apUsageSummary').innerHTML = `
                <div class="row g-2">
                    <div class="col"><div class="card card-body py-2">Sessions Used: <strong>${s.sessions_used||0}</strong></div></div>
                    <div class="col"><div class="card card-body py-2">Sessions Left: <strong>${s.sessions_remaining||0}</strong></div></div>
                    <div class="col"><div class="card card-body py-2">Credit Used: <strong>${fmtMoney(s.credit_used||0)}</strong></div></div>
                    <div class="col"><div class="card card-body py-2">Credit Left: <strong>${fmtMoney(s.credit_remaining||0)}</strong></div></div>
                </div>`;
            const tbody = $('apUsageRows');
            tbody.innerHTML = '';
            (j.usage||[]).forEach(u=>{
                tbody.insertAdjacentHTML('beforeend',`<tr>
                    <td>${fmtDate(u.date)}</td>
                    <td>${u.service}</td>
                    <td><span class="badge bg-secondary">${u.type}</span></td>
                    <td>${u.sessions||0}</td>
                    <td>${fmtMoney(u.amount||0)}</td>
                    <td>${u.invoice_id||'‚Äî'}</td>
                    <td>${u.user||'‚Äî'}</td>
                    <td>${u.notes||'‚Äî'}</td>
                </tr>`);
            });
            new bootstrap.Modal($('apUsageModal')).show();
        })
        .catch(()=>alert('Error loading usage'));
};

function updatePaymentSummary(packagePrice = 0, discount = 0, netPrice = 0) {
    const taxable = Math.max(packagePrice - discount, 0);
    const tax = taxable * 0.18;
    const grandTotal = taxable + tax;

    const displaySubtotal = document.getElementById('displaySubtotal');
    const displayNetPrice = document.getElementById('displayNetPrice');
    const displayTax = document.getElementById('displayGST'); // Corrected ID
    const displayDiscount = document.getElementById('displayDiscount');
    const displayGrandTotal = document.getElementById('displayGrandTotal');
    const paymentAmountInput = document.getElementById('paymentAmount');

    if (displaySubtotal) displaySubtotal.textContent = `‚Çπ${packagePrice.toFixed(2)}`; // Display original package price
    if (displayNetPrice) displayNetPrice.textContent = `‚Çπ${taxable.toFixed(2)}`;
    if (displayTax) displayTax.textContent = `‚Çπ${tax.toFixed(2)}`;
    if (displayDiscount) displayDiscount.textContent = `‚Çπ${discount.toFixed(2)}`;
    if (displayGrandTotal) displayGrandTotal.textContent = `‚Çπ${grandTotal.toFixed(2)}`;
    if (paymentAmountInput) paymentAmountInput.value = grandTotal.toFixed(2);
}

function handlePaymentStatusChange() {
    const paymentStatusElement = document.getElementById('asPaymentStatus'); // Assuming this ID is correct from context
    const amountPaidInput = document.getElementById('asAmountPaid'); // Assuming this ID is correct from context
    const amountPaidSection = document.getElementById('asAmountPaidSection'); // Assuming this ID is correct from context
    const summaryTotalElement = document.getElementById('summaryTotal'); // Assuming this ID is correct from context

    if (!paymentStatusElement || !amountPaidInput || !amountPaidSection) {
        return;
    }

    const paymentStatus = paymentStatusElement.value;

    if (paymentStatus === 'paid' || paymentStatus === 'pending') {
        const totalPayable = summaryTotalElement
            ? parseFloat(summaryTotalElement.textContent.replace('‚Çπ', '')) || 0
            : 0;
        amountPaidInput.value = totalPayable.toFixed(2);
        amountPaidInput.readOnly = true;
        amountPaidSection.style.display = 'block';
    } else if (paymentStatus === 'partial') {
        amountPaidInput.readOnly = false;
        amountPaidInput.value = parseFloat(amountPaidInput.value) || 0;
        amountPaidSection.style.display = 'block';
    } else {
        amountPaidSection.style.display = 'none';
    }
    updatePaymentSummary();
}

// Load customer packages when customer is selected
document.getElementById('customerId').addEventListener('change', function() {
    const customerId = this.value;
    if (customerId) {
        // Assuming loadCustomerPackages function is defined elsewhere or needs to be implemented
        // This function should fetch and populate packages for the given customer
        // For now, this is a placeholder.
        // loadCustomerPackages(customerId);
    } else {
        document.getElementById('packageType').value = ''; // Reset package type
        document.getElementById('packageId').innerHTML = '<option value="">Select Package...</option>'; // Reset package
        document.getElementById('packageSelectGroup').style.display = 'none'; // Hide package selection
        document.getElementById('serviceSelectGroup').style.display = 'none'; // Hide service selection
        recalculateTotals(); // Recalculate totals to reset to 0
    }
});

// Auto-load packages if customer is pre-selected from URL
window.addEventListener('DOMContentLoaded', function() {
    const customerSelect = document.getElementById('customerId');

    // Check if customer_id is in URL parameters (from context menu)
    const urlParams = new URLSearchParams(window.location.search);
    const customerIdFromUrl = urlParams.get('customer_id');

    console.log('üîç URL Parameters:', window.location.search);
    console.log('üîç Customer ID from URL:', customerIdFromUrl);

    function trySelectCustomerFromUrl(customerId, retries = 5) {
        // Wait a bit to ensure options are loaded
        setTimeout(() => {
            console.log('üîç Attempting to select customer:', customerId);
            console.log('üîç Total options available:', customerSelect.options.length);

            // Find the matching option
            let foundOption = null;
            for (let i = 0; i < customerSelect.options.length; i++) {
                const option = customerSelect.options[i];
                if (String(option.value) === String(customerId)) {
                    foundOption = option;
                    break;
                }
            }

            if (foundOption) {
                // Set the customer dropdown to the pre-selected customer
                customerSelect.value = String(customerId);
                console.log('‚úÖ Auto-selected customer from URL:', customerId);
                console.log('‚úÖ Customer name:', foundOption.text);

                // Trigger the change event to load packages and enable package selection
                customerSelect.dispatchEvent(new Event('change', { bubbles: true }));

                // Call validateAssignForm to enable the assign button
                setTimeout(() => {
                    if (typeof validateAssignForm === 'function') {
                        validateAssignForm();
                        console.log('‚úÖ Form validation triggered');
                    }
                }, 100);
                return true;
            } else if (retries > 0) {
                // Retry in case options are loaded asynchronously
                console.log(`‚è≥ Customer option not found yet, retrying... (${retries} attempts left)`);
                trySelectCustomerFromUrl(customerId, retries - 1);
                return false;
            } else {
                console.warn('‚ö†Ô∏è Customer ID not found in dropdown after retries:', customerId);
                console.log('Available customer IDs:', Array.from(customerSelect.options).map(o => ({value: o.value, text: o.text})));
                return false;
            }
        }, retries === 5 ? 200 : 100); // Longer initial delay
    }

    // Use a longer delay to ensure DOM is fully rendered
    setTimeout(() => {
        const currentValue = customerSelect.value;

        console.log('üîç Current customer dropdown value:', currentValue);
        console.log('üîç Selected option text:', customerSelect.options[customerSelect.selectedIndex]?.text || 'None');

        // Check if a customer is already selected (value is not empty and not the placeholder)
        if (currentValue && currentValue !== '' && currentValue !== 'Select Customer...') {
            console.log('‚úÖ Customer already selected by server:', currentValue);
            const selectedOption = customerSelect.options[customerSelect.selectedIndex];
            if (selectedOption) {
                console.log('‚úÖ Customer name:', selectedOption.text);
            }
            // Trigger change event to validate form and load packages
            customerSelect.dispatchEvent(new Event('change', { bubbles: true }));
            // Call validateAssignForm directly to enable the assign button
            setTimeout(() => {
                if (typeof validateAssignForm === 'function') {
                    validateAssignForm();
                }
            }, 100);
        } 
        // If not selected by server, try from URL parameter
        else if (customerIdFromUrl) {
            console.log('üîç Attempting to select customer from URL parameter:', customerIdFromUrl);
            trySelectCustomerFromUrl(customerIdFromUrl);
        } else {
            console.log('‚ÑπÔ∏è No customer pre-selected (neither from server nor URL)');
        }
    }, 300); // Wait 300ms for DOM to be fully ready
});

// Placeholder function for loading customer packages.
// This function would typically make an API call to fetch packages associated with a customer.
function loadCustomerPackages(customerId) {
    console.log(`Loading packages for customer ID: ${customerId}`);
    // Example: fetch(`/api/customer/${customerId}/packages`)
    //          .then(response => response.json())
    //          .then(data => {
    //              // Populate the packageType dropdown and potentially pre-select a package
    //              // based on the customer's history or a parameter from the URL.
    //              console.log('Customer packages loaded:', data);
    //          });
}
</script>
{% endblock %}