{% extends "base.html" %}

{% block title %}Package Management - Spa & Salon Suite{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-box"></i> Package Management</h4>
                    <div>
                        <span class="badge bg-primary">Total: {{ stats.total_packages }}</span>
                    </div>
                </div>
                <div class="card-body">

                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs" id="packageTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="prepaid-tab" data-bs-toggle="tab" data-bs-target="#prepaid" type="button" role="tab">
                                <i class="fas fa-credit-card"></i> Prepaid Packages
                                <span class="badge bg-success ms-1">{{ stats.prepaid_packages }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="service-tab" data-bs-toggle="tab" data-bs-target="#service" type="button" role="tab">
                                <i class="fas fa-spa"></i> Service Packages
                                <span class="badge bg-info ms-1">{{ stats.service_packages }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="membership-tab" data-bs-toggle="tab" data-bs-target="#membership" type="button" role="tab">
                                <i class="fas fa-id-card"></i> Memberships
                                <span class="badge bg-warning ms-1">{{ stats.memberships }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="student-tab" data-bs-toggle="tab" data-bs-target="#student" type="button" role="tab">
                                <i class="fas fa-graduation-cap"></i> Student Offers
                                <span class="badge bg-secondary ms-1">{{ stats.student_offers }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab">
                                <i class="fas fa-calendar-alt"></i> Yearly Memberships
                                <span class="badge bg-dark ms-1">{{ stats.yearly_memberships }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="kitty-tab" data-bs-toggle="tab" data-bs-target="#kitty" type="button" role="tab">
                                <i class="fas fa-users"></i> Kitty Parties
                                <span class="badge bg-danger ms-1">{{ stats.kitty_parties }}</span>
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content mt-3" id="packageTabContent">

                        <!-- Prepaid Packages Tab -->
                        <div class="tab-pane fade show active" id="prepaid" role="tabpanel">
                            <div class="d-flex justify-content-between mb-3">
                                <h5>Prepaid Packages</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#prepaidModal">
                                    <i class="fas fa-plus"></i> Add Prepaid Package
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Pay Amount</th>
                                            <th>Get Value</th>
                                            <th>Benefit %</th>
                                            <th>Validity</th>
                                            <th>Money Saved</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="prepaidTableBody">
                                        {% for package in prepaid_packages %}
                                        <tr>
                                            <td>{{ package.name }}</td>
                                            <td>₹{{ "{:,.0f}".format(package.actual_price) }}</td>
                                            <td>₹{{ "{:,.0f}".format(package.after_value) }}</td>
                                            <td>{{ package.benefit_percent }}%</td>
                                            <td>{{ package.validity_months }} months</td>
                                            <td class="text-success">₹{{ "{:,.0f}".format(package.money_saved) }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="editPrepaid({{ package.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deletePrepaid({{ package.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Service Packages Tab -->
                        <div class="tab-pane fade" id="service" role="tabpanel">
                            <div class="d-flex justify-content-between mb-3">
                                <h5>Service Packages</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#serviceModal">
                                    <i class="fas fa-plus"></i> Add Service Package
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Pay For</th>
                                            <th>Total Services</th>
                                            <th>Free Services</th>
                                            <th>Benefit %</th>
                                            <th>Validity</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="serviceTableBody">
                                        {% for package in service_packages %}
                                        <tr>
                                            <td>
                                                {{ package.name }}
                                                {% if package.service %}
                                                    <small class="text-muted d-block">Service: {{ package.service.name }}</small>
                                                {% endif %}
                                            </td>
                                            <td>{{ package.pay_for }}</td>
                                            <td>{{ package.total_services }}</td>
                                            <td class="text-success">{{ package.free_services }}</td>
                                            <td>{{ package.benefit_percent }}%</td>
                                            <td>{{ package.validity_months }} months</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-success btn-sm" onclick="assignPackage({{ package.id }}, '{{ package.name }}', 'service')" title="Assign Package">
                                                        <i class="fas fa-plus"></i> Assign
                                                    </button>
                                                    <button class="btn btn-outline-primary" onclick="editService({{ package.id }})" title="Edit Package">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteService({{ package.id }})" title="Delete Package">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Memberships Tab -->
                        <div class="tab-pane fade" id="membership" role="tabpanel">
                            <div class="d-flex justify-content-between mb-3">
                                <h5>Memberships</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#membershipModal">
                                    <i class="fas fa-plus"></i> Add Membership
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Price</th>
                                            <th>Validity</th>
                                            <th>Services Included</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="membershipTableBody">
                                        {% for membership in memberships %}
                                        <tr>
                                            <td>{{ membership.name }}</td>
                                            <td>₹{{ "{:,.0f}".format(membership.price) }}</td>
                                            <td>{{ membership.validity_months }} months</td>
                                            <td>{{ membership.services_included[:50] }}...</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="editMembership({{ membership.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteMembership({{ membership.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Student Offers Tab -->
                        <div class="tab-pane fade" id="student" role="tabpanel">
                            <div class="d-flex justify-content-between mb-3">
                                <h5>Student Offers</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#studentModal">
                                    <i class="fas fa-plus"></i> Add Student Offer
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Service</th>
                                            <th>Actual Price</th>
                                            <th>Discount %</th>
                                            <th>After Price</th>
                                            <th>Money Saved</th>
                                            <th>Valid Days</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentTableBody">
                                        {% for offer in student_offers %}
                                        <tr>
                                            <td>{{ offer.service_name }}</td>
                                            <td>₹{{ "{:,.0f}".format(offer.actual_price) }}</td>
                                            <td>{{ offer.discount_percent }}%</td>
                                            <td>₹{{ "{:,.0f}".format(offer.after_price) }}</td>
                                            <td class="text-success">₹{{ "{:,.0f}".format(offer.money_saved) }}</td>
                                            <td>{{ offer.valid_days }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="editStudent({{ offer.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent({{ offer.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Yearly Memberships Tab -->
                        <div class="tab-pane fade" id="yearly" role="tabpanel">
                            <div class="d-flex justify-content-between mb-3">
                                <h5>Yearly Memberships</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#yearlyModal">
                                    <i class="fas fa-plus"></i> Add Yearly Membership
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Price</th>
                                            <th>Discount %</th>
                                            <th>Validity</th>
                                            <th>Extra Benefits</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="yearlyTableBody">
                                        {% for membership in yearly_memberships %}
                                        <tr>
                                            <td>{{ membership.name }}</td>
                                            <td>₹{{ "{:,.0f}".format(membership.price) }}</td>
                                            <td>{{ membership.discount_percent }}%</td>
                                            <td>{{ membership.validity_months }} months</td>
                                            <td>{{ membership.extra_benefits[:30] if membership.extra_benefits else 'None' }}...</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="editYearly({{ membership.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteYearly({{ membership.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Kitty Parties Tab -->
                        <div class="tab-pane fade" id="kitty" role="tabpanel">
                            <div class="d-flex justify-content-between mb-3">
                                <h5>Kitty Parties</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#kittyModal">
                                    <i class="fas fa-plus"></i> Add Kitty Party
                                </button>
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Price</th>
                                            <th>After Value</th>
                                            <th>Min Guests</th>
                                            <th>Services</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="kittyTableBody">
                                        {% for party in kitty_parties %}
                                        <tr>
                                            <td>{{ party.name }}</td>
                                            <td>₹{{ "{:,.0f}".format(party.price) }}</td>
                                            <td>{{ '₹{:,.0f}'.format(party.after_value) if party.after_value else 'N/A' }}</td>
                                            <td>{{ party.min_guests }}</td>
                                            <td>{{ party.services_included[:30] if party.services_included else 'None' }}...</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary" onclick="editKitty({{ party.id }})">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteKitty({{ party.id }})">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals for adding/editing packages would go here -->
<!-- For brevity, showing just one example modal -->

<!-- Prepaid Package Modal -->
<div class="modal fade" id="prepaidModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Prepaid Package</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="prepaidForm">
                    <div class="mb-3">
                        <label class="form-label">Package Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Actual Price (Pay Amount)</label>
                        <input type="number" class="form-control" name="actual_price" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">After Value (Get Amount)</label>
                        <input type="number" class="form-control" name="after_value" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Benefit Percentage</label>
                        <input type="number" class="form-control" name="benefit_percent" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Validity (Months)</label>
                        <input type="number" class="form-control" name="validity_months" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitPrepaidForm()">Save Package</button>
            </div>
        </div>
    </div>
</div>

<!-- Service Package Modal (Example - Add if missing in original or incomplete) -->
<div class="modal fade" id="serviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Service Package</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="serviceForm">
                    <div class="mb-3">
                        <label class="form-label">Package Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Service Selection:</strong> The specific service will be chosen when assigning this package to a customer.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pay For</label>
                        <input type="number" class="form-control" name="pay_for" required min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Total Services</label>
                        <input type="number" class="form-control" name="total_services" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Free Services</label>
                        <input type="number" class="form-control" name="free_services" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Benefit Percentage</label>
                        <input type="number" class="form-control" name="benefit_percent" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Validity (Months)</label>
                        <input type="number" class="form-control" name="validity_months" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitServiceForm()">Save Package</button>
            </div>
        </div>
    </div>
</div>

<!-- Membership Modal (Example) -->
<div class="modal fade" id="membershipModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Membership</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="membershipForm">
                    <div class="mb-3">
                        <label class="form-label">Membership Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Price</label>
                        <input type="number" class="form-control" name="price" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Validity (Months)</label>
                        <input type="number" class="form-control" name="validity_months" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Services Included</label>
                        <textarea class="form-control" name="services_included" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMembershipForm()">Save Membership</button>
            </div>
        </div>
    </div>
</div>

<!-- Student Offer Modal (Example) -->
<div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Student Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <div class="mb-3">
                        <label class="form-label">Select Service</label>
                        <select class="form-select" name="service_id" id="student_service_select" required onchange="updateStudentServicePrice()">
                            <option value="">Choose a service...</option>
                            {% for service in services %}
                                <option value="{{ service.id }}" data-price="{{ service.price }}">{{ service.name }} - ₹{{ service.price }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Actual Price</label>
                        <input type="number" class="form-control" name="actual_price" id="student_actual_price" required readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount Percentage</label>
                        <input type="number" class="form-control" name="discount_percent" required min="0" max="100" onchange="calculateStudentDiscountPrice()">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">After Discount Price</label>
                        <input type="number" class="form-control" name="after_price" id="student_after_price" required readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Valid Days</label>
                        <input type="text" class="form-control" name="valid_days" placeholder="e.g. Mon-Fri" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitStudentForm()">Save Offer</button>
            </div>
        </div>
    </div>
</div>

<!-- Yearly Membership Modal (Example) -->
<div class="modal fade" id="yearlyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Yearly Membership</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="yearlyForm">
                    <div class="mb-3">
                        <label class="form-label">Membership Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Price</label>
                        <input type="number" class="form-control" name="price" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount Percentage</label>
                        <input type="number" class="form-control" name="discount_percent" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Validity (Months)</label>
                        <input type="number" class="form-control" name="validity_months" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Extra Benefits</label>
                        <textarea class="form-control" name="extra_benefits"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitYearlyForm()">Save Membership</button>
            </div>
        </div>
    </div>
</div>

<!-- Kitty Party Modal (Example) -->
<div class="modal fade" id="kittyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Kitty Party</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="kittyForm">
                    <div class="mb-3">
                        <label class="form-label">Party Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Price</label>
                        <input type="number" class="form-control" name="price" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">After Value</label>
                        <input type="number" class="form-control" name="after_value">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimum Guests</label>
                        <input type="number" class="form-control" name="min_guests" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Services Included</label>
                        <select multiple class="form-select" name="service_ids">
                            {% for service in services %}
                                <option value="{{ service.id }}">{{ service.name }} - ₹{{ service.price }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitKittyForm()">Save Party</button>
            </div>
        </div>
    </div>
</div>

<!-- Service Package Assignment Modal -->
<div class="modal fade" id="assignServicePackageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serviceAssignModalTitle">Assign Package: "Package Name"</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignServicePackageForm">
                    <input type="hidden" id="service_assign_package_id">
                    <input type="hidden" id="service_assign_package_type" value="service">
                    
                    <div class="mb-3">
                        <label class="form-label">Customer *</label>
                        <select name="customer_id" id="service_assign_customer_id" class="form-select" required>
                            <option value="">Search / select customer...</option>
                            {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.full_name }} - {{ customer.phone }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Service *</label>
                        <select name="service_id" id="service_assign_service_id" class="form-select" required>
                            <option value="">Choose a service...</option>
                            <!-- Services will be loaded dynamically -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title mb-3">Package Summary</h6>
                                <div class="row mb-3">
                                    <div class="col-4 text-center">
                                        <strong>Pay For:</strong> <span id="summary_pay_for" class="badge bg-primary">-</span>
                                    </div>
                                    <div class="col-4 text-center">
                                        <strong>Free:</strong> <span id="summary_free" class="badge bg-success">-</span>
                                    </div>
                                    <div class="col-4 text-center">
                                        <strong>TOTAL:</strong> <span id="summary_total" class="badge bg-info">-</span>
                                    </div>
                                </div>
                                
                                <!-- Cost Breakdown -->
                                <div class="cost-breakdown" id="cost_breakdown" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="text-muted mb-2">Cost Breakdown</h6>
                                    
                                    <div class="row small">
                                        <div class="col-8">Service Price (per session):</div>
                                        <div class="col-4 text-end" id="service_price_display">₹0</div>
                                    </div>
                                    
                                    <div class="row small">
                                        <div class="col-8">Total Services (<span id="total_sessions_text">4</span> sessions):</div>
                                        <div class="col-4 text-end" id="total_cost_display">₹0</div>
                                    </div>
                                    
                                    <div class="row small text-success">
                                        <div class="col-8">Package Discount (<span id="free_sessions_text">1</span> free session):</div>
                                        <div class="col-4 text-end" id="package_discount_display">-₹0</div>
                                    </div>
                                    
                                    <hr class="my-2">
                                    
                                    <div class="row fw-bold">
                                        <div class="col-8">You Pay (for <span id="paid_sessions_text">3</span> sessions):</div>
                                        <div class="col-4 text-end text-primary" id="final_payment_display">₹0</div>
                                    </div>
                                    
                                    <div class="row small text-success">
                                        <div class="col-8">Total Savings:</div>
                                        <div class="col-4 text-end fw-bold" id="total_savings_display">₹0</div>
                                    </div>
                                    
                                    <div class="row small text-muted mt-2">
                                        <div class="col-12 text-center">
                                            <i class="fas fa-gift me-1"></i>
                                            You get <span id="benefit_percent_display">25%</span> more value!
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Expiry (optional)</label>
                        <input type="date" name="expiry_date" id="service_assign_expiry" class="form-control">
                        <small class="text-muted">Leave empty for standard validity period</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" id="service_assign_notes" class="form-control" rows="3" placeholder="Additional notes about this assignment..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="submitServicePackageAssignment()">Assign Package</button>
            </div>
        </div>
    </div>
</div>

<!-- Regular Package Assignment Modal (for other package types) -->
<div class="modal fade" id="assignPackageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Package to Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignPackageForm">
                    <input type="hidden" id="assign_package_id">
                    <input type="hidden" id="assign_package_type">
                    <div class="mb-3">
                        <label class="form-label">Package Name</label>
                        <input type="text" id="assign_package_name" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Select Customer</label>
                        <select name="customer_id" id="assign_customer_id" class="form-select" required>
                            <option value="">Choose customer...</option>
                            {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.full_name }} - {{ customer.phone }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Custom Amount (Optional)</label>
                        <input type="number" name="custom_amount" id="assign_custom_amount" class="form-control" step="0.01">
                        <small class="text-muted">Leave empty to use standard package amount</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" id="assign_notes" class="form-control" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitPackageAssignment()">Assign Package</button>
            </div>
        </div>
    </div>
</div>

<script>
let selectedServices = new Set();

// Function to submit prepaid package form
function submitPrepaidForm() {
    const form = document.getElementById('prepaidForm');
    const formData = new FormData(form);

    // Convert FormData to JSON
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });

    fetch('/api/prepaid-packages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            const modal = bootstrap.Modal.getInstance(document.getElementById('prepaidModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating package');
    });
}

// Function to edit prepaid package
function editPrepaid(packageId) {
    // Implementation for editing prepaid package
    console.log('Edit prepaid package:', packageId);
    // You can add modal opening logic here
}

// Function to delete prepaid package
function deletePrepaid(packageId) {
    if (confirm('Are you sure you want to delete this prepaid package?')) {
        fetch(`/api/prepaid-packages/${packageId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting package');
        });
    }
}

// Function to submit service package form
function submitServiceForm() {
    const form = document.getElementById('serviceForm');
    const formData = new FormData(form);

    // Convert FormData to JSON
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });

    fetch('/api/service-packages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            const modal = bootstrap.Modal.getInstance(document.getElementById('serviceModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating package');
    });
}

// Service package CRUD functions
function editService(packageId) {
    console.log('Edit service package:', packageId);
}

function deleteService(packageId) {
    if (confirm('Are you sure you want to delete this service package?')) {
        fetch(`/api/service-packages/${packageId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

// Function to submit membership form
function submitMembershipForm() {
    const form = document.getElementById('membershipForm');
    const formData = new FormData(form);

    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });

    fetch('/api/memberships', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            const modal = bootstrap.Modal.getInstance(document.getElementById('membershipModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating membership');
    });
}


// Membership CRUD functions
function editMembership(membershipId) {
    console.log('Edit membership:', membershipId);
}

function deleteMembership(membershipId) {
    if (confirm('Are you sure you want to delete this membership?')) {
        fetch(`/api/memberships/${membershipId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

// Student offer price calculation functions
function updateStudentServicePrice() {
    const serviceSelect = document.getElementById('student_service_select');
    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
    const price = selectedOption.getAttribute('data-price');

    if (price) {
        document.getElementById('student_actual_price').value = price;
        calculateStudentDiscountPrice();
    }
}

function calculateStudentDiscountPrice() {
    const actualPrice = parseFloat(document.getElementById('student_actual_price').value) || 0;
    const discountPercent = parseFloat(document.querySelector('input[name="discount_percent"]').value) || 0;

    const afterPrice = actualPrice * (1 - discountPercent / 100);
    document.getElementById('student_after_price').value = afterPrice.toFixed(2);
}

// Function to submit student offer form
function submitStudentForm() {
    const form = document.getElementById('studentForm');
    const formData = new FormData(form);

    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });

    fetch('/api/student-offers', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            const modal = bootstrap.Modal.getInstance(document.getElementById('studentModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating student offer');
    });
}

// Student offer CRUD functions
function editStudent(offerId) {
    console.log('Edit student offer:', offerId);
}

function deleteStudent(offerId) {
    if (confirm('Are you sure you want to delete this student offer?')) {
        fetch(`/api/student-offers/${offerId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

// Function to submit yearly membership form
function submitYearlyForm() {
    const form = document.getElementById('yearlyForm');
    const formData = new FormData(form);

    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });

    fetch('/api/yearly-memberships', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            const modal = bootstrap.Modal.getInstance(document.getElementById('yearlyModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating membership');
    });
}

// Yearly membership CRUD functions
function editYearly(membershipId) {
    console.log('Edit yearly membership:', membershipId);
}

function deleteYearly(membershipId) {
    if (confirm('Are you sure you want to delete this yearly membership?')) {
        fetch(`/api/yearly-memberships/${membershipId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

// Function to submit kitty party form
function submitKittyForm() {
    const form = document.getElementById('kittyForm');
    const formData = new FormData(form);

    // Convert to JSON, handling multiple service selections
    const data = {};
    const serviceIds = [];

    formData.forEach((value, key) => {
        if (key === 'service_ids') {
            serviceIds.push(value);
        } else {
            data[key] = value;
        }
    });

    data['service_ids'] = serviceIds;

    fetch('/api/kitty-parties', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            const modal = bootstrap.Modal.getInstance(document.getElementById('kittyModal'));
            modal.hide();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating kitty party');
    });
}

// Kitty party CRUD functions
function editKitty(partyId) {
    console.log('Edit kitty party:', partyId);
}

function deleteKitty(partyId) {
    if (confirm('Are you sure you want to delete this kitty party?')) {
        fetch(`/api/kitty-parties/${partyId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function assignPackage(packageId, packageName, packageType) {
    if (packageType === 'service') {
        // Handle Service Package assignment
        assignServicePackage(packageId, packageName);
    } else {
        // Handle other package types
        document.getElementById('assign_package_id').value = packageId;
        document.getElementById('assign_package_name').value = packageName;
        document.getElementById('assign_package_type').value = packageType;

        // Reset form
        document.getElementById('assignPackageForm').reset();
        document.getElementById('assign_package_id').value = packageId;
        document.getElementById('assign_package_name').value = packageName;
        document.getElementById('assign_package_type').value = packageType;

        const modal = new bootstrap.Modal(document.getElementById('assignPackageModal'));
        modal.show();
    }
}

function assignServicePackage(packageId, packageName) {
    // Set package details
    document.getElementById('service_assign_package_id').value = packageId;
    document.getElementById('serviceAssignModalTitle').textContent = `Assign Package: "${packageName}"`;
    
    // Reset form
    document.getElementById('assignServicePackageForm').reset();
    document.getElementById('service_assign_package_id').value = packageId;
    
    // Load services for selection
    loadServicesForAssignment();
    
    // Load package details for summary
    loadServicePackageDetails(packageId);
    
    const modal = new bootstrap.Modal(document.getElementById('assignServicePackageModal'));
    modal.show();
}

function loadServicesForAssignment() {
    fetch('/packages/api/services')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const serviceSelect = document.getElementById('service_assign_service_id');
                serviceSelect.innerHTML = '<option value="">Choose a service...</option>';
                
                data.services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.name} - ₹${service.price} (${service.duration} min)`;
                    option.setAttribute('data-price', service.price);
                    option.setAttribute('data-name', service.name);
                    serviceSelect.appendChild(option);
                });
                
                // Add event listener for service selection
                serviceSelect.addEventListener('change', function() {
                    calculateServiceCostBreakdown();
                });
            }
        })
        .catch(error => {
            console.error('Error loading services:', error);
            alert('Error loading services');
        });
}

function calculateServiceCostBreakdown() {
    const serviceSelect = document.getElementById('service_assign_service_id');
    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
    
    if (!selectedOption || !selectedOption.value || !window.currentPackageTemplate) {
        document.getElementById('cost_breakdown').style.display = 'none';
        return;
    }
    
    const servicePrice = parseFloat(selectedOption.getAttribute('data-price')) || 0;
    const serviceName = selectedOption.getAttribute('data-name') || '';
    const template = window.currentPackageTemplate;
    
    const totalSessions = template.total_services || 4;
    const payForSessions = template.pay_for || 3;
    const freeSessions = template.free_services || 1;
    
    // Calculate costs
    const totalCost = servicePrice * totalSessions;
    const packageDiscount = servicePrice * freeSessions;
    const finalPayment = servicePrice * payForSessions;
    const totalSavings = packageDiscount;
    
    // Update display
    document.getElementById('service_price_display').textContent = `₹${servicePrice.toFixed(0)}`;
    document.getElementById('total_cost_display').textContent = `₹${totalCost.toFixed(0)}`;
    document.getElementById('package_discount_display').textContent = `-₹${packageDiscount.toFixed(0)}`;
    document.getElementById('final_payment_display').textContent = `₹${finalPayment.toFixed(0)}`;
    document.getElementById('total_savings_display').textContent = `₹${totalSavings.toFixed(0)}`;
    
    // Show the breakdown
    document.getElementById('cost_breakdown').style.display = 'block';
}

function loadServicePackageDetails(packageId) {
    fetch(`/packages/api/templates/${packageId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.template) {
                const template = data.template;
                document.getElementById('summary_pay_for').textContent = template.pay_for || '-';
                document.getElementById('summary_free').textContent = template.free_services || '-';
                document.getElementById('summary_total').textContent = template.total_services || '-';
                
                // Store template data for calculations
                window.currentPackageTemplate = template;
                
                // Update text placeholders
                document.getElementById('total_sessions_text').textContent = template.total_services || 4;
                document.getElementById('free_sessions_text').textContent = template.free_services || 1;
                document.getElementById('paid_sessions_text').textContent = template.pay_for || 3;
                document.getElementById('benefit_percent_display').textContent = Math.round(template.benefit_percent || 25) + '%';
            }
        })
        .catch(error => {
            console.error('Error loading package details:', error);
        });
}

function submitServicePackageAssignment() {
    const form = document.getElementById('assignServicePackageForm');
    const formData = new FormData(form);
    
    // Validate required fields
    const customerId = document.getElementById('service_assign_customer_id').value;
    const serviceId = document.getElementById('service_assign_service_id').value;
    const packageId = document.getElementById('service_assign_package_id').value;
    
    if (!customerId) {
        alert('Please select a customer');
        return;
    }
    
    if (!serviceId) {
        alert('Please select a service');
        return;
    }
    
    // Prepare data for API
    const assignmentData = {
        package_type: 'service_package',
        package_id: parseInt(packageId),
        customer_id: parseInt(customerId),
        service_id: parseInt(serviceId),
        price_paid: 0, // Will be set by package template price
        expires_on: formData.get('expiry_date') || null,
        notes: formData.get('notes') || ''
    };
    
    // Submit assignment
    fetch('/packages/api/assign', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(assignmentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('assignServicePackageModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while assigning the package');
    });
}

function submitPackageAssignment() {
    const form = document.getElementById('assignPackageForm');
    const formData = new FormData(form);
    const packageId = document.getElementById('assign_package_id').value;
    const packageType = document.getElementById('assign_package_type').value;

    // Add hidden fields to formData
    formData.append('package_id', packageId);
    formData.append('package_type', packageType);

    fetch(`/packages/assign/${packageId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('assignPackageModal')).hide();
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while assigning the package');
    });
}
</script>

{% endblock %}