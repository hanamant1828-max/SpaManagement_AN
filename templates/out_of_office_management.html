{% extends "base.html" %}

{% block title %}Out of Office Management - Spa & Salon Suite{% endblock %}

{% block body_class %}page-out-of-office{% endblock %}

{% block extra_head %}
<link href="{{ url_for('static', filename='css/shift_scheduler.css') }}" rel="stylesheet">
<style>
.ooo-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 2rem;
    margin-bottom: 2rem;
}

.ooo-header {
    background: linear-gradient(135deg, var(--spa-primary), var(--spa-primary-dark));
    color: white;
    padding: 2rem;
    border-radius: 12px 12px 0 0;
    margin: -2rem -2rem 2rem -2rem;
}

.form-control:focus, .form-select:focus {
    border-color: var(--spa-primary);
    box-shadow: 0 0 0 0.2rem var(--spa-primary-shadow);
}

.btn-primary {
    background: linear-gradient(135deg, var(--spa-primary), var(--spa-primary-dark));
    border: none;
}

.btn-primary:hover {
    background: linear-gradient(135deg, var(--spa-primary-dark), var(--spa-primary-darker));
    transform: translateY(-1px);
}

.entry-row:hover {
    background-color: var(--spa-gray-100);
}

.time-badge {
    background: var(--spa-info-bg);
    color: var(--spa-info-dark);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-weight: 500;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('shift_scheduler.shift_scheduler') }}">Shift Scheduler</a></li>
                    <li class="breadcrumb-item active">Out of Office Management</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="ooo-card">
        <div class="ooo-header">
            <h2 class="mb-0">
                <i class="fas fa-briefcase me-3"></i>Out of Office Management
            </h2>
            <p class="mb-0 mt-2 opacity-90">Track staff field work, client visits, and off-site activities</p>
        </div>

        <div class="row">
            <div class="col-lg-5">
                <!-- Add Entry Button -->
        <div class="mb-4 text-end">
            <button type="button" class="btn btn-primary btn-lg" id="addEntryBtn" onclick="toggleEntryForm()">
                <i class="fas fa-plus-circle me-2"></i>Add Out of Office Entry
            </button>
        </div>

        <!-- Out of Office Entry Form (Hidden by default) -->
        <div class="entry-form-card mb-4" id="entryFormCard">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-white">
                    <i class="fas fa-plus-circle me-2"></i>
                    <span id="formTitle">Add Out of Office Entry</span>
                </h5>
                <button type="button" class="btn btn-sm btn-outline-light" onclick="toggleEntryForm()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="outOfOfficeForm">
                <input type="hidden" id="entryId">

                <div class="mb-3">
                    <label for="staffId" class="form-label">Staff Member <span class="text-danger">*</span></label>
                    <select class="form-select" id="staffId" required>
                        <option value="">-- Select Staff Member --</option>
                        {% for staff in staff_members %}
                        <option value="{{ staff.id }}">{{ staff.first_name }} {{ staff.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="entryDate" class="form-label">Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" id="entryDate" value="{{ today }}" required>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="startTime" class="form-label">Start Time <span class="text-danger">*</span></label>
                        <input type="time" class="form-control" id="startTime" value="09:00" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="endTime" class="form-label">Expected Return <span class="text-danger">*</span></label>
                        <input type="time" class="form-control" id="endTime" value="17:00" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="reason" class="form-label">Reason <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="reason" maxlength="200" 
                           placeholder="Client visit / Site inspection / Delivery..." required>
                    <div class="form-text">Max 200 characters</div>
                </div>

                <div class="alert alert-danger d-none" id="errorAlert"></div>
                <div class="alert alert-success d-none" id="successAlert"></div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary flex-fill">
                        <i class="fas fa-save me-2"></i>Save Entry
                    </button>
                    <button type="button" class="btn btn-secondary" id="cancelBtn">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                </div>
            </form>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Current Entries
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" id="refreshBtn">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="entriesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Staff Member</th>
                                        <th>Date</th>
                                        <th>Time Period</th>
                                        <th>Reason</th>
                                        <th width="100" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="entriesTableBody">
                                    <tr id="loadingRow">
                                        <td colspan="5" class="text-center py-4">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                            <span class="ms-2">Loading entries...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center py-5 d-none" id="noEntriesMessage">
                            <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No out of office entries found</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let editingId = null;

    loadEntries();

    $('#refreshBtn').on('click', loadEntries);

    $('#cancelBtn').on('click', function() {
        resetForm();
    });

    $('#outOfOfficeForm').on('submit', function(e) {
        e.preventDefault();
        saveEntry();
    });

    $(document).on('click', '.edit-btn', function() {
        const entryId = $(this).data('id');
        loadEntryForEdit(entryId);
    });

    $(document).on('click', '.delete-btn', function() {
        const entryId = $(this).data('id');
        deleteEntry(entryId);
    });

    function loadEntries() {
        $('#loadingRow').removeClass('d-none');

        $.ajax({
            url: '/shift-scheduler/api/out-of-office',
            method: 'GET',
            success: function(response) {
                $('#loadingRow').addClass('d-none');

                if (response.success && response.entries && response.entries.length > 0) {
                    $('#noEntriesMessage').addClass('d-none');
                    $('#entriesTable').removeClass('d-none');

                    const tbody = $('#entriesTableBody');
                    tbody.empty();

                    response.entries.forEach(entry => {
                        const row = `
                            <tr class="entry-row">
                                <td><strong>${entry.staff_name || 'N/A'}</strong></td>
                                <td>${formatDate(entry.date)}</td>
                                <td><span class="time-badge">${entry.start_time} - ${entry.end_time}</span></td>
                                <td>${entry.reason || ''}</td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-primary edit-btn me-1" data-id="${entry.id}" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${entry.id}" title="Delete">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                } else {
                    $('#entriesTable').addClass('d-none');
                    $('#noEntriesMessage').removeClass('d-none');
                }
            },
            error: function(xhr) {
                $('#loadingRow').addClass('d-none');
                showError('Failed to load entries');
            }
        });
    }

    function saveEntry() {
        const staffId = $('#staffId').val();
        const date = $('#entryDate').val();
        const startTime = $('#startTime').val();
        const endTime = $('#endTime').val();
        const reason = $('#reason').val().trim();

        hideAlerts();

        if (!staffId || !date || !startTime || !endTime || !reason) {
            showError('Please fill all required fields');
            return;
        }

        if (reason.length > 200) {
            showError('Reason must be 200 characters or less');
            return;
        }

        if (startTime >= endTime) {
            showError('Start time must be before expected return time');
            return;
        }

        const data = {
            staff_id: staffId,
            date: date,
            start_time: startTime,
            end_time: endTime,
            reason: reason
        };

        const url = editingId 
            ? `/shift-scheduler/api/out-of-office/${editingId}`
            : '/shift-scheduler/api/out-of-office';
        const method = editingId ? 'PUT' : 'POST';

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showSuccess(response.message || 'Entry saved successfully!');
                    setTimeout(function() {
                        resetForm();
                        loadEntries();
                    }, 1500);
                } else {
                    showError(response.error || 'Failed to save entry');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON && xhr.responseJSON.error 
                    ? xhr.responseJSON.error 
                    : 'An error occurred while saving';
                showError(error);
            }
        });
    }

    function loadEntryForEdit(entryId) {
        $.ajax({
            url: `/shift-scheduler/api/out-of-office/${entryId}`,
            method: 'GET',
            success: function(response) {
                if (response.success && response.entry) {
                    const entry = response.entry;
                    editingId = entry.id;
                    $('#entryId').val(entry.id);
                    $('#staffId').val(entry.staff_id);
                    $('#entryDate').val(entry.date);
                    $('#startTime').val(entry.start_time);
                    $('#endTime').val(entry.end_time);
                    $('#reason').val(entry.reason);
                    $('#formTitle').text('Edit Out of Office Entry');

                    $('html, body').animate({
                        scrollTop: $('#outOfOfficeForm').offset().top - 100
                    }, 500);
                } else {
                    showError('Failed to load entry for editing');
                }
            },
            error: function() {
                showError('Failed to load entry for editing');
            }
        });
    }

    function deleteEntry(entryId) {
        if (!confirm('Are you sure you want to delete this out of office entry?')) {
            return;
        }

        $.ajax({
            url: `/shift-scheduler/api/out-of-office/${entryId}`,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    loadEntries();
                    showSuccess('Entry deleted successfully');
                } else {
                    showError(response.error || 'Failed to delete entry');
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON && xhr.responseJSON.error 
                    ? xhr.responseJSON.error 
                    : 'Failed to delete entry';
                showError(error);
            }
        });
    }

    function resetForm() {
        editingId = null;
        $('#outOfOfficeForm')[0].reset();
        $('#entryId').val('');
        $('#entryDate').val('{{ today }}');
        $('#startTime').val('09:00');
        $('#endTime').val('17:00');
        $('#formTitle').text('Add Out of Office Entry');
        hideAlerts();
    }

    function showError(message) {
        $('#errorAlert').text(message).removeClass('d-none');
        $('#successAlert').addClass('d-none');
    }

    function showSuccess(message) {
        $('#successAlert').text(message).removeClass('d-none');
        $('#errorAlert').addClass('d-none');
    }

    function hideAlerts() {
        $('#errorAlert').addClass('d-none');
        $('#successAlert').addClass('d-none');
    }

    function formatDate(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
    }
});
</script>
{% endblock %}