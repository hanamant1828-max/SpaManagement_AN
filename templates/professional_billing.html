{% extends "base.html" %}

{% block title %}Professional Billing & Payments - Spa & Salon Management Suite{% endblock %}

{% block extra_css %}
<style>
.invoice-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    overflow: hidden;
}

.invoice-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
}

.invoice-body {
    padding: 2rem;
}

.payment-method-card {
    border: 2px solid transparent;
    transition: all 0.3s ease;
    cursor: pointer;
}

.payment-method-card:hover {
    border-color: #007bff;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,123,255,0.2);
}

.payment-method-card.selected {
    border-color: #007bff;
    background-color: rgba(0,123,255,0.05);
}

.stat-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    border: none;
    border-radius: 15px;
    color: white;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card.success {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.stat-card.warning {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
}

.professional-table {
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

.professional-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.professional-table tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.05);
}

.invoice-footer {
    background: #f8f9fa;
    padding: 1.5rem;
    border-top: 3px solid #667eea;
}

.amount-highlight {
    font-size: 1.5rem;
    font-weight: 700;
    color: #667eea;
}

.payment-status-paid {
    background: linear-gradient(45deg, #56ab2f, #a8e6cf);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 600;
}

.payment-status-pending {
    background: linear-gradient(45deg, #ff9a9e, #fecfef);
    color: #d63384;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 600;
}

.payment-status-overdue {
    background: linear-gradient(45deg, #ff6b6b, #ffa500);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 600;
}

.action-button {
    border-radius: 25px;
    padding: 0.5rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.company-info {
    text-align: center;
    margin-bottom: 2rem;
}

.company-logo {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    font-size: 2rem;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-file-invoice-dollar me-2 text-primary"></i>
                    Professional Billing & Payments
                </h1>
                <div class="btn-group">
                    <button class="btn btn-primary action-button" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">
                        <i class="fas fa-plus me-2"></i>New Invoice
                    </button>
                    <button class="btn btn-outline-primary action-button" onclick="generateReport()">
                        <i class="fas fa-chart-line me-2"></i>Reports
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <div class="row no-gutters align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Today's Revenue</div>
                            <div class="h4 mb-0 font-weight-bold">{{ utils.format_currency(today_revenue or 0) }}</div>
                            <small class="mt-1">+12% from yesterday</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-dollar-sign fa-3x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card warning h-100">
                <div class="card-body text-center">
                    <div class="row no-gutters align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Pending Payments</div>
                            <div class="h4 mb-0 font-weight-bold">{{ pending_appointments|length }}</div>
                            <small class="mt-1">{{ utils.format_currency(pending_appointments|sum(attribute='amount') or 0) }} total</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-3x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card success h-100">
                <div class="card-body text-center">
                    <div class="row no-gutters align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Monthly Revenue</div>
                            <div class="h4 mb-0 font-weight-bold">{{ utils.format_currency(monthly_revenue or 0) }}</div>
                            <small class="mt-1">{{ (monthly_growth or 0)|round(1) }}% growth</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-3x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <div class="row no-gutters align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1">Outstanding</div>
                            <div class="h4 mb-0 font-weight-bold">{{ outstanding_invoices|length }}</div>
                            <small class="mt-1">{{ utils.format_currency(outstanding_amount or 0) }}</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-3x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Pending Payments -->
        <div class="col-lg-8 mb-4">
            <div class="card invoice-container">
                <div class="invoice-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Pending Payments & Invoices
                    </h5>
                </div>
                <div class="invoice-body">
                    {% if pending_appointments or outstanding_invoices %}
                        <div class="table-responsive">
                            <table class="table professional-table mb-0">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Client</th>
                                        <th>Service/Description</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for appointment in pending_appointments %}
                                    <tr>
                                        <td>{{ utils.format_date(appointment.appointment_date.date()) }}</td>
                                        <td>
                                            <div class="fw-bold">{{ appointment.client.full_name }}</div>
                                            <small class="text-muted">{{ appointment.client.phone }}</small>
                                        </td>
                                        <td>
                                            <div>{{ appointment.service.name }}</div>
                                            <small class="text-muted">with {{ appointment.assigned_staff.full_name }}</small>
                                        </td>
                                        <td>
                                            <div class="amount-highlight">{{ utils.format_currency(appointment.amount) }}</div>
                                            {% if appointment.discount > 0 %}
                                                <small class="text-success">-{{ utils.format_currency(appointment.discount) }} discount</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="payment-status-pending">Pending</span>
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-success action-button" 
                                                        onclick="markAsPaid({{ appointment.id }})">
                                                    <i class="fas fa-check me-1"></i>Pay
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary action-button" 
                                                        onclick="generateInvoice({{ appointment.id }})">
                                                    <i class="fas fa-file-invoice me-1"></i>Invoice
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="company-logo">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h4 class="text-success mb-3">All Payments Current!</h4>
                            <p class="text-muted">No pending payments at the moment. Your business is running smoothly.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Professional Payment Processing -->
        <div class="col-lg-4 mb-4">
            <div class="card invoice-container">
                <div class="invoice-header">
                    <h5 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>Payment Processing
                    </h5>
                </div>
                <div class="invoice-body">
                    <!-- Payment Methods -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="mb-3">Select Payment Method</h6>
                            <div class="row g-2">
                                <div class="col-12">
                                    <div class="card payment-method-card" onclick="selectPaymentMethod('cash')">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-money-bill-wave fa-2x text-success me-3"></i>
                                                <div>
                                                    <h6 class="mb-0">Cash Payment</h6>
                                                    <small class="text-muted">Immediate processing</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card payment-method-card" onclick="selectPaymentMethod('card')">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-credit-card fa-2x text-primary me-3"></i>
                                                <div>
                                                    <h6 class="mb-0">Credit/Debit Card</h6>
                                                    <small class="text-muted">Secure processing</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card payment-method-card" onclick="selectPaymentMethod('digital')">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-mobile-alt fa-2x text-info me-3"></i>
                                                <div>
                                                    <h6 class="mb-0">Digital Wallet</h6>
                                                    <small class="text-muted">Apple Pay, Google Pay</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Amount Input -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Payment Amount</label>
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-primary text-white">
                                <i class="fas fa-dollar-sign"></i>
                            </span>
                            <input type="number" id="paymentAmount" class="form-control" 
                                   placeholder="0.00" step="0.01" min="0">
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary btn-lg action-button" onclick="processPayment()">
                            <i class="fas fa-check-circle me-2"></i>Process Payment
                        </button>
                        <button class="btn btn-outline-secondary action-button" onclick="sendPaymentLink()">
                            <i class="fas fa-link me-2"></i>Send Payment Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Invoice History -->
    <div class="row">
        <div class="col-12">
            <div class="card invoice-container">
                <div class="invoice-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-file-invoice me-2"></i>Invoice Management
                        </h5>
                        <div class="btn-group">
                            <button class="btn btn-light action-button" onclick="exportInvoices()">
                                <i class="fas fa-download me-1"></i>Export
                            </button>
                            <button class="btn btn-light action-button" onclick="bulkActions()">
                                <i class="fas fa-tasks me-1"></i>Bulk Actions
                            </button>
                        </div>
                    </div>
                </div>
                <div class="invoice-body">
                    {% if recent_invoices %}
                        <div class="table-responsive">
                            <table class="table professional-table mb-0">
                                <thead>
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                        </th>
                                        <th>Invoice #</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for invoice in recent_invoices %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="invoice-checkbox" value="{{ invoice.id }}">
                                        </td>
                                        <td>
                                            <div class="fw-bold text-primary">{{ invoice.invoice_number }}</div>
                                            <small class="text-muted">{{ invoice.created_at.strftime('%B %d, %Y') }}</small>
                                        </td>
                                        <td>
                                            <div class="fw-bold">{{ invoice.client.full_name }}</div>
                                            <small class="text-muted">{{ invoice.client.email or invoice.client.phone }}</small>
                                        </td>
                                        <td>{{ utils.format_date(invoice.invoice_date.date()) }}</td>
                                        <td>
                                            <div class="amount-highlight">{{ utils.format_currency(invoice.total_amount) }}</div>
                                        </td>
                                        <td>
                                            {% if invoice.payment_status == 'paid' %}
                                                <span class="payment-status-paid">Paid</span>
                                            {% elif invoice.payment_status == 'pending' %}
                                                <span class="payment-status-pending">Pending</span>
                                            {% elif invoice.payment_status == 'overdue' %}
                                                <span class="payment-status-overdue">Overdue</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-primary action-button" 
                                                        onclick="viewInvoice({{ invoice.id }})">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-success action-button" 
                                                        onclick="downloadInvoice({{ invoice.id }})">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info action-button" 
                                                        onclick="emailInvoice({{ invoice.id }})">
                                                    <i class="fas fa-envelope"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary action-button" 
                                                        onclick="duplicateInvoice({{ invoice.id }})">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <div class="company-logo">
                                <i class="fas fa-file-invoice"></i>
                            </div>
                            <h4 class="mb-3">Start Creating Professional Invoices</h4>
                            <p class="text-muted mb-4">Create your first invoice to streamline your billing process</p>
                            <button class="btn btn-primary btn-lg action-button" data-bs-toggle="modal" data-bs-target="#createInvoiceModal">
                                <i class="fas fa-plus me-2"></i>Create First Invoice
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Professional Invoice Creation Modal -->
<div class="modal fade" id="createInvoiceModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Create Professional Invoice
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="professionalInvoiceForm">
                    <div class="row">
                        <!-- Company Information -->
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Business Information</h6>
                                </div>
                                <div class="card-body">
                                    <div class="company-info">
                                        <div class="company-logo">
                                            <i class="fas fa-spa"></i>
                                        </div>
                                        <h5>{{ business_name or 'Your Spa & Salon' }}</h5>
                                        <p class="text-muted mb-0">{{ business_address or '123 Wellness Street' }}</p>
                                        <p class="text-muted">{{ business_city or 'Spa City, SC 12345' }}</p>
                                        <p class="text-muted">Phone: {{ business_phone or '(555) 123-4567' }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Client Information -->
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0">Bill To</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Select Client</label>
                                        <select class="form-select" id="invoiceClient" required>
                                            <option value="">Choose a client...</option>
                                            {% for client in clients %}
                                            <option value="{{ client.id }}">{{ client.full_name }} - {{ client.phone }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Invoice Date</label>
                                        <input type="date" class="form-control" id="invoiceDate" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Due Date</label>
                                        <input type="date" class="form-control" id="invoiceDueDate" required>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Items -->
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Invoice Items</h6>
                            <button type="button" class="btn btn-sm btn-primary" onclick="addInvoiceItem()">
                                <i class="fas fa-plus me-1"></i>Add Item
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="invoiceItemsTable">
                                    <thead>
                                        <tr>
                                            <th>Service/Item</th>
                                            <th>Description</th>
                                            <th>Quantity</th>
                                            <th>Rate</th>
                                            <th>Amount</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invoiceItems">
                                        <tr class="invoice-item-row">
                                            <td>
                                                <select class="form-select service-select">
                                                    <option value="">Select service...</option>
                                                    {% for service in services %}
                                                    <option value="{{ service.id }}" data-price="{{ service.price }}">{{ service.name }}</option>
                                                    {% endfor %}
                                                </select>
                                            </td>
                                            <td><input type="text" class="form-control" placeholder="Service description"></td>
                                            <td><input type="number" class="form-control quantity-input" value="1" min="1"></td>
                                            <td><input type="number" class="form-control rate-input" step="0.01" min="0"></td>
                                            <td><span class="amount-display fw-bold">$0.00</span></td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeInvoiceItem(this)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="invoice-footer">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Notes</label>
                                    <textarea class="form-control" id="invoiceNotes" rows="3" placeholder="Thank you for your business!"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-borderless">
                                        <tbody>
                                            <tr>
                                                <td>Subtotal:</td>
                                                <td class="text-end"><span id="invoiceSubtotal">$0.00</span></td>
                                            </tr>
                                            <tr>
                                                <td>Tax ({{ tax_rate or 8.5 }}%):</td>
                                                <td class="text-end"><span id="invoiceTax">$0.00</span></td>
                                            </tr>
                                            <tr>
                                                <td>Discount:</td>
                                                <td class="text-end">
                                                    <input type="number" class="form-control form-control-sm" 
                                                           id="invoiceDiscount" placeholder="0.00" step="0.01" min="0">
                                                </td>
                                            </tr>
                                            <tr class="border-top">
                                                <td><strong>Total:</strong></td>
                                                <td class="text-end"><strong class="amount-highlight" id="invoiceTotal">$0.00</strong></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary" onclick="previewInvoice()">
                    <i class="fas fa-eye me-1"></i>Preview
                </button>
                <button type="button" class="btn btn-primary" onclick="saveInvoice()">
                    <i class="fas fa-save me-1"></i>Create Invoice
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Professional billing system JavaScript
let selectedPaymentMethod = null;
let invoiceItems = [];

document.addEventListener('DOMContentLoaded', function() {
    // Set current date for invoice
    document.getElementById('invoiceDate').valueAsDate = new Date();
    
    // Set due date to 30 days from now
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    document.getElementById('invoiceDueDate').valueAsDate = dueDate;
    
    // Initialize invoice calculations
    updateInvoiceCalculations();
});

function selectPaymentMethod(method) {
    // Remove previous selection
    document.querySelectorAll('.payment-method-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selection to clicked card
    event.currentTarget.classList.add('selected');
    selectedPaymentMethod = method;
    
    console.log('Selected payment method:', method);
}

function processPayment() {
    const amount = document.getElementById('paymentAmount').value;
    
    if (!selectedPaymentMethod) {
        alert('Please select a payment method');
        return;
    }
    
    if (!amount || amount <= 0) {
        alert('Please enter a valid payment amount');
        return;
    }
    
    // Show processing animation
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    btn.disabled = true;
    
    // Simulate payment processing
    setTimeout(() => {
        btn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Payment Successful!';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        
        // Reset after 3 seconds
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
            btn.disabled = false;
            
            // Clear form
            document.getElementById('paymentAmount').value = '';
            selectedPaymentMethod = null;
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
            });
        }, 3000);
    }, 2000);
}

function addInvoiceItem() {
    const tbody = document.getElementById('invoiceItems');
    const newRow = document.querySelector('.invoice-item-row').cloneNode(true);
    
    // Clear values in the new row
    newRow.querySelectorAll('input, select').forEach(input => {
        if (input.type === 'number' && input.classList.contains('quantity-input')) {
            input.value = 1;
        } else if (input.type !== 'number') {
            input.value = '';
        } else {
            input.value = '';
        }
    });
    
    newRow.querySelector('.amount-display').textContent = '$0.00';
    
    tbody.appendChild(newRow);
    attachItemEventListeners(newRow);
    updateInvoiceCalculations();
}

function removeInvoiceItem(button) {
    const tbody = document.getElementById('invoiceItems');
    if (tbody.children.length > 1) {
        button.closest('tr').remove();
        updateInvoiceCalculations();
    }
}

function attachItemEventListeners(row) {
    const serviceSelect = row.querySelector('.service-select');
    const quantityInput = row.querySelector('.quantity-input');
    const rateInput = row.querySelector('.rate-input');
    
    serviceSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.dataset.price) {
            rateInput.value = selectedOption.dataset.price;
            updateRowAmount(row);
        }
    });
    
    quantityInput.addEventListener('input', () => updateRowAmount(row));
    rateInput.addEventListener('input', () => updateRowAmount(row));
}

function updateRowAmount(row) {
    const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
    const rate = parseFloat(row.querySelector('.rate-input').value) || 0;
    const amount = quantity * rate;
    
    row.querySelector('.amount-display').textContent = formatCurrency(amount);
    updateInvoiceCalculations();
}

function updateInvoiceCalculations() {
    let subtotal = 0;
    
    document.querySelectorAll('.invoice-item-row').forEach(row => {
        const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
        const rate = parseFloat(row.querySelector('.rate-input').value) || 0;
        subtotal += quantity * rate;
    });
    
    const taxRate = {{ tax_rate or 8.5 }} / 100;
    const discount = parseFloat(document.getElementById('invoiceDiscount')?.value) || 0;
    const tax = subtotal * taxRate;
    const total = subtotal + tax - discount;
    
    document.getElementById('invoiceSubtotal').textContent = formatCurrency(subtotal);
    document.getElementById('invoiceTax').textContent = formatCurrency(tax);
    document.getElementById('invoiceTotal').textContent = formatCurrency(total);
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount);
}

function markAsPaid(appointmentId) {
    if (confirm('Mark this payment as received?')) {
        // Implementation for marking payment as paid
        window.location.href = `/mark_paid/${appointmentId}`;
    }
}

function generateInvoice(appointmentId) {
    // Implementation for generating invoice
    window.location.href = `/generate_invoice/${appointmentId}`;
}

function saveInvoice() {
    const form = document.getElementById('professionalInvoiceForm');
    const formData = new FormData(form);
    
    // Add invoice items to form data
    const items = [];
    document.querySelectorAll('.invoice-item-row').forEach(row => {
        const service = row.querySelector('.service-select').value;
        const description = row.querySelector('input[placeholder="Service description"]').value;
        const quantity = row.querySelector('.quantity-input').value;
        const rate = row.querySelector('.rate-input').value;
        
        if (service && quantity && rate) {
            items.push({
                service_id: service,
                description: description,
                quantity: quantity,
                rate: rate
            });
        }
    });
    
    formData.append('items', JSON.stringify(items));
    
    // Submit to server
    fetch('/create_invoice', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Invoice created successfully!');
            location.reload();
        } else {
            alert('Error creating invoice: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating invoice');
    });
}

// Initialize event listeners for existing items
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.invoice-item-row').forEach(row => {
        attachItemEventListeners(row);
    });
    
    // Add discount change listener
    document.getElementById('invoiceDiscount')?.addEventListener('input', updateInvoiceCalculations);
});

// Professional invoice actions
function viewInvoice(invoiceId) {
    window.open(`/invoice/${invoiceId}`, '_blank');
}

function downloadInvoice(invoiceId) {
    window.location.href = `/invoice/${invoiceId}/download`;
}

function emailInvoice(invoiceId) {
    if (confirm('Send this invoice via email?')) {
        fetch(`/invoice/${invoiceId}/send`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Invoice sent successfully!');
            } else {
                alert('Error sending invoice: ' + data.error);
            }
        });
    }
}

function duplicateInvoice(invoiceId) {
    if (confirm('Create a copy of this invoice?')) {
        window.location.href = `/invoice/${invoiceId}/duplicate`;
    }
}

console.log('Professional billing system loaded successfully');
</script>
{% endblock %}