{% extends "base.html" %}

{% block title %}Professional Invoice Management{% endblock %}

{% block extra_head %}
<style>
/* ==========================================
   DESIGN SYSTEM - PROFESSIONAL BILLING
   ========================================== */

:root {
    /* Brand Identity */
    --primary: #4f46e5;
    --primary-hover: #4338ca;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #06b6d4;

    /* Neutral Palette */
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-500: #6b7280;
    --gray-700: #374151;
    --gray-900: #111827;

    /* Elevation */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

    /* Spacing System */
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    --spacing-2xl: 3rem;

    /* Border Radius */
    --radius-sm: 0.375rem;
    --radius: 0.5rem;
    --radius-lg: 0.75rem;

    /* Transitions */
    --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ==========================================
   GLOBAL RESET & BASE
   ========================================== */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    background: var(--gray-50);
    color: var(--gray-900);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
}

/* ==========================================
   LAYOUT COMPONENTS
   ========================================== */

.page-header {
    background: white;
    border-bottom: 1px solid var(--gray-200);
    padding: var(--spacing-xl) var(--spacing-2xl);
    margin-bottom: var(--spacing-xl);
    box-shadow: var(--shadow-sm);
}

.page-title {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
}

.page-title i {
    color: var(--primary);
}

.page-subtitle {
    color: var(--gray-500);
    font-size: 0.875rem;
}

/* ==========================================
   CARD COMPONENTS
   ========================================== */

.card {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-lg);
    transition: var(--transition);
}

.card:hover {
    box-shadow: var(--shadow-md);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 2px solid var(--gray-100);
}

.card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.card-title i {
    color: var(--primary);
}

/* ==========================================
   FORM CONTROLS
   ========================================== */

.form-group {
    margin-bottom: var(--spacing-lg);
}

.form-label {
    display: block;
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--gray-700);
    margin-bottom: var(--spacing-sm);
}

.form-label.required::after {
    content: '*';
    color: var(--danger);
    margin-left: 0.25rem;
}

.form-control,
.form-select {
    width: 100%;
    padding: 0.625rem 0.875rem;
    font-size: 0.875rem;
    line-height: 1.5;
    color: var(--gray-900);
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius);
    transition: var(--transition);
}

.form-control:focus,
.form-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.form-control:hover:not(:focus),
.form-select:hover:not(:focus) {
    border-color: var(--gray-400);
}

.form-control.is-invalid,
.form-select.is-invalid {
    border-color: var(--danger);
}

.invalid-feedback {
    display: none;
    color: var(--danger);
    font-size: 0.8125rem;
    margin-top: var(--spacing-xs);
}

.is-invalid + .invalid-feedback {
    display: block;
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

/* ==========================================
   BUTTONS
   ========================================== */

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.5;
    text-align: center;
    text-decoration: none;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-success:hover:not(:disabled) {
    background: #059669;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-info {
    background: var(--info);
    color: white;
}

.btn-info:hover:not(:disabled) {
    background: #0891b2;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-danger:hover:not(:disabled) {
    background: #dc2626;
}

.btn-sm {
    padding: 0.4rem 0.875rem;
    font-size: 0.8125rem;
}

.btn-lg {
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
}

/* Button States */
.btn-loading .btn-text {
    display: none;
}

.btn-loading .btn-spinner {
    display: inline-block;
}

.btn:not(.btn-loading) .btn-spinner {
    display: none;
}

/* ==========================================
   ITEM ROWS
   ========================================== */

.item-row {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
    transition: var(--transition);
}

.item-row:hover {
    background: white;
    border-color: var(--primary);
    box-shadow: var(--shadow-sm);
}

.item-row .row {
    align-items: end;
}

.package-benefit {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    margin-top: var(--spacing-sm);
    font-size: 0.8125rem;
    border-left: 3px solid var(--success);
}

.student-offer-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
}

.package-benefit.student-discount {
    background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
    color: #4338ca;
    border-left: 3px solid #6366f1;
}

.package-benefit.student-discount::before {
    content: 'üéì ';
    margin-right: 0.25rem;
}

.batch-info {
    background: var(--gray-100);
    border-left: 3px solid var(--info);
    padding: var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    margin-top: var(--spacing-xs);
    color: var(--gray-700);
}

/* ==========================================
   SUMMARY PANEL
   ========================================== */

.summary-panel {
    background: linear-gradient(135deg, var(--primary) 0%, #6366f1 100%);
    color: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    position: sticky;
    top: var(--spacing-lg);
    box-shadow: var(--shadow-lg);
}

.summary-header {
    text-align: center;
    margin-bottom: var(--spacing-lg);
    font-size: 1.25rem;
    font-weight: 600;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.summary-row:last-of-type {
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.summary-label {
    font-weight: 400;
    opacity: 0.9;
}

.summary-value {
    font-weight: 600;
}

.grand-total {
    font-size: 2.5rem;
    font-weight: 800;
    text-align: center;
    margin: var(--spacing-xl) 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.summary-actions {
    display: grid;
    gap: var(--spacing-md);
    margin-top: var(--spacing-lg);
}

.summary-footer {
    text-align: center;
    margin-top: var(--spacing-md);
    font-size: 0.75rem;
    opacity: 0.7;
}

/* ==========================================
   ALERTS & NOTIFICATIONS
   ========================================== */

.alert {
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius);
    margin-bottom: var(--spacing-md);
    border-left: 4px solid;
}

.alert-info {
    background: #e0f2fe;
    border-color: var(--info);
    color: #075985;
}

.alert-success {
    background: #d1fae5;
    border-color: var(--success);
    color: #065f46;
}

.alert-warning {
    background: #fef3c7;
    border-color: var(--warning);
    color: #92400e;
}

.alert-danger {
    background: #fee2e2;
    border-color: var(--danger);
    color: #991b1b;
}

/* Toast Notifications */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    max-width: 400px;
    padding: var(--spacing-lg);
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* ==========================================
   UTILITIES
   ========================================== */

.text-muted {
    color: var(--gray-500);
}

.text-success {
    color: var(--success);
}

.text-danger {
    color: var(--danger);
}

.d-none {
    display: none !important;
}

.d-block {
    display: block !important;
}

.d-flex {
    display: flex !important;
}

.d-grid {
    display: grid !important;
}

.gap-2 {
    gap: var(--spacing-sm);
}

.gap-3 {
    gap: var(--spacing-md);
}

.mb-3 {
    margin-bottom: var(--spacing-md);
}

.w-100 {
    width: 100%;
}

.spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

/* ==========================================
   RESPONSIVE DESIGN
   ========================================== */

@media (max-width: 768px) {
    .page-header {
        padding: var(--spacing-lg);
    }

    .page-title {
        font-size: 1.5rem;
    }

    .card {
        padding: var(--spacing-lg);
    }

    .grand-total {
        font-size: 2rem;
    }

    .summary-panel {
        position: static;
        margin-top: var(--spacing-xl);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-file-invoice-dollar"></i>
            Create Professional Invoice
        </h1>
        <p class="page-subtitle">
            Comprehensive billing with package benefits, inventory tracking, and staff management
        </p>
    </div>

    <!-- Main Billing Form -->
    <form id="billingForm" method="POST" action="/integrated-billing/create-professional">
        <div class="row">
            <!-- Left Column: Form Inputs -->
            <div class="col-lg-8">
                <!-- Customer Section -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-user-circle"></i>
                            Customer Information
                        </h6>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label required">Select Customer</label>
                                <select class="form-select" id="client_id" name="client_id" required>
                                    <option value="">Choose customer...</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}" {{ 'selected' if selected_customer and customer.id == selected_customer.id else '' }}>
                                        {{ customer.full_name }} - {{ customer.phone }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select a customer</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Booked Appointments</label>
                                <div id="customerAppointments" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--gray-300); border-radius: var(--radius); background: white;">
                                    <div style="padding: var(--spacing-md); text-align: center; color: var(--gray-500);">
                                        <small><i class="fas fa-info-circle me-1"></i>Select customer to view appointments</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 mt-3">
                            <div class="form-group">
                                <label class="form-label">Active Packages</label>
                                <div id="customerPackagesTable" style="max-height: 250px; overflow-y: auto; border: 1px solid var(--gray-300); border-radius: var(--radius); background: white;">
                                    <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
                                        <thead style="background: var(--gray-50); position: sticky; top: 0;">
                                            <tr>
                                                <th>PACKAGE NAME</th>
                                                <th>TYPE</th>
                                                <th>STATUS</th>
                                                <th>BALANCE</th>
                                                <th>EXPIRY</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activePackagesTableBody">
                                            {% if customer_active_packages %}
                                                {% for package in customer_active_packages %}
                                                <tr data-package-type="{{ package.package_type }}"
                                                    data-package-id="{{ package.assignment_id }}"
                                                    data-discount="{{ package.discount_percentage|default(0) }}"
                                                    data-applicable-services="{{ package.applicable_service_ids|tojson if package.applicable_service_ids else '[]' }}"
                                                    data-valid-from="{{ package.valid_from|default('') }}"
                                                    data-valid-to="{{ package.valid_to|default('') }}"
                                                    data-valid-days="{{ package.valid_days|default('') }}">
                                                    <td>
                                                        <strong>{{ package.name }}</strong>
                                                        {% if package.package_type == 'student_offer' %}
                                                            <br><small class="text-primary"><i class="fas fa-graduation-cap me-1"></i>{{ package.applicable_service_names|default('All Services') }}</small>
                                                            <br><small class="text-success"><i class="fas fa-tag me-1"></i>{{ package.discount_percentage }}% Discount</small>
                                                            {% if package.valid_days %}
                                                            <br><small class="text-info"><i class="fas fa-calendar-check me-1"></i>Valid: {{ package.valid_days }}</small>
                                                            {% endif %}
                                                        {% else %}
                                                            <br><small class="text-muted">{{ package.service_name or 'Multiple Services' }}</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if package.package_type == 'student_offer' %}
                                                            <span class="badge bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                                <i class="fas fa-graduation-cap me-1"></i>Student Offer
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-{{ 'warning' if package.benefit_type == 'free' else 'info' }}">{{ package.benefit_type|title }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td><span class="badge bg-{{ 'success' if package.is_active else 'secondary' }}">{{ 'Active' if package.is_active else 'Inactive' }}</span></td>
                                                    <td>
                                                        {% if package.package_type == 'student_offer' %}
                                                            <div class="d-flex align-items-center">
                                                                <i class="fas fa-percentage text-success me-2"></i>
                                                                <span class="fw-bold text-success">{{ package.discount_percentage }}% OFF</span>
                                                            </div>
                                                            {% if package.package_price %}
                                                            <small class="text-muted">Package: ‚Çπ{{ "%.2f"|format(package.package_price) }}</small>
                                                            {% endif %}
                                                        {% elif package.benefit_type in ['free', 'discount'] %}
                                                            <strong>{{ package.remaining_count }}/{{ package.total_allocated }} sessions</strong>
                                                            <div class="progress mt-1" style="height: 5px;">
                                                                <div class="progress-bar bg-success" style="width: {{ package.usage_percentage }}%"></div>
                                                            </div>
                                                        {% elif package.benefit_type == 'prepaid' %}
                                                            <strong>‚Çπ{{ "%.2f"|format(package.balance_remaining) }}</strong> / ‚Çπ{{ "%.2f"|format(package.balance_total) }}
                                                        {% elif package.benefit_type == 'unlimited' %}
                                                            <span class="badge bg-success">Unlimited</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if package.package_type == 'student_offer' and package.valid_to %}
                                                            <small>{{ package.valid_from }} to<br>{{ package.valid_to }}</small>
                                                            {% if package.conditions %}
                                                            <br><button type="button" class="btn btn-sm btn-outline-info mt-1"
                                                                    onclick="showStudentOfferDetails('{{ package.name }}', '{{ package.discount_percentage }}', '{{ package.applicable_service_names }}', '{{ package.valid_from }}', '{{ package.valid_to }}', '{{ package.valid_days }}', '{{ package.conditions }}')">
                                                                <i class="fas fa-info-circle"></i> Details
                                                            </button>
                                                            {% endif %}
                                                        {% else %}
                                                            {{ package.valid_to }}
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">
                                                    <i class="fas fa-box-open fa-2x mb-2"></i>
                                                    <p class="mb-0">No active packages</p>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Services Section -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-spa"></i>
                            Services
                        </h6>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addServiceRow()">
                            <i class="fas fa-plus"></i>
                            Add Service
                        </button>
                    </div>
                    <div id="servicesContainer">
                        <div class="item-row service-row">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">Service</label>
                                        <select class="form-select" name="service_ids[]" onchange="handleServiceChange(this)">
                                            <option value="">Select Service</option>
                                            {% for service in services %}
                                            <option value="{{ service.id }}" data-price="{{ service.price|float }}">
                                                {{ service.name }} - ‚Çπ{{ "{:,.2f}".format(service.price) }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label required">Staff</label>
                                        <select class="form-select" name="staff_ids[]">
                                            <option value="">Select Staff</option>
                                            {% for staff in staff_members %}
                                            <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Staff required</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Qty</label>
                                        <input type="number" class="form-control" name="service_quantities[]" value="1" min="0.5" step="0.5" oninput="updateCalculations()">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Apt ID</label>
                                        <input type="number" class="form-control" name="appointment_ids[]" placeholder="Optional">
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-box"></i>
                            Products & Inventory
                        </h6>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addProductRow()">
                            <i class="fas fa-plus"></i>
                            Add Product
                        </button>
                    </div>
                    <div id="productsContainer">
                        <div class="item-row product-row">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Product</label>
                                        <select class="form-select" name="product_ids[]" onchange="loadBatches(this)">
                                            <option value="">Select Product</option>
                                            {% for product in inventory_items %}
                                            <option value="{{ product.id }}">{{ product.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Batch</label>
                                        <select class="form-select batch-select" name="batch_ids[]" disabled>
                                            <option value="">Select Product</option>
                                        </select>
                                        <div class="batch-info"></div>
                                        <div class="invalid-feedback">Batch required</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label required">Staff</label>
                                        <select class="form-select" name="product_staff_ids[]">
                                            <option value="">Select Staff</option>
                                            {% for staff in staff_members %}
                                            <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Staff required</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Qty</label>
                                        <input type="number" class="form-control" name="product_quantities[]" value="1" min="0.01" step="0.01" oninput="updateCalculations()">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Price</label>
                                        <input type="number" class="form-control" name="product_prices[]" placeholder="‚Çπ0.00" min="0" step="0.01" oninput="updateCalculations()">
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-credit-card"></i>
                            Payment & Tax Details
                        </h6>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label required">Payment Method</label>
                                <select class="form-select" name="payment_method" required>
                                    <option value="">Select Method</option>
                                    <option value="cash" selected>Cash</option>
                                    <option value="card">Card</option>
                                    <option value="upi">UPI</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                </select>
                                <div class="invalid-feedback">Payment method required</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Discount Type</label>
                                <select class="form-select" name="discount_type" onchange="updateCalculations()">
                                    <option value="percentage">Percentage (%)</option>
                                    <option value="amount">Amount (‚Çπ)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Discount Value</label>
                                <input type="number" class="form-control" name="discount_value" value="0" min="0" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">CGST Rate (%)</label>
                                <input type="number" class="form-control" name="cgst_rate" value="9" min="0" max="100" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">SGST Rate (%)</label>
                                <input type="number" class="form-control" name="sgst_rate" value="9" min="0" max="100" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Additional Charges</label>
                                <input type="number" class="form-control" name="additional_charges" value="0" min="0" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Tips Amount</label>
                                <input type="number" class="form-control" name="tips_amount" value="0" min="0" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes" rows="3" placeholder="Add invoice notes..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary -->
            <div class="col-lg-4">
                <div class="summary-panel">
                    <h5 class="summary-header">
                        <i class="fas fa-calculator me-2"></i>
                        Bill Summary
                    </h5>

                    <div class="summary-row">
                        <span class="summary-label">Services:</span>
                        <span class="summary-value" id="servicesSubtotal">‚Çπ0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Products:</span>
                        <span class="summary-value" id="productsSubtotal">‚Çπ0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Subtotal:</span>
                        <span class="summary-value" id="subtotalAmount">‚Çπ0.00</span>
                    </div>

                    <div class="summary-row text-success">
                        <span class="summary-label">Package Benefits:</span>
                        <span class="summary-value" id="packageDeductions">-‚Çπ0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Discount:</span>
                        <span class="summary-value" id="discountAmount">-‚Çπ0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">CGST:</span>
                        <span class="summary-value" id="cgstAmount">‚Çπ0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">SGST:</span>
                        <span class="summary-value" id="sgstAmount">‚Çπ0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Additional Charges:</span>
                        <span class="summary-value" id="additionalCharges">‚Çπ0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Tips:</span>
                        <span class="summary-value" id="tipsDisplay">‚Çπ0.00</span>
                    </div>

                    <div class="grand-total" id="grandTotal">‚Çπ0.00</div>

                    <div class="summary-actions">
                        <button type="submit" class="btn btn-success btn-lg" id="saveBtn">
                            <span class="btn-text">
                                <i class="fas fa-check-circle"></i>
                                Save
                            </span>
                            <span class="btn-spinner">
                                <i class="fas fa-spinner spinner"></i>
                                Saving...
                            </span>
                        </button>

                        <button type="button" class="btn btn-info btn-lg" onclick="saveAndPrint()">
                            <i class="fas fa-print"></i>
                            Save & Print
                        </button>

                        <button type="button" class="btn btn-primary" onclick="previewInvoice()">
                            <i class="fas fa-eye"></i>
                            Preview
                        </button>
                    </div>

                    <div class="summary-footer">
                        <i class="fas fa-shield-alt me-1"></i>
                        Secure & Encrypted
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// ==========================================
// STATE MANAGEMENT
// ==========================================
const BillingState = {
    selectedCustomerId: null, // Customer ID for tracking selected customer
    customerPackages: null, // Active packages for the selected customer
    batchCache: {},
    isSubmitting: false
};

// Global variables for cart items
let selectedServices = [];
let selectedProducts = [];
let taxRate = 9; // Default tax rate

// ==========================================
// INITIALIZATION
// ==========================================
// Initialize application when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    initializeBillingSystem();
    updateCalculations(); // Initial calculation to set display to 0.00

    {% if selected_customer %}
    console.log('Pre-selected customer ID:', {{ selected_customer.id }});
    // Ensure to use the correct function name and pass ID as string or number based on API
    loadCustomerPackages({{ selected_customer.id }});
    loadCustomerAppointments({{ selected_customer.id }});
    {% endif %}
});

function initializeBillingSystem() {
    // Customer selector
    const clientSelect = document.getElementById('client_id');
    clientSelect?.addEventListener('change', function() {
        console.log('Customer selected:', this.value);
        console.log('Selected option text:', this.options[this.selectedIndex]?.text);

        if (this.value) {
            loadCustomerPackages(this.value); // Pass value directly
            loadCustomerAppointments(this.value);
        } else {
            resetCustomerPackages();
            resetCustomerAppointments();
        }
    });

    // Form submission
    const form = document.getElementById('billingForm');
    form?.addEventListener('submit', handleFormSubmit);

    // Input validation setup
    setupInputValidation();

    // Initialize cart rendering if data is pre-loaded
    // (Assuming selectedServices and selectedProducts might be populated from backend for edits)
    if (selectedServices.length > 0) renderServiceCart();
    if (selectedProducts.length > 0) renderProductCart();
}

// ==========================================
// CUSTOMER & PACKAGES
// ==========================================

// Updated function to fetch and store packages in BillingState
async function loadCustomerPackages(customerId) {
    console.log('üîÑ Loading packages for customer:', customerId);
    console.log('üìç Customer ID type:', typeof customerId);
    console.log('üìç Customer ID value:', customerId);

    // CRITICAL: Store the selected customer ID in BillingState
    BillingState.selectedCustomerId = parseInt(customerId);
    console.log('‚úÖ Set BillingState.selectedCustomerId:', BillingState.selectedCustomerId);

    try {
        const url = `/integrated-billing/customer-packages/${customerId}`;
        console.log('üåê Fetching from URL:', url);

        const response = await fetch(url);
        console.log('üì° Response status:', response.status);
        console.log('üì° Response headers:', Object.fromEntries(response.headers.entries()));

        const data = await response.json();
        console.log('üì¶ Packages loaded:', data);
        console.log('üì¶ Raw response:', JSON.stringify(data, null, 2));

        if (data.success && data.packages) {
            BillingState.customerPackages = data.packages; // Store in BillingState
            console.log('‚úÖ Successfully loaded', BillingState.customerPackages.length, 'packages');
            console.log('üìã Package details:');
            BillingState.customerPackages.forEach((pkg, index) => {
                console.log(`  Package ${index + 1}:`, {
                    name: pkg.name,
                    type: pkg.package_type,
                    service_id: pkg.service_id,
                    service_name: pkg.service_name,
                    sessions: pkg.sessions,
                    credit: pkg.credit,
                    status: pkg.status,
                    expires_on: pkg.expires_on
                });
            });
        } else {
            BillingState.customerPackages = [];
            console.log('‚ö†Ô∏è No packages returned or request failed');
            console.log('‚ö†Ô∏è Success flag:', data.success);
            console.log('‚ö†Ô∏è Packages data:', data.packages);
        }
    } catch (error) {
        console.error('‚ùå Error loading packages:', error);
        console.error('‚ùå Error stack:', error.stack);
        BillingState.customerPackages = [];
    } finally {
        // Always update calculations after loading packages, even if empty or error
        updateCalculations();
        // Also refresh the display table
        displayCustomerPackagesTable(BillingState.customerPackages || []);
    }
}


function loadCustomerAppointments(customerId) {
    const appointmentsDiv = document.getElementById('customerAppointments');
    appointmentsDiv.innerHTML = '<div style="padding: var(--spacing-md); text-align: center;"><small><i class="fas fa-spinner spinner"></i> Loading appointments...</small></div>';

    fetch(`/api/customer/${customerId}/appointments`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                displayCustomerAppointments(data.appointments || []);
            } else {
                appointmentsDiv.innerHTML = '<div style="padding: var(--spacing-xl); text-align: center; color: var(--danger);"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p class="mb-0"><strong>Error Loading Appointments</strong></p><small>Please try again</small></div>';
            }
        })
        .catch(err => {
            console.error('Error loading appointments:', err);
            appointmentsDiv.innerHTML = '<div style="padding: var(--spacing-xl); text-align: center; color: var(--danger);"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p class="mb-0"><strong>Error Loading Appointments</strong></p><small>Please try again</small></div>';
        });

    // Also load packages display
    loadCustomerPackagesDisplay(customerId);
}

function loadCustomerPackagesDisplay(customerId) {
    const packagesDiv = document.getElementById('customerPackagesTable');
    packagesDiv.innerHTML = '<div style="padding: var(--spacing-md); text-align: center;"><small><i class="fas fa-spinner spinner"></i> Loading packages...</small></div>';

    fetch(`/integrated-billing/customer-packages/${customerId}`)
        .then(res => res.json())
        .then(data => {
            // Use the new display function which handles empty packages
            displayCustomerPackagesTable(data.packages || []);
        })
        .catch(err => {
            console.error('Error loading customer packages:', err);
            packagesDiv.innerHTML = `
                <div style="padding: var(--spacing-xl); text-align: center; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p class="mb-0"><strong>Error Loading Packages</strong></p>
                    <small>Please try again</small>
                </div>`;
        });
}

function refreshCustomerPackages(customerId, updatedPackages) {
    // Immediately update UI with the updated packages or fetch fresh data
    if (updatedPackages && updatedPackages.length > 0) {
        // Update the display with fresh data
        console.log('Refreshing package display after invoice creation', updatedPackages);
    }

    // Fetch fresh packages from server (fallback or additional verification)
    fetch(`/integrated-billing/customer-packages/${customerId}`, { cache: 'no-store' })
        .then(r => r.json())
        .then(j => {
            if (j.success) {
                displayCustomerPackagesTable(j.packages);
                console.log('Package balances refreshed successfully');
            }
        })
        .catch(err => console.error('Error refreshing packages:', err));
}

function displayCustomerPackagesTable(packages) {
    const packagesDiv = document.getElementById('customerPackagesTable');

    if (!packages || packages.length === 0) {
        packagesDiv.innerHTML = `
            <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
                <thead style="background: var(--gray-50); position: sticky; top: 0;">
                    <tr>
                        <th style="padding: 0.5rem;">Package Name</th>
                        <th style="padding: 0.5rem;">Type</th>
                        <th style="padding: 0.5rem;">Status</th>
                        <th style="padding: 0.5rem;">Balance/Services</th>
                        <th style="padding: 0.5rem;">Expiry</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-box-open fa-2x mb-2"></i>
                            <p class="mb-0">No active packages</p>
                        </td>
                    </tr>
                </tbody>
            </table>`;
        return;
    }

    let html = `
        <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
            <thead style="background: var(--gray-50); position: sticky; top: 0;">
                <tr>
                    <th style="padding: 0.5rem;">Package Name</th>
                    <th style="padding: 0.5rem;">Type</th>
                    <th style="padding: 0.5rem;">Status</th>
                    <th style="padding: 0.5rem;">Balance/Services</th>
                    <th style="padding: 0.5rem;">Expiry</th>
                </tr>
            </thead>
            <tbody>`;

    packages.forEach(pkg => {
        const packageName = pkg.name || 'Unknown Package';
        const packageType = pkg.package_type || 'N/A';
        const status = pkg.status || 'active';

        // Determine status badge
        let statusBadge = '';
        if (status === 'active') {
            statusBadge = '<span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Active</span>';
        } else if (status === 'expired') {
            statusBadge = '<span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Expired</span>';
        } else if (status === 'completed') {
            statusBadge = '<span style="background: #e5e7eb; color: #374151; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Completed</span>';
        }

        // Display balance based on package type - USE EXACT FIELD NAMES FROM BACKEND
        let balanceText = '';
        let balanceDetails = '';

        if (packageType === 'prepaid') {
            // FIXED: Use correct field names from API response
            const remaining = pkg.credit?.remaining || 0;
            const total = pkg.credit?.total || 0;
            const usedPct = total > 0 ? ((total - remaining) / total * 100).toFixed(0) : 0;
            balanceText = `‚Çπ${remaining.toFixed(2)} / ‚Çπ${total.toFixed(2)}`;
            balanceDetails = `
                <div class="progress mt-1" style="height: 5px;">
                    <div class="progress-bar bg-success" style="width: ${100 - usedPct}%"></div>
                </div>`;
        } else if (packageType === 'service_package') {
            // FIXED: Use correct field names from API response (sessions.remaining and sessions.total)
            const remaining = pkg.sessions?.remaining || 0;
            const total = pkg.sessions?.total || 0;
            const usedPct = total > 0 ? ((total - remaining) / total * 100).toFixed(0) : 0;
            balanceText = `${remaining} / ${total} sessions`;
            balanceDetails = `
                <div class="progress mt-1" style="height: 5px;">
                    <div class="progress-bar bg-success" style="width: ${100 - usedPct}%"></div>
                </div>`;
        } else if (packageType === 'membership') {
            // For memberships, show unlimited badge and usage count
            const usageCount = pkg.usage_count || 0;
            balanceText = `<span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Unlimited</span>`;
            balanceDetails = `<small class="text-muted">‚úì Used ${usageCount} times</small>`;
        } else if (packageType === 'student_offer') {
            // For student offers, show discount percentage in balance column
            const discountPct = pkg.discount_percentage || 0;
            balanceText = `<span style="background: #e9d5ff; color: #6b21a8; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">${discountPct}% OFF</span>`;
            if (pkg.package_price) {
                balanceDetails = `<small class="text-muted">Package: ‚Çπ${pkg.package_price}</small>`;
            }
        }

        // Format expiry date - check both valid_to and expires_on
        let expiryDate = '';
        if (packageType === 'student_offer' && pkg.valid_from && pkg.valid_to) {
            // Show validity period for student offers
            expiryDate = `<small>${pkg.valid_from} to<br>${pkg.valid_to}</small>`;
            // Add details button if conditions exist
            if (pkg.conditions) {
                expiryDate += `<br><button type="button" class="btn btn-sm btn-outline-info mt-1" onclick="showStudentOfferDetails('${pkg.name}', '${pkg.discount_percentage}', '${pkg.applicable_service_names}', '${pkg.valid_from}', '${pkg.valid_to}', '${pkg.valid_days}', '${pkg.conditions}')"><i class="fas fa-info-circle"></i> Details</button>`;
            }
        } else {
            expiryDate = (pkg.valid_to || pkg.expires_on) ?
                new Date(pkg.valid_to || pkg.expires_on).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'No expiry';
        }

        // Type badge
        let typeBadge = '';
        if (packageType === 'prepaid') {
            typeBadge = '<span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Prepaid</span>';
        } else if (packageType === 'service_package') {
            typeBadge = '<span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Service</span>';
        } else if (packageType === 'membership') {
            typeBadge = '<span style="background: #e9d5ff; color: #6b21a8; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Membership</span>';
        } else if (packageType === 'yearly') {
            typeBadge = '<span style="background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Yearly</span>';
        } else if (packageType === 'student_offer') {
            typeBadge = '<span class="badge bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-graduation-cap me-1"></i>Student Offer</span>';
        }


        // Format service name display - ONLY for service packages
        let serviceNameDisplay = '';
        if (packageType === 'service_package' && pkg.service_name && pkg.service_name !== 'null' && pkg.service_name !== 'Any Service') {
            serviceNameDisplay = `<br><small class="text-muted"><i class="fas fa-spa"></i> ${pkg.service_name}</small>`;
        } else if (packageType === 'membership' && pkg.services && pkg.services.length > 0) {
            const serviceNames = pkg.services.map(s => s.service_name).join(', ');
            serviceNameDisplay = `<br><small class="text-muted"><i class="fas fa-spa"></i> ${serviceNames}</small>`;
        } else if (packageType === 'yearly') {
            serviceNameDisplay = `<br><small class="text-muted"><i class="fas fa-percentage"></i> ${pkg.name.split(' - ')[1]}</small>`; // Show the percentage
        } else if (packageType === 'student_offer') {
            // Enhanced student offer display
            let studentOfferDetails = '';
            if (pkg.applicable_service_names) {
                studentOfferDetails += `<br><small class="text-primary"><i class="fas fa-graduation-cap me-1"></i>${pkg.applicable_service_names}</small>`;
            }
            if (pkg.discount_percentage) {
                studentOfferDetails += `<br><small class="text-success"><i class="fas fa-tag me-1"></i>${pkg.discount_percentage}% Discount</small>`;
            }
            if (pkg.valid_days) {
                studentOfferDetails += `<br><small class="text-info"><i class="fas fa-calendar-check me-1"></i>Valid: ${pkg.valid_days}</small>`;
            }
            serviceNameDisplay = studentOfferDetails;
        }

        html += `
            <tr style="border-bottom: 1px solid var(--gray-200);">
                <td style="padding: 0.5rem;">
                    <strong>${packageName}</strong>
                    ${serviceNameDisplay}
                </td>
                <td style="padding: 0.5rem;">${typeBadge}</td>
                <td style="padding: 0.5rem;">${statusBadge}</td>
                <td style="padding: 0.5rem;">
                    <strong style="font-size: 1.1em;">${balanceText}</strong>
                    ${balanceDetails}
                </td>
                <td style="padding: 0.5rem;">
                    <small>${expiryDate}</small>
                </td>
            </tr>`;
    });

    html += `
            </tbody>
        </table>`;

    packagesDiv.innerHTML = html;
}


function resetCustomerAppointments() {
    // Clear tracking when customer changes
    addedAppointmentIds.clear();
    document.getElementById('customerAppointments').innerHTML =
        '<div style="padding: var(--spacing-md); text-align: center; color: var(--gray-500);"><small><i class="fas fa-info-circle"></i> Select customer to view appointments</small></div>';

    // Also reset packages table
    document.getElementById('customerPackagesTable').innerHTML =
        '<div style="padding: var(--spacing-md); text-align: center; color: var(--gray-500);"><small><i class="fas fa-gift"></i> Select customer to view active packages</small></div>';
}


// Track which appointments have been added to bill
const addedAppointmentIds = new Set();

function displayCustomerAppointments(appointments) {
    const appointmentsDiv = document.getElementById('customerAppointments');

    if (!appointments || !appointments.length) {
        appointmentsDiv.innerHTML = `
            <div style="padding: var(--spacing-xl); text-align: center; color: var(--gray-500);">
                <i class="fas fa-calendar-times fa-2x mb-2" style="opacity: 0.5;"></i>
                <p class="mb-0"><strong>No Booked Appointments</strong></p>
                <small>This customer has no confirmed appointments ready for billing</small>
            </div>`;
        return;
    }

    let html = `
        <div style="padding: 0;">
            <div style="background: var(--gray-50); padding: 8px 12px; border-bottom: 1px solid var(--gray-300);">
                <small style="color: var(--gray-600);"><i class="fas fa-info-circle me-1"></i>Click "Add to Bill" to include appointment in invoice</small>
            </div>
            <table class="table table-sm mb-0" style="font-size: 0.875rem;">
                <thead style="background: var(--gray-100); position: sticky; top: 0; z-index: 1;">
                    <tr>
                        <th style="padding: 8px;">Service</th>
                        <th style="padding: 8px;">Staff</th>
                        <th style="padding: 8px;">Date & Time</th>
                        <th style="padding: 8px; text-align: right;">Price</th>
                        <th style="padding: 8px; width: 120px;">Action</th>
                    </tr>
                </thead>
                <tbody>`;

    appointments.forEach(apt => {
        const aptDate = new Date(apt.appointment_date);
        const dateStr = aptDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const timeStr = apt.start_time || aptDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

        const statusBadge = apt.status === 'completed' ?
            '<span class="badge bg-success" style="font-size: 0.7rem;">Done</span>' :
            apt.status === 'confirmed' ?
            '<span class="badge bg-info" style="font-size: 0.7rem;">Confirmed</span>' :
            '<span class="badge bg-warning" style="font-size: 0.7rem;">Scheduled</span>';

        const isAdded = addedAppointmentIds.has(apt.id);

        // Safely escape service and staff names
        const serviceName = (apt.service_name || 'Service not specified').replace(/'/g, "\\'").replace(/"/g, '\\"');
        const staffName = (apt.staff_name || 'Not assigned').replace(/'/g, "\\'").replace(/"/g, '\\"');

        html += `
            <tr style="border-bottom: 1px solid var(--gray-200); ${isAdded ? 'background: #f0f0f0;' : ''}">
                <td style="padding: 8px;">
                    <div style="font-weight: 600; color: var(--gray-900);">${apt.service_name || 'Service not specified'}</div>
                    <small style="color: var(--gray-500);">${apt.service_duration ? apt.service_duration + ' min' : ''} ${statusBadge}</small>
                </td>
                <td style="padding: 8px;">
                    <small style="color: var(--gray-700);">${apt.staff_name || 'Not assigned'}</small>
                </td>
                <td style="padding: 8px;">
                    <small style="color: var(--gray-700);">${dateStr}<br>${timeStr}</small>
                </td>
                <td style="padding: 8px; text-align: right;">
                    <strong style="color: var(--primary);">‚Çπ${(apt.service_price || 0).toFixed(2)}</strong>
                </td>
                <td style="padding: 8px;">
                    <button type="button"
                            class="btn btn-sm ${isAdded ? 'btn-success' : 'btn-primary'} w-100"
                            onclick="addAppointmentToBill(${apt.id}, '${serviceName}', ${apt.service_id || 'null'}, ${apt.staff_id || 'null'}, ${apt.service_price || 0}, ${apt.service_duration || 60})"
                            ${isAdded ? 'disabled' : ''}
                            style="font-size: 0.75rem; padding: 4px 8px;">
                        ${isAdded ? '<i class="fas fa-check"></i> Added' : '<i class="fas fa-plus"></i> Add'}
                    </button>
                </td>
            </tr>`;
    });

    html += `
                </tbody>
            </table>
        </div>`;

    appointmentsDiv.innerHTML = html;
}

function resetCustomerPackages() {
    BillingState.customerPackages = null; // Clear from state
    addedAppointmentIds.clear(); // Also clear added appointments tracking
    updateCalculations();
    displayCustomerPackagesTable([]); // Clear the display table
}


function addAppointmentToBill(appointmentId, serviceName, serviceId, staffId, servicePrice, serviceDuration) {
    console.log(`Adding appointment ${appointmentId} to bill - Service: ${serviceName}, ServiceID: ${serviceId}, StaffID: ${staffId}, Price: ${servicePrice}`);

    const container = document.getElementById('servicesContainer');
    if (!container) {
        console.error('Services container not found');
        return;
    }

    // Try to find an existing row for this appointment or add a new one
    let targetRow = null;
    const existingRows = container.querySelectorAll('.service-row');
    for (const row of existingRows) {
        const appointmentInput = row.querySelector('input[name="appointment_ids[]"]');
        if (appointmentInput && appointmentInput.dataset.appointmentId == appointmentId) {
            targetRow = row;
            break;
        }
    }

    if (!targetRow) {
        // If no existing row, add a new one
        addServiceRow(); // This adds a new row at the end
        targetRow = container.lastElementChild; // Get the newly added row
    }

    // Populate the target row
    const serviceSelect = targetRow.querySelector('select[name="service_ids[]"]');
    const staffSelect = targetRow.querySelector('select[name="staff_ids[]"]');
    const qtyInput = targetRow.querySelector('input[name="service_quantities[]"]');
    const appointmentInput = targetRow.querySelector('input[name="appointment_ids[]"]');

    // Set values from appointment data
    if (serviceId !== 'null' && serviceSelect) { // Check if serviceId is not null
        serviceSelect.value = serviceId;
    }

    if (staffId !== 'null' && staffSelect) { // Check if staffId is not null
        staffSelect.value = staffId;
    }

    if (qtyInput) {
        qtyInput.value = 1; // Default quantity to 1 for appointment
    }

    if (appointmentInput) {
        appointmentInput.value = appointmentId;
        appointmentInput.dataset.appointmentId = appointmentId; // Store ID for tracking
        appointmentInput.dataset.servicePrice = servicePrice; // Store price for accurate calculation
        appointmentInput.dataset.serviceDuration = serviceDuration; // Store duration
        console.log(`‚úÖ Set appointment ID ${appointmentId} in row`);
    }

    // Mark as added
    addedAppointmentIds.add(appointmentId);
    console.log('Tracking added appointment ID:', appointmentId);

    // CRITICAL: Trigger service change event AFTER all values are set to apply package benefits
    if (serviceId !== 'null' && serviceSelect) {
        console.log('üéØ Triggering service change to apply package benefits for appointment', appointmentId);
        serviceSelect.dispatchEvent(new Event('change', { bubbles: true }));
    }

    // Force recalculation after package benefits are applied
    updateCalculations();

    // Refresh appointments display to show "Added" button state
    const clientId = document.getElementById('client_id').value;
    if (clientId) {
        loadCustomerAppointments(clientId);
    }
}

function removeAppointmentFromBill(appointmentId) {
    const container = document.getElementById('servicesContainer');
    if (!container) return;

    // Find and remove the row with this appointment ID
    const rows = container.querySelectorAll('.service-row');
    let rowToRemove = null;
    for (const row of rows) {
        const appointmentInput = row.querySelector('input[name="appointment_ids[]"]');
        if (appointmentInput && appointmentInput.dataset.appointmentId == appointmentId) {
            rowToRemove = row;
            break;
        }
    }

    if (rowToRemove) {
        // If it's the only row and it contains this appointment, clear it instead of removing
        if (rows.length === 1 && rowToRemove.querySelector('input[name="appointment_ids[]"]')?.dataset.appointmentId == appointmentId) {
            // Clear inputs but keep the row structure
            rowToRemove.querySelectorAll('select, input').forEach(input => {
                input.value = ''; // Clear all values
                if (input.name?.includes('appointment_ids[]')) {
                    delete input.dataset.appointmentId; // Remove tracking attribute
                    delete input.dataset.servicePrice;
                    delete input.dataset.serviceDuration;
                }
            });
            // Also reset quantity to 1 if it exists
            const qtyInput = rowToRemove.querySelector('input[name="service_quantities[]"]');
            if (qtyInput) qtyInput.value = 1;

            console.log(`Cleared inputs in existing row for appointment ID ${appointmentId}`);
        } else {
            rowToRemove.remove(); // Remove the entire row
            console.log(`Removed row associated with appointment ID ${appointmentId}`);
        }
    }

    // Remove from tracking set
    addedAppointmentIds.delete(appointmentId);
    console.log('Removed appointment ID from tracking:', appointmentId);

    updateCalculations();

    // Refresh appointments display to show "Add" button state
    const clientId = document.getElementById('client_id').value;
    if (clientId) {
        loadCustomerAppointments(clientId);
    }
}

// ==========================================
// BATCH MANAGEMENT
// ==========================================
function loadBatches(productSelect) {
    const row = productSelect.closest('.item-row');
    const batchSelect = row.querySelector('.batch-select');
    const batchInfo = row.querySelector('.batch-info');
    const priceInput = row.querySelector('input[name="product_prices[]"]');
    const productId = parseInt(productSelect.value);

    console.log('üîÑ loadBatches called for product:', productId);

    if (!productId) {
        batchSelect.innerHTML = '<option value="">Select Product</option>';
        batchSelect.disabled = true;
        batchInfo.innerHTML = '';
        if (priceInput) priceInput.value = '';
        updateCalculations(); // Recalculate in case product was deselected
        return;
    }

    // Check cache first
    if (BillingState.batchCache[productId]) {
        console.log('üóÑÔ∏è Cache hit for product ID:', productId);
        populateBatchSelect(BillingState.batchCache[productId], batchSelect, batchInfo, priceInput);
        return;
    }

    // Load from API
    console.log('üóÑÔ∏è Cache miss for product ID:', productId, 'Fetching batches...');
    batchSelect.innerHTML = '<option value="">Loading...</option>';
    batchSelect.disabled = true;
    if (priceInput) priceInput.value = '';

    fetch(`/api/inventory/batches/for-product/${productId}`)
        .then(res => {
            console.log('üì° Batch API response status:', res.status);
            if (!res.ok) throw new Error(`HTTP error ${res.status}`);
            return res.json();
        })
        .then(data => {
            console.log('üì¶ Batch API response data:', data);
            if (data.success && data.batches) {
                const batches = data.batches || [];
                BillingState.batchCache[productId] = batches; // Cache the result
                populateBatchSelect(batches, batchSelect, batchInfo, priceInput);
            } else {
                throw new Error(data.message || 'Failed to load batches from API');
            }
        })
        .catch(err => {
            console.error('‚ùå Error loading batches:', err);
            console.error('‚ùå Error stack:', err.stack);
            batchSelect.innerHTML = '<option value="">Error loading batches</option>';
            batchInfo.innerHTML = '<span class="text-danger">Failed to load batches</span>';
        });
}

function populateBatchSelect(batches, batchSelect, batchInfo, priceInput) {
    // Filter available batches and sort by expiry (FIFO)
    const availableBatches = batches
        .filter(b => b.qty_available > 0)
        .sort((a, b) => {
            // Prioritize batches with expiry dates, sort by date
            if (a.expiry_date && b.expiry_date) {
                return new Date(a.expiry_date) - new Date(b.expiry_date);
            } else if (a.expiry_date) {
                return -1; // a has expiry, b doesn't, so a comes first
            } else if (b.expiry_date) {
                return 1; // b has expiry, a doesn't, so b comes first
            }
            return 0; // Both have no expiry, order doesn't matter
        });

    console.log('üî¢ Available batches after filtering and sorting:', availableBatches);

    if (!availableBatches.length) {
        batchSelect.innerHTML = '<option value="">Out of Stock</option>';
        batchSelect.disabled = true;
        batchInfo.innerHTML = '<span class="text-danger">Out of stock</span>';
        if (priceInput) priceInput.value = '';
        updateCalculations(); // Recalculate
        return;
    }

    batchSelect.innerHTML = availableBatches.map((b, i) =>
        `<option value="${b.id}" data-price="${b.selling_price || b.unit_price || 0}" data-qty="${b.qty_available}" ${i === 0 ? 'selected' : ''}>
            ${b.batch_name} - ${b.qty_available} available
        </option>`
    ).join('');
    batchSelect.disabled = false;

    // Display first batch info
    const firstBatch = availableBatches[0];
    const expiry = firstBatch.expiry_date ?
        new Date(firstBatch.expiry_date).toLocaleDateString() : 'No expiry';
    const expiryClass = firstBatch.is_near_expiry ? 'text-warning' : '';
    batchInfo.innerHTML = `<small>Avail: ${firstBatch.qty_available} | <span class="${expiryClass}">Exp: ${expiry}</span></small>`;

    // Set price from batch
    if (priceInput && (firstBatch.selling_price || firstBatch.unit_price)) {
        priceInput.value = parseFloat(firstBatch.selling_price || firstBatch.unit_price).toFixed(2);
    } else if (priceInput) {
        priceInput.value = '0.00'; // Default to 0 if no price found
    }

    // Add event listener for batch change (only if not already added to prevent duplicates)
    if (!batchSelect.dataset.changeListenerAdded) {
        batchSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const qty = selectedOption.dataset.qty;
            const price = selectedOption.dataset.price;
            const batch = availableBatches.find(b => b.id == this.value);

            console.log('‚ñ∂Ô∏è Batch selection changed:', { value: this.value, price, qty });

            if (batch) {
                const exp = batch.expiry_date ? new Date(batch.expiry_date).toLocaleDateString() : 'No expiry';
                const expClass = batch.is_near_expiry ? 'text-warning' : '';
                batchInfo.innerHTML = `<small>Avail: ${qty} | <span class="${expClass}">Exp: ${exp}</span></small>`;

                if (priceInput && price) {
                    priceInput.value = parseFloat(price).toFixed(2);
                } else if (priceInput) {
                    priceInput.value = '0.00'; // Default if price is missing
                }
            }
            updateCalculations();
        });
        batchSelect.dataset.changeListenerAdded = 'true'; // Mark as added
    }

    updateCalculations();
}

// ==========================================
// ROW MANAGEMENT
// ==========================================
function addServiceRow() {
    console.log('‚ûï addServiceRow called');
    const container = document.getElementById('servicesContainer');
    const firstRow = container.querySelector('.service-row'); // Get the template row

    if (!firstRow) {
        console.error('Template service row not found!');
        return;
    }

    const newRow = firstRow.cloneNode(true); // Clone the template row

    // Clear values in the new row, except for quantity which should default to 1
    newRow.querySelectorAll('select, input').forEach(input => {
        input.value = ''; // Clear all select and input values
        input.classList.remove('is-invalid'); // Remove validation classes

        // Reset quantity input to default value
        if (input.type === 'number' && input.name.includes('quantities')) {
            input.value = '1';
        }
        // Remove appointment tracking data if present
        if (input.name.includes('appointment_ids[]')) {
            delete input.dataset.appointmentId;
            delete input.dataset.servicePrice;
            delete input.dataset.serviceDuration;
        }
    });

    // Ensure remove button is visible on new rows
    const removeButton = newRow.querySelector('.btn-danger');
    if (removeButton) removeButton.style.display = 'block';

    container.appendChild(newRow); // Append the new row
    console.log('‚úÖ New service row added');
}

function addProductRow() {
    console.log('‚ûï addProductRow called');
    const container = document.getElementById('productsContainer');
    const firstRow = container.querySelector('.product-row'); // Get the template row

    if (!firstRow) {
        console.error('Template product row not found!');
        return;
    }

    const newRow = firstRow.cloneNode(true); // Clone the template row

    // Clear values in the new row
    newRow.querySelectorAll('select, input').forEach(input => {
        input.value = '';
        input.classList.remove('is-invalid');

        if (input.type === 'number' && input.name.includes('quantities')) {
            input.value = '1';
        }
    });

    // Reset batch select to default state
    const batchSelect = newRow.querySelector('.batch-select');
    batchSelect.innerHTML = '<option value="">Select Product</option>';
    batchSelect.disabled = true;
    newRow.querySelector('.batch-info').innerHTML = '';
    if (newRow.querySelector('input[name="product_prices[]"]')) {
        newRow.querySelector('input[name="product_prices[]"]').value = '';
    }

    // Ensure remove button is visible
    const removeButton = newRow.querySelector('.btn-danger');
    if (removeButton) removeButton.style.display = 'block';

    container.appendChild(newRow);
    console.log('‚úÖ New product row added');
}

function removeRow(button) {
    console.log('üóëÔ∏è removeRow called for button:', button);
    const row = button.closest('.item-row');
    if (row) {
        row.remove();
        console.log('‚úÖ Row removed');
        updateCalculations(); // Recalculate totals after removing a row
    } else {
        console.error('Could not find closest .item-row to remove');
    }
}

// ==========================================
// CALCULATIONS
// ==========================================
function handleServiceChange(selectElement) {
    console.log('‚ñ∂Ô∏è handleServiceChange triggered for select:', selectElement);

    const row = selectElement.closest('.service-row');
    if (!row) return;

    const selectedOption = selectElement.options[selectElement.selectedIndex];
    if (!selectedOption || !selectedOption.value) {
        // Clear package benefits if service is deselected
        row.querySelector('.package-benefit')?.remove();
        updateCalculations();
        return;
    }

    const serviceId = parseInt(selectedOption.value); // Convert to number
    const servicePrice = parseFloat(selectedOption.dataset.price) || 0;

    // Set the service price in a data attribute for calculations
    row.dataset.serviceId = serviceId;
    row.dataset.basePrice = servicePrice;

    console.log('üîÑ Service changed - checking for package benefits:', { serviceId, servicePrice });

    // Check and apply package benefits for this service
    const qtyInput = row.querySelector('input[name="service_quantities[]"]');
    const quantity = parseFloat(qtyInput?.value) || 1;

    // Check if customer is selected
    const customerId = BillingState.selectedCustomerId;
    if (customerId && BillingState.customerPackages && BillingState.customerPackages.length > 0) {
        console.log('üéÅ Customer selected with packages - applying benefits');
        
        // Apply package benefit check
        const benefit = checkPackageBenefit(serviceId, servicePrice, quantity);
        
        // Visual feedback for package application
        if (benefit && benefit.discount > 0) {
            let benefitDiv = row.querySelector('.package-benefit');
            if (!benefitDiv) {
                benefitDiv = document.createElement('div');
                row.appendChild(benefitDiv);
            }

            if (benefit.benefitType === 'student_discount') {
                benefitDiv.className = 'package-benefit student-discount';
                benefitDiv.innerHTML = `<i class="fas fa-graduation-cap"></i> ${benefit.packageUsed}: -‚Çπ${benefit.discount.toFixed(2)}`;
            } else {
                benefitDiv.className = 'package-benefit';
                benefitDiv.innerHTML = `<i class="fas fa-gift"></i> ${benefit.packageUsed}: -‚Çπ${benefit.discount.toFixed(2)}`;
            }
        } else {
            // Remove benefit indicator if no benefit applies
            row.querySelector('.package-benefit')?.remove();
        }
    }

    // Update calculations immediately to apply package benefits
    updateCalculations();
}

function updateCalculations() {
    console.log('üí∞ updateCalculations called');

    let servicesSubtotal = 0;
    let productsSubtotal = 0;
    let packageDeductions = 0;

    // --- Calculate Services Subtotal ---
    console.log('üîÑ Calculating services subtotal...');
    document.querySelectorAll('.service-row').forEach((row, index) => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const qtyInput = row.querySelector('input[name="service_quantities[]"]');
        const appointmentIdInput = row.querySelector('input[name="appointment_ids[]"]');
        const priceInput = row.querySelector('input[name="service_prices[]"]'); // Assuming a hidden price input

        const serviceId = serviceSelect?.value;
        const quantity = parseFloat(qtyInput?.value) || 0;
        let basePrice = parseFloat(serviceSelect.selectedOptions[0]?.dataset.price) || 0; // Get base price from dataset initially

        // If a price input exists, use its value as it might be updated by package benefits or explicitly set
        if (priceInput && priceInput.value) {
             basePrice = parseFloat(priceInput.value);
        }

        let effectivePrice = basePrice; // Start with the base price
        let itemTotal = 0;
        let benefitApplied = { discount: 0, packageUsed: null, packageId: null, benefitType: null };

        // Check if it's an appointment row
        const isAppointmentRow = appointmentIdInput && appointmentIdInput.value;
        if (isAppointmentRow) {
            const appointmentPrice = parseFloat(appointmentIdInput.dataset.servicePrice);
            const appointmentDuration = parseFloat(appointmentIdInput.dataset.serviceDuration);

            if (!isNaN(appointmentPrice)) {
                effectivePrice = appointmentPrice; // Use the price from the appointment
                // Quantity for appointments is usually 1, but we use it for calculation
                itemTotal = effectivePrice * quantity;
                console.log('‚ûï Appointment row item total:', { quantity, effectivePrice, itemTotal });
            } else {
                console.warn('‚ö†Ô∏è Appointment row detected but price is missing.');
                itemTotal = 0; // Cannot calculate if price is missing
            }
            // Package benefits typically don't apply to services already covered by an appointment
            benefitApplied = { discount: 0, packageUsed: null, packageId: null, benefitType: null };
            row.querySelector('.package-benefit')?.remove(); // Remove any previous benefit indicator
        } else if (serviceId && quantity > 0) {
            // Apply package benefits only if it's NOT an appointment row
            benefitApplied = checkPackageBenefit(serviceId, basePrice, quantity);
            console.log('üéÅ Package benefit for service row:', { serviceId, basePrice, quantity, benefitApplied });

            if (benefitApplied.discount > 0) {
                const discountAmount = Math.min(benefitApplied.discount, basePrice * quantity); // Ensure discount doesn't exceed item total
                packageDeductions += discountAmount;

                // Calculate effective price after benefit per unit
                effectivePrice = Math.max(0, basePrice - discountAmount / quantity);
                itemTotal = effectivePrice * quantity; // Item total after applying benefit

                if (priceInput) {
                    priceInput.value = effectivePrice.toFixed(2);
                    console.log(`‚¨ÜÔ∏è Updated priceInput in row due to package benefit: ${priceInput.value}`);
                }

                // Show package benefit indicator on the row
                let benefitDiv = row.querySelector('.package-benefit');
                if (!benefitDiv) {
                    benefitDiv = document.createElement('div');
                    benefitDiv.className = 'package-benefit';
                    row.appendChild(benefitDiv);
                }

                // Apply special styling for student offers
                if (benefitApplied.benefitType === 'student_discount') {
                    benefitDiv.className = 'package-benefit student-discount';
                    benefitDiv.innerHTML = `<i class="fas fa-graduation-cap"></i> Student Discount (${benefitApplied.packageUsed}): -‚Çπ${discountAmount.toFixed(2)}`;
                } else {
                    benefitDiv.className = 'package-benefit';
                    benefitDiv.innerHTML = `<i class="fas fa-gift"></i> Package Benefit (${benefitApplied.packageUsed || benefitApplied.benefitType}): -‚Çπ${discountAmount.toFixed(2)}`;
                }
            } else {
                // No benefit applied, ensure price input is updated with base price if it exists
                if (priceInput) {
                    priceInput.value = basePrice.toFixed(2);
                }
                row.querySelector('.package-benefit')?.remove(); // Remove benefit indicator if no benefit
                itemTotal = basePrice * quantity; // Item total is just base price * quantity
            }
            console.log('‚ûï Service row added to subtotal:', { serviceId, quantity, basePrice, effectivePrice, itemTotal, benefitApplied });
        } else if (serviceSelect && !serviceId) {
            // If serviceSelect is empty, clear related fields and remove benefit
            row.querySelector('.package-benefit')?.remove();
            if (priceInput) priceInput.value = ''; // Clear price input if service is deselected
        }

        // Only add to subtotal if it's a valid item and not an appointment row that couldn't be priced
        if (serviceId && quantity > 0 && !isNaN(itemTotal) && itemTotal >= 0) {
             servicesSubtotal += itemTotal;
        } else if (isAppointmentRow && !isNaN(itemTotal) && itemTotal >= 0) {
            // Add to subtotal even if it's an appointment row, as long as it's calculable
            servicesSubtotal += itemTotal;
        }
    });

    // --- Calculate Products Subtotal ---
    console.log('üîÑ Calculating products subtotal...');
    document.querySelectorAll('.product-row').forEach((row, index) => {
        const qtyInput = row.querySelector('input[name="product_quantities[]"]');
        const priceInput = row.querySelector('input[name="product_prices[]"]');
        const quantity = parseFloat(qtyInput?.value) || 0;
        const price = parseFloat(priceInput?.value) || 0; // Price entered by user or from batch

        if (quantity > 0 && price > 0) {
            const itemTotal = price * quantity;
            productsSubtotal += itemTotal;
            console.log('‚ûï Product row added to subtotal:', { quantity, price, itemTotal });
        } else if (qtyInput && priceInput && (quantity <= 0 || price <= 0)) {
             console.log('‚ö†Ô∏è Product row skipped due to zero quantity or price:', { quantity, price });
        }
    });

    const subtotal = servicesSubtotal + productsSubtotal;

    // --- Discount Calculation ---
    const discountType = document.querySelector('select[name="discount_type"]')?.value || 'percentage';
    const discountValue = parseFloat(document.querySelector('input[name="discount_value"]')?.value) || 0;
    let discountAmount = 0;

    // Discount applies after package benefits
    // Note: Package benefits are already applied to itemTotal, so subtotal already reflects the reduced prices
    const taxableAmountBeforeDiscount = Math.max(0, subtotal);

    if (discountType === 'percentage') {
        discountAmount = (taxableAmountBeforeDiscount * discountValue) / 100;
    } else { // 'amount'
        discountAmount = discountValue;
    }
    discountAmount = Math.max(0, discountAmount); // Ensure discount is not negative

    // --- Calculate Taxable Amount ---
    const taxableAmountAfterTax = Math.max(0, taxableAmountBeforeDiscount - discountAmount);

    // --- Tax Calculation ---
    const cgstRate = parseFloat(document.querySelector('input[name="cgst_rate"]')?.value) || 0;
    const sgstRate = parseFloat(document.querySelector('input[name="sgst_rate"]')?.value) || 0;
    const cgst = (taxableAmountAfterTax * cgstRate) / 100;
    const sgst = (taxableAmountAfterTax * sgstRate) / 100;

    // --- Additional Charges & Tips ---
    const additionalCharges = parseFloat(document.querySelector('input[name="additional_charges"]')?.value) || 0;
    const tips = parseFloat(document.querySelector('input[name="tips_amount"]')?.value) || 0;

    // --- Grand Total ---
    const grandTotal = taxableAmountAfterTax + cgst + sgst + additionalCharges + tips;

    // --- Update Display ---
    document.getElementById('servicesSubtotal').textContent = `‚Çπ${servicesSubtotal.toFixed(2)}`;
    document.getElementById('productsSubtotal').textContent = `‚Çπ${productsSubtotal.toFixed(2)}`;
    document.getElementById('subtotalAmount').textContent = `‚Çπ${subtotal.toFixed(2)}`;
    document.getElementById('packageDeductions').textContent = `-‚Çπ${packageDeductions.toFixed(2)}`;
    document.getElementById('discountAmount').textContent = `-‚Çπ${discountAmount.toFixed(2)}`;
    document.getElementById('cgstAmount').textContent = `‚Çπ${cgst.toFixed(2)}`;
    document.getElementById('sgstAmount').textContent = `‚Çπ${sgst.toFixed(2)}`;
    document.getElementById('additionalCharges').textContent = `‚Çπ${additionalCharges.toFixed(2)}`;
    document.getElementById('tipsDisplay').textContent = `‚Çπ${tips.toFixed(2)}`;
    document.getElementById('grandTotal').textContent = `‚Çπ${grandTotal.toFixed(2)}`;

    console.log('üìä Totals Updated:', {
        servicesSubtotal: servicesSubtotal.toFixed(2),
        productsSubtotal: productsSubtotal.toFixed(2),
        subtotal: subtotal.toFixed(2),
        packageDeductions: packageDeductions.toFixed(2),
        discountAmount: discountAmount.toFixed(2),
        taxableAmountAfterTax: taxableAmountAfterTax.toFixed(2),
        cgst: cgst.toFixed(2),
        sgst: sgst.toFixed(2),
        additionalCharges: additionalCharges.toFixed(2),
        tips: tips.toFixed(2),
        grandTotal: grandTotal.toFixed(2)
    });
    console.log('‚úÖ Calculations complete');
}

// Function to check package benefits for a given service
// IMPORTANT: This now calls the backend API for real-time benefit calculation
function checkPackageBenefit(serviceId, servicePrice, quantity = 1) {
    // CRITICAL: Convert serviceId to number for proper comparison
    const numericServiceId = parseInt(serviceId);

    console.log('üîç checkPackageBenefit called:', {serviceId: numericServiceId, servicePrice, quantity});
    console.log('üìä Input validation:', {
        serviceIdType: typeof numericServiceId,
        servicePriceType: typeof servicePrice,
        quantityType: typeof quantity,
        serviceIdValue: numericServiceId,
        servicePriceValue: servicePrice,
        quantityValue: quantity
    });

    // Quick check: if no customer selected, no benefits apply
    if (!BillingState.selectedCustomerId) {
        console.log('‚ÑπÔ∏è No customer selected - no benefits');
        return { discount: 0, packageUsed: null, packageId: null, benefitType: null };
    }

    // Use cached packages for quick client-side display
    const customerPackages = BillingState.customerPackages;

    if (!customerPackages || customerPackages.length === 0) {
        console.log('‚ÑπÔ∏è No packages available for customer');
        console.log('üì¶ customerPackages state:', customerPackages);
        return { discount: 0, packageUsed: null, packageId: null, benefitType: null };
    }

    console.log('üì¶ Total packages to check:', customerPackages.length);

    let totalBenefit = 0;
    let appliedPackage = null;
    let appliedPackageId = null;
    let benefitType = null;

    // Check each package
    for (const pkg of customerPackages) {
        console.log(`üîç Checking package: ${pkg.name} (type: ${pkg.package_type})`);

        // Skip packages that are explicitly inactive or expired
        if (pkg.status === 'expired' || pkg.status === 'completed' || pkg.is_active === false) {
             console.log('‚è≠Ô∏è Package skipped (expired/completed):', pkg.name);
             continue;
        }

        // Check if package has remaining benefits based on package_type
        if (pkg.package_type === 'service_package') {
            const remaining = pkg.sessions?.remaining || 0;
            if (remaining <= 0) {
                console.log('‚è≠Ô∏è Package skipped (no sessions):', pkg.name);
                continue;
            }
        } else if (pkg.package_type === 'prepaid') {
            const remaining = pkg.credit?.remaining || 0;
            if (remaining <= 0) {
                console.log('‚è≠Ô∏è Package skipped (no credit):', pkg.name);
                continue;
            }
        }

        // --- PRIORITY 1: Yearly membership - applies percentage discount to ALL services ---
        if (pkg.package_type === 'yearly') {
            // Extract discount percentage from package name (e.g., "Gold Membership - 20% Discount")
            const discountMatch = pkg.name.match(/(\d+)%/);
            if (discountMatch) {
                const discountPercent = parseInt(discountMatch[1]);
                const totalServiceCost = servicePrice * quantity;
                totalBenefit = (totalServiceCost * discountPercent) / 100;
                appliedPackage = pkg.name;
                benefitType = 'yearly_discount';
                console.log(`‚úÖ Yearly membership discount applied: ${pkg.name}, ${discountPercent}% off = ‚Çπ${totalBenefit.toFixed(2)}`);
                break; // Use first matching yearly package
            } else {
                console.log('‚è≠Ô∏è Yearly package found but no percentage in name:', pkg.name);
            }
        }

        // --- PRIORITY 2: Service Package / Free Session Logic ---
        else if (pkg.package_type === 'service_package') {
            // CRITICAL: Convert package service_id to number for comparison
            const packageServiceId = parseInt(pkg.service_id);

            console.log(`üîç Service package match check:`, {
                packageServiceId: packageServiceId,
                requestedServiceId: numericServiceId,
                match: packageServiceId === numericServiceId,
                remainingSessions: pkg.sessions?.remaining || 0
            });

            if (packageServiceId === numericServiceId && pkg.sessions && pkg.sessions.remaining > 0) {
                const sessionsToUse = Math.min(quantity, pkg.sessions.remaining);
                const pricePerSession = servicePrice;
                const benefitAmount = pricePerSession * sessionsToUse;

                totalBenefit += benefitAmount;
                appliedPackage = pkg.name;
                appliedPackageId = pkg.assignment_id || pkg.id;
                benefitType = 'free_sessions';

                console.log('   Benefit Details:', {
                    sessionsToUse,
                    benefitAmount: benefitAmount.toFixed(2),
                    remainingAfter: pkg.sessions.remaining - sessionsToUse
                });

                break; // First matching package wins
            } else {
                console.log('‚ùå Service package NOT applied (no sessions):', {
                    packageService: packageServiceId,
                    selectedService: numericServiceId,
                    remaining: pkg.sessions?.remaining || 0
                });
            }
        }
        // --- PRIORITY 3: Prepaid / Credit Package Logic ---
        else if (pkg.package_type === 'prepaid') {
            const remaining = pkg.credit?.remaining || 0;
            const serviceCost = servicePrice * quantity;

            if (remaining > 0 && serviceCost > 0) {
                const creditToUse = Math.min(serviceCost, remaining);
                console.log('‚úÖ Prepaid credit APPLIED:', {
                    packageId: pkg.assignment_id,
                    packageName: pkg.name,
                    creditRemaining: remaining,
                    serviceCost: serviceCost.toFixed(2),
                    creditToUse: creditToUse.toFixed(2)
                });

                totalBenefit += creditToUse;
                appliedPackage = pkg.name;
                appliedPackageId = pkg.assignment_id || pkg.id;
                benefitType = 'prepaid_credit';

                break; // First matching package wins
            } else {
                console.log('‚ùå Prepaid credit NOT applied:', {
                    hasRemaining: remaining > 0,
                    serviceCostPositive: serviceCost > 0
                });
            }
        }
        // --- PRIORITY 4: Membership Package Logic ---
        else if (pkg.package_type === 'membership' && pkg.status === 'active') {
            // Memberships provide unlimited access ONLY to specific included services
            const includedServices = pkg.services || [];
            const includedServiceIds = includedServices.map(s => s.service_id);

            console.log('üé´ Checking membership:', {
                packageName: pkg.name,
                includedServiceIds: includedServiceIds,
                requestedServiceId: numericServiceId,
                isServiceIncluded: includedServiceIds.includes(numericServiceId)
            });

            // Check if the requested service is included in the membership
            if (includedServiceIds.includes(numericServiceId)) {
                const serviceCost = servicePrice * quantity;

                console.log('‚úÖ Membership APPLIED (unlimited access):', {
                    packageId: pkg.assignment_id || pkg.id,
                    packageName: pkg.name,
                    serviceName: includedServices.find(s => s.service_id == numericServiceId)?.service_name || 'Unknown',
                    serviceCost: serviceCost.toFixed(2),
                    quantity: quantity
                });

                totalBenefit += serviceCost;
                appliedPackage = pkg.name;
                appliedPackageId = pkg.assignment_id || pkg.id;
                benefitType = 'membership_unlimited';

                break; // First matching package wins
            } else {
                console.log('‚è≠Ô∏è Membership skipped (service not included):', {
                    packageName: pkg.name,
                    requestedServiceId: numericServiceId,
                    includedServices: includedServices.map(s => s.service_name)
                });
            }
        }
        // --- PRIORITY 5: Student Offer packages ---
        else if (pkg.package_type === 'student_offer' && pkg.discount_percentage > 0) {
            // Validate student offer dates and valid days
            const validFrom = pkg.valid_from || '';
            const validTo = pkg.valid_to || '';
            const validDays = pkg.valid_days || '';

            if (!isStudentOfferValid(validFrom, validTo, validDays)) {
                console.log(`‚è≠Ô∏è Student offer ${pkg.name} is not valid today (expired or wrong day)`);
                continue; // Skip this offer
            }

            console.log(`‚úÖ Student offer ${pkg.name} is valid today`);

            // Student offers only apply to specific services that were selected when creating the offer
            const applicableServiceIds = pkg.applicable_service_ids || [];
            // CRITICAL: Ensure numeric comparison
            const numericApplicableIds = applicableServiceIds.map(id => parseInt(id));

            const appliesToThisService = applicableServiceIds.length === 0 || numericApplicableIds.includes(numericServiceId);

            if (appliesToThisService) {
                const totalServiceCost = servicePrice * quantity;
                const discountAmount = (totalServiceCost * pkg.discount_percentage) / 100;

                totalBenefit += discountAmount;
                appliedPackage = pkg.name;
                appliedPackageId = pkg.assignment_id;
                benefitType = 'student_discount';
                console.log(`‚úÖ Student offer discount applied: ${pkg.name}, ${pkg.discount_percentage}% off = ‚Çπ${discountAmount.toFixed(2)} (service ${numericServiceId} is in applicable list: ${numericApplicableIds})`);
                break; // Use first matching valid student offer
            } else {
                console.log(`‚è≠Ô∏è Student offer ${pkg.name} skipped - service ${numericServiceId} not in applicable list: ${numericApplicableIds}`);
            }
        }
    }

    if (totalBenefit === 0) {
        console.log('‚ÑπÔ∏è No package benefit applied for serviceId:', numericServiceId);
    }

    console.log('üí∞ Total benefit calculated:', totalBenefit.toFixed(2));
    console.log('üì¶ Package applied:', appliedPackage ? `${appliedPackage} (${benefitType})` : 'None');

    return { discount: totalBenefit, packageUsed: appliedPackage, packageId: appliedPackageId, benefitType: benefitType };
}


// ==========================================
// VALIDATION
// ==========================================
function validateForm() {
    console.log('üî¨ validateForm called');
    let isValid = true;
    const errors = [];

    // Customer validation
    const client = document.getElementById('client_id');
    if (!client.value) {
        client.classList.add('is-invalid');
        errors.push('Select a customer');
        isValid = false;
        console.log('‚ùå Validation failed: Customer not selected');
    } else {
        client.classList.remove('is-invalid');
    }

    let hasItems = false; // Track if any services or products are added

    // Service validation
    const serviceRows = document.querySelectorAll('.service-row');
    console.log(`Checking ${serviceRows.length} service rows...`);
    serviceRows.forEach((row, i) => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const staffSelect = row.querySelector('select[name="staff_ids[]"]');
        const qtyInput = row.querySelector('input[name="service_quantities[]"]');
        const appointmentIdInput = row.querySelector('input[name="appointment_ids[]"]');

        if (serviceSelect?.value) {
            hasItems = true; // At least one item is added
            if (!staffSelect?.value) {
                staffSelect.classList.add('is-invalid');
                errors.push(`Service #${i + 1}: Staff required`);
                isValid = false;
                console.log(`‚ùå Validation failed: Staff required for Service #${i + 1}`);
            } else {
                staffSelect.classList.remove('is-invalid');
            }

             // Validate quantity if it's not an appointment row (appointments have fixed quantity)
            if (!appointmentIdInput.value) {
                const qty = parseFloat(qtyInput?.value);
                if (isNaN(qty) || qty <= 0) {
                     qtyInput.classList.add('is-invalid');
                     errors.push(`Service #${i + 1}: Valid quantity required`);
                     isValid = false;
                     console.log(`‚ùå Validation failed: Invalid quantity for Service #${i + 1}`);
                } else {
                    qtyInput.classList.remove('is-invalid');
                }
            } else {
                // For appointment rows, quantity is usually 1 and fixed
                qtyInput.classList.remove('is-invalid');
            }
        } else {
            // If serviceSelect is empty, clear related fields' invalid status
            staffSelect.classList.remove('is-invalid');
            qtyInput.classList.remove('is-invalid');
        }
    });

    // Product validation
    const productRows = document.querySelectorAll('.product-row');
    console.log(`Checking ${productRows.length} product rows...`);
    productRows.forEach((row, i) => {
        const productSelect = row.querySelector('select[name="product_ids[]"]');
        const batchSelect = row.querySelector('.batch-select');
        const staffSelect = row.querySelector('select[name="product_staff_ids[]"]');
        const qtyInput = row.querySelector('input[name="product_quantities[]"]');
        const priceInput = row.querySelector('input[name="product_prices[]"]');

        if (productSelect?.value) {
            hasItems = true; // At least one item is added
            if (!batchSelect?.value) {
                batchSelect.classList.add('is-invalid');
                errors.push(`Product #${i + 1}: Batch required`);
                isValid = false;
                console.log(`‚ùå Validation failed: Batch required for Product #${i + 1}`);
            } else {
                batchSelect.classList.remove('is-invalid');
            }
            if (!staffSelect?.value) {
                staffSelect.classList.add('is-invalid');
                errors.push(`Product #${i + 1}: Staff required`);
                isValid = false;
                console.log(`‚ùå Validation failed: Staff required for Product #${i + 1}`);
            } else {
                staffSelect.classList.remove('is-invalid');
            }
            const qty = parseFloat(qtyInput?.value);
            if (isNaN(qty) || qty <= 0) {
                 qtyInput.classList.add('is-invalid');
                 errors.push(`Product #${i + 1}: Valid quantity required`);
                 isValid = false;
                 console.log(`‚ùå Validation failed: Invalid quantity for Product #${i + 1}`);
            } else {
                qtyInput.classList.remove('is-invalid');
            }
             const price = parseFloat(priceInput?.value);
            if (isNaN(price) || price < 0) { // Price can be 0, but not negative
                 priceInput.classList.add('is-invalid');
                 errors.push(`Product #${i + 1}: Valid price required`);
                 isValid = false;
                 console.log(`‚ùå Validation failed: Invalid price for Product #${i + 1}`);
            } else {
                priceInput.classList.remove('is-invalid');
            }
        } else {
            // Clear invalid status if product is deselected
            batchSelect.classList.remove('is-invalid');
            staffSelect.classList.remove('is-invalid');
            qtyInput.classList.remove('is-invalid');
            priceInput.classList.remove('is-invalid');
        }
    });

    // Check if any items were added
    if (!hasItems) {
        errors.push('Add at least one service or product');
        isValid = false;
        console.log('‚ùå Validation failed: No services or products added');
    }

    // Payment method validation
    const payment = document.querySelector('select[name="payment_method"]');
    if (!payment?.value) {
        payment.classList.add('is-invalid');
        errors.push('Payment method required');
        isValid = false;
        console.log('‚ùå Validation failed: Payment method not selected');
    } else {
        payment.classList.remove('is-invalid');
    }

    // If there are errors, display them and stop submission
    if (!isValid) {
        console.log('‚ùó Form validation failed with errors:', errors);
        showNotification(errors.join('\n'), 'danger');
        // Scroll to the first invalid field
        const firstErrorElement = document.querySelector('.is-invalid');
        if (firstErrorElement) {
            firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    } else {
        console.log('‚úÖ Form validation passed');
    }

    return isValid;
}

function setupInputValidation() {
    console.log('‚öôÔ∏è Setting up input validation listeners');
    document.getElementById('billingForm').addEventListener('input', function(e) {
        // Remove 'is-invalid' class when user starts typing/changing input
        if (e.target.matches('select, input, textarea')) {
            e.target.classList.remove('is-invalid');
            // Also clear associated feedback if it exists
            const feedbackElement = e.target.nextElementSibling;
            if (feedbackElement && feedbackElement.classList.contains('invalid-feedback')) {
                feedbackElement.style.display = 'none';
            }
        }
    });
}

// ==========================================
// FORM SUBMISSION
// ==========================================
async function saveAndPrint() {
    console.log('üöÄ saveAndPrint called');

    const form = document.getElementById('billingForm');
    if (!form) {
        console.error('‚ùå Billing form not found');
        showNotification('Error: Form not found', 'error');
        return;
    }

    // Validate required fields
    const clientId = document.getElementById('client_id')?.value;
    const paymentMethod = document.querySelector('select[name="payment_method"]')?.value;

    // Check if at least one service or product is selected
    const hasService = Array.from(document.querySelectorAll('select[name="service_ids[]"]'))
        .some(select => select.value);
    const hasProduct = Array.from(document.querySelectorAll('select[name="product_ids[]"]'))
        .some(select => select.value && document.querySelector(`select[name="batch_ids[]"][value!=""]`));

    // Validate staff assignment for services
    const serviceRows = document.querySelectorAll('.service-row');
    let missingStaff = false;
    serviceRows.forEach(row => {
        const serviceId = row.querySelector('select[name="service_ids[]"]')?.value;
        const staffId = row.querySelector('select[name="staff_ids[]"]')?.value;
        if (serviceId && !staffId) {
            missingStaff = true;
        }
    });

    if (!clientId) {
        showNotification('Please select a customer', 'error');
        document.getElementById('client_id')?.focus();
        return;
    }

    if (!hasService && !hasProduct) {
        showNotification('Please add at least one service or product', 'error');
        return;
    }

    if (missingStaff) {
        showNotification('Please assign staff to all services', 'error');
        return;
    }

    if (!paymentMethod) {
        showNotification('Please select a payment method', 'error');
        document.querySelector('select[name="payment_method"]')?.focus();
        return;
    }

    console.log('‚úÖ Form valid, submitting for print...');

    try {
        // Add print flag to form data
        const formData = new FormData(form);
        formData.append('print_after_save', 'true');

        // Show loading
        showNotification('Creating invoice...', 'info');

        // Submit via AJAX
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            showNotification('Invoice created successfully!', 'success');

            // Open print window immediately
            if (result.invoice_id) {
                window.open(`/integrated-billing/print-invoice/${result.invoice_id}`, '_blank');
            }

            // Redirect to billing page after short delay
            setTimeout(() => {
                window.location.href = '/integrated-billing';
            }, 1500);
        } else {
            showNotification(`Error: ${result.message}`, 'error');
        }
    } catch (error) {
        console.error('Error saving invoice:', error);
        showNotification('Error saving invoice. Please try again.', 'error');
    }
}

function handleFormSubmit(e) {
    e.preventDefault();
    console.log('üöÄ Form submit event triggered');

    if (!validateForm()) {
        console.log('üö´ Form submission aborted due to validation errors.');
        return;
    }

    if (BillingState.isSubmitting) {
        console.log('‚è≥ Submission already in progress. Aborting duplicate submission.');
        return;
    }

    BillingState.isSubmitting = true;
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.classList.add('btn-loading');
    console.log('‚öôÔ∏è Submission initiated. Button disabled and loading state activated.');

    const formData = new FormData(e.target);

    fetch('/integrated-billing/create-professional', {
        method: 'POST',
        body: formData
    })
    .then(res => {
        console.log('üìà Server response received. Status:', res.status);
        if (!res.ok) {
            // Attempt to get error message from response body
            return res.text().then(text => {
                console.error('Server returned error:', text);
                throw new Error(`Server error: ${res.status} - ${text || 'Unknown error'}`);
            });
        }
        return res.json();
    })
    .then(data => {
        console.log('‚úÖ Server successfully processed request. Response data:', data);
        if (data.success) {
            // Build success message for toast
            let toastMessage = `‚úÖ Bill Saved Successfully!\n\n`;
            toastMessage += `üìã Invoice Number: ${data.invoice_number}\n`;
            toastMessage += `üí∞ Total Amount: ‚Çπ${data.total_amount.toFixed(2)}\n\n`;

            if (data.service_items_created > 0) {
                toastMessage += `‚úì ${data.service_items_created} service(s) billed\n`;
            }
            if (data.inventory_items_created > 0) {
                toastMessage += `‚úì ${data.inventory_items_created} product(s) billed\n`;
            }
            if (data.appointments_completed > 0) {
                toastMessage += `‚úì ${data.appointments_completed} appointment(s) completed\n`;
            }
            if (data.package_deductions_applied > 0) {
                toastMessage += `‚úì ${data.package_deductions_applied} package benefit(s) applied\n`;
            }

            // Show success toast
            showNotification(toastMessage, 'success', 8000); // Display for 8 seconds

            // Refresh package display if packages were updated
            if (data.updated_packages && data.updated_packages.length > 0) {
                const customerId = document.getElementById('client_id').value;
                if (customerId) {
                    console.log('üîÑ Refreshing customer package display...');
                    refreshCustomerPackages(customerId, data.updated_packages);
                }
            }

            // Handle print if needed (window.printAfterSave is set by saveAndPrint)
            if (window.printAfterSave && data.invoice_id) {
                console.log(`üñ®Ô∏è Opening print window for invoice ID: ${data.invoice_id}`);
                window.open(`/integrated-billing/print-invoice/${data.invoice_id}`, '_blank');
                window.printAfterSave = false; // Reset flag
            }

            // Redirect to invoice detail page after a short delay
            setTimeout(() => {
                console.log(`üöÄ Redirecting to invoice detail page: /integrated-billing/invoice/${data.invoice_id}`);
                window.location.href = `/integrated-billing/invoice/${data.invoice_id}`;
            }, 2500); // Delay for toast message visibility

        } else {
            // Handle case where success is false but response is OK
            throw new Error(data.message || 'Failed to create invoice');
        }
    })
    .catch(err => {
        console.error('‚ùå Form submission failed:', err);
        console.error('‚ùå Error stack:', err.stack);

        BillingState.isSubmitting = false; // Reset submission flag
        btn.disabled = false; // Re-enable button
        btn.classList.remove('btn-loading'); // Remove loading state

        // Show error toast
        const errorMessage = err.message || 'Failed to save invoice. Please check your entries and try again.';
        showNotification(`‚ùå Error: ${errorMessage}`, 'danger', 6000); // Display for 6 seconds
    });
}

// ==========================================
// STUDENT OFFER UTILITIES
// ==========================================
function showStudentOfferDetails(name, discount, services, validFrom, validTo, validDays, conditions) {
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    modal.setAttribute('tabindex', '-1');
    modal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h5 class="modal-title"><i class="fas fa-graduation-cap me-2"></i>${name}</h5>
                    <button type="button" class="btn-close btn-close-white" onclick="this.closest('.modal').remove()"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-tag me-2"></i>Discount</h6>
                        <div class="alert alert-success mb-3">
                            <h4 class="mb-0"><strong>${discount}% OFF</strong></h4>
                        </div>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-spa me-2"></i>Applicable Services</h6>
                        <p class="mb-0">${services}</p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-calendar me-2"></i>Validity Period</h6>
                        <p class="mb-0"><strong>${validFrom}</strong> to <strong>${validTo}</strong></p>
                    </div>
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="fas fa-calendar-check me-2"></i>Valid Days</h6>
                        <p class="mb-0">${validDays}</p>
                    </div>
                    <div class="mb-0">
                        <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>Terms & Conditions</h6>
                        <p class="mb-0 text-muted small">${conditions}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function isStudentOfferValid(validFrom, validTo, validDays) {
    // Check date validity
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (validFrom) {
        const fromDate = new Date(validFrom);
        fromDate.setHours(0, 0, 0, 0);
        if (today < fromDate) {
            console.log(`‚ùå Student offer not yet valid. Starts: ${validFrom}`);
            return false;
        }
    }

    if (validTo) {
        const toDate = new Date(validTo);
        toDate.setHours(23, 59, 59, 999);
        if (today > toDate) {
            console.log(`‚ùå Student offer expired. Ended: ${validTo}`);
            return false;
        }
    }

    // Check valid days
    if (validDays && validDays !== 'All Days' && validDays !== '') {
        const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const todayDay = daysOfWeek[today.getDay()];

        // Parse valid days (e.g., "Mon-Fri", "Weekends Only", "Mon,Wed,Fri")
        let isValidDay = false;

        if (validDays === 'Mon-Fri') {
            isValidDay = today.getDay() >= 1 && today.getDay() <= 5;
        } else if (validDays === 'Mon-Sat') {
            isValidDay = today.getDay() >= 1 && today.getDay() <= 6;
        } else if (validDays === 'Weekends Only') {
            isValidDay = today.getDay() === 0 || today.getDay() === 6;
        } else if (validDays.includes(todayDay)) {
            isValidDay = true;
        }

        if (!isValidDay) {
            console.log(`‚ùå Student offer not valid today (${todayDay}). Valid days: ${validDays}`);
            return false;
        }
    }

    console.log(`‚úÖ Student offer is valid for today`);
    return true;
}

// ==========================================
// UTILITIES
// ==========================================
function showNotification(message, type = 'info', duration = 5000) {
    console.log(`üîî Showing notification: [${type}] ${message}`);
    const alertClass = {
        success: 'alert-success',
        danger: 'alert-danger',
        warning: 'alert-warning',
        info: 'alert-info'
    }[type] || 'alert-info';

    const notification = document.createElement('div');
    notification.className = `toast-notification alert ${alertClass}`;
    notification.innerHTML = `
        <div style="white-space: pre-line;">${message}</div>
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, duration);
}
</script>
{% endblock %}