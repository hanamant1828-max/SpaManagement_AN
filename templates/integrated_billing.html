{% extends "base.html" %}

{% block title %}Professional Invoice Management{% endblock %}
{% block body_class %}billing-page{% endblock %}

{% block extra_head %}
<style>
/* ==========================================
   BILLING PAGE - USING CENTRALIZED THEME TOKENS
   ========================================== */

/* Only billing-specific layout styles - all theme tokens are in style.css */

body.billing-page .page-header {
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-light);
    padding: var(--space-8) var(--space-10);
    margin-bottom: var(--space-8);
    box-shadow: var(--shadow-sm);
}

body.billing-page .page-title {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-2);
}

body.billing-page .page-title i {
    color: var(--spa-primary);
}

body.billing-page .page-subtitle {
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
}

/* Use reusable card component from style.css */
body.billing-page .card {
    border: none;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-base);
    transition: var(--transition-base);
    background-color: var(--bg-primary);
    margin-bottom: var(--space-6);
}

/* Gradient Headers using centralized tokens */
body.billing-page .bg-gradient-primary {
    background: linear-gradient(135deg, var(--spa-primary), var(--spa-primary-dark));
}

body.billing-page .bg-gradient-success {
    background: linear-gradient(135deg, var(--spa-success), var(--spa-success-dark));
}

body.billing-page .bg-gradient-info {
    background: linear-gradient(135deg, var(--spa-info), var(--spa-info-dark));
}

body.billing-page .bg-gradient-warning {
    background: linear-gradient(135deg, var(--spa-warning), var(--spa-warning-dark));
}

.card:hover {
    box-shadow: var(--shadow-md);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-4);
    border-bottom: 2px solid var(--spa-gray-100);
}

.card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--spa-gray-900);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.card-title i {
    color: var(--spa-primary);
}

/* ==========================================
   FORM CONTROLS
   ========================================== */

.form-group {
    margin-bottom: var(--space-6);
}

.form-label {
    display: block;
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--spa-gray-700);
    margin-bottom: var(--space-2);
}

.form-label.required::after {
    content: '*';
    color: var(--spa-danger);
    margin-left: 0.25rem;
}

.form-control,
.form-select {
    border-radius: var(--radius-base);
    border: 2px solid var(--spa-gray-200);
    padding: 0.75rem 1rem;
    transition: var(--transition-base);
    color: var(--spa-gray-900) !important;
    background-color: white !important;
    font-size: 0.95rem;
}

.form-select-lg {
    padding: 0.875rem 1.25rem;
    font-size: 1rem;
    border-width: 2px;
}

.form-control:focus,
.form-select:focus {
    outline: none;
    border-color: var(--spa-primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.form-control:hover:not(:focus),
.form-select:hover:not(:focus) {
    border-color: var(--spa-gray-400);
}

.form-control.is-invalid,
.form-select.is-invalid {
    border-color: var(--spa-danger);
}

.invalid-feedback {
    display: none;
    color: var(--spa-danger);
    font-size: 0.8125rem;
    margin-top: var(--space-1);
}

.is-invalid + .invalid-feedback {
    display: block;
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

/* ==========================================
   BUTTONS
   ========================================== */

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.5;
    text-align: center;
    text-decoration: none;
    border: none;
    border-radius: var(--radius-base);
    cursor: pointer;
    transition: var(--transition-base);
    white-space: nowrap;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-primary {
    background: var(--spa-primary);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: var(--spa-primary-dark);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-success {
    background: var(--spa-success);
    color: white;
}

.btn-success:hover:not(:disabled) {
    background: #059669;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-info {
    background: var(--spa-info);
    color: white;
}

.btn-info:hover:not(:disabled) {
    background: #0891b2;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-danger {
    background: var(--spa-danger);
    color: white;
}

.btn-danger:hover:not(:disabled) {
    background: #dc2626;
}

.btn-sm {
    padding: 0.4rem 0.875rem;
    font-size: 0.8125rem;
}

.btn-lg {
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
}

/* Button States */
.btn-loading .btn-text {
    display: none;
}

.btn-loading .btn-spinner {
    display: inline-block;
}

.btn:not(.btn-loading) .btn-spinner {
    display: none;
}

/* ==========================================
   ITEM ROWS
   ========================================== */

.item-row {
    background: var(--spa-gray-100);
    border: 1px solid var(--spa-gray-200);
    border-radius: var(--radius-base);
    padding: var(--space-6);
    margin-bottom: var(--space-4);
    transition: var(--transition-base);
}

.item-row:hover {
    background: white;
    border-color: var(--spa-primary);
    box-shadow: var(--shadow-sm);
}

.item-row .row {
    align-items: end;
}

.package-benefit {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-sm);
    margin-top: var(--space-2);
    font-size: 0.8125rem;
    border-left: 3px solid var(--spa-success);
}

.student-offer-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
}

.package-benefit.student-discount {
    background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
    color: #4338ca;
    border-left: 3px solid #6366f1;
}

.package-benefit.student-discount::before {
    content: 'ðŸŽ“ ';
    margin-right: 0.25rem;
}

.batch-info {
    background: var(--spa-gray-100);
    border-left: 3px solid var(--spa-info);
    padding: var(--space-2);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    margin-top: var(--space-1);
    color: var(--spa-gray-700);
}

/* ==========================================
   SUMMARY PANEL - ENHANCED PROFESSIONAL DESIGN
   ========================================== */

.summary-panel {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    border-radius: var(--radius-lg);
    padding: 0;
    position: sticky;
    top: var(--space-6);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.summary-header {
    background: linear-gradient(135deg, var(--spa-primary) 0%, #6366f1 100%);
    color: white;
    text-align: center;
    padding: var(--space-6) var(--space-6) var(--space-5);
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.15);
}

.summary-header i {
    margin-right: var(--space-2);
    font-size: 1.5rem;
    vertical-align: middle;
}

.summary-panel > div:not(.summary-header):not(.summary-actions):not(.summary-footer) {
    padding: 0 var(--space-6);
}

/* Section Headers in Summary */
.summary-section-header {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: rgba(255, 255, 255, 0.5);
    margin-top: var(--space-4);
    margin-bottom: var(--space-2);
    padding-top: var(--space-3);
    border-top: 1px solid rgba(255, 255, 255, 0.08);
}

.summary-section-header:first-of-type {
    margin-top: var(--space-3);
    border-top: none;
    padding-top: 0;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3) 0;
    color: rgba(255, 255, 255, 0.95);
}

.summary-row:last-of-type {
    border-bottom: none;
}

.summary-row.divider {
    border-top: 2px solid rgba(255, 255, 255, 0.2);
    margin-top: var(--space-3);
    padding-top: var(--space-4);
    padding-bottom: var(--space-2);
}

.summary-row.tax-row {
    font-size: 0.875rem;
    opacity: 0.9;
    padding: var(--space-2) 0;
}

.summary-row.highlight {
    background: linear-gradient(90deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
    padding: var(--space-3) var(--space-4);
    margin: var(--space-2) calc(-1 * var(--space-6));
    padding-left: var(--space-6);
    padding-right: var(--space-6);
    border-left: 4px solid #10b981;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
}

.summary-label {
    font-weight: 500;
    font-size: 0.9375rem;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.summary-label i {
    width: 20px;
    text-align: center;
    opacity: 0.7;
    font-size: 0.875rem;
}

.summary-value {
    font-weight: 700;
    font-size: 1.0625rem;
    font-variant-numeric: tabular-nums;
    letter-spacing: 0.025em;
}

/* Subtotal Row - Emphasized */
.summary-row.subtotal-row {
    font-size: 1.125rem;
    font-weight: 600;
    padding: var(--space-4) 0;
    margin-top: var(--space-2);
}

.summary-row.subtotal-row .summary-value {
    font-size: 1.25rem;
    color: #fbbf24;
}

/* Tax Summary Section */
.tax-summary-section {
    background: rgba(0, 0, 0, 0.15);
    margin: var(--space-3) calc(-1 * var(--space-6));
    padding: var(--space-4) var(--space-6);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.grand-total {
    font-size: 3rem;
    font-weight: 800;
    text-align: center;
    margin: var(--space-6) 0;
    color: white;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    letter-spacing: -0.5px;
    font-variant-numeric: tabular-nums;
    padding: var(--space-6);
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
    border-top: 2px solid rgba(16, 185, 129, 0.4);
    border-bottom: 2px solid rgba(16, 185, 129, 0.4);
    margin-left: calc(-1 * var(--space-6));
    margin-right: calc(-1 * var(--space-6));
    position: relative;
}

.grand-total::before {
    content: 'TOTAL AMOUNT';
    display: block;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 1.5px;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: var(--space-2);
}

.summary-actions {
    display: grid;
    gap: var(--space-3);
    padding: var(--space-6);
    background: rgba(0, 0, 0, 0.1);
}

.summary-actions .btn {
    width: 100%;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: 0.875rem;
    padding: 0.875rem 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    border: none;
}

.summary-actions .btn-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.summary-actions .btn-success:hover:not(:disabled) {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.summary-actions .btn-info {
    background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
}

.summary-actions .btn-info:hover:not(:disabled) {
    background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
    box-shadow: 0 4px 12px rgba(6, 182, 212, 0.4);
}

.summary-actions .btn-primary {
    background: linear-gradient(135deg, var(--spa-primary) 0%, #5b21b6 100%);
}

.summary-actions .btn-primary:hover:not(:disabled) {
    background: linear-gradient(135deg, #5b21b6 0%, #4c1d95 100%);
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
}

.summary-footer {
    text-align: center;
    padding: var(--space-4);
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.5);
    background: rgba(0, 0, 0, 0.15);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

/* ==========================================
   ALERTS & NOTIFICATIONS
   ========================================== */

.alert {
    padding: var(--space-4) var(--space-6);
    border-radius: var(--radius-base);
    margin-bottom: var(--space-4);
    border-left: 4px solid;
}

.alert-info {
    background: #e0f2fe;
    border-color: var(--spa-info);
    color: #075985;
}

.alert-success {
    background: #d1fae5;
    border-color: var(--spa-success);
    color: #065f46;
}

.alert-warning {
    background: #fef3c7;
    border-color: var(--spa-warning);
    color: #92400e;
}

.alert-danger {
    background: #fee2e2;
    border-color: var(--spa-danger);
    color: #991b1b;
}

/* Toast Notifications */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    max-width: 400px;
    padding: var(--space-6);
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* ==========================================
   PAYMENT METHOD RADIO BUTTONS
   ========================================== */

.payment-radio-option:hover {
    border-color: var(--spa-primary);
    background: var(--spa-gray-100);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.payment-radio-option:has(input:checked) {
    border-color: var(--spa-primary);
    background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(79, 70, 229, 0.1) 100%);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.payment-radio-option input[type="radio"]:checked {
    accent-color: var(--spa-primary);
}

/* ==========================================
   UTILITIES
   ========================================== */

.text-muted {
    color: var(--spa-gray-500);
}

.text-success {
    color: var(--spa-success);
}

.text-danger {
    color: var(--spa-danger);
}

.d-none {
    display: none !important;
}

.d-block {
    display: block !important;
}

.d-flex {
    display: flex !important;
}

.d-grid {
    display: grid !important;
}

.gap-2 {
    gap: var(--space-2);
}

.gap-3 {
    gap: var(--space-4);
}

.mb-3 {
    margin-bottom: var(--space-4);
}

.w-100 {
    width: 100%;
}

.spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

/* ==========================================
   RESPONSIVE DESIGN
   ========================================== */

@media (max-width: 768px) {
    .page-header {
        padding: var(--space-6);
    }

    .page-title {
        font-size: 1.5rem;
    }

    .card {
        padding: var(--space-6);
    }

    .grand-total {
        font-size: 2rem;
    }

    .summary-panel {
        position: static;
        margin-top: var(--space-8);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-2">
    <!-- Page Header - Ultra Compact Layout -->
    <div class="page-header" style="padding: 0.5rem 1rem; margin-bottom: 0.75rem; margin-top: 0;">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title" style="font-size: 1.35rem; margin-bottom: 0; margin-top: 0;">
                    <i class="fas fa-file-invoice-dollar"></i>
                    {% if edit_mode and edit_invoice_data %}
                    Edit Invoice {{ edit_invoice_data.invoice_number }}
                    {% else %}
                    Billing
                    {% endif %}
                </h1>
            </div>
        </div>
    </div>

    <!-- Main Billing Form -->
    <form id="billingForm" method="POST" action="{% if edit_mode and edit_invoice_data %}/integrated-billing/update/{{ edit_invoice_data.id }}{% else %}/integrated-billing/create-professional{% endif %}">
        <div class="row">
            <!-- Left Column: Form Inputs -->
            <div class="col-lg-8">
                <!-- Customer Section -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-user-circle"></i>
                            Customer Information
                        </h6>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label required">Select Customer</label>
                                <select class="form-select form-select-lg" id="client_id" name="client_id" required>
                                    <option value="">-- Select Customer --</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}" 
                                            {{ 'selected' if (selected_customer and customer.id == selected_customer.id) or (preselected_client_id and customer.id == preselected_client_id|int) else '' }}
                                            data-phone="{{ customer.phone }}"
                                            data-email="{{ customer.email }}">
                                        {{ customer.full_name }} - {{ customer.phone }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select a customer</div>
                            </div>
                        </div>
                        {% if not edit_mode %}
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Booked Appointments111</label>
                                <div id="customerAppointments" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--spa-gray-300); border-radius: var(--radius-base); background: white;">
                                    <div style="padding: var(--space-4); text-align: center; color: var(--spa-gray-500);">
                                        <small><i class="fas fa-info-circle me-1"></i>Select customer to view appointments</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-md-12 mt-3">
                            <div class="form-group">
                                <label class="form-label">Active Packages</label>
                                <div id="customerPackagesTable" style="max-height: 250px; overflow-y: auto; border: 1px solid var(--spa-gray-300); border-radius: var(--radius-base); background: white;">
                                    <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
                                        <thead style="background: var(--spa-gray-100); position: sticky; top: 0;">
                                            <tr>
                                                <th>PACKAGE NAME</th>
                                                <th>TYPE</th>
                                                <th>BALANCE</th>
                                                <th>STATUS</th>
                                                <th>EXPIRY</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activePackagesTableBody">
                                            {% if customer_active_packages %}
                                                {% for package in customer_active_packages %}
                                                <tr data-package-type="{{ package.package_type }}"
                                                    data-package-id="{{ package.assignment_id }}"
                                                    data-discount="{{ package.discount_percentage|default(0) }}"
                                                    data-applicable-services="{{ package.applicable_service_ids|tojson if package.applicable_service_ids else '[]' }}"
                                                    data-valid-from="{{ package.valid_from|default('') }}"
                                                    data-valid-to="{{ package.valid_to|default('') }}"
                                                    data-valid-days="{{ package.valid_days|default('') }}">
                                                    <td>
                                                        <strong>{{ package.name }}</strong>
                                                        {% if package.package_type == 'student_offer' %}
                                                            <br><small class="text-primary"><i class="fas fa-graduation-cap me-1"></i>{{ package.applicable_service_names|default('All Services') }}</small>
                                                            <br><small class="text-success"><i class="fas fa-tag me-1"></i>{{ package.discount_percentage }}% Discount</small>
                                                            {% if package.valid_days %}
                                                            <br><small class="text-info"><i class="fas fa-calendar-check me-1"></i>Valid: {{ package.valid_days }}</small>
                                                            {% endif %}
                                                        {% else %}
                                                            <br><small class="text-muted">{{ package.service_name or 'Multiple Services' }}</small>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if package.package_type == 'student_offer' %}
                                                            <span class="badge bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                                                <i class="fas fa-graduation-cap me-1"></i>Student Offer
                                                            </span>
                                                        {% else %}
                                                            <span class="badge bg-{{ 'warning' if package.benefit_type == 'free' else 'info' }}">{{ package.benefit_type|title }}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if package.package_type == 'student_offer' %}
                                                            <div class="d-flex align-items-center">
                                                                <i class="fas fa-percentage text-success me-2"></i>
                                                                <span class="fw-bold text-success">{{ package.discount_percentage }}% OFF</span>
                                                            </div>
                                                            {% if package.package_price %}
                                                            <small class="text-muted">Package: â‚¹{{ "%.2f"|format(package.package_price) }}</small>
                                                            {% endif %}
                                                        {% elif package.benefit_type in ['free', 'discount'] %}
                                                            <strong>{{ package.remaining_count }}/{{ package.total_allocated }} sessions</strong>
                                                            <div class="progress mt-1" style="height: 5px;">
                                                                <div class="progress-bar bg-success" style="width: {{ package.usage_percentage }}%"></div>
                                                            </div>
                                                        {% elif package.benefit_type == 'prepaid' %}
                                                            <strong>â‚¹{{ "%.2f"|format(package.balance_remaining) }}</strong> / â‚¹{{ "%.2f"|format(package.balance_total) }}
                                                        {% elif package.benefit_type == 'unlimited' %}
                                                            <span class="badge bg-success">Unlimited</span>
                                                        {% endif %}
                                                    </td>
                                                    <td><span class="badge bg-{{ 'success' if package.is_active else 'secondary' }}">{{ 'Active' if package.is_active else 'Inactive' }}</span></td>
                                                    <td>
                                                        {% if package.package_type == 'student_offer' and package.valid_to %}
                                                            <small>{{ package.valid_from }} to<br>{{ package.valid_to }}</small>
                                                            {% if package.conditions %}
                                                            <br><button type="button" class="btn btn-sm btn-outline-info mt-1"
                                                                    onclick="showStudentOfferDetails({{ package.name|tojson }}, '{{ package.discount_percentage }}', {{ package.applicable_service_names|tojson }}, '{{ package.valid_from }}', '{{ package.valid_to }}', '{{ package.valid_days }}', {{ package.conditions|tojson }})">
                                                                <i class="fas fa-info-circle"></i> Details
                                                            </button>
                                                            {% endif %}
                                                        {% else %}
                                                            {{ package.valid_to }}
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">
                                                    <i class="fas fa-box-open fa-2x mb-2"></i>
                                                    <p class="mb-0">No active packages</p>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Services Section -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-spa"></i>
                            Services
                        </h6>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addServiceRow()">
                            <i class="fas fa-plus"></i>
                            Add Service
                        </button>
                    </div>
                    <div id="servicesContainer">
                        <div class="item-row service-row">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">Service</label>
                                        <select class="form-select form-select-lg" name="service_ids[]" onchange="handleServiceChange(this)">
                                            <option value="">Select Service</option>
                                            {% for service in services %}
                                            <option value="{{ service.id }}" data-price="{{ "%.2f"|format(service.price|float) }}">
                                                {{ service.name }} - â‚¹{{ "{:,.2f}".format(service.price) }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label required">Staff</label>
                                        <select class="form-select form-select-lg" name="staff_ids[]">
                                            <option value="">Select Staff</option>
                                            {% for staff in staff_members %}
                                            <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Staff required</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Qty</label>
                                        <input type="number" class="form-control" name="service_quantities[]" value="1" min="0.5" step="0.5" oninput="updateCalculations()">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Apt ID</label>
                                        <input type="number" class="form-control" name="appointment_ids[]" placeholder="Optional">
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-box"></i>
                            Products & Inventory
                        </h6>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addProductRow()">
                            <i class="fas fa-plus"></i>
                            Add Product
                        </button>
                    </div>
                    <div id="productsContainer">
                        <div class="item-row product-row">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Product</label>
                                        <select class="form-select form-select-lg" name="product_ids[]" onchange="loadBatches(this)">
                                            <option value="">Select Product</option>
                                            {% for product in inventory_items %}
                                            <option value="{{ product.id }}">{{ product.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Batch</label>
                                        <select class="form-select form-select-lg batch-select" name="batch_ids[]" disabled>
                                            <option value="">Select Product</option>
                                        </select>
                                        <div class="batch-info"></div>
                                        <div class="invalid-feedback">Batch required</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label required">Staff</label>
                                        <select class="form-select form-select-lg" name="product_staff_ids[]">
                                            <option value="">Select Staff</option>
                                            {% for staff in staff_members %}
                                            <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Staff required</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Qty</label>
                                        <input type="number" class="form-control" name="product_quantities[]" value="1" min="0.01" step="0.01" oninput="updateCalculations()">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Price</label>
                                        <input type="number" class="form-control" name="product_prices[]" placeholder="â‚¹0.00" min="0" step="0.01" oninput="updateCalculations()">
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-credit-card"></i>
                            Payment & Tax Details
                        </h6>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Payment Terms</label>
                                <select class="form-select form-select-lg" id="paymentTerms" name="payment_terms">
                                    <option value="immediate">Immediate Payment</option>
                                    <option value="net_15">Net 15 Days</option>
                                    <option value="net_30">Net 30 Days</option>
                                    <option value="advance">Advance Payment</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Payment Method <span class="text-danger">*</span></label>
                                <select class="form-select form-select-lg" id="paymentMethod" name="payment_method" required onchange="toggleChequeNumber()">
                                    <option value="" selected>Select Payment Method</option>
                                    <option value="cash">Cash</option>
                                    <option value="card">Credit/Debit Card</option>
                                    <option value="upi">UPI Payment</option>
                                    <option value="cheque">Cheque</option>
                                    <option value="wallet">Digital Wallet</option>
                                    <option value="mixed">Mixed Payment</option>
                                </select>
                            </div>
                            <div class="form-group" id="chequeNumberField" style="display: none;">
                                <label class="form-label">Cheque Number <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="chequeNumber" name="cheque_number" placeholder="Enter cheque number">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Discount Type</label>
                                <select class="form-select form-select-lg" name="discount_type" onchange="updateCalculations()">
                                    <option value="percentage">Percentage (%)</option>
                                    <option value="amount">Amount (â‚¹)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Discount Value</label>
                                <input type="number" class="form-control" name="discount_value" value="0" min="0" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Additional Charges</label>
                                <input type="number" class="form-control" name="additional_charges" value="0" min="0" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Tips Amount</label>
                                <input type="number" class="form-control" name="tips_amount" value="0" min="0" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes" rows="3" placeholder="Add invoice notes..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary -->
            <div class="col-lg-4">
                <div class="summary-panel">
                    <h5 class="summary-header">
                        <i class="fas fa-receipt"></i>
                        Bill Summary
                    </h5>

                    <!-- Items Section -->
                    <div class="summary-section-header">Items Breakdown</div>
                    
                    <div class="summary-row">
                        <span class="summary-label">
                            <i class="fas fa-spa"></i>
                            Services
                        </span>
                        <span class="summary-value" id="servicesSubtotal">â‚¹0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">
                            <i class="fas fa-box"></i>
                            Products
                        </span>
                        <span class="summary-value" id="productsSubtotal">â‚¹0.00</span>
                    </div>

                    <div class="summary-row subtotal-row">
                        <span class="summary-label">
                            <i class="fas fa-calculator"></i>
                            Subtotal
                        </span>
                        <span class="summary-value" id="subtotalAmount">â‚¹0.00</span>
                    </div>

                    <!-- Deductions Section -->
                    <div class="summary-section-header">Deductions</div>

                    <div class="summary-row highlight">
                        <span class="summary-label">
                            <i class="fas fa-gift"></i>
                            Package Benefits
                        </span>
                        <span class="summary-value" id="packageDeductions">-â‚¹0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">
                            <i class="fas fa-tag"></i>
                            Discount
                        </span>
                        <span class="summary-value" id="discountAmount">-â‚¹0.00</span>
                    </div>

                    <!-- Tax Section -->
                    <div class="tax-summary-section">
                        <div class="summary-section-header" style="margin-top: 0; padding-top: 0; border-top: none;">Tax Calculation</div>
                        
                        <div class="summary-row">
                            <span class="summary-label">
                                <i class="fas fa-money-bill-wave"></i>
                                Taxable Amount
                            </span>
                            <span class="summary-value" id="taxableAmount">â‚¹0.00</span>
                        </div>

                        <div class="summary-row tax-row">
                            <span class="summary-label">
                                <i class="fas fa-percentage"></i>
                                CGST (9%)
                            </span>
                            <span class="summary-value" id="cgstAmount">â‚¹0.00</span>
                        </div>

                        <div class="summary-row tax-row">
                            <span class="summary-label">
                                <i class="fas fa-percentage"></i>
                                SGST (9%)
                            </span>
                            <span class="summary-value" id="sgstAmount">â‚¹0.00</span>
                        </div>
                    </div>

                    <!-- Additional Charges Section -->
                    <div class="summary-section-header">Additional</div>

                    <div class="summary-row">
                        <span class="summary-label">
                            <i class="fas fa-plus-circle"></i>
                            Additional Charges
                        </span>
                        <span class="summary-value" id="additionalCharges">â‚¹0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">
                            <i class="fas fa-hand-holding-heart"></i>
                            Tips
                        </span>
                        <span class="summary-value" id="tipsDisplay">â‚¹0.00</span>
                    </div>

                    <div class="grand-total" id="grandTotal">â‚¹0.00</div>

                    <div class="summary-actions">
                        <button type="submit" class="btn btn-success btn-lg" id="saveBtn" onclick="validateAndSubmitForm(); return false;">
                            <span class="btn-text">
                                <i class="fas fa-check-circle"></i>
                                Save
                            </span>
                            <span class="btn-spinner">
                                <i class="fas fa-spinner spinner"></i>
                                Saving...
                            </span>
                        </button>

                        <button type="button" class="btn btn-info btn-lg" onclick="saveAndPrint()">
                            <i class="fas fa-print"></i>
                            Save & Print
                        </button>

                        <button type="button" class="btn btn-primary btn-lg w-100 mb-2" id="previewBtn" onclick="previewInvoice()">
                            <i class="fas fa-eye me-2"></i>Preview
                        </button>
                    </div>

                    <div class="summary-footer">
                        <i class="fas fa-shield-alt me-1"></i>
                        Secure & Encrypted
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// ==========================================
// STATE MANAGEMENT
// ==========================================
const BillingState = {
    selectedCustomerId: null, // Customer ID for tracking selected customer
    customerPackages: null, // Active packages for the selected customer
    batchCache: {},
    isSubmitting: false
};

// Global variables for cart items
let selectedServices = [];
let selectedProducts = [];
let taxRate = 9; // Default tax rate

// Global GST Settings (loaded dynamically from database)
let GSTSettings = {
    cgst_rate: 9,
    sgst_rate: 9,
    igst_rate: 18,
    gstin_number: '',
    business_name: '',
    business_address: '',
    business_phone: '',
    business_email: '',
    state: '',
    enabled: false
};

// ==========================================
// INITIALIZATION
// ==========================================
// Initialize application when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    loadGSTSettings(); // Load GST settings first
    initializeBillingSystem();
    initializeSearchableDropdowns();
    updateCalculations(); // Initial calculation to set display to 0.00

    {% if selected_customer %}
    console.log('Pre-selected customer ID:', {{ selected_customer.id }});
    console.log('Pre-selected customer name:', '{{ selected_customer.full_name }}');

    // Use Select2's method to set value and trigger change
    setTimeout(() => {
        $('#client_id').val('{{ selected_customer.id }}').trigger('change');
        console.log('Set customer dropdown using Select2 to:', '{{ selected_customer.id }}');
    }, 100);

    // Also load packages and appointments directly
    loadCustomerPackages({{ selected_customer.id }});
    {% if not edit_mode %}
    loadCustomerAppointments({{ selected_customer.id }});
    {% endif %}
    {% elif preselected_client_id %}
    console.log('Pre-selected customer ID from URL:', {{ preselected_client_id }});

    // Use Select2's method to set value and trigger change
    setTimeout(() => {
        $('#client_id').val('{{ preselected_client_id }}').trigger('change');
        console.log('Set customer dropdown using Select2 to:', '{{ preselected_client_id }}');
    }, 100);
    {% endif %}

    {% if edit_mode and edit_invoice_data %}
    // Edit mode: Pre-populate invoice data
    console.log('ðŸ“ Edit mode activated - loading invoice data');
    setTimeout(() => {
        loadInvoiceEditData({{ edit_invoice_data|tojson }});
    }, 500); // Delay to ensure customer packages are loaded first
    {% endif %}
});

// ==========================================
// SEARCHABLE DROPDOWNS (SELECT2)
// ==========================================
function initializeSearchableDropdowns() {
    // Initialize Select2 on customer dropdown for searchability
    $('#client_id').select2({
        theme: 'bootstrap-5',
        placeholder: '-- Select Customer --',
        allowClear: true,
        width: '100%',
        dropdownAutoWidth: false,
        dropdownParent: $('body'),
        minimumResultsForSearch: 0,
        matcher: function(params, data) {
            // If there are no search terms, return all data
            if ($.trim(params.term) === '') {
                return data;
            }

            // Search in text (customer name and phone)
            if (data.text.toLowerCase().indexOf(params.term.toLowerCase()) > -1) {
                return data;
            }

            // Search in phone number from data attribute
            var $option = $(data.element);
            var phone = $option.data('phone');
            if (phone && phone.toString().indexOf(params.term) > -1) {
                return data;
            }

            // Return null if the term should not be displayed
            return null;
        }
    });

    // Initialize Select2 on payment method dropdown
    $('#paymentMethod').select2({
        theme: 'bootstrap-5',
        placeholder: 'Select Payment Method',
        allowClear: false,
        width: '100%',
        minimumResultsForSearch: Infinity
    });

    // Initialize Select2 on all existing service, staff, product, and batch dropdowns
    initializeRowDropdowns();

    console.log('âœ… Searchable dropdowns initialized (Customer, Service, Staff, Product, Batch, Payment Method)');
}

// Helper function to initialize Select2 on row dropdowns (can be called for new rows)
function initializeRowDropdowns(container) {
    const scope = container ? $(container) : $(document);
    
    // Service dropdowns
    scope.find('select[name="service_ids[]"]').each(function() {
        if (!$(this).hasClass('select2-hidden-accessible')) {
            $(this).select2({
                theme: 'bootstrap-5',
                placeholder: 'Select Service',
                allowClear: true,
                width: '100%',
                dropdownAutoWidth: true,
                minimumResultsForSearch: 5
            }).on('change', function() {
                handleServiceChange(this);
            });
        }
    });

    // Staff dropdowns (for service rows)
    scope.find('select[name="staff_ids[]"]').each(function() {
        if (!$(this).hasClass('select2-hidden-accessible')) {
            $(this).select2({
                theme: 'bootstrap-5',
                placeholder: 'Select Staff',
                allowClear: true,
                width: '100%',
                dropdownAutoWidth: true,
                minimumResultsForSearch: 5
            });
        }
    });

    // Staff dropdowns (for product rows)
    scope.find('select[name="product_staff_ids[]"]').each(function() {
        if (!$(this).hasClass('select2-hidden-accessible')) {
            $(this).select2({
                theme: 'bootstrap-5',
                placeholder: 'Select Staff',
                allowClear: true,
                width: '100%',
                dropdownAutoWidth: true,
                minimumResultsForSearch: 5
            });
        }
    });

    // Product dropdowns
    scope.find('select[name="product_ids[]"]').each(function() {
        if (!$(this).hasClass('select2-hidden-accessible')) {
            $(this).select2({
                theme: 'bootstrap-5',
                placeholder: 'Select Product',
                allowClear: true,
                width: '100%',
                dropdownAutoWidth: true,
                minimumResultsForSearch: 5
            });
        }
    });

    // Batch dropdowns
    scope.find('.batch-select').each(function() {
        if (!$(this).hasClass('select2-hidden-accessible')) {
            $(this).select2({
                theme: 'bootstrap-5',
                placeholder: 'Select Batch',
                allowClear: true,
                width: '100%',
                dropdownAutoWidth: true,
                minimumResultsForSearch: 5
            });
        }
    });
}

// ==========================================
// GST SETTINGS LOADER
// ==========================================
async function loadGSTSettings() {
    console.log('ðŸ”„ Loading GST settings from database...');
    try {
        const response = await fetch('/api/gst/configuration');
        if (!response.ok) {
            throw new Error('Failed to load GST settings');
        }
        const data = await response.json();

        if (data.success && data.configuration) {
            GSTSettings = {
                cgst_rate: data.configuration.default_cgst || 9,
                sgst_rate: data.configuration.default_sgst || 9,
                igst_rate: data.configuration.default_igst || 18,
                gstin_number: data.configuration.gstin_number || '',
                business_name: data.configuration.business_name || '',
                business_address: data.configuration.address || '',
                business_phone: data.configuration.phone || '',  // API returns 'phone' key
                business_email: data.configuration.email || '',  // API returns 'email' key
                state: data.configuration.state || '',
                enabled: data.configuration.gst_enabled || false
            };

            console.log('âœ… GST Settings loaded:', GSTSettings);

            // Update display labels with dynamic percentages
            document.querySelector('.summary-row:has(#cgstAmount) .summary-label').textContent = `CGST (${GSTSettings.cgst_rate}%):`;
            document.querySelector('.summary-row:has(#sgstAmount) .summary-label').textContent = `SGST (${GSTSettings.sgst_rate}%):`;

            // Trigger recalculation with new rates
            updateCalculations();
        }
    } catch (error) {
        console.error('âŒ Error loading GST settings:', error);
        // Use default values already set in GSTSettings
    }
}

function initializeBillingSystem() {
    // Customer selector - use jQuery for Select2 compatibility
    $('#client_id').on('change', function() {
        const selectedValue = $(this).val();
        const selectedText = $(this).find('option:selected').text();
        
        console.log('Customer selected:', selectedValue);
        console.log('Selected option text:', selectedText);

        if (selectedValue) {
            // Clear existing service/product rows first
            clearBillingRows();

            // Load customer data
            loadCustomerPackages(selectedValue); // Pass value directly
            loadCustomerAppointments(selectedValue);

            // Force recalculation after customer change
            setTimeout(() => {
                updateCalculations();
            }, 500);
        } else {
            resetCustomerPackages();
            resetCustomerAppointments();
            clearBillingRows();
            updateCalculations();
        }
    });

    // Form submission
    const form = document.getElementById('billingForm');
    form?.addEventListener('submit', handleFormSubmit);

    // Input validation setup
    setupInputValidation();

    // Initialize cart rendering if data is pre-populated (for editing)
    // This part needs to be more robust if editing existing bills with services/products.
    // For now, assuming it's only for new bills.
    // if (selectedServices.length > 0) renderServiceCart();
    // if (selectedProducts.length > 0) renderProductCart();
}

// ==========================================
// CUSTOMER & PACKAGES
// ==========================================

// Updated function to fetch and store packages in BillingState
async function loadCustomerPackages(customerId) {
    console.log('ðŸ”„ Loading packages for customer:', customerId);
    console.log('ðŸ“ Customer ID type:', typeof customerId);
    console.log('ðŸ“ Customer ID value:', customerId);

    // CRITICAL: Store the selected customer ID in BillingState
    BillingState.selectedCustomerId = parseInt(customerId);
    console.log('âœ… Set BillingState.selectedCustomerId:', BillingState.selectedCustomerId);

    try {
        const url = `/integrated-billing/customer-packages/${customerId}`;
        console.log('ðŸŒ Fetching from URL:', url);

        const response = await fetch(url);
        console.log('ðŸ“¡ Response status:', response.status);
        console.log('ðŸ“¡ Response headers:', Object.fromEntries(response.headers.entries()));

        const data = await response.json();
        console.log('ðŸ“¦ Packages loaded:', data);
        console.log('ðŸ“¦ Raw response:', JSON.stringify(data, null, 2));

        if (data.success && data.packages) {
            BillingState.customerPackages = data.packages; // Store in BillingState
            console.log('âœ… Successfully loaded', BillingState.customerPackages.length, 'packages');
            console.log('ðŸ“‹ Package details:');
            BillingState.customerPackages.forEach((pkg, index) => {
                console.log(`  Package ${index + 1}:`, {
                    name: pkg.name,
                    type: pkg.package_type,
                    service_id: pkg.service_id,
                    service_name: pkg.service_name,
                    sessions: pkg.sessions,
                    credit: pkg.credit,
                    status: pkg.status,
                    expires_on: pkg.expires_on
                });
            });
        } else {
            BillingState.customerPackages = [];
            console.log('âš ï¸ No packages returned or request failed');
            console.log('âš ï¸ Success flag:', data.success);
            console.log('âš ï¸ Packages data:', data.packages);
        }
    } catch (error) {
        console.error('âŒ Error loading packages:', error);
        console.error('âŒ Error stack:', error.stack);
        BillingState.customerPackages = [];
    } finally {
        // Always update calculations after loading packages, even if empty or error
        updateCalculations();
        // Also refresh the display table
        displayCustomerPackagesTable(BillingState.customerPackages || []);
    }
}


function loadCustomerAppointments(customerId) {
    const appointmentsDiv = document.getElementById('customerAppointments');
    if (!appointmentsDiv) {
        console.log('âš ï¸ Appointments div not found - skipping (likely in edit mode)');
        return;
    }
    appointmentsDiv.innerHTML = '<div style="padding: var(--space-4); text-align: center;"><small><i class="fas fa-spinner spinner"></i> Loading appointments...</small></div>';

    fetch(`/api/customer/${customerId}/appointments`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                displayCustomerAppointments(data.appointments || []);
            } else {
                appointmentsDiv.innerHTML = '<div style="padding: var(--space-8); text-align: center; color: var(--spa-danger);"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p class="mb-0"><strong>Error Loading Appointments</strong></p><small>Please try again</small></div>';
            }
        })
        .catch(err => {
            console.error('Error loading appointments:', err);
            appointmentsDiv.innerHTML = '<div style="padding: var(--space-8); text-align: center; color: var(--spa-danger);"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p class="mb-0"><strong>Error Loading Appointments</strong></p><small>Please try again</small></div>';
        });

    // Also load packages display
    loadCustomerPackagesDisplay(customerId);
}

function loadCustomerPackagesDisplay(customerId) {
    const packagesDiv = document.getElementById('customerPackagesTable');
    packagesDiv.innerHTML = '<div style="padding: var(--space-4); text-align: center;"><small><i class="fas fa-spinner spinner"></i> Loading packages...</small></div>';

    fetch(`/integrated-billing/customer-packages/${customerId}`)
        .then(res => res.json())
        .then(data => {
            // Use the new display function which handles empty packages
            displayCustomerPackagesTable(data.packages || []);
        })
        .catch(err => {
            console.error('Error loading customer packages:', err);
            packagesDiv.innerHTML = `
                <div style="padding: var(--space-8); text-align: center; color: var(--spa-danger);">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p class="mb-0"><strong>Error Loading Packages</strong></p>
                    <small>Please try again</small>
                </div>`;
        });
}

function refreshCustomerPackages(customerId, updatedPackages) {
    // Immediately update UI with the updated packages or fetch fresh data
    if (updatedPackages && updatedPackages.length > 0) {
        // Update the display with fresh data
        console.log('Refreshing package display after invoice creation', updatedPackages);
    }

    // Fetch fresh packages from server (fallback or additional verification)
    fetch(`/integrated-billing/customer-packages/${customerId}`, { cache: 'no-store' })
        .then(r => r.json())
        .then(j => {
            if (j.success) {
                displayCustomerPackagesTable(j.packages);
                console.log('Package balances refreshed successfully');
            }
        })
        .catch(err => console.error('Error refreshing packages:', err));
}

function displayCustomerPackagesTable(packages) {
    const packagesDiv = document.getElementById('customerPackagesTable');

    if (!packages || packages.length === 0) {
        packagesDiv.innerHTML = `
            <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
                <thead style="background: var(--spa-gray-100); position: sticky; top: 0;">
                    <tr>
                        <th style="padding: 0.5rem;">Package Name</th>
                        <th style="padding: 0.5rem;">Type</th>
                        <th style="padding: 0.5rem;">Balance/Services</th>
                        <th style="padding: 0.5rem;">Status</th>
                        <th style="padding: 0.5rem;">Expiry</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-box-open fa-2x mb-2"></i>
                            <p class="mb-0">No active packages</p>
                        </td>
                    </tr>
                </tbody>
            </table>`;
        return;
    }

    let html = `
        <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
            <thead style="background: var(--spa-gray-100); position: sticky; top: 0;">
                <tr>
                    <th style="padding: 0.5rem;">Package Name</th>
                    <th style="padding: 0.5rem;">Type</th>
                    <th style="padding: 0.5rem;">Balance/Services</th>
                    <th style="padding: 0.5rem;">Status</th>
                    <th style="padding: 0.5rem;">Expiry</th>
                </tr>
            </thead>
            <tbody>`;

    packages.forEach(pkg => {
        const packageName = pkg.name || 'Unknown Package';
        const packageType = pkg.package_type || 'N/A';
        const status = pkg.status || 'active';

        // Determine status badge
        let statusBadge = '';
        if (status === 'active') {
            statusBadge = '<span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Active</span>';
        } else if (status === 'expired') {
            statusBadge = '<span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Expired</span>';
        } else if (status === 'completed') {
            statusBadge = '<span style="background: #e5e7eb; color: #374151; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Completed</span>';
        } else if (status === 'inactive') {
            statusBadge = '<span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Inactive</span>';
        }

        // Display balance based on package type - USE EXACT FIELD NAMES FROM BACKEND
        let balanceText = '';
        let balanceDetails = '';

        if (packageType === 'prepaid') {
            // FIXED: Use correct field names from API response
            const remaining = pkg.credit?.remaining || 0;
            const total = pkg.credit?.total || 0;
            const usedPct = total > 0 ? ((total - remaining) / total * 100).toFixed(0) : 0;
            balanceText = `â‚¹${remaining.toFixed(2)} / â‚¹${total.toFixed(2)}`;
            balanceDetails = `
                <div class="progress mt-1" style="height: 5px;">
                    <div class="progress-bar bg-success" style="width: ${100 - usedPct}%"></div>
                </div>`;
        } else if (packageType === 'service_package') {
            // FIXED: Use correct field names from API response (sessions.remaining and sessions.total)
            const remaining = pkg.sessions?.remaining || 0;
            const total = pkg.sessions?.total || 0;
            const usedPct = total > 0 ? ((total - remaining) / total * 100).toFixed(0) : 0;
            balanceText = `${remaining} / ${total} sessions`;
            balanceDetails = `
                <div class="progress mt-1" style="height: 5px;">
                    <div class="progress-bar bg-success" style="width: ${100 - usedPct}%"></div>
                </div>`;
        } else if (packageType === 'membership') {
            // For memberships, show unlimited badge and usage count
            const usageCount = pkg.usage_count || 0;
            balanceText = `<span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Unlimited</span>`;
            balanceDetails = `<small class="text-muted">âœ“ Used ${usageCount} times</small>`;
        } else if (packageType === 'student_offer') {
            // For student offers, show discount percentage in balance column
            const discountPct = pkg.discount_percentage || 0;
            balanceText = `<span style="background: #e9d5ff; color: #6b21a8; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem; font-weight: bold;">${discountPct}% OFF</span>`;
            if (pkg.package_price) {
                balanceDetails = `<small class="text-muted">Package: â‚¹${pkg.package_price}</small>`;
            }
        }

        // Format expiry date - check both valid_to and expires_on
        let expiryDate = '';
        if (packageType === 'student_offer' && pkg.valid_from && pkg.valid_to) {
            // Show validity period for student offers
            expiryDate = `<small>${pkg.valid_from} to<br>${pkg.valid_to}</small>`;
            // Add details button if conditions exist
            if (pkg.conditions) {
                const escapedName = JSON.stringify(pkg.name || '');
                const escapedServiceNames = JSON.stringify(pkg.applicable_service_names || '');
                const escapedConditions = JSON.stringify(pkg.conditions || '');
                expiryDate += `<br><button type="button" class="btn btn-sm btn-outline-info mt-1" onclick="showStudentOfferDetails(${escapedName}, '${pkg.discount_percentage}', ${escapedServiceNames}, '${pkg.valid_from}', '${pkg.valid_to}', '${pkg.valid_days}', ${escapedConditions})"><i class="fas fa-info-circle"></i> Details</button>`;
            }
        } else {
            expiryDate = (pkg.valid_to || pkg.expires_on) ?
                new Date(pkg.valid_to || pkg.expires_on).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'No expiry';
        }

        // Type badge
        let typeBadge = '';
        if (packageType === 'prepaid') {
            typeBadge = '<span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Prepaid</span>';
        } else if (packageType === 'service_package') {
            typeBadge = '<span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Service</span>';
        } else if (packageType === 'membership') {
            typeBadge = '<span style="background: #e9d5ff; color: #4338ca; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Membership</span>';
        } else if (packageType === 'yearly') {
            typeBadge = '<span style="background: #e0e7ff; color: #4338ca; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Yearly</span>';
        } else if (packageType === 'student_offer') {
            typeBadge = '<span class="badge bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><i class="fas fa-graduation-cap me-1"></i>Student Offer</span>';
        }


        // Format service name display - ONLY for service packages
        let serviceNameDisplay = '';
        if (packageType === 'service_package' && pkg.service_name && pkg.service_name !== 'null' && pkg.service_name !== 'Any Service') {
            serviceNameDisplay = `<br><small class="text-muted"><i class="fas fa-spa"></i> ${pkg.service_name}</small>`;
        } else if (packageType === 'membership' && pkg.services && pkg.services.length > 0) {
            const serviceNames = pkg.services.map(s => s.service_name).join(', ');
            serviceNameDisplay = `<br><small class="text-muted"><i class="fas fa-spa"></i> ${serviceNames}</small>`;
        } else if (packageType === 'yearly') {
            // Extract discount from package name or show "All Services"
            const nameParts = pkg.name.split(' - ');
            const discountInfo = nameParts.length > 1 ? nameParts[1] : 'Yearly Discount';
            serviceNameDisplay = `<br><small class="text-muted"><i class="fas fa-percentage"></i> ${discountInfo} on all services</small>`;
        } else if (packageType === 'student_offer') {
            // Enhanced student offer display
            let studentOfferDetails = '';
            if (pkg.applicable_service_names) {
                studentOfferDetails += `<br><small class="text-primary"><i class="fas fa-graduation-cap me-1"></i>${pkg.applicable_service_names}</small>`;
            }
            if (pkg.discount_percentage) {
                studentOfferDetails += `<br><small class="text-success"><i class="fas fa-tag me-1"></i>${pkg.discount_percentage}% Discount</small>`;
            }
            if (pkg.valid_days) {
                studentOfferDetails += `<br><small class="text-info"><i class="fas fa-calendar-check me-1"></i>Valid: ${pkg.valid_days}</small>`;
            }
            serviceNameDisplay = studentOfferDetails;
        }

        html += `
            <tr style="border-bottom: 1px solid var(--spa-gray-200);">
                <td style="padding: 0.5rem;">
                    <strong>${packageName}</strong>
                    ${serviceNameDisplay}
                </td>
                <td style="padding: 0.5rem;">${typeBadge}</td>
                <td style="padding: 0.5rem;">
                    <strong style="font-size: 1.1em;">${balanceText}</strong>
                    ${balanceDetails}
                </td>
                <td style="padding: 0.5rem;">${statusBadge}</td>
                <td style="padding: 0.5rem;">
                    <small>${expiryDate}</small>
                </td>
            </tr>`;
    });

    html += `
            </tbody>
        </table>`;

    packagesDiv.innerHTML = html;
}


function resetCustomerAppointments() {
    // Clear tracking when customer changes
    addedAppointmentIds.clear();
    document.getElementById('customerAppointments').innerHTML =
        '<div style="padding: var(--space-4); text-align: center; color: var(--spa-gray-500);"><small><i class="fas fa-info-circle"></i> Select customer to view appointments</small></div>';

    // Also reset packages table
    document.getElementById('customerPackagesTable').innerHTML =
        '<div style="padding: var(--space-4); text-align: center; color: var(--spa-gray-500);"><small><i class="fas fa-gift"></i> Select customer to view active packages</small></div>';
}


    // Track which appointments have been added to bill
    const addedAppointmentIds = new Set();

    function displayCustomerAppointments(appointments) {
        const appointmentsDiv = document.getElementById('customerAppointments');

        if (!appointments || !appointments.length) {
            appointmentsDiv.innerHTML = `
                <div style="padding: var(--space-8); text-align: center; color: var(--spa-gray-500);">
                    <i class="fas fa-calendar-times fa-2x mb-2" style="opacity: 0.5;"></i>
                    <p class="mb-0"><strong>No Booked Appointments</strong></p>
                    <small>This customer has no confirmed appointments ready for billing</small>
                </div>`;
            return;
        }

        let html = `
            <div style="padding: 0;">
                <div style="background: var(--spa-gray-100); padding: 8px 12px; border-bottom: 1px solid var(--spa-gray-300);">
                    <small style="color: var(--spa-gray-600);"><i class="fas fa-info-circle me-1"></i>Click "Add to Bill" to include appointment in invoice</small>
                </div>
                <table class="table table-sm mb-0" style="font-size: 0.875rem;">
                    <thead style="background: var(--spa-gray-100); position: sticky; top: 0; z-index: 1;">
                        <tr>
                            <th style="padding: 8px;">Service</th>
                            <th style="padding: 8px;">Staff</th>
                            <th style="padding: 8px;">Date & Time</th>
                            <th style="padding: 8px; text-align: right;">Price</th>
                            <th style="padding: 8px; width: 120px;">Action</th>
                        </tr>
                    </thead>
                    <tbody>`;

        appointments.forEach(apt => {
            const aptDate = new Date(apt.appointment_date);
            const dateStr = aptDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = apt.start_time || aptDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            const statusBadge = apt.status === 'completed' ?
                '<span class="badge bg-success" style="font-size: 0.7rem;">Done</span>' :
                apt.status === 'confirmed' ?
                '<span class="badge bg-info" style="font-size: 0.7rem;">Confirmed</span>' :
                '<span class="badge bg-warning" style="font-size: 0.7rem;">Scheduled</span>';

            const isAdded = addedAppointmentIds.has(apt.id);

            // Safely escape service and staff names
            const serviceName = (apt.service_name || 'Service not specified').replace(/'/g, "\\'").replace(/"/g, '\\"');
            const staffName = (apt.staff_name || 'Not assigned').replace(/'/g, "\\'").replace(/"/g, '\\"');

            html += `
                <tr style="border-bottom: 1px solid var(--spa-gray-200); ${isAdded ? 'background: #f0f0f0;' : ''}">
                    <td style="padding: 8px;">
                        <div style="font-weight: 600; color: var(--spa-gray-900);">${apt.service_name || 'Service not specified'}</div>
                        <small style="color: var(--spa-gray-500);">${apt.service_duration ? apt.service_duration + ' min' : ''} ${statusBadge}</small>
                    </td>
                    <td style="padding: 8px;">
                        <small style="color: var(--spa-gray-700);">${apt.staff_name || 'Not assigned'}</small>
                    </td>
                    <td style="padding: 8px;">
                        <small style="color: var(--spa-gray-700);">${dateStr}<br>${timeStr}</small>
                    </td>
                    <td style="padding: 8px; text-align: right;">
                        <strong style="color: var(--spa-primary);">â‚¹${(apt.service_price || 0).toFixed(2)}</strong>
                    </td>
                    <td style="padding: 8px;">
                        <button type="button"
                                class="btn btn-sm ${isAdded ? 'btn-success' : 'btn-primary'} w-100"
                                onclick="addAppointmentToBill(${apt.id}, '${serviceName}', ${apt.service_id || 'null'}, ${apt.staff_id || 'null'}, ${apt.service_price || 0}, ${apt.service_duration || 60})"
                                ${isAdded ? 'disabled' : ''}
                                style="font-size: 0.75rem; padding: 4px 8px;">
                            ${isAdded ? '<i class="fas fa-check"></i> Added' : '<i class="fas fa-plus"></i> Add'}
                        </button>
                    </td>
                </tr>`;
        });

        html += `
                    </tbody>
                </table>
            </div>`;

        appointmentsDiv.innerHTML = html;
    }

function resetCustomerPackages() {
    BillingState.customerPackages = null; // Clear from state
    addedAppointmentIds.clear(); // Also clear added appointments tracking
    updateCalculations();
    displayCustomerPackagesTable([]); // Clear the display table
}


    function addAppointmentToBill(appointmentId, serviceName, serviceId, staffId, servicePrice, serviceDuration) {
      console.log(`Adding appointment ${appointmentId} to bill`, { serviceName, serviceId, staffId, servicePrice, serviceDuration });

      const container = document.getElementById('servicesContainer');
      if (!container) {
        console.error('Services container not found');
        return null;
      }

      // normalize inputs
      const norm = v => (v === undefined || v === null || v === 'null' || v === '' ? null : v);
      const aId   = norm(appointmentId);
      const sId   = norm(serviceId);
      const stId  = norm(staffId);
      const sPrice= typeof servicePrice === 'number' && !Number.isNaN(servicePrice) ? servicePrice : null;
      const sDur  = typeof serviceDuration === 'number' && !Number.isNaN(serviceDuration) ? serviceDuration : null;

      // Try to find an existing row for this appointment or add a new one
      let targetRow = null;
      for (const row of container.querySelectorAll('.service-row')) {
        const apptInput = row.querySelector('input[name="appointment_ids[]"]');
        if (apptInput && apptInput.dataset.appointmentId == aId) {
          targetRow = row;
          break;
        }
      }
      if (!targetRow) {
        addServiceRow(); // appends a new .service-row at the end
        targetRow = container.lastElementChild;
      }

      // Grab controls
      const serviceSelect     = targetRow.querySelector('select[name="service_ids[]"]');
      const staffSelect       = targetRow.querySelector('select[name="staff_ids[]"]');
      const qtyInput          = targetRow.querySelector('input[name="service_quantities[]"]');
      const apptInput         = targetRow.querySelector('input[name="appointment_ids[]"]');
      const hiddenPriceInput  = targetRow.querySelector('input[name="service_prices[]"]'); // make sure you added this hidden input
      const removeBtn         = targetRow.querySelector('.btn-danger');

      // Set values
      if (qtyInput) qtyInput.value = 1;

      if (apptInput) {
        apptInput.value = aId ?? '';
        apptInput.dataset.appointmentId   = aId ?? '';
        if (sPrice !== null) apptInput.dataset.servicePrice  = String(sPrice);
        if (sDur   !== null) apptInput.dataset.serviceDuration = String(sDur);
      }
        //debugger; // ex
      // Assign service & staff (supports raw selects or Select2)
      if (serviceSelect && sId !== null) {
          const setSelectValue = (el, val) => {
            if (window.jQuery && jQuery.fn.select2 && jQuery(el).hasClass('select2-hidden-accessible')) {
              jQuery(el).val(String(val)).trigger('change');
            } else {
              el.value = String(val);
              el.dispatchEvent(new Event('change', { bubbles: true }));
            }
          };

        setSelectValue(serviceSelect, sId);
      }

      if (staffSelect && stId !== null) {
        if (window.jQuery && jQuery.fn && jQuery.fn.select2 && jQuery(staffSelect).hasClass('select2-hidden-accessible')) {
          jQuery(staffSelect).val(String(stId)).trigger('change');
        } else {
          staffSelect.value = String(stId);
        }
      }

      // Mark as added
      addedAppointmentIds.add(aId);
      if (removeBtn) removeBtn.style.display = 'block';

      // If appointment price missing, fall back to the service base price for this row
      if (hiddenPriceInput) {
        let price = sPrice;
        if (price === null && serviceSelect && serviceSelect.selectedOptions.length) {
          price = parseFloat(serviceSelect.selectedOptions[0].dataset.price) || 0;
        }
        hiddenPriceInput.value = (price ?? 0).toFixed(2);
      }

      // Defer calculations until Select2/value updates have flushed
      requestAnimationFrame(() => {
        if (serviceSelect) {
          // Keep handleServiceChange minimal: it should just set row data; real math happens in updateCalculations()
          handleServiceChange(serviceSelect);
        }
        updateCalculations();
      });

      // Refresh appointments display to show "Added" state (non-blocking)
      const clientId = document.getElementById('client_id')?.value;
      if (clientId) loadCustomerAppointments(clientId);

      return targetRow;
    }


    function removeAppointmentFromBill(appointmentId) {
        const container = document.getElementById('servicesContainer');
        if (!container) return;

        // Find and remove the row with this appointment ID
        const rows = container.querySelectorAll('.service-row');
        let rowToRemove = null;
        for (const row of rows) {
            const appointmentInput = row.querySelector('input[name="appointment_ids[]"]');
            if (appointmentInput && appointmentInput.dataset.appointmentId == appointmentId) {
                rowToRemove = row;
                break;
            }
        }

        if (rowToRemove) {
            // If it's the only row and it contains this appointment, clear it instead of removing
            if (rows.length === 1 && rowToRemove.querySelector('input[name="appointment_ids[]"]')?.dataset.appointmentId == appointmentId) {
                // Clear inputs but keep the row structure
                rowToRemove.querySelectorAll('select, input').forEach(input => {
                    input.value = ''; // Clear all values
                    if (input.name?.includes('appointment_ids[]')) {
                        delete input.dataset.appointmentId; // Remove tracking attribute
                        delete input.dataset.servicePrice;
                        delete input.dataset.serviceDuration;
                    }
                });
                // Also reset quantity to 1 if it exists
                const qtyInput = rowToRemove.querySelector('input[name="service_quantities[]"]');
                if (qtyInput) qtyInput.value = 1;

                console.log(`Cleared inputs in existing row for appointment ID ${appointmentId}`);
            } else {
                rowToRemove.remove(); // Remove the entire row
                console.log(`Removed row associated with appointment ID ${appointmentId}`);
            }
        }

        // Remove from tracking set
        addedAppointmentIds.delete(appointmentId);
        console.log('Removed appointment ID from tracking:', appointmentId);

        updateCalculations();

        // Refresh appointments display to show "Add" button state
        const clientId = document.getElementById('client_id').value;
        if (clientId) {
            loadCustomerAppointments(clientId);
        }
    }

    // ==========================================
    // BATCH MANAGEMENT
    // ==========================================
    function loadBatches(productSelect) {
        const row = productSelect.closest('.item-row');
        const batchSelect = row.querySelector('.batch-select');
        const batchInfo = row.querySelector('.batch-info');
        const priceInput = row.querySelector('input[name="product_prices[]"]');
        const productId = parseInt(productSelect.value);

        console.log('ðŸ”„ loadBatches called for product:', productId);

        if (!productId) {
            batchSelect.innerHTML = '<option value="">Select Product</option>';
            batchSelect.disabled = true;
            batchInfo.innerHTML = '';
            if (priceInput) priceInput.value = '';
            updateCalculations(); // Recalculate in case product was deselected
            return;
        }

        // Check cache first
        if (BillingState.batchCache[productId]) {
            console.log('ðŸ—„ï¸ Cache hit for product ID:', productId);
            populateBatchSelect(BillingState.batchCache[productId], batchSelect, batchInfo, priceInput);
            return;
        }

        // Load from API
        console.log('ðŸ—„ï¸ Cache miss for product ID:', productId, 'Fetching batches...');
        batchSelect.innerHTML = '<option value="">Loading...</option>';
        batchSelect.disabled = true;
        if (priceInput) priceInput.value = '';

        fetch(`/api/inventory/batches/for-product/${productId}`)
            .then(res => {
                console.log('ðŸ“¡ Batch API response status:', res.status);
                if (!res.ok) throw new Error(`HTTP error ${res.status}`);
                return res.json();
            })
            .then(data => {
                console.log('ðŸ“¦ Batch API response data:', data);
                if (data.success && data.batches) {
                    const batches = data.batches || [];
                    BillingState.batchCache[productId] = batches; // Cache the result
                    populateBatchSelect(batches, batchSelect, batchInfo, priceInput);
                } else {
                    throw new Error(data.message || 'Failed to load batches from API');
                }
            })
            .catch(err => {
                console.error('âŒ Error loading batches:', err);
                console.error('âŒ Error stack:', err.stack);
                batchSelect.innerHTML = '<option value="">Error loading batches</option>';
                batchInfo.innerHTML = '<span class="text-danger">Failed to load batches</span>';
            });
    }

    function populateBatchSelect(batches, batchSelect, batchInfo, priceInput) {
        // Filter available batches and sort by expiry (FIFO)
        const availableBatches = batches
            .filter(b => b.qty_available > 0)
            .sort((a, b) => {
                // Prioritize batches with expiry dates, sort by date
                if (a.expiry_date && b.expiry_date) {
                    return new Date(a.expiry_date) - new Date(b.expiry_date);
                } else if (a.expiry_date) {
                    return -1; // a has expiry, b doesn't, so a comes first
                } else if (b.expiry_date) {
                    return 1; // b has expiry, a doesn't, so b comes first
                }
                return 0; // Both have no expiry, order doesn't matter
            });

        console.log('ðŸ”¢ Available batches after filtering and sorting:', availableBatches);

        if (!availableBatches.length) {
            batchSelect.innerHTML = '<option value="">Out of Stock</option>';
            batchSelect.disabled = true;
            batchInfo.innerHTML = '<span class="text-danger">Out of stock</span>';
            if (priceInput) priceInput.value = '';
            updateCalculations(); // Recalculate
            return;
        }

        batchSelect.innerHTML = availableBatches.map((b, i) =>
            `<option value="${b.id}" data-price="${b.selling_price || b.unit_price || 0}" data-qty="${b.qty_available}" ${i === 0 ? 'selected' : ''}>
                ${b.batch_name} - ${b.qty_available} available
            </option>`
        ).join('');
        batchSelect.disabled = false;

        // Reinitialize Select2 on batch dropdown after populating options
        const $batchSelect = $(batchSelect);
        if ($batchSelect.hasClass('select2-hidden-accessible')) {
            $batchSelect.select2('destroy');
        }
        $batchSelect.select2({
            theme: 'bootstrap-5',
            placeholder: 'Select Batch',
            allowClear: true,
            width: '100%'
        });

        // Display first batch info
        const firstBatch = availableBatches[0];
        const expiry = firstBatch.expiry_date ?
            new Date(firstBatch.expiry_date).toLocaleDateString() : 'No expiry';
        const expiryClass = firstBatch.is_near_expiry ? 'text-warning' : '';
        batchInfo.innerHTML = `<small>Avail: ${firstBatch.qty_available} | <span class="${expiryClass}">Exp: ${expiry}</span></small>`;

        // Set price from batch
        if (priceInput && (firstBatch.selling_price || firstBatch.unit_price)) {
            priceInput.value = parseFloat(firstBatch.selling_price || firstBatch.unit_price).toFixed(2);
        } else if (priceInput) {
            priceInput.value = '0.00'; // Default to 0 if no price found
        }

        // Add event listener for batch change (only if not already added to prevent duplicates)
        if (!batchSelect.dataset.changeListenerAdded) {
            batchSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const qty = selectedOption.dataset.qty;
                const price = selectedOption.dataset.price;
                const batch = availableBatches.find(b => b.id == this.value);

                console.log('â–¶ï¸ Batch selection changed:', { value: this.value, price, qty });

                if (batch) {
                    const exp = batch.expiry_date ? new Date(batch.expiry_date).toLocaleDateString() : 'No expiry';
                    const expClass = batch.is_near_expiry ? 'text-warning' : '';
                    batchInfo.innerHTML = `<small>Avail: ${qty} | <span class="${expClass}">Exp: ${exp}</span></small>`;

                    if (priceInput && price) {
                        priceInput.value = parseFloat(price).toFixed(2);
                    } else if (priceInput) {
                        priceInput.value = '0.00'; // Default if price is missing
                    }
                }
                updateCalculations();
            });
            batchSelect.dataset.changeListenerAdded = 'true'; // Mark as added
        }

        updateCalculations();
    }

    // ==========================================
    // ROW MANAGEMENT
    // ==========================================
        function addServiceRow() {
          console.log('âž• addServiceRow called');
          const container = document.getElementById('servicesContainer');
          const firstRow = container.querySelector('.service-row');
          if (!firstRow) return;

          const newRow = firstRow.cloneNode(true);

          // Destroy Select2 instances in the cloned row
          $(newRow).find('.select2-hidden-accessible').each(function() {
            $(this).select2('destroy');
          });

          // Clear select values
          newRow.querySelectorAll('select').forEach(sel => {
            sel.value = '';
          });

          // Clear inputs except Qty default
          newRow.querySelectorAll('input').forEach(inp => {
            if (inp.name?.includes('quantities')) { inp.value = '1'; }
            else { inp.value = ''; }
            if (inp.name === 'appointment_ids[]') {
              delete inp.dataset.appointmentId;
              delete inp.dataset.servicePrice;
              delete inp.dataset.serviceDuration;
            }
            inp.classList.remove('is-invalid');
          });

          const removeButton = newRow.querySelector('.btn-danger');
          if (removeButton) removeButton.style.display = 'block';

          container.appendChild(newRow);

          // Initialize Select2 on the new row's dropdowns
          initializeRowDropdowns(newRow);

          console.log('âœ… New service row added with searchable dropdowns');
        }


    function addProductRow() {
        console.log('âž• addProductRow called');
        const container = document.getElementById('productsContainer');
        const firstRow = container.querySelector('.product-row'); // Get the template row

        if (!firstRow) {
            console.error('Template product row not found!');
            return;
        }

        const newRow = firstRow.cloneNode(true); // Clone the template row

        // Destroy Select2 instances in the cloned row if they exist
        $(newRow).find('.select2-hidden-accessible').each(function() {
            $(this).select2('destroy');
        });

        // Clear values in the new row
        newRow.querySelectorAll('select, input').forEach(input => {
            input.value = '';
            input.classList.remove('is-invalid');

            if (input.type === 'number' && input.name.includes('quantities')) {
                input.value = '1';
            }
        });

        // Reset batch select to default state
        const batchSelect = newRow.querySelector('.batch-select');
        batchSelect.innerHTML = '<option value="">Select Product</option>';
        batchSelect.disabled = true;
        newRow.querySelector('.batch-info').innerHTML = '';
        if (newRow.querySelector('input[name="product_prices[]"]')) {
            newRow.querySelector('input[name="product_prices[]"]').value = '';
        }

        // Ensure remove button is visible
        const removeButton = newRow.querySelector('.btn-danger');
        if (removeButton) removeButton.style.display = 'block';

        container.appendChild(newRow);

        // Initialize Select2 on the new row's dropdowns
        initializeRowDropdowns(newRow);

        console.log('âœ… New product row added with searchable dropdowns');
    }

    function removeRow(button) {
        console.log('ðŸ—‘ï¸ removeRow called for button:', button);
        const row = button.closest('.item-row');
        if (row) {
            // Check if this row has an appointment ID
            const appointmentInput = row.querySelector('input[name="appointment_ids[]"]');
            if (appointmentInput && appointmentInput.value) {
                const appointmentId = parseInt(appointmentInput.value);
                console.log('ðŸ—‘ï¸ Row has appointment ID:', appointmentId);
                
                // Remove from tracking set
                addedAppointmentIds.delete(appointmentId);
                console.log('âœ… Removed appointment ID from tracking:', appointmentId);
                
                // Refresh appointments display to update button state
                const clientId = document.getElementById('client_id')?.value;
                if (clientId) {
                    loadCustomerAppointments(clientId);
                }
            }
            
            row.remove();
            console.log('âœ… Row removed');
            updateCalculations(); // Recalculate totals after removing a row
        } else {
            console.error('Could not find closest .item-row to remove');
        }
    }

    // Helper to clear all service and product rows
    function clearBillingRows() {
        console.log('ðŸ§¹ Clearing all service and product rows');
        document.getElementById('servicesContainer').innerHTML = '';
        document.getElementById('productsContainer').innerHTML = '';

        // Re-add the template row for services
        const servicesContainer = document.getElementById('servicesContainer');
        const serviceTemplateHtml = `
            <div class="item-row service-row">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label class="form-label">Service</label>
                            <select class="form-select form-select-lg" name="service_ids[]" onchange="handleServiceChange(this)">
                                <option value="">Select Service</option>
                                {% for service in services %}
                                <option value="{{ service.id }}" data-price="{{ "%.2f"|format(service.price|float) }}">
                                    {{ service.name }} - â‚¹{{ "{:,.2f}".format(service.price) }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label required">Staff</label>
                            <select class="form-select form-select-lg" name="staff_ids[]">
                                <option value="">Select Staff</option>
                                {% for staff in staff_members %}
                                <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Staff required</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Qty</label>
                            <input type="number" class="form-control" name="service_quantities[]" value="1" min="0.5" step="0.5" oninput="updateCalculations()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Apt ID</label>
                            <input type="number" class="form-control" name="appointment_ids[]" placeholder="Optional">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)" style="display:none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        servicesContainer.innerHTML = serviceTemplateHtml;

        // Re-add the template row for products
        const productsContainer = document.getElementById('productsContainer');
        const productTemplateHtml = `
            <div class="item-row product-row">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="form-label">Product</label>
                            <select class="form-select form-select-lg" name="product_ids[]" onchange="loadBatches(this)">
                                <option value="">Select Product</option>
                                {% for product in inventory_items %}
                                <option value="{{ product.id }}">{{ product.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Batch</label>
                            <select class="form-select form-select-lg batch-select" name="batch_ids[]" disabled>
                                <option value="">Select Product</option>
                            </select>
                            <div class="batch-info"></div>
                            <div class="invalid-feedback">Batch required</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label required">Staff</label>
                            <select class="form-select form-select-lg" name="product_staff_ids[]">
                                <option value="">Select Staff</option>
                                {% for staff in staff_members %}
                                <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Staff required</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Qty</label>
                            <input type="number" class="form-control" name="product_quantities[]" value="1" min="0.01" step="0.01" oninput="updateCalculations()">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label class="form-label">Price</label>
                            <input type="number" class="form-control" name="product_prices[]" placeholder="â‚¹0.00" min="0" step="0.01" oninput="updateCalculations()">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)" style="display:none;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        productsContainer.innerHTML = productTemplateHtml;

        // Reset tracking for added appointments
        addedAppointmentIds.clear();
        console.log('âœ… Billing rows cleared and template rows re-added.');
    }

    // ==========================================
    // CALCULATIONS
    // ==========================================
    function handleServiceChange(selectElement) {
        console.log('â–¶ï¸ handleServiceChange triggered for select:', selectElement);

        const row = selectElement.closest('.service-row');
        if (!row) return;

        const selectedOption = selectElement.options[selectElement.selectedIndex];
        if (!selectedOption || !selectedOption.value) {
            // Clear package benefits if service is deselected
            row.querySelector('.package-benefit')?.remove();
            updateCalculations();
            return;
        }

        const serviceId = parseInt(selectedOption.value); // Convert to number
        const servicePrice = parseFloat(selectedOption.getAttribute('data-price')) || 0;

        console.log('ðŸ” Service selected:', {
            serviceId,
            servicePrice,
            optionText: selectedOption.text,
            dataPrice: selectedOption.getAttribute('data-price')
        });

        // Set the service price in a data attribute for calculations
        row.dataset.serviceId = serviceId;
        row.dataset.basePrice = servicePrice;

        console.log('ðŸ”„ Service changed - checking for package benefits:', { serviceId, servicePrice });

        // Check if customer is selected
        const customerId = BillingState.selectedCustomerId;
        if (customerId && BillingState.customerPackages && BillingState.customerPackages.length > 0) {
            console.log('ðŸŽ Customer selected with packages - applying benefits');

            // Apply package benefit check
            const benefit = checkPackageBenefit(serviceId, servicePrice); // Removed quantity as it's not needed here

            // Visual feedback for package application
            if (benefit && benefit.discount > 0) {
                let benefitDiv = row.querySelector('.package-benefit');
                if (!benefitDiv) {
                    benefitDiv = document.createElement('div');
                    row.appendChild(benefitDiv);
                }

                if (benefit.benefitType === 'student_discount') {
                    benefitDiv.className = 'package-benefit student-discount';
                    benefitDiv.innerHTML = `<i class="fas fa-graduation-cap"></i> ${benefit.packageUsed}: -â‚¹${benefit.discount.toFixed(2)}`;
                } else {
                    benefitDiv.className = 'package-benefit';
                    benefitDiv.innerHTML = `<i class="fas fa-gift"></i> ${benefit.packageUsed || benefit.benefitType}: -â‚¹${benefit.discount.toFixed(2)}`;
                }
            } else {
                // Remove benefit indicator if no benefit applies
                row.querySelector('.package-benefit')?.remove();
            }
        }

        // Update calculations immediately to apply package benefits
        updateCalculations();
    }

    function updateCalculations() {
        console.log('ðŸ’° updateCalculations called');

        let servicesSubtotal = 0;
        let productsSubtotal = 0;
        let packageDeductions = 0;

        // CRITICAL: Track cumulative package usage across all services in this invoice
        const cumulativePackageUsage = {};

        // --- Calculate Services Subtotal ---
        console.log('ðŸ”„ Calculating services subtotal...');
        document.querySelectorAll('.service-row').forEach((row, index) => {
            const serviceSelect = row.querySelector('select[name="service_ids[]"]');
            const qtyInput = row.querySelector('input[name="service_quantities[]"]');
            const appointmentIdInput = row.querySelector('input[name="appointment_ids[]"]');
            const priceInput = row.querySelector('input[name="service_prices[]"]'); // Assuming a hidden price input

            const serviceId = serviceSelect?.value;
            const quantity = parseFloat(qtyInput?.value) || 0;
            let basePrice = parseFloat(serviceSelect.selectedOptions[0]?.dataset.price) || 0; // Get base price from dataset initially

            // If a price input exists, use its value as it might be updated by package benefits or explicitly set
            // However, for services, this price input might not be present or intended for user input.
            // The base price is usually derived from the service select's data-price.
            // Let's ensure we're using the correct price source.

            let effectivePrice = basePrice; // Start with the base price from the service option
            let itemTotal = 0;
            let benefitApplied = { discount: 0, packageUsed: null, packageId: null, benefitType: null };

            // Check if it's an appointment row
            const isAppointmentRow = appointmentIdInput && appointmentIdInput.value;
            if (isAppointmentRow) {
                const appointmentPrice = parseFloat(appointmentIdInput.dataset.servicePrice);
                const appointmentDuration = parseFloat(appointmentIdInput.dataset.serviceDuration);

                if (!isNaN(appointmentPrice)) {
                    basePrice = appointmentPrice; // Use the price from the appointment as base price
                    console.log('âž• Appointment row detected - Base price from appointment:', basePrice);
                } else {
                    console.warn('âš ï¸ Appointment row detected but price is missing.');
                    basePrice = 0; // Set basePrice to 0 if missing
                }
                effectivePrice = basePrice; // Ensure effective price is also based on appointment price
            }

            // Apply package benefits for ALL service rows (including appointments)
            if (serviceId && quantity > 0) {
                // Check for applicable package benefits with cumulative usage tracking
                benefitApplied = checkPackageBenefit(serviceId, basePrice, quantity, cumulativePackageUsage);
                console.log('ðŸŽ Package benefit check for service row:', { serviceId, basePrice, quantity, isAppointmentRow, benefitApplied });

                if (benefitApplied.discount > 0) {
                    const discountAmount = Math.min(benefitApplied.discount, basePrice * quantity); // Ensure discount doesn't exceed item total
                    packageDeductions += discountAmount;

                    // Calculate effective price after benefit per unit
                    effectivePrice = Math.max(0, basePrice - discountAmount / quantity);
                    itemTotal = effectivePrice * quantity; // Item total after applying benefit

                    // Update the hidden price input if it exists, for accurate submission
                    if (priceInput) {
                        priceInput.value = effectivePrice.toFixed(2);
                        console.log(`â¬†ï¸ Updated priceInput in row due to package benefit: ${priceInput.value}`);
                    }

                    // Show package benefit indicator on the row
                    let benefitDiv = row.querySelector('.package-benefit');
                    if (!benefitDiv) {
                        benefitDiv = document.createElement('div');
                        row.appendChild(benefitDiv);
                    }

                    // Apply special styling for student offers
                    if (benefitApplied.benefitType === 'student_discount') {
                        benefitDiv.className = 'package-benefit student-discount';
                        benefitDiv.innerHTML = `<i class="fas fa-graduation-cap"></i> ${benefitApplied.packageUsed}: -â‚¹${discountAmount.toFixed(2)}`;
                    } else {
                        benefitDiv.className = 'package-benefit';
                        benefitDiv.innerHTML = `<i class="fas fa-gift"></i> ${benefitApplied.packageUsed || benefitApplied.benefitType}: -â‚¹${discountAmount.toFixed(2)}`;
                    }
                } else {
                    // No benefit applied, ensure price input is updated with base price if it exists
                    if (priceInput) {
                        priceInput.value = basePrice.toFixed(2);
                    }
                    row.querySelector('.package-benefit')?.remove(); // Remove benefit indicator if no benefit
                    itemTotal = basePrice * quantity; // Item total is just base price * quantity
                }
                console.log('âž• Service row added to subtotal:', { serviceId, quantity, basePrice, effectivePrice, itemTotal, benefitApplied });
            } else if (serviceSelect && !serviceId) {
                // If serviceSelect is empty, clear related fields and remove benefit
                row.querySelector('.package-benefit')?.remove();
                if (priceInput) priceInput.value = ''; // Clear price input if service is deselected
            }

            // Only add to subtotal if it's a valid item and not an appointment row that couldn't be priced
            if (serviceId && quantity > 0 && !isNaN(itemTotal) && itemTotal >= 0) {
                 servicesSubtotal += itemTotal;
            } else if (isAppointmentRow && !isNaN(itemTotal) && itemTotal >= 0) {
                // Add to subtotal even if it's an appointment row, as long as it's calculable
                servicesSubtotal += itemTotal;
            }
        });

        // --- Calculate Products Subtotal ---
        console.log('ðŸ”„ Calculating products subtotal...');
        document.querySelectorAll('.product-row').forEach((row, index) => {
            const qtyInput = row.querySelector('input[name="product_quantities[]"]');
            const priceInput = row.querySelector('input[name="product_prices[]"]');
            const quantity = parseFloat(qtyInput?.value) || 0;
            const price = parseFloat(priceInput?.value) || 0; // Price entered by user or from batch

            if (quantity > 0 && price > 0) {
                const itemTotal = price * quantity;
                productsSubtotal += itemTotal;
                console.log('âž• Product row added to subtotal:', { quantity, price, itemTotal });
            } else if (qtyInput && priceInput && (quantity <= 0 || price <= 0)) {
                 console.log('âš ï¸ Product row skipped due to zero quantity or price:', { quantity, price });
            }
        });

        const subtotal = servicesSubtotal + productsSubtotal;

        // --- Discount Calculation ---
        const discountType = document.querySelector('select[name="discount_type"]')?.value || 'percentage';
        const discountValue = parseFloat(document.querySelector('input[name="discount_value"]')?.value) || 0;
        let discountAmount = 0;

        // Discount applies after package benefits
        // Note: Package benefits are already applied to itemTotal, so subtotal already reflects the reduced prices
        const taxableAmountBeforeDiscount = Math.max(0, subtotal);

        if (discountType === 'percentage') {
            discountAmount = (taxableAmountBeforeDiscount * discountValue) / 100;
        } else { // 'amount'
            discountAmount = discountValue;
        }
        discountAmount = Math.max(0, discountAmount); // Ensure discount is not negative

        // --- Calculate Taxable Amount ---
        const taxableAmountAfterTax = Math.max(0, taxableAmountBeforeDiscount - discountAmount);

        // --- Calculate GST (Services INCLUSIVE, Products NO GST - MRP is final) ---
        // Use dynamic GST rates from database configuration
        const gstRate = (GSTSettings.cgst_rate + GSTSettings.sgst_rate) / 100; // Total GST rate

        // For services: GST is INCLUSIVE (extract from price)
        const serviceBase = servicesSubtotal / (1 + gstRate);
        const serviceGst = servicesSubtotal - serviceBase;

        // For products: NO GST (MRP is final price, already includes all taxes)
        const productBase = productsSubtotal;
        const productGst = 0;

        // Total GST before discount adjustment (only from services)
        let totalGst = serviceGst + productGst;

        // Adjust GST proportionally if discount is applied
        if (discountAmount > 0 && taxableAmountBeforeDiscount > 0) {
            const discountFactor = taxableAmountAfterTax / taxableAmountBeforeDiscount;
            totalGst = totalGst * discountFactor;
        }

        // Split into CGST and SGST based on configured rates
        const totalGstRate = GSTSettings.cgst_rate + GSTSettings.sgst_rate;
        const cgstAmount = totalGstRate > 0 ? totalGst * (GSTSettings.cgst_rate / totalGstRate) : 0;
        const sgstAmount = totalGstRate > 0 ? totalGst * (GSTSettings.sgst_rate / totalGstRate) : 0;

        // --- Additional Charges & Tips ---
        const additionalCharges = parseFloat(document.querySelector('input[name="additional_charges"]')?.value) || 0;
        const tips = parseFloat(document.querySelector('input[name="tips_amount"]')?.value) || 0;

        // --- Grand Total (base + tax + charges + tips) ---
        const grandTotal = taxableAmountAfterTax + totalGst + additionalCharges + tips;

        // --- Update Display ---
        document.getElementById('servicesSubtotal').textContent = `â‚¹${servicesSubtotal.toFixed(2)}`;
        document.getElementById('productsSubtotal').textContent = `â‚¹${productsSubtotal.toFixed(2)}`;
        document.getElementById('subtotalAmount').textContent = `â‚¹${subtotal.toFixed(2)}`;
        document.getElementById('packageDeductions').textContent = `-â‚¹${packageDeductions.toFixed(2)}`;
        document.getElementById('discountAmount').textContent = `-â‚¹${discountAmount.toFixed(2)}`;
        document.getElementById('taxableAmount').textContent = `â‚¹${taxableAmountAfterTax.toFixed(2)}`;
        document.getElementById('cgstAmount').textContent = `â‚¹${cgstAmount.toFixed(2)}`;
        document.getElementById('sgstAmount').textContent = `â‚¹${sgstAmount.toFixed(2)}`;
        document.getElementById('additionalCharges').textContent = `â‚¹${additionalCharges.toFixed(2)}`;
        document.getElementById('tipsDisplay').textContent = `â‚¹${tips.toFixed(2)}`;
        document.getElementById('grandTotal').textContent = `â‚¹${grandTotal.toFixed(2)}`;

        console.log('ðŸ“Š Totals Updated:', {
            servicesSubtotal: servicesSubtotal.toFixed(2),
            productsSubtotal: productsSubtotal.toFixed(2),
            subtotal: subtotal.toFixed(2),
            packageDeductions: packageDeductions.toFixed(2),
            discountAmount: discountAmount.toFixed(2),
            taxableAmountAfterTax: taxableAmountAfterTax.toFixed(2),
            additionalCharges: additionalCharges.toFixed(2),
            tips: tips.toFixed(2),
            grandTotal: grandTotal.toFixed(2)
        });
        console.log('âœ… Calculations complete');
    }

    // Function to check package benefits for a given service
    // IMPORTANT: This now calls the backend API for real-time benefit calculation
    function checkPackageBenefit(serviceId, servicePrice, quantity = 1, cumulativePackageUsage = {}) {
        // CRITICAL: Convert serviceId to number for proper comparison
        const numericServiceId = parseInt(serviceId);

        console.log('ðŸ” checkPackageBenefit called:', {serviceId: numericServiceId, servicePrice, quantity});
        console.log('ðŸ“Š Input validation:', {
            serviceIdType: typeof numericServiceId,
            servicePriceType: typeof servicePrice,
            quantityType: typeof quantity,
            serviceIdValue: numericServiceId,
            servicePriceValue: servicePrice,
            quantityValue: quantity
        });

        // Quick check: if no customer selected, no benefits apply
        if (!BillingState.selectedCustomerId) {
            console.log('â„¹ï¸ No customer selected - no benefits');
            return { discount: 0, packageUsed: null, packageId: null, benefitType: null };
        }

        // Use cached packages for quick client-side display
        const customerPackages = BillingState.customerPackages;

        if (!customerPackages || customerPackages.length === 0) {
            console.log('â„¹ï¸ No packages available for customer');
            console.log('ðŸ“¦ customerPackages state:', customerPackages);
            return { discount: 0, packageUsed: null, packageId: null, benefitType: null };
        }

        console.log('ðŸ“¦ Total packages to check:', customerPackages.length);

        let totalBenefit = 0;
        let appliedPackage = null;
        let appliedPackageId = null;
        let benefitType = null;

        // Check each package
        for (const pkg of customerPackages) {
            console.log(`ðŸ” Checking package: ${pkg.name} (type: ${pkg.package_type})`);

            // Skip packages that are explicitly inactive or expired
            if (pkg.status === 'expired' || pkg.status === 'completed' || pkg.is_active === false) {
                 console.log('â­ï¸ Package skipped (expired/completed):', pkg.name);
                 continue;
            }

            // Check if package has remaining benefits based on package_type
            if (pkg.package_type === 'service_package') {
                const remaining = pkg.sessions?.remaining || 0;
                if (remaining <= 0) {
                    console.log('â­ï¸ Package skipped (no sessions):', pkg.name);
                    continue;
                }
            } else if (pkg.package_type === 'prepaid') {
                const remaining = pkg.credit?.remaining || 0;
                if (remaining <= 0) {
                    console.log('â­ï¸ Package skipped (no credit):', pkg.name);
                    continue;
                }
            }

            // --- PRIORITY 1: Yearly membership - applies percentage discount to ALL services ---
            if (pkg.package_type === 'yearly') {
                // Extract discount percentage from package name (e.g., "Gold Membership - 20% Discount")
                const discountMatch = pkg.name.match(/(\d+)%/);
                if (discountMatch) {
                    const discountPercent = parseInt(discountMatch[1]);
                    const totalServiceCost = servicePrice * quantity;
                    totalBenefit = (totalServiceCost * discountPercent) / 100;
                    appliedPackage = pkg.name;
                    benefitType = 'yearly_discount';
                    console.log(`âœ… Yearly membership discount applied: ${pkg.name}, ${discountPercent}% off = â‚¹${totalBenefit.toFixed(2)}`);
                    break; // Use first matching yearly package
                } else {
                    // If no percentage in name, check for discount_percentage field
                    if (pkg.discount_percentage && pkg.discount_percentage > 0) {
                        const discountPercent = pkg.discount_percentage;
                        const totalServiceCost = servicePrice * quantity;
                        totalBenefit = (totalServiceCost * discountPercent) / 100;
                        appliedPackage = pkg.name || 'Yearly Membership';
                        benefitType = 'yearly_discount';
                        console.log(`âœ… Yearly membership discount applied: ${appliedPackage}, ${discountPercent}% off = â‚¹${totalBenefit.toFixed(2)}`);
                        break;
                    } else {
                        console.log('â­ï¸ Yearly package found but no percentage available:', pkg.name);
                    }
                }
            }

            // --- PRIORITY 2: Service Package / Free Session Logic ---
            else if (pkg.package_type === 'service_package') {
                // CRITICAL: Convert package service_id to number for comparison
                const packageServiceId = parseInt(pkg.service_id);

                console.log(`ðŸ” Service package match check:`, {
                    packageServiceId: packageServiceId,
                    requestedServiceId: numericServiceId,
                    match: packageServiceId === numericServiceId,
                    remainingSessions: pkg.sessions?.remaining || 0
                });

                if (packageServiceId === numericServiceId && pkg.sessions && pkg.sessions.remaining > 0) {
                    const sessionsToUse = Math.min(quantity, pkg.sessions.remaining);
                    const pricePerSession = servicePrice;
                    const benefitAmount = pricePerSession * sessionsToUse;

                    totalBenefit += benefitAmount;
                    appliedPackage = pkg.name;
                    appliedPackageId = pkg.assignment_id || pkg.id;
                    benefitType = 'free_sessions';

                    console.log('   Benefit Details:', {
                        sessionsToUse,
                        benefitAmount: benefitAmount.toFixed(2),
                        remainingAfter: pkg.sessions.remaining - sessionsToUse
                    });

                    break; // First matching package wins
                } else {
                    console.log('âŒ Service package NOT applied (no sessions):', {
                        packageService: packageServiceId,
                        selectedService: numericServiceId,
                        remaining: pkg.sessions?.remaining || 0
                    });
                }
            }
            // --- PRIORITY 3: Prepaid / Credit Package Logic ---
            else if (pkg.package_type === 'prepaid') {
                const packageKey = `${pkg.assignment_id || pkg.id}`;
                const alreadyUsed = cumulativePackageUsage[packageKey] || 0;
                const originalRemaining = pkg.credit?.remaining || 0;
                const adjustedRemaining = Math.max(0, originalRemaining - alreadyUsed);
                const serviceCost = servicePrice * quantity;

                console.log('ðŸ“Š Prepaid package cumulative check:', {
                    packageName: pkg.name,
                    originalRemaining: originalRemaining.toFixed(2),
                    alreadyUsedInInvoice: alreadyUsed.toFixed(2),
                    adjustedRemaining: adjustedRemaining.toFixed(2),
                    serviceCost: serviceCost.toFixed(2)
                });

                if (adjustedRemaining > 0 && serviceCost > 0) {
                    const creditToUse = Math.min(serviceCost, adjustedRemaining);
                    console.log('âœ… Prepaid credit APPLIED:', {
                        packageId: pkg.assignment_id,
                        packageName: pkg.name,
                        creditRemaining: originalRemaining,
                        adjustedRemaining: adjustedRemaining.toFixed(2),
                        serviceCost: serviceCost.toFixed(2),
                        creditToUse: creditToUse.toFixed(2)
                    });

                    totalBenefit += creditToUse;
                    appliedPackage = pkg.name;
                    appliedPackageId = pkg.assignment_id || pkg.id;
                    benefitType = 'prepaid_credit';

                    // Track cumulative usage for this invoice
                    cumulativePackageUsage[packageKey] = alreadyUsed + creditToUse;

                    break; // First matching package wins
                } else {
                    console.log('âŒ Prepaid credit NOT applied:', {
                        hasAdjustedRemaining: adjustedRemaining > 0,
                        serviceCostPositive: serviceCost > 0,
                        reason: adjustedRemaining <= 0 ? 'Package exhausted by previous services' : 'Invalid service cost'
                    });
                }
            }
            // --- PRIORITY 4: Membership Package Logic ---
            else if (pkg.package_type === 'membership' && pkg.status === 'active') {
                // Memberships provide unlimited access ONLY to specific services
                const includedServices = pkg.services || [];
                const includedServiceIds = includedServices.map(s => s.service_id);

                console.log('ðŸŽ« Checking membership:', {
                    packageName: pkg.name,
                    includedServiceIds: includedServiceIds,
                    requestedServiceId: numericServiceId,
                    isServiceIncluded: includedServiceIds.includes(numericServiceId)
                });

                // Check if the requested service is included in the membership
                if (includedServiceIds.includes(numericServiceId)) {
                    const serviceCost = servicePrice * quantity;

                    console.log('âœ… Membership APPLIED (unlimited access):', {
                        packageId: pkg.assignment_id || pkg.id,
                        packageName: pkg.name,
                        serviceName: includedServices.find(s => s.service_id == numericServiceId)?.service_name || 'Unknown',
                        serviceCost: serviceCost.toFixed(2),
                        quantity: quantity
                    });

                    totalBenefit += serviceCost;
                    appliedPackage = pkg.name;
                    appliedPackageId = pkg.assignment_id || pkg.id;
                    benefitType = 'membership_unlimited';

                    break; // First matching package wins
                } else {
                    console.log('â­ï¸ Membership skipped (service not included):', {
                        packageName: pkg.name,
                        requestedServiceId: numericServiceId,
                        includedServices: includedServices.map(s => s.service_name)
                    });
                }
            }
            // --- PRIORITY 5: Student Offer packages ---
            else if (pkg.package_type === 'student_offer' && pkg.discount_percentage > 0) {
                // Validate student offer dates and valid days
                const validFrom = pkg.valid_from || '';
                const validTo = pkg.valid_to || '';
                const validDays = pkg.valid_days || '';

                if (!isStudentOfferValid(validFrom, validTo, validDays)) {
                    console.log(`âŒ Student offer ${pkg.name} is not valid today (expired or wrong day)`);
                    continue; // Skip this offer
                }

                console.log(`âœ… Student offer ${pkg.name} is valid today`);

                // Student offers only apply to specific services that were selected when creating the offer
                const applicableServiceIds = pkg.applicable_service_ids || [];
                // CRITICAL: Ensure numeric comparison
                const numericApplicableIds = applicableServiceIds.map(id => parseInt(id));

                const appliesToThisService = applicableServiceIds.length === 0 || numericApplicableIds.includes(numericServiceId);

                if (appliesToThisService) {
                    const totalServiceCost = servicePrice * quantity;
                    const discountAmount = (totalServiceCost * pkg.discount_percentage) / 100;

                    totalBenefit += discountAmount;
                    appliedPackage = pkg.name;
                    appliedPackageId = pkg.assignment_id;
                    benefitType = 'student_discount';
                    console.log(`âœ… Student offer discount applied: ${pkg.name}, ${pkg.discount_percentage}% off = â‚¹${discountAmount.toFixed(2)} (service ${numericServiceId} is in applicable list: ${numericApplicableIds})`);
                    break; // Use first matching valid student offer
                } else {
                    console.log(`â­ï¸ Student offer ${pkg.name} skipped - service ${numericServiceId} not in applicable list: ${numericApplicableIds}`);
                }
            }
        }

        if (totalBenefit === 0) {
            console.log('â„¹ï¸ No package benefit applied for serviceId:', numericServiceId);
        }

        console.log('ðŸ’° Total benefit calculated:', totalBenefit.toFixed(2));
        console.log('ðŸ“¦ Package applied:', appliedPackage ? `${appliedPackage} (${benefitType})` : 'None');

        return { discount: totalBenefit, packageUsed: appliedPackage, packageId: appliedPackageId, benefitType: benefitType };
    }


    // ==========================================
    // VALIDATION
    // ==========================================
    function setupInputValidation() { // Renamed from validateForm to setupInputValidation for clarity
        console.log('âš™ï¸ Setting up input validation listeners');
        document.getElementById('billingForm').addEventListener('input', function(e) {
            // Remove 'is-invalid' class when user starts typing/changing input
            if (e.target.matches('select, input, textarea')) {
                e.target.classList.remove('is-invalid');
                // Also clear associated feedback if it exists
                const feedbackElement = e.target.nextElementSibling;
                if (feedbackElement && feedbackElement.classList.contains('invalid-feedback')) {
                    feedbackElement.style.display = 'none';
                }
            }
        });
    }

    // Perform validation only (no submission)
    function performValidation() {
        console.log('ðŸ” Validating form...');

        const errors = [];

        // Clear previous validation states
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');

        // 1. Check customer selection
        const clientSelect = document.getElementById('client_id');
        if (!clientSelect || !clientSelect.value) {
            errors.push('âŒ Please select a customer');
            if (clientSelect) {
                clientSelect.classList.add('is-invalid');
                // Scroll to the element if it's visible
                clientSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 2. Check if at least one service or product is added and their details
        const serviceRows = document.querySelectorAll('.service-row');
        const productRows = document.querySelectorAll('.product-row');

        let hasValidService = false;
        let hasValidProduct = false;

        // Validate services
        serviceRows.forEach((row, index) => {
            const serviceSelect = row.querySelector('select[name="service_ids[]"]');
            const staffSelect = row.querySelector('select[name="staff_ids[]"]');
            const qtyInput = row.querySelector('input[name="service_quantities[]"]');
            const appointmentIdInput = row.querySelector('input[name="appointment_ids[]"]');

            // Only validate if a service is actually selected
            if (serviceSelect && serviceSelect.value) {
                hasValidService = true; // Mark that at least one service is present

                // Check if staff is assigned for a selected service
                if (!staffSelect || !staffSelect.value) {
                    errors.push(`âŒ Service #${index + 1}: Please assign a staff member`);
                    if (staffSelect) {
                        staffSelect.classList.add('is-invalid');
                        staffSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }

                // Check quantity for non-appointment services
                if (!appointmentIdInput || !appointmentIdInput.value) {
                    const qty = parseFloat(qtyInput?.value);
                    if (isNaN(qty) || qty <= 0) {
                        errors.push(`âŒ Service #${index + 1}: Please enter a valid quantity`);
                        if (qtyInput) {
                            qtyInput.classList.add('is-invalid');
                            qtyInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            }
        });

        // Validate products
        productRows.forEach((row, index) => {
            const productSelect = row.querySelector('select[name="product_ids[]"]');
            const batchSelect = row.querySelector('select[name="batch_ids[]"]');
            const staffSelect = row.querySelector('select[name="product_staff_ids[]"]');
            const qtyInput = row.querySelector('input[name="product_quantities[]"]');
            const priceInput = row.querySelector('input[name="product_prices[]"]');

            // Only validate if a product is actually selected
            if (productSelect && productSelect.value) {
                hasValidProduct = true; // Mark that at least one product is present

                // Check if batch is selected for a selected product
                if (!batchSelect || !batchSelect.value) {
                    errors.push(`âŒ Product #${index + 1}: Please select a batch`);
                    if (batchSelect) {
                        batchSelect.classList.add('is-invalid');
                        batchSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }

                // Check if staff is assigned for a selected product
                if (!staffSelect || !staffSelect.value) {
                    errors.push(`âŒ Product #${index + 1}: Please assign a staff member`);
                    if (staffSelect) {
                        staffSelect.classList.add('is-invalid');
                        staffSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }

                // Check quantity for a selected product
                const qty = parseFloat(qtyInput?.value);
                if (isNaN(qty) || qty <= 0) {
                    errors.push(`âŒ Product #${index + 1}: Please enter a valid quantity`);
                    if (qtyInput) {
                        qtyInput.classList.add('is-invalid');
                        qtyInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }

                // Check price for a selected product (can be 0, but not negative)
                const price = parseFloat(priceInput?.value);
                if (isNaN(price) || price < 0) {
                    errors.push(`âŒ Product #${index + 1}: Please enter a valid price`);
                    if (priceInput) {
                        priceInput.classList.add('is-invalid');
                        priceInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            }
        });

        // Check if at least one item (service or product) is added
        if (!hasValidService && !hasValidProduct) {
            errors.push('âŒ Please add at least one service or product to the invoice');
            // Scroll to the top of the form to guide user
            document.getElementById('billingForm')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // 3. Check payment method selection
        const paymentMethodSelect = document.getElementById('paymentMethod');
        if (!paymentMethodSelect || !paymentMethodSelect.value) {
            errors.push('âŒ Please select a payment method');
            if (paymentMethodSelect) {
                paymentMethodSelect.classList.add('is-invalid');
                paymentMethodSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        } else if (paymentMethodSelect.value === 'cheque') {
            // Validate cheque number if payment method is cheque
            const chequeNumberInput = document.getElementById('chequeNumber');
            if (!chequeNumberInput || !chequeNumberInput.value.trim()) {
                errors.push('âŒ Please enter the cheque number');
                if (chequeNumberInput) {
                    chequeNumberInput.classList.add('is-invalid');
                    chequeNumberInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }

        // Show errors if any
        if (errors.length > 0) {
            const errorMessage = `<strong>Please fix the following issues:</strong><br><br>${errors.join('<br>')}`;
            showNotification(errorMessage, 'error', 8000);
            console.log('âŒ Validation failed:', errors);
            return false;
        }

        console.log('âœ… Validation passed');
        return true;
    }

    function validateAndSubmitForm() {
        console.log('ðŸ” Validating form...');

        // Validation logic
        if (!performValidation()) {
            return false;
        }

        console.log('âœ… Validation passed');
        console.log('âœ… Submitting form via AJAX...');

        // Get form data
        const form = document.getElementById('billingForm');
        const formData = new FormData(form);

        // Show loading state
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.classList.add('btn-loading');
        saveBtn.disabled = true;

        // Submit via AJAX to handle response properly
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            saveBtn.classList.remove('btn-loading');
            saveBtn.disabled = false;

            if (data.success) {
                // Show success message
                alert(`âœ… ${data.message}\n\nInvoice ID: ${data.invoice_id}`);

                // Refresh package balances after successful invoice creation
                const customerId = document.getElementById('client_id').value;
                if (customerId) {
                    refreshCustomerPackages(customerId, data.updated_packages); // Pass updated_packages if available
                }


                // Redirect to invoice detail page
                window.location.href = `/integrated-billing/invoice/${data.invoice_id}`;
            } else {
                // Show error message
                alert(`âŒ Error: ${data.message || 'Failed to create invoice'}`);
            }
        })
        .catch(error => {
            saveBtn.classList.remove('btn-loading');
            saveBtn.disabled = false;
            console.error('Error:', error);
            alert('âŒ An error occurred while creating the invoice. Please try again.');
        });

        return false; // Prevent default form submission
    }

    // ==========================================
    // FORM SUBMISSION
    // ==========================================
    function handleFormSubmit(event) {
        event.preventDefault();
        console.log('ðŸš€ Form submit event caught.');

        // The actual validation and submission logic is now in validateAndSubmitForm
        // We call it here, and it will handle the form submission if validation passes.
        validateAndSubmitForm();
    }

    // Save and print function with AJAX handling
    async function saveAndPrint() {
        console.log('ðŸ” Validating form for save & print...');

        // Validation logic
        if (!performValidation()) {
            return false;
        }

        console.log('âœ… Validation passed');
        console.log('âœ… Submitting form and preparing to print...');

        // Get form data
        const form = document.getElementById('billingForm');
        const formData = new FormData(form);

        // Show loading state
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.classList.add('btn-loading');
        saveBtn.disabled = true;

        // Submit via AJAX
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            saveBtn.classList.remove('btn-loading');
            saveBtn.disabled = false;

            if (data.success) {
                // Refresh package balances after successful invoice creation
                const customerId = document.getElementById('client_id').value;
                if (customerId) {
                    refreshCustomerPackages(customerId, data.updated_packages); // Pass updated_packages if available
                }

                // Redirect to invoice detail page with print parameter and autoprint hash
                window.location.href = `/integrated-billing/invoice/${data.invoice_id}?print=true#autoprint`;
            } else {
                alert(`âŒ Error: ${data.message || 'Failed to create invoice'}`);
            }
        })
        .catch(error => {
            saveBtn.classList.remove('btn-loading');
            saveBtn.disabled = false;
            console.error('Error:', error);
            alert('âŒ An error occurred while creating the invoice. Please try again.');
        });

        return false;
    }

    // ==========================================
    // STUDENT OFFER UTILITIES
    // ==========================================
    function showStudentOfferDetails(name, discount, services, validFrom, validTo, validDays, conditions) {
        const modal = document.createElement('div');
        modal.className = 'modal fade show';
        modal.style.display = 'block';
        modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
        modal.setAttribute('tabindex', '-1');
        modal.innerHTML = `
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h5 class="modal-title"><i class="fas fa-graduation-cap me-2"></i>${name}</h5>
                        <button type="button" class="btn-close btn-close-white" onclick="this.closest('.modal').remove()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <h6 class="text-muted mb-2"><i class="fas fa-tag me-2"></i>Discount</h6>
                            <div class="alert alert-success mb-3">
                                <h4 class="mb-0"><strong>${discount}% OFF</strong></h4>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-muted mb-2"><i class="fas fa-spa me-2"></i>Applicable Services</h6>
                            <p class="mb-0">${services}</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-muted mb-2"><i class="fas fa-calendar me-2"></i>Validity Period</h6>
                            <p class="mb-0"><strong>${validFrom}</strong> to <strong>${validTo}</strong></p>
                        </div>
                        <div class="mb-0">
                            <h6 class="text-muted mb-2"><i class="fas fa-info-circle me-2"></i>Terms & Conditions</h6>
                            <p class="mb-0 text-muted small">${conditions}</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    function isStudentOfferValid(validFrom, validTo, validDays) {
        // Check date validity
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (validFrom) {
            const fromDate = new Date(validFrom);
            fromDate.setHours(0, 0, 0, 0);
            if (today < fromDate) {
                console.log(`âŒ Student offer not yet valid. Starts: ${validFrom}`);
                return false;
            }
        }

        if (validTo) {
            const toDate = new Date(validTo);
            toDate.setHours(23, 59, 59, 999);
            if (today > toDate) {
                console.log(`âŒ Student offer expired. Ended: ${validTo}`);
                return false;
            }
        }

        // Check valid days
        if (validDays && validDays !== 'All Days' && validDays !== '') {
            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const todayDay = daysOfWeek[today.getDay()];

            // Parse valid days (e.g., "Mon-Fri", "Weekends Only", "Mon,Wed,Fri")
            let isValidDay = false;

            if (validDays === 'Mon-Fri') {
                isValidDay = today.getDay() >= 1 && today.getDay() <= 5;
            } else if (validDays === 'Mon-Sat') {
                isValidDay = today.getDay() >= 1 && today.getDay() <= 6;
            } else if (validDays === 'Weekends Only') {
                isValidDay = today.getDay() === 0 || today.getDay() === 6;
            } else if (validDays.includes(todayDay)) {
                isValidDay = true;
            }

            if (!isValidDay) {
                console.log(`âŒ Student offer not valid today (${todayDay}). Valid days: ${validDays}`);
                return false;
            }
        }

        console.log(`âœ… Student offer is valid for today`);
        return true;
    }

    // ==========================================
    // EDIT MODE - LOAD INVOICE DATA
    // ==========================================
    function loadInvoiceEditData(invoiceData) {
        console.log('ðŸ“ Loading invoice data for editing:', invoiceData);

        // Pre-populate services
        if (invoiceData.service_items && invoiceData.service_items.length > 0) {
            console.log(`Adding ${invoiceData.service_items.length} service items`);
            invoiceData.service_items.forEach((item, index) => {
                if (index > 0) addServiceRow(); // Add new row for items after the first

                const serviceRows = document.querySelectorAll('.service-row');
                const row = serviceRows[index];

                if (row) {
                    const serviceSelect = row.querySelector('select[name="service_ids[]"]');
                    const qtyInput = row.querySelector('input[name="service_quantities[]"]');
                    const staffSelect = row.querySelector('select[name="staff_ids[]"]');
                    const aptIdInput = row.querySelector('input[name="appointment_ids[]"]');

                    if (serviceSelect) {
                        serviceSelect.value = item.service_id;
                        // Trigger change event to recalculate pricing and package benefits
                        $(serviceSelect).trigger('change');
                    }
                    if (qtyInput) qtyInput.value = item.quantity;
                    if (staffSelect) staffSelect.value = item.staff_id;
                    if (aptIdInput) aptIdInput.value = item.appointment_id || '';
                }
            });
        }

        // Pre-populate products
        if (invoiceData.product_items && invoiceData.product_items.length > 0) {
            console.log(`Adding ${invoiceData.product_items.length} product items`);
            invoiceData.product_items.forEach((item, index) => {
                if (index > 0 || document.querySelectorAll('.product-row').length === 0) {
                    addProductRow(); // Add new row
                }

                const productRows = document.querySelectorAll('.product-row');
                const row = productRows[index];

                if (row) {
                    const productSelect = row.querySelector('select[name="product_ids[]"]');
                    const qtyInput = row.querySelector('input[name="product_quantities[]"]');
                    const priceInput = row.querySelector('input[name="product_prices[]"]');
                    const staffSelect = row.querySelector('select[name="product_staff_ids[]"]');
                    const batchInput = row.querySelector('input[name="batch_ids[]"]');

                    if (productSelect) {
                        productSelect.value = item.product_id;
                        // Trigger change event to load batches and set pricing
                        $(productSelect).trigger('change');
                    }
                    // Set quantity and price after product selection loads batches
                    setTimeout(() => {
                        if (qtyInput) qtyInput.value = item.quantity;
                        if (priceInput) priceInput.value = item.unit_price;
                        if (staffSelect) staffSelect.value = item.staff_id;
                        if (batchInput) batchInput.value = item.batch_id || '';
                    }, 200);
                }
            });
        }

        // Pre-populate discount, charges, tips
        if (invoiceData.discount_amount) {
            const discountInput = document.getElementById('discount_amount');
            if (discountInput) discountInput.value = invoiceData.discount_amount;
        }

        if (invoiceData.additional_charges) {
            const chargesInput = document.getElementById('additional_charges');
            if (chargesInput) chargesInput.value = invoiceData.additional_charges;
        }

        if (invoiceData.tips_amount) {
            const tipsInput = document.getElementById('tips_amount');
            if (tipsInput) tipsInput.value = invoiceData.tips_amount;
        }

        // Pre-populate tax settings
        if (invoiceData.is_interstate) {
            const interstateCheckbox = document.getElementById('is_interstate');
            if (interstateCheckbox) interstateCheckbox.checked = true;
        }

        // Trigger full recalculation after all items are loaded
        setTimeout(() => {
            updateCalculations();
            console.log('âœ… Invoice data loaded and calculations updated');
        }, 500); // Increased delay to ensure all product batches are loaded
    }

    // ==========================================
    // UTILITIES
    // ==========================================
    function toggleChequeNumber() {
        const paymentMethod = document.getElementById('paymentMethod').value;
        const chequeField = document.getElementById('chequeNumberField');
        const chequeInput = document.getElementById('chequeNumber');

        if (paymentMethod === 'cheque') {
            chequeField.style.display = 'block';
            chequeInput.required = true;
        } else {
            chequeField.style.display = 'none';
            chequeInput.required = false;
            chequeInput.value = '';
        }
    }

    function showNotification(message, type = 'info', duration = 5000) {
        console.log(`ðŸ”” Showing notification: [${type}] ${message}`);
        const alertClass = {
            success: 'alert-success',
            danger: 'alert-danger',
            warning: 'alert-warning',
            info: 'alert-info'
        }[type] || 'alert-info';

        const notification = document.createElement('div');
        notification.className = `toast-notification alert ${alertClass}`;
        notification.innerHTML = `
            <div style="white-space: pre-line;">${message}</div>
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, duration);
    }

    // ==========================================
    // APPOINTMENT CANCELLATION
    // ==========================================
    function goToUnakiBooking() {
        const customerId = document.getElementById('customer_id').value;
        if (customerId) {
            window.location.href = `/unaki-booking?customer_id=${customerId}`;
        } else {
            window.location.href = '/unaki-booking';
        }
    }

    function cancelAllCustomerAppointmentsFromBilling() {
        // Get customer ID from the selected customer in the billing form
        const customerId = document.getElementById('client_id').value;
        const customerSelect = document.getElementById('client_id');
        const customerName = customerSelect.options[customerSelect.selectedIndex]?.text || 'this customer';

        if (!customerId) {
            showNotification('Please select a customer first to cancel their appointments.', 'warning');
            return;
        }

        // Fetch all appointments for this customer
        fetch(`/api/customer/${customerId}/appointments`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.appointments) {
                    // Filter for active appointments (scheduled or confirmed)
                    const activeAppointments = data.appointments.filter(
                        apt => apt.status === 'scheduled' || apt.status === 'confirmed'
                    );

                    if (activeAppointments.length === 0) {
                        showNotification('No active appointments found for this customer.', 'info');
                        return;
                    }

                    const appointmentsList = activeAppointments.map(apt =>
                        `- ${apt.service_name || 'Unknown Service'} on ${new Date(apt.appointment_date).toLocaleDateString()} at ${apt.start_time || 'Unknown Time'}`
                    ).join('\n');

                    const confirmMessage = `Are you sure you want to cancel ALL ${activeAppointments.length} active appointment(s) for ${customerName}?\n\nAppointments:\n${appointmentsList}`;

                    if (confirm(confirmMessage)) {
                        // Show loading indicator or disable button
                        const cancelButton = document.querySelector('button[onclick="cancelAllCustomerAppointmentsFromBilling()"]');
                        if (cancelButton) {
                            cancelButton.innerHTML = '<i class="fas fa-spinner spinner"></i> Cancelling...';
                            cancelButton.disabled = true;
                        }

                        // Cancel all appointments using the booking update endpoint
                        const cancelPromises = activeAppointments.map(apt =>
                            fetch(`/api/unaki/bookings/${apt.id}`, {
                                method: 'PATCH',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ status: 'cancelled' })
                            }).then(r => r.json())
                        );

                        Promise.all(cancelPromises)
                            .then(results => {
                                const successCount = results.filter(r => r.success).length;
                                const failCount = results.length - successCount;

                                if (failCount === 0) {
                                    showNotification(`âœ… Successfully cancelled all ${successCount} appointments for ${customerName}`, 'success');
                                    // Refresh appointments list after successful cancellation
                                    loadCustomerAppointments(customerId);
                                    // Optionally reload page if needed, or clear rows
                                    // location.reload();
                                } else {
                                    showNotification(`âš ï¸ Cancelled ${successCount} appointments, ${failCount} failed for ${customerName}. Please check individual statuses.`, 'warning');
                                    // Refresh appointments list
                                    loadCustomerAppointments(customerId);
                                }
                            })
                            .catch(error => {
                                console.error('Error cancelling appointments:', error);
                                showNotification('An error occurred while cancelling appointments. Please try again.', 'danger');
                            })
                            .finally(() => {
                                // Re-enable button if it exists
                                if (cancelButton) {
                                    cancelButton.innerHTML = '<i class="fas fa-times-circle me-2"></i>Cancel All Appointments';
                                    cancelButton.disabled = false;
                                }
                            });
                    }
                } else {
                    showNotification('Failed to load customer appointments. Please try again.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error loading appointments:', error);
                showNotification('An error occurred while fetching appointments. Please check your connection.', 'danger');
            });
    }

    function previewInvoice() {
    console.log('ðŸ” Preview invoice called');

    // Use performValidation to check form validity
    if (!performValidation()) {
        console.log('âŒ Validation failed');
        return;
    }

    // Show loading state on the preview button
    const previewBtn = document.getElementById('previewBtn');
    const originalText = previewBtn.innerHTML;
    previewBtn.disabled = true;
    previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating Preview...';

    // Collect customer info - FIX: Use correct element ID 'client_id'
    const customerSelect = document.getElementById('client_id');
    if (!customerSelect) {
        console.error('âŒ Customer select element not found');
        alert('Error: Customer selection field not found');
        previewBtn.disabled = false;
        previewBtn.innerHTML = originalText;
        return;
    }
    
    const selectedCustomerOption = customerSelect.options[customerSelect.selectedIndex];
    const customerName = selectedCustomerOption ? selectedCustomerOption.text.split(' - ')[0] : 'Customer';
    const customerPhone = selectedCustomerOption?.getAttribute('data-phone') || 'N/A';
    const isInterstate = document.getElementById('is_interstate')?.checked || false;

    // Collect services - FIX: Use correct field names
    const services = [];
    document.querySelectorAll('.service-row').forEach((row, index) => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const qtyInput = row.querySelector('input[name="service_quantities[]"]');
        const staffSelect = row.querySelector('select[name="staff_ids[]"]');
        
        if (serviceSelect && serviceSelect.value) {
            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            const serviceName = selectedOption.text.split(' - ')[0];
            const price = parseFloat(selectedOption.dataset.price || 0);
            const qty = parseFloat(qtyInput?.value || 1);
            
            services.push({
                service_id: serviceSelect.value,
                service_name: serviceName,
                quantity: qty,
                price: price,
                total: price * qty,
                staff_id: staffSelect?.value || null,
                staff_name: staffSelect?.options[staffSelect.selectedIndex]?.text || 'N/A'
            });
        }
    });

    // Collect products - FIX: Use correct field names
    const products = [];
    document.querySelectorAll('.product-row').forEach((row, index) => {
        const productSelect = row.querySelector('select[name="product_ids[]"]');
        const qtyInput = row.querySelector('input[name="product_quantities[]"]');
        const priceInput = row.querySelector('input[name="product_prices[]"]');
        const batchSelect = row.querySelector('select[name="batch_ids[]"]');
        
        if (productSelect && productSelect.value && batchSelect && batchSelect.value) {
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            const productName = selectedOption.text;
            const price = parseFloat(priceInput?.value || 0);
            const qty = parseFloat(qtyInput?.value || 1);
            
            products.push({
                product_id: productSelect.value,
                product_name: productName,
                quantity: qty,
                price: price,
                total: price * qty,
                batch_id: batchSelect.value
            });
        }
    });

    // Collect totals
    const servicesSubtotal = parseFloat(document.getElementById('servicesSubtotal')?.textContent.replace(/[â‚¹,]/g, '') || 0);
    const productsSubtotal = parseFloat(document.getElementById('productsSubtotal')?.textContent.replace(/[â‚¹,]/g, '') || 0);
    const packageDeductions = parseFloat(document.getElementById('packageDeductionsAmount')?.textContent.replace(/[â‚¹,]/g, '') || 0);
    const discountAmount = parseFloat(document.getElementById('discountAmount')?.textContent.replace(/[â‚¹,]/g, '') || 0);
    const additionalCharges = parseFloat(document.getElementById('additionalCharges')?.value || 0);
    const tips = parseFloat(document.getElementById('tips')?.value || 0);

    // Prepare JSON payload
    const previewData = {
        customer_name: customerName,
        customer_phone: customerPhone,
        is_interstate: isInterstate,
        services: services,
        products: products,
        services_subtotal: servicesSubtotal,
        products_subtotal: productsSubtotal,
        package_deductions: packageDeductions,
        discount_amount: discountAmount,
        additional_charges: additionalCharges,
        tips: tips
    };

    console.log('ðŸ“Š Preview data:', previewData);

    // Call the preview API endpoint
    fetch('/api/invoice-preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(previewData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('âœ… Preview generation response:', data);
        if (data.success && data.preview_html) {
            const previewWindow = window.open('', '_blank', 'width=900,height=700');
            if (previewWindow) {
                previewWindow.document.write(data.preview_html);
                previewWindow.document.close();
                console.log('ðŸ‘ Preview opened successfully.');
            } else {
                alert('Please allow pop-ups to view the preview');
                console.warn('âš ï¸ Pop-up blocked, could not open preview window.');
            }
        } else {
            alert('Failed to generate preview: ' + (data.error || data.message || 'Unknown error'));
            console.error('âŒ Preview generation failed:', data.error || data.message || 'Unknown error');
        }
    })
    .catch(error => {
        console.error('âŒ Error during preview generation:', error);
        alert('Error generating preview: ' + error.message);
    })
    .finally(() => {
        previewBtn.disabled = false;
        previewBtn.innerHTML = originalText;
        console.log('ðŸ‘ Preview button state restored.');
    });
}
</script>
{% endblock %}