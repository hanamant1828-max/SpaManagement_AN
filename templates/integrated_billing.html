
{% extends "base.html" %}

{% block title %}Integrated Billing & Service Management{% endblock %}

{% block extra_head %}
<style>
.billing-card {
    transition: all 0.3s ease;
}
.billing-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.package-deduction {
    color: #28a745;
    font-weight: 500;
}
.extra-charge {
    color: #dc3545;
    font-weight: 500;
}
.item-row {
    border-left: 3px solid transparent;
    padding-left: 10px;
    margin-bottom: 5px;
}
.item-row.package-item {
    border-left-color: #28a745;
    background-color: rgba(40, 167, 69, 0.1);
}
.item-row.extra-item {
    border-left-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.1);
}
.batch-info {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 2px;
}
.batch-warning {
    color: #dc3545;
    font-weight: 500;
}
.batch-success {
    color: #28a745;
    font-weight: 500;
}
.product-row {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-cash-register me-2 text-primary"></i>Integrated Billing & Service Management
            </h1>
            <p class="text-muted">Complete billing solution with package deductions, subscription management, and batch-wise inventory sales</p>
        </div>
    </div>

    <!-- Dashboard Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card billing-card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Today's Revenue
                            </div>
                            <div class="h5 mb-0 font-weight-bold">₹{{ "{:,.2f}".format(today_revenue) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card billing-card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Revenue
                            </div>
                            <div class="h5 mb-0 font-weight-bold">₹{{ "{:,.2f}".format(total_revenue) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card billing-card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pending Amount
                            </div>
                            <div class="h5 mb-0 font-weight-bold">₹{{ "{:,.2f}".format(pending_amount) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- New Invoice Creation -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-plus-circle me-2"></i>Create New Invoice
                    </h6>
                    <span class="badge badge-info">Services • Packages • Batch-wise Inventory</span>
                </div>
                <div class="card-body">
                    <form id="billingForm">
                        <!-- Customer Selection -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="client_id" class="form-label">Customer</label>
                                <select class="form-select" id="client_id" name="client_id" required>
                                    <option value="">Select Customer</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.full_name }} - {{ customer.phone }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Customer Packages</label>
                                <div id="customerPackages" class="alert alert-info">
                                    <small>Select a customer to view their active packages</small>
                                </div>
                            </div>
                        </div>

                        <!-- Services Section -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-spa me-2"></i>Services
                                <small class="text-muted">(Package deductions will be applied automatically)</small>
                            </h6>
                            <div id="servicesContainer">
                                <div class="service-row row mb-2">
                                    <div class="col-md-5">
                                        <select class="form-select" name="service_ids[]">
                                            <option value="">Select Service</option>
                                            {% for service in services %}
                                            <option value="{{ service.id }}" data-price="{{ service.price }}">
                                                {{ service.name }} - ₹{{ service.price }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" name="service_quantities[]" placeholder="Qty" min="1" value="1" step="0.5">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control" name="appointment_ids[]" placeholder="Appointment ID (Optional)">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-success btn-sm" onclick="addServiceRow()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Products & Inventory Section (Batch-wise) -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-shopping-bag me-2"></i>Products & Inventory 
                                <small class="text-muted">(Stock will be automatically reduced from batches - FIFO by expiry)</small>
                            </h6>
                            <div id="productsContainer">
                                <div class="product-row">
                                    <div class="row mb-2">
                                        <div class="col-md-4">
                                            <label class="form-label">Product</label>
                                            <select class="form-select product-select" name="product_ids[]" onchange="loadBatchesForProduct(this)">
                                                <option value="">Select Product</option>
                                                {% for product in inventory_items %}
                                                <option value="{{ product.id }}">{{ product.name }} (Total Stock: {{ product.total_stock }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Batch (Auto-selected FIFO)</label>
                                            <select class="form-select batch-select" name="batch_ids[]" disabled>
                                                <option value="">Select Product First</option>
                                            </select>
                                            <div class="batch-info"></div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Quantity</label>
                                            <input type="number" class="form-control quantity-input" name="product_quantities[]" placeholder="Qty" min="1" value="1" step="0.5" onchange="validateStock(this)">
                                            <small class="text-muted available-stock"></small>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Unit Price</label>
                                            <input type="number" class="form-control unit-price" name="product_prices[]" placeholder="Price" step="0.01" readonly>
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-success btn-sm w-100" onclick="addProductRow()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Tax & Billing Section -->
                        <div class="card mb-4 border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Professional Tax & Billing Calculations</h6>
                            </div>
                            <div class="card-body">
                                <!-- Tax Configuration -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="cgst_rate" class="form-label">CGST Rate (%)</label>
                                        <input type="number" class="form-control" id="cgst_rate" name="cgst_rate" value="9" step="0.01" min="0" max="50" onchange="updateTaxCalculations()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="sgst_rate" class="form-label">SGST Rate (%)</label>
                                        <input type="number" class="form-control" id="sgst_rate" name="sgst_rate" value="9" step="0.01" min="0" max="50" onchange="updateTaxCalculations()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="igst_rate" class="form-label">IGST Rate (%) <small class="text-muted">Interstate</small></label>
                                        <input type="number" class="form-control" id="igst_rate" name="igst_rate" value="0" step="0.01" min="0" max="50" onchange="updateTaxCalculations()">
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="is_interstate" name="is_interstate" onchange="toggleTaxType()">
                                            <label class="form-check-label" for="is_interstate">
                                                Interstate Transaction
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Discount and Additional Charges -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="discount_type" class="form-label">Discount Type</label>
                                        <select class="form-select" id="discount_type" name="discount_type" onchange="updateTaxCalculations()">
                                            <option value="amount">Amount (₹)</option>
                                            <option value="percentage">Percentage (%)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="discount_value" class="form-label">Discount Value</label>
                                        <input type="number" class="form-control" id="discount_value" name="discount_value" value="0" step="0.01" min="0" onchange="updateTaxCalculations()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="additional_charges" class="form-label">Additional Charges (₹)</label>
                                        <input type="number" class="form-control" id="additional_charges" name="additional_charges" value="0" step="0.01" min="0" onchange="updateTaxCalculations()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="tips_amount" class="form-label">Tips (₹)</label>
                                        <input type="number" class="form-control" id="tips_amount" name="tips_amount" value="0" step="0.01" min="0" onchange="updateTaxCalculations()">
                                    </div>
                                </div>

                                <!-- Live Tax Calculation Display -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <div class="row text-center">
                                                    <div class="col-md-2">
                                                        <div class="border-end">
                                                            <h6 class="text-muted mb-1">Subtotal</h6>
                                                            <h5 class="mb-0" id="display_subtotal">₹0.00</h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end">
                                                            <h6 class="text-muted mb-1">Discount</h6>
                                                            <h5 class="mb-0 text-danger" id="display_discount">₹0.00</h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end">
                                                            <h6 class="text-muted mb-1">CGST</h6>
                                                            <h5 class="mb-0 text-info" id="display_cgst">₹0.00</h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end">
                                                            <h6 class="text-muted mb-1">SGST</h6>
                                                            <h5 class="mb-0 text-info" id="display_sgst">₹0.00</h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end">
                                                            <h6 class="text-muted mb-1">Additional</h6>
                                                            <h5 class="mb-0 text-warning" id="display_additional">₹0.00</h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div>
                                                            <h6 class="text-muted mb-1">Total</h6>
                                                            <h4 class="mb-0 text-success" id="display_total">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Additional notes for this invoice"></textarea>
                        </div>

                        <!-- Payment Processing Section -->
                        <div class="card mb-4 border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Processing</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="payment_terms" class="form-label">Payment Terms</label>
                                        <select class="form-select" id="payment_terms" name="payment_terms">
                                            <option value="immediate">Immediate</option>
                                            <option value="net_15">Net 15 Days</option>
                                            <option value="net_30">Net 30 Days</option>
                                            <option value="advance">Advance Payment</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="payment_method" class="form-label">Primary Payment Method</label>
                                        <select class="form-select" id="payment_method" name="payment_method">
                                            <option value="cash">Cash</option>
                                            <option value="card">Credit/Debit Card</option>
                                            <option value="upi">UPI Payment</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="cheque">Cheque</option>
                                            <option value="mixed">Multiple Methods</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Multi-payment method section (hidden by default) -->
                                <div id="multiPaymentSection" class="mt-3" style="display: none;">
                                    <h6>Split Payment Methods:</h6>
                                    <div id="paymentMethodsContainer">
                                        <!-- Dynamic payment method rows will be added here -->
                                    </div>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="addPaymentMethod()">
                                        <i class="fas fa-plus me-1"></i>Add Payment Method
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Action Buttons -->
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-primary btn-lg w-100 mb-2" onclick="previewInvoice()">
                                    <i class="fas fa-eye me-2"></i>Preview Invoice
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-success btn-lg w-100 mb-2">
                                    <i class="fas fa-file-invoice-dollar me-2"></i>Generate Professional Invoice
                                </button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-info w-100" onclick="saveAsDraft()">
                                    <i class="fas fa-save me-2"></i>Save as Draft
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-warning w-100" onclick="sendQuotation()">
                                    <i class="fas fa-paper-plane me-2"></i>Send Quotation
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-secondary w-100" onclick="clearForm()">
                                    <i class="fas fa-undo me-2"></i>Clear Form
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Recent Invoices -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-file-invoice me-2"></i>Recent Invoices
                    </h6>
                </div>
                <div class="card-body">
                    {% if recent_invoices %}
                        {% for invoice in recent_invoices %}
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                            <div>
                                <div class="font-weight-bold">{{ invoice.invoice_number }}</div>
                                <small class="text-muted">{{ invoice.customer.full_name }}</small>
                                <br>
                                <small class="text-muted">{{ invoice.invoice_date.strftime('%d %b %Y') }}</small>
                            </div>
                            <div class="text-end">
                                <div class="font-weight-bold text-success">₹{{ "{:,.2f}".format(invoice.total_amount) }}</div>
                                {% if invoice.packages_deduction > 0 %}
                                <small class="text-success">
                                    <i class="fas fa-gift"></i> ₹{{ "{:,.2f}".format(invoice.packages_deduction) }} saved
                                </small>
                                {% endif %}
                                <br>
                                <span class="badge badge-{{ 'success' if invoice.payment_status == 'paid' else 'warning' if invoice.payment_status == 'partial' else 'danger' }}">
                                    {{ invoice.payment_status.title() }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="text-center mt-3">
                            <a href="{{ url_for('list_integrated_invoices') }}" class="btn btn-outline-primary btn-sm">
                                View All Invoices
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-file-invoice fa-3x mb-3"></i>
                            <p>No invoices created yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Professional Invoice Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">Invoice Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="viewInvoiceBtn" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-eye me-2"></i>View Invoice
                </a>
                <button type="button" id="printInvoiceBtn" class="btn btn-info" style="display: none;" onclick="printInvoice()">
                    <i class="fas fa-print me-2"></i>Print Invoice
                </button>
                <button type="button" id="emailInvoiceBtn" class="btn btn-success" style="display: none;" onclick="emailInvoice()">
                    <i class="fas fa-envelope me-2"></i>Email Invoice
                </button>
                <button type="button" id="whatsappInvoiceBtn" class="btn btn-warning" style="display: none;" onclick="whatsappInvoice()">
                    <i class="fab fa-whatsapp me-2"></i>WhatsApp Invoice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Professional Invoice Preview Modal -->
<div class="modal fade" id="invoicePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Professional Invoice Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoicePreviewBody" style="min-height: 600px;">
                <!-- Professional invoice preview will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="proceedWithInvoiceCreation()">
                    <i class="fas fa-check me-2"></i>Proceed with Invoice Creation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Add service row
function addServiceRow() {
    const container = document.getElementById('servicesContainer');
    const newRow = container.children[0].cloneNode(true);
    
    // Clear values
    newRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
    });
    
    // Change button to remove
    const button = newRow.querySelector('button');
    button.className = 'btn btn-danger btn-sm';
    button.innerHTML = '<i class="fas fa-minus"></i>';
    button.onclick = function() { this.closest('.service-row').remove(); };
    
    container.appendChild(newRow);
}

// Add product row
function addProductRow() {
    const container = document.getElementById('productsContainer');
    const newRow = container.children[0].cloneNode(true);
    
    // Clear values and reset state
    newRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
    });
    
    // Reset batch dropdown
    const batchSelect = newRow.querySelector('.batch-select');
    batchSelect.innerHTML = '<option value="">Select Product First</option>';
    batchSelect.disabled = true;
    
    // Reset info divs
    newRow.querySelector('.batch-info').innerHTML = '';
    newRow.querySelector('.available-stock').innerHTML = '';
    
    // Change button to remove
    const button = newRow.querySelector('button');
    button.className = 'btn btn-danger btn-sm w-100';
    button.innerHTML = '<i class="fas fa-minus"></i>';
    button.onclick = function() { this.closest('.product-row').remove(); };
    
    container.appendChild(newRow);
}

// Load batches for selected product (FIFO by expiry)
function loadBatchesForProduct(productSelect) {
    const productId = productSelect.value;
    const productRow = productSelect.closest('.product-row');
    const batchSelect = productRow.querySelector('.batch-select');
    const batchInfo = productRow.querySelector('.batch-info');
    const availableStock = productRow.querySelector('.available-stock');
    const unitPrice = productRow.querySelector('.unit-price');
    
    if (!productId) {
        batchSelect.innerHTML = '<option value="">Select Product First</option>';
        batchSelect.disabled = true;
        batchInfo.innerHTML = '';
        availableStock.innerHTML = '';
        unitPrice.value = '';
        return;
    }
    
    // Fetch batches for this product (FIFO by expiry)
    fetch(`/api/inventory/batches/for-product/${productId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches.length > 0) {
                batchSelect.innerHTML = '<option value="">Select Batch</option>';
                
                data.batches.forEach(batch => {
                    const option = document.createElement('option');
                    option.value = batch.id;
                    option.dataset.stock = batch.qty_available;
                    option.dataset.price = batch.selling_price || batch.unit_cost || 0;
                    option.dataset.expiry = batch.expiry_date;
                    option.dataset.batchName = batch.batch_name;
                    
                    const expiryText = batch.expiry_date ? ` (Exp: ${new Date(batch.expiry_date).toLocaleDateString()})` : '';
                    const stockText = ` - Stock: ${batch.qty_available}`;
                    option.textContent = `${batch.batch_name}${expiryText}${stockText}`;
                    
                    batchSelect.appendChild(option);
                });
                
                // Auto-select first batch (FIFO)
                if (data.batches.length > 0) {
                    const firstBatch = data.batches[0];
                    batchSelect.value = firstBatch.id;
                    
                    // Update info displays
                    const expiry = firstBatch.expiry_date ? new Date(firstBatch.expiry_date).toLocaleDateString() : 'No expiry';
                    const daysToExpiry = firstBatch.days_to_expiry;
                    const expiryClass = daysToExpiry <= 30 ? 'batch-warning' : 'batch-success';
                    
                    batchInfo.innerHTML = `
                        <strong>Auto-selected (FIFO):</strong> ${firstBatch.batch_name}<br>
                        <span class="${expiryClass}">Expiry: ${expiry}</span>
                    `;
                    
                    availableStock.innerHTML = `Available: ${firstBatch.qty_available}`;
                    unitPrice.value = firstBatch.selling_price || firstBatch.unit_cost || 0;
                }
                
                batchSelect.disabled = false;
            } else {
                batchSelect.innerHTML = '<option value="">No batches with stock</option>';
                batchSelect.disabled = true;
                batchInfo.innerHTML = '<span class="batch-warning">No stock available for this product</span>';
                availableStock.innerHTML = '';
                unitPrice.value = '';
            }
        })
        .catch(error => {
            console.error('Error loading batches:', error);
            batchSelect.innerHTML = '<option value="">Error loading batches</option>';
            batchSelect.disabled = true;
        });
}

// Validate stock availability
function validateStock(quantityInput) {
    const productRow = quantityInput.closest('.product-row');
    const batchSelect = productRow.querySelector('.batch-select');
    const selectedOption = batchSelect.options[batchSelect.selectedIndex];
    const availableStock = productRow.querySelector('.available-stock');
    
    if (selectedOption && selectedOption.dataset.stock) {
        const available = parseFloat(selectedOption.dataset.stock);
        const requested = parseFloat(quantityInput.value) || 0;
        
        if (requested > available) {
            quantityInput.style.borderColor = '#dc3545';
            availableStock.innerHTML = `<span class="batch-warning">Available: ${available} (Insufficient stock!)</span>`;
            quantityInput.setCustomValidity('Insufficient stock');
        } else {
            quantityInput.style.borderColor = '#28a745';
            availableStock.innerHTML = `<span class="batch-success">Available: ${available}</span>`;
            quantityInput.setCustomValidity('');
        }
    }
}

// Load customer packages
document.getElementById('client_id').addEventListener('change', function() {
    const clientId = this.value;
    const packagesDiv = document.getElementById('customerPackages');
    
    if (!clientId) {
        packagesDiv.innerHTML = '<small>Select a customer to view their active packages</small>';
        return;
    }
    
    fetch(`/integrated-billing/customer-packages/${clientId}`)
        .then(response => response.json())
        .then(data => {
            if (data.packages && data.packages.length > 0) {
                let html = '<strong>Active Packages:</strong><br>';
                data.packages.forEach(pkg => {
                    html += `<div class="badge badge-success me-1 mb-1">${pkg.package_name}</div>`;
                    pkg.sessions.forEach(session => {
                        if (session.sessions_remaining > 0) {
                            html += `<small class="d-block">${session.service_name}: ${session.sessions_remaining} sessions left</small>`;
                        }
                    });
                });
                packagesDiv.innerHTML = html;
            } else {
                packagesDiv.innerHTML = '<small class="text-muted">No active packages</small>';
            }
        })
        .catch(error => {
            packagesDiv.innerHTML = '<small class="text-danger">Error loading packages</small>';
        });
});

// Professional Tax Calculation Functions
function updateTaxCalculations() {
    const servicesSubtotal = calculateServicesSubtotal();
    const inventorySubtotal = calculateInventorySubtotal();
    const grossSubtotal = servicesSubtotal + inventorySubtotal;
    
    // Get discount
    const discountType = document.getElementById('discount_type').value;
    const discountValue = parseFloat(document.getElementById('discount_value').value) || 0;
    let discountAmount = 0;
    
    if (discountType === 'percentage') {
        discountAmount = (grossSubtotal * discountValue) / 100;
    } else {
        discountAmount = discountValue;
    }
    
    const taxableAmount = grossSubtotal - discountAmount;
    
    // Calculate taxes
    const isInterstate = document.getElementById('is_interstate').checked;
    let cgstAmount = 0, sgstAmount = 0, igstAmount = 0;
    
    if (isInterstate) {
        const igstRate = parseFloat(document.getElementById('igst_rate').value) || 0;
        igstAmount = (taxableAmount * igstRate) / 100;
    } else {
        const cgstRate = parseFloat(document.getElementById('cgst_rate').value) || 0;
        const sgstRate = parseFloat(document.getElementById('sgst_rate').value) || 0;
        cgstAmount = (taxableAmount * cgstRate) / 100;
        sgstAmount = (taxableAmount * sgstRate) / 100;
    }
    
    const additionalCharges = parseFloat(document.getElementById('additional_charges').value) || 0;
    const tipsAmount = parseFloat(document.getElementById('tips_amount').value) || 0;
    
    const totalAmount = taxableAmount + cgstAmount + sgstAmount + igstAmount + additionalCharges + tipsAmount;
    
    // Update display
    document.getElementById('display_subtotal').textContent = `₹${grossSubtotal.toFixed(2)}`;
    document.getElementById('display_discount').textContent = `₹${discountAmount.toFixed(2)}`;
    document.getElementById('display_cgst').textContent = `₹${(cgstAmount + igstAmount).toFixed(2)}`;
    document.getElementById('display_sgst').textContent = `₹${sgstAmount.toFixed(2)}`;
    document.getElementById('display_additional').textContent = `₹${(additionalCharges + tipsAmount).toFixed(2)}`;
    document.getElementById('display_total').textContent = `₹${totalAmount.toFixed(2)}`;
}

function calculateServicesSubtotal() {
    let total = 0;
    document.querySelectorAll('.service-row').forEach(row => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const quantityInput = row.querySelector('input[name="service_quantities[]"]');
        
        if (serviceSelect && serviceSelect.value && quantityInput) {
            const price = parseFloat(serviceSelect.options[serviceSelect.selectedIndex].dataset.price) || 0;
            const quantity = parseFloat(quantityInput.value) || 0;
            total += price * quantity;
        }
    });
    return total;
}

function calculateInventorySubtotal() {
    let total = 0;
    document.querySelectorAll('.product-row').forEach(row => {
        const quantityInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.unit-price');
        
        if (quantityInput && priceInput && quantityInput.value && priceInput.value) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            total += quantity * price;
        }
    });
    return total;
}

function toggleTaxType() {
    const isInterstate = document.getElementById('is_interstate').checked;
    const cgstInput = document.getElementById('cgst_rate');
    const sgstInput = document.getElementById('sgst_rate');
    const igstInput = document.getElementById('igst_rate');
    
    if (isInterstate) {
        cgstInput.value = 0;
        sgstInput.value = 0;
        cgstInput.disabled = true;
        sgstInput.disabled = true;
        igstInput.disabled = false;
        if (igstInput.value === '0') igstInput.value = '18';
    } else {
        igstInput.value = 0;
        igstInput.disabled = true;
        cgstInput.disabled = false;
        sgstInput.disabled = false;
        if (cgstInput.value === '0') cgstInput.value = '9';
        if (sgstInput.value === '0') sgstInput.value = '9';
    }
    
    updateTaxCalculations();
}

// Payment Method Management
function addPaymentMethod() {
    const container = document.getElementById('paymentMethodsContainer');
    const methodCount = container.children.length;
    
    const methodRow = document.createElement('div');
    methodRow.className = 'row mb-2 payment-method-row';
    methodRow.innerHTML = `
        <div class="col-md-4">
            <select class="form-select" name="split_payment_methods[]" required>
                <option value="">Select Method</option>
                <option value="cash">Cash</option>
                <option value="card">Card</option>
                <option value="upi">UPI</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="cheque">Cheque</option>
            </select>
        </div>
        <div class="col-md-4">
            <input type="number" class="form-control" name="split_payment_amounts[]" placeholder="Amount" step="0.01" min="0" required>
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" name="split_payment_refs[]" placeholder="Reference/Transaction ID">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger btn-sm" onclick="removePaymentMethod(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(methodRow);
}

function removePaymentMethod(button) {
    button.closest('.payment-method-row').remove();
}

// Invoice Actions
function previewInvoice() {
    // Generate preview modal with current form data
    const modal = new bootstrap.Modal(document.getElementById('resultModal'));
    const title = document.getElementById('resultModalTitle');
    const body = document.getElementById('resultModalBody');
    
    title.textContent = 'Invoice Preview';
    title.className = 'text-info';
    
    const customer = document.getElementById('client_id');
    const customerName = customer.options[customer.selectedIndex].text;
    
    const servicesSubtotal = calculateServicesSubtotal();
    const inventorySubtotal = calculateInventorySubtotal();
    const grossSubtotal = servicesSubtotal + inventorySubtotal;
    
    body.innerHTML = `
        <div class="invoice-preview">
            <h5>Customer: ${customerName}</h5>
            <hr>
            <div class="row">
                <div class="col-6"><strong>Services Subtotal:</strong></div>
                <div class="col-6 text-end">₹${servicesSubtotal.toFixed(2)}</div>
            </div>
            <div class="row">
                <div class="col-6"><strong>Inventory Subtotal:</strong></div>
                <div class="col-6 text-end">₹${inventorySubtotal.toFixed(2)}</div>
            </div>
            <div class="row">
                <div class="col-6"><strong>Gross Subtotal:</strong></div>
                <div class="col-6 text-end">₹${grossSubtotal.toFixed(2)}</div>
            </div>
            <hr>
            <div class="text-center">
                <p class="text-muted">This is a preview. Click "Generate Professional Invoice" to create the actual invoice.</p>
            </div>
        </div>
    `;
    
    modal.show();
}

function saveAsDraft() {
    // Save current form as draft
    const formData = new FormData(document.getElementById('billingForm'));
    formData.append('save_as_draft', 'true');
    
    fetch('/integrated-billing/save-draft', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Draft saved successfully!');
        } else {
            alert('Error saving draft: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving draft.');
    });
}

function sendQuotation() {
    // Convert current form to quotation
    alert('Quotation feature coming soon!');
}

function clearForm() {
    if (confirm('Are you sure you want to clear the entire form? All entered data will be lost.')) {
        document.getElementById('billingForm').reset();
        updateTaxCalculations();
        
        // Reset all dynamic elements
        const productRows = document.querySelectorAll('.product-row');
        productRows.forEach((row, index) => {
            if (index > 0) {
                row.remove();
            }
        });
        
        document.getElementById('customerPackages').innerHTML = '<small>Select a customer to view their active packages</small>';
    }
}

// Payment Method Change Handler
document.getElementById('payment_method').addEventListener('change', function() {
    const multiPaymentSection = document.getElementById('multiPaymentSection');
    if (this.value === 'mixed') {
        multiPaymentSection.style.display = 'block';
        addPaymentMethod(); // Add first payment method row
    } else {
        multiPaymentSection.style.display = 'none';
        document.getElementById('paymentMethodsContainer').innerHTML = '';
    }
});

// Auto-update calculations when any input changes
document.addEventListener('input', function(e) {
    if (e.target.matches('input[name="service_quantities[]"], .quantity-input, .unit-price, #discount_value, #additional_charges, #tips_amount')) {
        updateTaxCalculations();
    }
});

document.addEventListener('change', function(e) {
    if (e.target.matches('select[name="service_ids[]"], #discount_type, #cgst_rate, #sgst_rate, #igst_rate')) {
        updateTaxCalculations();
    }
});

// Enhanced form submission with professional features
document.getElementById('billingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate all stock quantities before submission
    const quantityInputs = document.querySelectorAll('.quantity-input');
    let hasStockErrors = false;
    
    quantityInputs.forEach(input => {
        validateStock(input);
        if (!input.checkValidity()) {
            hasStockErrors = true;
        }
    });
    
    if (hasStockErrors) {
        alert('Please check stock availability for all products before submitting.');
        return;
    }
    
    const formData = new FormData(this);
    
    // Add tax calculation data
    formData.append('cgst_amount', (parseFloat(document.getElementById('display_cgst').textContent.replace('₹', '')) || 0));
    formData.append('sgst_amount', (parseFloat(document.getElementById('display_sgst').textContent.replace('₹', '')) || 0));
    formData.append('total_tax_amount', (parseFloat(document.getElementById('display_cgst').textContent.replace('₹', '')) + parseFloat(document.getElementById('display_sgst').textContent.replace('₹', '')) || 0));
    
    fetch('/integrated-billing/create-professional', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        const title = document.getElementById('resultModalTitle');
        const body = document.getElementById('resultModalBody');
        const viewBtn = document.getElementById('viewInvoiceBtn');
        
        if (data.success) {
            title.textContent = 'Professional Invoice Created Successfully!';
            title.className = 'text-success';
            
            let message = `<div class="text-success">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <h4>${data.message}</h4>
                <div class="row mt-3">
                    <div class="col-6"><strong>Invoice Number:</strong></div>
                    <div class="col-6">${data.invoice_number}</div>
                </div>
                <div class="row">
                    <div class="col-6"><strong>Total Amount:</strong></div>
                    <div class="col-6">₹${data.total_amount.toLocaleString()}</div>
                </div>
                <div class="row">
                    <div class="col-6"><strong>CGST:</strong></div>
                    <div class="col-6">₹${data.cgst_amount.toLocaleString()}</div>
                </div>
                <div class="row">
                    <div class="col-6"><strong>SGST:</strong></div>
                    <div class="col-6">₹${data.sgst_amount.toLocaleString()}</div>
                </div>
            `;
            
            if (data.deductions_applied > 0) {
                message += `<div class="row text-success">
                    <div class="col-6"><strong>Package Deductions:</strong></div>
                    <div class="col-6">₹${data.deductions_applied.toLocaleString()}</div>
                </div>`;
            }
            
            if (data.stock_reduced) {
                message += `<div class="row text-info">
                    <div class="col-12"><small><strong>Stock Reduced:</strong> ${data.stock_reduced} items from batches</small></div>
                </div>`;
            }
            
            message += '</div>';
            body.innerHTML = message;
            
            viewBtn.style.display = 'block';
            viewBtn.href = `/integrated-billing/invoice/${data.invoice_id}`;
            
            // Reset form
            clearForm();
            
        } else {
            title.textContent = 'Error Creating Professional Invoice';
            title.className = 'text-danger';
            body.innerHTML = `<div class="text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <p>${data.message}</p>
            </div>`;
            viewBtn.style.display = 'none';
        }
        
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the professional invoice.');
    });
});

// Initialize tax calculations on page load
document.addEventListener('DOMContentLoaded', function() {
    updateTaxCalculations();
});
</script>
{% endblock %}
