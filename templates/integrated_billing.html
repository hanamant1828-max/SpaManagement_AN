{% extends "base.html" %}

{% block title %}Professional Billing & Invoice Management{% endblock %}

{% block extra_head %}
<style>
/* Enhanced Modern Billing Page Styles */
:root {
    --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --gradient-info: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --gradient-warning: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.16);
    --border-radius: 16px;
}

/* Page Header Enhancements */
.page-header {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    border-radius: var(--border-radius);
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: var(--shadow-sm);
}

.page-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 8px;
}

.page-header p {
    font-size: 1rem;
    color: #718096;
    margin-bottom: 0;
}

/* Enhanced Stats Cards */
.stats-card {
    border-radius: var(--border-radius) !important;
    border: none !important;
    box-shadow: var(--shadow-md) !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    position: relative;
}

.stats-card:hover {
    transform: translateY(-8px);
    box-shadow: var(--shadow-lg) !important;
}

.stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: rgba(255, 255, 255, 0.4);
}

.gradient-card-success {
    background: var(--gradient-success);
    color: white !important;
}

.gradient-card-info {
    background: var(--gradient-info);
    color: white !important;
}

.gradient-card-warning {
    background: var(--gradient-warning);
    color: white !important;
}

.stats-card .card-body {
    padding: 32px 24px;
}

.stats-card .icon-wrapper {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.stats-card:hover .icon-wrapper {
    transform: scale(1.1) rotate(5deg);
}

.stats-card h6 {
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-size: 0.75rem;
    opacity: 0.95;
}

.stats-card h3 {
    font-size: 2.25rem;
    font-weight: 800;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Main Card Enhancements */
.main-billing-card {
    border-radius: var(--border-radius);
    border: none;
    box-shadow: var(--shadow-md);
    overflow: hidden;
}

.main-billing-card .card-header {
    background: var(--gradient-primary);
    border-radius: var(--border-radius) var(--border-radius) 0 0;
    padding: 24px 32px;
    border: none;
}

.main-billing-card .card-header h5 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
}

.main-billing-card .card-body {
    padding: 32px;
    background: #fafbfc;
}

/* Enhanced Form Sections */
.form-section {
    background: white;
    border-radius: 12px;
    padding: 28px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    border: 1px solid #e2e8f0;
    transition: all 0.3s ease;
}

.form-section:hover {
    box-shadow: var(--shadow-sm);
    border-color: #667eea;
}

.section-header {
    border-bottom: 3px solid #667eea;
    padding-bottom: 12px;
    margin-bottom: 24px;
    font-size: 1.125rem;
    font-weight: 700;
    color: #2d3748;
}

.section-header i {
    font-size: 1.25rem;
}

/* Enhanced Form Controls */
.form-label {
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 8px;
    font-size: 0.875rem;
}

.form-select,
.form-control {
    border-radius: 10px;
    border: 2px solid #e2e8f0;
    padding: 12px 16px;
    font-size: 0.9375rem;
    transition: all 0.3s ease;
    background-color: white;
}

.form-select:focus,
.form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
}

.form-select-lg {
    padding: 14px 18px;
    font-size: 1rem;
}

/* Enhanced Buttons */
.btn {
    border-radius: 10px;
    padding: 10px 20px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
}

.btn-primary {
    background: var(--gradient-primary);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
}

.btn-success {
    background: var(--gradient-success);
    box-shadow: 0 4px 12px rgba(17, 153, 142, 0.4);
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(17, 153, 142, 0.5);
}

.btn-outline-primary {
    border: 2px solid #667eea;
    color: #667eea;
    background: transparent;
}

.btn-outline-primary:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
}

.btn-outline-info {
    border: 2px solid #4facfe;
    color: #4facfe;
    background: transparent;
}

.btn-outline-info:hover {
    background: #4facfe;
    color: white;
    transform: translateY(-2px);
}

.btn-sm {
    padding: 6px 14px;
    font-size: 0.875rem;
}

/* Enhanced Badges */
.badge {
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
}

.badge.bg-light {
    background: rgba(255, 255, 255, 0.3) !important;
    color: white !important;
    backdrop-filter: blur(10px);
}

.badge.bg-success {
    background: var(--gradient-success) !important;
}

.badge.bg-primary {
    background: var(--gradient-primary) !important;
}

.badge.bg-info {
    background: var(--gradient-info) !important;
}

/* Enhanced Alert Boxes */
.alert {
    border-radius: 12px;
    border: none;
    padding: 16px 20px;
    box-shadow: var(--shadow-sm);
}

.alert-info {
    background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
    color: #075985;
}

.alert-success {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.alert-warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
}

.alert i {
    font-size: 1.1rem;
}

/* Customer Packages Display */
#customerPackages {
    border-radius: 12px;
    padding: 16px;
    min-height: 60px;
    display: flex;
    align-items: center;
}

/* Customer Bookings Card */
.customer-bookings-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    border: none;
    overflow: hidden;
    margin-bottom: 24px;
}

.customer-bookings-card .card-header {
    background: var(--gradient-info);
    color: white;
    padding: 20px 24px;
    border: none;
}

.customer-bookings-card .card-body {
    padding: 24px;
}

/* Enhanced Table */
.table {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}

.table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.table thead th {
    border: none;
    padding: 16px;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 1px;
}

.table tbody tr {
    transition: all 0.2s ease;
}

.table tbody tr:hover {
    background: #f7fafc;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.table tbody td {
    padding: 16px;
    vertical-align: middle;
    border-color: #e2e8f0;
}

.table-success thead {
    background: var(--gradient-success) !important;
}

/* Service and Product Rows */
.service-row,
.product-row {
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.3s ease;
}

.service-row:hover,
.product-row:hover {
    border-color: #667eea;
    box-shadow: var(--shadow-sm);
    transform: translateX(4px);
}

/* Package Benefit Display */
.package-benefit-display {
    margin-top: 12px;
    padding: 12px 16px;
    border-radius: 10px;
    border-left: 4px solid;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Batch Info */
.batch-info {
    font-size: 0.8125rem;
    color: #718096;
    margin-top: 8px;
    padding: 8px 12px;
    background: #f7fafc;
    border-radius: 8px;
    border-left: 3px solid #4facfe;
}

.batch-warning {
    color: #dc2626;
    font-weight: 600;
}

.batch-success {
    color: #059669;
    font-weight: 600;
}

/* Item Rows */
.item-row {
    border-left: 4px solid transparent;
    padding: 16px;
    margin-bottom: 12px;
    border-radius: 10px;
    background: white;
    transition: all 0.3s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.item-row:hover {
    box-shadow: var(--shadow-sm);
    transform: translateX(4px);
}

.item-row.package-item {
    border-left-color: #059669;
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
}

.item-row.extra-item {
    border-left-color: #dc2626;
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.05) 0%, rgba(220, 38, 38, 0.02) 100%);
}

.package-deduction {
    color: #059669;
    font-weight: 700;
}

.extra-charge {
    color: #dc2626;
    font-weight: 700;
}

/* Calculation Preview */
.calculation-preview {
    background: var(--gradient-primary);
    color: white;
    border-radius: var(--border-radius);
    padding: 28px;
    box-shadow: var(--shadow-lg);
    position: sticky;
    top: 20px;
}

.calculation-preview .amount {
    font-size: 2.5rem;
    font-weight: 800;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* Responsive Improvements */
@media (max-width: 768px) {
    .page-header {
        padding: 20px;
    }
    
    .stats-card h3 {
        font-size: 1.75rem;
    }
    
    .form-section {
        padding: 20px;
    }
    
    .main-billing-card .card-body {
        padding: 20px;
    }
}

/* Loading Animation */
@keyframes spin {
    to { transform: rotate(360deg); }
}

.fa-spinner {
    animation: spin 1s linear infinite;
}

/* Smooth Transitions */
* {
    transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Compact Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">
            <i class="fas fa-cash-register me-2 text-primary"></i>Create Invoice
        </h3>
        <div class="d-flex gap-2 align-items-center">
            <small class="text-muted">Quick Billing</small>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleBillSummary()">
                <i class="fas fa-calculator me-1"></i>Bill Summary
            </button>
        </div>
    </div>

    <div class="row">
        <!-- New Invoice Creation - Full Width -->
        <div class="col-12 mb-4" id="billingFormContainer">
            <div class="card main-billing-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5>
                            <i class="fas fa-file-invoice-dollar me-2"></i>Create Professional Invoice
                        </h5>
                        <div class="d-flex gap-2">
                            <span class="badge bg-light">Services</span>
                            <span class="badge bg-light">Packages</span>
                            <span class="badge bg-light">Inventory</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form id="billingForm">
                        <!-- Customer Selection Section -->
                        <div class="form-section">
                            <h6 class="section-header">
                                <i class="fas fa-user-circle me-2"></i>Customer Information
                            </h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="client_id" class="form-label">
                                        <i class="fas fa-user me-1"></i>Select Customer <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select form-select-lg" id="client_id" name="client_id" required>
                                        <option value="">Choose a customer...</option>
                                        {% for customer in customers %}
                                        <option value="{{ customer.id }}" {{ 'selected' if selected_customer and customer.id == selected_customer.id else '' }}>
                                            {{ customer.full_name }} - {{ customer.phone }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-gift me-1"></i>Active Packages
                                    </label>
                                    <div id="customerPackages" class="alert alert-info mb-0">
                                        <small><i class="fas fa-info-circle me-1"></i>Select a customer to view their active packages</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Services History Section -->
                        {% if selected_customer %}
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card customer-bookings-card">
                                    <div class="card-header">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                            <h6 class="mb-0">
                                                <i class="fas fa-user me-2"></i>{{ selected_customer.full_name }}'s Current Bookings
                                            </h6>
                                            <span class="badge bg-light">{{ customer_appointments|length }} Ready to Bill</span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        {% if customer_services %}
                                        <div class="alert alert-success">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <strong>{{ customer_services|length }} Different Services Found</strong> - Ready to add to bill
                                        </div>
                                        <h6 class="text-primary mb-3 fw-bold">Available Services for Billing:</h6>
                                        <div class="row">
                                            {% for service in customer_services %}
                                            <div class="col-md-4 mb-2">
                                                <div class="d-flex align-items-center p-2 bg-light rounded">
                                                    <i class="fas fa-spa text-success me-2"></i>
                                                    <span class="fw-bold">{{ service.name }}</span>
                                                    <span class="text-muted ms-2">₹{{ "{:,.2f}".format(service.price) }}</span>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}

                                        {% if customer_appointments and customer_appointments|length > 0 %}
                                        <hr class="my-4">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="text-success mb-0 fw-bold">
                                                <i class="fas fa-clock me-1"></i>All Confirmed Bookings Ready for Billing
                                            </h6>
                                            <div class="badge bg-success fs-6">{{ customer_appointments|length }} Bookings Found</div>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            These are all the confirmed/scheduled appointments for <strong>{{ selected_customer.full_name }}</strong> that can be billed.
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead class="table-success">
                                                    <tr>
                                                        <th>Date & Time</th>
                                                        <th>Service</th>
                                                        <th>Staff</th>
                                                        <th>Status</th>
                                                        <th>Amount</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for appointment in customer_appointments %}
                                                    <tr>
                                                        <td>
                                                            <strong>
                                                                {% if appointment.appointment_date.strftime is defined %}
                                                                    {{ appointment.appointment_date.strftime('%d %b %Y') }}
                                                                {% else %}
                                                                    {{ appointment.appointment_date }}
                                                                {% endif %}
                                                            </strong><br>
                                                            <small class="text-muted">
                                                                {% if appointment.start_time and appointment.start_time.strftime is defined %}
                                                                    {{ appointment.start_time.strftime('%I:%M %p') }}
                                                                {% else %}
                                                                    {{ appointment.start_time if appointment.start_time else 'N/A' }}
                                                                {% endif %}
                                                                -
                                                                {% if appointment.end_time and appointment.end_time.strftime is defined %}
                                                                    {{ appointment.end_time.strftime('%I:%M %p') }}
                                                                {% else %}
                                                                    {{ appointment.end_time if appointment.end_time else 'N/A' }}
                                                                {% endif %}
                                                            </small>
                                                        </td>
                                                        <td>
                                                            <strong>{{ appointment.service_name if appointment.service_name else 'N/A' }}</strong><br>
                                                            <small class="text-muted">{{ appointment.service_duration if appointment.service_duration else '0' }} mins</small>
                                                        </td>
                                                        <td>{{ appointment.staff_name if appointment.staff_name else 'N/A' }}</td>
                                                        <td>
                                                            <span class="badge badge-warning">
                                                                {{ appointment.status.title() }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <strong class="text-success">₹{{ "{:,.2f}".format(appointment.service_price) if appointment.service_price else '0.00' }}</strong>
                                                        </td>
                                                        <td>
                                                            <button type="button"
                                                                    class="btn btn-primary btn-sm"
                                                                    onclick="addUnakiAppointmentToBill({{ appointment.id }}, '{{ appointment.service_name }}', {{ appointment.service_price }}, '{{ appointment.staff_name }}')">
                                                                <i class="fas fa-plus me-1"></i>Add to Bill
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>No ready-to-bill bookings found.</strong> This customer has no scheduled or confirmed appointments ready for billing.
                                        </div>
                                        {% endif %}

                                        <div class="mt-3 d-flex gap-2 flex-wrap">
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="autoFillCurrentServices()">
                                                <i class="fas fa-bolt me-1"></i>Auto-Fill ALL Bookings to Bill
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="viewFullCustomerHistory()">
                                                <i class="fas fa-history me-1"></i>View Full Customer History
                                            </button>
                                        </div>
                                        <small class="text-muted d-block mt-2">
                                            <i class="fas fa-lightbulb me-1"></i>
                                            Auto-Fill will add all {{ customer_appointments|length }} confirmed bookings to your billing form instantly
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Services Section -->
                        <div class="form-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="section-header mb-0">
                                    <i class="fas fa-spa me-2"></i>Services
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-sync-alt me-1"></i>Package benefits auto-applied
                                </small>
                            </div>
                            <div id="servicesContainer">
                                <div class="service-row">
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label">Service</label>
                                            <select class="form-select" name="service_ids[]" onchange="handleServiceSelection(this)">
                                                <option value="">Select Service</option>
                                                {% for service in services %}
                                                <option value="{{ service.id }}" data-price="{{ service.price|float }}">
                                                    {{ service.name }} - ₹{{ "{:,.2f}".format(service.price) }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label">Staff Member <span class="text-danger">*</span></label>
                                            <select class="form-select" name="staff_ids[]" required>
                                                <option value="">Select Staff</option>
                                                {% for staff_member in staff_members %}
                                                <option value="{{ staff_member.id }}">
                                                    {{ staff_member.full_name }} - {{ staff_member.designation or staff_member.role }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-2 mb-2">
                                            <label class="form-label">Quantity</label>
                                            <input type="number" class="form-control" name="service_quantities[]" placeholder="Qty" min="1" value="1" step="0.5">
                                        </div>
                                        <div class="col-md-2 mb-2">
                                            <label class="form-label">Appointment ID</label>
                                            <input type="number" class="form-control" name="appointment_ids[]" placeholder="Optional">
                                        </div>
                                        <div class="col-md-1 mb-2">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-success btn-sm w-100" onclick="addServiceRow()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Products & Inventory Section (Batch-wise) -->
                        <div class="form-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="section-header mb-0">
                                    <i class="fas fa-box-open me-2"></i>Products & Inventory
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-sync-alt me-1"></i>FIFO auto-deduction from batches
                                </small>
                            </div>
                            <div id="productsContainer">
                                <div class="product-row">
                                    <div class="row">
                                        <div class="col-md-4 mb-2">
                                            <label class="form-label">Product</label>
                                            <select class="form-select product-select" name="product_ids[]" onchange="loadBatchesForProduct(this)">
                                                <option value="">Select Product</option>
                                                {% for product in inventory_items %}
                                                <option value="{{ product.id }}" data-name="{{ product.name }}">{{ product.name }} (Total Stock: {{ product.total_stock }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3 mb-2">
                                            <label class="form-label">Batch (Auto-selected FIFO)</label>
                                            <select class="form-select batch-select" name="batch_ids[]" disabled>
                                                <option value="">Select Product First</option>
                                            </select>
                                            <div class="batch-info"></div>
                                        </div>
                                        <div class="col-md-2 mb-2">
                                            <label class="form-label">Quantity</label>
                                            <input type="number" class="form-control" name="product_quantities[]" placeholder="Qty" min="0.01" value="1" step="0.01" oninput="validateInventoryQuantity(this); updateTaxCalculations();">
                                        </div>
                                        <div class="col-md-2 mb-2">
                                            <label class="form-label">Unit Price</label>
                                            <input type="number" class="form-control" name="product_prices[]" placeholder="₹0.00" min="0" step="0.01" oninput="updateTaxCalculations()">
                                        </div>
                                        <div class="col-md-1 mb-2">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-success btn-sm w-100" onclick="addProductRow()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment & Tax Section -->
                        <div class="form-section">
                            <h6 class="section-header">
                                <i class="fas fa-calculator me-2"></i>Payment & Tax Details
                            </h6>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Payment Method <span class="text-danger">*</span></label>
                                    <select class="form-select" name="payment_method" required>
                                        <option value="">Select Payment Method</option>
                                        <option value="cash">Cash</option>
                                        <option value="card">Card</option>
                                        <option value="upi">UPI</option>
                                        <option value="bank_transfer">Bank Transfer</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Payment Status <span class="text-danger">*</span></label>
                                    <select class="form-select" name="payment_status" required>
                                        <option value="paid">Paid</option>
                                        <option value="partial">Partially Paid</option>
                                        <option value="pending">Pending</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Discount (%)</label>
                                    <input type="number" class="form-control" name="discount_percentage" placeholder="0" min="0" max="100" step="0.01" oninput="updateTaxCalculations()">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">
                                        <input type="checkbox" id="gstEnabled" name="gst_enabled" onchange="updateTaxCalculations()" class="form-check-input me-2">
                                        Enable GST
                                    </label>
                                    <input type="number" class="form-control" name="gst_percentage" id="gstPercentage" placeholder="GST %" min="0" max="100" step="0.01" oninput="updateTaxCalculations()" disabled>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Notes (Optional)</label>
                                    <textarea class="form-control" name="notes" rows="2" placeholder="Add any notes here..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button with Total Display -->
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                            <div>
                                <h4 class="mb-0">
                                    <span class="text-muted">Total Amount:</span>
                                    <span class="text-primary fw-bold">₹<span id="grandTotal">0.00</span></span>
                                </h4>
                                <small class="text-muted">
                                    <span id="serviceCount">0</span> Services, 
                                    <span id="productCount">0</span> Products
                                </small>
                            </div>
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-check-circle me-2"></i>Generate Invoice (₹<span id="grandTotalBtn">0.00</span>)
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Bill Summary Panel -->
<div id="billSummaryPanel" class="bill-summary-panel" style="display: none;">
    <div class="calculation-preview" style="height: auto; max-height: 90vh; overflow-y: auto;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0 fw-bold">
                <i class="fas fa-receipt me-2"></i>Bill Summary
            </h5>
            <button type="button" class="btn btn-sm btn-light" onclick="toggleBillSummary()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="mb-3 pb-3 border-bottom border-white border-opacity-25">
            <div class="d-flex justify-content-between mb-2">
                <span>Services Subtotal:</span>
                <span class="fw-bold">₹<span id="servicesSubtotalPanel">0.00</span></span>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span>Products Subtotal:</span>
                <span class="fw-bold">₹<span id="productsSubtotalPanel">0.00</span></span>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span>Package Deductions:</span>
                <span class="fw-bold text-success">-₹<span id="packageDeductionsPanel">0.00</span></span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Discount:</span>
                <span class="fw-bold text-warning">-₹<span id="discountAmountPanel">0.00</span></span>
            </div>
        </div>

        <div class="mb-3 pb-3 border-bottom border-white border-opacity-25">
            <div class="d-flex justify-content-between mb-2">
                <span>Subtotal After Deductions:</span>
                <span class="fw-bold">₹<span id="subtotalAfterDeductionsPanel">0.00</span></span>
            </div>
            <div class="d-flex justify-content-between">
                <span>GST (<span id="gstRateDisplayPanel">0</span>%):</span>
                <span class="fw-bold">₹<span id="gstAmountPanel">0.00</span></span>
            </div>
        </div>

        <div class="text-center py-3">
            <h6 class="text-uppercase mb-2" style="opacity: 0.9; letter-spacing: 2px;">Total Amount</h6>
            <div class="amount">₹<span id="grandTotalPanel">0.00</span></div>
        </div>

        <div class="alert alert-light">
            <small class="d-block mb-1"><i class="fas fa-info-circle me-1"></i><strong>Items Added:</strong></small>
            <small class="d-block">Services: <span id="serviceCountPanel" class="fw-bold">0</span></small>
            <small class="d-block">Products: <span id="productCountPanel" class="fw-bold">0</span></small>
        </div>
    </div>
</div>

<style>
.bill-summary-panel {
    position: fixed;
    top: 70px;
    right: 20px;
    width: 350px;
    z-index: 1050;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@media (max-width: 768px) {
    .bill-summary-panel {
        width: calc(100% - 40px);
        right: 20px;
        left: 20px;
    }
}
</style>

<!-- Keep all the existing JavaScript from the original template -->
<script>
function toggleBillSummary() {
    const panel = document.getElementById('billSummaryPanel');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
    } else {
        panel.style.display = 'none';
    }
}

// All the existing JavaScript code remains exactly the same
// (Copying the complete JavaScript section from the original file)

let customerPackageData = null;
let lastLoadedCustomerId = null;
let availableBatches = [];
let globalStaffMembers = [];
window.customerAppointments = {{ customer_appointments|tojson if customer_appointments else '[]' }};

document.addEventListener('DOMContentLoaded', function() {
    console.log('Integrated Billing page loaded');
    
    globalStaffMembers = [
        {% for staff in staff_members %}
        {
            id: {{ staff.id }},
            name: '{{ staff.full_name }}',
            designation: '{{ staff.designation or staff.role }}'
        }{{ ',' if not loop.last else '' }}
        {% endfor %}
    ];
    
    loadAvailableBatches();
    
    const clientSelect = document.getElementById('client_id');
    if (clientSelect) {
        clientSelect.addEventListener('change', function() {
            const clientId = this.value;
            if (clientId) {
                loadCustomerPackages(clientId);
                loadCustomerAppointments(clientId);
            } else {
                const packagesDiv = document.getElementById('customerPackages');
                if (packagesDiv) {
                    packagesDiv.innerHTML = '<small class="text-muted">Select a customer to view their active packages</small>';
                }
                customerPackageData = null;
                lastLoadedCustomerId = null;
            }
        });
    }
    
    const gstCheckbox = document.getElementById('gstEnabled');
    const gstInput = document.getElementById('gstPercentage');
    if (gstCheckbox && gstInput) {
        gstCheckbox.addEventListener('change', function() {
            gstInput.disabled = !this.checked;
            if (!this.checked) {
                gstInput.value = '';
            } else {
                gstInput.value = '18';
            }
        });
    }
    
    const billingForm = document.getElementById('billingForm');
    if (billingForm) {
        billingForm.addEventListener('submit', handleBillingFormSubmit);
    }
    
    {% if selected_customer %}
    loadCustomerPackages({{ selected_customer.id }});
    loadCustomerAppointments({{ selected_customer.id }});
    {% endif %}
});

function addServiceRow() {
    const container = document.getElementById('servicesContainer');
    if (!container || container.children.length === 0) {
        console.error('Services container not found or empty');
        return;
    }
    
    const newRow = container.children[0].cloneNode(true);
    
    newRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
    });
    
    const benefitDisplay = newRow.querySelector('.package-benefit-display');
    if (benefitDisplay) {
        benefitDisplay.remove();
    }
    
    const button = newRow.querySelector('button');
    if (button) {
        button.className = 'btn btn-danger btn-sm w-100';
        button.innerHTML = '<i class="fas fa-minus"></i>';
        button.onclick = function() { 
            this.closest('.service-row').remove(); 
            updateTaxCalculations();
        };
    }
    
    container.appendChild(newRow);
}

function handleServiceSelection(selectElement) {
    updateTaxCalculations();
}

function addUnakiAppointmentToBill(appointmentId, serviceName, servicePrice, staffName) {
    console.log(`Adding appointment ${appointmentId} to bill`);
    
    const container = document.getElementById('servicesContainer');
    if (!container) {
        console.error('Services container not found');
        return;
    }
    
    const firstRow = container.children[0];
    const serviceSelect = firstRow.querySelector('select[name="service_ids[]"]');
    const staffSelect = firstRow.querySelector('select[name="staff_ids[]"]');
    const qtyInput = firstRow.querySelector('input[name="service_quantities[]"]');
    const appointmentInput = firstRow.querySelector('input[name="appointment_ids[]"]');
    
    const isFirstRowEmpty = !serviceSelect.value && !qtyInput.value;
    
    if (isFirstRowEmpty) {
        const serviceOption = Array.from(serviceSelect.options).find(opt => 
            opt.text.toLowerCase().includes(serviceName.toLowerCase())
        );
        
        if (serviceOption) {
            serviceSelect.value = serviceOption.value;
            handleServiceSelection(serviceSelect);
        }
        
        if (staffName && staffSelect) {
            const staffOption = Array.from(staffSelect.options).find(opt => 
                opt.text.toLowerCase().includes(staffName.toLowerCase())
            );
            if (staffOption) {
                staffSelect.value = staffOption.value;
            }
        }
        
        if (qtyInput) qtyInput.value = 1;
        if (appointmentInput) appointmentInput.value = appointmentId;
    } else {
        addServiceRow();
        
        const newRow = container.children[container.children.length - 1];
        const newServiceSelect = newRow.querySelector('select[name="service_ids[]"]');
        const newStaffSelect = newRow.querySelector('select[name="staff_ids[]"]');
        const newQtyInput = newRow.querySelector('input[name="service_quantities[]"]');
        const newAppointmentInput = newRow.querySelector('input[name="appointment_ids[]"]');
        
        const serviceOption = Array.from(newServiceSelect.options).find(opt => 
            opt.text.toLowerCase().includes(serviceName.toLowerCase())
        );
        
        if (serviceOption) {
            newServiceSelect.value = serviceOption.value;
            handleServiceSelection(newServiceSelect);
        }
        
        if (staffName && newStaffSelect) {
            const staffOption = Array.from(newStaffSelect.options).find(opt => 
                opt.text.toLowerCase().includes(staffName.toLowerCase())
            );
            if (staffOption) {
                newStaffSelect.value = staffOption.value;
            }
        }
        
        if (newQtyInput) newQtyInput.value = 1;
        if (newAppointmentInput) newAppointmentInput.value = appointmentId;
    }
    
    updateTaxCalculations();
    showNotification('Service added to bill!', 'success');
}

function loadCustomerAppointments(clientId) {
    if (!clientId) {
        window.customerAppointments = [];
        // Hide the bookings card if no customer selected
        const bookingsCard = document.getElementById('customerBookingsCard');
        if (bookingsCard) {
            bookingsCard.style.display = 'none';
        }
        return;
    }
    
    fetch(`/api/customer/${clientId}/appointments`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.appointments) {
                window.customerAppointments = data.appointments;
                console.log(`Loaded ${data.appointments.length} appointments for customer ${clientId}`);
                
                // Render the appointments in the UI
                renderCustomerAppointments(data.appointments, data.customer);
            } else {
                window.customerAppointments = [];
                console.log('No appointments found or error loading appointments');
                renderCustomerAppointments([], null);
            }
        })
        .catch(error => {
            console.error('Error loading appointments:', error);
            window.customerAppointments = [];
            renderCustomerAppointments([], null);
        });
}

function renderCustomerAppointments(appointments, customer) {
    // Check if bookings card container exists, if not create it
    let bookingsCardContainer = document.getElementById('customerBookingsCardContainer');
    
    if (!bookingsCardContainer) {
        // Create the container after the customer selection section
        const customerSection = document.querySelector('.form-section');
        if (customerSection) {
            bookingsCardContainer = document.createElement('div');
            bookingsCardContainer.id = 'customerBookingsCardContainer';
            bookingsCardContainer.className = 'row mb-4';
            customerSection.after(bookingsCardContainer);
        } else {
            return; // Can't render without a place to put it
        }
    }
    
    if (!appointments || appointments.length === 0) {
        bookingsCardContainer.innerHTML = '';
        return;
    }
    
    const customerName = customer ? customer.name : 'Customer';
    
    // Build the appointments table HTML
    let appointmentsHTML = appointments.map(apt => {
        const appointmentDate = apt.appointment_date || 'N/A';
        const startTime = apt.start_time || 'N/A';
        const endTime = apt.end_time || 'N/A';
        const serviceName = apt.service_name || 'N/A';
        const serviceDuration = apt.service_duration || 0;
        const staffName = apt.staff_name || 'N/A';
        const status = apt.status || 'scheduled';
        const servicePrice = apt.service_price || 0;
        
        return `
            <tr>
                <td>
                    <strong>${appointmentDate}</strong><br>
                    <small class="text-muted">${startTime} - ${endTime}</small>
                </td>
                <td>
                    <strong>${serviceName}</strong><br>
                    <small class="text-muted">${serviceDuration} mins</small>
                </td>
                <td>${staffName}</td>
                <td>
                    <span class="badge badge-warning">
                        ${status.charAt(0).toUpperCase() + status.slice(1)}
                    </span>
                </td>
                <td>
                    <strong class="text-success">₹${parseFloat(servicePrice).toFixed(2)}</strong>
                </td>
                <td>
                    <button type="button"
                            class="btn btn-primary btn-sm"
                            onclick="addUnakiAppointmentToBill(${apt.id}, '${serviceName}', ${servicePrice}, '${staffName}')">
                        <i class="fas fa-plus me-1"></i>Add to Bill
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    // Render the complete card
    bookingsCardContainer.innerHTML = `
        <div class="col-12">
            <div class="card customer-bookings-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h6 class="mb-0">
                            <i class="fas fa-user me-2"></i>${customerName}'s Current Bookings
                        </h6>
                        <span class="badge bg-light">${appointments.length} Ready to Bill</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>${appointments.length} Confirmed Bookings Found</strong> - Ready to add to bill
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-success">
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Service</th>
                                    <th>Staff</th>
                                    <th>Status</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${appointmentsHTML}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3 d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="autoFillCurrentServices()">
                            <i class="fas fa-bolt me-1"></i>Auto-Fill ALL Bookings to Bill
                        </button>
                    </div>
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-lightbulb me-1"></i>
                        Auto-Fill will add all ${appointments.length} confirmed bookings to your billing form instantly
                    </small>
                </div>
            </div>
        </div>
    `;
}

function autoPopulateBillingFromAppointments(appointments) {
    if (!appointments || appointments.length === 0) {
        console.log('No appointments to auto-populate');
        return;
    }
    
    const unpaidAppointments = appointments.filter(apt => 
        (apt.status === 'confirmed' || apt.status === 'scheduled') && 
        apt.payment_status === 'pending'
    );
    
    if (unpaidAppointments.length === 0) {
        console.log('No unpaid confirmed/scheduled appointments found');
        return;
    }
    
    console.log(`Auto-populating ${unpaidAppointments.length} unpaid appointments into billing form`);
    
    const container = document.getElementById('servicesContainer');
    const firstRow = container.children[0];
    container.innerHTML = '';
    container.appendChild(firstRow);
    
    firstRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
    });
    
    unpaidAppointments.forEach((apt, index) => {
        if (index === 0) {
            const serviceSelect = firstRow.querySelector('select[name="service_ids[]"]');
            const staffSelect = firstRow.querySelector('select[name="staff_ids[]"]');
            const qtyInput = firstRow.querySelector('input[name="service_quantities[]"]');
            const appointmentInput = firstRow.querySelector('input[name="appointment_ids[]"]');
            
            if (serviceSelect && apt.service_id) {
                serviceSelect.value = apt.service_id;
                handleServiceSelection(serviceSelect);
            }
            if (staffSelect && apt.staff_id) {
                staffSelect.value = apt.staff_id;
            }
            if (qtyInput) qtyInput.value = 1;
            if (appointmentInput) appointmentInput.value = apt.id;
        } else {
            addServiceRow();
            const rows = container.querySelectorAll('.service-row');
            const newRow = rows[rows.length - 1];
            
            const serviceSelect = newRow.querySelector('select[name="service_ids[]"]');
            const staffSelect = newRow.querySelector('select[name="staff_ids[]"]');
            const qtyInput = newRow.querySelector('input[name="service_quantities[]"]');
            const appointmentInput = newRow.querySelector('input[name="appointment_ids[]"]');
            
            if (serviceSelect && apt.service_id) {
                serviceSelect.value = apt.service_id;
                handleServiceSelection(serviceSelect);
            }
            if (staffSelect && apt.staff_id) {
                staffSelect.value = apt.staff_id;
            }
            if (qtyInput) qtyInput.value = 1;
            if (appointmentInput) appointmentInput.value = apt.id;
        }
    });
    
    updateTaxCalculations();
    
    showNotification(`Auto-added ${unpaidAppointments.length} unpaid services to billing`, 'success');
}

function autoFillCurrentServices() {
    if (!window.customerAppointments || window.customerAppointments.length === 0) {
        showNotification('No appointments found for this customer', 'warning');
        return;
    }
    
    autoPopulateBillingFromAppointments(window.customerAppointments);
}

function viewFullCustomerHistory() {
    {% if selected_customer %}
    window.open('/clients/{{ selected_customer.id }}', '_blank');
    {% endif %}
}

function addProductRow() {
    const container = document.getElementById('productsContainer');
    if (!container || container.children.length === 0) {
        console.error('Products container not found or empty');
        return;
    }
    
    const newRow = container.children[0].cloneNode(true);
    
    newRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
    });
    
    const batchSelect = newRow.querySelector('.batch-select');
    if (batchSelect) {
        batchSelect.innerHTML = '<option value="">Select Product First</option>';
        batchSelect.disabled = true;
    }
    
    const batchInfo = newRow.querySelector('.batch-info');
    if (batchInfo) {
        batchInfo.innerHTML = '';
    }
    
    const button = newRow.querySelector('button');
    if (button) {
        button.className = 'btn btn-danger btn-sm w-100';
        button.innerHTML = '<i class="fas fa-minus"></i>';
        button.onclick = function() { 
            this.closest('.product-row').remove(); 
            updateTaxCalculations();
        };
    }
    
    container.appendChild(newRow);
}

function loadAvailableBatches() {
    fetch('/api/inventory/batches/for-consumption')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches) {
                availableBatches = data.batches;
                console.log('Available batches loaded:', availableBatches.length);
            }
        })
        .catch(error => {
            console.error('Error loading batches:', error);
        });
}

function loadBatchesForProduct(productSelect) {
    const row = productSelect.closest('.row');
    const batchSelect = row.querySelector('.batch-select');
    const batchInfo = row.querySelector('.batch-info');
    const quantityInput = row.querySelector('input[name="product_quantities[]"]');
    const priceInput = row.querySelector('input[name="product_prices[]"]');
    
    const productId = parseInt(productSelect.value);
    
    batchSelect.innerHTML = '<option value="">Loading batches...</option>';
    batchSelect.disabled = true;
    batchInfo.innerHTML = '';
    
    if (!productId) {
        batchSelect.innerHTML = '<option value="">Select Product First</option>';
        return;
    }
    
    const productBatches = availableBatches.filter(batch => {
        return batch.product_id === productId && batch.qty_available > 0;
    });
    
    console.log(`DEBUG: Product ID ${productId} has ${productBatches.length} available batches`);
    
    if (productBatches.length === 0) {
        batchSelect.innerHTML = '<option value="">No stock available</option>';
        batchInfo.innerHTML = '<span class="text-danger">⚠️ No stock available for this product</span>';
        if (quantityInput) quantityInput.value = '0';
        if (priceInput) priceInput.value = '';
        return;
    }
    
    productBatches.sort((a, b) => {
        if (!a.expiry_date && !b.expiry_date) return 0;
        if (!a.expiry_date) return 1;
        if (!b.expiry_date) return -1;
        return new Date(a.expiry_date) - new Date(b.expiry_date);
    });
    
    const firstBatch = productBatches[0];
    batchSelect.innerHTML = `<option value="${firstBatch.id}" selected>${firstBatch.dropdown_display}</option>`;
    
    productBatches.slice(1).forEach(batch => {
        const option = document.createElement('option');
        option.value = batch.id;
        option.textContent = batch.dropdown_display;
        batchSelect.appendChild(option);
    });
    
    batchSelect.disabled = false;
    
    const expiryText = firstBatch.expiry_date ?
        `Expires: ${new Date(firstBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
    batchInfo.innerHTML = `
        <strong>Auto-selected:</strong> ${firstBatch.batch_name}<br>
        <strong>Available:</strong> ${firstBatch.qty_available} ${firstBatch.unit}<br>
        <strong>${expiryText}</strong>
    `;
    
    if (quantityInput) {
        quantityInput.max = firstBatch.qty_available;
        quantityInput.placeholder = `Max: ${firstBatch.qty_available}`;
        quantityInput.value = '1';
        validateInventoryQuantity(quantityInput);
    }
    
    if (priceInput) {
        const sellingPrice = firstBatch.selling_price || firstBatch.unit_price || firstBatch.unit_cost || 0;
        priceInput.value = parseFloat(sellingPrice).toFixed(2);
        updateTaxCalculations();
    }
    
    batchSelect.addEventListener('change', function() {
        const selectedBatch = productBatches.find(b => b.id == this.value);
        if (selectedBatch) {
            const expiryText = selectedBatch.expiry_date ?
                `Expires: ${new Date(selectedBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
            batchInfo.innerHTML = `
                <strong>Selected:</strong> ${selectedBatch.batch_name}<br>
                <strong>Available:</strong> ${selectedBatch.qty_available} ${selectedBatch.unit}<br>
                <strong>${expiryText}</strong>
            `;
            if (quantityInput) {
                quantityInput.max = selectedBatch.qty_available;
                quantityInput.placeholder = `Max: ${selectedBatch.qty_available}`;
                quantityInput.value = '1';
                validateInventoryQuantity(quantityInput);
            }
            if (priceInput) {
                const sellingPrice = selectedBatch.selling_price || selectedBatch.unit_price || selectedBatch.unit_cost || 0;
                priceInput.value = parseFloat(sellingPrice).toFixed(2);
                updateTaxCalculations();
            }
        }
    });
}

function validateInventoryQuantity(quantityInput) {
    const productRow = quantityInput.closest('.product-row');
    const batchSelect = productRow.querySelector('.batch-select');
    const selectedOption = batchSelect.options[batchSelect.selectedIndex];
    const batchInfo = productRow.querySelector('.batch-info');
    
    if (!selectedOption || selectedOption.value === "") {
        if (batchInfo) {
            batchInfo.innerHTML = '<span class="text-muted">Select batch to see stock</span>';
        }
        quantityInput.setCustomValidity('');
        return;
    }
    
    const selectedBatchId = selectedOption.value;
    const selectedBatch = availableBatches.find(b => b.id == selectedBatchId);
    
    if (selectedBatch) {
        const available = parseFloat(selectedBatch.qty_available);
        const requested = parseFloat(quantityInput.value) || 0;
        
        if (requested > available) {
            quantityInput.style.borderColor = '#dc3545';
            if (batchInfo) {
                batchInfo.innerHTML = '<span class="batch-warning">Available: ' + available + ' (Insufficient stock!)</span>';
            }
            quantityInput.setCustomValidity('Insufficient stock');
        } else {
            quantityInput.style.borderColor = '#28a745';
             if (batchInfo) {
                const expiryText = selectedBatch.expiry_date ?
                    `Expires: ${new Date(selectedBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
                batchInfo.innerHTML = `
                    <strong>Selected:</strong> ${selectedBatch.batch_name}<br>
                    <strong>Available:</strong> ${selectedBatch.qty_available} ${selectedBatch.unit}<br>
                    <strong>${expiryText}</strong>
                `;
            }
            quantityInput.setCustomValidity('');
        }
    } else {
        quantityInput.style.borderColor = '';
        if (batchInfo) {
            batchInfo.innerHTML = '';
        }
        quantityInput.setCustomValidity('');
    }
}

function loadCustomerPackages(clientId) {
    const packagesDiv = document.getElementById('customerPackages');
    
    if (!clientId) {
        packagesDiv.innerHTML = '<small>Select a customer to view their active packages</small>';
        customerPackageData = null;
        lastLoadedCustomerId = null;
        updateTaxCalculations();
        return;
    }
    
    if (lastLoadedCustomerId === clientId) {
        console.log('Customer packages already loaded for:', clientId);
        return;
    }
    
    lastLoadedCustomerId = clientId;
    
    packagesDiv.innerHTML = '<small class="text-info"><i class="fas fa-spinner fa-spin"></i> Loading packages...</small>';
    
    fetch(`/integrated-billing/customer-packages/${clientId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Package data received:', data);
            
            if (!data || data.error) {
                packagesDiv.innerHTML = `<small class="text-danger">Error: ${data.error || 'Unknown error'}</small>`;
                customerPackageData = null;
                return;
            }
            
            customerPackageData = data;
            
            if (data.packages && data.packages.length > 0) {
                let html = '<div class="alert alert-success mb-0"><strong>Active Packages:</strong><br>';
                
                data.packages.forEach(pkg => {
                    html += `<div class="badge bg-success me-1 mb-1">${pkg.package_name}</div>`;
                    
                    if (pkg.package_type === 'service_package') {
                        html += `<small class="d-block">${pkg.service_name || 'Any Service'}: ${pkg.sessions_remaining || 0} sessions remaining</small>`;
                    } else if (pkg.package_type === 'prepaid') {
                        html += `<small class="d-block text-info">Prepaid Credit: ₹${pkg.credit_remaining || 0}</small>`;
                    } else if (pkg.package_type === 'membership') {
                        html += `<small class="d-block text-success">Unlimited Access</small>`;
                    }
                });
                
                if (data.total) {
                    html += `<hr class="my-1"><small class="text-muted">Total Active: ${data.total} package(s)</small>`;
                }
                html += '</div>';
                
                packagesDiv.innerHTML = html;
            } else {
                packagesDiv.innerHTML = '<small class="text-muted">No active packages found</small>';
                customerPackageData = { packages: [], total: 0 };
            }
            
            updateTaxCalculations();
        })
        .catch(error => {
            console.error('Error loading packages:', error);
            packagesDiv.innerHTML = '<small class="text-danger">Error loading packages. Please try again.</small>';
            customerPackageData = null;
        });
}

function checkServicePackageBenefit(serviceId, serviceName, originalPrice, quantity) {
    if (!customerPackageData || !customerPackageData.packages) {
        return null;
    }
    
    quantity = Math.max(1, quantity);
    
    for (const pkg of customerPackageData.packages) {
        if (!pkg.is_active && pkg.status !== 'active') continue;
        
        if (pkg.package_type === 'membership') {
            return {
                type: 'unlimited',
                packageName: pkg.package_name,
                originalPrice: originalPrice * quantity,
                finalPrice: 0,
                discount: originalPrice * quantity,
                description: `FREE via ${pkg.package_name} (Unlimited Membership)`
            };
        }
        
        if (pkg.package_type === 'service_package' && pkg.sessions_remaining > 0) {
            const pricePerSession = originalPrice;
            const sessionsToCover = Math.min(quantity, pkg.sessions_remaining);
            const sessionsToPayFor = Math.max(0, quantity - sessionsToCover);
            
            const coveredAmount = sessionsToCover * pricePerSession;
            const finalPrice = sessionsToPayFor * pricePerSession;
            
            const totalServicePrice = originalPrice * quantity;
            const actualDiscount = Math.min(coveredAmount, totalServicePrice);
            const actualFinalPrice = Math.max(0, totalServicePrice - actualDiscount);
            
            if (sessionsToPayFor > 0) {
                return {
                    type: 'service_package_partial',
                    packageName: pkg.package_name,
                    originalPrice: totalServicePrice,
                    finalPrice: actualFinalPrice,
                    discount: actualDiscount,
                    description: `${sessionsToCover} of ${quantity} sessions FREE, ${sessionsToPayFor} charged via ${pkg.package_name}`,
                    sessionsRemaining: pkg.sessions_remaining,
                    sessionsCovered: sessionsToCover,
                    sessionsToPayFor: sessionsToPayFor
                };
            } else {
                return {
                    type: 'service_package_full',
                    packageName: pkg.package_name,
                    originalPrice: totalServicePrice,
                    finalPrice: 0,
                    discount: totalServicePrice,
                    description: `All ${sessionsToCover} sessions FREE via ${pkg.package_name} (${pkg.sessions_remaining - sessionsToCover} remaining)`,
                    sessionsRemaining: pkg.sessions_remaining,
                    sessionsCovered: sessionsToCover,
                    sessionsToPayFor: 0
                };
            }
        }
        
        if (pkg.package_type === 'prepaid' && pkg.credit_remaining > 0) {
            const serviceTotal = originalPrice * quantity;
            if (pkg.credit_remaining >= serviceTotal) {
                return {
                    type: 'prepaid_full',
                    packageName: pkg.package_name,
                    originalPrice: serviceTotal,
                    finalPrice: 0,
                    discount: serviceTotal,
                    description: `FREE via ${pkg.package_name} (₹${pkg.credit_remaining} credit)`
                };
            } else {
                return {
                    type: 'prepaid_partial',
                    packageName: pkg.package_name,
                    originalPrice: serviceTotal,
                    finalPrice: serviceTotal - pkg.credit_remaining,
                    discount: pkg.credit_remaining,
                    description: `₹${pkg.credit_remaining} off via ${pkg.package_name}`
                };
            }
        }
    }
    
    return null;
}

function updateServiceDisplayWithBenefit(row, benefit, index) {
    let benefitDisplay = row.querySelector('.package-benefit-display');
    if (!benefitDisplay) {
        benefitDisplay = document.createElement('div');
        benefitDisplay.className = 'package-benefit-display mt-2';
        row.appendChild(benefitDisplay);
    }
    
    if (benefit.finalPrice === 0) {
        benefitDisplay.innerHTML = `
            <small class="text-success fw-bold">
                <i class="fas fa-gift me-1"></i>FREE - ${benefit.description}
                <br><strike class="text-muted">₹${benefit.originalPrice.toFixed(2)}</strike>
                <span class="badge bg-success ms-1">100% Covered</span>
            </small>
        `;
        benefitDisplay.style.backgroundColor = '#d1fae5';
        benefitDisplay.style.borderLeftColor = '#059669';
    } else {
        const isPartialCoverage = benefit.sessionsCovered && benefit.sessionsToPayFor;
        const coveragePercent = Math.round((benefit.discount / benefit.originalPrice) * 100);
        
        benefitDisplay.innerHTML = `
            <small class="fw-bold">
                <i class="fas fa-percentage me-1 text-info"></i>${benefit.description}
                <br>
                ${isPartialCoverage ?
                    `<span class="text-success">✓ Free: ${benefit.sessionsCovered} sessions</span> | <span class="text-warning">₹ Pay: ${benefit.sessionsToPayFor} sessions</span><br>` :
                    ''
                }
                <span class="text-dark">Pay: ₹${benefit.finalPrice.toFixed(2)}</span>
                <strike class="text-muted small">₹${benefit.originalPrice.toFixed(2)}</strike>
                <span class="badge bg-info ms-1">${coveragePercent}% Saved</span>
                <br><span class="text-success small">Package Discount: ₹${benefit.discount.toFixed(2)}</span>
            </small>
        `;
        benefitDisplay.style.backgroundColor = '#e0f2fe';
        benefitDisplay.style.borderLeftColor = '#0ea5e9';
    }
}

function clearServiceBenefitDisplay(row, index) {
    const benefitDisplay = row.querySelector('.package-benefit-display');
    if (benefitDisplay) {
        benefitDisplay.remove();
    }
}

function calculateServicesSubtotal() {
    let total = 0;
    document.querySelectorAll('.service-row').forEach((row, index) => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const quantityInput = row.querySelector('input[name="service_quantities[]"]');
        
        if (serviceSelect && serviceSelect.value && quantityInput && quantityInput.value) {
            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.price) {
                const originalPrice = parseFloat(selectedOption.dataset.price);
                const quantity = parseFloat(quantityInput.value) || 1;
                const serviceId = parseInt(serviceSelect.value);
                const serviceName = selectedOption.text;
                
                let finalPrice = originalPrice * quantity;
                let packageBenefit = null;
                
                if (customerPackageData && customerPackageData.packages) {
                    packageBenefit = checkServicePackageBenefit(serviceId, serviceName, originalPrice, quantity);
                    if (packageBenefit) {
                        finalPrice = packageBenefit.finalPrice;
                        updateServiceDisplayWithBenefit(row, packageBenefit, index);
                    }
                }
                
                if (!packageBenefit) {
                    clearServiceBenefitDisplay(row, index);
                }
                
                total += finalPrice;
            }
        }
    });
    
    return total;
}

function calculateProductsSubtotal() {
    let total = 0;
    document.querySelectorAll('.product-row').forEach(row => {
        const productSelect = row.querySelector('select[name="product_ids[]"]');
        const quantityInput = row.querySelector('input[name="product_quantities[]"]');
        const priceInput = row.querySelector('input[name="product_prices[]"]');
        
        if (productSelect && productSelect.value && quantityInput && quantityInput.value && priceInput && priceInput.value) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            total += quantity * price;
        }
    });
    
    return total;
}

function calculatePackageDeductions() {
    let totalDeductions = 0;
    
    document.querySelectorAll('.service-row').forEach((row, index) => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const quantityInput = row.querySelector('input[name="service_quantities[]"]');
        
        if (serviceSelect && serviceSelect.value && quantityInput && quantityInput.value) {
            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.price) {
                const originalPrice = parseFloat(selectedOption.dataset.price);
                const quantity = parseFloat(quantityInput.value) || 1;
                const serviceId = parseInt(serviceSelect.value);
                const serviceName = selectedOption.text;
                
                if (customerPackageData && customerPackageData.packages) {
                    const packageBenefit = checkServicePackageBenefit(serviceId, serviceName, originalPrice, quantity);
                    if (packageBenefit && packageBenefit.discount) {
                        totalDeductions += packageBenefit.discount;
                    }
                }
            }
        }
    });
    
    return totalDeductions;
}

function updateTaxCalculations() {
    const servicesSubtotal = calculateServicesSubtotal();
    const productsSubtotal = calculateProductsSubtotal();
    const packageDeductions = calculatePackageDeductions();
    
    const totalBeforeDiscount = servicesSubtotal + productsSubtotal;
    
    const discountPercentage = parseFloat(document.querySelector('input[name="discount_percentage"]')?.value) || 0;
    const discountAmount = (totalBeforeDiscount * discountPercentage) / 100;
    
    const subtotalAfterDeductions = Math.max(0, totalBeforeDiscount - discountAmount);
    
    const gstEnabled = document.getElementById('gstEnabled')?.checked || false;
    const gstPercentage = gstEnabled ? (parseFloat(document.getElementById('gstPercentage')?.value) || 0) : 0;
    const gstAmount = (subtotalAfterDeductions * gstPercentage) / 100;
    
    const grandTotal = subtotalAfterDeductions + gstAmount;
    
    const serviceCount = document.querySelectorAll('.service-row select[name="service_ids[]"]').length;
    const productCount = document.querySelectorAll('.product-row select[name="product_ids[]"]').length;
    
    // Update main display
    document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
    document.getElementById('grandTotalBtn').textContent = grandTotal.toFixed(2);
    document.getElementById('serviceCount').textContent = serviceCount;
    document.getElementById('productCount').textContent = productCount;
    
    // Update floating panel (if exists)
    if (document.getElementById('servicesSubtotalPanel')) {
        document.getElementById('servicesSubtotalPanel').textContent = servicesSubtotal.toFixed(2);
        document.getElementById('productsSubtotalPanel').textContent = productsSubtotal.toFixed(2);
        document.getElementById('packageDeductionsPanel').textContent = packageDeductions.toFixed(2);
        document.getElementById('discountAmountPanel').textContent = discountAmount.toFixed(2);
        document.getElementById('subtotalAfterDeductionsPanel').textContent = subtotalAfterDeductions.toFixed(2);
        document.getElementById('gstAmountPanel').textContent = gstAmount.toFixed(2);
        document.getElementById('gstRateDisplayPanel').textContent = gstPercentage.toFixed(0);
        document.getElementById('grandTotalPanel').textContent = grandTotal.toFixed(2);
        document.getElementById('serviceCountPanel').textContent = serviceCount;
        document.getElementById('productCountPanel').textContent = productCount;
    }
}

function handleBillingFormSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const data = {
        client_id: formData.get('client_id'),
        payment_method: formData.get('payment_method'),
        payment_status: formData.get('payment_status'),
        discount_percentage: parseFloat(formData.get('discount_percentage')) || 0,
        gst_enabled: document.getElementById('gstEnabled')?.checked || false,
        gst_percentage: document.getElementById('gstEnabled')?.checked ? 
            (parseFloat(formData.get('gst_percentage')) || 0) : 0,
        notes: formData.get('notes') || '',
        services: [],
        products: []
    };
    
    document.querySelectorAll('.service-row').forEach((row, index) => {
        const serviceId = row.querySelector('select[name="service_ids[]"]')?.value;
        const staffId = row.querySelector('select[name="staff_ids[]"]')?.value;
        const quantity = row.querySelector('input[name="service_quantities[]"]')?.value;
        const appointmentId = row.querySelector('input[name="appointment_ids[]"]')?.value;
        
        if (serviceId && staffId) {
            data.services.push({
                service_id: parseInt(serviceId),
                staff_id: parseInt(staffId),
                quantity: parseFloat(quantity) || 1,
                appointment_id: appointmentId ? parseInt(appointmentId) : null
            });
        }
    });
    
    document.querySelectorAll('.product-row').forEach((row, index) => {
        const productId = row.querySelector('select[name="product_ids[]"]')?.value;
        const batchId = row.querySelector('select[name="batch_ids[]"]')?.value;
        const quantity = row.querySelector('input[name="product_quantities[]"]')?.value;
        const price = row.querySelector('input[name="product_prices[]"]')?.value;
        
        if (productId && batchId && quantity && price) {
            data.products.push({
                product_id: parseInt(productId),
                batch_id: parseInt(batchId),
                quantity: parseFloat(quantity),
                unit_price: parseFloat(price)
            });
        }
    });
    
    if (!data.client_id) {
        showNotification('Please select a customer', 'error');
        return;
    }
    
    if (data.services.length === 0 && data.products.length === 0) {
        showNotification('Please add at least one service or product', 'error');
        return;
    }
    
    fetch('/integrated-billing/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showNotification('Invoice created successfully!', 'success');
            setTimeout(() => {
                window.location.href = result.redirect || '/integrated-billing';
            }, 1500);
        } else {
            showNotification(result.error || 'Failed to create invoice', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred while creating the invoice', 'error');
    });
}

function showNotification(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    notification.style.zIndex = '9999';
    notification.style.maxWidth = '400px';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}
</script>
{% endblock %}
