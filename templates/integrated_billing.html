{% extends "base.html" %}

{% block title %}Professional Invoice Management{% endblock %}

{% block extra_head %}
<style>
/* ==========================================
   DESIGN SYSTEM - PROFESSIONAL BILLING
   ========================================== */

:root {
    /* Brand Identity */
    --primary: #4f46e5;
    --primary-hover: #4338ca;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #06b6d4;

    /* Neutral Palette */
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-500: #6b7280;
    --gray-700: #374151;
    --gray-900: #111827;

    /* Elevation */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

    /* Spacing System */
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    --spacing-2xl: 3rem;

    /* Border Radius */
    --radius-sm: 0.375rem;
    --radius: 0.5rem;
    --radius-lg: 0.75rem;

    /* Transitions */
    --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ==========================================
   GLOBAL RESET & BASE
   ========================================== */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
    background: var(--gray-50);
    color: var(--gray-900);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
}

/* ==========================================
   LAYOUT COMPONENTS
   ========================================== */

.page-header {
    background: white;
    border-bottom: 1px solid var(--gray-200);
    padding: var(--spacing-xl) var(--spacing-2xl);
    margin-bottom: var(--spacing-xl);
    box-shadow: var(--shadow-sm);
}

.page-title {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-sm);
}

.page-title i {
    color: var(--primary);
}

.page-subtitle {
    color: var(--gray-500);
    font-size: 0.875rem;
}

/* ==========================================
   CARD COMPONENTS
   ========================================== */

.card {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    padding: var(--spacing-xl);
    margin-bottom: var(--spacing-lg);
    transition: var(--transition);
}

.card:hover {
    box-shadow: var(--shadow-md);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 2px solid var(--gray-100);
}

.card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.card-title i {
    color: var(--primary);
}

/* ==========================================
   FORM CONTROLS
   ========================================== */

.form-group {
    margin-bottom: var(--spacing-lg);
}

.form-label {
    display: block;
    font-weight: 500;
    font-size: 0.875rem;
    color: var(--gray-700);
    margin-bottom: var(--spacing-sm);
}

.form-label.required::after {
    content: '*';
    color: var(--danger);
    margin-left: 0.25rem;
}

.form-control,
.form-select {
    width: 100%;
    padding: 0.625rem 0.875rem;
    font-size: 0.875rem;
    line-height: 1.5;
    color: var(--gray-900);
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius);
    transition: var(--transition);
}

.form-control:focus,
.form-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
}

.form-control:hover:not(:focus),
.form-select:hover:not(:focus) {
    border-color: var(--gray-400);
}

.form-control.is-invalid,
.form-select.is-invalid {
    border-color: var(--danger);
}

.invalid-feedback {
    display: none;
    color: var(--danger);
    font-size: 0.8125rem;
    margin-top: var(--spacing-xs);
}

.is-invalid + .invalid-feedback {
    display: block;
}

textarea.form-control {
    resize: vertical;
    min-height: 80px;
}

/* ==========================================
   BUTTONS
   ========================================== */

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.5;
    text-align: center;
    text-decoration: none;
    border: none;
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: var(--primary-hover);
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-success:hover:not(:disabled) {
    background: #059669;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-info {
    background: var(--info);
    color: white;
}

.btn-info:hover:not(:disabled) {
    background: #0891b2;
    transform: translateY(-1px);
    box-shadow: var(--shadow-md);
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-danger:hover:not(:disabled) {
    background: #dc2626;
}

.btn-sm {
    padding: 0.4rem 0.875rem;
    font-size: 0.8125rem;
}

.btn-lg {
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
}

/* Button States */
.btn-loading .btn-text {
    display: none;
}

.btn-loading .btn-spinner {
    display: inline-block;
}

.btn:not(.btn-loading) .btn-spinner {
    display: none;
}

/* ==========================================
   ITEM ROWS
   ========================================== */

.item-row {
    background: var(--gray-50);
    border: 1px solid var(--gray-200);
    border-radius: var(--radius);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
    transition: var(--transition);
}

.item-row:hover {
    background: white;
    border-color: var(--primary);
    box-shadow: var(--shadow-sm);
}

.item-row .row {
    align-items: end;
}

.package-benefit {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-sm);
    margin-top: var(--spacing-sm);
    font-size: 0.8125rem;
    border-left: 3px solid var(--success);
}

.batch-info {
    background: var(--gray-100);
    border-left: 3px solid var(--info);
    padding: var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    margin-top: var(--spacing-xs);
    color: var(--gray-700);
}

/* ==========================================
   SUMMARY PANEL
   ========================================== */

.summary-panel {
    background: linear-gradient(135deg, var(--primary) 0%, #6366f1 100%);
    color: white;
    border-radius: var(--radius-lg);
    padding: var(--spacing-xl);
    position: sticky;
    top: var(--spacing-lg);
    box-shadow: var(--shadow-lg);
}

.summary-header {
    text-align: center;
    margin-bottom: var(--spacing-lg);
    font-size: 1.25rem;
    font-weight: 600;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: var(--spacing-md) 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.summary-row:last-of-type {
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.summary-label {
    font-weight: 400;
    opacity: 0.9;
}

.summary-value {
    font-weight: 600;
}

.grand-total {
    font-size: 2.5rem;
    font-weight: 800;
    text-align: center;
    margin: var(--spacing-xl) 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.summary-actions {
    display: grid;
    gap: var(--spacing-md);
    margin-top: var(--spacing-lg);
}

.summary-footer {
    text-align: center;
    margin-top: var(--spacing-md);
    font-size: 0.75rem;
    opacity: 0.7;
}

/* ==========================================
   ALERTS & NOTIFICATIONS
   ========================================== */

.alert {
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius);
    margin-bottom: var(--spacing-md);
    border-left: 4px solid;
}

.alert-info {
    background: #e0f2fe;
    border-color: var(--info);
    color: #075985;
}

.alert-success {
    background: #d1fae5;
    border-color: var(--success);
    color: #065f46;
}

.alert-warning {
    background: #fef3c7;
    border-color: var(--warning);
    color: #92400e;
}

.alert-danger {
    background: #fee2e2;
    border-color: var(--danger);
    color: #991b1b;
}

/* Toast Notifications */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    max-width: 400px;
    padding: var(--spacing-lg);
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

/* ==========================================
   UTILITIES
   ========================================== */

.text-muted {
    color: var(--gray-500);
}

.text-success {
    color: var(--success);
}

.text-danger {
    color: var(--danger);
}

.d-none {
    display: none !important;
}

.d-block {
    display: block !important;
}

.d-flex {
    display: flex !important;
}

.d-grid {
    display: grid !important;
}

.gap-2 {
    gap: var(--spacing-sm);
}

.gap-3 {
    gap: var(--spacing-md);
}

.mb-3 {
    margin-bottom: var(--spacing-md);
}

.w-100 {
    width: 100%;
}

.spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

/* ==========================================
   RESPONSIVE DESIGN
   ========================================== */

@media (max-width: 768px) {
    .page-header {
        padding: var(--spacing-lg);
    }

    .page-title {
        font-size: 1.5rem;
    }

    .card {
        padding: var(--spacing-lg);
    }

    .grand-total {
        font-size: 2rem;
    }

    .summary-panel {
        position: static;
        margin-top: var(--spacing-xl);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-file-invoice-dollar"></i>
            Create Professional Invoice
        </h1>
        <p class="page-subtitle">
            Comprehensive billing with package benefits, inventory tracking, and staff management
        </p>
    </div>

    <!-- Main Billing Form -->
    <form id="billingForm" method="POST" action="/integrated-billing/create-professional">
        <div class="row">
            <!-- Left Column: Form Inputs -->
            <div class="col-lg-8">
                <!-- Customer Section -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-user-circle"></i>
                            Customer Information
                        </h6>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label required">Select Customer</label>
                                <select class="form-select" id="client_id" name="client_id" required>
                                    <option value="">Choose customer...</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}" {{ 'selected' if selected_customer and customer.id == selected_customer.id else '' }}>
                                        {{ customer.full_name }} - {{ customer.phone }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">Please select a customer</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Booked Appointments</label>
                                <div id="customerAppointments" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--gray-300); border-radius: var(--radius); background: white;">
                                    <div style="padding: var(--spacing-md); text-align: center; color: var(--gray-500);">
                                        <small><i class="fas fa-info-circle me-1"></i>Select customer to view appointments</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 mt-3">
                            <div class="form-group">
                                <label class="form-label">Active Packages</label>
                                <div id="customerPackagesTable" style="max-height: 250px; overflow-y: auto; border: 1px solid var(--gray-300); border-radius: var(--radius); background: white;">
                                    <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
                                        <thead style="background: var(--gray-50); position: sticky; top: 0;">
                                            <tr>
                                                <th>PACKAGE NAME</th>
                                                <th>TYPE</th>
                                                <th>STATUS</th>
                                                <th>BALANCE</th>
                                                <th>EXPIRY</th>
                                            </tr>
                                        </thead>
                                        <tbody id="activePackagesTableBody">
                                            {% if customer_active_packages %}
                                                {% for package in customer_active_packages %}
                                                <tr>
                                                    <td><strong>{{ package.name }}</strong><br><small class="text-muted">{{ package.service_name or 'Multiple Services' }}</small></td>
                                                    <td><span class="badge bg-{{ 'warning' if package.benefit_type == 'free' else 'info' }}">{{ package.benefit_type|title }}</span></td>
                                                    <td><span class="badge bg-{{ 'success' if package.is_active else 'secondary' }}">{{ 'Active' if package.is_active else 'Inactive' }}</span></td>
                                                    <td>
                                                        {% if package.benefit_type in ['free', 'discount'] %}
                                                            <strong>{{ package.remaining_count }}/{{ package.total_allocated }} sessions</strong>
                                                            <div class="progress mt-1" style="height: 5px;">
                                                                <div class="progress-bar bg-success" style="width: {{ package.usage_percentage }}%"></div>
                                                            </div>
                                                        {% elif package.benefit_type == 'prepaid' %}
                                                            <strong>₹{{ "%.2f"|format(package.balance_remaining) }}</strong> / ₹{{ "%.2f"|format(package.balance_total) }}
                                                        {% elif package.benefit_type == 'unlimited' %}
                                                            <span class="badge bg-success">Unlimited</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>{{ package.valid_to }}</td>
                                                </tr>
                                                {% endfor %}
                                            {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">
                                                    <i class="fas fa-box-open fa-2x mb-2"></i>
                                                    <p class="mb-0">No active packages</p>
                                                </td>
                                            </tr>
                                            {% endif %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Services Section -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-spa"></i>
                            Services
                        </h6>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addServiceRow()">
                            <i class="fas fa-plus"></i>
                            Add Service
                        </button>
                    </div>
                    <div id="servicesContainer">
                        <div class="item-row service-row">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">Service</label>
                                        <select class="form-select" name="service_ids[]" onchange="handleServiceChange(this)">
                                            <option value="">Select Service</option>
                                            {% for service in services %}
                                            <option value="{{ service.id }}" data-price="{{ service.price|float }}">
                                                {{ service.name }} - ₹{{ "{:,.2f}".format(service.price) }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label required">Staff</label>
                                        <select class="form-select" name="staff_ids[]">
                                            <option value="">Select Staff</option>
                                            {% for staff in staff_members %}
                                            <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Staff required</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Qty</label>
                                        <input type="number" class="form-control" name="service_quantities[]" value="1" min="0.5" step="0.5" oninput="updateCalculations()">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Apt ID</label>
                                        <input type="number" class="form-control" name="appointment_ids[]" placeholder="Optional">
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-box"></i>
                            Products & Inventory
                        </h6>
                        <button type="button" class="btn btn-primary btn-sm" onclick="addProductRow()">
                            <i class="fas fa-plus"></i>
                            Add Product
                        </button>
                    </div>
                    <div id="productsContainer">
                        <div class="item-row product-row">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Product</label>
                                        <select class="form-select" name="product_ids[]" onchange="loadBatches(this)">
                                            <option value="">Select Product</option>
                                            {% for product in inventory_items %}
                                            <option value="{{ product.id }}">{{ product.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Batch</label>
                                        <select class="form-select batch-select" name="batch_ids[]" disabled>
                                            <option value="">Select Product</option>
                                        </select>
                                        <div class="batch-info"></div>
                                        <div class="invalid-feedback">Batch required</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label required">Staff</label>
                                        <select class="form-select" name="product_staff_ids[]">
                                            <option value="">Select Staff</option>
                                            {% for staff in staff_members %}
                                            <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="invalid-feedback">Staff required</div>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Qty</label>
                                        <input type="number" class="form-control" name="product_quantities[]" value="1" min="0.01" step="0.01" oninput="updateCalculations()">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label class="form-label">Price</label>
                                        <input type="number" class="form-control" name="product_prices[]" placeholder="₹0.00" min="0" step="0.01" oninput="updateCalculations()">
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="removeRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title">
                            <i class="fas fa-credit-card"></i>
                            Payment & Tax Details
                        </h6>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label required">Payment Method</label>
                                <select class="form-select" name="payment_method" required>
                                    <option value="">Select Method</option>
                                    <option value="cash">Cash</option>
                                    <option value="card">Card</option>
                                    <option value="upi">UPI</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                </select>
                                <div class="invalid-feedback">Payment method required</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Discount Type</label>
                                <select class="form-select" name="discount_type" onchange="updateCalculations()">
                                    <option value="percentage">Percentage (%)</option>
                                    <option value="amount">Amount (₹)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Discount Value</label>
                                <input type="number" class="form-control" name="discount_value" value="0" min="0" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">CGST Rate (%)</label>
                                <input type="number" class="form-control" name="cgst_rate" value="9" min="0" max="100" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">SGST Rate (%)</label>
                                <input type="number" class="form-control" name="sgst_rate" value="9" min="0" max="100" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">Additional Charges</label>
                                <input type="number" class="form-control" name="additional_charges" value="0" min="0" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Tips Amount</label>
                                <input type="number" class="form-control" name="tips_amount" value="0" min="0" step="0.01" oninput="updateCalculations()">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes" rows="3" placeholder="Add invoice notes..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary -->
            <div class="col-lg-4">
                <div class="summary-panel">
                    <h5 class="summary-header">
                        <i class="fas fa-calculator me-2"></i>
                        Bill Summary
                    </h5>

                    <div class="summary-row">
                        <span class="summary-label">Services:</span>
                        <span class="summary-value" id="servicesSubtotal">₹0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Products:</span>
                        <span class="summary-value" id="productsSubtotal">₹0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Subtotal:</span>
                        <span class="summary-value" id="subtotalAmount">₹0.00</span>
                    </div>

                    <div class="summary-row text-success">
                        <span class="summary-label">Package Benefits:</span>
                        <span class="summary-value" id="packageDeductions">-₹0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Discount:</span>
                        <span class="summary-value" id="discountAmount">-₹0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">CGST:</span>
                        <span class="summary-value" id="cgstAmount">₹0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">SGST:</span>
                        <span class="summary-value" id="sgstAmount">₹0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Additional Charges:</span>
                        <span class="summary-value" id="additionalCharges">₹0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Tips:</span>
                        <span class="summary-value" id="tipsDisplay">₹0.00</span>
                    </div>

                    <div class="grand-total" id="grandTotal">₹0.00</div>

                    <div class="summary-actions">
                        <button type="submit" class="btn btn-success btn-lg" id="saveBtn">
                            <span class="btn-text">
                                <i class="fas fa-check-circle"></i>
                                Save
                            </span>
                            <span class="btn-spinner">
                                <i class="fas fa-spinner spinner"></i>
                                Saving...
                            </span>
                        </button>

                        <button type="button" class="btn btn-info btn-lg" onclick="saveAndPrint()">
                            <i class="fas fa-print"></i>
                            Save & Print
                        </button>

                        <button type="button" class="btn btn-primary" onclick="previewInvoice()">
                            <i class="fas fa-eye"></i>
                            Preview
                        </button>
                    </div>

                    <div class="summary-footer">
                        <i class="fas fa-shield-alt me-1"></i>
                        Secure & Encrypted
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// ==========================================
// STATE MANAGEMENT
// ==========================================
const BillingState = {
    customerPackages: null,
    batchCache: {},
    isSubmitting: false
};

// ==========================================
// INITIALIZATION
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    initializeBillingSystem();
    updateCalculations();

    {% if selected_customer %}
    loadCustomerPackages({{ selected_customer.id }});
    loadCustomerAppointments({{ selected_customer.id }});
    {% endif %}
});

function initializeBillingSystem() {
    // Customer selector
    const clientSelect = document.getElementById('client_id');
    clientSelect?.addEventListener('change', function() {
        if (this.value) {
            loadCustomerPackages(this.value);
            loadCustomerAppointments(this.value);
        } else {
            resetCustomerPackages();
            resetCustomerAppointments();
        }
    });

    // Form submission
    const form = document.getElementById('billingForm');
    form?.addEventListener('submit', handleFormSubmit);

    // Input validation
    setupInputValidation();
}

// ==========================================
// CUSTOMER & PACKAGES
// ==========================================
function loadCustomerPackages(customerId) {
    // Fetch packages only
    fetch(`/integrated-billing/customer-packages/${customerId}`)
        .then(res => res.json())
        .then(packagesData => {
            BillingState.customerPackages = packagesData;
            updateCalculations();
        })
        .catch(err => {
            console.error('Error loading packages:', err);
        });
}

function loadCustomerAppointments(customerId) {
    const appointmentsDiv = document.getElementById('customerAppointments');
    appointmentsDiv.innerHTML = '<div style="padding: var(--spacing-md); text-align: center;"><small><i class="fas fa-spinner spinner"></i> Loading appointments...</small></div>';

    fetch(`/api/customer/${customerId}/appointments`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                displayCustomerAppointments(data.appointments || []);
            } else {
                appointmentsDiv.innerHTML = '<div style="padding: var(--spacing-xl); text-align: center; color: var(--danger);"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p class="mb-0"><strong>Error Loading Appointments</strong></p><small>Please try again</small></div>';
            }
        })
        .catch(err => {
            console.error('Error loading appointments:', err);
            appointmentsDiv.innerHTML = '<div style="padding: var(--spacing-xl); text-align: center; color: var(--danger);"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p class="mb-0"><strong>Error Loading Appointments</strong></p><small>Please try again</small></div>';
        });

    // Also load packages display
    loadCustomerPackagesDisplay(customerId);
}

function loadCustomerPackagesDisplay(customerId) {
    const packagesDiv = document.getElementById('customerPackagesTable');
    packagesDiv.innerHTML = '<div style="padding: var(--spacing-md); text-align: center;"><small><i class="fas fa-spinner spinner"></i> Loading packages...</small></div>';

    fetch(`/integrated-billing/customer-packages/${customerId}`)
        .then(res => res.json())
        .then(data => {
            // Use the new display function which handles empty packages
            displayCustomerPackagesTable(data.packages || []);
        })
        .catch(err => {
            console.error('Error loading customer packages:', err);
            packagesDiv.innerHTML = `
                <div style="padding: var(--spacing-xl); text-align: center; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p class="mb-0"><strong>Error Loading Packages</strong></p>
                    <small>Please try again</small>
                </div>`;
        });
}

function refreshCustomerPackages(customerId, updatedPackages) {
    // Immediately update UI with the updated packages or fetch fresh data
    if (updatedPackages && updatedPackages.length > 0) {
        // Update the display with fresh data
        console.log('Refreshing package display after invoice creation', updatedPackages);
    }

    // Fetch fresh packages from server (fallback or additional verification)
    fetch(`/integrated-billing/customer-packages/${customerId}`, { cache: 'no-store' })
        .then(r => r.json())
        .then(j => { 
            if (j.success) {
                displayCustomerPackagesTable(j.packages);
                console.log('Package balances refreshed successfully');
            }
        })
        .catch(err => console.error('Error refreshing packages:', err));
}

function displayCustomerPackagesTable(packages) {
    const packagesDiv = document.getElementById('customerPackagesTable');

    if (!packages || packages.length === 0) {
        packagesDiv.innerHTML = `
            <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
                <thead style="background: var(--gray-50); position: sticky; top: 0;">
                    <tr>
                        <th style="padding: 0.5rem;">Package Name</th>
                        <th style="padding: 0.5rem;">Type</th>
                        <th style="padding: 0.5rem;">Status</th>
                        <th style="padding: 0.5rem;">Balance</th>
                        <th style="padding: 0.5rem;">Expiry</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            <i class="fas fa-box-open fa-2x mb-2"></i>
                            <p class="mb-0">No active packages</p>
                        </td>
                    </tr>
                </tbody>
            </table>`;
        return;
    }

    let html = `
        <table class="table table-sm table-hover mb-0" style="font-size: 0.875rem;">
            <thead style="background: var(--gray-50); position: sticky; top: 0;">
                <tr>
                    <th style="padding: 0.5rem;">Package Name</th>
                    <th style="padding: 0.5rem;">Type</th>
                    <th style="padding: 0.5rem;">Status</th>
                    <th style="padding: 0.5rem;">Balance</th>
                    <th style="padding: 0.5rem;">Expiry</th>
                </tr>
            </thead>
            <tbody>`;

    packages.forEach(pkg => {
        const packageName = pkg.package_name || 'Unknown Package';
        const packageType = pkg.package_type || 'N/A';
        const status = pkg.status || 'active';

        // Determine status badge
        let statusBadge = '';
        if (status === 'active') {
            statusBadge = '<span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Active</span>';
        } else if (status === 'expired') {
            statusBadge = '<span style="background: #fee2e2; color: #991b1b; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Expired</span>';
        } else if (status === 'completed') {
            statusBadge = '<span style="background: #e5e7eb; color: #374151; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Completed</span>';
        }

        // Display balance based on package type
        let balanceText = '';
        if (packageType === 'prepaid') {
            balanceText = `₹${(pkg.remaining_credit || 0).toFixed(2)} / ₹${(pkg.credit_amount || 0).toFixed(2)}`;
        } else if (packageType === 'service_package') {
            balanceText = `${pkg.remaining_sessions || 0} / ${pkg.total_sessions || 0} sessions`;
        } else if (packageType === 'membership') {
            balanceText = 'Unlimited';
        }

        // Format expiry date
        const expiryDate = pkg.expires_on ? new Date(pkg.expires_on).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'No expiry';

        // Type badge
        let typeBadge = '';
        if (packageType === 'prepaid') {
            typeBadge = '<span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Prepaid</span>';
        } else if (packageType === 'service_package') {
            typeBadge = '<span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Service</span>';
        } else if (packageType === 'membership') {
            typeBadge = '<span style="background: #e9d5ff; color: #6b21a8; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">Membership</span>';
        }

        html += `
            <tr style="border-bottom: 1px solid var(--gray-200);">
                <td style="padding: 0.5rem;">
                    <strong>${packageName}</strong>
                    ${pkg.service_name ? `<br><small class="text-muted">${pkg.service_name}</small>` : ''}
                </td>
                <td style="padding: 0.5rem;">${typeBadge}</td>
                <td style="padding: 0.5rem;">${statusBadge}</td>
                <td style="padding: 0.5rem;"><strong>${balanceText}</strong></td>
                <td style="padding: 0.5rem;">
                    <small>${expiryDate}</small>
                </td>
            </tr>`;
    });

    html += `
            </tbody>
        </table>`;

    packagesDiv.innerHTML = html;
}


function resetCustomerAppointments() {
    // Clear tracking when customer changes
    addedAppointmentIds.clear();
    document.getElementById('customerAppointments').innerHTML = 
        '<div style="padding: var(--spacing-md); text-align: center; color: var(--gray-500);"><small><i class="fas fa-info-circle"></i> Select customer to view appointments</small></div>';

    // Also reset packages table
    document.getElementById('customerPackagesTable').innerHTML = 
        '<div style="padding: var(--spacing-md); text-align: center; color: var(--gray-500);"><small><i class="fas fa-gift"></i> Select customer to view active packages</small></div>';
}


// Track which appointments have been added to bill
const addedAppointmentIds = new Set();

function displayCustomerAppointments(appointments) {
    const appointmentsDiv = document.getElementById('customerAppointments');

    if (!appointments || !appointments.length) {
        appointmentsDiv.innerHTML = `
            <div style="padding: var(--spacing-xl); text-align: center; color: var(--gray-500);">
                <i class="fas fa-calendar-times fa-2x mb-2" style="opacity: 0.5;"></i>
                <p class="mb-0"><strong>No Booked Appointments</strong></p>
                <small>This customer has no confirmed appointments ready for billing</small>
            </div>`;
        return;
    }

    let html = `
        <div style="padding: 0;">
            <div style="background: var(--gray-50); padding: 8px 12px; border-bottom: 1px solid var(--gray-300);">
                <small style="color: var(--gray-600);"><i class="fas fa-info-circle me-1"></i>Click "Add to Bill" to include appointment in invoice</small>
            </div>
            <table class="table table-sm mb-0" style="font-size: 0.875rem;">
                <thead style="background: var(--gray-100); position: sticky; top: 0; z-index: 1;">
                    <tr>
                        <th style="padding: 8px;">Service</th>
                        <th style="padding: 8px;">Staff</th>
                        <th style="padding: 8px;">Date & Time</th>
                        <th style="padding: 8px; text-align: right;">Price</th>
                        <th style="padding: 8px; width: 120px;">Action</th>
                    </tr>
                </thead>
                <tbody>`;

    appointments.forEach(apt => {
        const aptDate = new Date(apt.appointment_date);
        const dateStr = aptDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const timeStr = apt.start_time || aptDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

        const statusBadge = apt.status === 'completed' ? 
            '<span class="badge bg-success" style="font-size: 0.7rem;">Done</span>' :
            apt.status === 'confirmed' ?
            '<span class="badge bg-info" style="font-size: 0.7rem;">Confirmed</span>' :
            '<span class="badge bg-warning" style="font-size: 0.7rem;">Scheduled</span>';

        const isAdded = addedAppointmentIds.has(apt.id);

        // Safely escape service and staff names
        const serviceName = (apt.service_name || 'Service not specified').replace(/'/g, "\\'").replace(/"/g, '\\"');
        const staffName = (apt.staff_name || 'Not assigned').replace(/'/g, "\\'").replace(/"/g, '\\"');

        html += `
            <tr style="border-bottom: 1px solid var(--gray-200); ${isAdded ? 'background: #f0fdf4;' : ''}">
                <td style="padding: 8px;">
                    <div style="font-weight: 600; color: var(--gray-900);">${apt.service_name || 'Service not specified'}</div>
                    <small style="color: var(--gray-500);">${apt.service_duration ? apt.service_duration + ' min' : ''} ${statusBadge}</small>
                </td>
                <td style="padding: 8px;">
                    <small style="color: var(--gray-700);">${apt.staff_name || 'Not assigned'}</small>
                </td>
                <td style="padding: 8px;">
                    <small style="color: var(--gray-700);">${dateStr}<br>${timeStr}</small>
                </td>
                <td style="padding: 8px; text-align: right;">
                    <strong style="color: var(--primary);">₹${(apt.service_price || 0).toFixed(2)}</strong>
                </td>
                <td style="padding: 8px;">
                    <button type="button" 
                            class="btn btn-sm ${isAdded ? 'btn-success' : 'btn-primary'} w-100" 
                            onclick="addAppointmentToBill(${apt.id}, '${serviceName}', ${apt.service_id || 'null'}, ${apt.staff_id || 'null'}, ${apt.service_price || 0}, ${apt.service_duration || 60})"
                            ${isAdded ? 'disabled' : ''}
                            style="font-size: 0.75rem; padding: 4px 8px;">
                        ${isAdded ? '<i class="fas fa-check"></i> Added' : '<i class="fas fa-plus"></i> Add'}
                    </button>
                </td>
            </tr>`;
    });

    html += `
                </tbody>
            </table>
        </div>`;

    appointmentsDiv.innerHTML = html;
}

function resetCustomerPackages() {
    BillingState.customerPackages = null;
    addedAppointmentIds.clear(); // Also clear added appointments tracking
    updateCalculations();
}


function toggleAppointmentInBill(appointmentId, serviceName, servicePrice, staffName, serviceId) {
    const isAdded = addedAppointmentIds.has(appointmentId);

    if (isAdded) {
        // Remove from bill
        removeAppointmentFromBill(appointmentId);
        addedAppointmentIds.delete(appointmentId);

        // Update button
        const btn = document.getElementById(`apt-btn-${appointmentId}`);
        if (btn) {
            btn.className = 'btn btn-sm btn-primary';
            btn.innerHTML = '<i class="fas fa-plus"></i> Add';
        }

        showNotification(`Appointment #${appointmentId} removed from bill`, 'info');
    } else {
        // Add to bill
        addAppointmentToBill(appointmentId, serviceName, servicePrice, staffName, serviceId);
        addedAppointmentIds.add(appointmentId);

        // Update button
        const btn = document.getElementById(`apt-btn-${appointmentId}`);
        if (btn) {
            btn.className = 'btn btn-sm btn-danger';
            btn.innerHTML = '<i class="fas fa-minus"></i> Remove';
        }

        showNotification(`Appointment #${appointmentId} added to bill`, 'success');
    }
}

function addAppointmentToBill(appointmentId, serviceName, serviceId, staffId, servicePrice, serviceDuration) {
    console.log(`Adding appointment ${appointmentId} to bill - Service: ${serviceName}, ServiceID: ${serviceId}, StaffID: ${staffId}, Price: ${servicePrice}`);

    const container = document.getElementById('servicesContainer');
    if (!container) {
        console.error('Services container not found');
        return;
    }

    const firstRow = container.children[0];
    const serviceSelect = firstRow.querySelector('select[name="service_ids[]"]');
    const staffSelect = firstRow.querySelector('select[name="staff_ids[]"]');
    const qtyInput = firstRow.querySelector('input[name="service_quantities[]"]');
    const appointmentInput = firstRow.querySelector('input[name="appointment_ids[]"]');

    const isFirstRowEmpty = !serviceSelect.value;

    if (isFirstRowEmpty) {
        // Use first row if empty
        if (serviceId && serviceSelect) {
            serviceSelect.value = serviceId;
            handleServiceChange(serviceSelect);
        }

        if (staffId && staffSelect) {
            staffSelect.value = staffId;
        }

        if (qtyInput) qtyInput.value = 1;
        if (appointmentInput) {
            appointmentInput.value = appointmentId;
            appointmentInput.dataset.appointmentId = appointmentId;
            console.log(`✅ Set appointment ID ${appointmentId} in first row`);
        }

        // Mark as added
        addedAppointmentIds.add(appointmentId);
    } else {
        // Add new row
        addServiceRow();

        const newRow = container.children[container.children.length - 1];
        const newServiceSelect = newRow.querySelector('select[name="service_ids[]"]');
        const newStaffSelect = newRow.querySelector('select[name="staff_ids[]"]');
        const newQtyInput = newRow.querySelector('input[name="service_quantities[]"]');
        const newAppointmentInput = newRow.querySelector('input[name="appointment_ids[]"]');

        if (serviceId && newServiceSelect) {
            newServiceSelect.value = serviceId;
            handleServiceChange(newServiceSelect);
        }

        if (staffId && newStaffSelect) {
            newStaffSelect.value = staffId;
        }

        if (newQtyInput) newQtyInput.value = 1;
        if (newAppointmentInput) {
            newAppointmentInput.value = appointmentId;
            newAppointmentInput.dataset.appointmentId = appointmentId;
            console.log(`✅ Set appointment ID ${appointmentId} in new row`);
        }

        // Mark as added
        addedAppointmentIds.add(appointmentId);
    }

    updateCalculations();

    // Refresh appointments display to show "Added" button
    const clientId = document.getElementById('client_id').value;
    if (clientId) {
        loadCustomerAppointments(clientId);
    }
}

function removeAppointmentFromBill(appointmentId) {
    const container = document.getElementById('servicesContainer');
    if (!container) return;

    // Find and remove the row with this appointment ID
    const rows = container.querySelectorAll('.service-row');
    rows.forEach(row => {
        const appointmentInput = row.querySelector('input[name="appointment_ids[]"]');
        if (appointmentInput && appointmentInput.dataset.appointmentId == appointmentId) {
            // If it's the only row, just clear it instead of removing
            if (rows.length === 1) {
                row.querySelectorAll('select, input').forEach(input => {
                    input.value = input.name?.includes('quantities') ? '1' : '';
                    delete input.dataset.appointmentId;
                });
            } else {
                row.remove();
            }
        }
    });

    updateCalculations();
}

// ==========================================
// BATCH MANAGEMENT
// ==========================================
function loadBatches(productSelect) {
    const row = productSelect.closest('.item-row');
    const batchSelect = row.querySelector('.batch-select');
    const batchInfo = row.querySelector('.batch-info');
    const priceInput = row.querySelector('input[name="product_prices[]"]');
    const productId = parseInt(productSelect.value);

    if (!productId) {
        batchSelect.innerHTML = '<option value="">Select Product</option>';
        batchSelect.disabled = true;
        batchInfo.innerHTML = '';
        return;
    }

    // Check cache first
    if (BillingState.batchCache[productId]) {
        populateBatchSelect(BillingState.batchCache[productId], batchSelect, batchInfo, priceInput);
        return;
    }

    // Load from API
    batchSelect.innerHTML = '<option value="">Loading...</option>';
    batchSelect.disabled = true;

    fetch(`/api/inventory/batches/for-product/${productId}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                const batches = data.batches || [];
                BillingState.batchCache[productId] = batches;
                populateBatchSelect(batches, batchSelect, batchInfo, priceInput);
            } else {
                throw new Error('Failed to load batches');
            }
        })
        .catch(err => {
            console.error('Error loading batches:', err);
            batchSelect.innerHTML = '<option value="">Error loading batches</option>';
            batchInfo.innerHTML = '<span class="text-danger">Failed to load batches</span>';
        });
}

function populateBatchSelect(batches, batchSelect, batchInfo, priceInput) {
    // Filter available batches and sort by expiry (FIFO)
    const availableBatches = batches
        .filter(b => b.qty_available > 0)
        .sort((a, b) => {
            if (!a.expiry_date) return 1;
            if (!b.expiry_date) return -1;
            return new Date(a.expiry_date) - new Date(b.expiry_date);
        });

    if (!availableBatches.length) {
        batchSelect.innerHTML = '<option value="">Out of Stock</option>';
        batchSelect.disabled = true;
        batchInfo.innerHTML = '<span class="text-danger">Out of stock</span>';
        return;
    }

    batchSelect.innerHTML = availableBatches.map((b, i) => 
        `<option value="${b.id}" data-price="${b.selling_price || b.unit_price || 0}" data-qty="${b.qty_available}" ${i === 0 ? 'selected' : ''}>
            ${b.batch_name} - ${b.qty_available} available
        </option>`
    ).join('');
    batchSelect.disabled = false;

    // Display first batch info
    const firstBatch = availableBatches[0];
    const expiry = firstBatch.expiry_date ? 
        new Date(firstBatch.expiry_date).toLocaleDateString() : 'No expiry';
    const expiryClass = firstBatch.is_near_expiry ? 'text-warning' : '';
    batchInfo.innerHTML = `<small>Avail: ${firstBatch.qty_available} | <span class="${expiryClass}">Exp: ${expiry}</span></small>`;

    // Set price from batch
    if (priceInput && (firstBatch.selling_price || firstBatch.unit_price)) {
        priceInput.value = parseFloat(firstBatch.selling_price || firstBatch.unit_price).toFixed(2);
    }

    // Update batch info on batch change
    batchSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const qty = selectedOption.dataset.qty;
        const price = selectedOption.dataset.price;
        const batch = availableBatches.find(b => b.id == this.value);

        if (batch) {
            const exp = batch.expiry_date ? new Date(batch.expiry_date).toLocaleDateString() : 'No expiry';
            const expClass = batch.is_near_expiry ? 'text-warning' : '';
            batchInfo.innerHTML = `<small>Avail: ${qty} | <span class="${expClass}">Exp: ${exp}</span></small>`;

            if (priceInput && price) {
                priceInput.value = parseFloat(price).toFixed(2);
            }
        }
        updateCalculations();
    });

    updateCalculations();
}

// ==========================================
// ROW MANAGEMENT
// ==========================================
function addServiceRow() {
    const container = document.getElementById('servicesContainer');
    const newRow = container.children[0].cloneNode(true);

    newRow.querySelectorAll('select, input').forEach(input => {
        input.value = input.name?.includes('quantities') ? '1' : '';
        input.classList.remove('is-invalid');
    });

    newRow.querySelector('.package-benefit')?.remove();
    newRow.querySelector('.btn-danger').style.display = 'block';

    container.appendChild(newRow);
}

function addProductRow() {
    const container = document.getElementById('productsContainer');
    const newRow = container.children[0].cloneNode(true);

    newRow.querySelectorAll('select, input').forEach(input => {
        input.value = input.name?.includes('quantities') ? '1' : '';
        input.classList.remove('is-invalid');
    });

    const batchSelect = newRow.querySelector('.batch-select');
    batchSelect.innerHTML = '<option value="">Select Product</option>';
    batchSelect.disabled = true;
    newRow.querySelector('.batch-info').innerHTML = '';
    newRow.querySelector('.btn-danger').style.display = 'block';

    container.appendChild(newRow);
}

function removeRow(button) {
    button.closest('.item-row').remove();
    updateCalculations();
}

// ==========================================
// CALCULATIONS
// ==========================================
function handleServiceChange(select) {
    select.classList.remove('is-invalid');
    updateCalculations();
}

function updateCalculations() {
    let servicesTotal = 0;
    let productsTotal = 0;
    let packageDeductions = 0;

    // Calculate services and check package benefits
    document.querySelectorAll('.service-row').forEach(row => {
        const select = row.querySelector('select[name="service_ids[]"]');
        const qty = parseFloat(row.querySelector('input[name="service_quantities[]"]')?.value) || 0;

        if (select?.value) {
            const price = parseFloat(select.selectedOptions[0]?.dataset.price) || 0;
            const serviceTotal = price * qty;
            servicesTotal += serviceTotal;

            // Check if this service is covered by customer packages
            const serviceId = parseInt(select.value);
            const packageBenefit = checkPackageBenefit(serviceId, serviceTotal, qty);

            if (packageBenefit > 0) {
                packageDeductions += packageBenefit;

                // Show package benefit indicator on the row
                let benefitDiv = row.querySelector('.package-benefit');
                if (!benefitDiv) {
                    benefitDiv = document.createElement('div');
                    benefitDiv.className = 'package-benefit';
                    row.appendChild(benefitDiv);
                }
                benefitDiv.innerHTML = `<i class="fas fa-gift"></i> Package Benefit: -₹${packageBenefit.toFixed(2)}`;
            } else {
                // Remove benefit indicator if no benefit
                row.querySelector('.package-benefit')?.remove();
            }
        }
    });

    // Calculate products
    document.querySelectorAll('.product-row').forEach(row => {
        const qty = parseFloat(row.querySelector('input[name="product_quantities[]"]')?.value) || 0;
        const price = parseFloat(row.querySelector('input[name="product_prices[]"]')?.value) || 0;
        productsTotal += qty * price;
    });

    const subtotal = servicesTotal + productsTotal;

    // Discount calculation
    const discountType = document.querySelector('select[name="discount_type"]')?.value || 'percentage';
    const discountValue = parseFloat(document.querySelector('input[name="discount_value"]')?.value) || 0;
    const discount = discountType === 'percentage' ? 
        (subtotal * discountValue / 100) : discountValue;

    // Apply package deductions first
    const afterPackages = Math.max(0, subtotal - packageDeductions);
    const afterDiscount = Math.max(0, afterPackages - discount);

    // Tax calculation
    const cgstRate = parseFloat(document.querySelector('input[name="cgst_rate"]')?.value) || 0;
    const sgstRate = parseFloat(document.querySelector('input[name="sgst_rate"]')?.value) || 0;
    const cgst = (afterDiscount * cgstRate) / 100;
    const sgst = (afterDiscount * sgstRate) / 100;

    // Additional charges
    const additionalCharges = parseFloat(document.querySelector('input[name="additional_charges"]')?.value) || 0;
    const tips = parseFloat(document.querySelector('input[name="tips_amount"]')?.value) || 0;

    const total = afterDiscount + cgst + sgst + additionalCharges + tips;

    // Update display
    document.getElementById('servicesSubtotal').textContent = `₹${servicesTotal.toFixed(2)}`;
    document.getElementById('productsSubtotal').textContent = `₹${productsTotal.toFixed(2)}`;
    document.getElementById('subtotalAmount').textContent = `₹${subtotal.toFixed(2)}`;
    document.getElementById('packageDeductions').textContent = `-₹${packageDeductions.toFixed(2)}`;
    document.getElementById('discountAmount').textContent = `-₹${discount.toFixed(2)}`;
    document.getElementById('cgstAmount').textContent = `₹${cgst.toFixed(2)}`;
    document.getElementById('sgstAmount').textContent = `₹${sgst.toFixed(2)}`;
    document.getElementById('additionalCharges').textContent = `₹${additionalCharges.toFixed(2)}`;
    document.getElementById('tipsDisplay').textContent = `₹${tips.toFixed(2)}`;
    document.getElementById('grandTotal').textContent = `₹${total.toFixed(2)}`;
}

function checkPackageBenefit(serviceId, servicePrice, quantity) {
    // Return 0 if no customer packages loaded
    if (!BillingState.customerPackages || !BillingState.customerPackages.packages) {
        return 0;
    }

    let totalBenefit = 0;

    // Check each package for this service
    for (const pkg of BillingState.customerPackages.packages) {
        if (pkg.package_type === 'membership') {
            // Check if membership covers this service
            const coveredServices = pkg.services || [];
            const isCovered = coveredServices.some(s => s.service_id === serviceId);

            if (isCovered) {
                // Membership covers full price
                return servicePrice;
            }
        } else if (pkg.package_type === 'service_package') {
            // Check if service package has remaining sessions for this service
            if (pkg.service_id === serviceId && pkg.remaining_sessions > 0) {
                // Calculate how many sessions can be covered
                const sessionsToCover = Math.min(quantity, pkg.remaining_sessions);
                const pricePerSession = servicePrice / quantity;
                totalBenefit += sessionsToCover * pricePerSession;
            }
        } else if (pkg.package_type === 'prepaid') {
            // Prepaid can cover any service up to remaining credit
            const deduction = Math.min(servicePrice, pkg.remaining_credit || 0);
            totalBenefit += deduction;
        }
    }

    return totalBenefit;
}

// ==========================================
// VALIDATION
// ==========================================
function validateForm() {
    let isValid = true;
    const errors = [];

    // Customer
    const client = document.getElementById('client_id');
    if (!client.value) {
        client.classList.add('is-invalid');
        errors.push('Select a customer');
        isValid = false;
    }

    // Services
    let hasItems = false;
    document.querySelectorAll('.service-row').forEach((row, i) => {
        const service = row.querySelector('select[name="service_ids[]"]');
        const staff = row.querySelector('select[name="staff_ids[]"]');

        if (service?.value) {
            hasItems = true;
            if (!staff?.value) {
                staff.classList.add('is-invalid');
                errors.push(`Service #${i + 1}: Staff required`);
                isValid = false;
            }
        }
    });

    // Products
    document.querySelectorAll('.product-row').forEach((row, i) => {
        const product = row.querySelector('select[name="product_ids[]"]');
        const batch = row.querySelector('.batch-select');
        const staff = row.querySelector('select[name="product_staff_ids[]"]');

        if (product?.value) {
            hasItems = true;
            if (!batch?.value) {
                batch.classList.add('is-invalid');
                errors.push(`Product #${i + 1}: Batch required`);
                isValid = false;
            }
            if (!staff?.value) {
                staff.classList.add('is-invalid');
                errors.push(`Product #${i + 1}: Staff required`);
                isValid = false;
            }
        }
    });

    if (!hasItems) {
        errors.push('Add at least one service or product');
        isValid = false;
    }

    // Payment method
    const payment = document.querySelector('select[name="payment_method"]');
    if (!payment?.value) {
        payment.classList.add('is-invalid');
        errors.push('Payment method required');
        isValid = false;
    }

    if (!isValid) {
        showNotification(errors.join('\n'), 'danger');
        // Scroll to first error
        document.querySelector('.is-invalid')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    return isValid;
}

function setupInputValidation() {
    document.getElementById('billingForm').addEventListener('input', function(e) {
        if (e.target.matches('select, input')) {
            e.target.classList.remove('is-invalid');
        }
    });
}

// ==========================================
// FORM SUBMISSION
// ==========================================
function handleFormSubmit(e) {
    e.preventDefault();

    if (!validateForm() || BillingState.isSubmitting) {
        return;
    }

    BillingState.isSubmitting = true;
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.classList.add('btn-loading');

    const formData = new FormData(e.target);

    fetch('/integrated-billing/create-professional', {
        method: 'POST',
        body: formData
    })
    .then(res => {
        if (!res.ok) {
            return res.text().then(text => {
                throw new Error(`Server error: ${res.status}`);
            });
        }
        return res.json();
    })
    .then(data => {
        if (data.success) {
            // Build success message for toast
            let toastMessage = `✅ Bill Saved Successfully!\n\n`;
            toastMessage += `📋 Invoice Number: ${data.invoice_number}\n`;
            toastMessage += `💰 Total Amount: ₹${data.total_amount.toFixed(2)}\n\n`;

            if (data.service_items_created > 0) {
                toastMessage += `✓ ${data.service_items_created} service(s) billed\n`;
            }
            if (data.inventory_items_created > 0) {
                toastMessage += `✓ ${data.inventory_items_created} product(s) billed\n`;
            }
            if (data.appointments_completed > 0) {
                toastMessage += `✓ ${data.appointments_completed} appointment(s) completed\n`;
            }
            if (data.package_deductions_applied > 0) {
                toastMessage += `✓ ${data.package_deductions_applied} package benefit(s) applied\n`;
            }

            // Show success toast
            showNotification(toastMessage, 'success', 8000);

            // Refresh package display if packages were updated
            if (data.updated_packages && data.updated_packages.length > 0) {
                const customerId = document.getElementById('client_id').value;
                if (customerId) {
                    refreshCustomerPackages(customerId, data.updated_packages);
                }
            }

            // Handle print if needed
            if (window.printAfterSave && data.invoice_id) {
                window.open(`/integrated-billing/print-invoice/${data.invoice_id}`, '_blank');
            }

            // Redirect to invoice detail
            setTimeout(() => {
                window.location.href = `/integrated-billing/invoice/${data.invoice_id}`;
            }, 2000);
        } else {
            throw new Error(data.message || 'Failed to create invoice');
        }
    })
    .catch(err => {
        BillingState.isSubmitting = false;
        btn.disabled = false;
        btn.classList.remove('btn-loading');

        // Show error toast
        const errorMessage = err.message || 'Failed to save invoice. Please try again.';
        showNotification(`❌ Error: ${errorMessage}`, 'error', 6000);

        console.error('Submission error:', err);
    });
}

function saveAndPrint() {
    if (!validateForm()) return;
    window.printAfterSave = true;
    document.getElementById('billingForm').dispatchEvent(new Event('submit'));
}

function previewInvoice() {
    if (!validateForm()) return;

    // Gather form data
    const formData = new FormData(document.getElementById('billingForm'));

    // Convert to JSON for preview endpoint
    const previewData = {
        client_id: parseInt(formData.get('client_id')),
        services: [],
        products: [],
        cgst_rate: parseFloat(formData.get('cgst_rate') || 0),
        sgst_rate: parseFloat(formData.get('sgst_rate') || 0),
        discount_type: formData.get('discount_type'),
        discount_value: parseFloat(formData.get('discount_value') || 0),
        additional_charges: parseFloat(formData.get('additional_charges') || 0),
        tips_amount: parseFloat(formData.get('tips_amount') || 0)
    };

    // Collect services
    const serviceIds = formData.getAll('service_ids[]');
    const serviceQtys = formData.getAll('service_quantities[]');
    serviceIds.forEach((id, i) => {
        if (id) {
            previewData.services.push({
                service_id: parseInt(id),
                quantity: parseFloat(serviceQtys[i] || 1)
            });
        }
    });

    // Collect products
    const productIds = formData.getAll('product_ids[]');
    const productQtys = formData.getAll('product_quantities[]');
    const productPrices = formData.getAll('product_prices[]');
    productIds.forEach((id, i) => {
        if (id) {
            previewData.products.push({
                product_id: parseInt(id),
                quantity: parseFloat(productQtys[i] || 1),
                unit_price: parseFloat(productPrices[i] || 0)
            });
        }
    });

    // Call preview API
    fetch('/integrated-billing/preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(previewData)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success && data.preview_html) {
            // Show preview in modal
            showPreviewModal(data.preview_html);
        } else {
            throw new Error('Preview generation failed');
        }
    })
    .catch(err => {
        console.error('Preview error:', err);
        showNotification('Preview feature is currently unavailable', 'warning');
    });
}

function showPreviewModal(html) {
    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Invoice Preview</h5>
                    <button type="button" class="btn-close" onclick="this.closest('.modal').remove()"></button>
                </div>
                <div class="modal-body">
                    ${html}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// ==========================================
// UTILITIES
// ==========================================
function showNotification(message, type = 'info') {
    const alertClass = {
        success: 'alert-success',
        danger: 'alert-danger',
        warning: 'alert-warning',
        info: 'alert-info'
    }[type] || 'alert-info';

    const notification = document.createElement('div');
    notification.className = `toast-notification alert ${alertClass}`;
    notification.innerHTML = `
        <div style="white-space: pre-line;">${message}</div>
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => notification.remove(), 5000);
}
</script>
{% endblock %}