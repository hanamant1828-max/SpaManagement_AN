{% extends "base.html" %}

{% block title %}Integrated Billing & Service Management{% endblock %}

{% block extra_head %}
<style>
.billing-card {
    transition: all 0.3s ease;
}
.billing-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.package-deduction {
    color: #28a745;
    font-weight: 500;
}
.extra-charge {
    color: #dc3545;
    font-weight: 500;
}
.item-row {
    border-left: 3px solid transparent;
    padding-left: 10px;
    margin-bottom: 5px;
}
.item-row.package-item {
    border-left-color: #28a745;
    background-color: rgba(40, 167, 69, 0.1);
}
.item-row.extra-item {
    border-left-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.1);
}
.batch-info {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 2px;
}
.batch-warning {
    color: #dc3545;
    font-weight: 500;
}
.batch-success {
    color: #28a745;
    font-weight: 500;
}
.product-row {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-cash-register me-2 text-primary"></i>Integrated Billing & Service Management
            </h1>
            <p class="text-muted">Complete billing solution with package deductions, subscription management, and batch-wise inventory sales</p>
        </div>
    </div>

    <!-- Dashboard Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card billing-card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Today's Revenue
                            </div>
                            <div class="h5 mb-0 font-weight-bold">₹{{ "{:,.2f}".format(today_revenue) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card billing-card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Revenue
                            </div>
                            <div class="h5 mb-0 font-weight-bold">₹{{ "{:,.2f}".format(total_revenue) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card billing-card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pending Amount
                            </div>
                            <div class="h5 mb-0 font-weight-bold">₹{{ "{:,.2f}".format(pending_amount) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- New Invoice Creation -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-plus-circle me-2"></i>Create New Invoice
                    </h6>
                    <span class="badge badge-info">Services • Packages • Batch-wise Inventory</span>
                </div>
                <div class="card-body">
                    <form id="billingForm">
                        <!-- Customer Selection -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="client_id" class="form-label">Customer</label>
                                <select class="form-select" id="client_id" name="client_id" required>
                                    <option value="">Select Customer</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}" {{ 'selected' if selected_customer and customer.id == selected_customer.id else '' }}>{{ customer.full_name }} - {{ customer.phone }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Customer Packages</label>
                                <div id="customerPackages" class="alert alert-info">
                                    <small>Select a customer to view their active packages</small>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Services History Section -->
                        {% if selected_customer %}
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-user me-2"></i>{{ selected_customer.full_name }}'s Current Bookings
                                            <span class="badge bg-primary text-white ms-2">{{ customer_appointments|length }} Ready to Bill</span>
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        {% if customer_services %}
                                        <div class="alert alert-success">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <strong>{{ customer_services|length }} Different Services Found</strong> - Ready to add to bill
                                        </div>
                                        <h6 class="text-primary mb-3">Available Services for Billing:</h6>
                                        <div class="row">
                                            {% for service in customer_services %}
                                            <div class="col-md-4 mb-2">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-spa text-success me-2"></i>
                                                    <span class="fw-bold">{{ service.name }}</span>
                                                    <span class="text-muted ms-2">₹{{ "{:,.2f}".format(service.price) }}</span>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}

                                        {% if customer_appointments %}
                                        <hr>
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="text-success mb-0">
                                                <i class="fas fa-clock me-1"></i>All Confirmed Bookings Ready for Billing
                                            </h6>
                                            <div class="badge bg-success fs-6">{{ customer_appointments|length }} Bookings Found</div>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            These are all the confirmed/scheduled appointments for <strong>{{ selected_customer.full_name }}</strong> that can be billed.
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-success">
                                                    <tr>
                                                        <th>Date & Time</th>
                                                        <th>Service</th>
                                                        <th>Staff</th>
                                                        <th>Status</th>
                                                        <th>Amount</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for appointment in customer_appointments %}
                                                    <tr class="bg-light">
                                                        <td>
                                                            <strong>
                                                                {% if appointment.appointment_date.strftime is defined %}
                                                                    {{ appointment.appointment_date.strftime('%d %b %Y') }}
                                                                {% else %}
                                                                    {{ appointment.appointment_date }}
                                                                {% endif %}
                                                            </strong><br>
                                                            <small class="text-muted">
                                                                {% if appointment.start_time and appointment.start_time.strftime is defined %}
                                                                    {{ appointment.start_time.strftime('%I:%M %p') }}
                                                                {% else %}
                                                                    {{ appointment.start_time if appointment.start_time else 'N/A' }}
                                                                {% endif %}
                                                                -
                                                                {% if appointment.end_time and appointment.end_time.strftime is defined %}
                                                                    {{ appointment.end_time.strftime('%I:%M %p') }}
                                                                {% else %}
                                                                    {{ appointment.end_time if appointment.end_time else 'N/A' }}
                                                                {% endif %}
                                                            </small>
                                                        </td>
                                                        <td>
                                                            <strong>{{ appointment.service_name if appointment.service_name else 'N/A' }}</strong><br>
                                                            <small class="text-muted">{{ appointment.service_duration if appointment.service_duration else '0' }} mins</small>
                                                        </td>
                                                        <td>{{ appointment.staff_name if appointment.staff_name else 'N/A' }}</td>
                                                        <td>
                                                            <span class="badge badge-warning">
                                                                {{ appointment.status.title() }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <strong class="text-success">₹{{ "{:,.2f}".format(appointment.service_price) if appointment.service_price else '0.00' }}</strong>
                                                        </td>
                                                        <td>
                                                            <button type="button" class="btn btn-success btn-sm" onclick="addUnakiAppointmentToBill({{ appointment.id }}, '{{ appointment.service_name if appointment.service_name else '' }}', {{ appointment.service_price if appointment.service_price else 0 }}, {{ appointment.service_duration if appointment.service_duration else 60 }})">
                                                                <i class="fas fa-plus me-1"></i>Add to Bill
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>No ready-to-bill bookings found.</strong> This customer has no scheduled or confirmed appointments ready for billing.
                                        </div>
                                        {% endif %}

                                        <div class="mt-3">
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="autoFillCurrentServices()">
                                                <i class="fas fa-bolt me-1"></i>Auto-Fill ALL Bookings to Bill
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="viewFullCustomerHistory()">
                                                <i class="fas fa-history me-1"></i>View Full Customer History
                                            </button>
                                            <small class="text-muted d-block mt-1">
                                                <i class="fas fa-lightbulb me-1"></i>
                                                Auto-Fill will add all {{ customer_appointments|length }} confirmed bookings to your billing form instantly
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Services Section -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-spa me-2"></i>Services
                                <small class="text-muted">(Package deductions will be applied automatically)</small>
                            </h6>
                            <div id="servicesContainer">
                                <div class="service-row row mb-2">
                                    <div class="col-md-5">
                                        <select class="form-select" name="service_ids[]" onchange="handleServiceSelection(this)">
                                            <option value="">Select Service</option>
                                            {% for service in services %}
                                            <option value="{{ service.id }}" data-price="{{ service.price }}">
                                                {{ service.name }} - ₹{{ "{:,.2f}".format(service.price) }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" name="service_quantities[]" placeholder="Qty" min="1" value="1" step="0.5">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control" name="appointment_ids[]" placeholder="Appointment ID (Optional)">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-success btn-sm" onclick="addServiceRow()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Products & Inventory Section (Batch-wise) -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-shopping-bag me-2"></i>Products & Inventory 
                                <small class="text-muted">(Stock will be automatically reduced from batches - FIFO by expiry)</small>
                            </h6>
                            <div id="productsContainer">
                                <div class="product-row">
                                    <div class="row mb-2">
                                        <div class="col-md-4">
                                            <label class="form-label">Product</label>
                                            <select class="form-select product-select" name="product_ids[]" onchange="loadBatchesForProduct(this)">
                                                <option value="">Select Product</option>
                                                {% for product in inventory_items %}
                                                <option value="{{ product.id }}" data-name="{{ product.name }}">{{ product.name }} (Total Stock: {{ product.total_stock }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Batch (Auto-selected FIFO)</label>
                                            <select class="form-select batch-select" name="batch_ids[]" disabled>
                                                <option value="">Select Product First</option>
                                            </select>
                                            <div class="batch-info"></div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Quantity</label>
                                            <input type="number" class="form-control quantity-input" name="product_quantities[]" value="1" min="0.1" step="0.1" onchange="validateInventoryQuantity(this)">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Unit Price</label>
                                            <input type="number" class="form-control unit-price" name="product_prices[]" placeholder="Price" step="0.01" min="0" required>
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-success btn-sm w-100" onclick="addProductRow()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Tax & Billing Section -->
                        <div class="card mb-4 border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Professional Tax & Billing Calculations</h6>
                            </div>
                            <div class="card-body">
                                <!-- Tax Configuration -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="cgst_rate" class="form-label">CGST Rate (%)</label>
                                        <input type="number" class="form-control tax-input" id="cgst_rate" name="cgst_rate" value="9" step="0.01" min="0" max="50">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="sgst_rate" class="form-label">SGST Rate (%)</label>
                                        <input type="number" class="form-control tax-input" id="sgst_rate" name="sgst_rate" value="9" step="0.01" min="0" max="50">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="igst_rate" class="form-label">IGST Rate (%) <small class="text-muted">Interstate</small></label>
                                        <input type="number" class="form-control tax-input" id="igst_rate" name="igst_rate" value="0" step="0.01" min="0" max="50">
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="is_interstate" name="is_interstate">
                                            <label class="form-label" for="is_interstate">
                                                Interstate Transaction
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Discount and Additional Charges -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="discount_type" class="form-label">Discount Type</label>
                                        <select class="form-select billing-input" id="discount_type" name="discount_type">
                                            <option value="amount">Amount (₹)</option>
                                            <option value="percentage">Percentage (%)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="discount_value" class="form-label">Discount Value</label>
                                        <input type="number" class="form-control billing-input" id="discount_value" name="discount_value" value="0" step="0.01" min="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="additional_charges" class="form-label">Additional Charges (₹)</label>
                                        <input type="number" class="form-control billing-input" id="additional_charges" name="additional_charges" value="0" step="0.01" min="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="tips_amount" class="form-label">Tips (₹)</label>
                                        <input type="number" class="form-control billing-input" id="tips_amount" name="tips_amount" value="0" step="0.01" min="0">
                                    </div>
                                </div>

                                <!-- Live Tax Calculation Display -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card bg-light border-2 border-primary">
                                            <div class="card-header bg-primary text-white text-center">
                                                <h6 class="mb-0"><i class="fas fa-rupee-sign me-2"></i>Live Billing Calculation</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row text-center">
                                                    <div class="col-md-2">
                                                        <div class="border-end pe-3">
                                                            <h6 class="text-muted mb-1 fw-bold">Subtotal</h6>
                                                            <h4 class="mb-0 text-primary fw-bold" id="display_subtotal">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end pe-3">
                                                            <h6 class="text-muted mb-1 fw-bold">Discount</h6>
                                                            <h4 class="mb-0 text-danger fw-bold" id="display_discount">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end pe-3">
                                                            <h6 class="text-muted mb-1 fw-bold">CGST</h6>
                                                            <h4 class="mb-0 text-info fw-bold" id="display_cgst">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end pe-3">
                                                            <h6 class="text-muted mb-1 fw-bold">SGST</h6>
                                                            <h4 class="mb-0 text-info fw-bold" id="display_sgst">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end pe-3">
                                                            <h6 class="text-muted mb-1 fw-bold">Additional</h6>
                                                            <h4 class="mb-0 text-warning fw-bold" id="display_additional">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="ps-3">
                                                            <h6 class="text-muted mb-1 fw-bold">FINAL TOTAL</h6>
                                                            <h3 class="mb-0 text-success fw-bold bg-light p-2 rounded border" id="display_total">₹0.00</h3>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Tax Summary Row -->
                                                <div class="row mt-3 pt-3 border-top">
                                                    <div class="col-md-4">
                                                        <small class="text-muted">
                                                            <strong>Tax Type:</strong> <span id="tax_type_display">Intrastate (CGST + SGST)</span>
                                                        </small>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <small class="text-muted">
                                                            <strong>Total Tax:</strong> <span id="total_tax_display" class="text-info fw-bold">₹0.00</span>
                                                        </small>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <small class="text-muted">
                                                            <strong>Tax %:</strong> <span id="tax_percentage_display" class="text-info fw-bold">18.00%</span>
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Additional notes for this invoice"></textarea>
                        </div>

                        <!-- Payment Processing Section -->
                        <div class="card mb-4 border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Processing</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="payment_terms" class="form-label">Payment Terms</label>
                                        <select class="form-select" id="payment_terms" name="payment_terms">
                                            <option value="immediate">Immediate</option>
                                            <option value="net_15">Net 15 Days</option>
                                            <option value="net_30">Net 30 Days</option>
                                            <option value="advance">Advance Payment</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="payment_method" class="form-label">Primary Payment Method</label>
                                        <select class="form-select" id="payment_method" name="payment_method">
                                            <option value="cash">Cash</option>
                                            <option value="card">Credit/Debit Card</option>
                                            <option value="upi">UPI Payment</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="cheque">Cheque</option>
                                            <option value="mixed">Multiple Methods</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Multi-payment method section (hidden by default) -->
                                <div id="multiPaymentSection" class="mt-3" style="display: none;">
                                    <h6>Split Payment Methods:</h6>
                                    <div id="paymentMethodsContainer">
                                        <!-- Dynamic payment method rows will be added here -->
                                    </div>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="addPaymentMethod()">
                                        <i class="fas fa-plus me-1"></i>Add Payment Method
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Action Buttons -->
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-primary btn-lg w-100 mb-2" onclick="previewInvoice()">
                                    <i class="fas fa-eye me-2"></i>Preview Invoice
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-success btn-lg w-100 mb-2">
                                    <i class="fas fa-file-invoice-dollar me-2"></i>Generate Professional Invoice
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-info w-100" onclick="saveAsDraft()" id="saveDraftBtn">
                                    <i class="fas fa-save me-2"></i>Save as Draft
                                </button>
                                <div id="draftSaveStatus"></div>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-warning w-100" onclick="sendQuotation()">
                                    <i class="fas fa-paper-plane me-2"></i>Send Quotation
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-secondary w-100" onclick="clearForm()">
                                    <i class="fas fa-undo me-2"></i>Clear Form
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Removed Recent Invoices Section -->

    </div>
</div>

<!-- Professional Invoice Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">Invoice Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="viewInvoiceBtn" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-eye me-2"></i>View Invoice
                </a>
                <button type="button" id="printInvoiceBtn" class="btn btn-info" style="display: none;" onclick="printInvoice()">
                    <i class="fas fa-print me-2"></i>Print Invoice
                </button>
                <button type="button" id="emailInvoiceBtn" class="btn btn-success" style="display: none;" onclick="emailInvoice()">
                    <i class="fas fa-envelope me-2"></i>Email Invoice
                </button>
                <button type="button" id="whatsappInvoiceBtn" class="btn btn-warning" style="display: none;" onclick="whatsappInvoice()">
                    <i class="fab fa-whatsapp me-2"></i>WhatsApp Invoice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Professional Invoice Preview Modal -->
<div class="modal fade" id="invoicePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Professional Invoice Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoicePreviewBody" style="min-height: 600px;">
                <!-- Professional invoice preview will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="proceedWithInvoiceCreation()">
                    <i class="fas fa-check me-2"></i>Proceed with Invoice Creation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
var availableBatches = []; // Global array to hold all available batches

// CRITICAL: Define addUnakiAppointmentToBill function FIRST for immediate availability
function addUnakiAppointmentToBill(appointmentId, serviceName, servicePrice, serviceDuration) {
    console.log('Adding Unaki appointment to bill:', appointmentId, serviceName, servicePrice, serviceDuration);

    try {
        // Ensure servicePrice is a number
        servicePrice = parseFloat(servicePrice) || 0;

        // Find the first empty service row or add a new one
        let targetRow = findEmptyServiceRow();
        if (!targetRow) {
            if (typeof addServiceRow === 'function') {
                addServiceRow();
                targetRow = findEmptyServiceRow();
            } else {
                throw new Error('Cannot add new service row - addServiceRow function not available');
            }
        }

        // Fill the row with Unaki appointment data
        if (targetRow) {
            const serviceSelect = targetRow.querySelector('select[name="service_ids[]"]');
            const quantityInput = targetRow.querySelector('input[name="service_quantities[]"]');
            const appointmentInput = targetRow.querySelector('input[name="appointment_ids[]"]');

            if (!serviceSelect || !quantityInput || !appointmentInput) {
                throw new Error('Required form elements not found in service row');
            }

            // Try to find matching service by name
            let matchedServiceId = null;
            let finalServicePrice = servicePrice;

            // Look through all service options to find a match
            for (let option of serviceSelect.options) {
                if (option.value && option.text.toLowerCase().includes(serviceName.toLowerCase())) {
                    matchedServiceId = option.value;

                    // Get the actual price from the service option
                    const priceMatch = option.text.match(/₹([\d,]+\.?\d*)/);
                    if (priceMatch) {
                        const systemPrice = parseFloat(priceMatch[1].replace(/,/g, ''));
                        finalServicePrice = systemPrice > 0 ? systemPrice : servicePrice;
                    }
                    break;
                }
            }

            if (matchedServiceId) {
                serviceSelect.value = matchedServiceId;
                quantityInput.value = '1';
                appointmentInput.value = `unaki_${appointmentId}`;

                // Trigger change event to update calculations
                setTimeout(() => {
                    serviceSelect.dispatchEvent(new Event('change', { bubbles: true }));
                    quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
                    calculateTotals();
                }, 200);

                // Show success message
                showNotification(`Added Unaki booking: ${serviceName} (₹${finalServicePrice}) to bill successfully!`, 'success');
            } else {
                console.warn(`No matching service found for: ${serviceName}`);

                // Fill quantity and appointment ID anyway
                quantityInput.value = '1';
                appointmentInput.value = `unaki_${appointmentId}`;

                // Add warning indicator
                let indicator = targetRow.querySelector('.unaki-indicator');
                if (!indicator) {
                    indicator = document.createElement('small');
                    indicator.className = 'unaki-indicator text-warning fw-bold d-block';
                    indicator.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i>Service not found: ${serviceName}`;
                    targetRow.appendChild(indicator);
                }

                // Show a notification for the user
                showNotification(`Could not find a matching service for "${serviceName}". Please select manually.`, 'warning');
            }
        } else {
            throw new Error('No service row available for adding appointment');
        }
    } catch (error) {
        console.error('Error adding Unaki appointment to bill:', error);
        showNotification(`Error adding appointment to bill: ${error.message}`, 'error');
    }
}

// Show notification function
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    `;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Define helper functions first
function findEmptyServiceRow() {
    const serviceRows = document.querySelectorAll('.service-row');
    for (let row of serviceRows) {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        if (!serviceSelect.value) {
            return row;
        }
    }
    return null;
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    `;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// CRITICAL: Define addUnakiAppointmentToBill function with ALL dependencies
function addUnakiAppointmentToBill(appointmentId, serviceName, servicePrice, serviceDuration) {
    console.log('Adding Unaki appointment to bill:', appointmentId, serviceName, servicePrice, serviceDuration);

    try {
        // Ensure servicePrice is a number
        servicePrice = parseFloat(servicePrice) || 0;

        // Find the first empty service row or add a new one
        let targetRow = findEmptyServiceRow();
        if (!targetRow) {
            if (typeof addServiceRow === 'function') {
                addServiceRow();
                targetRow = findEmptyServiceRow();
            } else {
                throw new Error('Cannot add new service row - addServiceRow function not available');
            }
        }

        // Fill the row with Unaki appointment data
        if (targetRow) {
            const serviceSelect = targetRow.querySelector('select[name="service_ids[]"]');
            const quantityInput = targetRow.querySelector('input[name="service_quantities[]"]');
            const appointmentInput = targetRow.querySelector('input[name="appointment_ids[]"]');

            if (!serviceSelect || !quantityInput || !appointmentInput) {
                throw new Error('Required form elements not found in service row');
            }

            // Try to find matching service by name
            let matchedServiceId = null;
            let finalServicePrice = servicePrice;

            // Look through all service options to find a match
            for (let option of serviceSelect.options) {
                if (option.value && option.text.toLowerCase().includes(serviceName.toLowerCase())) {
                    matchedServiceId = option.value;

                    // Get the actual price from the service option
                    const priceMatch = option.text.match(/₹([\d,]+\.?\d*)/);
                    if (priceMatch) {
                        const systemPrice = parseFloat(priceMatch[1].replace(/,/g, ''));
                        finalServicePrice = systemPrice > 0 ? systemPrice : servicePrice;
                    }
                    break;
                }
            }

            if (matchedServiceId) {
                serviceSelect.value = matchedServiceId;
                quantityInput.value = '1';
                appointmentInput.value = `unaki_${appointmentId}`;

                // CRITICAL: Ensure the selected option has the price data
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                if (selectedOption) {
                    selectedOption.dataset.price = finalServicePrice.toString();
                    console.log(`Set service price data: ${serviceName} = ₹${finalServicePrice}`);
                }

                // Highlight the row
                targetRow.style.borderLeft = '4px solid #007bff';
                targetRow.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';

                // Add visual indicator
                let indicator = targetRow.querySelector('.unaki-indicator');
                if (!indicator) {
                    indicator = document.createElement('small');
                    indicator.className = 'unaki-indicator text-info fw-bold d-block';
                    indicator.innerHTML = '<i class="fas fa-calendar-check me-1"></i>Unaki Booking';
                    targetRow.appendChild(indicator);
                }

                // Trigger service selection change event
                if (typeof handleServiceSelection === 'function') {
                    handleServiceSelection(serviceSelect);
                }

                // Force recalculation after a small delay to ensure DOM updates
                setTimeout(() => {
                    console.log(`Triggering calculation update for ${serviceName} at ₹${finalServicePrice}`);
                    if (typeof updateTaxCalculations === 'function') {
                        updateTaxCalculations();
                    }
                }, 200);

                // Show success message
                showNotification(`Added Unaki booking: ${serviceName} (₹${finalServicePrice}) to bill successfully!`, 'success');
            } else {
                console.warn(`No matching service found for: ${serviceName}`);

                // Fill quantity and appointment ID anyway
                quantityInput.value = '1';
                appointmentInput.value = `unaki_${appointmentId}`;

                // Add warning indicator
                let indicator = targetRow.querySelector('.unaki-indicator');
                if (!indicator) {
                    indicator = document.createElement('small');
                    indicator.className = 'unaki-indicator text-warning fw-bold d-block';
                    indicator.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i>Service not found: ${serviceName}`;
                    targetRow.appendChild(indicator);
                }

                // Show a notification for the user
                showNotification(`Could not find a matching service for "${serviceName}". Please select manually.`, 'warning');
            }
        } else {
            throw new Error('No service row available for adding appointment');
        }
    } catch (error) {
        console.error('Error adding Unaki appointment to bill:', error);
        showNotification(`Error adding appointment to bill: ${error.message}`, 'error');
    }
}

// Make functions globally available IMMEDIATELY at script load
window.addUnakiAppointmentToBill = addUnakiAppointmentToBill;
window.findEmptyServiceRow = findEmptyServiceRow;

// Additional safety: Ensure functions are available on DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // Double-check and re-assign functions to ensure they're available
    if (typeof window.addUnakiAppointmentToBill !== 'function') {
        window.addUnakiAppointmentToBill = addUnakiAppointmentToBill;
        console.log('Re-assigned addUnakiAppointmentToBill function');
    }
    if (typeof window.findEmptyServiceRow !== 'function') {
        window.findEmptyServiceRow = findEmptyServiceRow;
        console.log('Re-assigned findEmptyServiceRow function');
    }
    console.log('All billing functions confirmed available');
});

// Show notification function
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    `;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Debug: Check if services are loaded in template
document.addEventListener('DOMContentLoaded', function() {
    const serviceSelects = document.querySelectorAll('select[name="service_ids[]"]');
    serviceSelects.forEach((select, index) => {
        console.log(`Service select ${index + 1} has ${select.options.length - 1} services loaded`);
        if (select.options.length <= 1) {
            console.error('Services dropdown is empty! Check backend data loading.');
        }
    });

    // Add customer selection change handler
    const customerSelect = document.getElementById('client_id');
    if (customerSelect) {
        customerSelect.addEventListener('change', function() {
            const selectedCustomerId = this.value;

            // Get current customer ID from URL to prevent unnecessary redirects
            const currentPath = window.location.pathname;
            const currentCustomerId = currentPath.match(/\/integrated-billing\/(\d+)$/)?.[1];

            if (selectedCustomerId) {
                // Only redirect if the selected customer is different from current
                if (selectedCustomerId !== currentCustomerId) {
                    window.location.href = `/integrated-billing/${selectedCustomerId}`;
                }
            } else {
                // Only redirect if we're currently viewing a specific customer
                if (currentCustomerId) {
                    window.location.href = '/integrated-billing';
                }
            }
        });
    }
});

// Add service row
function addServiceRow() {
    const container = document.getElementById('servicesContainer');
    if (!container) {
        console.error('Services container not found');
        return;
    }

    const firstRow = container.children[0];
    if (!firstRow) {
        console.error('No service rows found to clone');
        return;
    }

    const newRow = firstRow.cloneNode(true);

    // Clear values
    newRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
    });

    // Change button to remove
    const button = newRow.querySelector('button');
    if (button) {
        button.className = 'btn btn-danger btn-sm';
        button.innerHTML = '<i class="fas fa-minus"></i>';
        button.onclick = function() { 
            this.closest('.service-row').remove(); 
            updateTaxCalculations(); 
        };
    }

    container.appendChild(newRow);
    return newRow;
}

// Function to add appointment directly to billing
        function addAppointmentToBill(appointmentId, serviceName, serviceId, servicePrice) {
            console.log('Adding appointment to bill:', appointmentId, serviceName, serviceId, servicePrice);

            // Find the first empty service row or add a new one
            const serviceRows = document.querySelectorAll('.service-row');
            let targetRow = null;

            // Look for empty row
            for (let row of serviceRows) {
                const serviceSelect = row.querySelector('select[name="service_ids[]"]');
                if (!serviceSelect.value) {
                    targetRow = row;
                    break;
                }
            }

            // If no empty row found, add new one
            if (!targetRow) {
                addServiceRow();
                const allRows = document.querySelectorAll('.service-row');
                targetRow = allRows[allRows.length - 1];
            }

            // Fill the row with appointment data
            if (targetRow && serviceId) {
                const serviceSelect = targetRow.querySelector('select[name="service_ids[]"]');
                const quantityInput = targetRow.querySelector('input[name="service_quantities[]"]');
                const appointmentInput = targetRow.querySelector('input[name="appointment_ids[]"]');

                serviceSelect.value = serviceId;
                quantityInput.value = '1';
                appointmentInput.value = appointmentId;

                // Highlight the row
                targetRow.style.borderLeft = '4px solid #28a745';
                targetRow.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';

                // Update calculations
                updateTaxCalculations();

                // Show success message
                showNotification(`Added ${serviceName} to bill successfully!`, 'success');
            }
        }

        // Additional helper function definitions that were removed
        console.log('All required functions have been defined and made globally available');

        // Preview invoice function
        function previewInvoice() {
            console.log('Generating invoice preview...');

            // Validate form first
            const clientSelect = document.getElementById('client_id');
            if (!clientSelect || !clientSelect.value) {
                showNotification('Please select a customer first', 'warning');
                return;
            }

            // Check if there are any services or products
            const serviceRows = document.querySelectorAll('.service-row');
            const productRows = document.querySelectorAll('.product-row');

            let hasServices = false;
            let hasProducts = false;

            serviceRows.forEach(row => {
                const serviceSelect = row.querySelector('select[name="service_ids[]"]');
                if (serviceSelect && serviceSelect.value) {
                    hasServices = true;
                }
            });

            productRows.forEach(row => {
                const productSelect = row.querySelector('select[name="product_ids[]"]');
                if (productSelect && productSelect.value) {
                    hasProducts = true;
                }
            });

            if (!hasServices && !hasProducts) {
                showNotification('Please add at least one service or product to preview', 'warning');
                return;
            }

            // Generate preview data
            const customerName = clientSelect.options[clientSelect.selectedIndex].text;
            const totalAmount = document.getElementById('display_total').textContent;

            // Create preview modal content
            const previewModal = document.getElementById('invoicePreviewModal');
            const previewBody = document.getElementById('invoicePreviewBody');

            if (previewModal && previewBody) {
                previewBody.innerHTML = `
                    <div class="invoice-preview">
                        <div class="text-center mb-4">
                            <h3>INVOICE PREVIEW</h3>
                            <p class="text-muted">Spa Management System</p>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Customer:</strong> ${customerName}
                            </div>
                            <div class="col-md-6 text-end">
                                <strong>Total Amount:</strong> ${totalAmount}
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            This is a preview. Click "Proceed with Invoice Creation" to generate the actual invoice.
                        </div>
                    </div>
                `;

                // Show the modal
                const modal = new bootstrap.Modal(previewModal);
                modal.show();
            } else {
                showNotification('Preview modal not found', 'error');
            }
        }

        // Proceed with invoice creation
        function proceedWithInvoiceCreation() {
            console.log('Proceeding with invoice creation...');

            // Close preview modal
            const previewModal = bootstrap.Modal.getInstance(document.getElementById('invoicePreviewModal'));
            if (previewModal) {
                previewModal.hide();
            }

            // Submit the billing form
            const billingForm = document.getElementById('billingForm');
            if (billingForm) {
                // Set form action to professional invoice creation
                billingForm.action = '/integrated-billing/create-professional';
                billingForm.method = 'POST';
                billingForm.submit();
            }
        }

        // Save as draft function
        function saveAsDraft() {
            console.log('Saving invoice as draft...');
            showNotification('Draft functionality coming soon!', 'info');
        }

        // Send quotation function
        function sendQuotation() {
            console.log('Sending quotation...');
            showNotification('Quotation functionality coming soon!', 'info');
        }

        // Clear form function
        function clearForm() {
            if (confirm('Are you sure you want to clear all form data?')) {
                const billingForm = document.getElementById('billingForm');
                if (billingForm) {
                    billingForm.reset();
                    // Reset calculations
                    updateTaxCalculations();
                    showNotification('Form cleared successfully', 'success');
                }
            }
        }

        // Helper function to ensure billing calculations are triggered properly
        function ensureBillingCalculation() {
            console.log('Ensuring billing calculation is up to date...');
            // Small delay to ensure DOM updates are complete
            setTimeout(() => {
                updateTaxCalculations();
            }, 50);
        }


        // Auto-fill customer's current Unaki appointments
        function autoFillCurrentServices() {
            {% if selected_customer and customer_appointments %}
            const servicesContainer = document.getElementById('servicesContainer');

            // Clear existing service rows except the first one
            const serviceRows = servicesContainer.querySelectorAll('.service-row');
            for (let i = 1; i < serviceRows.length; i++) {
                serviceRows[i].remove();
            }

            // Get customer's Unaki appointments
            const customerAppointments = {{ customer_appointments | tojson | safe }};
            let servicesAdded = 0;

            customerAppointments.forEach((appointment, index) => {
                // Find or create a service row
                let targetRow = null;

                if (index === 0) {
                    // Use the first existing row
                    targetRow = servicesContainer.querySelector('.service-row');
                } else {
                    // Create new row
                    addServiceRow();
                    const allRows = servicesContainer.querySelectorAll('.service-row');
                    targetRow = allRows[allRows.length - 1];
                }

                if (targetRow) {
                    const serviceSelect = targetRow.querySelector('select[name="service_ids[]"]');
                    const quantityInput = targetRow.querySelector('input[name="service_quantities[]"]');
                    const appointmentInput = targetRow.querySelector('input[name="appointment_ids[]"]');

                    // Try to find matching service by name
                    let matchedServiceId = null;
                    let servicePrice = appointment.service_price || 0;

                    // Look through all service options to find a match
                    for (let option of serviceSelect.options) {
                        if (option.value && option.text.toLowerCase().includes(appointment.service_name.toLowerCase())) {
                            matchedServiceId = option.value;
                            // Extract price from option text if available
                            const priceMatch = option.text.match(/₹([\d,]+\.?\d*)/);
                            if (priceMatch) {
                                servicePrice = parseFloat(priceMatch[1].replace(/,/g, ''));
                            }
                            break;
                        }
                    }

                    if (matchedServiceId) {
                        serviceSelect.value = matchedServiceId;
                        quantityInput.value = '1';
                        appointmentInput.value = `unaki_${appointment.id}`;

                        // Update the option's data-price attribute if needed
                        const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                        if (selectedOption && !selectedOption.dataset.price) {
                            selectedOption.dataset.price = servicePrice;
                        }

                        // Highlight the row
                        targetRow.style.borderLeft = '4px solid #007bff';
                        targetRow.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';

                        // Add visual indicator
                        let indicator = targetRow.querySelector('.unaki-indicator');
                        if (!indicator) {
                            indicator = document.createElement('small');
                            indicator.className = 'unaki-indicator text-info fw-bold d-block';
                            indicator.innerHTML = '<i class="fas fa-calendar-check me-1"></i>Unaki Booking';
                            targetRow.appendChild(indicator);
                        }

                        servicesAdded++;
                    } else {
                        // If no exact match, create a custom entry or show warning
                        console.warn(`No matching service found for: ${appointment.service_name}`);

                        // You could optionally add it as a custom service here
                        // For now, just fill the quantity and appointment ID
                        quantityInput.value = '1';
                        appointmentInput.value = `unaki_${appointment.id}`;

                        // Add warning indicator
                        let indicator = targetRow.querySelector('.unaki-indicator');
                        if (!indicator) {
                            indicator = document.createElement('small');
                            indicator.className = 'unaki-indicator text-warning fw-bold d-block';
                            indicator.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i>Service not found: ${appointment.service_name}`;
                            targetRow.appendChild(indicator);
                        }
                    }
                }
            });

            // Force update tax calculations after all services are added
            setTimeout(() => {
                updateTaxCalculations();
            }, 100);

            showNotification(`Auto-filled ${servicesAdded} of ${customerAppointments.length} Unaki appointments!`, servicesAdded > 0 ? 'success' : 'warning');
            {% else %}
            showNotification('No current Unaki appointments found to auto-fill', 'warning');
            {% endif %}
        }

// View full customer history
function viewFullCustomerHistory() {
    {% if selected_customer %}
    // Open customer detail page in new tab
    window.open('/clients/{{ selected_customer.id }}', '_blank');
    {% endif %}
}

// Add product row
function addProductRow() {
    const container = document.getElementById('productsContainer');
    const newRow = container.children[0].cloneNode(true);

    // Clear values and reset state
    newRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
    });

    // Reset batch dropdown
    const batchSelect = newRow.querySelector('.batch-select');
    batchSelect.innerHTML = '<option value="">Select Product First</option>';
    batchSelect.disabled = true;

    // Reset info divs
    newRow.querySelector('.batch-info').innerHTML = '';
    newRow.querySelector('.available-stock').innerHTML = '';

    // Change button to remove
    const button = newRow.querySelector('button');
    button.className = 'btn btn-danger btn-sm w-100';
    button.innerHTML = '<i class="fas fa-minus"></i>';
    button.onclick = function() { this.closest('.product-row').remove(); };

    container.appendChild(newRow);
}

// Load available batches for consumption (FIFO ordering)
        function loadAvailableBatches() {
            fetch('/api/inventory/batches/for-consumption')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.batches) {
                        availableBatches = data.batches;
                        console.log('Available batches loaded:', availableBatches.length);
                    }
                })
                .catch(error => {
                    console.error('Error loading batches:', error);
                });
        }

        // Load batches for selected product (FIFO - First In First Out by expiry)
        function loadBatchesForProduct(productSelect) {
            const row = productSelect.closest('.row');
            const batchSelect = row.querySelector('.batch-select');
            const batchInfo = row.querySelector('.batch-info');
            const quantityInput = row.querySelector('input[name="product_quantities[]"]');
            const priceInput = row.querySelector('input[name="product_prices[]"]');

            const productId = parseInt(productSelect.value);

            // Reset batch selection
            batchSelect.innerHTML = '<option value="">Loading batches...</option>';
            batchSelect.disabled = true;
            batchInfo.innerHTML = '';

            if (!productId) {
                batchSelect.innerHTML = '<option value="">Select Product First</option>';
                return;
            }

            // Find batches for this product (FIFO by expiry date)
            const productBatches = availableBatches.filter(batch => {
                // Match by product_id which is more reliable than name comparison
                return batch.product_id === productId && batch.qty_available > 0;
            });

            console.log(`DEBUG: Product ID ${productId} has ${productBatches.length} available batches`);
            console.log('Available batches for this product:', productBatches);

            if (productBatches.length === 0) {
                batchSelect.innerHTML = '<option value="">No stock available</option>';
                batchInfo.innerHTML = '<span class="text-danger">⚠️ No stock available for this product</span>';
                // Clear previous quantity and price if any
                if (quantityInput) quantityInput.value = '0';
                if (priceInput) priceInput.value = '';
                return;
            }

            // Sort by expiry date (FIFO - First to expire first)
            productBatches.sort((a, b) => {
                if (!a.expiry_date && !b.expiry_date) return 0;
                if (!a.expiry_date) return 1;
                if (!b.expiry_date) return -1;
                return new Date(a.expiry_date) - new Date(b.expiry_date);
            });

            // Auto-select first batch (FIFO)
            const firstBatch = productBatches[0];
            batchSelect.innerHTML = `<option value="${firstBatch.id}" selected>${firstBatch.dropdown_display}</option>`;

            // Add other batches as options
            productBatches.slice(1).forEach(batch => {
                const option = document.createElement('option');
                option.value = batch.id;
                option.textContent = batch.dropdown_display;
                batchSelect.appendChild(option);
            });

            batchSelect.disabled = false;

            // Show batch info
            const expiryText = firstBatch.expiry_date ? 
                `Expires: ${new Date(firstBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
            batchInfo.innerHTML = `
                <strong>Auto-selected:</strong> ${firstBatch.batch_name}<br>
                <strong>Available:</strong> ${firstBatch.qty_available} ${firstBatch.unit}<br>
                <strong>${expiryText}</strong>
            `;

            // Set max quantity and placeholder
            if (quantityInput) {
                quantityInput.max = firstBatch.qty_available;
                quantityInput.placeholder = `Max: ${firstBatch.qty_available}`;
                quantityInput.value = '1'; // Reset quantity to 1
                validateInventoryQuantity(quantityInput); // Validate after setting max and default value
            }
            // Auto-populate price based on the first batch's selling price
            if (priceInput) {
                const sellingPrice = firstBatch.selling_price || firstBatch.unit_price || firstBatch.unit_cost || 0;
                priceInput.value = parseFloat(sellingPrice).toFixed(2);
                // Trigger calculation update after setting price
                updateTaxCalculations();
            }

            // Update batch info when batch selection changes
            batchSelect.addEventListener('change', function() {
                const selectedBatch = productBatches.find(b => b.id == this.value);
                if (selectedBatch) {
                    const expiryText = selectedBatch.expiry_date ? 
                        `Expires: ${new Date(selectedBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
                    batchInfo.innerHTML = `
                        <strong>Selected:</strong> ${selectedBatch.batch_name}<br>
                        <strong>Available:</strong> ${selectedBatch.qty_available} ${selectedBatch.unit}<br>
                        <strong>${expiryText}</strong>
                    `;
                    if (quantityInput) {
                        quantityInput.max = selectedBatch.qty_available;
                        quantityInput.placeholder = `Max: ${selectedBatch.qty_available}`;
                        quantityInput.value = '1'; // Reset quantity to 1 on batch change
                        validateInventoryQuantity(quantityInput); // Re-validate
                    }
                    // Auto-populate price based on selected batch's selling price
                    if (priceInput) {
                        const sellingPrice = selectedBatch.selling_price || selectedBatch.unit_price || selectedBatch.unit_cost || 0;
                        priceInput.value = parseFloat(sellingPrice).toFixed(2);
                        // Trigger calculation update
                        updateTaxCalculations();
                    }
                }
            });
        }


// Validate stock availability
function validateStock(quantityInput) {
    const productRow = quantityInput.closest('.product-row');
    const batchSelect = productRow.querySelector('.batch-select');
    const selectedOption = batchSelect.options[batchSelect.selectedIndex];
    const availableStockDiv = productRow.querySelector('.batch-info'); // Use batch-info div for feedback

    if (!selectedOption || selectedOption.value === "") {
        // No batch selected yet or product not selected
        if (availableStockDiv) {
            availableStockDiv.innerHTML = '<span class="text-muted">Select batch to see stock</span>';
        }
        quantityInput.setCustomValidity(''); // Clear any previous invalidity
        return;
    }

    const selectedBatchId = selectedOption.value;
    const selectedBatch = availableBatches.find(b => b.id == selectedBatchId);

    if (selectedBatch) {
        const available = parseFloat(selectedBatch.qty_available);
        const requested = parseFloat(quantityInput.value) || 0;

        if (requested > available) {
            quantityInput.style.borderColor = '#dc3545'; // Red border for invalid input
            if (availableStockDiv) {
                availableStockDiv.innerHTML = '<span class="batch-warning">Available: ' + available + ' (Insufficient stock!)</span>';
            }
            quantityInput.setCustomValidity('Insufficient stock');
        } else {
            quantityInput.style.borderColor = '#28a745'; // Green border for valid input
             if (availableStockDiv) {
                const expiryText = selectedBatch.expiry_date ? 
                    `Expires: ${new Date(selectedBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
                availableStockDiv.innerHTML = `
                    <strong>Selected:</strong> ${selectedBatch.batch_name}<br>
                    <strong>Available:</strong> ${selectedBatch.qty_available} ${selectedBatch.unit}<br>
                    <strong>${expiryText}</strong>
                `;
            }
            quantityInput.setCustomValidity('');
        }
    } else {
        // If selected batch is not found in availableBatches, reset
        quantityInput.style.borderColor = '';
        if (availableStockDiv) {
            availableStockDiv.innerHTML = '';
        }
        quantityInput.setCustomValidity('');
    }
}

// Global variable to store customer package data for benefit calculations
let customerPackageData = null;

// Load customer packages and auto-populate services
document.getElementById('client_id').addEventListener('change', function() {
    const clientId = this.value;
    const packagesDiv = document.getElementById('customerPackages');

    if (!clientId) {
        packagesDiv.innerHTML = '<small>Select a customer to view their active packages</small>';
        customerPackageData = null;
        updateTaxCalculations(); // Update totals when customer is deselected
        return;
    }

    // Show loading state
    packagesDiv.innerHTML = '<small class="text-info"><i class="fas fa-spinner fa-spin"></i> Loading packages...</small>';

    fetch(`/integrated-billing/customer-packages/${clientId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Package data received:', data); // Debug log
            customerPackageData = data; // Store globally for package benefit calculations

            if (data.error) {
                packagesDiv.innerHTML = `<small class="text-danger">Error: ${data.error}</small>`;
                customerPackageData = null;
                return;
            }

            if (data.packages && data.packages.length > 0) {
                let html = '<div class="alert alert-success"><strong>Active Packages:</strong><br>';
                data.packages.forEach(pkg => {
                    html += `<div class="badge badge-success me-1 mb-1">${pkg.package_name}</div>`;

                    // Display package details based on type
                    pkg.sessions.forEach(session => {
                        if (session.benefit_type === 'unlimited') {
                            html += `<small class="d-block text-success">${session.service_name}: ${session.description}</small>`;
                        } else if (session.benefit_type === 'prepaid') {
                            html += `<small class="d-block text-info">${session.description}</small>`;
                        } else if (session.sessions_remaining > 0) {
                            html += `<small class="d-block">${session.service_name}: ${session.sessions_remaining} sessions left</small>`;
                        }
                    });
                });

                // Add summary if available
                if (data.summary) {
                    html += `<hr><small class="text-muted">Total Active: ${data.summary.total_active_packages} packages</small>`;
                }
                html += '</div>';

                packagesDiv.innerHTML = html;
            } else {
                packagesDiv.innerHTML = '<small class="text-muted">No active packages found</small>';
            }

            // Update calculations to apply package benefits
            updateTaxCalculations();
        })
        .catch(error => {
            console.error('Error loading packages:', error);
            packagesDiv.innerHTML = '<small class="text-danger">Error loading packages. Please try again.</button>';
            customerPackageData = null;
        });
});

// Function to auto-populate customer's historical services
        function autoPopulateCustomerServices(customerId) {
    if (!customerId) return;

    // Check if customer_services data is passed from backend
    const customerServicesData = {{ customer_services | tojson | safe }};

    if (customerServicesData && customerServicesData.length > 0) {
        console.log('Auto-populating services for customer:', customerServicesData);

        // Clear existing service rows except the first one
        const servicesContainer = document.getElementById('servicesContainer');
        const firstRow = servicesContainer.querySelector('.service-row');
        servicesContainer.innerHTML = '';
        servicesContainer.appendChild(firstRow);

        // Populate services
        customerServicesData.forEach((service, index) => {
            if (index === 0) {
                // Use first row
                const firstServiceSelect = firstRow.querySelector('select[name="service_ids[]"]');
                firstServiceSelect.value = service.id;

                // Add visual indicator
                firstRow.style.borderLeft = '3px solid #28a745';
                firstRow.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                firstRow.style.padding = '10px';
                firstRow.style.borderRadius = '5px';
                firstRow.style.marginBottom = '10px';

                // Add label
                const existingLabel = firstRow.querySelector('.auto-service-label');
                if (!existingLabel) {
                    const label = document.createElement('small');
                    label.className = 'auto-service-label text-success fw-bold';
                    label.innerHTML = '<i class="fas fa-history me-1"></i>Previously booked service';
                    firstRow.appendChild(label);
                }
            } else {
                // Add new rows for additional services
                addServiceRowWithData(service);
            }
        });

        // Show notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-info alert-dismissible fade show';
        notification.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>
            <strong>Auto-populated services:</strong> Found ${customerServicesData.length} services this customer has previously booked.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        const form = document.getElementById('billingForm');
        form.insertBefore(notification, form.firstChild);

        // Auto-dismiss notification after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);

        // Update calculations
        updateTaxCalculations();
    }
}

// Function to add a service row with pre-filled data
function addServiceRowWithData(serviceData) {
    const container = document.getElementById('servicesContainer');
    const newRow = container.children[0].cloneNode(true);

    // Set service value
    const serviceSelect = newRow.querySelector('select[name="service_ids[]"]');
    serviceSelect.value = serviceData.id;

    // Set default quantity
    const quantityInput = newRow.querySelector('input[name="service_quantities[]"]');
    quantityInput.value = '1';

    // Clear appointment ID
    const appointmentInput = newRow.querySelector('input[name="appointment_ids[]"]');
    appointmentInput.value = '';

    // Style the row to indicate it's auto-populated
    newRow.style.borderLeft = '3px solid #28a745';
    newRow.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
    newRow.style.padding = '10px';
    newRow.style.borderRadius = '5px';
    newRow.style.marginBottom = '10px';

    // Change button to remove
    const button = newRow.querySelector('button');
    button.className = 'btn btn-danger btn-sm';
    button.innerHTML = '<i class="fas fa-minus"></i>';
    button.onclick = function() { this.closest('.service-row').remove(); updateTaxCalculations(); };

    // Add label
    const label = document.createElement('small');
    label.className = 'auto-service-label text-success fw-bold d-block';
    label.innerHTML = '<i class="fas fa-history me-1"></i>Previously booked service';
    newRow.appendChild(label);

    container.appendChild(newRow);
}

// Professional Tax Calculation Functions
function updateTaxCalculations() {
    console.log('=== BILLING CALCULATION DEBUG ===');
    try {
        let servicesSubtotal = 0;
        let inventorySubtotal = 0;

        // Calculate services subtotal - include ALL service rows (manually added and auto-populated)
        const serviceRows = document.querySelectorAll('.service-row');
        console.log(`Found ${serviceRows.length} service rows to calculate`);

        serviceRows.forEach((row, index) => {
            const serviceSelect = row.querySelector('select[name="service_ids[]"]');
            const quantityInput = row.querySelector('input[name="service_quantities[]"]');

            console.log(`Row ${index + 1}:`, {
                hasService: !!serviceSelect?.value,
                serviceName: serviceSelect?.options[serviceSelect?.selectedIndex]?.text,
                price: serviceSelect?.options[serviceSelect?.selectedIndex]?.dataset?.price,
                quantity: quantityInput?.value
            });

            if (serviceSelect && serviceSelect.value && quantityInput && quantityInput.value) {
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                if (selectedOption) {
                    // Try to get price from data attribute first, then extract from text
                    let price = parseFloat(selectedOption.dataset.price) || 0;

                    if (price === 0) {
                        // Try to extract price from option text if data-price is missing
                        const priceMatch = selectedOption.text.match(/₹([\d,]+\.?\d*)/);
                        if (priceMatch) {
                            price = parseFloat(priceMatch[1].replace(/,/g, ''));
                            // Set the data-price for future calculations
                            selectedOption.dataset.price = price.toString();
                        }
                    }

                    const quantity = parseFloat(quantityInput.value) || 1;
                    const lineTotal = price * quantity;
                    servicesSubtotal += lineTotal;
                    console.log(`Added: Service ${index + 1}: ₹${price} × ${quantity} = ₹${lineTotal}`);
                } else {
                    console.log(`Service ${index + 1}: No selected option found`);
                }
            } else {
                console.log(`Service ${index + 1}: Missing service selection or quantity`);
            }
        });

        // Calculate inventory subtotal
        const productRows = document.querySelectorAll('.product-row');
        console.log(`Found ${productRows.length} product rows to calculate`);

        productRows.forEach((row, index) => {
            const quantityInput = row.querySelector('input[name="product_quantities[]"]');
            const priceInput = row.querySelector('input[name="product_prices[]"]');

            if (quantityInput && priceInput && quantityInput.value && priceInput.value) {
                const quantity = parseFloat(quantityInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const lineTotal = quantity * price;
                inventorySubtotal += lineTotal;
                console.log(`Product ${index + 1}: Qty: ${quantity}, Price: ₹${price}, Line Total: ₹${lineTotal}`);
            }
        });

        const grossSubtotal = servicesSubtotal + inventorySubtotal;
        console.log(`Total services subtotal: ₹${servicesSubtotal.toFixed(2)}`);
        console.log(`Total inventory subtotal: ₹${inventorySubtotal.toFixed(2)}`);
        console.log(`Gross subtotal: ₹${grossSubtotal.toFixed(2)}`);

        // Get discount
        const discountType = document.getElementById('discount_type').value;
        const discountValue = parseFloat(document.getElementById('discount_value').value) || 0;
        let discountAmount = 0;

        if (discountType === 'percentage') {
            discountAmount = (grossSubtotal * discountValue) / 100;
        } else {
            // Amount discount
            discountAmount = discountValue;
        }
        // Ensure discount amount doesn't exceed gross subtotal
        discountAmount = Math.min(discountAmount, grossSubtotal);

        const taxableAmount = Math.max(0, grossSubtotal - discountAmount);

        // Calculate taxes
        const isInterstate = document.getElementById('is_interstate').checked;
        let cgstAmount = 0, sgstAmount = 0, igstAmount = 0;

        if (isInterstate) {
            const igstRate = parseFloat(document.getElementById('igst_rate').value) || 0;
            igstAmount = (taxableAmount * igstRate) / 100;
        } else {
            const cgstRate = parseFloat(document.getElementById('cgst_rate').value) || 0;
            const sgstRate = parseFloat(document.getElementById('sgst_rate').value) || 0;
            cgstAmount = (taxableAmount * cgstRate) / 100;
            sgstAmount = (taxableAmount * sgstRate) / 100;
        }

        const additionalCharges = parseFloat(document.getElementById('additional_charges').value) || 0;
        const tipsAmount = parseFloat(document.getElementById('tips_amount').value) || 0;

        const totalTaxAmount = cgstAmount + sgstAmount + igstAmount;
        const totalAmount = taxableAmount + totalTaxAmount + additionalCharges + tipsAmount;

        // Update display with proper formatting
        document.getElementById('display_subtotal').textContent = formatCurrency(grossSubtotal);
        document.getElementById('display_discount').textContent = formatCurrency(discountAmount);
        document.getElementById('display_cgst').textContent = formatCurrency(cgstAmount + igstAmount);
        document.getElementById('display_sgst').textContent = formatCurrency(sgstAmount);
        document.getElementById('display_additional').textContent = formatCurrency(additionalCharges + tipsAmount);
        document.getElementById('display_total').textContent = formatCurrency(totalAmount);

        // Update tax summary information
        updateTaxSummaryDisplay(isInterstate, totalTaxAmount, taxableAmount);

        console.log(`Final calculation: Subtotal: ₹${grossSubtotal.toFixed(2)}, Tax: ₹${totalTaxAmount.toFixed(2)}, Total: ₹${totalAmount.toFixed(2)}`);

    } catch (error) {
        console.error('Error in updateTaxCalculations:', error);
        // Set default values on error
        document.getElementById('display_subtotal').textContent = '₹0.00';
        document.getElementById('display_discount').textContent = '₹0.00';
        document.getElementById('display_cgst').textContent = '₹0.00';
        document.getElementById('display_sgst').textContent = '₹0.00';
        document.getElementById('display_additional').textContent = '₹0.00';
        document.getElementById('display_total').textContent = '₹0.00';
    }
}

// Helper function to format currency
function formatCurrency(amount) {
    return `₹${(amount || 0).toFixed(2)}`;
}

// Update tax summary display
function updateTaxSummaryDisplay(isInterstate, totalTaxAmount, taxableAmount) {
    try {
        const taxTypeDisplay = document.getElementById('tax_type_display');
        const totalTaxDisplay = document.getElementById('total_tax_display');
        const taxPercentageDisplay = document.getElementById('tax_percentage_display');

        if (taxTypeDisplay) {
            taxTypeDisplay.textContent = isInterstate ? 'Interstate (IGST)' : 'Intrastate (CGST + SGST)';
        }

        if (totalTaxDisplay) {
            totalTaxDisplay.textContent = formatCurrency(totalTaxAmount);
        }

        if (taxPercentageDisplay) {
            const cgstRate = parseFloat(document.getElementById('cgst_rate').value) || 0;
            const sgstRate = parseFloat(document.getElementById('sgst_rate').value) || 0;
            const igstRate = parseFloat(document.getElementById('igst_rate').value) || 0;

            const totalTaxRate = isInterstate ? igstRate : (cgstRate + sgstRate);
            taxPercentageDisplay.textContent = `${totalTaxRate.toFixed(2)}%`;
        }
    } catch (error) {
        console.error('Error updating tax summary display:', error);
    }
}

function calculateServicesSubtotal() {
    let total = 0;
    document.querySelectorAll('.service-row').forEach((row, index) => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const quantityInput = row.querySelector('input[name="service_quantities[]"]');

        if (serviceSelect && serviceSelect.value && quantityInput && quantityInput.value) {
            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            if (selectedOption && selectedOption.dataset.price) {
                const originalPrice = parseFloat(selectedOption.dataset.price);
                const quantity = parseFloat(quantityInput.value) || 1; // Default to 1 if empty
                const serviceId = parseInt(serviceSelect.value);
                const serviceName = selectedOption.text;

                // Check if customer has package benefits for this service
                let finalPrice = originalPrice * quantity;
                let packageBenefit = null;

                if (customerPackageData && customerPackageData.packages) {
                    packageBenefit = checkServicePackageBenefit(serviceId, serviceName, originalPrice, quantity);
                    if (packageBenefit) {
                        finalPrice = packageBenefit.finalPrice;

                        // Update service display to show package benefit
                        updateServiceDisplayWithBenefit(row, packageBenefit, index);
                    }
                }

                if (!packageBenefit) {
                    // Clear any previous package benefit display
                    clearServiceBenefitDisplay(row, index);
                }

                total += finalPrice;
            }
        }
    });
    return total;
}

// Check if customer has package benefits for a specific service
function checkServicePackageBenefit(serviceId, serviceName, originalPrice, quantity) {
    if (!customerPackageData || !customerPackageData.packages) {
        return null;
    }

    // Ensure quantity is at least 1
    quantity = Math.max(1, quantity);

    // Check all packages for this service (priority: unlimited > service_package > prepaid)
    for (const pkg of customerPackageData.packages) {
        if (!pkg.is_active) continue;

        // Check unlimited membership first (highest priority)
        if (pkg.package_type === 'membership') {
            for (const session of pkg.sessions) {
                if (session.benefit_type === 'unlimited' && session.service_id === serviceId) {
                    return {
                        type: 'unlimited',
                        packageName: pkg.package_name,
                        originalPrice: originalPrice * quantity,
                        finalPrice: 0, // FREE
                        discount: originalPrice * quantity,
                        description: `FREE via ${pkg.package_name} (Unlimited)`
                    };
                }
            }
        }

        // Check service package benefits (specific service sessions) with quantity awareness
        if (pkg.package_type === 'service_package') {
            for (const session of pkg.sessions) {
                if (session.service_id === serviceId && session.sessions_remaining > 0) {
                    const pricePerSession = originalPrice; // Service price is for one session
                    const sessionsToCover = Math.min(quantity, session.sessions_remaining);
                    const sessionsToPayFor = Math.max(0, quantity - sessionsToCover);

                    const coveredAmount = sessionsToCover * pricePerSession;
                    const finalPrice = sessionsToPayFor * pricePerSession;

                    // Ensure calculations are accurate
                    const totalServicePrice = originalPrice * quantity;
                    const actualDiscount = Math.min(coveredAmount, totalServicePrice);
                    const actualFinalPrice = Math.max(0, totalServicePrice - actualDiscount);

                    if (sessionsToPayFor > 0) {
                        // Partial coverage - some sessions free, some charged
                        return {
                            type: 'service_package_partial',
                            packageName: pkg.package_name,
                            originalPrice: totalServicePrice,
                            finalPrice: actualFinalPrice,
                            discount: actualDiscount,
                            description: `${sessionsToCover} of ${quantity} sessions FREE, ${sessionsToPayFor} charged via ${pkg.package_name}`,
                            sessionsRemaining: session.sessions_remaining,
                            sessionsCovered: sessionsToCover,
                            sessionsToPayFor: sessionsToPayFor
                        };
                    } else {
                        // Full coverage - all sessions free
                        return {
                            type: 'service_package_full',
                            packageName: pkg.package_name,
                            originalPrice: totalServicePrice,
                            finalPrice: 0,
                            discount: totalServicePrice,
                            description: `All ${sessionsToCover} sessions FREE via ${pkg.package_name} (${session.sessions_remaining - sessionsToCover} remaining)`,
                            sessionsRemaining: session.sessions_remaining,
                            sessionsCovered: sessionsToCover,
                            sessionsToPayFor: 0
                        };
                    }
                }
            }
        }

        // Check prepaid package benefits (can cover any service)
        if (pkg.package_type === 'prepaid') {
            for (const session of pkg.sessions) {
                if (session.benefit_type === 'prepaid' && session.balance_remaining > 0) {
                    const serviceTotal = originalPrice * quantity;
                    if (session.balance_remaining >= serviceTotal) {
                        // Full coverage
                        return {
                            type: 'prepaid_full',
                            packageName: pkg.package_name,
                            originalPrice: serviceTotal,
                            finalPrice: 0, // FREE
                            discount: serviceTotal,
                            description: `FREE via ${pkg.package_name} (₹${session.balance_remaining} credit)`
                        };
                    } else {
                        // Partial coverage
                        return {
                            type: 'prepaid_partial',
                            packageName: pkg.package_name,
                            originalPrice: serviceTotal,
                            finalPrice: serviceTotal - session.balance_remaining,
                            discount: session.balance_remaining,
                            description: `₹${session.balance_remaining} off via ${pkg.package_name}`
                        };
                    }
                }
            }
        }
    }

    return null;
}

// Update service display to show package benefit
function updateServiceDisplayWithBenefit(row, benefit, index) {
    // Add package benefit indicator to the service row
    let benefitDisplay = row.querySelector('.package-benefit-display');
    if (!benefitDisplay) {
        benefitDisplay = document.createElement('div');
        benefitDisplay.className = 'package-benefit-display mt-1';
        row.appendChild(benefitDisplay);
    }

    if (benefit.finalPrice === 0) {
        // Full coverage - all sessions free
        benefitDisplay.innerHTML = `
            <small class="text-success fw-bold">
                <i class="fas fa-gift me-1"></i>FREE - ${benefit.description}
                <br><strike class="text-muted">₹${benefit.originalPrice.toFixed(2)}</strike>
                <span class="badge bg-success ms-1">100% Covered</span>
            </small>
        `;
        benefitDisplay.style.backgroundColor = '#d4edda';
        benefitDisplay.style.border = '1px solid #28a745';
        benefitDisplay.style.padding = '6px 10px';
        benefitDisplay.style.borderRadius = '6px';
    } else {
        // Partial coverage or discount
        const isPartialCoverage = benefit.sessionsCovered && benefit.sessionsToPayFor;
        const coveragePercent = Math.round((benefit.discount / benefit.originalPrice) * 100);

        benefitDisplay.innerHTML = `
            <small class="fw-bold">
                <i class="fas fa-percentage me-1 text-info"></i>${benefit.description}
                <br>
                ${isPartialCoverage ? 
                    `<span class="text-success">✓ Free: ${benefit.sessionsCovered} sessions</span> | <span class="text-warning">₹ Pay: ${benefit.sessionsToPayFor} sessions</span><br>` : 
                    ''
                }
                <span class="text-dark">Pay: ₹${benefit.finalPrice.toFixed(2)}</span> 
                <strike class="text-muted small">₹${benefit.originalPrice.toFixed(2)}</strike>
                <span class="badge bg-info ms-1">${coveragePercent}% Saved</span>
                <br><span class="text-success small">Package Discount: ₹${benefit.discount.toFixed(2)}</span>
            </small>
        `;
        benefitDisplay.style.backgroundColor = '#e3f2fd';
        benefitDisplay.style.border = '1px solid #2196f3';
        benefitDisplay.style.padding = '6px 10px';
        benefitDisplay.style.borderRadius = '6px';
    }
}

// Clear service benefit display
function clearServiceBenefitDisplay(row, index) {
    const benefitDisplay = row.querySelector('.package-benefit-display');
    if (benefitDisplay) {
        benefitDisplay.remove();
    }
}

function calculateInventorySubtotal() {
    let total = 0;
    document.querySelectorAll('.product-row').forEach(row => {
        const quantityInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.unit-price');

        if (quantityInput && priceInput && quantityInput.value && priceInput.value) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            total += quantity * price;
        }
    });
    return total;
}

function toggleTaxType() {
    try {
        const isInterstate = document.getElementById('is_interstate').checked;
        const cgstInput = document.getElementById('cgst_rate');
        const sgstInput = document.getElementById('sgst_rate');
        const igstInput = document.getElementById('igst_rate');

        if (isInterstate) {
            // Interstate transaction - use IGST only
            cgstInput.value = 0;
            sgstInput.value = 0;
            cgstInput.disabled = true;
            sgstInput.disabled = true;
            igstInput.disabled = false;
            if (parseFloat(igstInput.value) === 0) igstInput.value = '18'; // Default IGST to 18%

            // Visual feedback
            cgstInput.classList.add('text-muted');
            sgstInput.classList.add('text-muted');
            igstInput.classList.remove('text-muted');
        } else {
            // Intrastate transaction - use CGST + SGST
            igstInput.value = 0;
            igstInput.disabled = true;
            cgstInput.disabled = false;
            sgstInput.disabled = false;
            if (parseFloat(cgstInput.value) === 0) cgstInput.value = '9'; // Default CGST to 9%
            if (parseFloat(sgstInput.value) === 0) sgstInput.value = '9'; // Default SGST to 9%

            // Visual feedback
            igstInput.classList.add('text-muted');
            cgstInput.classList.remove('text-muted');
            sgstInput.classList.remove('text-muted');
        }

        updateTaxCalculations();
    } catch (error) {
        console.error('Error in toggleTaxType:', error);
    }
}

// Payment Method Management
function addPaymentMethod() {
    const container = document.getElementById('paymentMethodsContainer');
    const methodCount = container.children.length;

    const methodRow = document.createElement('div');
    methodRow.className = 'row mb-2 payment-method-row';
    methodRow.innerHTML = `
        <div class="col-md-4">
            <select class="form-select" name="split_payment_methods[]" required>
                <option value="">Select Method</option>
                <option value="cash">Cash</option>
                <option value="card">Card</option>
                <option value="upi">UPI</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="cheque">Cheque</option>
            </select>
        </div>
        <div class="col-md-4">
            <input type="number" class="form-control" name="split_payment_amounts[]" placeholder="Amount" step="0.01" min="0" required>
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" name="split_payment_refs[]" placeholder="Reference/Transaction ID">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger btn-sm" onclick="removePaymentMethod(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    container.appendChild(methodRow);
}

function removePaymentMethod(button) {
    button.closest('.payment-method-row').remove();
}

// Invoice Actions
function previewInvoice() {
    // Get the modal and elements
    const modal = new bootstrap.Modal(document.getElementById('invoicePreviewModal'));
    const previewBody = document.getElementById('invoicePreviewBody');

    // Collect current invoice data from the form
    const customerId = document.getElementById('client_id').value;
    const customerSelect = document.getElementById('client_id');
    const customerName = customerSelect.options[customerSelect.selectedIndex].text;

    const servicesSubtotal = calculateServicesSubtotal();
    const inventorySubtotal = calculateInventorySubtotal();
    const grossSubtotal = servicesSubtotal + inventorySubtotal;
    const discountType = document.getElementById('discount_type').value;
    const discountValue = parseFloat(document.getElementById('discount_value').value) || 0;
    const additionalCharges = parseFloat(document.getElementById('additional_charges').value) || 0;
    const tipsAmount = parseFloat(document.getElementById('tips_amount').value) || 0;
    const isInterstate = document.getElementById('is_interstate').checked;
    const cgstRate = parseFloat(document.getElementById('cgst_rate').value) || 0;
    const sgstRate = parseFloat(document.getElementById('sgst_rate').value) || 0;
    const igstRate = parseFloat(document.getElementById('igst_rate').value) || 0;

    const invoiceDataForPreview = {
        customer_name: customerName.split(' - ')[0], // Extract name from "Name - Phone"
        customer_id: customerId,
        services: [],
        inventory_items: [],
        discount_type: discountType,
        discount_value: discountValue,
        additional_charges: additionalCharges,
        tips_amount: tipsAmount,
        is_interstate: isInterstate,
        cgst_rate: cgstRate,
        sgst_rate: sgstRate,
        igst_rate: igstRate,
        notes: document.getElementById('notes').value
    };

    // Collect service items
    document.querySelectorAll('.service-row').forEach((row, index) => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const quantityInput = row.querySelector('input[name="service_quantities[]"]');
        const appointmentIdInput = row.querySelector('input[name="appointment_ids[]"]');
        const serviceName = serviceSelect.options[serviceSelect.selectedIndex].text;
        const originalPrice = parseFloat(serviceSelect.options[serviceSelect.selectedIndex].dataset.price) || 0;
        const quantity = parseFloat(quantityInput.value) || 1;
        const appointmentId = appointmentIdInput.value;

        if (serviceSelect.value) {
            // Check for package benefits
            const packageBenefit = checkServicePackageBenefit(parseInt(serviceSelect.value), serviceName, originalPrice, quantity);
            let finalPrice = originalPrice * quantity;
            let discount = 0;
            let benefitDescription = '';

            if (packageBenefit) {
                finalPrice = packageBenefit.finalPrice;
                discount = packageBenefit.discount;
                benefitDescription = packageBenefit.description;
            }

            invoiceDataForPreview.services.push({
                name: serviceName,
                quantity: quantity,
                unit_price: originalPrice,
                subtotal: originalPrice * quantity,
                final_price: finalPrice,
                discount: discount,
                package_benefit: benefitDescription
            });
        }
    });

    // Collect inventory items
    document.querySelectorAll('.product-row').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const batchSelect = row.querySelector('.batch-select');
        const quantityInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.unit-price');

        if (productSelect.value && batchSelect.value && quantityInput.value && priceInput.value) {
            const productName = productSelect.options[productSelect.selectedIndex].text.split(' (')[0]; // Get name without stock info
            const batchName = batchSelect.options[batchSelect.selectedIndex].text;
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(priceInput.value) || 0;
            const subtotal = quantity * unitPrice;

            invoiceDataForPreview.inventory_items.push({
                name: productName,
                batch: batchName,
                quantity: quantity,
                unit_price: unitPrice,
                subtotal: subtotal
            });
        }
    });

    // Make the API call to get the preview HTML
    fetch('/api/invoice-preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(invoiceDataForPreview)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.preview_html) {
            previewBody.innerHTML = data.preview_html;
            modal.show();
        } else {
            // Show error in the result modal instead of the preview modal
            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            document.getElementById('resultModalTitle').textContent = 'Error generating preview';
            document.getElementById('resultModalTitle').className = 'text-danger';
            document.getElementById('resultModalBody').innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>${data.error || 'Failed to load preview content.'}</div>`;
            resultModal.show();
        }
    })
    .catch(error => {
        console.error('Error fetching invoice preview:', error);
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        document.getElementById('resultModalTitle').textContent = 'Error';
        document.getElementById('resultModalTitle').className = 'text-danger';
        document.getElementById('resultModalBody').innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Failed to generate invoice preview. ${error.message}</div>`;
        resultModal.show();
    });
}

function saveAsDraft() {
    // Get the save draft button and status div
    const saveButton = document.getElementById('saveDraftBtn');
    const statusDiv = document.getElementById('draftSaveStatus');
    const originalText = saveButton.innerHTML;

    // Show loading state
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    saveButton.disabled = true;
    statusDiv.innerHTML = '';

    // Prepare form data
    const formData = new FormData(document.getElementById('billingForm'));
    formData.append('save_as_draft', 'true');

    fetch('/integrated-billing/save-draft', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        // Reset button state
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;

        if (data.success) {
            // Show success message
            statusDiv.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show mt-2">
                    <i class="fas fa-check-circle me-2"></i>Draft saved successfully! ${data.items_saved ? `(${data.items_saved} items)` : ''}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            // Auto-hide alert after 4 seconds
            setTimeout(() => {
                const alert = statusDiv.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 4000);
        } else {
            // Show error message
            statusDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show mt-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error: ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
    })
    .catch(error => {
        // Reset button state
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;

        console.error('Draft save error:', error);

        // Show error message
        statusDiv.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show mt-2">
                <i class="fas fa-exclamation-triangle me-2"></i>Network error while saving draft. Please check your connection.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    });
}

function sendQuotation() {
    // Convert current form to quotation
    alert('Quotation feature coming soon!');
}

function clearForm() {
    if (confirm('Are you sure you want to clear the entire form? All entered data will be lost.')) {
        document.getElementById('billingForm').reset();
        updateTaxCalculations();

        // Clear all dynamic elements
        const productRows = document.querySelectorAll('.product-row');
        productRows.forEach((row, index) => {
            if (index > 0) {
                row.remove();
            }
        });

        document.getElementById('customerPackages').innerHTML = '<small>Select a customer to view their active packages</small>';
    }
}

// Payment Method Change Handler
document.getElementById('payment_method').addEventListener('change', function() {
    const multiPaymentSection = document.getElementById('multiPaymentSection');
    if (this.value === 'mixed') {
        multiPaymentSection.style.display = 'block';
        addPaymentMethod(); // Add first payment method row
    } else {
        multiPaymentSection.style.display = 'none';
        document.getElementById('paymentMethodsContainer').innerHTML = '';
    }
});

// Auto-update calculations when any input changes (integrated with new system)
document.addEventListener('input', function(e) {
    if (e.target.matches('input[name="service_quantities[]"], .quantity-input, .unit-price, .tax-input, .billing-input')) {
        // Debounce rapid input changes
        clearTimeout(window.taxCalculationTimeout);
        window.taxCalculationTimeout = setTimeout(updateTaxCalculations, 200);
    }
});

document.addEventListener('change', function(e) {
    if (e.target.matches('select[name="service_ids[]"], .billing-input, .tax-input, #is_interstate')) {
        updateTaxCalculations();
    }
});

// Enhanced form submission with professional features
document.getElementById('billingForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Get submit button and show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Invoice...';
    submitBtn.disabled = true;

    // Basic validation for required fields (example: customer)
    if (!document.getElementById('client_id').value) {
        alert('Please select a customer.');
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        return;
    }

    // Check if at least one service or product is selected
    const serviceSelected = Array.from(document.querySelectorAll('select[name="service_ids[]"]')).some(select => select.value);
    const productSelected = Array.from(document.querySelectorAll('select[name="product_ids[]"]')).some(select => select.value);

    if (!serviceSelected && !productSelected) {
        alert('Please select at least one service or product to create an invoice.');
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        return;
    }

    // Validate all stock quantities before submission
    const quantityInputs = document.querySelectorAll('.quantity-input');
    let hasStockErrors = false;

    quantityInputs.forEach(input => {
        const productRow = input.closest('.product-row');
        const productSelect = productRow.querySelector('.product-select');

        // Only validate if product is selected
        if (productSelect && productSelect.value) {
            validateInventoryQuantity(input);
            if (!input.checkValidity()) {
                hasStockErrors = true;
            }
        }
    });

    if (hasStockErrors) {
        alert('Please check stock availability for all products before submitting.');
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        return;
    }

    const formData = new FormData(this);

    // Add tax calculation data to form data for submission
    formData.append('cgst_amount', (parseFloat(document.getElementById('display_cgst').textContent.replace('₹', '').replace(/,/g, '')) || 0));
    formData.append('sgst_amount', (parseFloat(document.getElementById('display_sgst').textContent.replace('₹', '').replace(/,/g, '')) || 0));
    formData.append('igst_amount', (parseFloat(document.getElementById('display_cgst').textContent.replace('₹', '').replace(/,/g, '')) || 0)); // Assuming IGST is displayed in CGST placeholder if interstate
    formData.append('discount_amount', (parseFloat(document.getElementById('display_discount').textContent.replace('₹', '').replace(/,/g, '')) || 0));
    formData.append('additional_charges_display', (parseFloat(document.getElementById('display_additional').textContent.replace('₹', '').replace(/,/g, '')) || 0));
    formData.append('total_amount', (parseFloat(document.getElementById('display_total').textContent.replace('₹', '').replace(/,/g, '')) || 0));

    fetch('/integrated-billing/create-professional', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Always reset button state first
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        const title = document.getElementById('resultModalTitle');
        const body = document.getElementById('resultModalBody');
        const viewBtn = document.getElementById('viewInvoiceBtn');
        const printBtn = document.getElementById('printInvoiceBtn');
        const emailBtn = document.getElementById('emailInvoiceBtn');
        const whatsappBtn = document.getElementById('whatsappInvoiceBtn');

        // Reset all action buttons display
        viewBtn.style.display = 'none';
        printBtn.style.display = 'none';
        emailBtn.style.display = 'none';
        whatsappBtn.style.display = 'none';


        if (data.success) {
            title.textContent = 'Professional Invoice Created Successfully!';
            title.className = 'text-success';

            let message = `<div class="text-success">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <h4>${data.message}</h4>
                <div class="row mt-3">
                    <div class="col-6"><strong>Invoice Number:</strong></div>
                    <div class="col-6">${data.invoice_number}</div>
                </div>
                <div class="row">
                    <div class="col-6"><strong>Total Amount:</strong></div>
                    <div class="col-6">₹${data.total_amount.toLocaleString('en-IN')}</div>
                </div>
                <div class="row">
                    <div class="col-6"><strong>CGST:</strong></div>
                    <div class="col-6">₹${data.cgst_amount.toLocaleString('en-IN')}</div>
                </div>
                <div class="row">
                    <div class="col-6"><strong>SGST:</strong></div>
                    <div class="col-6">₹${data.sgst_amount.toLocaleString('en-IN')}</div>
                </div>
            `;

            if (data.deductions_applied > 0) {
                message += `<div class="row text-success">
                    <div class="col-6"><strong>Package Deductions:</strong></div>
                    <div class="col-6">₹${data.deductions_applied.toLocaleString('en-IN')}</div>
                </div>`;
            }

            if (data.stock_reduced && data.stock_reduced.length > 0) {
                message += `<div class="row text-info mt-2">
                    <div class="col-12"><small><strong>Stock Reduced:</strong></small></div>
                    <ul class="mb-0">`;
                data.stock_reduced.forEach(item => {
                    message += `<li><small>${item.product_name} - Batch ${item.batch_name}: ${item.quantity_reduced} ${item.unit}</small></li>`;
                });
                message += `</ul></div>`;
            }

            message += '</div>';
            body.innerHTML = message;

            viewBtn.style.display = 'block';
            viewBtn.href = `/integrated-billing/invoice/${data.invoice_id}`;
            printBtn.style.display = 'block';
            emailBtn.style.display = 'block';
            whatsappBtn.style.display = 'block';

            // Store invoice ID for action buttons
            viewBtn.dataset.invoiceId = data.invoice_id;
            printBtn.dataset.invoiceId = data.invoice_id;
            emailBtn.dataset.invoiceId = data.invoice_id;
            whatsappBtn.dataset.invoiceId = data.invoice_id;


            // Reset form after successful submission
            clearForm();

        } else {
            title.textContent = 'Error Creating Professional Invoice';
            title.className = 'text-danger';
            body.innerHTML = `<div class="text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h5>Invoice creation failed</h5>
                <p>${data.message}</p>
            </div>`;
            viewBtn.style.display = 'none';
        }

        modal.show();
    })
    .catch(error => {
        console.error('Submission Error:', error);

        // Ensure button state is reset
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;

        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        const title = document.getElementById('resultModalTitle');
        const body = document.getElementById('resultModalBody');
        const viewBtn = document.getElementById('viewInvoiceBtn');
        const printBtn = document.getElementById('printInvoiceBtn');
        const emailBtn = document.getElementById('emailInvoiceBtn');
        const whatsappBtn = document.getElementById('whatsappInvoiceBtn');

        // Hide action buttons on error
        viewBtn.style.display = 'none';
        printBtn.style.display = 'none';
        emailBtn.style.display = 'none';
        whatsappBtn.style.display = 'none';

        title.textContent = 'Invoice Creation Failed';
        title.className = 'text-danger';
        body.innerHTML = `<div class="text-danger">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <h5>Invoice creation failed</h5>
            <p>There was an error processing your invoice. Please try again.</p>
            <small class="text-muted">Error details: ${error.message}</small>
            <hr>
            <p class="text-muted"><strong>Troubleshooting tips:</strong></p>
            <ul class="text-muted">
                <li>Check that all required fields are filled</li>
                <li>Verify sufficient stock for selected products</li>
                <li>Ensure tax rates are valid numbers</li>
                <li>Try refreshing the page and creating again</li>
            </ul>
        </div>`;

        modal.show();
    });
});

// Validate inventory quantity against available stock
        function validateInventoryQuantity(quantityInput) {
            const row = quantityInput.closest('.row');
            const batchSelect = row.querySelector('.batch-select');
            const productSelect = row.querySelector('.product-select');

            // Ensure product and batch are selected before validating
            if (!batchSelect.value || !productSelect.value) {
                // Clear any previous validation messages if product/batch not selected
                quantityInput.classList.remove('is-invalid');
                const errorMsg = row.querySelector('.quantity-error');
                if (errorMsg) errorMsg.remove();
                return;
            }

            const selectedBatch = availableBatches.find(b => b.id == batchSelect.value);
            if (selectedBatch) {
                const requestedQty = parseFloat(quantityInput.value);
                const availableQty = parseFloat(selectedBatch.qty_available);

                if (requestedQty > availableQty) {
                    quantityInput.classList.add('is-invalid');
                    // Show error message
                    let errorMsg = row.querySelector('.quantity-error');
                    if (!errorMsg) {
                        errorMsg = document.createElement('div');
                        errorMsg.className = 'quantity-error text-danger small mt-1';
                        quantityInput.parentNode.appendChild(errorMsg);
                    }
                    errorMsg.textContent = `Maximum available: ${availableQty} ${selectedBatch.unit}`;
                    // Optionally auto-correct or just show error
                    // quantityInput.value = availableQty; // Auto-correct to max available
                    // quantityInput.classList.remove('is-invalid'); // Remove invalid class if auto-corrected
                    // errorMsg.remove(); // Remove error message if auto-corrected
                } else {
                    quantityInput.classList.remove('is-invalid');
                    const errorMsg = row.querySelector('.quantity-error');
                    if (errorMsg) errorMsg.remove();
                }
            }
        }

        // Add debug function for manual testing
        function debugBillingCalculation() {
            console.log('=== MANUAL DEBUG TRIGGERED ===');
            validateServiceRowPrices();
            updateTaxCalculations();

            const finalTotal = document.getElementById('display_total').textContent;
            console.log('Final displayed total:', finalTotal);
        }

        // Validate that all service rows have proper price data
        function validateServiceRowPrices() {
            const serviceRows = document.querySelectorAll('.service-row');
            let hasErrors = false;

            serviceRows.forEach((row, index) => {
                const serviceSelect = row.querySelector('select[name="service_ids[]"]');
                if (serviceSelect && serviceSelect.value) {
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    if (!selectedOption.dataset.price) {
                        console.error(`Row ${index + 1} missing price data for service:`, selectedOption.text);
                        hasErrors = true;

                        // Try to extract and set price from text
                        const priceMatch = selectedOption.text.match(/₹([\d,]+\.?\d*)/);
                        if (priceMatch) {
                            const price = parseFloat(priceMatch[1].replace(/,/g, ''));
                            selectedOption.dataset.price = price.toString();
                            console.log(`Fixed price data for ${selectedOption.text}: ₹${price}`);
                            hasErrors = false;
                        }
                    }
                }
            });

            return !hasErrors;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Integrated billing page loaded, initializing...');
            loadAvailableBatches();

            // Auto-fill appointment services when customer is pre-selected
            {% if customer_appointments and customer_appointments|length > 0 %}
            console.log('Auto-filling {{ customer_appointments|length }} appointment services...');
            autoFillCurrentServices();
            {% endif %}

            // Initialize tax calculations
            setTimeout(() => {
                updateTaxCalculations(); // Initial calculation update based on default values
                toggleTaxType(); // Apply initial tax type settings
            }, 500);

            // Add event listeners for real-time package benefit calculation
            setupServiceChangeListeners();
            setupTaxCalculationListeners();

            // Add enhanced change event listeners
            document.addEventListener('change', function(e) {
                if (e.target.matches('select[name="service_ids[]"]') || 
                    e.target.matches('input[name="service_quantities[]"]')) {
                    console.log('Service selection or quantity changed, updating calculations...');
                    setTimeout(() => {
                        validateServiceRowPrices();
                        updateTaxCalculations();
                    }, 100);
                }
            });
        });

        // Setup comprehensive event listeners for tax calculations
        function setupTaxCalculationListeners() {
            console.log('Setting up tax calculation listeners...');

            // Tax rate inputs
            const taxInputs = document.querySelectorAll('.tax-input, .billing-input');
            taxInputs.forEach(input => {
                input.addEventListener('input', updateTaxCalculations);
                input.addEventListener('change', updateTaxCalculations);
            });

            // Service selection listeners
            document.addEventListener('change', function(e) {
                if (e.target.matches('select[name="service_ids[]"]') || 
                    e.target.matches('input[name="service_quantities[]"]') ||
                    e.target.matches('input[name="product_quantities[]"]') ||
                    e.target.matches('input[name="product_prices[]"]')) {
                    updateTaxCalculations();
                }
            });

            // Initial calculation
            updateTaxCalculations();

            console.log('Tax calculation listeners set up successfully');
        }

        // Setup event listeners for service selection changes
        function setupServiceChangeListeners() {
            // Monitor service dropdown changes
            document.addEventListener('change', function(event) {
                if (event.target.matches('select[name="service_ids[]"]') || 
                    event.target.matches('input[name="service_quantities[]"]')) {
                    // Service or quantity changed, update calculations
                    handleServiceSelection(event.target);
                    setTimeout(updateTaxCalculations, 100); // Small delay to ensure DOM is updated
                }
            });

            // Monitor input changes for quantities
            document.addEventListener('input', function(event) {
                if (event.target.matches('input[name="service_quantities[]"]') ||
                    event.target.matches('input[name="product_quantities[]"]') ||
                    event.target.matches('input[name="product_prices[]"]')) {
                    setTimeout(updateTaxCalculations, 100);
                }
            });

            // Monitor when new service rows are added
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.classList.contains('service-row')) {
                            // New service row added, attach listeners
                            const serviceSelect = node.querySelector('select[name="service_ids[]"]');
                            const quantityInput = node.querySelector('input[name="service_quantities[]"]');

                            if (serviceSelect) {
                                serviceSelect.addEventListener('change', (e) => {
                                    handleServiceSelection(e.target);
                                    setTimeout(updateTaxCalculations, 100);
                                });
                            }

                            if (quantityInput) {
                                quantityInput.addEventListener('input', () => {
                                    setTimeout(updateTaxCalculations, 100);
                                });
                            }
                        }
                    });
                });
            });

            observer.observe(document.getElementById('servicesContainer'), {
                childList: true,
                subtree: true
            });
        }

        // --- Action button handlers ---
        function proceedWithInvoiceCreation() {
            document.getElementById('billingForm').submit();
        }

        function printInvoice() {
            const invoiceId = document.getElementById('printInvoiceBtn').dataset.invoiceId;
            if (invoiceId) {
                window.open(`/integrated-billing/print-invoice/${invoiceId}`, '_blank');
            } else {
                alert('Invoice ID not found. Cannot print.');
            }
        }

        function emailInvoice() {
            const invoiceId = document.getElementById('emailInvoiceBtn').dataset.invoiceId;
            if (invoiceId) {
                // In a real application, this would trigger an email sending process
                alert(`Email invoice functionality for Invoice ID: ${invoiceId} is being processed.`);
                // Example: fetch(`/integrated-billing/email-invoice/${invoiceId}`) ...
            } else {
                alert('Invoice ID not found. Cannot email.');
            }
        }

        function whatsappInvoice() {
            const invoiceId = document.getElementById('whatsappInvoiceBtn').dataset.invoiceId;
            if (invoiceId) {
                // In a real application, this would trigger a WhatsApp sharing process
                alert(`WhatsApp invoice functionality for Invoice ID: ${invoiceId} is being processed.`);
                // Example: fetch(`/integrated-billing/whatsapp-invoice/${invoiceId}`) ...
            } else {
                alert('Invoice ID not found. Cannot send via WhatsApp.');
            }
        }

        // Auto-select customer and load appointments if coming from appointment context menu
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-select customer if provided from appointment context menu
            {% if selected_customer %}
            const customerSelect = document.getElementById('client_id');
            if (customerSelect) {
                customerSelect.value = '{{ selected_customer.id }}';
                // Trigger change event to load customer packages and appointments
                customerSelect.dispatchEvent(new Event('change'));

                // Show notification about auto-selection
                const notification = document.createElement('div');
                notification.className = 'alert alert-info alert-dismissible fade show mt-3';
                notification.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Customer Auto-Selected:</strong> {{ selected_customer.full_name }}
                    {% if customer_appointments|length > 0 %}
                    <br><small>{{ customer_appointments|length }} pending appointment{{ 's' if customer_appointments|length != 1 else '' }} ready for billing</small>
                    {% endif %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                // Insert notification after the header
                const container = document.querySelector('.container-fluid');
                const firstRow = container.querySelector('.row');
                if (firstRow && firstRow.parentNode) {
                    firstRow.parentNode.insertBefore(notification, firstRow.nextSibling);
                } else {
                    // Fallback: insert at the top of the container
                    container.insertBefore(notification, container.firstChild);
                }
            }
            {% endif %}
        });

        // Function to populate services from customer appointments
        {% if customer_appointments %}
        function populateCustomerAppointments() {
            const appointments = {{ customer_appointments | tojson }};

            if (appointments && appointments.length > 0) {
                // Add success message
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show mt-3';
                successAlert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Services Ready for Billing:</strong> ${appointments.length} service${appointments.length !== 1 ? 's' : ''} from pending appointments
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                const container = document.querySelector('.container-fluid'); 
                const billingCard = container.querySelector('.card');
                billingCard.parentNode.insertBefore(successAlert, billingCard);

                // Auto-dismiss after 8 seconds
                setTimeout(() => {
                    if (successAlert.parentNode) {
                        successAlert.remove();
                    }
                }, 8000);
            }
        }
        {% endif %}

        // Helper function to update service price in the UI
        function updateServicePrice(serviceId, price) {
            const serviceRows = document.querySelectorAll('.service-row');
            let targetRow = null;

            // Find the row associated with the selected service ID
            serviceRows.forEach(row => {
                const selectElement = row.querySelector('select[name="service_ids[]"]');
                if (selectElement && selectElement.value === serviceId) {
                    targetRow = row;
                }
            });

            if (targetRow) {
                const priceInput = targetRow.querySelector('input[name="service_prices[]"]'); // Assuming such input exists or needs to be added
                if (priceInput) {
                    priceInput.value = parseFloat(price).toFixed(2);
                }
            } else if (serviceId === '') { // Handle deselection or "Select Service"
                // If no service is selected, we don't need to update a price input
            } else {
                // If the service is not found in existing rows, it might be a new one
                // Or an auto-populated one. We need to ensure the price is set correctly.
                // For auto-populated, the price should be handled by handleServiceSelection itself.
                console.log(`Could not find row for service ID: ${serviceId} to update price directly.`);
            }
        }


function handleServiceSelection(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];

    if (selectedOption && selectedOption.value) {
        // Extract price from data attribute or option text
        let price = selectedOption.dataset.price;

        if (!price) {
            // Try to extract price from option text
            const priceMatch = selectedOption.text.match(/₹([\d,]+\.?\d*)/);
            if (priceMatch) {
                price = parseFloat(priceMatch[1].replace(/,/g, ''));
                // Store it for future use
                selectedOption.dataset.price = price.toString();
            }
        }

        if (price) {
            console.log(`Service selected: ${selectedOption.text}, Price: ₹${price}`);
            updateServicePrice(selectElement.value, price);

            // Trigger calculation update
            setTimeout(() => {
                updateTaxCalculations();
            }, 50);
        } else {
            console.warn('No price found for selected service:', selectedOption.text);
            updateServicePrice(selectElement.value, '0.00');
        }
    } else {
        // Reset for empty selection
        updateServicePrice(selectElement.value, '0.00');
        setTimeout(() => {
            updateTaxCalculations();
        }, 50);
    }
}

// Initialize components and event listeners
        window.addServiceRow = addServiceRow;
        window.addAppointmentToBill = addAppointmentToBill;
        window.previewInvoice = previewInvoice;
        window.proceedWithInvoiceCreation = proceedWithInvoiceCreation;
        window.saveAsDraft = saveAsDraft;
        window.sendQuotation = sendQuotation;
        window.clearForm = clearForm;
        window.findEmptyServiceRow = findEmptyServiceRow;
        window.autoFillCurrentServices = autoFillCurrentServices;
        window.viewFullCustomerHistory = viewFullCustomerHistory;
        window.handleServiceSelection = handleServiceSelection;
        window.updateTaxCalculations = updateTaxCalculations;
        window.loadBatchesForProduct = loadBatchesForProduct;
        window.validateInventoryQuantity = validateInventoryQuantity;

        // Set up tax calculation listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up tax calculation listeners...');

            // Tax input listeners
            const taxInputs = document.querySelectorAll('.tax-input, .billing-input');
            taxInputs.forEach(input => {
                input.addEventListener('input', updateTaxCalculations);
                input.addEventListener('change', updateTaxCalculations);
            });

            // Service selection listeners
            document.addEventListener('change', function(e) {
                if (e.target.matches('select[name="service_ids[]"]') || 
                    e.target.matches('input[name="service_quantities[]"]') ||
                    e.target.matches('input[name="product_quantities[]"]') ||
                    e.target.matches('input[name="product_prices[]"]')) {
                    updateTaxCalculations();
                }
            });

            // Initial calculation
            updateTaxCalculations();

            console.log('Tax calculation listeners set up successfully');
        });
</script>
{% endblock %}