{% extends "base.html" %}

{% block title %}Integrated Billing & Service Management{% endblock %}

{% block extra_head %}
<style>
.billing-card {
    transition: all 0.3s ease;
}
.billing-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.package-deduction {
    color: #28a745;
    font-weight: 500;
}
.extra-charge {
    color: #dc3545;
    font-weight: 500;
}
.item-row {
    border-left: 3px solid transparent;
    padding-left: 10px;
    margin-bottom: 5px;
}
.item-row.package-item {
    border-left-color: #28a745;
    background-color: rgba(40, 167, 69, 0.1);
}
.item-row.extra-item {
    border-left-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.1);
}
.batch-info {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 2px;
}
.batch-warning {
    color: #dc3545;
    font-weight: 500;
}
.batch-success {
    color: #28a745;
    font-weight: 500;
}
.product-row {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 10px;
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-cash-register me-2 text-primary"></i>Integrated Billing & Service Management
            </h1>
            <p class="text-muted">Complete billing solution with package deductions, subscription management, and batch-wise inventory sales</p>
        </div>
    </div>

    <!-- Dashboard Stats -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card billing-card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Today's Revenue
                            </div>
                            <div class="h5 mb-0 font-weight-bold">₹{{ "{:,.2f}".format(today_revenue) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card billing-card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Total Revenue
                            </div>
                            <div class="h5 mb-0 font-weight-bold">₹{{ "{:,.2f}".format(total_revenue) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card billing-card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pending Amount
                            </div>
                            <div class="h5 mb-0 font-weight-bold">₹{{ "{:,.2f}".format(pending_amount) }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- New Invoice Creation -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-plus-circle me-2"></i>Create New Invoice
                    </h6>
                    <span class="badge badge-info">Services • Packages • Batch-wise Inventory</span>
                </div>
                <div class="card-body">
                    <form id="billingForm">
                        <!-- Customer Selection -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="client_id" class="form-label">Customer</label>
                                <select class="form-select" id="client_id" name="client_id" required>
                                    <option value="">Select Customer</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.full_name }} - {{ customer.phone }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Customer Packages</label>
                                <div id="customerPackages" class="alert alert-info">
                                    <small>Select a customer to view their active packages</small>
                                </div>
                            </div>
                        </div>

                        <!-- Services Section -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-spa me-2"></i>Services
                                <small class="text-muted">(Package deductions will be applied automatically)</small>
                            </h6>
                            <div id="servicesContainer">
                                <div class="service-row row mb-2">
                                    <div class="col-md-5">
                                        <select class="form-select" name="service_ids[]">
                                            <option value="">Select Service</option>
                                            {% for service in services %}
                                            <option value="{{ service.id }}" data-price="{{ service.price }}">
                                                {{ service.name }} - ₹{{ "{:,.2f}".format(service.price) }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control" name="service_quantities[]" placeholder="Qty" min="1" value="1" step="0.5">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" class="form-control" name="appointment_ids[]" placeholder="Appointment ID (Optional)">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-success btn-sm" onclick="addServiceRow()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Products & Inventory Section (Batch-wise) -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">
                                <i class="fas fa-shopping-bag me-2"></i>Products & Inventory 
                                <small class="text-muted">(Stock will be automatically reduced from batches - FIFO by expiry)</small>
                            </h6>
                            <div id="productsContainer">
                                <div class="product-row">
                                    <div class="row mb-2">
                                        <div class="col-md-4">
                                            <label class="form-label">Product</label>
                                            <select class="form-select product-select" name="product_ids[]" onchange="loadBatchesForProduct(this)">
                                                <option value="">Select Product</option>
                                                {% for product in inventory_items %}
                                                <option value="{{ product.id }}" data-name="{{ product.name }}">{{ product.name }} (Total Stock: {{ product.total_stock }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Batch (Auto-selected FIFO)</label>
                                            <select class="form-select batch-select" name="batch_ids[]" disabled>
                                                <option value="">Select Product First</option>
                                            </select>
                                            <div class="batch-info"></div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Quantity</label>
                                            <input type="number" class="form-control quantity-input" name="product_quantities[]" value="1" min="0.1" step="0.1" onchange="validateInventoryQuantity(this)">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Unit Price</label>
                                            <input type="number" class="form-control unit-price" name="product_prices[]" placeholder="Price" step="0.01" min="0" required>
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-success btn-sm w-100" onclick="addProductRow()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Tax & Billing Section -->
                        <div class="card mb-4 border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Professional Tax & Billing Calculations</h6>
                            </div>
                            <div class="card-body">
                                <!-- Tax Configuration -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="cgst_rate" class="form-label">CGST Rate (%)</label>
                                        <input type="number" class="form-control" id="cgst_rate" name="cgst_rate" value="9" step="0.01" min="0" max="50" onchange="updateTaxCalculations()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="sgst_rate" class="form-label">SGST Rate (%)</label>
                                        <input type="number" class="form-control" id="sgst_rate" name="sgst_rate" value="9" step="0.01" min="0" max="50" onchange="updateTaxCalculations()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="igst_rate" class="form-label">IGST Rate (%) <small class="text-muted">Interstate</small></label>
                                        <input type="number" class="form-control" id="igst_rate" name="igst_rate" value="0" step="0.01" min="0" max="50" onchange="updateTaxCalculations()">
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="is_interstate" name="is_interstate" onchange="toggleTaxType()">
                                            <label class="form-check-label" for="is_interstate">
                                                Interstate Transaction
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Discount and Additional Charges -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="discount_type" class="form-label">Discount Type</label>
                                        <select class="form-select" id="discount_type" name="discount_type" onchange="updateTaxCalculations()">
                                            <option value="amount">Amount (₹)</option>
                                            <option value="percentage">Percentage (%)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="discount_value" class="form-label">Discount Value</label>
                                        <input type="number" class="form-control" id="discount_value" name="discount_value" value="0" step="0.01" min="0" onchange="updateTaxCalculations()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="additional_charges" class="form-label">Additional Charges (₹)</label>
                                        <input type="number" class="form-control" id="additional_charges" name="additional_charges" value="0" step="0.01" min="0" onchange="updateTaxCalculations()">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="tips_amount" class="form-label">Tips (₹)</label>
                                        <input type="number" class="form-control" id="tips_amount" name="tips_amount" value="0" step="0.01" min="0" onchange="updateTaxCalculations()">
                                    </div>
                                </div>

                                <!-- Live Tax Calculation Display -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <div class="row text-center">
                                                    <div class="col-md-2">
                                                        <div class="border-end">
                                                            <h6 class="text-muted mb-1">Subtotal</h6>
                                                            <h5 class="mb-0" id="display_subtotal">₹0.00</h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end">
                                                            <h6 class="text-muted mb-1">Discount</h6>
                                                            <h5 class="mb-0 text-danger" id="display_discount">₹0.00</h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end">
                                                            <h6 class="text-muted mb-1">CGST</h6>
                                                            <h5 class="mb-0 text-info" id="display_cgst">₹0.00</h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end">
                                                            <h6 class="text-muted mb-1">SGST</h6>
                                                            <h5 class="mb-0 text-info" id="display_sgst">₹0.00</h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end">
                                                            <h6 class="text-muted mb-1">Additional</h6>
                                                            <h5 class="mb-0 text-warning" id="display_additional">₹0.00</h5>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div>
                                                            <h6 class="text-muted mb-1">Total</h6>
                                                            <h4 class="mb-0 text-success" id="display_total">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Additional notes for this invoice"></textarea>
                        </div>

                        <!-- Payment Processing Section -->
                        <div class="card mb-4 border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Processing</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="payment_terms" class="form-label">Payment Terms</label>
                                        <select class="form-select" id="payment_terms" name="payment_terms">
                                            <option value="immediate">Immediate</option>
                                            <option value="net_15">Net 15 Days</option>
                                            <option value="net_30">Net 30 Days</option>
                                            <option value="advance">Advance Payment</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="payment_method" class="form-label">Primary Payment Method</label>
                                        <select class="form-select" id="payment_method" name="payment_method">
                                            <option value="cash">Cash</option>
                                            <option value="card">Credit/Debit Card</option>
                                            <option value="upi">UPI Payment</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="cheque">Cheque</option>
                                            <option value="mixed">Multiple Methods</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Multi-payment method section (hidden by default) -->
                                <div id="multiPaymentSection" class="mt-3" style="display: none;">
                                    <h6>Split Payment Methods:</h6>
                                    <div id="paymentMethodsContainer">
                                        <!-- Dynamic payment method rows will be added here -->
                                    </div>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="addPaymentMethod()">
                                        <i class="fas fa-plus me-1"></i>Add Payment Method
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Action Buttons -->
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-primary btn-lg w-100 mb-2" onclick="previewInvoice()">
                                    <i class="fas fa-eye me-2"></i>Preview Invoice
                                </button>
                            </div>
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-success btn-lg w-100 mb-2">
                                    <i class="fas fa-file-invoice-dollar me-2"></i>Generate Professional Invoice
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-info w-100" onclick="saveAsDraft()" id="saveDraftBtn">
                                    <i class="fas fa-save me-2"></i>Save as Draft
                                </button>
                                <div id="draftSaveStatus"></div>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-warning w-100" onclick="sendQuotation()">
                                    <i class="fas fa-paper-plane me-2"></i>Send Quotation
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-secondary w-100" onclick="clearForm()">
                                    <i class="fas fa-undo me-2"></i>Clear Form
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Recent Invoices -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-file-invoice me-2"></i>Recent Invoices
                    </h6>
                </div>
                <div class="card-body">
                    {% if recent_invoices %}
                        {% for invoice in recent_invoices %}
                        <div class="d-flex justify-content-between align-items-center mb-3 p-2 border rounded">
                            <div>
                                <div class="font-weight-bold">{{ invoice.invoice_number }}</div>
                                <small class="text-muted">{{ invoice.customer.full_name }}</small>
                                <br>
                                <small class="text-muted">{{ invoice.invoice_date.strftime('%d %b %Y') }}</small>
                            </div>
                            <div class="text-end">
                                <div class="font-weight-bold text-success">₹{{ "{:,.2f}".format(invoice.total_amount) }}</div>
                                {% if invoice.packages_deduction > 0 %}
                                <small class="text-success">
                                    <i class="fas fa-gift"></i> ₹{{ "{:,.2f}".format(invoice.packages_deduction) }} saved
                                </small>
                                {% endif %}
                                <br>
                                <span class="badge badge-{{ 'success' if invoice.payment_status == 'paid' else 'warning' if invoice.payment_status == 'partial' else 'danger' }}">
                                    {{ invoice.payment_status.title() }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-file-invoice fa-3x mb-3"></i>
                            <p>No invoices created yet</p>
                        </div>
                    {% endif %}
                    </div>
            </div>
        </div>
    </div>
</div>

<!-- Professional Invoice Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">Invoice Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="viewInvoiceBtn" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-eye me-2"></i>View Invoice
                </a>
                <button type="button" id="printInvoiceBtn" class="btn btn-info" style="display: none;" onclick="printInvoice()">
                    <i class="fas fa-print me-2"></i>Print Invoice
                </button>
                <button type="button" id="emailInvoiceBtn" class="btn btn-success" style="display: none;" onclick="emailInvoice()">
                    <i class="fas fa-envelope me-2"></i>Email Invoice
                </button>
                <button type="button" id="whatsappInvoiceBtn" class="btn btn-warning" style="display: none;" onclick="whatsappInvoice()">
                    <i class="fab fa-whatsapp me-2"></i>WhatsApp Invoice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Professional Invoice Preview Modal -->
<div class="modal fade" id="invoicePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Professional Invoice Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoicePreviewBody" style="min-height: 600px;">
                <!-- Professional invoice preview will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="proceedWithInvoiceCreation()">
                    <i class="fas fa-check me-2"></i>Proceed with Invoice Creation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
var availableBatches = []; // Global array to hold all available batches

// Debug: Check if services are loaded in template
document.addEventListener('DOMContentLoaded', function() {
    const serviceSelects = document.querySelectorAll('select[name="service_ids[]"]');
    serviceSelects.forEach((select, index) => {
        console.log(`Service select ${index + 1} has ${select.options.length - 1} services loaded`);
        if (select.options.length <= 1) {
            console.error('Services dropdown is empty! Check backend data loading.');
        }
    });
});

// Add service row
function addServiceRow() {
    const container = document.getElementById('servicesContainer');
    const newRow = container.children[0].cloneNode(true);

    // Clear values
    newRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
    });

    // Change button to remove
    const button = newRow.querySelector('button');
    button.className = 'btn btn-danger btn-sm';
    button.innerHTML = '<i class="fas fa-minus"></i>';
    button.onclick = function() { this.closest('.service-row').remove(); };

    container.appendChild(newRow);
}

// Add product row
function addProductRow() {
    const container = document.getElementById('productsContainer');
    const newRow = container.children[0].cloneNode(true);

    // Clear values and reset state
    newRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
    });

    // Reset batch dropdown
    const batchSelect = newRow.querySelector('.batch-select');
    batchSelect.innerHTML = '<option value="">Select Product First</option>';
    batchSelect.disabled = true;

    // Reset info divs
    newRow.querySelector('.batch-info').innerHTML = '';
    newRow.querySelector('.available-stock').innerHTML = '';

    // Change button to remove
    const button = newRow.querySelector('button');
    button.className = 'btn btn-danger btn-sm w-100';
    button.innerHTML = '<i class="fas fa-minus"></i>';
    button.onclick = function() { this.closest('.product-row').remove(); };

    container.appendChild(newRow);
}

// Load available batches for consumption (FIFO ordering)
        function loadAvailableBatches() {
            fetch('/api/inventory/batches/for-consumption')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.batches) {
                        availableBatches = data.batches;
                        console.log('Available batches loaded:', availableBatches.length);
                    }
                })
                .catch(error => {
                    console.error('Error loading batches:', error);
                });
        }

        // Load batches for selected product (FIFO - First In First Out by expiry)
        function loadBatchesForProduct(productSelect) {
            const row = productSelect.closest('.row');
            const batchSelect = row.querySelector('.batch-select');
            const batchInfo = row.querySelector('.batch-info');
            const quantityInput = row.querySelector('input[name="product_quantities[]"]');
            const priceInput = row.querySelector('input[name="product_prices[]"]');

            const productId = parseInt(productSelect.value);

            // Reset batch selection
            batchSelect.innerHTML = '<option value="">Loading batches...</option>';
            batchSelect.disabled = true;
            batchInfo.innerHTML = '';

            if (!productId) {
                batchSelect.innerHTML = '<option value="">Select Product First</option>';
                return;
            }

            // Find batches for this product (FIFO by expiry date)
            const productBatches = availableBatches.filter(batch => {
                // Match by product_id which is more reliable than name comparison
                return batch.product_id === productId && batch.qty_available > 0;
            });

            console.log(`DEBUG: Product ID ${productId} has ${productBatches.length} available batches`);
            console.log('Available batches for this product:', productBatches);

            if (productBatches.length === 0) {
                batchSelect.innerHTML = '<option value="">No stock available</option>';
                batchInfo.innerHTML = '<span class="text-danger">⚠️ No stock available for this product</span>';
                // Clear previous quantity and price if any
                if (quantityInput) quantityInput.value = '0';
                if (priceInput) priceInput.value = '';
                return;
            }

            // Sort by expiry date (FIFO - First to expire first)
            productBatches.sort((a, b) => {
                if (!a.expiry_date && !b.expiry_date) return 0;
                if (!a.expiry_date) return 1;
                if (!b.expiry_date) return -1;
                return new Date(a.expiry_date) - new Date(b.expiry_date);
            });

            // Auto-select first batch (FIFO)
            const firstBatch = productBatches[0];
            batchSelect.innerHTML = `<option value="${firstBatch.id}" selected>${firstBatch.dropdown_display}</option>`;

            // Add other batches as options
            productBatches.slice(1).forEach(batch => {
                const option = document.createElement('option');
                option.value = batch.id;
                option.textContent = batch.dropdown_display;
                batchSelect.appendChild(option);
            });

            batchSelect.disabled = false;

            // Show batch info
            const expiryText = firstBatch.expiry_date ? 
                `Expires: ${new Date(firstBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
            batchInfo.innerHTML = `
                <strong>Auto-selected:</strong> ${firstBatch.batch_name}<br>
                <strong>Available:</strong> ${firstBatch.qty_available} ${firstBatch.unit}<br>
                <strong>${expiryText}</strong>
            `;

            // Set max quantity and placeholder
            if (quantityInput) {
                quantityInput.max = firstBatch.qty_available;
                quantityInput.placeholder = `Max: ${firstBatch.qty_available}`;
                quantityInput.value = '1'; // Reset quantity to 1
                validateInventoryQuantity(quantityInput); // Validate after setting max and default value
            }
            // Auto-populate price based on the first batch's selling price
            if (priceInput) {
                const sellingPrice = firstBatch.selling_price || firstBatch.unit_price || firstBatch.unit_cost || 0;
                priceInput.value = parseFloat(sellingPrice).toFixed(2);
                // Trigger calculation update after setting price
                updateTaxCalculations();
            }

            // Update batch info when batch selection changes
            batchSelect.addEventListener('change', function() {
                const selectedBatch = productBatches.find(b => b.id == this.value);
                if (selectedBatch) {
                    const expiryText = selectedBatch.expiry_date ? 
                        `Expires: ${new Date(selectedBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
                    batchInfo.innerHTML = `
                        <strong>Selected:</strong> ${selectedBatch.batch_name}<br>
                        <strong>Available:</strong> ${selectedBatch.qty_available} ${selectedBatch.unit}<br>
                        <strong>${expiryText}</strong>
                    `;
                    if (quantityInput) {
                        quantityInput.max = selectedBatch.qty_available;
                        quantityInput.placeholder = `Max: ${selectedBatch.qty_available}`;
                        quantityInput.value = '1'; // Reset quantity to 1 on batch change
                        validateInventoryQuantity(quantityInput); // Re-validate
                    }
                    // Auto-populate price based on selected batch's selling price
                    if (priceInput) {
                        const sellingPrice = selectedBatch.selling_price || selectedBatch.unit_price || selectedBatch.unit_cost || 0;
                        priceInput.value = parseFloat(sellingPrice).toFixed(2);
                        // Trigger calculation update
                        updateTaxCalculations();
                    }
                }
            });
        }


// Validate stock availability
function validateStock(quantityInput) {
    const productRow = quantityInput.closest('.product-row');
    const batchSelect = productRow.querySelector('.batch-select');
    const selectedOption = batchSelect.options[batchSelect.selectedIndex];
    const availableStockDiv = productRow.querySelector('.batch-info'); // Use batch-info div for feedback

    if (!selectedOption || selectedOption.value === "") {
        // No batch selected yet or product not selected
        if (availableStockDiv) {
            availableStockDiv.innerHTML = '<span class="text-muted">Select batch to see stock</span>';
        }
        quantityInput.setCustomValidity(''); // Clear any previous invalidity
        return;
    }

    const selectedBatchId = selectedOption.value;
    const selectedBatch = availableBatches.find(b => b.id == selectedBatchId);

    if (selectedBatch) {
        const available = parseFloat(selectedBatch.qty_available);
        const requested = parseFloat(quantityInput.value) || 0;

        if (requested > available) {
            quantityInput.style.borderColor = '#dc3545'; // Red border for invalid input
            if (availableStockDiv) {
                availableStockDiv.innerHTML = `<span class="batch-warning">Available: ${available} (Insufficient stock!)</span>`;
            }
            quantityInput.setCustomValidity('Insufficient stock');
        } else {
            quantityInput.style.borderColor = '#28a745'; // Green border for valid input
             if (availableStockDiv) {
                const expiryText = selectedBatch.expiry_date ? 
                    `Expires: ${new Date(selectedBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
                availableStockDiv.innerHTML = `
                    <strong>Selected:</strong> ${selectedBatch.batch_name}<br>
                    <strong>Available:</strong> ${selectedBatch.qty_available} ${selectedBatch.unit}<br>
                    <strong>${expiryText}</strong>
                `;
            }
            quantityInput.setCustomValidity('');
        }
    } else {
        // If selected batch is not found in availableBatches, reset
        quantityInput.style.borderColor = '';
        if (availableStockDiv) {
            availableStockDiv.innerHTML = '';
        }
        quantityInput.setCustomValidity('');
    }
}

// Global variable to store customer package data for benefit calculations
let customerPackageData = null;

// Load customer packages and auto-populate services
document.getElementById('client_id').addEventListener('change', function() {
    const clientId = this.value;
    const packagesDiv = document.getElementById('customerPackages');

    if (!clientId) {
        packagesDiv.innerHTML = '<small>Select a customer to view their active packages</small>';
        customerPackageData = null;
        updateTaxCalculations(); // Update totals when customer is deselected
        return;
    }

    // Show loading state
    packagesDiv.innerHTML = '<small class="text-info"><i class="fas fa-spinner fa-spin"></i> Loading packages...</small>';

    fetch(`/integrated-billing/customer-packages/${clientId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Package data received:', data); // Debug log
            customerPackageData = data; // Store globally for package benefit calculations

            if (data.error) {
                packagesDiv.innerHTML = `<small class="text-danger">Error: ${data.error}</small>`;
                customerPackageData = null;
                return;
            }

            if (data.packages && data.packages.length > 0) {
                let html = '<div class="alert alert-success"><strong>Active Packages:</strong><br>';
                data.packages.forEach(pkg => {
                    html += `<div class="badge badge-success me-1 mb-1">${pkg.package_name}</div>`;

                    // Display package details based on type
                    pkg.sessions.forEach(session => {
                        if (session.benefit_type === 'unlimited') {
                            html += `<small class="d-block text-success">${session.service_name}: ${session.description}</small>`;
                        } else if (session.benefit_type === 'prepaid') {
                            html += `<small class="d-block text-info">${session.description}</small>`;
                        } else if (session.sessions_remaining > 0) {
                            html += `<small class="d-block">${session.service_name}: ${session.sessions_remaining} sessions left</small>`;
                        }
                    });
                });

                // Add summary if available
                if (data.summary) {
                    html += `<hr><small class="text-muted">Total Active: ${data.summary.total_active_packages} packages</small>`;
                }
                html += '</div>';

                packagesDiv.innerHTML = html;
            } else {
                packagesDiv.innerHTML = '<small class="text-muted">No active packages found</small>';
            }

            // Update calculations to apply package benefits
            updateTaxCalculations();
        })
        .catch(error => {
            console.error('Error loading packages:', error);
            packagesDiv.innerHTML = '<small class="text-danger">Error loading packages. Please try again.</button>';
            customerPackageData = null;
        });
});

// Auto-populate customer services when page loads with pre-selected customer
document.addEventListener('DOMContentLoaded', function() {
    const selectedCustomerId = document.getElementById('client_id').value;
    if (selectedCustomerId) {
        console.log('Auto-populating services for pre-selected customer:', selectedCustomerId);
        autoPopulateCustomerServices(selectedCustomerId);
    }
});

// Function to auto-populate customer's historical services
function autoPopulateCustomerServices(customerId) {
    if (!customerId) return;

    // Check if customer_services data is passed from backend
    const customerServicesData = {{ customer_services | safe }};
    
    if (customerServicesData && customerServicesData.length > 0) {
        console.log('Auto-populating services for customer:', customerServicesData);
        
        // Clear existing service rows except the first one
        const servicesContainer = document.getElementById('servicesContainer');
        const firstRow = servicesContainer.querySelector('.service-row');
        servicesContainer.innerHTML = '';
        servicesContainer.appendChild(firstRow);
        
        // Populate services
        customerServicesData.forEach((service, index) => {
            if (index === 0) {
                // Use first row
                const firstServiceSelect = firstRow.querySelector('select[name="service_ids[]"]');
                firstServiceSelect.value = service.id;
                
                // Add visual indicator
                firstRow.style.borderLeft = '3px solid #28a745';
                firstRow.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
                firstRow.style.padding = '10px';
                firstRow.style.borderRadius = '5px';
                firstRow.style.marginBottom = '10px';
                
                // Add label
                const existingLabel = firstRow.querySelector('.auto-service-label');
                if (!existingLabel) {
                    const label = document.createElement('small');
                    label.className = 'auto-service-label text-success fw-bold';
                    label.innerHTML = '<i class="fas fa-history me-1"></i>Previously booked service';
                    firstRow.appendChild(label);
                }
            } else {
                // Add new rows for additional services
                addServiceRowWithData(service);
            }
        });
        
        // Show notification
        const notification = document.createElement('div');
        notification.className = 'alert alert-info alert-dismissible fade show';
        notification.innerHTML = `
            <i class="fas fa-info-circle me-2"></i>
            <strong>Auto-populated services:</strong> Found ${customerServicesData.length} services this customer has previously booked.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const form = document.getElementById('billingForm');
        form.insertBefore(notification, form.firstChild);
        
        // Auto-dismiss notification after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
        
        // Update calculations
        updateTaxCalculations();
    }
}

// Function to add a service row with pre-filled data
function addServiceRowWithData(serviceData) {
    const container = document.getElementById('servicesContainer');
    const newRow = container.children[0].cloneNode(true);

    // Set service value
    const serviceSelect = newRow.querySelector('select[name="service_ids[]"]');
    serviceSelect.value = serviceData.id;
    
    // Set default quantity
    const quantityInput = newRow.querySelector('input[name="service_quantities[]"]');
    quantityInput.value = '1';
    
    // Clear appointment ID
    const appointmentInput = newRow.querySelector('input[name="appointment_ids[]"]');
    appointmentInput.value = '';
    
    // Style the row to indicate it's auto-populated
    newRow.style.borderLeft = '3px solid #28a745';
    newRow.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
    newRow.style.padding = '10px';
    newRow.style.borderRadius = '5px';
    newRow.style.marginBottom = '10px';
    
    // Change button to remove
    const button = newRow.querySelector('button');
    button.className = 'btn btn-danger btn-sm';
    button.innerHTML = '<i class="fas fa-minus"></i>';
    button.onclick = function() { this.closest('.service-row').remove(); updateTaxCalculations(); };
    
    // Add label
    const label = document.createElement('small');
    label.className = 'auto-service-label text-success fw-bold d-block';
    label.innerHTML = '<i class="fas fa-history me-1"></i>Previously booked service';
    newRow.appendChild(label);

    container.appendChild(newRow);
}

// Professional Tax Calculation Functions
function updateTaxCalculations() {
    const servicesSubtotal = calculateServicesSubtotal();
    const inventorySubtotal = calculateInventorySubtotal();
    const grossSubtotal = servicesSubtotal + inventorySubtotal;

    // Get discount
    const discountType = document.getElementById('discount_type').value;
    const discountValue = parseFloat(document.getElementById('discount_value').value) || 0;
    let discountAmount = 0;

    if (discountType === 'percentage') {
        discountAmount = (grossSubtotal * discountValue) / 100;
    } else {
        // Amount discount
        discountAmount = discountValue;
    }
    // Ensure discount amount doesn't exceed gross subtotal
    discountAmount = Math.min(discountAmount, grossSubtotal);


    const taxableAmount = grossSubtotal - discountAmount;

    // Calculate taxes
    const isInterstate = document.getElementById('is_interstate').checked;
    let cgstAmount = 0, sgstAmount = 0, igstAmount = 0;

    if (isInterstate) {
        const igstRate = parseFloat(document.getElementById('igst_rate').value) || 0;
        igstAmount = (taxableAmount * igstRate) / 100;
    } else {
        const cgstRate = parseFloat(document.getElementById('cgst_rate').value) || 0;
        const sgstRate = parseFloat(document.getElementById('sgst_rate').value) || 0;
        cgstAmount = (taxableAmount * cgstRate) / 100;
        sgstAmount = (taxableAmount * sgstRate) / 100;
    }

    const additionalCharges = parseFloat(document.getElementById('additional_charges').value) || 0;
    const tipsAmount = parseFloat(document.getElementById('tips_amount').value) || 0;

    const totalAmount = taxableAmount + cgstAmount + sgstAmount + igstAmount + additionalCharges + tipsAmount;

    // Update display
    document.getElementById('display_subtotal').textContent = `₹${grossSubtotal.toFixed(2)}`;
    document.getElementById('display_discount').textContent = `₹${discountAmount.toFixed(2)}`;
    document.getElementById('display_cgst').textContent = `₹${(cgstAmount + igstAmount).toFixed(2)}`;
    document.getElementById('display_sgst').textContent = `₹${sgstAmount.toFixed(2)}`;
    document.getElementById('display_additional').textContent = `₹${(additionalCharges + tipsAmount).toFixed(2)}`;
    document.getElementById('display_total').textContent = `₹${totalAmount.toFixed(2)}`;
}

function calculateServicesSubtotal() {
    let total = 0;
    document.querySelectorAll('.service-row').forEach((row, index) => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const quantityInput = row.querySelector('input[name="service_quantities[]"]');

        if (serviceSelect && serviceSelect.value && quantityInput && quantityInput.value) {
            const originalPrice = parseFloat(serviceSelect.options[serviceSelect.selectedIndex].dataset.price) || 0;
            const quantity = parseFloat(quantityInput.value) || 1; // Default to 1 if empty
            const serviceId = parseInt(serviceSelect.value);
            const serviceName = serviceSelect.options[serviceSelect.selectedIndex].text;

            // Check if customer has package benefits for this service
            let finalPrice = originalPrice * quantity;
            let packageBenefit = null;

            if (customerPackageData && customerPackageData.packages) {
                packageBenefit = checkServicePackageBenefit(serviceId, serviceName, originalPrice, quantity);
                if (packageBenefit) {
                    finalPrice = packageBenefit.finalPrice;

                    // Update service display to show package benefit
                    updateServiceDisplayWithBenefit(row, packageBenefit, index);
                }
            }

            if (!packageBenefit) {
                // Clear any previous package benefit display
                clearServiceBenefitDisplay(row, index);
            }

            total += finalPrice;
        }
    });
    return total;
}

// Check if customer has package benefits for a specific service
function checkServicePackageBenefit(serviceId, serviceName, originalPrice, quantity) {
    if (!customerPackageData || !customerPackageData.packages) {
        return null;
    }

    // Ensure quantity is at least 1
    quantity = Math.max(1, quantity);

    // Check all packages for this service (priority: unlimited > service_package > prepaid)
    for (const pkg of customerPackageData.packages) {
        if (!pkg.is_active) continue;

        // Check unlimited membership first (highest priority)
        if (pkg.package_type === 'membership') {
            for (const session of pkg.sessions) {
                if (session.benefit_type === 'unlimited' && session.service_id === serviceId) {
                    return {
                        type: 'unlimited',
                        packageName: pkg.package_name,
                        originalPrice: originalPrice * quantity,
                        finalPrice: 0, // FREE
                        discount: originalPrice * quantity,
                        description: `FREE via ${pkg.package_name} (Unlimited)`
                    };
                }
            }
        }

        // Check service package benefits (specific service sessions) with quantity awareness
        if (pkg.package_type === 'service_package') {
            for (const session of pkg.sessions) {
                if (session.service_id === serviceId && session.sessions_remaining > 0) {
                    const pricePerSession = originalPrice; // Service price is for one session
                    const sessionsToCover = Math.min(quantity, session.sessions_remaining);
                    const sessionsToPayFor = Math.max(0, quantity - sessionsToCover);

                    const coveredAmount = sessionsToCover * pricePerSession;
                    const finalPrice = sessionsToPayFor * pricePerSession;

                    // Ensure calculations are accurate
                    const totalServicePrice = originalPrice * quantity;
                    const actualDiscount = Math.min(coveredAmount, totalServicePrice);
                    const actualFinalPrice = Math.max(0, totalServicePrice - actualDiscount);

                    if (sessionsToPayFor > 0) {
                        // Partial coverage - some sessions free, some charged
                        return {
                            type: 'service_package_partial',
                            packageName: pkg.package_name,
                            originalPrice: totalServicePrice,
                            finalPrice: actualFinalPrice,
                            discount: actualDiscount,
                            description: `${sessionsToCover} of ${quantity} sessions FREE, ${sessionsToPayFor} charged via ${pkg.package_name}`,
                            sessionsRemaining: session.sessions_remaining,
                            sessionsCovered: sessionsToCover,
                            sessionsToPayFor: sessionsToPayFor
                        };
                    } else {
                        // Full coverage - all sessions free
                        return {
                            type: 'service_package_full',
                            packageName: pkg.package_name,
                            originalPrice: totalServicePrice,
                            finalPrice: 0,
                            discount: totalServicePrice,
                            description: `All ${sessionsToCover} sessions FREE via ${pkg.package_name} (${session.sessions_remaining - sessionsToCover} remaining)`,
                            sessionsRemaining: session.sessions_remaining,
                            sessionsCovered: sessionsToCover,
                            sessionsToPayFor: 0
                        };
                    }
                }
            }
        }

        // Check prepaid package benefits (can cover any service)
        if (pkg.package_type === 'prepaid') {
            for (const session of pkg.sessions) {
                if (session.benefit_type === 'prepaid' && session.balance_remaining > 0) {
                    const serviceTotal = originalPrice * quantity;
                    if (session.balance_remaining >= serviceTotal) {
                        // Full coverage
                        return {
                            type: 'prepaid_full',
                            packageName: pkg.package_name,
                            originalPrice: serviceTotal,
                            finalPrice: 0, // FREE
                            discount: serviceTotal,
                            description: `FREE via ${pkg.package_name} (₹${session.balance_remaining} credit)`
                        };
                    } else {
                        // Partial coverage
                        return {
                            type: 'prepaid_partial',
                            packageName: pkg.package_name,
                            originalPrice: serviceTotal,
                            finalPrice: serviceTotal - session.balance_remaining,
                            discount: session.balance_remaining,
                            description: `₹${session.balance_remaining} off via ${pkg.package_name}`
                        };
                    }
                }
            }
        }
    }

    return null;
}

// Update service display to show package benefit
function updateServiceDisplayWithBenefit(row, benefit, index) {
    // Add package benefit indicator to the service row
    let benefitDisplay = row.querySelector('.package-benefit-display');
    if (!benefitDisplay) {
        benefitDisplay = document.createElement('div');
        benefitDisplay.className = 'package-benefit-display mt-1';
        row.appendChild(benefitDisplay);
    }

    if (benefit.finalPrice === 0) {
        // Full coverage - all sessions free
        benefitDisplay.innerHTML = `
            <small class="text-success fw-bold">
                <i class="fas fa-gift me-1"></i>FREE - ${benefit.description}
                <br><strike class="text-muted">₹${benefit.originalPrice.toFixed(2)}</strike>
                <span class="badge bg-success ms-1">100% Covered</span>
            </small>
        `;
        benefitDisplay.style.backgroundColor = '#d4edda';
        benefitDisplay.style.border = '1px solid #28a745';
        benefitDisplay.style.padding = '6px 10px';
        benefitDisplay.style.borderRadius = '6px';
    } else {
        // Partial coverage or discount
        const isPartialCoverage = benefit.sessionsCovered && benefit.sessionsToPayFor;
        const coveragePercent = Math.round((benefit.discount / benefit.originalPrice) * 100);

        benefitDisplay.innerHTML = `
            <small class="fw-bold">
                <i class="fas fa-percentage me-1 text-info"></i>${benefit.description}
                <br>
                ${isPartialCoverage ? 
                    `<span class="text-success">✓ Free: ${benefit.sessionsCovered} sessions</span> | <span class="text-warning">₹ Pay: ${benefit.sessionsToPayFor} sessions</span><br>` : 
                    ''
                }
                <span class="text-dark">Pay: ₹${benefit.finalPrice.toFixed(2)}</span> 
                <strike class="text-muted small">₹${benefit.originalPrice.toFixed(2)}</strike>
                <span class="badge bg-info ms-1">${coveragePercent}% Saved</span>
                <br><span class="text-success small">Package Discount: ₹${benefit.discount.toFixed(2)}</span>
            </small>
        `;
        benefitDisplay.style.backgroundColor = '#e3f2fd';
        benefitDisplay.style.border = '1px solid #2196f3';
        benefitDisplay.style.padding = '6px 10px';
        benefitDisplay.style.borderRadius = '6px';
    }
}

// Clear service benefit display
function clearServiceBenefitDisplay(row, index) {
    const benefitDisplay = row.querySelector('.package-benefit-display');
    if (benefitDisplay) {
        benefitDisplay.remove();
    }
}

function calculateInventorySubtotal() {
    let total = 0;
    document.querySelectorAll('.product-row').forEach(row => {
        const quantityInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.unit-price');

        if (quantityInput && priceInput && quantityInput.value && priceInput.value) {
            const quantity = parseFloat(quantityInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            total += quantity * price;
        }
    });
    return total;
}

function toggleTaxType() {
    const isInterstate = document.getElementById('is_interstate').checked;
    const cgstInput = document.getElementById('cgst_rate');
    const sgstInput = document.getElementById('sgst_rate');
    const igstInput = document.getElementById('igst_rate');

    if (isInterstate) {
        cgstInput.value = 0;
        sgstInput.value = 0;
        cgstInput.disabled = true;
        sgstInput.disabled = true;
        igstInput.disabled = false;
        if (igstInput.value === '0') igstInput.value = '18'; // Default IGST to 18% if not set
    } else {
        igstInput.value = 0;
        igstInput.disabled = true;
        cgstInput.disabled = false;
        sgstInput.disabled = false;
        if (cgstInput.value === '0') cgstInput.value = '9'; // Default CGST to 9% if not set
        if (sgstInput.value === '0') sgstInput.value = '9'; // Default SGST to 9% if not set
    }

    updateTaxCalculations();
}

// Payment Method Management
function addPaymentMethod() {
    const container = document.getElementById('paymentMethodsContainer');
    const methodCount = container.children.length;

    const methodRow = document.createElement('div');
    methodRow.className = 'row mb-2 payment-method-row';
    methodRow.innerHTML = `
        <div class="col-md-4">
            <select class="form-select" name="split_payment_methods[]" required>
                <option value="">Select Method</option>
                <option value="cash">Cash</option>
                <option value="card">Card</option>
                <option value="upi">UPI</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="cheque">Cheque</option>
            </select>
        </div>
        <div class="col-md-4">
            <input type="number" class="form-control" name="split_payment_amounts[]" placeholder="Amount" step="0.01" min="0" required>
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" name="split_payment_refs[]" placeholder="Reference/Transaction ID">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger btn-sm" onclick="removePaymentMethod(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;

    container.appendChild(methodRow);
}

function removePaymentMethod(button) {
    button.closest('.payment-method-row').remove();
}

// Invoice Actions
function previewInvoice() {
    // Get the modal and elements
    const modal = new bootstrap.Modal(document.getElementById('invoicePreviewModal'));
    const previewBody = document.getElementById('invoicePreviewBody');

    // Collect current invoice data from the form
    const customerId = document.getElementById('client_id').value;
    const customerSelect = document.getElementById('client_id');
    const customerName = customerSelect.options[customerSelect.selectedIndex].text;

    const servicesSubtotal = calculateServicesSubtotal();
    const inventorySubtotal = calculateInventorySubtotal();
    const grossSubtotal = servicesSubtotal + inventorySubtotal;
    const discountType = document.getElementById('discount_type').value;
    const discountValue = parseFloat(document.getElementById('discount_value').value) || 0;
    const additionalCharges = parseFloat(document.getElementById('additional_charges').value) || 0;
    const tipsAmount = parseFloat(document.getElementById('tips_amount').value) || 0;
    const isInterstate = document.getElementById('is_interstate').checked;
    const cgstRate = parseFloat(document.getElementById('cgst_rate').value) || 0;
    const sgstRate = parseFloat(document.getElementById('sgst_rate').value) || 0;
    const igstRate = parseFloat(document.getElementById('igst_rate').value) || 0;

    const invoiceDataForPreview = {
        customer_name: customerName.split(' - ')[0], // Extract name from "Name - Phone"
        customer_id: customerId,
        services: [],
        inventory_items: [],
        discount_type: discountType,
        discount_value: discountValue,
        additional_charges: additionalCharges,
        tips_amount: tipsAmount,
        is_interstate: isInterstate,
        cgst_rate: cgstRate,
        sgst_rate: sgstRate,
        igst_rate: igstRate,
        notes: document.getElementById('notes').value
    };

    // Collect service items
    document.querySelectorAll('.service-row').forEach((row, index) => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const quantityInput = row.querySelector('input[name="service_quantities[]"]');
        const appointmentIdInput = row.querySelector('input[name="appointment_ids[]"]');
        const serviceName = serviceSelect.options[serviceSelect.selectedIndex].text;
        const originalPrice = parseFloat(serviceSelect.options[serviceSelect.selectedIndex].dataset.price) || 0;
        const quantity = parseFloat(quantityInput.value) || 1;
        const appointmentId = appointmentIdInput.value;

        if (serviceSelect.value) {
            // Check for package benefits
            const packageBenefit = checkServicePackageBenefit(parseInt(serviceSelect.value), serviceName, originalPrice, quantity);
            let finalPrice = originalPrice * quantity;
            let discount = 0;
            let benefitDescription = '';

            if (packageBenefit) {
                finalPrice = packageBenefit.finalPrice;
                discount = packageBenefit.discount;
                benefitDescription = packageBenefit.description;
            }

            invoiceDataForPreview.services.push({
                name: serviceName,
                quantity: quantity,
                unit_price: originalPrice,
                subtotal: originalPrice * quantity,
                final_price: finalPrice,
                discount: discount,
                package_benefit: benefitDescription
            });
        }
    });

    // Collect inventory items
    document.querySelectorAll('.product-row').forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const batchSelect = row.querySelector('.batch-select');
        const quantityInput = row.querySelector('.quantity-input');
        const priceInput = row.querySelector('.unit-price');

        if (productSelect.value && batchSelect.value && quantityInput.value && priceInput.value) {
            const productName = productSelect.options[productSelect.selectedIndex].text.split(' (')[0]; // Get name without stock info
            const batchName = batchSelect.options[batchSelect.selectedIndex].text;
            const quantity = parseFloat(quantityInput.value) || 0;
            const unitPrice = parseFloat(priceInput.value) || 0;
            const subtotal = quantity * unitPrice;

            invoiceDataForPreview.inventory_items.push({
                name: productName,
                batch: batchName,
                quantity: quantity,
                unit_price: unitPrice,
                subtotal: subtotal
            });
        }
    });

    // Make the API call to get the preview HTML
    fetch('/api/invoice-preview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(invoiceDataForPreview)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.preview_html) {
            previewBody.innerHTML = data.preview_html;
            modal.show();
        } else {
            // Show error in the result modal instead of the preview modal
            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            document.getElementById('resultModalTitle').textContent = 'Error generating preview';
            document.getElementById('resultModalTitle').className = 'text-danger';
            document.getElementById('resultModalBody').innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>${data.error || 'Failed to load preview content.'}</div>`;
            resultModal.show();
        }
    })
    .catch(error => {
        console.error('Error fetching invoice preview:', error);
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        document.getElementById('resultModalTitle').textContent = 'Error';
        document.getElementById('resultModalTitle').className = 'text-danger';
        document.getElementById('resultModalBody').innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Failed to generate invoice preview. ${error.message}</div>`;
        resultModal.show();
    });
}

function saveAsDraft() {
    // Get the save draft button and status div
    const saveButton = document.getElementById('saveDraftBtn');
    const statusDiv = document.getElementById('draftSaveStatus');
    const originalText = saveButton.innerHTML;

    // Show loading state
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    saveButton.disabled = true;
    statusDiv.innerHTML = '';

    // Prepare form data
    const formData = new FormData(document.getElementById('billingForm'));
    formData.append('save_as_draft', 'true');

    fetch('/integrated-billing/save-draft', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        // Reset button state
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;

        if (data.success) {
            // Show success message
            statusDiv.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show mt-2">
                    <i class="fas fa-check-circle me-2"></i>Draft saved successfully! ${data.items_saved ? `(${data.items_saved} items)` : ''}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            // Auto-hide alert after 4 seconds
            setTimeout(() => {
                const alert = statusDiv.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 4000);
        } else {
            // Show error message
            statusDiv.innerHTML = `
                <div class="alert alert-danger alert-dismissible fade show mt-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>Error: ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
    })
    .catch(error => {
        // Reset button state
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;

        console.error('Draft save error:', error);

        // Show error message
        statusDiv.innerHTML = `
            <div class="alert alert-danger alert-dismissible fade show mt-2">
                <i class="fas fa-exclamation-triangle me-2"></i>Network error while saving draft. Please check your connection.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    });
}

function sendQuotation() {
    // Convert current form to quotation
    alert('Quotation feature coming soon!');
}

function clearForm() {
    if (confirm('Are you sure you want to clear the entire form? All entered data will be lost.')) {
        document.getElementById('billingForm').reset();
        updateTaxCalculations();

        // Clear all dynamic elements
        const productRows = document.querySelectorAll('.product-row');
        productRows.forEach((row, index) => {
            if (index > 0) {
                row.remove();
            }
        });

        document.getElementById('customerPackages').innerHTML = '<small>Select a customer to view their active packages</small>';
    }
}

// Payment Method Change Handler
document.getElementById('payment_method').addEventListener('change', function() {
    const multiPaymentSection = document.getElementById('multiPaymentSection');
    if (this.value === 'mixed') {
        multiPaymentSection.style.display = 'block';
        addPaymentMethod(); // Add first payment method row
    } else {
        multiPaymentSection.style.display = 'none';
        document.getElementById('paymentMethodsContainer').innerHTML = '';
    }
});

// Auto-update calculations when any input changes
document.addEventListener('input', function(e) {
    if (e.target.matches('input[name="service_quantities[]"], .quantity-input, .unit-price, #discount_value, #additional_charges, #tips_amount')) {
        updateTaxCalculations();
    }
});

document.addEventListener('change', function(e) {
    if (e.target.matches('select[name="service_ids[]"], #discount_type, #cgst_rate, #sgst_rate, #igst_rate')) {
        updateTaxCalculations();
    }
});

// Enhanced form submission with professional features
document.getElementById('billingForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Get submit button and show loading state
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Invoice...';
    submitBtn.disabled = true;

    // Basic validation for required fields (example: customer)
    if (!document.getElementById('client_id').value) {
        alert('Please select a customer.');
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        return;
    }

    // Check if at least one service or product is selected
    const serviceSelected = Array.from(document.querySelectorAll('select[name="service_ids[]"]')).some(select => select.value);
    const productSelected = Array.from(document.querySelectorAll('select[name="product_ids[]"]')).some(select => select.value);

    if (!serviceSelected && !productSelected) {
        alert('Please select at least one service or product to create an invoice.');
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        return;
    }

    // Validate all stock quantities before submission
    const quantityInputs = document.querySelectorAll('.quantity-input');
    let hasStockErrors = false;

    quantityInputs.forEach(input => {
        const productRow = input.closest('.product-row');
        const productSelect = productRow.querySelector('.product-select');

        // Only validate if product is selected
        if (productSelect && productSelect.value) {
            validateInventoryQuantity(input);
            if (!input.checkValidity()) {
                hasStockErrors = true;
            }
        }
    });

    if (hasStockErrors) {
        alert('Please check stock availability for all products before submitting.');
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        return;
    }

    const formData = new FormData(this);

    // Add tax calculation data to form data for submission
    formData.append('cgst_amount', (parseFloat(document.getElementById('display_cgst').textContent.replace('₹', '').replace(/,/g, '')) || 0));
    formData.append('sgst_amount', (parseFloat(document.getElementById('display_sgst').textContent.replace('₹', '').replace(/,/g, '')) || 0));
    formData.append('igst_amount', (parseFloat(document.getElementById('display_cgst').textContent.replace('₹', '').replace(/,/g, '')) || 0)); // Assuming IGST is displayed in CGST placeholder if interstate
    formData.append('discount_amount', (parseFloat(document.getElementById('display_discount').textContent.replace('₹', '').replace(/,/g, '')) || 0));
    formData.append('additional_charges_display', (parseFloat(document.getElementById('display_additional').textContent.replace('₹', '').replace(/,/g, '')) || 0));
    formData.append('total_amount', (parseFloat(document.getElementById('display_total').textContent.replace('₹', '').replace(/,/g, '')) || 0));

    fetch('/integrated-billing/create-professional', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Always reset button state first
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        const title = document.getElementById('resultModalTitle');
        const body = document.getElementById('resultModalBody');
        const viewBtn = document.getElementById('viewInvoiceBtn');
        const printBtn = document.getElementById('printInvoiceBtn');
        const emailBtn = document.getElementById('emailInvoiceBtn');
        const whatsappBtn = document.getElementById('whatsappInvoiceBtn');

        // Reset all action buttons display
        viewBtn.style.display = 'none';
        printBtn.style.display = 'none';
        emailBtn.style.display = 'none';
        whatsappBtn.style.display = 'none';


        if (data.success) {
            title.textContent = 'Professional Invoice Created Successfully!';
            title.className = 'text-success';

            let message = `<div class="text-success">
                <i class="fas fa-check-circle fa-3x mb-3"></i>
                <h4>${data.message}</h4>
                <div class="row mt-3">
                    <div class="col-6"><strong>Invoice Number:</strong></div>
                    <div class="col-6">${data.invoice_number}</div>
                </div>
                <div class="row">
                    <div class="col-6"><strong>Total Amount:</strong></div>
                    <div class="col-6">₹${data.total_amount.toLocaleString('en-IN')}</div>
                </div>
                <div class="row">
                    <div class="col-6"><strong>CGST:</strong></div>
                    <div class="col-6">₹${data.cgst_amount.toLocaleString('en-IN')}</div>
                </div>
                <div class="row">
                    <div class="col-6"><strong>SGST:</strong></div>
                    <div class="col-6">₹${data.sgst_amount.toLocaleString('en-IN')}</div>
                </div>
            `;

            if (data.deductions_applied > 0) {
                message += `<div class="row text-success">
                    <div class="col-6"><strong>Package Deductions:</strong></div>
                    <div class="col-6">₹${data.deductions_applied.toLocaleString('en-IN')}</div>
                </div>`;
            }

            if (data.stock_reduced && data.stock_reduced.length > 0) {
                message += `<div class="row text-info mt-2">
                    <div class="col-12"><small><strong>Stock Reduced:</strong></small></div>
                    <ul class="mb-0">`;
                data.stock_reduced.forEach(item => {
                    message += `<li><small>${item.product_name} - Batch ${item.batch_name}: ${item.quantity_reduced} ${item.unit}</small></li>`;
                });
                message += `</ul></div>`;
            }

            message += '</div>';
            body.innerHTML = message;

            viewBtn.style.display = 'block';
            viewBtn.href = `/integrated-billing/invoice/${data.invoice_id}`;
            printBtn.style.display = 'block';
            emailBtn.style.display = 'block';
            whatsappBtn.style.display = 'block';

            // Store invoice ID for action buttons
            viewBtn.dataset.invoiceId = data.invoice_id;
            printBtn.dataset.invoiceId = data.invoice_id;
            emailBtn.dataset.invoiceId = data.invoice_id;
            whatsappBtn.dataset.invoiceId = data.invoice_id;


            // Reset form after successful submission
            clearForm();

        } else {
            title.textContent = 'Error Creating Professional Invoice';
            title.className = 'text-danger';
            body.innerHTML = `<div class="text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <p>${data.message}</p>
            </div>`;
            viewBtn.style.display = 'none';
        }

        modal.show();
    })
    .catch(error => {
        console.error('Submission Error:', error);

        // Ensure button state is reset
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;

        const modal = new bootstrap.Modal(document.getElementById('resultModal'));
        const title = document.getElementById('resultModalTitle');
        const body = document.getElementById('resultModalBody');
        const viewBtn = document.getElementById('viewInvoiceBtn');
        const printBtn = document.getElementById('printInvoiceBtn');
        const emailBtn = document.getElementById('emailInvoiceBtn');
        const whatsappBtn = document.getElementById('whatsappInvoiceBtn');

        // Hide action buttons on error
        viewBtn.style.display = 'none';
        printBtn.style.display = 'none';
        emailBtn.style.display = 'none';
        whatsappBtn.style.display = 'none';

        title.textContent = 'Invoice Creation Failed';
        title.className = 'text-danger';
        body.innerHTML = `<div class="text-danger">
            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
            <h5>Invoice creation failed</h5>
            <p>There was an error processing your invoice. Please try again.</p>
            <small class="text-muted">Error details: ${error.message}</small>
            <hr>
            <p class="text-muted"><strong>Troubleshooting tips:</strong></p>
            <ul class="text-muted">
                <li>Check that all required fields are filled</li>
                <li>Verify sufficient stock for selected products</li>
                <li>Ensure tax rates are valid numbers</li>
                <li>Try refreshing the page and creating again</li>
            </ul>
        </div>`;

        modal.show();
    });
});

// Validate inventory quantity against available stock
        function validateInventoryQuantity(quantityInput) {
            const row = quantityInput.closest('.row');
            const batchSelect = row.querySelector('.batch-select');
            const productSelect = row.querySelector('.product-select');

            // Ensure product and batch are selected before validating
            if (!batchSelect.value || !productSelect.value) {
                // Clear any previous validation messages if product/batch not selected
                quantityInput.classList.remove('is-invalid');
                const errorMsg = row.querySelector('.quantity-error');
                if (errorMsg) errorMsg.remove();
                return;
            }

            const selectedBatch = availableBatches.find(b => b.id == batchSelect.value);
            if (selectedBatch) {
                const requestedQty = parseFloat(quantityInput.value);
                const availableQty = parseFloat(selectedBatch.qty_available);

                if (requestedQty > availableQty) {
                    quantityInput.classList.add('is-invalid');
                    // Show error message
                    let errorMsg = row.querySelector('.quantity-error');
                    if (!errorMsg) {
                        errorMsg = document.createElement('div');
                        errorMsg.className = 'quantity-error text-danger small mt-1';
                        quantityInput.parentNode.appendChild(errorMsg);
                    }
                    errorMsg.textContent = `Maximum available: ${availableQty} ${selectedBatch.unit}`;
                    // Optionally auto-correct or just show error
                    // quantityInput.value = availableQty; // Auto-correct to max available
                    // quantityInput.classList.remove('is-invalid'); // Remove invalid class if auto-corrected
                    // errorMsg.remove(); // Remove error message if auto-corrected
                } else {
                    quantityInput.classList.remove('is-invalid');
                    const errorMsg = row.querySelector('.quantity-error');
                    if (errorMsg) errorMsg.remove();
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Integrated billing page loaded, initializing...');
            loadAvailableBatches();
            updateTaxCalculations(); // Initial calculation update based on default values
            toggleTaxType(); // Apply initial tax type settings

            // Add event listeners for real-time package benefit calculation
            setupServiceChangeListeners();
        });

        // Setup event listeners for service selection changes
        function setupServiceChangeListeners() {
            // Monitor service dropdown changes
            document.addEventListener('change', function(event) {
                if (event.target.matches('select[name="service_ids[]"]') || 
                    event.target.matches('input[name="service_quantities[]"]')) {
                    // Service or quantity changed, update calculations
                    setTimeout(updateTaxCalculations, 100); // Small delay to ensure DOM is updated
                }
            });

            // Monitor when new service rows are added
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.classList.contains('service-row')) {
                            // New service row added, attach listeners
                            const serviceSelect = node.querySelector('select[name="service_ids[]"]');
                            const quantityInput = node.querySelector('input[name="service_quantities[]"]');

                            if (serviceSelect) {
                                serviceSelect.addEventListener('change', () => {
                                    setTimeout(updateTaxCalculations, 100);
                                });
                            }

                            if (quantityInput) {
                                quantityInput.addEventListener('input', () => {
                                    setTimeout(updateTaxCalculations, 100);
                                });
                            }
                        }
                    });
                });
            });

            observer.observe(document.getElementById('servicesContainer'), {
                childList: true,
                subtree: true
            });
        }

        // --- Action button handlers ---
        function proceedWithInvoiceCreation() {
            document.getElementById('billingForm').submit();
        }

        function printInvoice() {
            const invoiceId = document.getElementById('printInvoiceBtn').dataset.invoiceId;
            if (invoiceId) {
                window.open(`/integrated-billing/print-invoice/${invoiceId}`, '_blank');
            } else {
                alert('Invoice ID not found. Cannot print.');
            }
        }

        function emailInvoice() {
            const invoiceId = document.getElementById('emailInvoiceBtn').dataset.invoiceId;
            if (invoiceId) {
                // In a real application, this would trigger an email sending process
                alert(`Email invoice functionality for Invoice ID: ${invoiceId} is being processed.`);
                // Example: fetch(`/integrated-billing/email-invoice/${invoiceId}`) ...
            } else {
                alert('Invoice ID not found. Cannot email.');
            }
        }

        function whatsappInvoice() {
            const invoiceId = document.getElementById('whatsappInvoiceBtn').dataset.invoiceId;
            if (invoiceId) {
                // In a real application, this would trigger a WhatsApp sharing process
                alert(`WhatsApp invoice functionality for Invoice ID: ${invoiceId} is being processed.`);
                // Example: fetch(`/integrated-billing/whatsapp-invoice/${invoiceId}`) ...
            } else {
                alert('Invoice ID not found. Cannot send via WhatsApp.');
            }
        }
        
        // Auto-select customer and load appointments if coming from appointment context menu
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-select customer if provided from appointment context menu
            {% if selected_customer %}
            const customerSelect = document.getElementById('client_id');
            if (customerSelect) {
                customerSelect.value = '{{ selected_customer.id }}';
                // Trigger change event to load customer packages
                customerSelect.dispatchEvent(new Event('change'));
                
                // Show notification about auto-selection
                const notification = document.createElement('div');
                notification.className = 'alert alert-info alert-dismissible fade show mt-3';
                notification.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Customer Auto-Selected:</strong> {{ selected_customer.full_name }}
                    {% if customer_appointments|length > 0 %}
                    <br><small>{{ customer_appointments|length }} pending appointment{{ 's' if customer_appointments|length != 1 else '' }} ready for billing</small>
                    {% endif %}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insert notification after the header
                const container = document.querySelector('.container-fluid');
                const firstRow = container.querySelector('.row');
                firstRow.parentNode.insertBefore(notification, firstRow.nextSibling);
                
                // Auto-populate services from customer appointments  
                {% if customer_appointments %}
                populateCustomerAppointments();
                {% endif %}
            }
            {% endif %}
        });

        // Function to populate services from customer appointments
        {% if customer_appointments %}
        function populateCustomerAppointments() {
            const appointments = {{ customer_appointments | tojson }};
            
            if (appointments && appointments.length > 0) {
                // Add success message
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show mt-3';
                successAlert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Services Ready for Billing:</strong> ${appointments.length} service${appointments.length !== 1 ? 's' : ''} from pending appointments
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                const container = document.querySelector('.container-fluid'); 
                const billingCard = container.querySelector('.card');
                billingCard.parentNode.insertBefore(successAlert, billingCard);
                
                // Auto-dismiss after 8 seconds
                setTimeout(() => {
                    if (successAlert.parentNode) {
                        successAlert.remove();
                    }
                }, 8000);
            }
        }
        {% endif %}
</script>
{% endblock %}