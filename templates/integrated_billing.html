{% extends "base.html" %}

{% block title %}Professional Billing & Invoice Management{% endblock %}

{% block extra_head %}
<style>
.billing-card {
    transition: all 0.3s ease;
    border-radius: 12px;
}
.billing-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}
.package-deduction {
    color: #28a745;
    font-weight: 500;
}
.extra-charge {
    color: #dc3545;
    font-weight: 500;
}
.item-row {
    border-left: 3px solid transparent;
    padding: 12px;
    margin-bottom: 8px;
    border-radius: 6px;
    background: #fff;
    transition: all 0.2s ease;
}
.item-row:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.item-row.package-item {
    border-left-color: #28a745;
    background-color: rgba(40, 167, 69, 0.05);
}
.item-row.extra-item {
    border-left-color: #dc3545;
    background-color: rgba(220, 53, 69, 0.05);
}
.batch-info {
    font-size: 0.8rem;
    color: #6c757d;
    margin-top: 4px;
}
.batch-warning {
    color: #dc3545;
    font-weight: 500;
}
.batch-success {
    color: #28a745;
    font-weight: 500;
}
.product-row {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
}
.product-row:hover {
    border-color: #667eea;
    background: #fff;
}
.section-header {
    border-bottom: 3px solid #667eea;
    padding-bottom: 8px;
    margin-bottom: 20px;
}
.stats-card {
    border-radius: 12px;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}
.calculation-preview {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 20px;
}
.calculation-preview .amount {
    font-size: 2rem;
    font-weight: 700;
}
.form-section {
    background: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.customer-info-card {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
    border-radius: 12px;
    padding: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-cash-register me-2 text-primary"></i>Integrated Billing & Service Management
            </h1>
            <p class="text-muted">Complete billing solution with package deductions, subscription management, and batch-wise inventory sales</p>
        </div>
    </div>

    <!-- Enhanced Dashboard Stats -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card stats-card gradient-card-success h-100">
                <div class="card-body text-center">
                    <div class="icon-wrapper mx-auto mb-3" style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%;">
                        <i class="fas fa-calendar-day fa-2x" style="line-height: 60px;"></i>
                    </div>
                    <h6 class="text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 1px; opacity: 0.9;">Today's Revenue</h6>
                    <h3 class="mb-0 font-weight-bold">₹{{ "{:,.2f}".format(today_revenue) }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card stats-card gradient-card-info h-100">
                <div class="card-body text-center">
                    <div class="icon-wrapper mx-auto mb-3" style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%;">
                        <i class="fas fa-chart-line fa-2x" style="line-height: 60px;"></i>
                    </div>
                    <h6 class="text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 1px; opacity: 0.9;">Total Revenue</h6>
                    <h3 class="mb-0 font-weight-bold">₹{{ "{:,.2f}".format(total_revenue) }}</h3>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card stats-card gradient-card-warning h-100">
                <div class="card-body text-center">
                    <div class="icon-wrapper mx-auto mb-3" style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%;">
                        <i class="fas fa-clock fa-2x" style="line-height: 60px;"></i>
                    </div>
                    <h6 class="text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 1px; opacity: 0.9;">Pending Amount</h6>
                    <h3 class="mb-0 font-weight-bold">₹{{ "{:,.2f}".format(pending_amount) }}</h3>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- New Invoice Creation -->
        <div class="col-lg-8 mb-4">
            <div class="card shadow" style="border-radius: 12px; border: none;">
                <div class="card-header py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px 12px 0 0;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="m-0 font-weight-bold">
                            <i class="fas fa-file-invoice-dollar me-2"></i>Create Professional Invoice
                        </h5>
                        <div class="d-flex gap-2">
                            <span class="badge bg-light text-dark">Services</span>
                            <span class="badge bg-light text-dark">Packages</span>
                            <span class="badge bg-light text-dark">Inventory</span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form id="billingForm">
                        <!-- Customer Selection Section -->
                        <div class="form-section">
                            <h6 class="section-header">
                                <i class="fas fa-user-circle me-2 text-primary"></i>Customer Information
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="client_id" class="form-label fw-bold">
                                        <i class="fas fa-user me-1"></i>Select Customer <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select form-select-lg" id="client_id" name="client_id" required style="border-radius: 8px;">
                                        <option value="">Choose a customer...</option>
                                        {% for customer in customers %}
                                        <option value="{{ customer.id }}" {{ 'selected' if selected_customer and customer.id == selected_customer.id else '' }}>
                                            {{ customer.full_name }} - {{ customer.phone }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-gift me-1"></i>Active Packages
                                    </label>
                                    <div id="customerPackages" class="alert alert-info mb-0" style="border-radius: 8px;">
                                        <small><i class="fas fa-info-circle me-1"></i>Select a customer to view their active packages</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Services & Appointments Section -->
                        {% if selected_customer %}
                        <div id="customerAppointmentsSection" class="row mb-4" style="display: none;">
                            <div class="col-12">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0">
                                            <i class="fas fa-user me-2"></i><span id="customerNameDisplay">{{ selected_customer.full_name }}</span>'s Current Bookings
                                            <span id="appointmentsCount" class="badge bg-primary text-white ms-2">{{ customer_appointments|length }} Ready to Bill</span>
                                        </h6>
                                    </div>
                                    <div id="appointmentsListContainer" class="card-body">
                                        <!-- Appointments will be loaded here by JavaScript -->
                                        {% if customer_services %}
                                        <div class="alert alert-success">
                                            <i class="fas fa-check-circle me-2"></i>
                                            <strong>{{ customer_services|length }} Different Services Found</strong> - Ready to add to bill
                                        </div>
                                        <h6 class="text-primary mb-3">Available Services for Billing:</h6>
                                        <div class="row">
                                            {% for service in customer_services %}
                                            <div class="col-md-4 mb-2">
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-spa text-success me-2"></i>
                                                    <span class="fw-bold">{{ service.name }}</span>
                                                    <span class="text-muted ms-2">₹{{ "{:,.2f}".format(service.price) }}</span>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}

                                        {% if customer_appointments and customer_appointments|length > 0 %}
                                        <hr>
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="text-success mb-0">
                                                <i class="fas fa-clock me-1"></i>All Confirmed Bookings Ready for Billing
                                            </h6>
                                            <div class="badge bg-success fs-6">{{ customer_appointments|length }} Bookings Found</div>
                                        </div>
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            These are all the confirmed/scheduled appointments for <strong>{{ selected_customer.full_name }}</strong> that can be billed.
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-success">
                                                    <tr>
                                                        <th>Date & Time</th>
                                                        <th>Service</th>
                                                        <th>Staff</th>
                                                        <th>Status</th>
                                                        <th>Amount</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for appointment in customer_appointments %}
                                                    <tr class="bg-light">
                                                        <td>
                                                            <strong>
                                                                {% if appointment.appointment_date.strftime is defined %}
                                                                    {{ appointment.appointment_date.strftime('%d %b %Y') }}
                                                                {% else %}
                                                                    {{ appointment.appointment_date }}
                                                                {% endif %}
                                                            </strong><br>
                                                            <small class="text-muted">
                                                                {% if appointment.start_time and appointment.start_time.strftime is defined %}
                                                                    {{ appointment.start_time.strftime('%I:%M %p') }}
                                                                {% else %}
                                                                    {{ appointment.start_time if appointment.start_time else 'N/A' }}
                                                                {% endif %}
                                                                -
                                                                {% if appointment.end_time and appointment.end_time.strftime is defined %}
                                                                    {{ appointment.end_time.strftime('%I:%M %p') }}
                                                                {% else %}
                                                                    {{ appointment.end_time if appointment.end_time else 'N/A' }}
                                                                {% endif %}
                                                            </small>
                                                        </td>
                                                        <td>
                                                            <strong>{{ appointment.service_name if appointment.service_name else 'N/A' }}</strong><br>
                                                            <small class="text-muted">{{ appointment.service_duration if appointment.service_duration else '0' }} mins</small>
                                                        </td>
                                                        <td>{{ appointment.staff_name if appointment.staff_name else 'N/A' }}</td>
                                                        <td>
                                                            <span class="badge badge-warning">
                                                                {{ appointment.status.title() }}
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <strong class="text-success">₹{{ "{:,.2f}".format(appointment.service_price) if appointment.service_price else '0.00' }}</strong>
                                                        </td>
                                                        <td>
                                                            <button type="button"
                                                                    class="btn btn-primary btn-sm"
                                                                    onclick="addAppointmentToBill({{ appointment.id }}, '{{ appointment.service_name }}', {{ appointment.service_price }}, '{{ appointment.staff_name }}')">
                                                                <i class="fas fa-plus me-1"></i>Add to Bill
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <strong>No ready-to-bill bookings found.</strong> This customer has no scheduled or confirmed appointments ready for billing.
                                        </div>
                                        {% endif %}

                                        <div class="mt-3">
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="autoFillCurrentServices()">
                                                <i class="fas fa-bolt me-1"></i>Auto-Fill ALL Bookings to Bill
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="viewFullCustomerHistory()">
                                                <i class="fas fa-history me-1"></i>View Full Customer History
                                            </button>
                                            <small class="text-muted d-block mt-1">
                                                <i class="fas fa-lightbulb me-1"></i>
                                                Auto-Fill will add all {{ customer_appointments|length }} confirmed bookings to your billing form instantly
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Services Section -->
                        <div class="form-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="section-header mb-0">
                                    <i class="fas fa-spa me-2 text-primary"></i>Services
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-magic me-1"></i>Package benefits auto-applied
                                </small>
                            </div>
                            <div id="servicesContainer">
                                <div class="service-row row mb-2">
                                    <div class="col-md-4">
                                        <label class="form-label text-muted small">Service</label>
                                        <select class="form-select" name="service_ids[]" onchange="handleServiceSelection(this)">
                                            <option value="">Select Service</option>
                                            {% for service in services %}
                                            <option value="{{ service.id }}" data-price="{{ service.price|float }}">
                                                {{ service.name }} - ₹{{ "{:,.2f}".format(service.price) }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label text-muted small">Staff Member <span class="text-danger">*</span></label>
                                        <select class="form-select" name="staff_ids[]" required>
                                            <option value="">Select Staff</option>
                                            {% for staff_member in staff_members %}
                                            <option value="{{ staff_member.id }}">
                                                {{ staff_member.full_name }} - {{ staff_member.designation or staff_member.role }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label text-muted small">Quantity</label>
                                        <input type="number" class="form-control" name="service_quantities[]" placeholder="Qty" min="1" value="1" step="0.5">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label text-muted small">Appointment ID</label>
                                        <input type="number" class="form-control" name="appointment_ids[]" placeholder="Optional">
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label text-muted small">&nbsp;</label>
                                        <button type="button" class="btn btn-success btn-sm w-100" onclick="addServiceRow()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Products & Inventory Section (Batch-wise) -->
                        <div class="form-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="section-header mb-0">
                                    <i class="fas fa-box-open me-2 text-primary"></i>Products & Inventory
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-sync-alt me-1"></i>FIFO auto-deduction from batches
                                </small>
                            </div>
                            <div id="productsContainer">
                                <div class="product-row">
                                    <div class="row mb-2">
                                        <div class="col-md-4">
                                            <label class="form-label">Product</label>
                                            <select class="form-select product-select" name="product_ids[]" onchange="loadBatchesForProduct(this)">
                                                <option value="">Select Product</option>
                                                {% for product in inventory_items %}
                                                <option value="{{ product.id }}" data-name="{{ product.name }}">{{ product.name }} (Total Stock: {{ product.total_stock }})</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Batch (Auto-selected FIFO)</label>
                                            <select class="form-select batch-select" name="batch_ids[]" disabled>
                                                <option value="">Select Product First</option>
                                            </select>
                                            <div class="batch-info"></div>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Quantity</label>
                                            <input type="number" class="form-control quantity-input" name="product_quantities[]" value="1" min="0.1" step="0.1" onchange="validateInventoryQuantity(this)">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Unit Price</label>
                                            <input type="number" class="form-control unit-price" name="product_prices[]" placeholder="Price" step="0.01" min="0" required>
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-success btn-sm w-100" onclick="addProductRow()">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Tax & Billing Section -->
                        <div class="card mb-4 border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-calculator me-2"></i>Professional Tax & Billing Calculations</h6>
                            </div>
                            <div class="card-body">
                                <!-- Tax Configuration -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="cgst_rate" class="form-label">CGST Rate (%)</label>
                                        <input type="number" class="form-control tax-input" id="cgst_rate" name="cgst_rate" value="9" step="0.01" min="0" max="50">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="sgst_rate" class="form-label">SGST Rate (%)</label>
                                        <input type="number" class="form-control tax-input" id="sgst_rate" name="sgst_rate" value="9" step="0.01" min="0" max="50">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="igst_rate" class="form-label">IGST Rate (%) <small class="text-muted">Interstate</small></label>
                                        <input type="number" class="form-control tax-input" id="igst_rate" name="igst_rate" value="0" step="0.01" min="0" max="50">
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input" type="checkbox" id="is_interstate" name="is_interstate">
                                            <label class="form-label" for="is_interstate">
                                                Interstate Transaction
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- Discount and Additional Charges -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <label for="discount_type" class="form-label">Discount Type</label>
                                        <select class="form-select billing-input" id="discount_type" name="discount_type">
                                            <option value="amount">Amount (₹)</option>
                                            <option value="percentage">Percentage (%)</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="discount_value" class="form-label">Discount Value</label>
                                        <input type="number" class="form-control billing-input" id="discount_value" name="discount_value" value="0" step="0.01" min="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="additional_charges" class="form-label">Additional Charges (₹)</label>
                                        <input type="number" class="form-control billing-input" id="additional_charges" name="additional_charges" value="0" step="0.01" min="0">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="tips_amount" class="form-label">Tips (₹)</label>
                                        <input type="number" class="form-control billing-input" id="tips_amount" name="tips_amount" value="0" step="0.01" min="0">
                                    </div>
                                </div>

                                <!-- Live Tax Calculation Display -->
                                <div class="row">
                                    <div class="col-12">
                                        <div class="calculation-preview">
                                            <div class="text-center mb-3">
                                                <h6 class="mb-0 fw-bold">
                                                    <i class="fas fa-calculator me-2"></i>Live Billing Calculation
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row text-center">
                                                    <div class="col-md-2">
                                                        <div class="border-end pe-3">
                                                            <h6 class="text-muted mb-1 fw-bold">Subtotal</h6>
                                                            <h4 class="mb-0 text-primary fw-bold" id="display_subtotal">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end pe-3">
                                                            <h6 class="text-muted mb-1 fw-bold">Discount</h6>
                                                            <h4 class="mb-0 text-danger fw-bold" id="display_discount">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end pe-3">
                                                            <h6 class="text-muted mb-1 fw-bold">CGST</h6>
                                                            <h4 class="mb-0 text-info fw-bold" id="display_cgst">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end pe-3">
                                                            <h6 class="text-muted mb-1 fw-bold">SGST</h6>
                                                            <h4 class="mb-0 text-info fw-bold" id="display_sgst">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="border-end pe-3">
                                                            <h6 class="text-muted mb-1 fw-bold">Additional</h6>
                                                            <h4 class="mb-0 text-warning fw-bold" id="display_additional">₹0.00</h4>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-2">
                                                        <div class="ps-3">
                                                            <h6 class="text-muted mb-1 fw-bold">FINAL TOTAL</h6>
                                                            <h3 class="mb-0 text-success fw-bold bg-light p-2 rounded border" id="display_total">₹0.00</h3>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Tax Summary Row -->
                                                <div class="row mt-3 pt-3 border-top">
                                                    <div class="col-md-4">
                                                        <small class="text-muted">
                                                            <strong>Tax Type:</strong> <span id="tax_type_display">Intrastate (CGST + SGST)</span>
                                                        </small>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <small class="text-muted">
                                                            <strong>Total Tax:</strong> <span id="total_tax_display" class="text-info fw-bold">₹0.00</span>
                                                        </small>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <small class="text-muted">
                                                            <strong>Tax %:</strong> <span id="tax_percentage_display" class="text-info fw-bold">18.00%</span>
                                                        </small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2" placeholder="Additional notes for this invoice"></textarea>
                        </div>

                        <!-- Payment Processing Section -->
                        <div class="card mb-4 border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Payment Processing</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="payment_terms" class="form-label">Payment Terms</label>
                                        <select class="form-select" id="payment_terms" name="payment_terms">
                                            <option value="immediate">Immediate</option>
                                            <option value="net_15">Net 15 Days</option>
                                            <option value="net_30">Net 30 Days</option>
                                            <option value="advance">Advance Payment</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="payment_method" class="form-label">Primary Payment Method</label>
                                        <select class="form-select" id="payment_method" name="payment_method">
                                            <option value="cash">Cash</option>
                                            <option value="card">Credit/Debit Card</option>
                                            <option value="upi">UPI Payment</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="cheque">Cheque</option>
                                            <option value="mixed">Multiple Methods</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Multi-payment method section (hidden by default) -->
                                <div id="multiPaymentSection" class="mt-3" style="display: none;">
                                    <h6>Split Payment Methods:</h6>
                                    <div id="paymentMethodsContainer">
                                        <!-- Dynamic payment method rows will be added here -->
                                    </div>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="addPaymentMethod()">
                                        <i class="fas fa-plus me-1"></i>Add Payment Method
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Professional Action Buttons -->
                        <div class="form-section" style="background: #f8f9fa;">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary btn-lg w-100" onclick="previewInvoice()" style="border-radius: 8px;">
                                        <i class="fas fa-eye me-2"></i>Preview
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-success btn-lg w-100" style="border-radius: 8px;">
                                        <i class="fas fa-check-circle me-2"></i>Generate Invoice
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-secondary btn-lg w-100" onclick="clearForm()" style="border-radius: 8px;">
                                        <i class="fas fa-redo me-2"></i>Clear Form
                                    </button>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-shield-alt me-1"></i>All transactions are secure and recorded
                                </small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Removed Recent Invoices Section -->

    </div>
</div>

<!-- Professional Invoice Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalTitle">Invoice Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="viewInvoiceBtn" class="btn btn-primary" style="display: none;">
                    <i class="fas fa-eye me-2"></i>View Invoice
                </a>
                <button type="button" id="printInvoiceBtn" class="btn btn-info" style="display: none;" onclick="printInvoice()">
                    <i class="fas fa-print me-2"></i>Print Invoice
                </button>
                <button type="button" id="emailInvoiceBtn" class="btn btn-success" style="display: none;" onclick="emailInvoice()">
                    <i class="fas fa-envelope me-2"></i>Email Invoice
                </button>
                <button type="button" id="whatsappInvoiceBtn" class="btn btn-warning" style="display: none;" onclick="whatsappInvoice()">
                    <i class="fab fa-whatsapp me-2"></i>WhatsApp Invoice
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Professional Invoice Preview Modal -->
<div class="modal fade" id="invoicePreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Professional Invoice Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoicePreviewBody" style="min-height: 600px;">
                <!-- Professional invoice preview will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="proceedWithInvoiceCreation()">
                    <i class="fas fa-check me-2"></i>Proceed with Invoice Creation
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Helper function to show toast notifications
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    `;
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    toastContainer.appendChild(toast);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
        if (toastContainer.children.length === 0) {
            toastContainer.remove();
        }
    }, 5000);
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    document.body.appendChild(container);
    return container;
}

// Global array to hold all available batches
var availableBatches = []; 

// Helper function to find an empty service row
function findEmptyServiceRow() {
    const serviceRows = document.querySelectorAll('.service-row');
    for (let row of serviceRows) {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        if (serviceSelect && !serviceSelect.value) {
            return row;
        }
    }
    return null;
}

// Function to add a service row
function addServiceRow() {
    const container = document.getElementById('servicesContainer');
    if (!container) {
        console.error('Services container not found');
        return;
    }

    const firstRow = container.children[0];
    if (!firstRow) {
        console.error('No service rows found to clone');
        return;
    }

    const newRow = firstRow.cloneNode(true);

    // Clear values
    newRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
    });

    // Reset appointment ID input
    const appointmentInput = newRow.querySelector('input[name="appointment_ids[]"]');
    if (appointmentInput) {
        appointmentInput.value = '';
    }
    
    // Clear any previous indicators or styling
    newRow.style.borderLeft = '';
    newRow.style.backgroundColor = '';
    const indicator = newRow.querySelector('.unaki-indicator, .package-benefit-display');
    if(indicator) indicator.remove();


    // Change button to remove
    const button = newRow.querySelector('button');
    if (button) {
        button.className = 'btn btn-danger btn-sm w-100';
        button.innerHTML = '<i class="fas fa-minus"></i>';
        button.onclick = function() {
            this.closest('.service-row').remove();
            updateTaxCalculations(); // Recalculate totals when a row is removed
        };
    }

    container.appendChild(newRow);
    return newRow;
}

// Function to add appointment directly to billing
function addAppointmentToBill(appointmentId, serviceName, servicePrice, serviceDuration) { 
    console.log('Adding appointment to bill:', appointmentId, serviceName, servicePrice, serviceDuration);

    // Find the first empty service row or add a new one
    let targetRow = findEmptyServiceRow();
    if (!targetRow) {
        if (typeof addServiceRow === 'function') {
            addServiceRow();
            targetRow = findEmptyServiceRow();
        } else {
            throw new Error('Cannot add new service row - addServiceRow function not available');
        }
    }

    if (targetRow) {
        const serviceSelect = targetRow.querySelector('select[name="service_ids[]"]');
        const quantityInput = targetRow.querySelector('input[name="service_quantities[]"]');
        const appointmentInput = targetRow.querySelector('input[name="appointment_ids[]"]');

        if (!serviceSelect || !quantityInput || !appointmentInput) {
            throw new Error('Required form elements not found in service row');
        }

        // Try to find matching service by name
        let matchedServiceId = null;
        let finalServicePrice = parseFloat(servicePrice) || 0;

        for (let option of serviceSelect.options) {
            if (option.value && option.text.toLowerCase().includes(serviceName.toLowerCase())) {
                matchedServiceId = option.value;
                const priceMatch = option.text.match(/₹([\d,]+\.?\d*)/);
                if (priceMatch) {
                    const systemPrice = parseFloat(priceMatch[1].replace(/,/g, ''));
                    finalServicePrice = systemPrice > 0 ? systemPrice : servicePrice;
                }
                break;
            }
        }

        if (matchedServiceId) {
            serviceSelect.value = matchedServiceId;
            quantityInput.value = '1';
            appointmentInput.value = `unaki_${appointmentId}`; // Prefix with 'unaki_' for clarity

            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            if (selectedOption) {
                selectedOption.dataset.price = finalServicePrice.toString();
            }

            // Highlight the row
            targetRow.style.borderLeft = '4px solid #007bff'; // Blue for Unaki booking
            targetRow.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';

            // Add visual indicator
            let indicator = targetRow.querySelector('.unaki-indicator');
            if (!indicator) {
                indicator = document.createElement('small');
                indicator.className = 'unaki-indicator text-info fw-bold d-block';
                indicator.innerHTML = '<i class="fas fa-calendar-check me-1"></i>Unaki Booking';
                targetRow.appendChild(indicator);
            }

            // Trigger service selection change event to update price and calculations
            if (typeof handleServiceSelection === 'function') {
                handleServiceSelection(serviceSelect);
            }

            // Force recalculation after a small delay
            setTimeout(() => {
                if (typeof updateTaxCalculations === 'function') {
                    updateTaxCalculations();
                }
            }, 200);

            showNotification(`Added Unaki booking: ${serviceName} (₹${finalServicePrice.toFixed(2)}) to bill successfully!`, 'success');
        } else {
            console.warn(`No matching service found for: ${serviceName}`);
            // If service not found, still fill quantity and appointment ID
            quantityInput.value = '1';
            appointmentInput.value = `unaki_${appointmentId}`;

            // Add warning indicator
            let indicator = targetRow.querySelector('.unaki-indicator');
            if (!indicator) {
                indicator = document.createElement('small');
                indicator.className = 'unaki-indicator text-warning fw-bold d-block';
                indicator.innerHTML = `<i class="fas fa-exclamation-triangle me-1"></i>Service not found: ${serviceName}`;
                targetRow.appendChild(indicator);
            }
            showNotification(`Could not find a matching service for "${serviceName}". Please select manually.`, 'warning');
        }
    } else {
        throw new Error('No service row available for adding appointment');
    }
}

// Additional helper function definitions that were removed or modified
console.log('All billing functions confirmed available');

// Preview invoice function
function previewInvoice() {
    console.log('Generating invoice preview...');

    // Validate form first
    const clientSelect = document.getElementById('client_id');
    if (!clientSelect || !clientSelect.value) {
        showNotification('Please select a customer first', 'warning');
        return;
    }

    // Check if there are any services or products
    const serviceRows = document.querySelectorAll('.service-row');
    const productRows = document.querySelectorAll('.product-row');

    let hasServices = false;
    let hasProducts = false;

    serviceRows.forEach(row => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        if (serviceSelect && serviceSelect.value) {
            hasServices = true;
        }
    });

    productRows.forEach(row => {
        const productSelect = row.querySelector('select[name="product_ids[]"]');
        if (productSelect && productSelect.value) {
            hasProducts = true;
        }
    });

    if (!hasServices && !hasProducts) {
        showNotification('Please add at least one service or product to preview', 'warning');
        return;
    }

    // Generate preview data
    const customerName = clientSelect.options[clientSelect.selectedIndex].text;
    const totalAmount = document.getElementById('display_total').textContent;

    // Create preview modal content
    const previewModal = document.getElementById('invoicePreviewModal');
    const previewBody = document.getElementById('invoicePreviewBody');

    if (previewModal && previewBody) {
        previewBody.innerHTML = `
            <div class="invoice-preview">
                <div class="text-center mb-4">
                    <h3>INVOICE PREVIEW</h3>
                    <p class="text-muted">Spa Management System</p>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Customer:</strong> ${customerName.split(' - ')[0]}
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Total Amount:</strong> ${totalAmount}
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    This is a preview. Click "Proceed with Invoice Creation" to generate the actual invoice.
                </div>
            </div>
        `;

        // Show the modal
        const modal = new bootstrap.Modal(previewModal);
        modal.show();
    } else {
        showNotification('Preview modal not found', 'error');
    }
}

// Proceed with invoice creation
function proceedWithInvoiceCreation() {
    console.log('Proceeding with invoice creation...');

    // Close preview modal
    const previewModal = bootstrap.Modal.getInstance(document.getElementById('invoicePreviewModal'));
    if (previewModal) {
        previewModal.hide();
    }

    // Submit the billing form
    const billingForm = document.getElementById('billingForm');
    if (billingForm) {
        // Set form action to professional invoice creation
        billingForm.action = '/integrated-billing/create-professional';
        billingForm.method = 'POST';
        billingForm.submit();
    }
}

// Save as draft function
function saveAsDraft() {
    console.log('Saving invoice as draft...');
    showNotification('Draft functionality coming soon!', 'info');
}

// Send quotation function
function sendQuotation() {
    console.log('Sending quotation...');
    showNotification('Quotation functionality coming soon!', 'info');
}

// Clear form function
function clearForm() {
    if (confirm('Are you sure you want to clear all form data?')) {
        const billingForm = document.getElementById('billingForm');
        if (billingForm) {
            billingForm.reset();
            // Reset calculations
            updateTaxCalculations();
            // Clear dynamic rows
            const serviceRows = document.querySelectorAll('.service-row');
            for(let i = 1; i < serviceRows.length; i++) { // Start from 1 to keep the first row
                serviceRows[i].remove();
            }
            const productRows = document.querySelectorAll('.product-row');
            for(let i = 1; i < productRows.length; i++) {
                productRows[i].remove();
            }
             // Reset package display
            document.getElementById('customerPackages').innerHTML = '<small><i class="fas fa-info-circle me-1"></i>Select a customer to view their active packages</small>';
            // Hide appointments section if it exists
            let appointmentsSection = document.querySelector('#customerAppointmentsSection');
            if (appointmentsSection) {
                appointmentsSection.style.display = 'none';
            }

            showNotification('Form cleared successfully', 'success');
        }
    }
}

// Helper function to ensure billing calculations are triggered properly
function ensureBillingCalculation() {
    console.log('Ensuring billing calculation is up to date...');
    // Small delay to ensure DOM updates are complete
    setTimeout(() => {
        updateTaxCalculations();
    }, 50);
}


// Auto-fill customer's current Unaki appointments
function autoFillCurrentServices() {
    console.log('Auto-filling current services...');
    // This function would auto-add all customer services to the billing form
    showNotification('Feature coming soon: Auto-fill all services', 'info');
}

// Load customer appointments when customer is selected
function loadCustomerAppointmentsForBilling(customerId) {
    if (!customerId) {
        document.getElementById('customerAppointmentsSection').style.display = 'none';
        return;
    }

    console.log('Loading appointments for customer:', customerId);

    // Show loading state
    const appointmentsSection = document.getElementById('customerAppointmentsSection');
    const appointmentsContainer = document.getElementById('appointmentsListContainer');
    appointmentsSection.style.display = 'block';
    appointmentsContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2">Loading appointments...</p></div>';

    // Fetch customer appointments
    fetch(`/api/customer/${customerId}/appointments`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const customer = data.customer;
                const appointments = data.appointments;
                const services = data.services;

                // Update customer name display
                document.getElementById('customerNameDisplay').textContent = customer.name;
                document.getElementById('appointmentsCount').textContent = `${appointments.length} Ready to Bill`;

                // Build appointments HTML
                let appointmentsHTML = '';

                if (appointments.length > 0) {
                    appointmentsHTML += `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>${appointments.length} Confirmed Bookings Found</strong> - Ready to add to bill
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-success">
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Service</th>
                                        <th>Staff</th>
                                        <th>Status</th>
                                        <th>Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                    appointments.forEach(apt => {
                        const appointmentDate = new Date(apt.appointment_date).toLocaleDateString('en-GB');
                        appointmentsHTML += `
                            <tr class="bg-light">
                                <td>
                                    <strong>${appointmentDate}</strong><br>
                                    <small class="text-muted">${apt.start_time} - ${apt.end_time}</small>
                                </td>
                                <td>
                                    <strong>${apt.service_name || 'N/A'}</strong><br>
                                    <small class="text-muted">${apt.service_duration || '0'} mins</small>
                                </td>
                                <td>${apt.staff_name || 'N/A'}</td>
                                <td>
                                    <span class="badge badge-warning">${apt.status}</span>
                                </td>
                                <td>
                                    <strong class="text-success">₹${parseFloat(apt.service_price || 0).toFixed(2)}</strong>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-primary btn-sm" 
                                            onclick="addAppointmentToBill(${apt.id}, '${apt.service_name}', ${apt.service_price}, '${apt.staff_name}')">
                                        <i class="fas fa-plus me-1"></i>Add to Bill
                                    </button>
                                </td>
                            </tr>`;
                    });

                    appointmentsHTML += `
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="autoFillAllAppointments()">
                                <i class="fas fa-bolt me-1"></i>Auto-Fill ALL Bookings to Bill
                            </button>
                            <small class="text-muted d-block mt-1">
                                <i class="fas fa-lightbulb me-1"></i>
                                Auto-Fill will add all ${appointments.length} confirmed bookings to your billing form instantly
                            </small>
                        </div>`;
                } else {
                    appointmentsHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>No ready-to-bill bookings found.</strong> This customer has no scheduled or confirmed appointments ready for billing.
                        </div>`;
                }

                appointmentsContainer.innerHTML = appointmentsHTML;
            } else {
                appointmentsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading appointments: ${data.error || 'Unknown error'}
                    </div>`;
            }
        })
        .catch(error => {
            console.error('Error loading appointments:', error);
            appointmentsContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading appointments. Please try again.
                </div>`;
        });
}

// Add appointment to bill
function addAppointmentToBill(appointmentId, serviceName, servicePrice, staffName) {
    console.log('Adding appointment to bill:', appointmentId, serviceName, servicePrice, staffName);

    // Find the first empty service row or add a new one
    let targetRow = findEmptyServiceRow();
    if (!targetRow) {
        if (typeof addServiceRow === 'function') {
            addServiceRow();
            targetRow = findEmptyServiceRow();
        } else {
            throw new Error('Cannot add new service row - addServiceRow function not available');
        }
    }

    if (targetRow) {
        const serviceSelect = targetRow.querySelector('select[name="service_ids[]"]');
        const staffSelect = targetRow.querySelector('select[name="staff_ids[]"]');
        const appointmentInput = targetRow.querySelector('input[name="appointment_ids[]"]');

        // Find and select the service by name
        let serviceFound = false;
        for (let option of serviceSelect.options) {
            if (option.value && option.text.toLowerCase().includes(serviceName.toLowerCase())) {
                serviceSelect.value = option.value;
                serviceFound = true;
                break;
            }
        }

        // Find and select the staff by name
        let staffFound = false;
        for (let option of staffSelect.options) {
            if (option.value && option.text.includes(staffName)) {
                staffSelect.value = option.value;
                staffFound = true;
                break;
            }
        }

        // Set appointment ID
        if (appointmentInput) {
            appointmentInput.value = appointmentId;
        }

        // Highlight the row if service or staff was found
        if (serviceFound || staffFound) {
             targetRow.style.borderLeft = '4px solid #28a745'; // Green for direct add
             targetRow.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';

             // Add visual indicator
             let indicator = targetRow.querySelector('.unaki-indicator');
             if (!indicator) {
                 indicator = document.createElement('small');
                 indicator.className = 'unaki-indicator text-success fw-bold d-block';
                 indicator.innerHTML = '<i class="fas fa-calendar-check me-1"></i>Added from Booking';
                 targetRow.appendChild(indicator);
             }
        } else {
            // If service or staff not found, show a warning
            console.warn(`Service or Staff not found for: ${serviceName}`);
            showNotification(`Could not find exact match for Service or Staff: "${serviceName}", "${staffName}". Please verify.`, 'warning');
        }

        // Trigger service selection change event to update price and calculations
        if (typeof handleServiceSelection === 'function') {
            handleServiceSelection(serviceSelect);
        }

        // Force recalculation after a small delay
        setTimeout(() => {
            if (typeof updateTaxCalculations === 'function') {
                updateTaxCalculations();
            }
        }, 200);

        showNotification(`Added ${serviceName} to bill`, 'success');

    } else {
        throw new Error('No service row available for adding appointment');
    }
}

// View full customer history
function viewFullCustomerHistory() {
    {% if selected_customer %}
    // Open customer detail page in new tab
    window.open('/clients/{{ selected_customer.id }}', '_blank');
    {% endif %}
}


// Load available batches for consumption (FIFO ordering)
function loadAvailableBatches() {
    fetch('/api/inventory/batches/for-consumption')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches) {
                availableBatches = data.batches;
                console.log('Available batches loaded:', availableBatches.length);
            }
        })
        .catch(error => {
            console.error('Error loading batches:', error);
        });
}

// Load batches for selected product (FIFO - First In First Out by expiry)
function loadBatchesForProduct(productSelect) {
    const row = productSelect.closest('.row');
    const batchSelect = row.querySelector('.batch-select');
    const batchInfo = row.querySelector('.batch-info');
    const quantityInput = row.querySelector('input[name="product_quantities[]"]');
    const priceInput = row.querySelector('input[name="product_prices[]"]');

    const productId = parseInt(productSelect.value);

    // Reset batch selection
    batchSelect.innerHTML = '<option value="">Loading batches...</option>';
    batchSelect.disabled = true;
    batchInfo.innerHTML = '';

    if (!productId) {
        batchSelect.innerHTML = '<option value="">Select Product First</option>';
        return;
    }

    // Find batches for this product (FIFO by expiry date)
    const productBatches = availableBatches.filter(batch => {
        return batch.product_id === productId && batch.qty_available > 0;
    });

    console.log(`DEBUG: Product ID ${productId} has ${productBatches.length} available batches`);

    if (productBatches.length === 0) {
        batchSelect.innerHTML = '<option value="">No stock available</option>';
        batchInfo.innerHTML = '<span class="text-danger">⚠️ No stock available for this product</span>';
        if (quantityInput) quantityInput.value = '0';
        if (priceInput) priceInput.value = '';
        return;
    }

    // Sort by expiry date (FIFO - First to expire first)
    productBatches.sort((a, b) => {
        if (!a.expiry_date && !b.expiry_date) return 0;
        if (!a.expiry_date) return 1; // Batches without expiry date go last
        if (!b.expiry_date) return -1;
        return new Date(a.expiry_date) - new Date(b.expiry_date);
    });

    // Auto-select first batch (FIFO)
    const firstBatch = productBatches[0];
    batchSelect.innerHTML = `<option value="${firstBatch.id}" selected>${firstBatch.dropdown_display}</option>`;

    // Add other batches as options
    productBatches.slice(1).forEach(batch => {
        const option = document.createElement('option');
        option.value = batch.id;
        option.textContent = batch.dropdown_display;
        batchSelect.appendChild(option);
    });

    batchSelect.disabled = false;

    // Show batch info
    const expiryText = firstBatch.expiry_date ?
        `Expires: ${new Date(firstBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
    batchInfo.innerHTML = `
        <strong>Auto-selected:</strong> ${firstBatch.batch_name}<br>
        <strong>Available:</strong> ${firstBatch.qty_available} ${firstBatch.unit}<br>
        <strong>${expiryText}</strong>
    `;

    // Set max quantity and placeholder
    if (quantityInput) {
        quantityInput.max = firstBatch.qty_available;
        quantityInput.placeholder = `Max: ${firstBatch.qty_available}`;
        quantityInput.value = '1'; // Reset quantity to 1
        validateInventoryQuantity(quantityInput); // Validate after setting max and default value
    }
    // Auto-populate price based on the first batch's selling price
    if (priceInput) {
        const sellingPrice = firstBatch.selling_price || firstBatch.unit_price || firstBatch.unit_cost || 0;
        priceInput.value = parseFloat(sellingPrice).toFixed(2);
        updateTaxCalculations(); // Trigger calculation update
    }

    // Update batch info when batch selection changes
    batchSelect.addEventListener('change', function() {
        const selectedBatch = productBatches.find(b => b.id == this.value);
        if (selectedBatch) {
            const expiryText = selectedBatch.expiry_date ?
                `Expires: ${new Date(selectedBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
            batchInfo.innerHTML = `
                <strong>Selected:</strong> ${selectedBatch.batch_name}<br>
                <strong>Available:</strong> ${selectedBatch.qty_available} ${selectedBatch.unit}<br>
                <strong>${expiryText}</strong>
            `;
            if (quantityInput) {
                quantityInput.max = selectedBatch.qty_available;
                quantityInput.placeholder = `Max: ${selectedBatch.qty_available}`;
                quantityInput.value = '1'; // Reset quantity to 1 on batch change
                validateInventoryQuantity(quantityInput); // Re-validate
            }
            // Auto-populate price based on selected batch's selling price
            if (priceInput) {
                const sellingPrice = selectedBatch.selling_price || selectedBatch.unit_price || selectedBatch.unit_cost || 0;
                priceInput.value = parseFloat(sellingPrice).toFixed(2);
                updateTaxCalculations(); // Trigger calculation update
            }
        }
    });
}

// Validate stock availability
function validateInventoryQuantity(quantityInput) {
    const productRow = quantityInput.closest('.product-row');
    const batchSelect = productRow.querySelector('.batch-select');
    const selectedOption = batchSelect.options[batchSelect.selectedIndex];
    const availableStockDiv = productRow.querySelector('.batch-info');

    if (!selectedOption || selectedOption.value === "") {
        if (availableStockDiv) {
            availableStockDiv.innerHTML = '<span class="text-muted">Select batch to see stock</span>';
        }
        quantityInput.setCustomValidity(''); // Clear any previous invalidity
        return;
    }

    const selectedBatchId = selectedOption.value;
    const selectedBatch = availableBatches.find(b => b.id == selectedBatchId);

    if (selectedBatch) {
        const available = parseFloat(selectedBatch.qty_available);
        const requested = parseFloat(quantityInput.value) || 0;

        if (requested > available) {
            quantityInput.style.borderColor = '#dc3545'; // Red border for invalid input
            if (availableStockDiv) {
                availableStockDiv.innerHTML = '<span class="batch-warning">Available: ' + available + ' (Insufficient stock!)</span>';
            }
            quantityInput.setCustomValidity('Insufficient stock');
        } else {
            quantityInput.style.borderColor = '#28a745'; // Green border for valid input
             if (availableStockDiv) {
                const expiryText = selectedBatch.expiry_date ?
                    `Expires: ${new Date(selectedBatch.expiry_date).toLocaleDateString()}` : 'No expiry date';
                availableStockDiv.innerHTML = `
                    <strong>Selected:</strong> ${selectedBatch.batch_name}<br>
                    <strong>Available:</strong> ${selectedBatch.qty_available} ${selectedBatch.unit}<br>
                    <strong>${expiryText}</strong>
                `;
            }
            quantityInput.setCustomValidity('');
        }
    } else {
        quantityInput.style.borderColor = '';
        if (availableStockDiv) {
            availableStockDiv.innerHTML = '';
        }
        quantityInput.setCustomValidity('');
    }
}

// Global variable to store customer package data for benefit calculations
let customerPackageData = null;
let lastLoadedCustomerId = null; // Track last loaded customer to prevent duplicates

// Load customer packages and auto-populate services
document.getElementById('client_id').addEventListener('change', function() {
    const clientId = this.value;
    const packagesDiv = document.getElementById('customerPackages');

    if (!clientId) {
        packagesDiv.innerHTML = '<small><i class="fas fa-info-circle me-1"></i>Select a customer to view their active packages</small>';
        customerPackageData = null;
        lastLoadedCustomerId = null;
        updateTaxCalculations(); // Update totals when customer is deselected
        
        // Clear appointments section if it exists
        let appointmentsSection = document.querySelector('#customerAppointmentsSection');
        if (appointmentsSection) {
            appointmentsSection.style.display = 'none';
        }
        return;
    }

    // Prevent duplicate loads for the same customer
    if (lastLoadedCustomerId === clientId) {
        console.log('Customer packages already loaded for:', clientId);
        return;
    }

    lastLoadedCustomerId = clientId;

    // Show loading state
    packagesDiv.innerHTML = '<small class="text-info"><i class="fas fa-spinner fa-spin"></i> Loading packages...</small>';

    // Fetch customer packages
    fetch(`/integrated-billing/customer-packages/${clientId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Package data received:', data);

            if (!data || data.error) {
                packagesDiv.innerHTML = `<small class="text-danger">Error: ${data.error || 'Unknown error'}</small>`;
                customerPackageData = null;
                return;
            }

            customerPackageData = data; // Store package data globally

            if (data.packages && data.packages.length > 0) {
                let html = '<div class="alert alert-success mb-0"><strong>Active Packages:</strong><br>';
                data.packages.forEach(pkg => {
                    html += `<div class="badge bg-success me-1 mb-1">${pkg.package_name}</div>`;
                    if (pkg.package_type === 'service_package') {
                        html += `<small class="d-block">${pkg.service_name || 'Any Service'}: ${pkg.sessions_remaining || 0} sessions remaining</small>`;
                    } else if (pkg.package_type === 'prepaid') {
                        html += `<small class="d-block text-info">Prepaid Credit: ₹${pkg.credit_remaining || 0}</small>`;
                    } else if (pkg.package_type === 'membership') {
                        html += `<small class="d-block text-success">Unlimited Access</small>`;
                    }
                });
                if (data.total) {
                    html += `<hr class="my-1"><small class="text-muted">Total Active: ${data.total} package(s)</small>`;
                }
                html += '</div>';
                packagesDiv.innerHTML = html;
            } else {
                packagesDiv.innerHTML = '<small class="text-muted">No active packages found</small>';
                customerPackageData = { packages: [], total: 0 };
            }

            // Update calculations to apply package benefits
            updateTaxCalculations();
        })
        .catch(error => {
            console.error('Error loading packages:', error);
            packagesDiv.innerHTML = '<small class="text-danger">Error loading packages. Please try again.</small>';
            customerPackageData = null;
        });

    // Load appointments for billing
    loadCustomerAppointmentsForBilling(clientId);
});


// Function to populate services from customer appointments
{% if customer_appointments %}
function populateCustomerAppointments() {
    const appointments = {{ customer_appointments | tojson }};

    if (appointments && appointments.length > 0) {
        // Add success message
        const successAlert = document.createElement('div');
        successAlert.className = 'alert alert-success alert-dismissible fade show mt-3';
        successAlert.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            <strong>Services Ready for Billing:</strong> ${appointments.length} service${appointments.length !== 1 ? 's' : ''} from pending appointments
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        const container = document.querySelector('.container-fluid');
        const billingCard = container.querySelector('.card');
        billingCard.parentNode.insertBefore(successAlert, billingCard);

        // Auto-dismiss after 8 seconds
        setTimeout(() => {
            if (successAlert.parentNode) {
                successAlert.remove();
            }
        }, 8000);
    }
}
{% endif %}

// Helper function to update service price in the UI (if price input exists per row)
function updateServicePrice(serviceId, price) {
    const serviceRows = document.querySelectorAll('.service-row');
    let targetRow = null;

    serviceRows.forEach(row => {
        const selectElement = row.querySelector('select[name="service_ids[]"]');
        if (selectElement && selectElement.value === serviceId) {
            targetRow = row;
        }
    });

    if (targetRow) {
        // Assuming there's an input for service price per row, e.g., name="service_prices[]"
        const priceInput = targetRow.querySelector('input[name="service_prices[]"]'); 
        if (priceInput) {
            priceInput.value = parseFloat(price).toFixed(2);
        }
    } else if (serviceId === '') { // Handle deselection or "Select Service"
        // Do nothing if no service is selected
    } else {
        console.log(`Could not find row for service ID: ${serviceId} to update price directly.`);
    }
}

// Handle service selection change
function handleServiceSelection(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];

    if (selectedOption && selectedOption.value) {
        // Extract price from data attribute or option text
        let price = selectedOption.dataset.price;

        if (!price) {
            const priceMatch = selectedOption.text.match(/₹([\d,]+\.?\d*)/);
            if (priceMatch) {
                price = parseFloat(priceMatch[1].replace(/,/g, ''));
                selectedOption.dataset.price = price.toString(); // Store for future use
            }
        }

        if (price) {
            console.log(`Service selected: ${selectedOption.text}, Price: ₹${price}`);
            updateServicePrice(selectElement.value, price); // Update the price input if it exists

            // Trigger calculation update
            setTimeout(() => {
                updateTaxCalculations();
            }, 50);
        } else {
            console.warn('No price found for selected service:', selectedOption.text);
            updateServicePrice(selectElement.value, '0.00'); // Reset price if not found
        }
    } else {
        // Reset for empty selection
        updateServicePrice(selectElement.value, '0.00');
        setTimeout(() => {
            updateTaxCalculations();
        }, 50);
    }
}

// Initialize components and event listeners
window.addServiceRow = addServiceRow;
window.addAppointmentToBill = addAppointmentToBill;
window.previewInvoice = previewInvoice;
window.proceedWithInvoiceCreation = proceedWithInvoiceCreation;
window.saveAsDraft = saveAsDraft;
window.sendQuotation = sendQuotation;
window.clearForm = clearForm;
window.findEmptyServiceRow = findEmptyServiceRow;
window.autoFillCurrentServices = autoFillCurrentServices;
window.viewFullCustomerHistory = viewFullCustomerHistory;
window.handleServiceSelection = handleServiceSelection;
window.updateTaxCalculations = updateTaxCalculations;
window.loadBatchesForProduct = loadBatchesForProduct;
window.validateInventoryQuantity = validateInventoryQuantity;
window.loadCustomerAppointmentsForBilling = loadCustomerAppointmentsForBilling; // Expose for dynamic loading
window.autoFillAllAppointments = function() { showNotification('Auto-fill feature is under development.', 'info'); }; // Placeholder

// Set up tax calculation listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('Setting up tax calculation listeners...');

    // Tax and billing input listeners
    const taxBillingInputs = document.querySelectorAll('.tax-input, .billing-input, select[name="service_ids[]"], input[name="service_quantities[]"], input[name="product_quantities[]"], input[name="product_prices[]"]');
    taxBillingInputs.forEach(input => {
        input.addEventListener('input', updateTaxCalculations);
        input.addEventListener('change', updateTaxCalculations);
    });

    // Interstate checkbox listener
    const interstateCheckbox = document.getElementById('is_interstate');
    if (interstateCheckbox) {
        interstateCheckbox.addEventListener('change', toggleTaxType); // Use toggleTaxType for interstate logic
    }

    // Initial calculation on page load
    setTimeout(updateTaxCalculations, 300);

    console.log('Tax calculation listeners set up successfully');
});

// Setup event listeners for service selection changes
function setupServiceChangeListeners() {
    // Monitor service dropdown and quantity changes
    document.addEventListener('change', function(event) {
        if (event.target.matches('select[name="service_ids[]"]') ||
            event.target.matches('input[name="service_quantities[]"]')) {
            handleServiceSelection(event.target);
            setTimeout(updateTaxCalculations, 100);
        }
    });

    // Monitor input changes for quantities and prices
    document.addEventListener('input', function(event) {
        if (event.target.matches('input[name="service_quantities[]"]') ||
            event.target.matches('input[name="product_quantities[]"]') ||
            event.target.matches('input[name="product_prices[]"]')) {
            setTimeout(updateTaxCalculations, 100);
        }
    });

    // Observe mutations for dynamically added service rows
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1 && node.classList.contains('service-row')) {
                    const serviceSelect = node.querySelector('select[name="service_ids[]"]');
                    const quantityInput = node.querySelector('input[name="service_quantities[]"]');

                    if (serviceSelect) {
                        serviceSelect.addEventListener('change', (e) => {
                            handleServiceSelection(e.target);
                            setTimeout(updateTaxCalculations, 100);
                        });
                    }
                    if (quantityInput) {
                        quantityInput.addEventListener('input', () => {
                            setTimeout(updateTaxCalculations, 100);
                        });
                    }
                }
            });
        });
    });

    observer.observe(document.getElementById('servicesContainer'), {
        childList: true,
        subtree: true
    });
}

// --- Action button handlers ---
function proceedWithInvoiceCreation() {
    document.getElementById('billingForm').submit();
}

function printInvoice() {
    const invoiceId = document.getElementById('printInvoiceBtn').dataset.invoiceId;
    if (invoiceId) {
        window.open(`/integrated-billing/print-invoice/${invoiceId}`, '_blank');
    } else {
        alert('Invoice ID not found. Cannot print.');
    }
}

function emailInvoice() {
    const invoiceId = document.getElementById('emailInvoiceBtn').dataset.invoiceId;
    if (invoiceId) {
        alert(`Email invoice functionality for Invoice ID: ${invoiceId} is being processed.`);
    } else {
        alert('Invoice ID not found. Cannot email.');
    }
}

function whatsappInvoice() {
    const invoiceId = document.getElementById('whatsappInvoiceBtn').dataset.invoiceId;
    if (invoiceId) {
        alert(`WhatsApp invoice functionality for Invoice ID: ${invoiceId} is being processed.`);
    } else {
        alert('Invoice ID not found. Cannot send via WhatsApp.');
    }
}

// Auto-select customer and load appointments if coming from appointment context menu
document.addEventListener('DOMContentLoaded', function() {
    // Handle customer selection change for dynamic loading
    const clientSelect = document.getElementById('client_id');
    if (clientSelect) {
        clientSelect.addEventListener('change', function() {
            const customerId = this.value;
            if (customerId) {
                console.log('Loading client data for ID:', customerId);
                // Load packages and trigger appointments loading via loadCustomerAppointmentsForBilling
                document.getElementById('client_id').dispatchEvent(new Event('change')); 
            } else {
                // Clear packages display and hide appointments section
                document.getElementById('customerPackages').innerHTML = 
                    '<small><i class="fas fa-info-circle me-1"></i>Select a customer to view their active packages</small>';
                let appointmentsSection = document.querySelector('#customerAppointmentsSection');
                if (appointmentsSection) {
                    appointmentsSection.style.display = 'none';
                }
            }
        });
    }

    // Auto-select customer if passed via template context
    {% if selected_customer %}
    const customerSelect = document.getElementById('client_id');
    if (customerSelect) {
        customerSelect.value = '{{ selected_customer.id }}';
        // Trigger change event to load packages and appointments
        customerSelect.dispatchEvent(new Event('change'));

        showNotification(
            'Customer Auto-Selected: {{ selected_customer.full_name }}' + 
            {% if customer_appointments|length > 0 %}
            ' - {{ customer_appointments|length }} pending appointment{{ "s" if customer_appointments|length != 1 else "" }} ready for billing'
            {% else %}
            ''
            {% endif %},
            'info'
        );
    }
    {% endif %}
});

// Helper function to update service price in the UI (if price input exists per row)
function updateServicePrice(serviceId, price) {
    const serviceRows = document.querySelectorAll('.service-row');
    let targetRow = null;

    serviceRows.forEach(row => {
        const selectElement = row.querySelector('select[name="service_ids[]"]');
        if (selectElement && selectElement.value === serviceId) {
            targetRow = row;
        }
    });

    if (targetRow) {
        // Assuming there's an input for service price per row, e.g., name="service_prices[]"
        const priceInput = targetRow.querySelector('input[name="service_prices[]"]'); 
        if (priceInput) {
            priceInput.value = parseFloat(price).toFixed(2);
        }
    } else if (serviceId === '') { // Handle deselection or "Select Service"
        // Do nothing if no service is selected
    } else {
        console.log(`Could not find row for service ID: ${serviceId} to update price directly.`);
    }
}

// Handle service selection change
function handleServiceSelection(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];

    if (selectedOption && selectedOption.value) {
        // Extract price from data attribute or option text
        let price = selectedOption.dataset.price;

        if (!price) {
            const priceMatch = selectedOption.text.match(/₹([\d,]+\.?\d*)/);
            if (priceMatch) {
                price = parseFloat(priceMatch[1].replace(/,/g, ''));
                selectedOption.dataset.price = price.toString(); // Store for future use
            }
        }

        if (price) {
            console.log(`Service selected: ${selectedOption.text}, Price: ₹${price}`);
            updateServicePrice(selectElement.value, price); // Update the price input if it exists

            // Trigger calculation update
            setTimeout(() => {
                updateTaxCalculations();
            }, 50);
        } else {
            console.warn('No price found for selected service:', selectedOption.text);
            updateServicePrice(selectElement.value, '0.00'); // Reset price if not found
        }
    } else {
        // Reset for empty selection
        updateServicePrice(selectElement.value, '0.00');
        setTimeout(() => {
            updateTaxCalculations();
        }, 50);
    }
}

// Initialize components and event listeners
window.addServiceRow = addServiceRow;
window.addAppointmentToBill = addAppointmentToBill;
window.previewInvoice = previewInvoice;
window.proceedWithInvoiceCreation = proceedWithInvoiceCreation;
window.saveAsDraft = saveAsDraft;
window.sendQuotation = sendQuotation;
window.clearForm = clearForm;
window.findEmptyServiceRow = findEmptyServiceRow;
window.autoFillCurrentServices = autoFillCurrentServices;
window.viewFullCustomerHistory = viewFullCustomerHistory;
window.handleServiceSelection = handleServiceSelection;
window.updateTaxCalculations = updateTaxCalculations;
window.loadBatchesForProduct = loadBatchesForProduct;
window.validateInventoryQuantity = validateInventoryQuantity;
window.loadCustomerAppointmentsForBilling = loadCustomerAppointmentsForBilling; // Expose for dynamic loading
window.autoFillAllAppointments = function() { showNotification('Auto-fill feature is under development.', 'info'); }; // Placeholder

// Set up tax calculation listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('Setting up tax calculation listeners...');

    // Tax and billing input listeners
    const taxBillingInputs = document.querySelectorAll('.tax-input, .billing-input, select[name="service_ids[]"], input[name="service_quantities[]"], input[name="product_quantities[]"], input[name="product_prices[]"]');
    taxBillingInputs.forEach(input => {
        input.addEventListener('input', updateTaxCalculations);
        input.addEventListener('change', updateTaxCalculations);
    });

    // Interstate checkbox listener
    const interstateCheckbox = document.getElementById('is_interstate');
    if (interstateCheckbox) {
        interstateCheckbox.addEventListener('change', toggleTaxType); // Use toggleTaxType for interstate logic
    }

    // Initial calculation on page load
    setTimeout(updateTaxCalculations, 300);

    console.log('Tax calculation listeners set up successfully');
});

// Setup event listeners for service selection changes
function setupServiceChangeListeners() {
    // Monitor service dropdown and quantity changes
    document.addEventListener('change', function(event) {
        if (event.target.matches('select[name="service_ids[]"]') ||
            event.target.matches('input[name="service_quantities[]"]')) {
            handleServiceSelection(event.target);
            setTimeout(updateTaxCalculations, 100);
        }
    });

    // Monitor input changes for quantities and prices
    document.addEventListener('input', function(event) {
        if (event.target.matches('input[name="service_quantities[]"]') ||
            event.target.matches('input[name="product_quantities[]"]') ||
            event.target.matches('input[name="product_prices[]"]')) {
            setTimeout(updateTaxCalculations, 100);
        }
    });

    // Observe mutations for dynamically added service rows
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1 && node.classList.contains('service-row')) {
                    const serviceSelect = node.querySelector('select[name="service_ids[]"]');
                    const quantityInput = node.querySelector('input[name="service_quantities[]"]');

                    if (serviceSelect) {
                        serviceSelect.addEventListener('change', (e) => {
                            handleServiceSelection(e.target);
                            setTimeout(updateTaxCalculations, 100);
                        });
                    }
                    if (quantityInput) {
                        quantityInput.addEventListener('input', () => {
                            setTimeout(updateTaxCalculations, 100);
                        });
                    }
                }
            });
        });
    });

    observer.observe(document.getElementById('servicesContainer'), {
        childList: true,
        subtree: true
    });
}

// --- Action button handlers ---
function proceedWithInvoiceCreation() {
    document.getElementById('billingForm').submit();
}

function printInvoice() {
    const invoiceId = document.getElementById('printInvoiceBtn').dataset.invoiceId;
    if (invoiceId) {
        window.open(`/integrated-billing/print-invoice/${invoiceId}`, '_blank');
    } else {
        alert('Invoice ID not found. Cannot print.');
    }
}

function emailInvoice() {
    const invoiceId = document.getElementById('emailInvoiceBtn').dataset.invoiceId;
    if (invoiceId) {
        alert(`Email invoice functionality for Invoice ID: ${invoiceId} is being processed.`);
    } else {
        alert('Invoice ID not found. Cannot email.');
    }
}

function whatsappInvoice() {
    const invoiceId = document.getElementById('whatsappInvoiceBtn').dataset.invoiceId;
    if (invoiceId) {
        alert(`WhatsApp invoice functionality for Invoice ID: ${invoiceId} is being processed.`);
    } else {
        alert('Invoice ID not found. Cannot send via WhatsApp.');
    }
}

// Auto-select customer and load appointments if coming from appointment context menu
document.addEventListener('DOMContentLoaded', function() {
    // Handle customer selection change for dynamic loading
    const clientSelect = document.getElementById('client_id');
    if (clientSelect) {
        clientSelect.addEventListener('change', function() {
            const customerId = this.value;
            if (customerId) {
                console.log('Loading client data for ID:', customerId);
                // Load packages and trigger appointments loading via loadCustomerAppointmentsForBilling
                document.getElementById('client_id').dispatchEvent(new Event('change')); 
            } else {
                // Clear packages display and hide appointments section
                document.getElementById('customerPackages').innerHTML = 
                    '<small><i class="fas fa-info-circle me-1"></i>Select a customer to view their active packages</small>';
                let appointmentsSection = document.querySelector('#customerAppointmentsSection');
                if (appointmentsSection) {
                    appointmentsSection.style.display = 'none';
                }
            }
        });
    }

    // Auto-select customer if passed via template context
    {% if selected_customer %}
    const customerSelect = document.getElementById('client_id');
    if (customerSelect) {
        customerSelect.value = '{{ selected_customer.id }}';
        // Trigger change event to load packages and appointments
        customerSelect.dispatchEvent(new Event('change'));

        showNotification(
            'Customer Auto-Selected: {{ selected_customer.full_name }}' + 
            {% if customer_appointments|length > 0 %}
            ' - {{ customer_appointments|length }} pending appointment{{ "s" if customer_appointments|length != 1 else "" }} ready for billing'
            {% else %}
            ''
            {% endif %},
            'info'
        );
    }
    {% endif %}
});
</script>
{% endblock %}