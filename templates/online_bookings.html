{% extends "base.html" %}

{% block title %}Online Bookings - Spa Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-globe me-2"></i>Online Booking Management
                </h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" onclick="refreshBookings()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <a href="{{ url_for('website_book_online') }}" class="btn btn-primary" target="_blank">
                        <i class="fas fa-external-link-alt me-2"></i>View Public Booking Page
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1 text-primary">
                                Total Online Bookings
                            </div>
                            <div class="h5 mb-0 font-weight-bold">{{ stats.total }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-warning">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1 text-warning">
                                Pending Review
                            </div>
                            <div class="h5 mb-0 font-weight-bold">{{ stats.pending }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1 text-success">
                                Accepted
                            </div>
                            <div class="h5 mb-0 font-weight-bold">{{ stats.accepted }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-danger">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1 text-danger">
                                Rejected
                            </div>
                            <div class="h5 mb-0 font-weight-bold">{{ stats.rejected }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('online_bookings') }}" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Statuses</option>
                                <option value="scheduled" {% if status_filter == 'scheduled' %}selected{% endif %}>Pending Review</option>
                                <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Accepted</option>
                                <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">From Date</label>
                            <input type="date" name="date_from" class="form-control"
                                   value="{{ date_from.strftime('%Y-%m-%d') if date_from else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">To Date</label>
                            <input type="date" name="date_to" class="form-control"
                                   value="{{ date_to.strftime('%Y-%m-%d') if date_to else '' }}">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-2"></i>Apply Filters
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bookings List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Online Bookings ({{ grouped_bookings|length }} customers)
                    </h5>
                </div>
                <div class="card-body">
                    {% if grouped_bookings %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 50px;"></th>
                                    <th>ID</th>
                                    <th>Customer</th>
                                    <th>Contact</th>
                                    <th>Service</th>
                                    <th>Preferred Date/Time</th>
                                    <th>Amount</th>
                                    <th>Received</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for group in grouped_bookings %}
                                {% set first_booking = group.bookings[0] %}
                                {% set group_id = loop.index %}
                                <tr class="customer-group-row" data-group-id="{{ group_id }}">
                                    <td>
                                        {% if group.bookings|length > 1 %}
                                        <button type="button" class="btn btn-sm btn-link expand-btn" onclick="toggleGroup({{ group_id }})">
                                            <i class="fas fa-chevron-right" id="icon-{{ group_id }}"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                    <td><strong>#{{ first_booking.id }}</strong></td>
                                    <td>
                                        <div>
                                            <strong>{{ group.customer_name }}</strong>
                                            {% if group.client %}
                                            <span class="badge bg-success ms-1">Existing</span>
                                            {% else %}
                                            <span class="badge bg-warning ms-1">New</span>
                                            {% endif %}
                                        </div>
                                        {% if group.bookings|length > 1 %}
                                        <small class="text-muted">{{ group.bookings|length }} services</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div><i class="fas fa-phone text-primary me-2"></i>{{ group.customer_phone }}</div>
                                    </td>
                                    <td>
                                        {% if group.bookings|length == 1 %}
                                        <strong>{{ first_booking.service_name }}</strong>
                                        <div class="text-muted small">{{ first_booking.service_duration }} min</div>
                                        {% else %}
                                        <strong>Multiple Services</strong>
                                        <div class="text-muted small">Click to expand</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div><strong>{{ group.appointment_date.strftime('%b %d, %Y') }}</strong></div>
                                        <div class="text-primary">{{ first_booking.start_time.strftime('%I:%M %p') }}</div>
                                    </td>
                                    <td>
                                        <strong>${{ "%.2f"|format(group.total_amount) }}</strong>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ group.created_at.strftime('%b %d, %I:%M %p') }}
                                        </small>
                                    </td>
                                    <td>
                                        {% if group.status == 'scheduled' %}
                                        <span class="badge bg-warning">Pending Review</span>
                                        {% elif group.status == 'confirmed' %}
                                        <span class="badge bg-success">Accepted</span>
                                        {% elif group.status == 'cancelled' %}
                                        <span class="badge bg-danger">Rejected</span>
                                        {% elif group.status == 'completed' %}
                                        <span class="badge bg-info">Completed</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ group.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="tel:{{ group.customer_phone }}" class="btn btn-primary" title="Call Customer">
                                                <i class="fas fa-phone"></i>
                                            </a>
                                            {% if group.customer_email %}
                                            <a href="mailto:{{ group.customer_email }}" class="btn btn-secondary" title="Email Customer">
                                                <i class="fas fa-envelope"></i>
                                            </a>
                                            {% endif %}
                                            {% if group.status == 'scheduled' %}
                                            <button type="button" class="btn btn-success"
                                                    onclick="acceptGroupBooking({{ group_id }})" title="Accept">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn btn-danger"
                                                    onclick="rejectGroupBooking({{ group_id }})" title="Reject">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>

                                <!-- Sub-appointments (hidden by default) -->
                                {% if group.bookings|length > 1 %}
                                <tr class="sub-appointments" id="sub-{{ group_id }}" style="display: none;">
                                    <td colspan="10">
                                        <div class="ms-5 mb-3">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Booking ID</th>
                                                        <th>Service</th>
                                                        <th>Duration</th>
                                                        <th>Time</th>
                                                        <th>Price</th>
                                                        <th>Staff</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for booking in group.bookings %}
                                                    <tr>
                                                        <td>#{{ booking.id }}</td>
                                                        <td>{{ booking.service_name }}</td>
                                                        <td>{{ booking.service_duration }} min</td>
                                                        <td>{{ booking.start_time.strftime('%I:%M %p') }}</td>
                                                        <td>${{ "%.2f"|format(booking.service_price or 0) }}</td>
                                                        <td>
                                                            {% if booking.staff_name %}
                                                            {{ booking.staff_name }}
                                                            {% else %}
                                                            <span class="text-muted">Not assigned</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No online bookings found</h5>
                        <p class="text-muted">Online bookings will appear here when customers book through your website.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Accept Group Booking Modal -->
<div class="modal fade" id="acceptGroupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Accept Booking - Assign Staff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="acceptGroupForm" method="POST" action="{{ url_for('accept_grouped_booking') }}">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Please assign staff members to each service below before confirming the booking.
                    </div>
                    <div id="servicesContainer">
                        <!-- Services will be dynamically added here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-2"></i>Confirm All Bookings
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Group Booking Modal -->
<div class="modal fade" id="rejectGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Bookings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="rejectGroupForm" method="POST">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Are you sure you want to reject these booking(s)?
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason for Rejection <span class="text-danger">*</span></label>
                        <textarea name="reason" class="form-control" rows="3" required
                                  placeholder="Please provide a reason for rejection..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times me-2"></i>Reject Booking(s)
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.border-left-primary { border-left: 4px solid #4e73df; }
.border-left-success { border-left: 4px solid #1cc88a; }
.border-left-warning { border-left: 4px solid #f6c23e; }
.border-left-danger { border-left: 4px solid #e74a3b; }
.customer-group-row { cursor: pointer; }
.sub-appointments td { background-color: #f8f9fa; }
.expand-btn { padding: 0; }
</style>

<script>
// Store grouped bookings data for JavaScript access
const groupedBookings = {{ grouped_bookings_json|tojson|safe }};

// Toggle group expansion
function toggleGroup(groupId) {
    const subRow = document.getElementById('sub-' + groupId);
    const icon = document.getElementById('icon-' + groupId);

    if (subRow.style.display === 'none') {
        subRow.style.display = 'table-row';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    } else {
        subRow.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
}

// Accept group booking
function acceptGroupBooking(groupId) {
    const group = groupedBookings[groupId - 1];
    const container = document.getElementById('servicesContainer');
    container.innerHTML = '';

    // Add each booking as a service with staff assignment dropdown
    group.bookings.forEach((booking, index) => {
        const serviceDiv = document.createElement('div');
        serviceDiv.className = 'mb-3 p-3 border rounded';
        serviceDiv.innerHTML = `
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-1">${booking.service_name}</h6>
                    <small class="text-muted">
                        ${booking.service_duration} min |
                        ${new Date(booking.start_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })} |
                        $${parseFloat(booking.service_price || 0).toFixed(2)}
                    </small>
                </div>
                <div class="col-md-6">
                    <label class="form-label small mb-1">Assign Staff</label>
                    <select name="staff_${booking.id}" class="form-select" required>
                        <option value="">Select staff member...</option>
                        {% for staff in staff_members %}
                        <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                        {% endfor %}
                    </select>
                    <input type="hidden" name="booking_ids[]" value="${booking.id}">
                </div>
            </div>
        `;
        container.appendChild(serviceDiv);
    });

    const modal = new bootstrap.Modal(document.getElementById('acceptGroupModal'));
    modal.show();
}

// Reject group booking
function rejectGroupBooking(groupId) {
    const group = groupedBookings[groupId - 1];
    const form = document.getElementById('rejectGroupForm');

    // Set form action to reject all bookings in this group
    form.action = '{{ url_for("bulk_action_online_bookings") }}';

    // Clear any existing hidden inputs
    form.querySelectorAll('input[name="booking_ids[]"]').forEach(input => input.remove());

    // Add hidden inputs for all booking IDs in the group
    group.bookings.forEach(booking => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'booking_ids[]';
        input.value = booking.id;
        form.appendChild(input);
    });

    // Add action type
    let actionInput = form.querySelector('input[name="action"]');
    if (!actionInput) {
        actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        form.appendChild(actionInput);
    }
    actionInput.value = 'reject';

    const modal = new bootstrap.Modal(document.getElementById('rejectGroupModal'));
    modal.show();
}

// Refresh bookings
function refreshBookings() {
    location.reload();
}
</script>

{% endblock %}