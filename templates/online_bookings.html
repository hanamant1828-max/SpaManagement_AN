{% extends "base.html" %}

{% block title %}Online Bookings - Spa Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-globe me-2"></i>Online Booking Management
                </h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" onclick="refreshBookings()">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                    <a href="{{ url_for('website_book_online') }}" class="btn btn-primary" target="_blank">
                        <i class="fas fa-external-link-alt me-2"></i>View Public Booking Page
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-left-primary">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1 text-primary">
                                Total Online Bookings
                            </div>
                            <div class="h5 mb-0 font-weight-bold">{{ stats.total }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-warning">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1 text-warning">
                                Pending Review
                            </div>
                            <div class="h5 mb-0 font-weight-bold">{{ stats.pending }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-success">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1 text-success">
                                Accepted
                            </div>
                            <div class="h5 mb-0 font-weight-bold">{{ stats.accepted }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-left-danger">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs font-weight-bold text-uppercase mb-1 text-danger">
                                Rejected
                            </div>
                            <div class="h5 mb-0 font-weight-bold">{{ stats.rejected }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="GET" action="{{ url_for('online_bookings') }}" class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Status</label>
                            <select name="status" class="form-select">
                                <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Statuses</option>
                                <option value="scheduled" {% if status_filter == 'scheduled' %}selected{% endif %}>Pending Review</option>
                                <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Accepted</option>
                                <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">From Date</label>
                            <input type="date" name="date_from" class="form-control"
                                   value="{{ date_from.strftime('%Y-%m-%d') if date_from else '' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">To Date</label>
                            <input type="date" name="date_to" class="form-control"
                                   value="{{ date_to.strftime('%Y-%m-%d') if date_to else '' }}">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-filter me-2"></i>Apply Filters
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bookings List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Online Bookings ({{ grouped_bookings|length }} customers)
                    </h5>
                </div>
                <div class="card-body">
                    {% if grouped_bookings %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th style="width: 50px;"></th>
                                    <th>ID</th>
                                    <th>Customer</th>
                                    <th>Contact</th>
                                    <th>Service</th>
                                    <th>Preferred Date/Time</th>
                                    <th>Amount</th>
                                    <th>Received</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for group in grouped_bookings %}
                                {% set first_booking = group.bookings[0] %}
                                {% set group_id = loop.index %}
                                <tr class="customer-group-row" data-group-id="{{ group_id }}">
                                    <td>
                                        {% if group.bookings|length > 1 %}
                                        <button type="button" class="btn btn-sm btn-link expand-btn" onclick="toggleGroup({{ group_id }})">
                                            <i class="fas fa-chevron-right" id="icon-{{ group_id }}"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                    <td><strong>#{{ first_booking.id }}</strong></td>
                                    <td>
                                        <div>
                                            <strong>{{ group.customer_name }}</strong>
                                            {% if group.client %}
                                            <span class="badge bg-success ms-1">Existing</span>
                                            {% else %}
                                            <span class="badge bg-warning ms-1">New</span>
                                            {% endif %}
                                        </div>
                                        {% if group.bookings|length > 1 %}
                                        <small class="text-muted">{{ group.bookings|length }} services</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div><i class="fas fa-phone text-primary me-2"></i>{{ group.customer_phone }}</div>
                                    </td>
                                    <td>
                                        {% if group.bookings|length == 1 %}
                                        <strong>{{ first_booking.service_name }}</strong>
                                        <div class="text-muted small">{{ first_booking.service_duration }} min</div>
                                        {% else %}
                                        <strong>Multiple Services</strong>
                                        <div class="text-muted small">Click to expand</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div><strong>{{ group.appointment_date.strftime('%b %d, %Y') }}</strong></div>
                                        <div class="text-primary">{{ first_booking.start_time.strftime('%I:%M %p') }}</div>
                                    </td>
                                    <td>
                                        <strong>${{ "%.2f"|format(group.total_amount) }}</strong>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {{ group.created_at.strftime('%b %d, %I:%M %p') }}
                                        </small>
                                    </td>
                                    <td>
                                        {% if group.status == 'scheduled' %}
                                        <span class="badge bg-warning">Pending Review</span>
                                        {% elif group.status == 'confirmed' %}
                                        <span class="badge bg-success">Accepted</span>
                                        {% elif group.status == 'cancelled' %}
                                        <span class="badge bg-danger">Rejected</span>
                                        {% elif group.status == 'completed' %}
                                        <span class="badge bg-info">Completed</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ group.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="tel:{{ group.customer_phone }}" class="btn btn-primary" title="Call Customer">
                                                <i class="fas fa-phone"></i>
                                            </a>
                                            {% if group.status == 'scheduled' %}
                                            <a href="{{ url_for('accept_booking_page', group_id=group_id) }}" 
                                               class="btn btn-success" title="Accept Booking">
                                                <i class="fas fa-check"></i>
                                            </a>
                                            <button type="button" class="btn btn-danger"
                                                    onclick="rejectGroupBooking({{ group_id }})" title="Reject">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>

                                <!-- Sub-appointments (hidden by default) -->
                                {% if group.bookings|length > 1 %}
                                <tr class="sub-appointments" id="sub-{{ group_id }}" style="display: none;">
                                    <td colspan="10">
                                        <div class="ms-5 mb-3">
                                            <table class="table table-sm table-bordered">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>Booking ID</th>
                                                        <th>Service</th>
                                                        <th>Duration</th>
                                                        <th>Time</th>
                                                        <th>Price</th>
                                                        <th>Staff</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for booking in group.bookings %}
                                                    <tr>
                                                        <td>#{{ booking.id }}</td>
                                                        <td>{{ booking.service_name }}</td>
                                                        <td>{{ booking.service_duration }} min</td>
                                                        <td>{{ booking.start_time.strftime('%I:%M %p') }}</td>
                                                        <td>${{ "%.2f"|format(booking.service_price or 0) }}</td>
                                                        <td>
                                                            {% if booking.staff_name %}
                                                            {{ booking.staff_name }}
                                                            {% else %}
                                                            <span class="text-muted">Not assigned</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No online bookings found</h5>
                        <p class="text-muted">Online bookings will appear here when customers book through your website.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Accept Group Booking Modal -->
<div class="modal fade" id="acceptGroupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Accept Booking - Assign Staff</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="acceptGroupForm" method="POST" action="{{ url_for('accept_grouped_booking') }}" onsubmit="return validateAcceptForm()">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Please assign staff members to each service below before confirming the booking.
                    </div>

                    <div id="breakTimeWarning" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-coffee me-2"></i>
                        <strong>Break/Lunch Time Notice:</strong>
                        <div id="breakTimeDetails"></div>
                    </div>

                    <div id="acceptFormErrors" class="alert alert-danger" style="display: none;"></div>

                    <!-- Conflict warning with time change option -->
                    <div id="conflictWarning" class="alert alert-warning border-warning" style="display: none;">
                        <div class="d-flex align-items-start mb-3">
                            <div class="flex-grow-1">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Scheduling Conflicts Detected:</strong>
                                <div id="conflictMessages" class="mt-2"></div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 mb-3">
                            <button type="button" class="btn btn-primary btn-lg" onclick="showTimeChangeSection()">
                                <i class="fas fa-clock me-2"></i>Change Time & Date
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="forceConfirmBookings()">
                                <i class="fas fa-exclamation-circle me-2"></i>Confirm Anyway
                            </button>
                        </div>

                        <!-- Time Change Section -->
                        <div id="timeChangeSection" class="mt-3 p-3 border rounded bg-white shadow-sm" style="display: none;">
                            <h6 class="mb-3 text-primary">
                                <i class="fas fa-clock me-2"></i>Select New Date & Time
                            </h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">New Date</label>
                                    <input type="date" id="newBookingDate" class="form-control" onchange="updateEndTime()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Start Time</label>
                                    <input type="time" id="newStartTime" class="form-control" onchange="updateEndTime()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">End Time <small class="text-muted">(Auto)</small></label>
                                    <input type="time" id="newEndTime" class="form-control" readonly style="background-color: #f8f9fa;">
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-success w-100" onclick="validateNewTime()">
                                        <i class="fas fa-check me-1"></i>Validate
                                    </button>
                                </div>
                            </div>

                            <!-- Validation Result -->
                            <div id="timeValidationResult" class="mt-3" style="display: none;"></div>

                            <!-- Suggested Times -->
                            <div id="suggestedTimesContainer" class="mt-3" style="display: none;">
                                <h6 class="small mb-2">
                                    <i class="fas fa-lightbulb me-2"></i>Suggested Available Times:
                                </h6>
                                <div id="suggestedTimes" class="d-flex flex-wrap gap-2"></div>
                            </div>
                        </div>
                    </div>

                    <div id="servicesContainer">
                        <!-- Services will be dynamically added here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-success" id="confirmBookingsBtn">
                        <i class="fas fa-check me-2"></i>Confirm All Bookings
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reschedule Booking Modal (for break time conflicts) -->
<div class="modal fade" id="rescheduleConflictModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-clock me-2"></i>Break Time Conflict - Reschedule Required
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="rescheduleConflictForm" method="POST" action="{{ url_for('accept_grouped_booking') }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-coffee me-2"></i>
                        <strong>The selected time overlaps with the staff's break/lunch time.</strong>
                    </div>

                    <div id="conflictBookingDetails" class="mb-3">
                        <!-- Will be populated by JavaScript -->
                    </div>

                    <div class="mb-3">
                        <label class="form-label">New Date</label>
                        <input type="date" id="rescheduleDate" class="form-control" required>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">New Start Time</label>
                            <input type="time" id="rescheduleStartTime" class="form-control" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">New End Time</label>
                            <input type="time" id="rescheduleEndTime" class="form-control" readonly>
                        </div>
                    </div>

                    <div id="rescheduleConflictWarning" class="alert alert-danger" style="display: none;">
                        <!-- Conflict warnings will appear here -->
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Suggested time slots:</strong>
                        <div id="suggestedTimeSlots" class="mt-2">
                            <!-- Will be populated with suggested times -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="confirmRescheduleBtn">
                        <i class="fas fa-check me-2"></i>Reschedule & Accept Booking
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reject Group Booking Modal -->
<div class="modal fade" id="rejectGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Bookings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="rejectGroupForm" method="POST">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Are you sure you want to reject these booking(s)?
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reason for Rejection <span class="text-danger">*</span></label>
                        <textarea name="reason" class="form-control" rows="3" required
                                  placeholder="Please provide a reason for rejection..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-times me-2"></i>Reject Booking(s)
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.border-left-primary { border-left: 4px solid #4e73df; }
.border-left-success { border-left: 4px solid #1cc88a; }
.border-left-warning { border-left: 4px solid #f6c23e; }
.border-left-danger { border-left: 4px solid #e74a3b; }
.customer-group-row { cursor: pointer; }
.sub-appointments td { background-color: #f8f9fa; }
.expand-btn { padding: 0; }

/* Pulse animation for confirm button */
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}
.pulse-animation {
    animation: pulse 2s infinite;
}
</style>

<script>
// Store grouped bookings data for JavaScript access
const groupedBookings = {{ grouped_bookings_json|tojson|safe }};

// Toggle group expansion
function toggleGroup(groupId) {
    const subRow = document.getElementById('sub-' + groupId);
    const icon = document.getElementById('icon-' + groupId);

    if (subRow.style.display === 'none') {
        subRow.style.display = 'table-row';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    } else {
        subRow.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
}

// Accept group booking
function acceptGroupBooking(groupId) {
    const group = groupedBookings[groupId - 1];
    const container = document.getElementById('servicesContainer');
    container.innerHTML = '';

    // Add each booking as a service with staff assignment dropdown
    group.bookings.forEach((booking, index) => {
        const serviceDiv = document.createElement('div');
        serviceDiv.className = 'mb-3 p-3 border rounded';

        // Format the time properly - booking.start_time is already in ISO format
        let timeDisplay = 'N/A';
        if (booking.start_time) {
            const timeObj = new Date(booking.start_time);
            timeDisplay = timeObj.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        }

        serviceDiv.innerHTML = `
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-1">${booking.service_name}</h6>
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>${booking.service_duration} min |
                        <i class="fas fa-calendar-alt me-1"></i>${timeDisplay} |
                        <i class="fas fa-rupee-sign me-1"></i>${parseFloat(booking.service_price || 0).toFixed(2)}
                    </small>
                </div>
                <div class="col-md-6">
                    <label class="form-label small mb-1">Assign Staff</label>
                    <select name="staff_${booking.id}" class="form-select staff-select" data-booking-time="${booking.start_time}" required>
                        <option value="">Select staff member...</option>
                        {% for staff in staff_members %}
                        <option value="{{ staff.id }}" data-staff-name="{{ staff.full_name }}">{{ staff.full_name }}</option>
                        {% endfor %}
                    </select>
                    <input type="hidden" name="booking_ids[]" value="${booking.id}">
                    <small class="text-muted mt-1" style="display: block;">
                        <i class="fas fa-info-circle me-1"></i>Check staff availability before assigning
                    </small>
                </div>
            </div>
        `;
        container.appendChild(serviceDiv);
    });

    // Show helpful note about break times
    const breakTimeWarning = document.getElementById('breakTimeWarning');
    const breakTimeDetails = document.getElementById('breakTimeDetails');
    breakTimeDetails.innerHTML = `
        Most staff members have lunch/break times between 12:00 PM - 2:00 PM.<br>
        If you see a conflict error, please choose a time slot before or after this period.
    `;
    breakTimeWarning.style.display = 'block';

    const modal = new bootstrap.Modal(document.getElementById('acceptGroupModal'));
    modal.show();
}

// Reject group booking
function rejectGroupBooking(groupId) {
    const group = groupedBookings[groupId - 1];
    const form = document.getElementById('rejectGroupForm');

    // Set form action to reject all bookings in this group
    form.action = '{{ url_for("bulk_action_online_bookings") }}';

    // Clear any existing hidden inputs
    form.querySelectorAll('input[name="booking_ids[]"]').forEach(input => input.remove());

    // Add hidden inputs for all booking IDs in the group
    group.bookings.forEach(booking => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'booking_ids[]';
        input.value = booking.id;
        form.appendChild(input);
    });

    // Add action type
    let actionInput = form.querySelector('input[name="action"]');
    if (!actionInput) {
        actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        form.appendChild(actionInput);
    }
    actionInput.value = 'reject';

    const modal = new bootstrap.Modal(document.getElementById('rejectGroupModal'));
    modal.show();
}

// Validate accept form before submission
function validateAcceptForm() {
    const form = document.getElementById('acceptGroupForm');
    const staffSelects = form.querySelectorAll('select[name^="staff_"]');
    const errorDiv = document.getElementById('acceptFormErrors');
    const errors = [];

    // Check if all staff members are assigned
    staffSelects.forEach((select, index) => {
        if (!select.value) {
            errors.push(`Service ${index + 1}: Please select a staff member`);
        }
    });

    if (errors.length > 0) {
        errorDiv.innerHTML = '<strong>Please fix the following errors:</strong><ul class="mb-0 mt-2">' + 
            errors.map(err => `<li>${err}</li>`).join('') + '</ul>';
        errorDiv.style.display = 'block';
        return false;
    }

    errorDiv.style.display = 'none';

    // Don't show loading if there are conflicts - let user change time
    const conflictWarning = document.getElementById('conflictWarning');
    if (conflictWarning && conflictWarning.style.display !== 'none') {
        // Conflicts exist - don't submit, show time change option
        showTimeChangeSection();
        return false;
    }

    // Show loading state only if no conflicts
    const submitBtn = document.getElementById('confirmBookingsBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

    return true;
}

// Check for conflicts when staff is assigned
function checkStaffConflicts(bookingId, staffId, bookingTime) {
    if (!staffId || !bookingTime) return;

    // For demonstration, we'll let the backend validate on submission
    // Real-time validation could be added here if needed
}

// Store original booking time and conflict data
let originalBookingTime = null;
let conflictedBooking = null;

// Show time change section with pre-filled current booking time
function showTimeChangeSection() {
    const section = document.getElementById('timeChangeSection');
    section.style.display = 'block';

    // Get booking data from services container
    const bookingIds = document.querySelectorAll('input[name="booking_ids[]"]');
    if (bookingIds.length > 0) {
        const firstBookingId = bookingIds[0].value;
        const group = groupedBookings.find(g => 
            g.bookings.some(b => b.id == firstBookingId)
        );

        if (group && group.bookings[0]) {
            const booking = group.bookings[0];
            originalBookingTime = {
                id: booking.id,
                start_time: booking.start_time,
                duration: booking.service_duration
            };

            // Set current date and time
            const timeObj = new Date(booking.start_time);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            document.getElementById('newBookingDate').value = timeObj.toISOString().split('T')[0];
            document.getElementById('newBookingDate').min = today.toISOString().split('T')[0];
            document.getElementById('newStartTime').value = timeObj.toTimeString().substr(0, 5);

            // Calculate and set end time
            updateEndTime();
        }
    }

    // Clear previous validation results
    document.getElementById('timeValidationResult').style.display = 'none';
    document.getElementById('suggestedTimesContainer').style.display = 'none';
}

// Update end time based on start time and service duration
function updateEndTime() {
    const startTimeInput = document.getElementById('newStartTime');
    const endTimeInput = document.getElementById('newEndTime');
    
    if (originalBookingTime && originalBookingTime.duration && startTimeInput.value) {
        const [hours, minutes] = startTimeInput.value.split(':').map(Number);
        const totalMinutes = hours * 60 + minutes + originalBookingTime.duration;
        const endHours = Math.floor(totalMinutes / 60) % 24;
        const endMinutes = totalMinutes % 60;
        endTimeInput.value = `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
    }
}

// Auto-calculate end time when start time changes
document.addEventListener('DOMContentLoaded', function() {
    const newStartTimeInput = document.getElementById('newStartTime');
    if (newStartTimeInput) {
        newStartTimeInput.addEventListener('change', function() {
            if (originalBookingTime && originalBookingTime.duration) {
                const startTime = this.value;
                const [hours, minutes] = startTime.split(':').map(Number);
                const totalMinutes = hours * 60 + minutes + originalBookingTime.duration;
                const endHours = Math.floor(totalMinutes / 60);
                const endMinutes = totalMinutes % 60;
                const endTime = `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
                document.getElementById('newEndTime').value = endTime;
            }
        });
    }
});

// Validate new time selection
function validateNewTime() {
    const bookingIds = document.querySelectorAll('input[name="booking_ids[]"]');
    if (bookingIds.length === 0) {
        alert('No booking selected');
        return;
    }

    const bookingId = bookingIds[0].value;
    const staffSelect = document.querySelector(`select[name="staff_${bookingId}"]`);
    if (!staffSelect || !staffSelect.value) {
        alert('Please assign a staff member first');
        return;
    }

    const staffId = staffSelect.value;
    const newDate = document.getElementById('newBookingDate').value;
    const newStartTime = document.getElementById('newStartTime').value;
    const newEndTime = document.getElementById('newEndTime').value;

    if (!newDate || !newStartTime || !newEndTime) {
        alert('Please select date and time');
        return;
    }

    // Show loading state
    const validationResult = document.getElementById('timeValidationResult');
    validationResult.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>Validating...';
    validationResult.className = 'mt-3 alert alert-info';
    validationResult.style.display = 'block';

    // Make AJAX request to validate
    fetch('/api/validate-booking-time-change', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            booking_id: bookingId,
            staff_id: staffId,
            appointment_date: newDate,
            start_time: newStartTime,
            end_time: newEndTime
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.valid) {
                // No conflicts - time is valid
                validationResult.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-2 text-success" style="font-size: 1.5rem;"></i>
                        <div>
                            <strong>Perfect! This time is available.</strong><br>
                            <small>Click "Confirm with New Time" below to book the appointment.</small>
                        </div>
                    </div>
                `;
                validationResult.className = 'mt-3 alert alert-success border-success';

                // Enable "Confirm with New Time" button with clear styling
                const confirmBtn = document.getElementById('confirmBookingsBtn');
                confirmBtn.disabled = false;
                confirmBtn.className = 'btn btn-success btn-lg pulse-animation';
                confirmBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Confirm with New Time';

                // Store the new time for submission with validated flag
                window.conflictedBooking = {
                    id: bookingId,
                    newDate: newDate,
                    newStartTime: newStartTime,
                    newEndTime: newEndTime,
                    staffId: staffId,
                    validated: true
                };

                // Hide conflict warning
                document.getElementById('conflictWarning').style.display = 'none';
                // Hide suggestions
                document.getElementById('suggestedTimesContainer').style.display = 'none';
            } else {
                // Still has conflicts
                let errorHtml = '<i class="fas fa-exclamation-triangle me-2"></i>' + data.message;
                if (data.errors && data.errors.length > 0) {
                    errorHtml += '<ul class="mb-0 mt-2">';
                    data.errors.forEach(err => {
                        errorHtml += `<li><strong>${err.category}:</strong> ${err.message}</li>`;
                    });
                    errorHtml += '</ul>';
                }
                validationResult.innerHTML = errorHtml;
                validationResult.className = 'mt-3 alert alert-danger';

                // Show suggestions if available
                if (data.suggestions && data.suggestions.length > 0) {
                    displaySuggestedTimes(data.suggestions);
                }
            }
        } else {
            validationResult.innerHTML = '<i class="fas fa-times-circle me-2"></i>Error: ' + data.error;
            validationResult.className = 'mt-3 alert alert-danger';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        validationResult.innerHTML = '<i class="fas fa-times-circle me-2"></i>Failed to validate time. Please try again.';
        validationResult.className = 'mt-3 alert alert-danger';
    });
}

// Display suggested available times
function displaySuggestedTimes(suggestions) {
    const container = document.getElementById('suggestedTimesContainer');
    const timesDiv = document.getElementById('suggestedTimes');

    if (!suggestions || suggestions.length === 0) {
        container.style.display = 'none';
        return;
    }

    let html = '';
    suggestions.forEach(slot => {
        html += `
            <button type="button" class="btn btn-sm btn-outline-primary" 
                    onclick="applySuggestedTimeSlot('${slot.start_time}', '${slot.end_time}')">
                <i class="fas fa-clock me-1"></i>${slot.display}
            </button>
        `;
    });

    timesDiv.innerHTML = html;
    container.style.display = 'block';
}

// Apply a suggested time slot
function applySuggestedTimeSlot(startTime, endTime) {
    document.getElementById('newStartTime').value = startTime;
    document.getElementById('newEndTime').value = endTime;

    // Automatically validate the suggested time
    validateNewTime();
}

// Force confirm bookings (override conflict warning)
function forceConfirmBookings() {
    if (confirm('Are you sure you want to confirm this booking despite the conflicts? This may cause scheduling issues.')) {
        document.getElementById('acceptGroupForm').submit();
    }
}

// Override form submission to handle time changes and conflicts
document.addEventListener('DOMContentLoaded', function() {
    const acceptForm = document.getElementById('acceptGroupForm');
    if (acceptForm) {
        acceptForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // If we have a validated time change, submit with new time
            if (window.conflictedBooking && window.conflictedBooking.validated) {
                submitWithTimeChange();
                return;
            }
            
            // Otherwise, submit normally and check for conflicts
            const formData = new FormData(acceptForm);
            const submitBtn = document.getElementById('confirmBookingsBtn');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Checking...';
            
            fetch(acceptForm.action, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Success - reload page
                    location.reload();
                } else if (data.has_conflicts) {
                    // Conflicts detected - show conflict warning and keep modal open
                    displayConflicts(data.conflict_messages);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Confirm All Bookings';
                } else {
                    // Other error
                    alert('Error: ' + (data.error || 'Unknown error occurred'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Confirm All Bookings';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting form. Please try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Confirm All Bookings';
            });
        });
    }
});

// Display conflict messages in the modal
function displayConflicts(messages) {
    const conflictWarning = document.getElementById('conflictWarning');
    const conflictMessages = document.getElementById('conflictMessages');
    
    if (messages && messages.length > 0) {
        conflictMessages.innerHTML = '<ul class="mb-0">' + 
            messages.map(msg => `<li>${msg}</li>`).join('') + 
            '</ul>';
        conflictWarning.style.display = 'block';
        
        // Scroll to conflict warning
        conflictWarning.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}

// Submit booking with time change
function submitWithTimeChange() {
    const submitBtn = document.getElementById('confirmBookingsBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating & Confirming...';

    fetch(`/api/online-bookings/${conflictedBooking.id}/update-time`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            booking_id: conflictedBooking.id,
            staff_id: conflictedBooking.staffId,
            appointment_date: conflictedBooking.newDate,
            start_time: conflictedBooking.newStartTime,
            end_time: conflictedBooking.newEndTime
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message and reload
            alert('✅ ' + data.message);
            location.reload();
        } else {
            alert('❌ Error: ' + data.error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Confirm All Bookings';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update booking. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Confirm All Bookings';
    });
}

// Handle reschedule modal for break time conflicts
function showRescheduleModal(conflictBooking) {
    const modal = new bootstrap.Modal(document.getElementById('rescheduleConflictModal'));

    // Populate booking details
    const detailsDiv = document.getElementById('conflictBookingDetails');
    detailsDiv.innerHTML = `
        <div class="card">
            <div class="card-body">
                <h6 class="card-title">Booking Details</h6>
                <p class="mb-1"><strong>Client:</strong> ${conflictBooking.client_name}</p>
                <p class="mb-1"><strong>Service:</strong> ${conflictBooking.service_name}</p>
                <p class="mb-1"><strong>Current Date:</strong> ${new Date(conflictBooking.current_date).toLocaleDateString()}</p>
                <p class="mb-1"><strong>Current Time:</strong> ${conflictBooking.current_start_time} - ${conflictBooking.current_end_time}</p>
                <div class="alert alert-warning mt-2 mb-0">
                    <small>${conflictBooking.error}</small>
                </div>
            </div>
        </div>
    `;

    // Set default values
    document.getElementById('rescheduleDate').value = conflictBooking.current_date;
    document.getElementById('rescheduleStartTime').value = conflictBooking.current_start_time;
    document.getElementById('rescheduleEndTime').value = conflictBooking.current_end_time;

    // Store booking data for submission
    document.getElementById('rescheduleConflictForm').dataset.bookingId = conflictBooking.id;
    document.getElementById('rescheduleConflictForm').dataset.staffId = conflictBooking.staff_id;

    // Generate suggested time slots
    generateSuggestedTimeSlots(conflictBooking);

    modal.show();
}

// Generate suggested time slots avoiding break times
function generateSuggestedTimeSlots(booking) {
    const slotsDiv = document.getElementById('suggestedTimeSlots');
    const currentStart = booking.current_start_time;
    const currentEnd = booking.current_end_time;

    // Calculate service duration
    const [startH, startM] = currentStart.split(':').map(Number);
    const [endH, endM] = currentEnd.split(':').map(Number);
    const durationMinutes = (endH * 60 + endM) - (startH * 60 + startM);

    // Suggest slots before and after typical lunch break (12:00 - 14:00)
    const suggestions = [
        { label: 'Before Lunch', time: '10:00' },
        { label: 'Before Lunch', time: '11:00' },
        { label: 'After Lunch', time: '14:00' },
        { label: 'After Lunch', time: '15:00' },
        { label: 'After Lunch', time: '16:00' }
    ];

    let html = '<div class="btn-group-vertical w-100" role="group">';
    suggestions.forEach(slot => {
        const endTime = calculateEndTime(slot.time, durationMinutes);
        html += `
            <button type="button" class="btn btn-outline-primary text-start" 
                    onclick="applySuggestedTime('${slot.time}', '${endTime}')">
                <i class="fas fa-clock me-2"></i>${slot.label}: ${slot.time} - ${endTime}
            </button>
        `;
    });
    html += '</div>';

    slotsDiv.innerHTML = html;
}

// Apply suggested time to form
function applySuggestedTime(startTime, endTime) {
    document.getElementById('rescheduleStartTime').value = startTime;
    document.getElementById('rescheduleEndTime').value = endTime;

    // Check for conflicts with new time
    checkRescheduleConflicts();
}

// Calculate end time based on duration
function calculateEndTime(startTime, durationMinutes) {
    const [hours, minutes] = startTime.split(':').map(Number);
    const totalMinutes = hours * 60 + minutes + durationMinutes;
    const endHours = Math.floor(totalMinutes / 60);
    const endMinutes = totalMinutes % 60;
    return `${String(endHours).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;
}

// Auto-calculate end time when start time changes
document.addEventListener('DOMContentLoaded', function() {
    const startTimeInput = document.getElementById('rescheduleStartTime');
    if (startTimeInput) {
        startTimeInput.addEventListener('change', function() {
            const form = document.getElementById('rescheduleConflictForm');
            const bookingId = form.dataset.bookingId;

            // Get original duration from conflict booking
            const currentStart = document.getElementById('rescheduleStartTime').value;
            const currentEnd = document.getElementById('rescheduleEndTime').value;

            if (currentStart && currentEnd) {
                const [startH, startM] = currentStart.split(':').map(Number);
                const [endH, endM] = currentEnd.split(':').map(Number);
                const durationMinutes = (endH * 60 + endM) - (startH * 60 + startM);

                const newEndTime = calculateEndTime(this.value, durationMinutes);
                document.getElementById('rescheduleEndTime').value = newEndTime;

                checkRescheduleConflicts();
            }
        });
    }

    // Handle reschedule form submission
    const rescheduleForm = document.getElementById('rescheduleConflictForm');
    if (rescheduleForm) {
        rescheduleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitReschedule();
        });
    }
});

// Check for conflicts with rescheduled time
function checkRescheduleConflicts() {
    const form = document.getElementById('rescheduleConflictForm');
    const staffId = form.dataset.staffId;
    const date = document.getElementById('rescheduleDate').value;
    const startTime = document.getElementById('rescheduleStartTime').value;
    const endTime = document.getElementById('rescheduleEndTime').value;

    if (!staffId || !date || !startTime || !endTime) return;

    // In a real implementation, make AJAX call to check conflicts
    // For now, just hide the warning
    document.getElementById('rescheduleConflictWarning').style.display = 'none';
}

// Submit rescheduled booking
function submitReschedule() {
    const form = document.getElementById('rescheduleConflictForm');
    const bookingId = form.dataset.bookingId;
    const staffId = form.dataset.staffId;
    const date = document.getElementById('rescheduleDate').value;
    const startTime = document.getElementById('rescheduleStartTime').value;
    const endTime = document.getElementById('rescheduleEndTime').value;

    const submitBtn = document.getElementById('confirmRescheduleBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

    // Update booking time via AJAX
    fetch(`/api/online-bookings/${bookingId}/reschedule`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            appointment_date: date,
            start_time: startTime,
            end_time: endTime,
            staff_id: staffId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload page
            bootstrap.Modal.getInstance(document.getElementById('rescheduleConflictModal')).hide();
            location.reload();
        } else {
            document.getElementById('rescheduleConflictWarning').innerHTML = 
                `<i class="fas fa-exclamation-triangle me-2"></i>${data.error}`;
            document.getElementById('rescheduleConflictWarning').style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Reschedule & Accept Booking';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Reschedule & Accept Booking';
    });
}

// Refresh bookings
function refreshBookings() {
    location.reload();
}
</script>

{% endblock %}