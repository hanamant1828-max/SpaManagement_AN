
{% extends "base.html" %}

{% block title %}Edit Invoice - {{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-edit"></i>
            Edit Invoice {{ invoice.invoice_number }}
        </h1>
        <p class="page-subtitle">
            Modify invoice details and line items
        </p>
    </div>

    <form id="editBillingForm" method="POST" action="/integrated-billing/update/{{ invoice.id }}">
        <div class="row">
            <div class="col-lg-8">
                <!-- Customer Section (Read-only) -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6><i class="fas fa-user"></i> Customer Information</h6>
                    </div>
                    <div class="card-body">
                        <input type="hidden" name="client_id" value="{{ invoice.client_id }}">
                        <p><strong>{{ invoice.customer.full_name }}</strong></p>
                        <p>Phone: {{ invoice.customer.phone }}</p>
                    </div>
                </div>

                <!-- Services Section -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6><i class="fas fa-spa"></i> Services</h6>
                    </div>
                    <div class="card-body">
                        <div id="servicesContainer">
                            {% for item in service_items %}
                            <div class="row mb-2 service-row">
                                <div class="col-md-4">
                                    <select name="service_ids[]" class="form-select" required>
                                        {% for service in services %}
                                        <option value="{{ service.id }}" {% if service.id == item.service_id %}selected{% endif %}>
                                            {{ service.name }} - ₹{{ "%.2f"|format(service.price) }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" name="service_quantities[]" class="form-control" 
                                           value="{{ item.quantity }}" min="1" step="0.5" required>
                                </div>
                                <div class="col-md-3">
                                    <select name="staff_ids[]" class="form-select" required>
                                        <option value="">Select Staff</option>
                                        {% for staff in staff_members %}
                                        <option value="{{ staff.id }}" {% if staff.id == item.staff_id %}selected{% endif %}>
                                            {{ staff.full_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="hidden" name="appointment_ids[]" value="{{ item.appointment_id or '' }}">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeServiceRow(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" onclick="addServiceRow()">
                            <i class="fas fa-plus"></i> Add Service
                        </button>
                    </div>
                </div>

                <!-- Products Section -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6><i class="fas fa-box"></i> Products</h6>
                    </div>
                    <div class="card-body">
                        <div id="productsContainer">
                            {% for item in product_items %}
                            <div class="row mb-2 product-row">
                                <div class="col-md-3">
                                    <select name="product_ids[]" class="form-select">
                                        {% for product in inventory_items %}
                                        <option value="{{ product.id }}" {% if product.id == item.product_id %}selected{% endif %}>
                                            {{ product.name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" name="product_quantities[]" class="form-control" 
                                           value="{{ item.quantity }}" min="1">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" name="product_prices[]" class="form-control" 
                                           value="{{ item.unit_price }}" step="0.01">
                                </div>
                                <div class="col-md-3">
                                    <select name="product_staff_ids[]" class="form-select">
                                        <option value="">Select Staff</option>
                                        {% for staff in staff_members %}
                                        <option value="{{ staff.id }}" {% if staff.id == item.staff_id %}selected{% endif %}>
                                            {{ staff.full_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="hidden" name="batch_ids[]" value="{{ item.batch_id }}">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeProductRow(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Tax & Charges -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6><i class="fas fa-receipt"></i> Tax & Additional Charges</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label>CGST Rate (%)</label>
                                <input type="number" name="cgst_rate" class="form-control" 
                                       value="{{ invoice.cgst_rate }}" step="0.01">
                            </div>
                            <div class="col-md-6">
                                <label>SGST Rate (%)</label>
                                <input type="number" name="sgst_rate" class="form-control" 
                                       value="{{ invoice.sgst_rate }}" step="0.01">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <label>Discount</label>
                                <input type="number" name="discount_value" class="form-control" 
                                       value="{{ invoice.discount_amount }}" step="0.01">
                            </div>
                            <div class="col-md-6">
                                <label>Additional Charges</label>
                                <input type="number" name="additional_charges" class="form-control" 
                                       value="{{ invoice.additional_charges }}" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-calculator"></i> Invoice Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <strong id="displaySubtotal">₹{{ "%.2f"|format(invoice.gross_subtotal) }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Discount:</span>
                            <strong id="displayDiscount">-₹{{ "%.2f"|format(invoice.discount_amount) }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tax:</span>
                            <strong id="displayTax">₹{{ "%.2f"|format(invoice.tax_amount) }}</strong>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Total:</strong>
                            <strong class="text-primary" id="displayTotal">₹{{ "%.2f"|format(invoice.total_amount) }}</strong>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-success btn-lg w-100">
                        <i class="fas fa-save"></i> Update Invoice
                    </button>
                    <a href="{{ url_for('view_integrated_invoice', invoice_id=invoice.id) }}" 
                       class="btn btn-secondary btn-lg w-100 mt-2">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
function addServiceRow() {
    const container = document.getElementById('servicesContainer');
    const newRow = document.createElement('div');
    newRow.className = 'row mb-2 service-row';
    newRow.innerHTML = `
        <div class="col-md-4">
            <select name="service_ids[]" class="form-select" required>
                {% for service in services %}
                <option value="{{ service.id }}">{{ service.name }} - ₹{{ "%.2f"|format(service.price) }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" name="service_quantities[]" class="form-control" value="1" min="1" step="0.5" required>
        </div>
        <div class="col-md-3">
            <select name="staff_ids[]" class="form-select" required>
                <option value="">Select Staff</option>
                {% for staff in staff_members %}
                <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="hidden" name="appointment_ids[]" value="">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeServiceRow(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(newRow);
}

function removeServiceRow(btn) {
    btn.closest('.service-row').remove();
}

function removeProductRow(btn) {
    btn.closest('.product-row').remove();
}

document.getElementById('editBillingForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Invoice updated successfully!');
            window.location.href = `/integrated-billing/invoice/${data.invoice_id}`;
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error updating invoice: ' + error.message);
    });
});
</script>
{% endblock %}
