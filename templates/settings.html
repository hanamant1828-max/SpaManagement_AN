{% extends "base.html" %}

{% block title %}Settings - Spa & Salon Management Suite{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-cog me-2"></i>Settings & Configuration
            </h1>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="business-tab" data-bs-toggle="tab" data-bs-target="#business" type="button" role="tab">
                <i class="fas fa-building me-2"></i>Business Settings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="whatsapp-tab" data-bs-toggle="tab" data-bs-target="#whatsapp" type="button" role="tab">
                <i class="fab fa-whatsapp me-2"></i>WhatsApp Configuration
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="gst-tab" data-bs-toggle="tab" data-bs-target="#gst" type="button" role="tab">
                <i class="fas fa-file-invoice me-2"></i>GST Settings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="departments-tab" data-bs-toggle="tab" data-bs-target="#departments" type="button" role="tab">
                <i class="fas fa-sitemap me-2"></i>Departments
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                <i class="fas fa-info-circle me-2"></i>System Information
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="settingsTabContent">
        <!-- Business Settings Tab -->
        <div class="tab-pane fade show active" id="business" role="tabpanel">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Business Settings</h6>
                        </div>
                        <div class="card-body">
                    <form method="POST" action="{{ url_for('update_business_settings_route') }}">
                        {{ business_form.hidden_tag() }}
                        
                        <div class="mb-3">
                            <label for="business_name" class="form-label">Business Name</label>
                            {{ business_form.business_name(class="form-control", value=business_settings.business_name if business_settings else '') }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="business_phone" class="form-label">Business Phone</label>
                            {{ business_form.business_phone(class="form-control", value=business_settings.business_phone if business_settings else '') }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="business_email" class="form-label">Business Email</label>
                            {{ business_form.business_email(class="form-control", value=business_settings.business_email if business_settings else '') }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="business_address" class="form-label">Business Address</label>
                            {{ business_form.business_address(class="form-control", rows="3", value=business_settings.business_address if business_settings else '') }}
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="tax_rate" class="form-label">Tax Rate (%)</label>
                                    {{ business_form.tax_rate(class="form-control", step="0.01", value=business_settings.tax_rate if business_settings else '0.00') }}
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-3">
                                    <label for="currency" class="form-label">Currency</label>
                                    {{ business_form.currency(class="form-select") }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="timezone" class="form-label">Timezone</label>
                            {{ business_form.timezone(class="form-select") }}
                        </div>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Update Settings
                        </button>
                    </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- WhatsApp Configuration Tab -->
        <div class="tab-pane fade" id="whatsapp" role="tabpanel">
            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow">
                        <div class="card-header py-3 bg-success text-white">
                            <h6 class="m-0 font-weight-bold">
                                <i class="fab fa-whatsapp me-2"></i>WhatsApp API Configuration
                            </h6>
                        </div>
                        <div class="card-body">
                            <!-- Configuration Status -->
                            <div id="whatsapp-status" class="mb-4 p-3 border rounded bg-light">
                                <h6 class="mb-2">
                                    <i class="fas fa-signal me-2"></i>Connection Status: 
                                    <span id="config-status-badge" class="badge bg-secondary">Checking...</span>
                                </h6>
                                <div id="config-details" class="small text-muted mt-2"></div>
                            </div>

                            <!-- WhatsApp API Configuration Form -->
                            <form method="POST" action="{{ url_for('save_whatsapp_api_config') }}" id="whatsappApiForm" class="needs-validation" novalidate>
                                <!-- Twilio API Credentials Section -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-key me-2"></i>Twilio API Credentials</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <strong>Security Note:</strong> For production use, store sensitive credentials in Replit Secrets. 
                                            Database storage is provided for convenience but Secrets take priority.
                                        </div>

                                        <div class="mb-3">
                                            <label for="twilio_account_sid" class="form-label fw-bold">
                                                <i class="fas fa-fingerprint me-1"></i>Twilio Account SID
                                            </label>
                                            <input type="text" 
                                                   class="form-control font-monospace" 
                                                   id="twilio_account_sid" 
                                                   name="twilio_account_sid" 
                                                   placeholder="ACxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                                                   value="{{ whatsapp_config.get('twilio_account_sid', '') if whatsapp_config else '' }}">
                                            <div class="form-text">
                                                Your Twilio Account SID from <a href="https://console.twilio.com" target="_blank">Twilio Console</a>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="twilio_auth_token" class="form-label fw-bold">
                                                <i class="fas fa-lock me-1"></i>Twilio Auth Token
                                            </label>
                                            <div class="input-group">
                                                <input type="password" 
                                                       class="form-control font-monospace" 
                                                       id="twilio_auth_token" 
                                                       name="twilio_auth_token" 
                                                       placeholder="••••••••••••••••••••••••••••••••"
                                                       value="{{ whatsapp_config.get('twilio_auth_token', '') if whatsapp_config else '' }}">
                                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('twilio_auth_token')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">
                                                Your Twilio Auth Token (keep this secret!)
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="twilio_whatsapp_number" class="form-label fw-bold">
                                                <i class="fab fa-whatsapp me-1"></i>Twilio WhatsApp Number
                                            </label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="twilio_whatsapp_number" 
                                                   name="twilio_whatsapp_number" 
                                                   placeholder="whatsapp:+14155238886"
                                                   value="{{ whatsapp_config.get('twilio_whatsapp_number', '') if whatsapp_config else '' }}">
                                            <div class="form-text">
                                                Format: <code>whatsapp:+[country_code][number]</code> (e.g., whatsapp:+14155238886)
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Business Configuration Section -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-building me-2"></i>Business Configuration</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="business_whatsapp_number" class="form-label fw-bold">
                                                <i class="fab fa-whatsapp me-1"></i>Business WhatsApp Number (Display)
                                            </label>
                                            <input type="tel" 
                                                   class="form-control" 
                                                   id="business_whatsapp_number" 
                                                   name="business_whatsapp_number" 
                                                   placeholder="+918746084638"
                                                   pattern="\+?[0-9]{10,15}"
                                                   value="{{ whatsapp_config.get('business_whatsapp_number', '') if whatsapp_config else '' }}">
                                            <div class="form-text">
                                                Your business contact number shown to customers
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="business_name_whatsapp" class="form-label fw-bold">
                                                <i class="fas fa-store me-1"></i>Business Name for Messages
                                            </label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="business_name_whatsapp" 
                                                   name="business_name_whatsapp" 
                                                   placeholder="My Spa & Salon"
                                                   value="{{ whatsapp_config.get('business_name_whatsapp', '') if whatsapp_config else '' }}">
                                            <div class="form-text">
                                                Business name that appears in WhatsApp messages
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Message Configuration Section -->
                                <div class="card mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-comment-dots me-2"></i>Message Templates & Settings</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input type="checkbox" 
                                                       class="form-check-input" 
                                                       id="enable_notifications" 
                                                       name="enable_notifications"
                                                       role="switch"
                                                       {% if whatsapp_config and whatsapp_config.get('enable_notifications') %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_notifications">
                                                    <strong>Enable Automatic Notifications</strong>
                                                </label>
                                            </div>
                                            <div class="form-text ms-5">
                                                Send automatic WhatsApp messages for bookings, reminders, and confirmations
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input type="checkbox" 
                                                       class="form-check-input" 
                                                       id="enable_booking_confirmation" 
                                                       name="enable_booking_confirmation"
                                                       role="switch"
                                                       {% if whatsapp_config and whatsapp_config.get('enable_booking_confirmation') %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_booking_confirmation">
                                                    <strong>Send Booking Confirmation Messages</strong>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input type="checkbox" 
                                                       class="form-check-input" 
                                                       id="enable_appointment_reminders" 
                                                       name="enable_appointment_reminders"
                                                       role="switch"
                                                       {% if whatsapp_config and whatsapp_config.get('enable_appointment_reminders') %}checked{% endif %}>
                                                <label class="form-check-label" for="enable_appointment_reminders">
                                                    <strong>Send Appointment Reminders</strong>
                                                </label>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="reminder_hours_before" class="form-label fw-bold">
                                                <i class="fas fa-clock me-1"></i>Reminder Time (hours before appointment)
                                            </label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="reminder_hours_before" 
                                                   name="reminder_hours_before" 
                                                   min="1"
                                                   max="72"
                                                   value="{{ whatsapp_config.get('reminder_hours_before', '24') if whatsapp_config else '24' }}">
                                            <div class="form-text">
                                                Send reminders this many hours before the appointment (default: 24 hours)
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="message_template_booking" class="form-label fw-bold">
                                                <i class="fas fa-edit me-1"></i>Booking Confirmation Template
                                            </label>
                                            <textarea class="form-control font-monospace" 
                                                      id="message_template_booking" 
                                                      name="message_template_booking" 
                                                      rows="4"
                                                      placeholder="Hi {client_name}, your appointment for {service_name} on {date} at {time} has been confirmed. See you soon!">{{ whatsapp_config.get('message_template_booking', '') if whatsapp_config else '' }}</textarea>
                                            <div class="form-text">
                                                Available variables: {client_name}, {service_name}, {date}, {time}, {staff_name}, {business_name}
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="message_template_reminder" class="form-label fw-bold">
                                                <i class="fas fa-edit me-1"></i>Appointment Reminder Template
                                            </label>
                                            <textarea class="form-control font-monospace" 
                                                      id="message_template_reminder" 
                                                      name="message_template_reminder" 
                                                      rows="4"
                                                      placeholder="Hi {client_name}, this is a reminder for your appointment tomorrow at {time} for {service_name}. Looking forward to seeing you!">{{ whatsapp_config.get('message_template_reminder', '') if whatsapp_config else '' }}</textarea>
                                            <div class="form-text">
                                                Available variables: {client_name}, {service_name}, {date}, {time}, {staff_name}, {business_name}
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Save Buttons -->
                                <div class="d-grid gap-2 d-md-flex">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="fas fa-save me-2"></i>Save Configuration
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-lg" onclick="document.getElementById('whatsappApiForm').reset();">
                                        <i class="fas fa-undo me-2"></i>Reset
                                    </button>
                                </div>
                            </form>

                            <!-- Test Section -->
                            <div class="mt-4 pt-4 border-top">
                                <h6 class="mb-3"><i class="fas fa-vial me-2"></i>Test WhatsApp Connection</h6>
                                <p class="text-muted small mb-3">
                                    Send a test message to verify your configuration is working correctly.
                                </p>
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="input-group mb-3">
                                            <span class="input-group-text"><i class="fab fa-whatsapp"></i></span>
                                            <input type="tel" 
                                                   class="form-control" 
                                                   id="test_phone_number" 
                                                   placeholder="+1234567890"
                                                   pattern="\+?[0-9]{10,15}">
                                            <button class="btn btn-primary" type="button" onclick="testWhatsApp()">
                                                <i class="fas fa-paper-plane me-2"></i>Send Test Message
                                            </button>
                                        </div>
                                        <div id="test-result"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-success">
                                <i class="fas fa-lightbulb me-2"></i>Quick Guide
                            </h6>
                        </div>
                        <div class="card-body">
                            <h6>WhatsApp Messaging Features:</h6>
                            <ul class="small">
                                <li>Automatic booking confirmations</li>
                                <li>Appointment reminders</li>
                                <li>Custom message templates</li>
                                <li>Customer engagement</li>
                            </ul>
                            <hr>
                            <h6>Security:</h6>
                            <p class="small">Your Twilio credentials are stored securely in Replit Secrets and never exposed in the application code or database.</p>
                        </div>
                    </div>

                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-info">
                                <i class="fas fa-question-circle me-2"></i>Need Help?
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="small mb-2"><strong>Getting Started:</strong></p>
                            <ol class="small mb-3">
                                <li>Sign up for Twilio</li>
                                <li>Get your credentials</li>
                                <li>Add them to Replit Secrets</li>
                                <li>Configure your business number</li>
                                <li>Test the connection</li>
                            </ol>
                            <a href="https://www.twilio.com/docs/whatsapp/quickstart" target="_blank" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-book me-1"></i>View Twilio Docs
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- System Information Tab -->
        <div class="tab-pane fade" id="system" role="tabpanel">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">System Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-12">
                                    <div class="info-item mb-3">
                                        <strong>Application Version:</strong>
                                        <span class="text-muted">v2.0.0</span>
                                    </div>
                                    <div class="info-item mb-3">
                                        <strong>Database Status:</strong>
                                        <span class="badge bg-success">Connected</span>
                                    </div>
                                    <div class="info-item mb-3">
                                        <strong>Last Backup:</strong>
                                        <span class="text-muted">Never</span>
                                    </div>
                                    <div class="info-item mb-3">
                                        <strong>System Health:</strong>
                                        <span class="badge bg-success">Good</span>
                                    </div>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <h6 class="mb-3">Quick Actions</h6>
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('system_management') }}" class="btn btn-outline-primary">
                                    <i class="fas fa-tools me-2"></i>System Management
                                </a>
                                <a href="{{ url_for('role_management') }}" class="btn btn-outline-info">
                                    <i class="fas fa-users-cog me-2"></i>Role Management
                                </a>
                                <button class="btn btn-outline-warning" onclick="clearCache()">
                                    <i class="fas fa-broom me-2"></i>Clear Cache
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function clearCache() {
    if (confirm('Are you sure you want to clear the system cache?')) {
        // Implement cache clearing logic here
        alert('Cache cleared successfully!');
    }
}

function togglePasswordVisibility(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

// Check WhatsApp configuration status on page load
document.addEventListener('DOMContentLoaded', function() {
    checkWhatsAppStatus();
});

function checkWhatsAppStatus() {
    fetch('/api/whatsapp/status')
        .then(response => response.json())
        .then(data => {
            const statusBadge = document.getElementById('config-status-badge');
            const detailsDiv = document.getElementById('config-details');
            
            if (data.configured) {
                statusBadge.className = 'badge bg-success';
                statusBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i>Configured & Ready';
                
                detailsDiv.innerHTML = `
                    <div class="alert alert-success mb-0 py-2">
                        <i class="fas fa-check me-2"></i>All required Twilio credentials are configured.
                        <br><small>✓ Account SID: ${data.has_account_sid ? 'Present' : 'Missing'}</small>
                        <br><small>✓ Auth Token: ${data.has_auth_token ? 'Present' : 'Missing'}</small>
                        <br><small>✓ WhatsApp Number: ${data.has_whatsapp_number ? 'Present' : 'Missing'}</small>
                    </div>
                `;
            } else {
                statusBadge.className = 'badge bg-warning text-dark';
                statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Not Configured';
                
                const missing = [];
                if (!data.has_account_sid) missing.push('TWILIO_ACCOUNT_SID');
                if (!data.has_auth_token) missing.push('TWILIO_AUTH_TOKEN');
                if (!data.has_whatsapp_number) missing.push('TWILIO_WHATSAPP_NUMBER');
                
                detailsDiv.innerHTML = `
                    <div class="alert alert-warning mb-0 py-2">
                        <i class="fas fa-exclamation-circle me-2"></i>Missing configuration: <code>${missing.join(', ')}</code>
                        <br><small>Please add these secrets in Replit Secrets (Tools → Secrets) and refresh the page.</small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error checking WhatsApp status:', error);
            const statusBadge = document.getElementById('config-status-badge');
            const detailsDiv = document.getElementById('config-details');
            
            statusBadge.className = 'badge bg-danger';
            statusBadge.innerHTML = '<i class="fas fa-times-circle me-1"></i>Error';
            detailsDiv.innerHTML = `
                <div class="alert alert-danger mb-0 py-2">
                    <i class="fas fa-exclamation-triangle me-2"></i>Unable to check configuration status.
                </div>
            `;
        });
}

function testWhatsApp() {
    const phoneNumber = document.getElementById('test_phone_number').value;
    const resultDiv = document.getElementById('test-result');
    
    if (!phoneNumber) {
        resultDiv.innerHTML = '<div class="alert alert-warning">Please enter a phone number</div>';
        return;
    }
    
    resultDiv.innerHTML = '<div class="alert alert-info">Sending test message...</div>';
    
    fetch('/api/whatsapp/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ phone_number: phoneNumber })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>' + data.message + '</div>';
        } else {
            resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>' + data.error + '</div>';
        }
    })
    .catch(error => {
        resultDiv.innerHTML = '<div class="alert alert-danger"><i class="fas fa-exclamation-circle me-2"></i>Error sending test message: ' + error.message + '</div>';
    });
}
</script>
{% endblock %}