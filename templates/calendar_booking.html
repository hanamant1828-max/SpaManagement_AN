{% extends "base.html" %}

{% block title %}Calendar Booking - Spa Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>Calendar Booking
                </h1>
                <div class="d-flex gap-2">
                    <input type="date" class="form-control" id="dateSelector" value="{{ selected_date.strftime('%Y-%m-%d') }}"
                           onchange="window.location.href='{{ url_for('appointments_schedule') }}?date=' + this.value">
                    <a href="{{ url_for('bookings') }}" class="btn btn-outline-primary">
                        <i class="fas fa-calendar me-2"></i>Full Calendar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h4 class="card-title">{{ selected_date.strftime('%A, %B %d, %Y') }}</h4>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-success rounded" style="width: 20px; height: 20px;"></div>
                                </div>
                                <span>Available</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-danger rounded" style="width: 20px; height: 20px;"></div>
                                </div>
                                <span>Booked</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-warning rounded" style="width: 20px; height: 20px;"></div>
                                </div>
                                <span>Break</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="bg-secondary rounded" style="width: 20px; height: 20px;"></div>
                                </div>
                                <span>Unavailable</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title">Today's Revenue</h5>
                            <h3>${{ "%.2f"|format(today_revenue) }}</h3>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title">Today's Appointments</h5>
                            <h3>{{ today_appointments|length }}</h3>
                        </div>
                        <div class="ms-3">
                            <i class="fas fa-calendar-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Schedule Grid -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Staff Schedule</h5>
                </div>
                <div class="card-body">
                    <div class="calendar-container">
                        <!-- Availability Legend -->
                        <div class="availability-legend">
                            <div class="legend-item">
                                <div class="legend-color bg-success"></div>
                                <span><i class="fas fa-clock"></i> Available for booking</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color bg-danger"></div>
                                <span><i class="fas fa-calendar-plus"></i> Manual booking</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color bg-info"></div>
                                <span><i class="fas fa-globe"></i> Online booking</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color bg-warning"></div>
                                <span><i class="fas fa-phone"></i> Phone booking / Break</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #198754;"></div>
                                <span><i class="fas fa-walking"></i> Walk-in booking</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color bg-light border"></div>
                                <span><i class="fas fa-moon"></i> Off duty</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color bg-secondary"></div>
                                <span><i class="fas fa-times"></i> Not available</span>
                            </div>
                        </div>

                        <table class="table table-bordered schedule-table">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-center" style="width: 100px;">Time</th>
                                    {% for staff_member in staff_members %}
                                    <th class="text-center">
                                        <div class="d-flex flex-column align-items-center">
                                            <div class="fw-bold">{{ staff_member.first_name }} {{ staff_member.last_name }}</div>
                                            <small class="text-muted">{{ staff_member.role }}</small>
                                            {% set schedule = staff_schedules.get(staff_member.id) %}
                                            {% if schedule and schedule.has_shift %}
                                                {% if schedule.is_absent %}
                                                <div class="badge bg-dark mt-1">
                                                    <i class="fas fa-user-times me-1"></i>Absent Today
                                                </div>
                                                {% else %}
                                                <div class="badge bg-info mt-1">
                                                    {{ schedule.shift_start.strftime('%I:%M %p') if schedule.shift_start else 'N/A' }} â€“ 
                                                    {{ schedule.shift_end.strftime('%I:%M %p') if schedule.shift_end else 'N/A' }}
                                                </div>
                                                {% if schedule.break_start and schedule.break_end %}
                                                <div class="badge bg-warning text-dark mt-1">
                                                    Break: {{ schedule.break_start.strftime('%I:%M %p') }} â€“ {{ schedule.break_end.strftime('%I:%M %p') }}
                                                </div>
                                                {% endif %}
                                                {% endif %}
                                            {% else %}
                                            <div class="badge bg-secondary mt-1">
                                                <i class="fas fa-ban me-1"></i>Not Scheduled
                                            </div>
                                            {% endif %}
                                        </div>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for time_slot in time_slots %}
                                <tr>
                                    <td class="fw-bold text-center align-middle">
                                        {{ time_slot.start_time.strftime('%I:%M %p') }}
                                    </td>
                                    {% for staff_member in staff_members %}
                                    {% set slot_key = (staff_member.id, time_slot.start_time) %}
                                    {% set availability = staff_availability.get(slot_key, {'status': 'unknown'}) %}

                                    <td class="availability-cell p-1" style="position: relative;">
                                        {% if availability.status == 'available' %}
                                            <button class="btn btn-sm btn-success w-100 available-slot" 
                                                    onclick="openBookingModal({{ staff_member.id }}, '{{ time_slot.start_time.strftime('%H:%M') }}', '{{ staff_member.first_name }} {{ staff_member.last_name }}')"
                                                    title="Available - {{ availability.remaining_time }}min remaining in shift"
                                                    data-staff-id="{{ staff_member.id }}"
                                                    data-time="{{ time_slot.start_time.strftime('%H:%M') }}"
                                                    data-remaining-time="{{ availability.remaining_time }}">
                                                <i class="fas fa-clock"></i>
                                            </button>
                                        {% elif availability.status == 'booked' %}
                                            <div class="appointment-block {% if availability.booking_source == 'online' %}bg-info{% elif availability.booking_source == 'phone' %}bg-warning text-dark{% elif availability.booking_source == 'walk_in' %}bg-success{% else %}bg-danger{% endif %} text-white p-1 w-100 text-center" 
                                                 style="font-size: 0.7rem; border-radius: 3px; min-height: 40px; cursor: pointer;"
                                                 onclick="showAppointmentDetails({{ availability.appointment_id }})"
                                                 title="{{ availability.client_name }} - {{ availability.service_name }} ({{ availability.service_duration }}min) - Source: {{ availability.booking_source or 'Manual' }} - Click to view details">
                                                {% if availability.booking_source == 'online' %}
                                                <small><i class="fas fa-globe"></i> Online</small><br>
                                                {% elif availability.booking_source == 'phone' %}
                                                <small><i class="fas fa-phone"></i> Phone</small><br>
                                                {% elif availability.booking_source == 'walk_in' %}
                                                <small><i class="fas fa-walking"></i> Walk-in</small><br>
                                                {% elif availability.booking_source == 'unaki_system' %}
                                                <small><i class="fas fa-calendar-plus"></i> System</small><br>
                                                {% endif %}
                                                <strong>{{ availability.client_name[:15] if availability.client_name|length > 15 else availability.client_name }}</strong><br>
                                                <small>{{ availability.service_name[:12] if availability.service_name|length > 12 else availability.service_name }}</small><br>
                                                <small><i class="fas fa-clock"></i> {{ availability.service_duration }}min</small>
                                            </div>
                                        {% elif availability.status == 'booked_continuation' %}
                                            <div class="appointment-continuation bg-danger text-white p-1 w-100 text-center" 
                                                 style="font-size: 0.6rem; border-radius: 3px; min-height: 40px; opacity: 0.8;">
                                                â†‘
                                            </div>
                                        {% elif availability.status == 'break' %}
                                            <div class="break-block bg-warning text-dark p-1 w-100 text-center" 
                                                 style="font-size: 0.7rem; border-radius: 3px; min-height: 40px;"
                                                 title="{{ availability.reason }}">
                                                <i class="fas fa-coffee"></i><br>
                                                <small>Break</small>
                                            </div>
                                        {% elif availability.status == 'off_duty' %}
                                            <div class="off-duty-block bg-light text-muted p-1 w-100 text-center" 
                                                 style="font-size: 0.7rem; border-radius: 3px; min-height: 40px;"
                                                 title="{{ availability.reason }}">
                                                <i class="fas fa-moon"></i><br>
                                                <small>Off</small>
                                            </div>
                                        {% else %}
                                            <div class="not-available-block bg-secondary text-white p-1 w-100 text-center" 
                                                 style="font-size: 0.7rem; border-radius: 3px; min-height: 40px;"
                                                 title="{{ availability.reason or 'Not Available' }}">
                                                <i class="fas fa-times"></i><br>
                                                <small>N/A</small>
                                            </div>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's Appointments List -->
    {% if today_appointments %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Today's Appointments</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Client</th>
                                    <th>Service</th>
                                    <th>Staff</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for appointment in today_appointments %}
                                <tr>
                                    <td>{{ appointment.appointment_date.strftime('%I:%M %p') }}</td>
                                    <td>{{ appointment.client.full_name if appointment.client else 'N/A' }}</td>
                                    <td>{{ appointment.service.name if appointment.service else 'N/A' }}</td>
                                    <td>{{ appointment.staff.full_name if appointment.staff else 'N/A' }}</td>
                                    <td>
                                        {% if appointment.amount %}
                                            ${{ "%.2f"|format(appointment.amount) }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge
                                            {% if appointment.status == 'completed' %}bg-success
                                            {% elif appointment.status == 'scheduled' %}bg-primary
                                            {% elif appointment.status == 'cancelled' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ appointment.status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if appointment.status == 'scheduled' %}
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-success" onclick="markCompleted({{ appointment.id }})">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" onclick="editAppointment({{ appointment.id }})">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" onclick="cancelAppointment({{ appointment.id }})">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Book Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <div class="mb-3">
                        <label for="clientSelect" class="form-label">Client</label>
                        <select class="form-select" id="clientSelect" required>
                            <option value="">Select Client</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="bookingService" class="form-label">Service <span class="text-danger">*</span></label>
                                <select class="form-select" id="bookingService" required onchange="validateServiceDuration()">
                                    <option value="">Select Service...</option>
                                    {% for service in services %}
                                    <option value="{{ service.id }}" 
                                            data-duration="{{ service.duration }}" 
                                            data-price="{{ service.price }}"
                                            data-description="{{ service.description or '' }}">
                                        {{ service.name }} - {{ service.duration }} minutes - ${{ service.price }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div id="serviceDurationInfo" class="mt-2" style="display: none;">
                                    <div class="alert alert-info">
                                        <strong>Service Duration:</strong> <span id="selectedDuration"></span> minutes<br>
                                        <strong>Estimated End Time:</strong> <span id="estimatedEndTime"></span><br>
                                        <strong>Price:</strong> $<span id="selectedPrice"></span>
                                    </div>
                                </div>
                                <div id="durationWarning" class="mt-2" style="display: none;">
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i> 
                                        <strong>Warning:</strong> This service duration may extend beyond the staff member's shift hours.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="bookingNotes" class="form-label">Notes (Optional)</label>
                                <textarea class="form-control" id="bookingNotes" rows="2" 
                                          placeholder="Any special requirements or preferences..."></textarea>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="selectedStaffId">
                    <input type="hidden" id="selectedDate">
                    <input type="hidden" id="selectedTime">
                    <span id="selectedStaffName" class="d-none"></span>
                    <span id="selectedTimeDisplay" class="d-none"></span>
                </form>
                <div id="bookingSummary" class="mt-3 p-3 bg-light rounded d-none">
                    <h6>Booking Summary:</h6>
                    <div id="summaryDetails"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitBooking()">Book Appointment</button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Book Modal -->
<div class="modal fade" id="quickBookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Quick Book Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickBookingForm">
                    <div class="mb-3">
                        <label for="quickClientSelect" class="form-label">Client</label>
                        <select class="form-select" id="quickClientSelect" required>
                            <option value="">Select Client</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quickServiceSelect" class="form-label">Service</label>
                        <select class="form-select" id="quickServiceSelect" required>
                            <option value="">Select Service</option>
                            {% for service in services %}
                            <option value="{{ service.id }}" data-price="{{ service.price }}">
                                {{ service.name }} - ${{ service.price }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <input type="hidden" id="quickSelectedStaffId">
                    <input type="hidden" id="quickSelectedDate">
                    <input type="hidden" id="quickSelectedTime">
                    <input type="hidden" id="quickSelectedStaffName">
                    <input type="hidden" id="quickSelectedDisplayTime">
                </form>
                <div id="quickBookingSummary" class="mt-3 p-3 bg-light rounded d-none">
                    <h6>Booking Summary:</h6>
                    <div id="quickSummaryDetails"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitQuickBooking()">Book Appointment</button>
            </div>
        </div>
    </div>
</div>


<script>
// Handle booking button clicks
document.addEventListener('DOMContentLoaded', function() {
    const bookSlotButtons = document.querySelectorAll('.book-slot-btn');
    bookSlotButtons.forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('selectedStaffId').value = this.dataset.staffId;
            document.getElementById('selectedDate').value = this.dataset.date;
            document.getElementById('selectedTime').value = this.dataset.time;

            // Update modal title
            const modalTitle = document.querySelector('#bookingModal .modal-title');
            modalTitle.textContent = `Book Appointment - ${this.dataset.staffName} at ${this.dataset.displayTime}`;
        });
    });

    // Handle quick book button clicks
    const quickBookButtons = document.querySelectorAll('.quick-book-btn');
    quickBookButtons.forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('quickSelectedStaffId').value = this.dataset.staffId;
            document.getElementById('quickSelectedDate').value = this.dataset.date;
            document.getElementById('quickSelectedTime').value = this.dataset.time;
            document.getElementById('quickSelectedStaffName').value = this.dataset.staffName;
            document.getElementById('quickSelectedDisplayTime').value = this.dataset.displayTime;

            // Update modal title
            const modalTitle = document.querySelector('#quickBookModal .modal-title');
            modalTitle.textContent = `Quick Book Appointment - ${this.dataset.staffName} at ${this.dataset.displayTime}`;
        });
    });


    // Show booking summary when service is selected
    document.getElementById('serviceSelect').addEventListener('change', function() {
        const serviceSelect = this;
        const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
        const summary = document.getElementById('bookingSummary');
        const summaryDetails = document.getElementById('summaryDetails');

        if (selectedOption.value) {
            summaryDetails.innerHTML = `
                <div><strong>Service:</strong> ${selectedOption.textContent}</div>
                <div><strong>Staff:</strong> ${document.getElementById('selectedStaffId').value ? document.querySelector(`[data-staff-id='${document.getElementById('selectedStaffId').value}']`).dataset.staffName : 'N/A'}</div>
                <div><strong>Date:</strong> ${document.getElementById('selectedDate').value}</div>
                <div><strong>Time:</strong> ${document.getElementById('selectedTime').value}</div>
            `;
            summary.classList.remove('d-none');
        } else {
            summary.classList.add('d-none');
        }
    });

    // Show quick booking summary when service is selected
    document.getElementById('quickServiceSelect').addEventListener('change', function() {
        const serviceSelect = this;
        const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
        const summary = document.getElementById('quickBookingSummary');
        const summaryDetails = document.getElementById('quickSummaryDetails');

        if (selectedOption.value) {
            summaryDetails.innerHTML = `
                <div><strong>Service:</strong> ${selectedOption.textContent}</div>
                <div><strong>Staff:</strong> ${document.getElementById('quickSelectedStaffName').value}</div>
                <div><strong>Date:</strong> ${document.getElementById('quickSelectedDate').value}</div>
                <div><strong>Time:</strong> ${document.getElementById('quickSelectedTime').value}</div>
            `;
            summary.classList.remove('d-none');
        } else {
            summary.classList.add('d-none');
        }
    });
});


function submitBooking() {
    const formData = {
        client_id: document.getElementById('clientSelect').value,
        service_id: document.getElementById('bookingService').value,
        staff_id: document.getElementById('selectedStaffId').value,
        appointment_date: document.getElementById('selectedDate').value,
        appointment_time: document.getElementById('selectedTime').value,
        notes: document.getElementById('bookingNotes').value
    };

    // Validate required fields
    if (!formData.client_id || !formData.service_id || !formData.staff_id) {
        alert('Please fill in all required fields');
        return;
    }

    // Submit the booking
    fetch('/appointments/book', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Appointment booked successfully!');
            location.reload(); // Refresh to show updated schedule
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error booking appointment: ' + error);
    });
}

function submitQuickBooking() {
    const formData = {
        client_id: document.getElementById('quickClientSelect').value,
        service_id: document.getElementById('quickServiceSelect').value,
        staff_id: document.getElementById('quickSelectedStaffId').value,
        appointment_date: document.getElementById('quickSelectedDate').value,
        appointment_time: document.getElementById('quickSelectedTime').value,
        notes: document.getElementById('appointmentNotes').value // Assuming notes field is common or can be reused
    };

    // Validate required fields
    if (!formData.client_id || !formData.service_id || !formData.staff_id) {
        alert('Please fill in all required fields');
        return;
    }

    // Submit the booking
    fetch('/appointments/book', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Appointment booked successfully!');
            location.reload(); // Refresh to show updated schedule
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error booking appointment: ' + error);
    });
}

function showAppointmentDetails(appointmentId) {
    if (!appointmentId) {
        console.warn('No appointment ID provided');
        return;
    }
    console.log('ðŸ“‹ Viewing appointment details:', appointmentId);
    window.location.href = `/appointments/${appointmentId}`;
}

function markCompleted(appointmentId) {
    if (confirm('Mark this appointment as completed?')) {
        // Implementation for marking appointment as completed
        fetch(`/appointments/${appointmentId}/complete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Appointment marked as completed!');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error updating appointment: ' + error);
        });
    }
}

function editAppointment(appointmentId) {
    window.location.href = `/appointments/edit/${appointmentId}`;
}

function cancelAppointment(appointmentId) {
    if (confirm('Are you sure you want to cancel this appointment?')) {
        fetch(`/appointments/${appointmentId}/cancel`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Appointment cancelled!');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error cancelling appointment: ' + error);
        });
    }
}

let selectedStaffRemainingTime = 0;

function openBookingModal(staffId, time, staffName) {
    document.getElementById('selectedStaffId').value = staffId;
    document.getElementById('selectedTime').value = time;
    document.getElementById('selectedStaffName').textContent = staffName;
    document.getElementById('selectedTimeDisplay').textContent = time;

    // Get remaining time from the clicked button
    const clickedButton = event.target;
    selectedStaffRemainingTime = parseInt(clickedButton.getAttribute('data-remaining-time') || '0');

    // Reset form
    document.getElementById('bookingService').value = '';
    document.getElementById('serviceDurationInfo').style.display = 'none';
    document.getElementById('durationWarning').style.display = 'none';

    const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
    modal.show();
}

function validateServiceDuration() {
    const serviceSelect = document.getElementById('bookingService');
    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

    if (selectedOption.value) {
        const duration = parseInt(selectedOption.getAttribute('data-duration'));
        const price = parseFloat(selectedOption.getAttribute('data-price'));
        const selectedTime = document.getElementById('selectedTime').value;

        // Calculate end time
        const [hours, minutes] = selectedTime.split(':').map(Number);
        const startTime = new Date();
        startTime.setHours(hours, minutes, 0, 0);
        const endTime = new Date(startTime.getTime() + duration * 60000);

        // Update service info
        document.getElementById('selectedDuration').textContent = duration;
        document.getElementById('selectedPrice').textContent = price.toFixed(2);
        document.getElementById('estimatedEndTime').textContent = endTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        document.getElementById('serviceDurationInfo').style.display = 'block';

        // Check if service duration exceeds remaining shift time
        if (duration > selectedStaffRemainingTime) {
            document.getElementById('durationWarning').style.display = 'block';
        } else {
            document.getElementById('durationWarning').style.display = 'none';
        }
    } else {
        document.getElementById('serviceDurationInfo').style.display = 'none';
        document.getElementById('durationWarning').style.display = 'none';
    }
}
</script>

<style>
.availability-cell {
    height: 50px;
    width: 70px;
    vertical-align: middle;
    padding: 2px !important;
}

.time-header {
    background-color: #f8f9fa;
    font-weight: bold;
    padding: 8px 4px;
    border-bottom: 2px solid #dee2e6;
    font-size: 0.8rem;
    min-width: 70px;
}

.staff-name {
    background-color: #e9ecef;
    font-weight: bold;
    writing-mode: vertical-lr;
    text-orientation: mixed;
    width: 120px;
    text-align: center;
    padding: 10px 5px;
}

.appointment-block {
    min-height: 45px !important;
    font-size: 0.7rem !important;
    line-height: 1.2;
    border: 1px solid #dc3545;
    cursor: pointer;
    transition: all 0.2s;
}

.appointment-block:hover {
    opacity: 0.9;
    transform: scale(1.02);
}

.appointment-continuation {
    min-height: 45px !important;
    border: 1px solid #dc3545;
    border-top: none;
    opacity: 0.7;
}

.available-slot {
    min-height: 45px !important;
    transition: all 0.2s;
    border: 1px solid #28a745;
}

.available-slot:hover {
    background-color: #218838 !important;
    transform: scale(1.05);
}

.break-block, .off-duty-block, .not-available-block {
    min-height: 45px !important;
    font-size: 0.7rem !important;
    opacity: 0.8;
}

.today-stats {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.calendar-container {
    overflow-x: auto;
    max-width: 100%;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.schedule-table {
    min-width: 1400px;
    margin-bottom: 0;
}

.service-duration-badge {
    background-color: #17a2b8;
    color: white;
    font-size: 0.6rem;
    padding: 1px 4px;
    border-radius: 3px;
    margin-top: 2px;
}

/* Legend */
.availability-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 3px;
    border: 1px solid #ddd;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .availability-cell {
        width: 60px;
        height: 45px;
    }

    .time-header {
        font-size: 0.7rem;
        min-width: 60px;
    }

    .staff-name {
        width: 100px;
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}