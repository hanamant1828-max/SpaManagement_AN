{% extends "base.html" %}
{% block title %}{% if edit_appointment %}Edit Appointment{% else %}Book Multiple Appointments{% endif %} - Spa Management{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        {% if edit_appointment %}
                        <i class="fas fa-edit text-warning me-2"></i>
                        Edit Appointment
                        {% else %}
                        <i class="fas fa-calendar-plus text-primary me-2"></i>
                        Book Multiple Appointments
                        {% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        {% if edit_appointment %}
                        Update the appointment details below
                        {% else %}
                        Book multiple services for a client in one go
                        {% endif %}
                    </p>
                </div>
                <a
                    href="{{ url_for('unaki_booking') }}"
                    class="btn btn-outline-secondary"
                >
                    <i class="fas fa-arrow-left me-2"></i>Back to Calendar
                </a>
            </div>
        </div>
    </div>

    <!-- Hidden field to store edit appointment data -->
    {% if edit_appointment %}
    <script type="application/json" id="editAppointmentData">{{ edit_appointment | tojson | safe }}</script>
    {% endif %}

    <div class="row">
        <div class="col-lg-8">
            <!-- Client Selection Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Client Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-10">
                            <label class="form-label fw-semibold"
                                >Select Client *</label
                            >
                            <select
                                id="clientSelect"
                                class="form-select form-select-lg"
                                data-placeholder="Search for a client by name or phone..."
                                required
                            >
                                <option value="">-- Select Client --</option>
                                {% if clients %} {% for client in clients %}
                                <option
                                    value="{{ client.id }}"
                                    data-phone="{{ client.phone }}"
                                    data-email="{{ client.email or '' }}"
                                >
                                    {{ client.first_name }} {{ client.last_name
                                    }} - {{ client.phone }}
                                </option>
                                {% endfor %} {% endif %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">&nbsp;</label>
                            <button
                                type="button"
                                class="btn btn-primary w-100"
                                onclick="openQuickAddClient()"
                            >
                                <i class="fas fa-plus"></i> New
                            </button>
                        </div>
                    </div>

                    <!-- Booking Source Selection -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-tag me-1"></i>Booking Source *
                            </label>
                            <select id="bookingSourceSelect" class="form-select" required>
                                <option value="phone">Phone Call</option>
                                <option value="walk_in">Walk-in</option>
                            </select>
                            <small class="form-text text-muted mt-1">
                                <i class="fas fa-info-circle me-1"></i>
                                Select how this booking was received
                            </small>
                        </div>
                    </div>

                    <!-- Client Existing Appointments Alert -->
                    <div
                        id="clientExistingAppointments"
                        class="mt-3"
                        style="display: none"
                    >
                        <div class="alert alert-info">
                            <div
                                class="d-flex justify-content-between align-items-center mb-2"
                            >
                                <strong
                                    ><i class="fas fa-calendar-check me-2"></i
                                    >Existing Appointments</strong
                                >
                                <span
                                    id="clientAppointmentsCount"
                                    class="badge bg-primary"
                                    >0</span
                                >
                            </div>
                            <div
                                id="clientAppointmentsList"
                                style="max-height: 200px; overflow-y: auto"
                            ></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Appointments Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <div
                        class="d-flex justify-content-between align-items-center"
                    >
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>Appointments
                        </h5>
                        <span
                            id="appointmentCount"
                            class="badge bg-light text-dark"
                            >0 Appointments</span
                        >
                    </div>
                </div>
                <div class="card-body">
                    <!-- Conflict Summary Banner -->
                    <div
                        id="conflictSummaryBanner"
                        class="alert d-none mb-3"
                        role="alert"
                    >
                        <div class="d-flex align-items-center">
                            <i
                                class="fas fa-exclamation-triangle fs-4 me-3"
                            ></i>
                            <div class="flex-grow-1">
                                <div
                                    class="fw-bold"
                                    id="conflictSummaryText"
                                ></div>
                                <small id="conflictSummarySubtext"></small>
                            </div>
                        </div>
                    </div>

                    <div id="appointmentsContainer"></div>

                    <button
                        type="button"
                        class="btn btn-outline-primary w-100 mt-3"
                        id="addAppointmentBtn"
                        onclick="addAppointmentRow()"
                    >
                        <i class="fas fa-plus-circle me-2"></i>Add First Appointment
                    </button>
                </div>
            </div>

            <!-- Notes Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-sticky-note me-2"></i>Additional Notes
                    </h5>
                </div>
                <div class="card-body">
                    <textarea
                        id="bookingNotes"
                        class="form-control"
                        rows="3"
                        placeholder="Add any special instructions or notes..."
                    ></textarea>
                </div>
            </div>
        </div>

        <!-- Summary Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow-sm sticky-top" style="top: 20px">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-receipt me-2"></i>Booking Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div
                            class="d-flex justify-content-between align-items-center p-3 bg-light rounded"
                        >
                            <div>
                                <i class="fas fa-clock text-primary me-2"></i>
                                <small class="text-muted">Total Duration</small>
                            </div>
                            <h4 class="mb-0" id="totalDuration">0 min</h4>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div
                            class="d-flex justify-content-between align-items-center p-3 bg-light rounded"
                        >
                            <div>
                                <i
                                    class="fas fa-rupee-sign text-success me-2"
                                ></i>
                                <small class="text-muted">Total Price</small>
                            </div>
                            <h4 class="mb-0" id="totalPrice">â‚¹0.00</h4>
                        </div>
                    </div>

                    <div class="mb-4">
                        <div
                            class="d-flex justify-content-between align-items-center p-3 bg-light rounded"
                        >
                            <div>
                                <i class="fas fa-user-md text-warning me-2"></i>
                                <small class="text-muted">Staff Required</small>
                            </div>
                            <h4 class="mb-0" id="staffRequired">0</h4>
                        </div>
                    </div>

                    <hr />

                    <div class="d-grid gap-2">
                        <button
                            type="button"
                            id="submitBookingBtn"
                            class="btn btn-lg btn-secondary"
                            onclick="submitMultiBooking()"
                            disabled
                        >
                            <i class="fas fa-edit me-2"></i>Complete All Fields
                        </button>
                        <button
                            type="button"
                            class="btn btn-outline-secondary"
                            onclick="resetForm()"
                        >
                            <i class="fas fa-redo me-2"></i>Reset Form
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Client Modal -->
<div class="modal fade" id="quickAddClientModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Quick Add New Client
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <div class="modal-body">
                <form id="quickAddClientForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">First Name *</label>
                            <input
                                type="text"
                                id="quickFirstName"
                                class="form-control"
                                required
                            />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Last Name *</label>
                            <input
                                type="text"
                                id="quickLastName"
                                class="form-control"
                                required
                            />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number *</label>
                        <input
                            type="tel"
                            id="quickPhone"
                            class="form-control"
                            required
                        />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input
                            type="email"
                            id="quickEmail"
                            class="form-control"
                        />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gender *</label>
                        <select id="quickGender" class="form-select" required>
                            <option value="">Select gender...</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Cancel
                </button>
                <button
                    type="button"
                    id="saveQuickClientBtn"
                    class="btn btn-primary"
                    onclick="saveQuickClient()"
                >
                    <i class="fas fa-save me-2"></i>Save Client
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Select2 Customer Dropdown Styling */
    .select2-customer-container .select2-selection {
        min-height: 48px !important;
        border: 2px solid #e2e8f0 !important;
        border-radius: 8px !important;
        padding: 8px 12px !important;
        font-size: 15px !important;
    }

    .select2-customer-container .select2-selection__rendered {
        line-height: 32px !important;
        padding-left: 8px !important;
    }

    .select2-customer-dropdown {
        border: 2px solid #4f46e5 !important;
        border-radius: 8px !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15) !important;
    }

    .select2-customer-dropdown .select2-search--dropdown {
        padding: 12px !important;
        background: #f8f9fa !important;
        border-bottom: 1px solid #e2e8f0 !important;
    }

    .select2-customer-dropdown .select2-search__field {
        width: 100% !important;
        padding: 10px 16px !important;
        border: 2px solid #cbd5e1 !important;
        border-radius: 6px !important;
        font-size: 14px !important;
        background: white !important;
    }

    .select2-customer-dropdown .select2-search__field:focus {
        border-color: #4f46e5 !important;
        outline: none !important;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important;
    }

    .select2-customer-dropdown .select2-results__options {
        padding: 8px !important;
        max-height: 300px !important;
    }

    .select2-customer-dropdown .select2-results__option {
        padding: 12px 16px !important;
        margin-bottom: 4px !important;
        border-radius: 6px !important;
        transition: all 0.2s !important;
    }

    .select2-customer-dropdown .select2-results__option:hover {
        background: #eff6ff !important;
    }

    .select2-customer-dropdown .select2-results__option--highlighted {
        background: #eff6ff !important;
        color: #1e293b !important;
    }

    .select2-customer-dropdown .select2-results__option--selected {
        background: #dbeafe !important;
        color: #1e40af !important;
        font-weight: 500 !important;
    }

    /* Select2 Service and Staff Dropdown Styling - Bootstrap 5 Theme Override */
    .select2-container--bootstrap-5 .select2-selection {
        min-height: 44px !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 8px !important;
        background: white !important;
    }

    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        color: #212529 !important;
        line-height: 42px !important;
        padding-left: 12px !important;
    }

    .select2-container--bootstrap-5 .select2-dropdown {
        border: 1px solid #dee2e6 !important;
        border-radius: 8px !important;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15) !important;
        background: white !important;
    }

    /* Ensure search box is visible in dropdown */
    .select2-container--bootstrap-5 .select2-search--dropdown {
        display: block !important;
        padding: 10px !important;
        background: #f8f9fa !important;
        border-bottom: 1px solid #e9ecef !important;
    }

    .select2-container--bootstrap-5 .select2-search--dropdown .select2-search__field {
        display: block !important;
        width: 100% !important;
        padding: 8px 12px !important;
        border: 1px solid #ced4da !important;
        border-radius: 6px !important;
        font-size: 14px !important;
        background: white !important;
        color: #212529 !important;
    }

    .select2-container--bootstrap-5 .select2-search--dropdown .select2-search__field:focus {
        border-color: #86b7fe !important;
        outline: none !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25) !important;
    }

    .select2-container--bootstrap-5 .select2-results__options {
        background: white !important;
        max-height: 300px !important;
        overflow-y: auto !important;
    }

    .select2-container--bootstrap-5 .select2-results__option {
        padding: 10px 14px !important;
        color: #212529 !important;
        background: white !important;
        transition: background 0.15s ease !important;
    }

    .select2-container--bootstrap-5 .select2-results__option:hover,
    .select2-container--bootstrap-5 .select2-results__option--highlighted {
        background: #e9ecef !important;
        color: #212529 !important;
    }

    .select2-container--bootstrap-5 .select2-results__option--selected {
        background: #0d6efd !important;
        color: white !important;
    }

    .customer-option {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .customer-name {
        font-weight: 500;
        color: #1e293b;
        font-size: 14px;
    }

    .customer-phone {
        font-size: 13px;
        color: #64748b;
    }

    .appointment-card {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        position: relative;
        transition: all 0.3s;
    }

    .appointment-card:hover {
        border-color: #4f46e5;
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
    }

    .appointment-card.has-conflict {
        border-color: #ef4444 !important;
        background: #fef2f2;
    }

    .appointment-card.has-warning {
        border-color: #f59e0b !important;
        background: #fffbeb;
    }

    .appointment-card.validating {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .appointment-card.validated {
        border-color: #10b981;
        background: #f0fdf4;
    }

    .time-display-12hr {
        display: block;
        margin-top: 4px;
        font-size: 0.875rem;
        color: #4f46e5;
        font-weight: 600;
    }

    .appointment-number {
        position: absolute;
        top: -10px;
        left: 20px;
        background: #4f46e5;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .remove-appointment {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: #ef4444;
        color: white;
        cursor: pointer;
        transition: all 0.2s;
    }

    .remove-appointment:hover {
        background: #dc2626;
        transform: scale(1.1);
    }

    .validation-icon {
        display: none;
        margin-left: 8px;
    }

    .validation-icon.show {
        display: inline-block;
    }

    .field-validated {
        border-color: #10b981 !important;
        background-color: #f0fdf4;
    }

    .field-error {
        border-color: #ef4444 !important;
        background-color: #fef2f2;
    }

    .field-validating {
        border-color: #3b82f6 !important;
        background-color: #eff6ff;
    }

    .field-warning {
        border-color: #f59e0b !important;
        background-color: #fffbeb;
    }

    @keyframes shake {
        0%,
        100% {
            transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
            transform: translateX(-5px);
        }
        20%,
        40%,
        60%,
        80% {
            transform: translateX(5px);
        }
    }

    .shake-animation {
        animation: shake 0.5s;
    }

    .validation-toast {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        min-width: 400px;
        max-width: 500px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
</style>

<!-- Select2 CSS for searchable dropdowns -->
<link
    href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
    rel="stylesheet"
/>
<!-- Select2 Bootstrap 5 Theme CSS for styled searchable dropdowns -->
<link
    href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    rel="stylesheet"
/>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="{{ url_for('static', filename='js/multi_appointment_booking.js') }}"></script>
{% endblock %}