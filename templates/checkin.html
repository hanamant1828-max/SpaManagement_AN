{% extends "base.html" %}

{% block title %}Check-In - Spa & Salon Suite{% endblock %}

{% block extra_css %}
<style>
.checkin-page {
    background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
    min-height: 100vh;
    padding: 0;
}

.checkin-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem 2.5rem;
    margin-bottom: 2rem;
    position: relative;
    overflow: hidden;
}

.checkin-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 400px;
    height: 400px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 50%;
}

.checkin-header::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: 5%;
    width: 200px;
    height: 200px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 50%;
}

.header-content {
    position: relative;
    z-index: 1;
}

.header-icon {
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1.25rem;
    backdrop-filter: blur(10px);
}

.header-icon i {
    font-size: 1.75rem;
    color: #ffffff;
}

.header-title {
    color: #ffffff;
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
    letter-spacing: -0.02em;
}

.header-subtitle {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.95rem;
    margin: 0.25rem 0 0;
}

.checkin-container {
    padding: 0 2rem 2rem;
}

.camera-section {
    background: #ffffff;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
    height: 100%;
}

.section-header {
    background: linear-gradient(135deg, #1a1f36 0%, #252d4a 100%);
    padding: 1rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-header-icon {
    width: 36px;
    height: 36px;
    background: rgba(102, 126, 234, 0.3);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.section-header-icon i {
    color: #a5b4fc;
    font-size: 1rem;
}

.section-header h5 {
    color: #ffffff;
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
}

.camera-container {
    background: linear-gradient(135deg, #1e2235 0%, #252d4a 100%);
    min-height: 380px;
    height: 380px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.camera-placeholder {
    text-align: center;
    padding: 2rem;
}

.camera-placeholder-icon {
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.08);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    border: 2px dashed rgba(255, 255, 255, 0.2);
}

.camera-placeholder-icon i {
    font-size: 2.5rem;
    color: rgba(255, 255, 255, 0.4);
}

.camera-placeholder h6 {
    color: rgba(255, 255, 255, 0.7);
    font-size: 1rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.camera-placeholder p {
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.85rem;
    margin: 0;
}

#checkinVideo {
    width: 100%;
    height: 380px;
    object-fit: cover;
    display: block;
}

.camera-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 4px solid #667eea !important;
    border-radius: 50%;
    width: 260px;
    height: 260px;
    pointer-events: none;
    z-index: 100;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 30px rgba(102, 126, 234, 0.5) !important;
}

.camera-overlay.scanning-animation {
    animation: scanPulse 2s ease-in-out infinite;
}

@keyframes scanPulse {
    0%, 100% {
        border-color: #667eea;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 30px rgba(102, 126, 234, 0.5);
    }
    50% {
        border-color: #a5b4fc;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 50px rgba(102, 126, 234, 0.8);
    }
}

.camera-overlay.detecting {
    border-color: #fbbf24 !important;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 30px rgba(251, 191, 36, 0.6) !important;
    animation: detectPulse 0.5s ease-in-out infinite;
}

@keyframes detectPulse {
    0%, 100% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.02); }
}

.camera-overlay.success {
    border-color: #10b981 !important;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 40px rgba(16, 185, 129, 0.7) !important;
}

.camera-overlay.error {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6), 0 0 30px rgba(239, 68, 68, 0.6) !important;
}

.camera-actions {
    padding: 1.25rem;
    background: #f8fafc;
    display: flex;
    gap: 0.75rem;
    justify-content: center;
}

.btn-camera {
    padding: 0.75rem 2rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
    border: none;
}

.btn-camera-start {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: #ffffff;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-camera-start:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    color: #ffffff;
}

.btn-camera-start:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-camera-stop {
    background: linear-gradient(135deg, #64748b 0%, #475569 100%);
    color: #ffffff;
    box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
}

.btn-camera-stop:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4);
    color: #ffffff;
}

.btn-camera-stop:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.status-section {
    background: #ffffff;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
    height: 100%;
}

.status-content {
    padding: 1.5rem;
}

.status-card {
    border-radius: 16px;
    padding: 1.25rem;
    margin-bottom: 1.25rem;
}

.status-card.status-ready {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border: 1px solid #bfdbfe;
}

.status-card.status-scanning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 1px solid #fcd34d;
}

.status-card.status-success {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    border: 1px solid #6ee7b7;
}

.status-card.status-error {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border: 1px solid #fca5a5;
}

.status-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 1rem;
}

.status-ready .status-icon {
    background: #3b82f6;
}

.status-scanning .status-icon {
    background: #f59e0b;
    animation: statusPulse 1s ease-in-out infinite;
}

.status-success .status-icon {
    background: #10b981;
}

.status-error .status-icon {
    background: #ef4444;
}

@keyframes statusPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.status-icon i {
    color: #ffffff;
    font-size: 1.25rem;
}

.status-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.25rem;
}

.status-message {
    font-size: 0.85rem;
    color: #64748b;
    margin: 0;
}

.progress-container {
    margin-bottom: 1.5rem;
    display: none;
}

.progress-container.active {
    display: block;
}

.progress-bar-custom {
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
    background-size: 200% 100%;
    animation: progressMove 1.5s linear infinite;
    border-radius: 4px;
}

@keyframes progressMove {
    0% { background-position: 100% 0; }
    100% { background-position: -100% 0; }
}

.progress-text {
    text-align: center;
    font-size: 0.8rem;
    color: #64748b;
    margin-top: 0.5rem;
}

.customer-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.25rem;
    display: none;
}

.customer-card.visible {
    display: block;
    animation: fadeInUp 0.4s ease;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.customer-avatar {
    width: 72px;
    height: 72px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1rem;
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.customer-avatar span {
    color: #ffffff;
    font-size: 1.75rem;
    font-weight: 700;
}

.customer-name {
    color: #ffffff;
    font-size: 1.25rem;
    font-weight: 600;
    text-align: center;
    margin-bottom: 0.25rem;
}

.customer-phone {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
    text-align: center;
    margin-bottom: 1rem;
}

.customer-stats {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 1rem;
}

.customer-stat {
    text-align: center;
}

.customer-stat-value {
    color: #ffffff;
    font-size: 1.25rem;
    font-weight: 700;
}

.customer-stat-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.btn-billing {
    display: block;
    width: 100%;
    padding: 0.85rem;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 12px;
    color: #ffffff;
    font-weight: 600;
    font-size: 0.9rem;
    text-align: center;
    transition: all 0.2s ease;
    text-decoration: none;
}

.btn-billing:hover {
    background: rgba(255, 255, 255, 0.3);
    color: #ffffff;
    transform: translateY(-2px);
}

.btn-checkin-customer {
    display: block;
    width: 100%;
    padding: 0.85rem;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border: none;
    border-radius: 12px;
    color: #ffffff;
    font-weight: 600;
    font-size: 0.9rem;
    text-align: center;
    transition: all 0.2s ease;
    cursor: pointer;
    margin-top: 1rem;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-checkin-customer:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.btn-checkin-customer:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.last-recognition {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1rem;
}

.last-recognition h6 {
    font-size: 0.8rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
}

.last-recognition p {
    font-size: 0.9rem;
    color: #334155;
    margin-bottom: 0.25rem;
}

.last-recognition small {
    font-size: 0.8rem;
    color: #94a3b8;
}

.appointments-section {
    background: #ffffff;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
    margin-top: 1.5rem;
}

.appointments-table {
    width: 100%;
}

.appointments-table th {
    background: #f8fafc;
    color: #64748b;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e2e8f0;
}

.appointments-table td {
    padding: 1rem 1.25rem;
    color: #334155;
    font-size: 0.9rem;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
}

.appointments-table tr:last-child td {
    border-bottom: none;
}

.appointments-table tr:hover td {
    background: #f8fafc;
}

.client-info-cell strong {
    display: block;
    color: #1e293b;
    margin-bottom: 0.15rem;
}

.client-info-cell small {
    color: #94a3b8;
    font-size: 0.8rem;
}

.badge-status {
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

.badge-scheduled {
    background: #fef3c7;
    color: #92400e;
}

.badge-confirmed {
    background: #dbeafe;
    color: #1e40af;
}

.badge-in-progress {
    background: #ede9fe;
    color: #6b21a8;
}

.badge-completed {
    background: #d1fae5;
    color: #065f46;
}

.btn-action {
    padding: 0.4rem 0.75rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 500;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    transition: all 0.2s ease;
}

.btn-checkin {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: #ffffff;
}

.btn-checkin:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    color: #ffffff;
}

.btn-delete-face {
    background: #fee2e2;
    color: #dc2626;
    margin-left: 0.5rem;
}

.btn-delete-face:hover {
    background: #fecaca;
    color: #b91c1c;
}

.empty-appointments {
    text-align: center;
    padding: 3rem 2rem;
}

.empty-icon {
    width: 80px;
    height: 80px;
    background: #f1f5f9;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.25rem;
}

.empty-icon i {
    font-size: 2rem;
    color: #94a3b8;
}

.empty-appointments h5 {
    color: #334155;
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.empty-appointments p {
    color: #94a3b8;
    font-size: 0.9rem;
    margin: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="checkin-page">
    <div class="checkin-header">
        <div class="header-content d-flex align-items-center">
            <div class="header-icon">
                <i class="fas fa-user-check"></i>
            </div>
            <div>
                <h1 class="header-title">Client Check-In</h1>
                <p class="header-subtitle">Face recognition powered quick check-in system</p>
            </div>
        </div>
    </div>

    <div class="checkin-container">
        <div class="row g-4">
            <div class="col-lg-7">
                <div class="camera-section">
                    <div class="section-header">
                        <div class="section-header-icon">
                            <i class="fas fa-video"></i>
                        </div>
                        <h5>Face Recognition Camera</h5>
                    </div>
                    <div class="camera-container" id="cameraContainer">
                        <div id="cameraPlaceholder" class="camera-placeholder">
                            <div class="camera-placeholder-icon">
                                <i class="fas fa-camera"></i>
                            </div>
                            <h6>Camera Preview</h6>
                            <p>Click "Start Recognition" to begin</p>
                        </div>
                        <video id="checkinVideo" style="display: none;" autoplay playsinline></video>
                        <div id="cameraOverlay" class="camera-overlay" style="display: none;"></div>
                    </div>
                    <div class="camera-actions">
                        <button type="button" id="startRecognition" class="btn btn-camera btn-camera-start">
                            <i class="fas fa-play"></i>
                            Start Recognition
                        </button>
                        <button type="button" id="stopRecognition" class="btn btn-camera btn-camera-stop" disabled>
                            <i class="fas fa-stop"></i>
                            Stop
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="status-section">
                    <div class="section-header">
                        <div class="section-header-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <h5>Recognition Status</h5>
                    </div>
                    <div class="status-content">
                        <div id="statusAlert" class="status-card status-ready">
                            <div class="d-flex align-items-start">
                                <div class="status-icon">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div>
                                    <div class="status-title">Ready for Check-In</div>
                                    <p class="status-message">Click "Start Recognition" and position your face in the circle for automatic check-in.</p>
                                </div>
                            </div>
                        </div>

                        <div id="scanningProgress" class="progress-container">
                            <div class="progress-bar-custom">
                                <div class="progress-fill" style="width: 100%;"></div>
                            </div>
                            <p class="progress-text" id="progressText">Scanning for faces...</p>
                        </div>

                        <div id="customerInfo" class="customer-card">
                            <div class="customer-avatar" id="customerAvatar">
                                <span>--</span>
                            </div>
                            <div class="customer-name" id="customerName">Customer Name</div>
                            <div class="customer-phone" id="customerPhone">Phone Number</div>
                            <div class="customer-stats">
                                <div class="customer-stat">
                                    <div class="customer-stat-value" id="customerVisits">0</div>
                                    <div class="customer-stat-label">Visits</div>
                                </div>
                                <div class="customer-stat">
                                    <div class="customer-stat-value" id="customerStatus">Regular</div>
                                    <div class="customer-stat-label">Status</div>
                                </div>
                            </div>
                            <button type="button" class="btn-checkin-customer" id="checkInCustomerBtn" onclick="checkInRecognizedCustomer()" style="display: none;">
                                <i class="fas fa-check-circle me-2"></i>Check In Customer
                            </button>
                        </div>

                        <div class="last-recognition">
                            <h6>Last Recognition</h6>
                            <p id="lastRecognition">No recent activity</p>
                            <small>System will automatically identify clients and load their appointments</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="appointments-section">
            <div class="section-header">
                <div class="section-header-icon">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <h5>Today's Appointments</h5>
            </div>
            {% if appointments %}
            <div class="table-responsive">
                <table class="appointments-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Client</th>
                            <th>Service</th>
                            <th>Staff</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentsTable">
                        {% for appointment in appointments %}
                        <tr data-appointment-id="{{ appointment.id }}" data-client-id="{{ appointment.client.id }}"
                            {% if appointment.status == 'in_progress' %}style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%) !important;"{% endif %}>
                            <td>
                                <strong>{{ appointment.appointment_date.strftime('%I:%M %p') }}</strong>
                            </td>
                            <td class="client-info-cell">
                                <strong>{{ appointment.client.full_name }}</strong>
                                <small>{{ appointment.client.phone }}</small>
                                {% if appointment.status == 'in_progress' %}
                                <div style="display: flex; align-items: center; gap: 4px; font-size: 0.7rem; color: #78350f; font-weight: 600; margin-top: 4px; padding: 2px 6px; background: rgba(245, 158, 11, 0.15); border-radius: 4px; width: fit-content;">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Checked In</span>
                                </div>
                                {% endif %}
                            </td>
                            <td>{{ appointment.service.name }}</td>
                            <td>{{ appointment.assigned_staff.full_name }}</td>
                            <td>
                                {% if appointment.status == 'scheduled' %}
                                <span class="badge-status badge-scheduled">Scheduled</span>
                                {% elif appointment.status == 'confirmed' %}
                                <span class="badge-status badge-confirmed">Confirmed</span>
                                {% elif appointment.status == 'in_progress' %}
                                <span class="badge-status badge-in-progress">In Progress</span>
                                {% elif appointment.status == 'completed' %}
                                <span class="badge-status badge-completed">Completed</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if appointment.status in ['scheduled', 'confirmed'] %}
                                <form method="POST" action="{{ url_for('checkin_appointment', id=appointment.id) }}" style="display: inline;">
                                    <button type="submit" class="btn-action btn-checkin">
                                        <i class="fas fa-check"></i>
                                        Check In
                                    </button>
                                </form>
                                {% elif appointment.status == 'in_progress' %}
                                <span class="badge-status badge-in-progress">Checked In</span>
                                {% else %}
                                <span class="badge-status" style="background: #f1f5f9; color: #64748b;">{{ appointment.status.title() }}</span>
                                {% endif %}

                                {% if appointment.client.face_encoding or appointment.client.face_image_url %}
                                <button type="button" class="btn-action btn-delete-face"
                                        onclick="deleteFaceDataFromCheckin({{ appointment.client.id }}, '{{ appointment.client.full_name }}')"
                                        title="Delete Face Data">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="empty-appointments">
                <div class="empty-icon">
                    <i class="fas fa-calendar-xmark"></i>
                </div>
                <h5>No appointments today</h5>
                <p>No scheduled appointments for today.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
console.log('Face recognition check-in module loaded');

let checkinStream = null;
let checkinRecognitionInterval = null;
let checkinIsRecognizing = false;
let recognizedCustomerId = null;

let video = null;
let canvas = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('=== CHECKIN PAGE DOM LOADED ===');

    const startButton = document.getElementById('startRecognition');
    const stopButton = document.getElementById('stopRecognition');
    video = document.getElementById('checkinVideo');
    const placeholder = document.getElementById('cameraPlaceholder');
    canvas = document.createElement('canvas');

    console.log('Elements found:');
    console.log('- Start button:', startButton);
    console.log('- Stop button:', stopButton);
    console.log('- Video element:', video);
    console.log('- Placeholder:', placeholder);
    console.log('- Canvas element:', canvas);

    if (startButton) {
        console.log('Attaching click handler to start button...');

        startButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('>>> START BUTTON CLICKED <<<');
            startFaceRecognition();
        });

        console.log('Start button listener attached successfully');
    } else {
        console.error('Start button NOT FOUND');
    }

    if (stopButton) {
        stopButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('>>> STOP BUTTON CLICKED <<<');
            stopRecognition();
        });
        console.log('Stop button listener attached');
    } else {
        console.error('Stop button NOT FOUND');
    }

    console.log('=== CHECKIN PAGE INITIALIZATION COMPLETE ===');
});

async function startFaceRecognition() {
    console.log('START FACE RECOGNITION FUNCTION CALLED');

    try {
        console.log('Step 1: Checking camera API availability...');

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error('Camera API not available in this browser. Please use Chrome, Firefox, or Safari.');
        }
        console.log('Camera API available');

        console.log('Step 2: Requesting camera access...');

        try {
            checkinStream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user'
                }
            });
        } catch (videoError) {
            console.log('Trying basic camera constraints...');
            checkinStream = await navigator.mediaDevices.getUserMedia({
                video: true
            });
        }

        console.log('Camera access granted!');
        console.log('Stream details:', checkinStream);
        console.log('Video tracks:', checkinStream.getVideoTracks());

        console.log('Step 3: Getting DOM elements...');

        console.log('Video element:', video);
        console.log('Placeholder element:', document.getElementById('cameraPlaceholder'));
        console.log('Overlay element:', document.getElementById('cameraOverlay'));

        console.log('Step 4: Setting up video stream...');
        if (!video) {
            throw new Error('Video element not found!');
        }

        video.srcObject = checkinStream;
        console.log('Video source set');

        console.log('Step 5: Starting video playback...');
        await video.play();
        console.log('Video playing');

        console.log('Step 6: Updating UI...');
        video.style.display = 'block';
        video.style.position = 'absolute';
        video.style.top = '0';
        video.style.left = '0';
        const placeholder = document.getElementById('cameraPlaceholder');
        if (placeholder) placeholder.style.display = 'none';
        const overlay = document.getElementById('cameraOverlay');
        if (overlay) {
            overlay.style.display = 'block';
            overlay.classList.add('scanning-animation');
        }
        console.log('UI updated');

        console.log('Step 7: Updating button states...');
        const startBtn = document.getElementById('startRecognition');
        const stopBtn = document.getElementById('stopRecognition');
        if (startBtn) startBtn.disabled = true;
        if (stopBtn) stopBtn.disabled = false;
        console.log('Buttons updated');

        console.log('Step 8: Updating status message...');
        window.recognitionAttempts = 0;
        recognizedCustomerId = null;
        updateStatus('scanning', 'Scanning for Faces', 'Position your face in the circle for recognition.');

        const progressBar = document.getElementById('scanningProgress');
        if (progressBar) {
            progressBar.classList.add('active');
        }

        console.log('Step 9: Starting recognition loop...');
        checkinIsRecognizing = true;
        checkinRecognitionInterval = setInterval(() => performRecognition(video), 2000);

        console.log('FACE RECOGNITION STARTED SUCCESSFULLY');

    } catch (error) {
        console.error('Camera access error:', error);
        console.error('Error name:', error.name);
        console.error('Error message:', error.message);

        let errorTitle = 'Camera Access Error';
        let errorMessage = '';

        if (error.name === 'NotAllowedError') {
            errorMessage = 'Camera permission was denied. Please click the camera icon in your browser\'s address bar and allow camera access, then try again.';
        } else if (error.name === 'NotFoundError') {
            errorMessage = 'No camera detected on this device. Please ensure a camera is connected and try again.';
        } else if (error.name === 'NotReadableError') {
            errorMessage = 'Camera is currently being used by another application. Please close other apps using the camera and try again.';
        } else {
            errorMessage = 'Unable to access camera. Please check your camera settings and permissions, then try again.';
        }

        updateStatus('error', errorTitle, errorMessage);
    }
}

console.log('Face recognition check-in script loaded and ready');

function stopRecognition() {
    console.log('Stopping face recognition...');

    window.recognitionAttempts = 0;

    if (checkinStream) {
        checkinStream.getTracks().forEach(track => track.stop());
        checkinStream = null;
    }

    if (checkinRecognitionInterval) {
        clearInterval(checkinRecognitionInterval);
        checkinRecognitionInterval = null;
    }

    checkinIsRecognizing = false;

    if (video) video.style.display = 'none';
    const placeholder = document.getElementById('cameraPlaceholder');
    if (placeholder) placeholder.style.display = 'flex';
    const overlay = document.getElementById('cameraOverlay');
    if (overlay) {
        overlay.style.display = 'none';
        overlay.classList.remove('scanning-animation');
        overlay.classList.remove('success');
        overlay.classList.remove('error');
        overlay.classList.remove('detecting');
    }

    document.getElementById('startRecognition').disabled = false;
    document.getElementById('stopRecognition').disabled = true;

    const progressBar = document.getElementById('scanningProgress');
    if (progressBar) {
        progressBar.classList.remove('active');
    }

    if (!recognizedCustomerId) {
        updateStatus('ready', 'Ready for Check-In', 'Click "Start Recognition" and position your face in the circle for automatic check-in.');
    }

    console.log('Face recognition stopped - customer info remains visible');
}

function updateStatus(type, title, message) {
    const statusAlert = document.getElementById('statusAlert');
    if (!statusAlert) return;

    statusAlert.className = 'status-card';

    let iconClass = 'fa-check';

    switch(type) {
        case 'ready':
        case 'info':
            statusAlert.classList.add('status-ready');
            iconClass = 'fa-check';
            break;
        case 'scanning':
        case 'warning':
            statusAlert.classList.add('status-scanning');
            iconClass = 'fa-spinner fa-spin';
            break;
        case 'success':
            statusAlert.classList.add('status-success');
            iconClass = 'fa-check-circle';
            break;
        case 'error':
        case 'danger':
            statusAlert.classList.add('status-error');
            iconClass = 'fa-exclamation-triangle';
            break;
    }

    statusAlert.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="status-icon">
                <i class="fas ${iconClass}"></i>
            </div>
            <div>
                <div class="status-title">${title}</div>
                <p class="status-message">${message}</p>
            </div>
        </div>
    `;
}

function showCustomerInfo(customer, todaysAppointments) {
    const customerCard = document.getElementById('customerInfo');
    const customerAvatar = document.getElementById('customerAvatar');
    const customerName = document.getElementById('customerName');
    const customerPhone = document.getElementById('customerPhone');
    const customerVisits = document.getElementById('customerVisits');
    const customerStatus = document.getElementById('customerStatus');
    const checkInBtn = document.getElementById('checkInCustomerBtn');

    if (!customerCard) return;

    const initials = customer.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    customerAvatar.innerHTML = `<span>${initials}</span>`;
    customerName.textContent = customer.name;
    customerPhone.textContent = customer.phone || 'No phone';
    customerVisits.textContent = customer.total_visits || customer.visits || '0';
    customerStatus.textContent = customer.is_vip ? 'VIP' : 'Regular';

    customerCard.classList.add('visible');
    recognizedCustomerId = customer.id;

    // Show check-in button
    if (checkInBtn) {
        checkInBtn.style.display = 'block';
    }
    
    // Update the appointments table with today's appointments for this customer
    const appointmentsTable = document.getElementById('appointmentsTable');
    if (appointmentsTable && todaysAppointments) {
        if (todaysAppointments.length > 0) {
            let html = '';
            todaysAppointments.forEach(apt => {
                const statusBadge = apt.status === 'scheduled' ? 
                    '<span class="badge bg-primary">Scheduled</span>' :
                    apt.status === 'confirmed' ? 
                    '<span class="badge bg-success">Confirmed</span>' :
                    apt.status === 'in_progress' ? 
                    '<span class="badge bg-warning">In Progress</span>' :
                    `<span class="badge bg-secondary">${apt.status}</span>`;
                    
                html += `
                    <tr data-appointment-id="${apt.id}" data-client-id="${customer.id}">
                        <td><strong>${apt.start_time}</strong></td>
                        <td class="client-info-cell">
                            <strong>${customer.name}</strong>
                            <small>${customer.phone || ''}</small>
                        </td>
                        <td>${apt.service_name}</td>
                        <td>${apt.staff_name}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <form method="POST" action="/checkin/${apt.id}" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-success">
                                    <i class="fas fa-check me-1"></i>Check In
                                </button>
                            </form>
                        </td>
                    </tr>
                `;
            });
            appointmentsTable.innerHTML = html;
            
            // Show the appointments section
            const emptyAppointments = document.querySelector('.empty-appointments');
            const appointmentsTableEl = document.querySelector('.appointments-table');
            if (emptyAppointments) emptyAppointments.style.display = 'none';
            if (appointmentsTableEl) appointmentsTableEl.style.display = 'table';
            
            console.log(`ðŸ“… Displayed ${todaysAppointments.length} appointments for ${customer.name}`);
        } else {
            appointmentsTable.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
                        <p class="mb-0 text-muted">No appointments scheduled for ${customer.name} today</p>
                    </td>
                </tr>
            `;
            console.log(`ðŸ“… No appointments found for ${customer.name} today`);
        }
    }
}

function hideCustomerInfo() {
    const customerCard = document.getElementById('customerInfo');
    if (customerCard) {
        customerCard.classList.remove('visible');
    }
    recognizedCustomerId = null;
}

function showErrorMessage(message) {
    updateStatus('error', 'Recognition Error', message);
}

async function performRecognition(videoElement) {
    if (!checkinIsRecognizing || !videoElement) return;

    console.log('Performing face recognition...');

    window.recognitionAttempts = (window.recognitionAttempts || 0) + 1;
    const progressText = document.getElementById('progressText');
    if (progressText) {
        progressText.textContent = `Scanning... (Attempt ${window.recognitionAttempts})`;
    }

    const overlay = document.getElementById('cameraOverlay');
    if (overlay) {
        overlay.classList.add('detecting');
    }

    try {
        if (!canvas) {
            canvas = document.createElement('canvas');
        }
        canvas.width = videoElement.videoWidth || 640;
        canvas.height = videoElement.videoHeight || 480;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL('image/jpeg', 0.8);

        // Send to recognition API
        const response = await fetch('/api/face-recognition/recognize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin', // Include session cookies
            body: JSON.stringify({
                image: imageData
            })
        });

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('Non-JSON response received:', response.status);
            if (response.status === 401 || response.status === 302) {
                showErrorMessage('Session expired. Please refresh the page and log in again.');
                stopRecognition();
                return;
            }
            showErrorMessage('Server error. Please try again.');
            if (overlay) { // Ensure overlay is defined before accessing properties
                overlay.style.borderColor = '#667eea'; // Back to blue
                overlay.classList.remove('detecting');
            }
            return;
        }

        const result = await response.json();

        if (overlay) {
            overlay.classList.remove('detecting');
        }

        if (result.success && result.customer) {
            console.log('Customer recognized:', result.customer);

            if (overlay) {
                overlay.classList.remove('scanning-animation');
                overlay.classList.add('success');
            }

            updateStatus('success', 'Customer Recognized!', `Welcome back, ${result.customer.name}!`);
            showCustomerInfo(result.customer, result.todays_appointments || []);

            const lastRecognition = document.getElementById('lastRecognition');
            if (lastRecognition) {
                const now = new Date();
                lastRecognition.textContent = `${result.customer.name} - ${now.toLocaleTimeString()}`;
            }

            clearInterval(checkinRecognitionInterval);
            checkinRecognitionInterval = null;

        } else if (result.face_detected) {
            console.log('Face detected but not recognized');
            updateStatus('scanning', 'Face Detected', 'Face found but not recognized. Continuing to scan...');
        } else {
            console.log('No face detected in frame');
            updateStatus('scanning', 'Scanning...', 'Position your face in the circle for recognition.');
        }

    } catch (error) {
        console.error('Recognition error:', error);
        if (overlay) {
            overlay.classList.remove('detecting');
        }
        showErrorMessage('An unexpected error occurred during recognition. Please try again.');
    }
}

function deleteFaceDataFromCheckin(clientId, clientName) {
    if (typeof Swal !== 'undefined') {
        Swal.fire({
            title: 'Delete Face Data?',
            text: `This will remove face recognition data for ${clientName}. They will need to re-register their face for future check-ins.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ef4444',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Yes, delete it',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                performFaceDataDeletion(clientId);
            }
        });
    } else {
        if (confirm(`Delete face data for ${clientName}? This action cannot be undone.`)) {
            performFaceDataDeletion(clientId);
        }
    }
}

async function performFaceDataDeletion(clientId) {
    try {
        const response = await fetch(`/api/delete-face-data/${clientId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const result = await response.json();

        if (result.success) {
            if (typeof Swal !== 'undefined') {
                Swal.fire('Deleted!', 'Face data has been removed.', 'success');
            } else {
                alert('Face data has been removed successfully.');
            }
            location.reload();
        } else {
            throw new Error(result.message || 'Failed to delete face data');
        }
    } catch (error) {
        console.error('Error deleting face data:', error);
        if (typeof Swal !== 'undefined') {
            Swal.fire('Error', 'Failed to delete face data. Please try again.', 'error');
        } else {
            alert('Failed to delete face data. Please try again.');
        }
    }
}

async function checkInRecognizedCustomer() {
    if (!recognizedCustomerId) {
        alert('No customer recognized. Please scan face first.');
        return;
    }

    const checkInBtn = document.getElementById('checkInCustomerBtn');
    if (checkInBtn) {
        checkInBtn.disabled = true;
        checkInBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Checking in...';
    }

    try {
        // Use the manual check-in API endpoint
        const response = await fetch('/api/unaki/checkin/manual', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                client_id: recognizedCustomerId
            })
        });

        const data = await response.json();

        if (data.success) {
            updateStatus('success', 'Check-In Successful!', `${data.customer_name} checked in for ${data.checked_in_count} appointment(s).`);
            
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'success',
                    title: 'Check-In Successful!',
                    html: `<strong>${data.customer_name}</strong> has been checked in for <strong>${data.checked_in_count}</strong> appointment(s).`,
                    timer: 2000,
                    confirmButtonColor: '#10b981',
                    showConfirmButton: false
                }).then(() => {
                    location.reload();
                });
            } else {
                alert(`Check-In Successful! ${data.customer_name} checked in for ${data.checked_in_count} appointment(s).`);
                location.reload();
            }
        } else {
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'warning',
                    title: data.message || 'No Appointments',
                    text: data.error || 'This customer has no appointments scheduled for today.',
                    confirmButtonColor: '#f59e0b'
                });
            } else {
                alert(data.message || 'This customer has no appointments scheduled for today.');
            }
            if (checkInBtn) {
                checkInBtn.disabled = false;
                checkInBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Check In Customer';
            }
        }

    } catch (error) {
        console.error('Check-in error:', error);
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: 'error',
                title: 'Check-In Failed',
                text: 'Unable to check in customer. Please try again.',
                confirmButtonColor: '#ef4444'
            });
        } else {
            alert('Check-in failed. Please try again.');
        }
        if (checkInBtn) {
            checkInBtn.disabled = false;
            checkInBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Check In Customer';
        }
    }
}
</script>
{% endblock %}