{% extends "base.html" %}

{% block title %}Inventory Management - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-boxes me-2"></i>Inventory Management</h2>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" onclick="openAddInventoryModal()">
                        <i class="fas fa-plus me-1"></i>Add Inventory Items
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="openAddProductModal()">
                        <i class="fas fa-box me-1"></i>Add Product
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="openAddCategoryModal()">
                        <i class="fas fa-tags me-1"></i>Add Category
                    </button>
                </div>
            </div>

            <!-- Dashboard Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ stats.total_products }}</h4>
                                    <p class="card-text">Total Products</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-boxes fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ stats.low_stock_count }}</h4>
                                    <p class="card-text">Low Stock Items</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ stats.out_of_stock_count }}</h4>
                                    <p class="card-text">Out of Stock</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-times-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">${{ "{:.2f}".format(stats.total_value) }}</h4>
                                    <p class="card-text">Inventory Value</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-dollar-sign fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="inventoryTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
                        <i class="fas fa-box me-1"></i>Product Master
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">
                        <i class="fas fa-tags me-1"></i>Categories
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="adjustments-tab" data-bs-toggle="tab" data-bs-target="#adjustments" type="button" role="tab">
                        <i class="fas fa-plus-circle me-1"></i>Add Inventory Items
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="consumption-tab" data-bs-toggle="tab" data-bs-target="#consumption" type="button" role="tab">
                        <i class="fas fa-minus-circle me-1"></i>Consumption
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="inventoryTabContent">
                <!-- Dashboard Tab -->
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Stock Level Overview</h5>
                        </div>
                        <div class="card-body">
                            <!-- Critical Alerts -->
                            {% if critical_alerts %}
                            <div class="alert alert-danger mb-3">
                                <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-1"></i>Critical Alerts</h6>
                                {% for alert in critical_alerts %}
                                <div class="mb-1">{{ alert.message }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Recent Stock Movements -->
                            <div class="row">
                                <div class="col-md-12">
                                    <h6><i class="fas fa-history me-1"></i>Recent Stock Movements</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Product</th>
                                                    <th>Type</th>
                                                    <th>Quantity</th>
                                                    <th>Reason</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for movement in recent_movements %}
                                                <tr>
                                                    <td>{{ movement.created_at.strftime('%Y-%m-%d %H:%M') if movement.created_at else 'N/A' }}</td>
                                                    <td>{{ movement.product.name if movement.product else 'Unknown' }}</td>
                                                    <td>
                                                        <span class="badge bg-{{ 'success' if movement.movement_type == 'in' else 'danger' }}">
                                                            {{ movement.movement_type.upper() }}
                                                        </span>
                                                    </td>
                                                    <td>{{ movement.quantity }}</td>
                                                    <td>{{ movement.reason[:50] + '...' if movement.reason and movement.reason|length > 50 else movement.reason or 'N/A' }}</td>
                                                </tr>
                                                {% else %}
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">No recent movements</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Master Tab -->
                <div class="tab-pane fade" id="products" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-box me-2"></i>Product Master</h5>
                            <button class="btn btn-primary btn-sm" onclick="openAddProductModal()">
                                <i class="fas fa-plus me-1"></i>Add Product
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="productsTable">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>Product Name</th>
                                            <th>Category</th>
                                            <th>Unit</th>
                                            <th>Current Stock</th>
                                            <th>Reorder Level</th>
                                            <th>Status</th>
                                            <th>Location</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsTableBody">
                                        <!-- Products will be loaded via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories Tab -->
                <div class="tab-pane fade" id="categories" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Categories</h5>
                            <button class="btn btn-primary btn-sm" onclick="openAddCategoryModal()">
                                <i class="fas fa-plus me-1"></i>Add Category
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Color</th>
                                            <th>Products Count</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category in categories %}
                                        <tr>
                                            <td>
                                                <span class="badge" style="background-color: {{ category.color_code }};">
                                                    {{ category.name }}
                                                </span>
                                            </td>
                                            <td>{{ category.description or 'No description' }}</td>
                                            <td>
                                                <div class="color-preview" style="background-color: {{ category.color_code }}; width: 20px; height: 20px; border-radius: 3px; display: inline-block;"></div>
                                                {{ category.color_code }}
                                            </td>
                                            <td>{{ category.products|length }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="viewCategory({{ category.id }})" title="View">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary" onclick="editCategory({{ category.id }})" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteCategory({{ category.id }})" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">No categories found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Inventory Items Tab -->
                <div class="tab-pane fade" id="adjustments" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Inventory Adjustments</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInventoryModal">
                            <i class="fas fa-plus"></i> Add Inventory Items
                        </button>
                    </div>

                    <!-- Adjustments Filter Bar -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="adjustments-from-date">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="adjustments-to-date">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Search</label>
                                    <input type="text" class="form-control" id="adjustments-search" placeholder="Search reference ID, remarks, created by">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Page Size</label>
                                    <select class="form-control" id="adjustments-page-size">
                                        <option value="10">10</option>
                                        <option value="25" selected>25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-secondary btn-sm" id="resetAdjustmentsFilters">
                                            <i class="fas fa-undo"></i> Reset
                                        </button>
                                        <div class="dropdown">
                                            <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-download"></i> Export
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" id="exportAdjustmentsFiltered">Export Filtered to Excel</a></li>
                                                <li><a class="dropdown-item" href="#" id="exportAdjustmentsAll">Export All to Excel</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Adjustments Table -->
                    <div class="table-responsive">
                        <table class="table table-striped" id="adjustmentsTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="reference_id">
                                        Reference ID <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-sort="adjustment_date">
                                        Adjustment Date <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-sort="items_count">
                                        Number of Items <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-sort="subtotal">
                                        Subtotal Value <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-sort="total_value">
                                        Total Value <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th>Remarks</th>
                                    <th class="sortable" data-sort="created_by">
                                        Created By <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <!-- Adjustments Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="adjustmentsTableInfo"></div>
                        <nav>
                            <ul class="pagination" id="adjustmentsPagination"></ul>
                        </nav>
                    </div>
                </div>

                <!-- Consumption Records Tab -->
                <div class="tab-pane fade" id="consumption" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Consumption Records</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addConsumptionModal">
                            <i class="fas fa-plus"></i> Add Consumption
                        </button>
                    </div>

                    <!-- Consumption Filter Bar -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <label class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="consumption-from-date">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="consumption-to-date">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Search</label>
                                    <input type="text" class="form-control" id="consumption-search" placeholder="Search product, SKU, reference, notes, issued to">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Page Size</label>
                                    <select class="form-control" id="consumption-page-size">
                                        <option value="10">10</option>
                                        <option value="25" selected>25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-secondary btn-sm" id="resetConsumptionFilters">
                                            <i class="fas fa-undo"></i> Reset
                                        </button>
                                        <div class="dropdown">
                                            <button class="btn btn-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-download"></i> Export
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" id="exportConsumptionFiltered">Export Filtered to Excel</a></li>
                                                <li><a class="dropdown-item" href="#" id="exportConsumptionAll">Export All to Excel</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Consumption Table -->
                    <div class="table-responsive">
                        <table class="table table-striped" id="consumptionTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="consumption_date">
                                        Date <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-sort="product_name">
                                        Product <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="sortable" data-sort="quantity_used">
                                        Qty Used <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th>Unit</th>
                                    <th class="sortable" data-sort="issued_to">
                                        Issued To <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th>Reference ID</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <!-- Consumption Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="consumptionTableInfo"></div>
                        <nav>
                            <ul class="pagination" id="consumptionPagination"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProductForm">
                <div class="modal-body">
                    <input type="hidden" id="editProductId" name="product_id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">SKU <span class="text-danger">*</span></label>
                            <input type="text" id="editSku" name="sku" class="form-control" required readonly>
                            <small class="text-muted">SKU cannot be changed after creation</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Product Name <span class="text-danger">*</span></label>
                            <input type="text" id="editName" name="name" class="form-control" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Category</label>
                            <select id="editCategory" name="category_id" class="form-select">
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unit of Measure <span class="text-danger">*</span></label>
                            <select id="editUnitOfMeasure" name="unit_of_measure" class="form-select" required>
                                <option value="pcs">Pieces</option>
                                <option value="kg">Kilograms</option>
                                <option value="g">Grams</option>
                                <option value="ml">Milliliters</option>
                                <option value="l">Liters</option>
                                <option value="m">Meters</option>
                                <option value="cm">Centimeters</option>
                                <option value="box">Box</option>
                                <option value="bottle">Bottle</option>
                                <option value="tube">Tube</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Current Stock</label>
                            <input type="number" id="editCurrentStock" name="current_stock" class="form-control" step="0.01" readonly>
                            <small class="text-muted">Use inventory adjustments to change stock</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Reorder Level</label>
                            <input type="number" id="editReorderLevel" name="reorder_point" class="form-control" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Min Stock Level</label>
                            <input type="number" id="editMinStock" name="min_stock_level" class="form-control" step="0.01">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Max Stock Level</label>
                            <input type="number" id="editMaxStock" name="max_stock_level" class="form-control" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cost Price</label>
                            <input type="number" id="editCostPrice" name="cost_price" class="form-control" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Selling Price</label>
                            <input type="number" id="editSellingPrice" name="selling_price" class="form-control" step="0.01">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Barcode</label>
                            <input type="text" id="editBarcode" name="barcode" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Storage Location</label>
                            <input type="text" id="editLocation" name="location" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="editDescription" name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editUsedInServices" name="is_service_item">
                                <label class="form-check-label" for="editUsedInServices">
                                    Used in Services
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editRetailItem" name="is_retail_item">
                                <label class="form-check-label" for="editRetailItem">
                                    Retail Item
                                </label>
                            </div>
                        </div>
                    </div>
                    <div id="editProductStatus" class="alert alert-info" style="display: none;">
                        <strong>Current Status:</strong> <span id="editStatusText"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditProduct()">
                        <i class="fas fa-save me-1"></i>Update Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Inventory Items Modal -->
<div class="modal fade" id="addInventoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Inventory Items</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addInventoryForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Add stock for existing products. This will increase current stock levels.
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Date of Adjustment</label>
                            <input type="date" name="adjustment_date" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Reference ID</label>
                            <input type="text" name="reference_no" class="form-control" placeholder="Optional reference">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Remarks</label>
                        <textarea name="notes" class="form-control" rows="2" placeholder="Optional remarks"></textarea>
                    </div>

                    <div class="mb-3">
                        <h6>Items</h6>
                        <div id="inventoryItems">
                            <div class="row mb-2 inventory-item">
                                <div class="col-md-3">
                                    <label class="form-label small">Select Product</label>
                                    <div class="input-group">
                                        <select name="product_id[]" class="form-select product-select" required onchange="updateCurrentStock(this)">
                                            <option value="">Select Product</option>
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="refreshProductsDropdown(this)" title="Refresh Products">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback" style="display: none;">Please select a product</div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Current Stock</label>
                                    <input type="number" name="current_stock[]" class="form-control current-stock" readonly>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Quantity to Add</label>
                                    <input type="number" name="quantity_in[]" class="form-control quantity-in" step="0.01" required onchange="calculateLineTotal(this)">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Unit Cost</label>
                                    <input type="number" name="unit_cost[]" class="form-control unit-cost" step="0.01" onchange="calculateLineTotal(this)">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Line Total</label>
                                    <input type="number" name="line_total[]" class="form-control line-total" readonly>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label small">&nbsp;</label>
                                    <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeInventoryItem(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addInventoryItem()">
                            <i class="fas fa-plus me-1"></i>Add Item
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4">
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Subtotal:</strong></td>
                                    <td class="text-end"><span id="modalSubtotal">$0.00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Tax (if any):</strong></td>
                                    <td class="text-end">
                                        <input type="number" id="modalTax" class="form-control form-control-sm" step="0.01" value="0" onchange="calculateGrandTotal()">
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Total Value:</strong></td>
                                    <td class="text-end"><strong><span id="modalGrandTotal">$0.00</span></strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveInventoryItems()">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Adjustment Modal -->
<div class="modal fade" id="viewAdjustmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">View Inventory Adjustment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Reference ID:</strong> <span id="viewReferenceId"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Adjustment Date:</strong> <span id="viewAdjustmentDate"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Created By:</strong> <span id="viewCreatedBy"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Created Date:</strong> <span id="viewCreatedDate"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Remarks:</strong>
                    <p id="viewRemarks" class="text-muted"></p>
                </div>
                <div class="mb-3">
                    <h6>Items</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity Added</th>
                                    <th>Unit Cost</th>
                                    <th>Line Total</th>
                                </tr>
                            </thead>
                            <tbody id="viewItemsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8"></div>
                    <div class="col-md-4">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Subtotal:</strong></td>
                                <td class="text-end"><span id="viewSubtotal"></span></td>
                            </tr>
                            <tr>
                                <td><strong>Tax:</strong></td>
                                <td class="text-end"><span id="viewTax"></span></td>
                            </tr>
                            <tr>
                                <td><strong>Total Value:</strong></td>
                                <td class="text-end"><strong><span id="viewGrandTotal"></span></strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Adjustment Modal -->
<div class="modal fade" id="editAdjustmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Inventory Adjustment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editAdjustmentForm">
                <input type="hidden" name="adjustment_id" id="editAdjustmentId">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Editing this adjustment will reverse the original stock changes and apply the new ones.
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Date of Adjustment</label>
                            <input type="date" name="adjustment_date" id="editAdjustmentDate" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Reference ID</label>
                            <input type="text" name="reference_no" id="editReferenceNo" class="form-control" placeholder="Optional reference">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Remarks</label>
                        <textarea name="notes" id="editNotes" class="form-control" rows="2" placeholder="Optional remarks"></textarea>
                    </div>

                    <div class="mb-3">
                        <h6>Items</h6>
                        <div id="editInventoryItems">
                            <!-- Items will be loaded dynamically -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addEditInventoryItem()">
                            <i class="fas fa-plus me-1"></i>Add Item
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4">
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Subtotal:</strong></td>
                                    <td class="text-end"><span id="editSubtotal">$0.00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Tax (if any):</strong></td>
                                    <td class="text-end">
                                        <input type="number" id="editTax" class="form-control form-control-sm" step="0.01" value="0" onchange="calculateEditGrandTotal()">
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Total Value:</strong></td>
                                    <td class="text-end"><strong><span id="editGrandTotal">$0.00</span></strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedAdjustment()">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProductForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">SKU <span class="text-danger">*</span></label>
                                <input type="text" name="sku" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Product Name <span class="text-danger">*</span></label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select name="category_id" class="form-select">
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Unit of Measure</label>
                                <input type="text" name="unit_of_measure" class="form-control" value="pcs">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Current Stock (read-only)</label>
                                <input type="number" name="current_stock" class="form-control" value="0" readonly>
                                <small class="text-muted">Use "Add Inventory Items" to add stock</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Reorder Point</label>
                                <input type="number" name="reorder_point" class="form-control" value="20" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Min Stock Level</label>
                                <input type="number" name="min_stock_level" class="form-control" value="10" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Max Stock Level</label>
                                <input type="number" name="max_stock_level" class="form-control" value="100" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cost Price</label>
                                <input type="number" name="cost_price" class="form-control" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Selling Price</label>
                                <input type="number" name="selling_price" class="form-control" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Barcode</label>
                                <input type="text" name="barcode" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Location</label>
                                <input type="text" name="location" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_service_item" id="isServiceItem">
                                <label class="form-check-label" for="isServiceItem">
                                    Used in Services
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_retail_item" id="isRetailItem">
                                <label class="form-check-label" for="isRetailItem">
                                    Retail Item
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="fas fa-save me-1"></i>Add Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCategoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Category Name <span class="text-danger">*</span></label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <input type="color" name="color_code" class="form-control" value="#007bff">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategory()">
                        <i class="fas fa-save me-1"></i>Add Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Consumption Modal -->
<div class="modal fade" id="addConsumptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Consumption Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addConsumptionForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Product <span class="text-danger">*</span></label>
                        <select name="product_id" class="form-select consumption-product-select" required onchange="updateAvailableStock(this)">
                            <option value="">Select Product</option>
                        </select>
                        <div class="invalid-feedback">Please select a product</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Available Stock</label>
                        <input type="text" class="form-control available-stock" readonly placeholder="Select a product first">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Consumption Date <span class="text-danger">*</span></label>
                        <input type="date" name="consumption_date" class="form-control" required>
                        <div class="invalid-feedback">Please select a date (YYYY-MM-DD format)</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity Used <span class="text-danger">*</span></label>
                        <input type="number" name="quantity_used" class="form-control" step="0.01" min="0.01" required>
                        <div class="invalid-feedback">Please enter a valid quantity greater than 0</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Issued To <span class="text-danger">*</span></label>
                        <input type="text" name="issued_to" class="form-control" required placeholder="Department/Person">
                        <div class="invalid-feedback">Please specify who the items were issued to</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reference/Doc No.</label>
                        <input type="text" name="reference_doc_no" class="form-control" placeholder="Optional reference document number">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="2" placeholder="Optional notes about this consumption"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveConsumption()">
                        <i class="fas fa-save me-1"></i>Add Consumption
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<!-- SheetJS for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// Global variables for pagination and sorting
let allConsumptionData = [];
let filteredConsumptionData = [];
let consumptionPageSize = 25;
let consumptionCurrentPage = 1;
let consumptionSortField = 'consumption_date';
let consumptionSortOrder = 'asc';

let allAdjustmentsData = [];
let filteredAdjustmentsData = [];
let adjustmentsPageSize = 25;
let adjustmentsCurrentPage = 1;
let adjustmentsSortField = 'adjustment_date';
let adjustmentsSortOrder = 'asc';

document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded successfully');
    console.log('Dashboard JavaScript loaded and ready');

    // Initialize date ranges and filters
    initializeDateRanges();
    initializeConsumptionFilters();
    initializeAdjustmentsFilters();

    // Load initial data
    loadConsumptionData();
    loadAdjustmentsData();
    loadProducts(); // Load products for product master tab

    // Set up event listeners for filters and sorting
    setupFilterEventListeners();
    setupSortEventListeners();

    // Set up tab change listeners to load data on demand
    setupTabChangeListeners();

    // Set default date to today for input fields that require it
    setDefaultDateValues();
});

function initializeDateRanges() {
    const today = new Date().toISOString().split('T')[0];
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        if (!input.value) {
            input.value = today;
        }
    });
}

function setDefaultDateValues() {
    const today = new Date().toISOString().split('T')[0];
    const adjustmentDateInput = document.querySelector('input[name="adjustment_date"]');
    const consumptionDateInput = document.querySelector('input[name="consumption_date"]');

    if (adjustmentDateInput && !adjustmentDateInput.value) {
        adjustmentDateInput.value = today;
    }
    if (consumptionDateInput && !consumptionDateInput.value) {
        consumptionDateInput.value = today;
    }
}

function initializeConsumptionFilters() {
    document.getElementById('consumption-from-date').value = '';
    document.getElementById('consumption-to-date').value = '';
    document.getElementById('consumption-search').value = '';
    consumptionCurrentPage = 1; // Reset to first page
    consumptionSortField = 'consumption_date';
    consumptionSortOrder = 'asc';
    // Reset sort icons
    $('#consumptionTable .sort-icon').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
}

function initializeAdjustmentsFilters() {
    document.getElementById('adjustments-from-date').value = '';
    document.getElementById('adjustments-to-date').value = '';
    document.getElementById('adjustments-search').value = '';
    adjustmentsCurrentPage = 1; // Reset to first page
    adjustmentsSortField = 'adjustment_date';
    adjustmentsSortOrder = 'asc';
    // Reset sort icons
    $('#adjustmentsTable .sort-icon').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
}

function setupFilterEventListeners() {
    // Consumption filters
    const consumptionFromDate = document.getElementById('consumption-from-date');
    const consumptionToDate = document.getElementById('consumption-to-date');
    const consumptionSearch = document.getElementById('consumption-search');
    const resetConsumptionFiltersBtn = document.getElementById('resetConsumptionFilters');

    if (consumptionFromDate) consumptionFromDate.addEventListener('change', applyConsumptionFilters);
    if (consumptionToDate) consumptionToDate.addEventListener('change', applyConsumptionFilters);
    if (consumptionSearch) consumptionSearch.addEventListener('input', debounce(applyConsumptionFilters, 500));
    if (resetConsumptionFiltersBtn) resetConsumptionFiltersBtn.addEventListener('click', resetAndApplyConsumptionFilters);

    // Adjustments filters
    const adjustmentsFromDate = document.getElementById('adjustments-from-date');
    const adjustmentsToDate = document.getElementById('adjustments-to-date');
    const adjustmentsSearch = document.getElementById('adjustments-search');
    const resetAdjustmentsFiltersBtn = document.getElementById('resetAdjustmentsFilters');

    if (adjustmentsFromDate) adjustmentsFromDate.addEventListener('change', applyAdjustmentsFilters);
    if (adjustmentsToDate) adjustmentsToDate.addEventListener('change', applyAdjustmentsFilters);
    if (adjustmentsSearch) adjustmentsSearch.addEventListener('input', debounce(applyAdjustmentsFilters, 500));
    if (resetAdjustmentsFiltersBtn) resetAdjustmentsFiltersBtn.addEventListener('click', resetAndApplyAdjustmentsFilters);

    // Page size selectors
    const consumptionPageSizeSelect = document.getElementById('consumption-page-size');
    const adjustmentsPageSizeSelect = document.getElementById('adjustments-page-size');

    if (consumptionPageSizeSelect) consumptionPageSizeSelect.addEventListener('change', changeConsumptionPageSize);
    if (adjustmentsPageSizeSelect) adjustmentsPageSizeSelect.addEventListener('change', changeAdjustmentsPageSize);
}

function setupSortEventListeners() {
    // Add click listeners to sortable table headers
    document.querySelectorAll('#consumptionTable .sortable').forEach(header => {
        header.addEventListener('click', () => handleSort(header, 'consumption'));
    });
    document.querySelectorAll('#adjustmentsTable .sortable').forEach(header => {
        header.addEventListener('click', () => handleSort(header, 'adjustments'));
    });
}

function setupTabChangeListeners() {
    // Listen for tab changes to load data only when a tab is shown
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tabButton => {
        tabButton.addEventListener('shown.bs.tab', function (e) {
            const targetTabId = e.target.getAttribute('data-bs-target');
            if (targetTabId === '#products') {
                loadProducts();
            } else if (targetTabId === '#consumption') {
                loadConsumptionData();
            } else if (targetTabId === '#adjustments') {
                loadAdjustmentsData();
            }
        });
    });
}

// Debounce function for search inputs
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Reset and apply filters for consumption
function resetAndApplyConsumptionFilters() {
    initializeConsumptionFilters();
    applyConsumptionFilters();
}

// Reset and apply filters for adjustments
function resetAndApplyAdjustmentsFilters() {
    initializeAdjustmentsFilters();
    applyAdjustmentsFilters();
}

// Change consumption page size
function changeConsumptionPageSize(event) {
    consumptionPageSize = parseInt(event.target.value);
    consumptionCurrentPage = 1; // Reset to first page
    renderConsumptionTable();
    renderConsumptionPagination();
}

// Change adjustments page size
function changeAdjustmentsPageSize(event) {
    adjustmentsPageSize = parseInt(event.target.value);
    adjustmentsCurrentPage = 1; // Reset to first page
    renderAdjustmentsTable();
    renderAdjustmentsPagination();
}

// Handle sorting
function handleSort(header, tableType) {
    const field = header.getAttribute('data-sort');
    let currentField, currentOrder, setField, setOrder;
    let iconElement;

    if (tableType === 'consumption') {
        currentField = consumptionSortField;
        currentOrder = consumptionSortOrder;
        iconElement = header.querySelector('.sort-icon');
    } else { // adjustments
        currentField = adjustmentsSortField;
        currentOrder = adjustmentsSortOrder;
        iconElement = header.querySelector('.sort-icon');
    }

    if (currentField === field) {
        // Toggle order if same field is clicked
        setOrder = currentOrder === 'asc' ? 'desc' : 'asc';
    } else {
        // Reset order to asc if new field is clicked
        setOrder = 'asc';
    }

    setField = field;

    // Update sort order state
    if (tableType === 'consumption') {
        consumptionSortField = setField;
        consumptionSortOrder = setOrder;
    } else {
        adjustmentsSortField = setField;
        adjustmentsSortOrder = setOrder;
    }

    // Update sort icons
    document.querySelectorAll(`#${tableType}Table .sort-icon`).forEach(icon => {
        icon.classList.remove('fa-sort-up', 'fa-sort-down');
        icon.classList.add('fa-sort');
    });
    iconElement.classList.remove('fa-sort');
    iconElement.classList.add(setOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down');

    // Re-apply filters to update sorting
    applyFilters(tableType);
}

// Function to apply filters and re-render the table
function applyFilters(tableType) {
    let data, filterFunc, renderFunc, paginationFunc, sortField, sortOrder;

    if (tableType === 'consumption') {
        data = allConsumptionData;
        filterFunc = applyConsumptionFilters;
        renderFunc = renderConsumptionTable;
        paginationFunc = renderConsumptionPagination;
        sortField = consumptionSortField;
        sortOrder = consumptionSortOrder;
    } else { // adjustments
        data = allAdjustmentsData;
        filterFunc = applyAdjustmentsFilters;
        renderFunc = renderAdjustmentsTable;
        paginationFunc = renderAdjustmentsPagination;
        sortField = adjustmentsSortField;
        sortOrder = adjustmentsSortOrder;
    }

    // Apply filters first
    filterFunc();
    // Then sort the filtered data
    sortData(tableType);
    // Render the sorted and filtered data
    renderFunc();
    // Render pagination
    paginationFunc();
}

// Sort data based on current sort field and order
function sortData(tableType) {
    let dataToSort;
    let sortField;
    let sortOrder;

    if (tableType === 'consumption') {
        dataToSort = filteredConsumptionData;
        sortField = consumptionSortField;
        sortOrder = consumptionSortOrder;
    } else { // adjustments
        dataToSort = filteredAdjustmentsData;
        sortField = adjustmentsSortField;
        sortOrder = adjustmentsSortOrder;
    }

    dataToSort.sort((a, b) => {
        const valA = a[sortField];
        const valB = b[sortField];

        if (valA === null || valA === undefined) return sortOrder === 'asc' ? 1 : -1;
        if (valB === null || valB === undefined) return sortOrder === 'asc' ? -1 : 1;

        if (typeof valA === 'string' && typeof valB === 'string') {
            return sortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        } else {
            return sortOrder === 'asc' ? valA - valB : valB - valA;
        }
    });
}

// Function to apply consumption filters
function applyConsumptionFilters() {
    const fromDate = document.getElementById('consumption-from-date')?.value;
    const toDate = document.getElementById('consumption-to-date')?.value;
    const searchTerm = document.getElementById('consumption-search')?.value.toLowerCase().trim();

    filteredConsumptionData = allConsumptionData.filter(record => {
        const recordDate = new Date(record.consumption_date);
        const matchDateRange = (!fromDate || recordDate >= new Date(fromDate)) &&
                               (!toDate || recordDate <= new Date(toDate));

        const matchSearch = !searchTerm ||
                            (record.product_name && record.product_name.toLowerCase().includes(searchTerm)) ||
                            (record.product_sku && record.product_sku.toLowerCase().includes(searchTerm)) ||
                            (record.issued_to && record.issued_to.toLowerCase().includes(searchTerm)) ||
                            (record.reference_doc_no && record.reference_doc_no.toLowerCase().includes(searchTerm)) ||
                            (record.notes && record.notes.toLowerCase().includes(searchTerm));

        return matchDateRange && matchSearch;
    });

    sortData('consumption'); // Sort after filtering
    renderConsumptionTable();
    renderConsumptionPagination();
}

// Function to render the consumption table
function renderConsumptionTable() {
    const tbody = document.getElementById('consumptionTable').querySelector('tbody');
    tbody.innerHTML = ''; // Clear existing rows

    const startIndex = (consumptionCurrentPage - 1) * consumptionPageSize;
    const endIndex = startIndex + consumptionPageSize;
    const paginatedData = filteredConsumptionData.slice(startIndex, endIndex);

    if (paginatedData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No consumption records found.</td></tr>';
        return;
    }

    paginatedData.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${record.consumption_date || 'N/A'}</td>
            <td>${record.product_name || 'N/A'}</td>
            <td>${record.quantity_used !== undefined ? parseFloat(record.quantity_used).toFixed(2) : '0.00'}</td>
            <td>${record.unit_of_measure || 'pcs'}</td>
            <td>${record.issued_to || 'N/A'}</td>
            <td>${record.reference_doc_no || ''}</td>
            <td>${record.notes ? record.notes.substring(0, 50) + (record.notes.length > 50 ? '...' : '') : ''}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewConsumption(${record.id})" title="View"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-outline-secondary" onclick="editConsumption(${record.id})" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-outline-danger" onclick="deleteConsumption(${record.id})" title="Delete"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Update table info
    const tableInfo = document.getElementById('consumptionTableInfo');
    const totalRecords = filteredConsumptionData.length;
    const displayedCount = paginatedData.length;
    const infoText = `Showing ${startIndex + 1} to ${startIndex + displayedCount} of ${totalRecords} entries`;
    if (tableInfo) tableInfo.textContent = infoText;
}

// Function to render consumption pagination
function renderConsumptionPagination() {
    const paginationContainer = document.getElementById('consumptionPagination');
    paginationContainer.innerHTML = ''; // Clear previous pagination

    const totalPages = Math.ceil(filteredConsumptionData.length / consumptionPageSize);
    const maxPagesToShow = 5; // Number of page buttons to show at once

    if (totalPages <= 1) return; // No pagination needed if only one page

    // Previous button
    const prevButton = document.createElement('li');
    prevButton.classList.add('page-item', consumptionCurrentPage === 1 ? 'disabled' : '');
    prevButton.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
    prevButton.querySelector('a').addEventListener('click', (e) => {
        e.preventDefault();
        if (consumptionCurrentPage > 1) {
            consumptionCurrentPage--;
            renderConsumptionTable();
            renderConsumptionPagination();
        }
    });
    paginationContainer.appendChild(prevButton);

    // Page number buttons
    let startPage = Math.max(1, consumptionCurrentPage - Math.floor(maxPagesToShow / 2));
    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

    if (endPage - startPage + 1 < maxPagesToShow) {
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('li');
        pageButton.classList.add('page-item', i === consumptionCurrentPage ? 'active' : '');
        pageButton.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        pageButton.querySelector('a').addEventListener('click', (e) => {
            e.preventDefault();
            consumptionCurrentPage = i;
            renderConsumptionTable();
            renderConsumptionPagination();
        });
        paginationContainer.appendChild(pageButton);
    }

    // Next button
    const nextButton = document.createElement('li');
    nextButton.classList.add('page-item', consumptionCurrentPage === totalPages ? 'disabled' : '');
    nextButton.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
    nextButton.querySelector('a').addEventListener('click', (e) => {
        e.preventDefault();
        if (consumptionCurrentPage < totalPages) {
            consumptionCurrentPage++;
            renderConsumptionTable();
            renderConsumptionPagination();
        }
    });
    paginationContainer.appendChild(nextButton);
}

// Function to apply adjustments filters
function applyAdjustmentsFilters() {
    const fromDate = document.getElementById('adjustments-from-date')?.value;
    const toDate = document.getElementById('adjustments-to-date')?.value;
    const searchTerm = document.getElementById('adjustments-search')?.value.toLowerCase().trim();

    filteredAdjustmentsData = allAdjustmentsData.filter(record => {
        const recordDate = new Date(record.adjustment_date);
        const matchDateRange = (!fromDate || recordDate >= new Date(fromDate)) &&
                               (!toDate || recordDate <= new Date(toDate));

        const matchSearch = !searchTerm ||
                            (record.reference_id && record.reference_id.toLowerCase().includes(searchTerm)) ||
                            (record.remarks && record.remarks.toLowerCase().includes(searchTerm)) ||
                            (record.created_by && record.created_by.toLowerCase().includes(searchTerm));

        return matchDateRange && matchSearch;
    });

    sortData('adjustments'); // Sort after filtering
    renderAdjustmentsTable();
    renderAdjustmentsPagination();
}

// Function to render the adjustments table
function renderAdjustmentsTable() {
    const tbody = document.getElementById('adjustmentsTable').querySelector('tbody');
    tbody.innerHTML = ''; // Clear existing rows

    const startIndex = (adjustmentsCurrentPage - 1) * adjustmentsPageSize;
    const endIndex = startIndex + adjustmentsPageSize;
    const paginatedData = filteredAdjustmentsData.slice(startIndex, endIndex);

    if (paginatedData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No inventory adjustments found.</td></tr>';
        return;
    }

    paginatedData.forEach(record => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${record.reference_id || 'N/A'}</td>
            <td>${record.adjustment_date || 'N/A'}</td>
            <td>${record.items_count || 0}</td>
            <td>$${parseFloat(record.subtotal || 0).toFixed(2)}</td>
            <td>$${parseFloat(record.total_value || 0).toFixed(2)}</td>
            <td>${record.remarks ? record.remarks.substring(0, 50) + (record.remarks.length > 50 ? '...' : '') : ''}</td>
            <td>${record.created_by || 'N/A'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewAdjustment(${record.id})" title="View"><i class="fas fa-eye"></i></button>
                    <button class="btn btn-outline-secondary" onclick="editAdjustment(${record.id})" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-outline-danger" onclick="deleteAdjustment(${record.id})" title="Delete"><i class="fas fa-trash"></i></button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Update table info
    const tableInfo = document.getElementById('adjustmentsTableInfo');
    const totalRecords = filteredAdjustmentsData.length;
    const displayedCount = paginatedData.length;
    const infoText = `Showing ${startIndex + 1} to ${startIndex + displayedCount} of ${totalRecords} entries`;
    if (tableInfo) tableInfo.textContent = infoText;
}

// Function to render adjustments pagination
function renderAdjustmentsPagination() {
    const paginationContainer = document.getElementById('adjustmentsPagination');
    paginationContainer.innerHTML = ''; // Clear previous pagination

    const totalPages = Math.ceil(filteredAdjustmentsData.length / adjustmentsPageSize);
    const maxPagesToShow = 5; // Number of page buttons to show at once

    if (totalPages <= 1) return; // No pagination needed if only one page

    // Previous button
    const prevButton = document.createElement('li');
    prevButton.classList.add('page-item', adjustmentsCurrentPage === 1 ? 'disabled' : '');
    prevButton.innerHTML = `<a class="page-link" href="#" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>`;
    prevButton.querySelector('a').addEventListener('click', (e) => {
        e.preventDefault();
        if (adjustmentsCurrentPage > 1) {
            adjustmentsCurrentPage--;
            renderAdjustmentsTable();
            renderAdjustmentsPagination();
        }
    });
    paginationContainer.appendChild(prevButton);

    // Page number buttons
    let startPage = Math.max(1, adjustmentsCurrentPage - Math.floor(maxPagesToShow / 2));
    let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

    if (endPage - startPage + 1 < maxPagesToShow) {
        startPage = Math.max(1, endPage - maxPagesToShow + 1);
    }

    for (let i = startPage; i <= endPage; i++) {
        const pageButton = document.createElement('li');
        pageButton.classList.add('page-item', i === adjustmentsCurrentPage ? 'active' : '');
        pageButton.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        pageButton.querySelector('a').addEventListener('click', (e) => {
            e.preventDefault();
            adjustmentsCurrentPage = i;
            renderAdjustmentsTable();
            renderAdjustmentsPagination();
        });
        paginationContainer.appendChild(pageButton);
    }

    // Next button
    const nextButton = document.createElement('li');
    nextButton.classList.add('page-item', adjustmentsCurrentPage === totalPages ? 'disabled' : '');
    nextButton.innerHTML = `<a class="page-link" href="#" aria-label="Next"><span aria-hidden="true">&raquo;</span></a>`;
    nextButton.querySelector('a').addEventListener('click', (e) => {
        e.preventDefault();
        if (adjustmentsCurrentPage < totalPages) {
            adjustmentsCurrentPage++;
            renderAdjustmentsTable();
            renderAdjustmentsPagination();
        }
    });
    paginationContainer.appendChild(nextButton);
}

// Load initial dashboard data (example: statistics)
function loadDashboardData() {
    // This function would typically fetch data for the stats cards
    // For now, we'll assume stats are passed from the backend template
    console.log('Dashboard data loaded (or assumed to be loaded).');
}

// Utility functions for showing toasts
function showToast(message, type = 'info') {
    // Ensure toast container exists
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toastElement = document.createElement('div');
    toastElement.className = `toast align-items-center text-white bg-${type} border-0 show`;
    toastElement.role = 'alert';
    toastElement.ariaLive = 'assertive';
    toastElement.ariaAtomic = 'true';
    toastElement.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    toastContainer.appendChild(toastElement);

    // Bootstrap Toast initialization and show
    const toast = new bootstrap.Toast(toastElement);
    toast.show();

    // Clean up the element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

// --- Product Master Functions ---
function loadProducts() {
    fetch('/api/inventory/products/master')
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch products');
        return response.json();
    })
    .then(products => {
        const tbody = document.getElementById('productsTableBody');
        tbody.innerHTML = ''; // Clear existing rows

        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No products found. Please add products in the "Product Master" tab.</td></tr>';
            return;
        }

        products.forEach(product => {
            const statusBadgeClass = product.stock_status ?
                (product.stock_status === 'low_stock' ? 'warning' :
                 product.stock_status === 'out_of_stock' ? 'danger' : 'success') :
                'secondary';
            const statusText = (product.stock_status || 'in_stock').replace('_', ' ').toUpperCase();

            const row = `
                <tr>
                    <td>${product.sku || 'N/A'}</td>
                    <td>${product.name || 'N/A'}</td>
                    <td><span class="badge" style="background-color: ${product.category_color || '#6c757d'};">${product.category || 'Uncategorized'}</span></td>
                    <td>${product.unit_of_measure || 'pcs'}</td>
                    <td>${product.current_stock !== undefined ? product.current_stock : 0}</td>
                    <td>${product.reorder_point !== undefined ? product.reorder_point : 0}</td>
                    <td><span class="badge bg-${statusBadgeClass}">${statusText}</span></td>
                    <td>${product.location || 'N/A'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewProduct(${product.id})" title="View Product"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-outline-secondary" onclick="editProduct(${product.id})" title="Edit Product"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id})" title="Delete Product"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    })
    .catch(error => {
        console.error('Error loading products:', error);
        showToast(`Error loading products: ${error.message}`, 'error');
        document.getElementById('productsTableBody').innerHTML = '<tr><td colspan="9" class="text-center text-danger">Failed to load products.</td></tr>';
    });
}

function viewProduct(id) {
    fetch(`/api/inventory/product/${id}`)
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(product => {
        document.getElementById('viewProductSKU').textContent = product.sku || 'N/A';
        document.getElementById('viewProductName').textContent = product.name || 'N/A';
        document.getElementById('viewProductDescription').textContent = product.description || 'No description';
        document.getElementById('viewProductCategory').textContent = product.category || 'Uncategorized';
        document.getElementById('viewProductUnit').textContent = product.unit_of_measure || 'pcs';
        document.getElementById('viewProductCurrentStock').textContent = product.current_stock !== undefined ? product.current_stock : 0;
        document.getElementById('viewProductReorderLevel').textContent = product.reorder_point !== undefined ? product.reorder_point : 0;
        document.getElementById('viewProductMinStock').textContent = product.min_stock_level !== undefined ? product.min_stock_level : 0;
        document.getElementById('viewProductMaxStock').textContent = product.max_stock_level !== undefined ? product.max_stock_level : 0;
        document.getElementById('viewProductCostPrice').textContent = `$${(product.cost_price || 0).toFixed(2)}`;
        document.getElementById('viewProductSellingPrice').textContent = `$${(product.selling_price || 0).toFixed(2)}`;
        document.getElementById('viewProductBarcode').textContent = product.barcode || 'N/A';
        document.getElementById('viewProductLocation').textContent = product.location || 'N/A';

        const statusBadgeClass = product.stock_status ?
            (product.stock_status === 'low_stock' ? 'warning' :
             product.stock_status === 'out_of_stock' ? 'danger' : 'success') :
            'secondary';
        const statusText = (product.stock_status || 'in_stock').replace('_', ' ').toUpperCase();
        document.getElementById('viewProductStatus').textContent = statusText;
        document.getElementById('viewProductStatus').className = `mb-0 badge bg-${statusBadgeClass}`; // Update class for styling

        document.getElementById('viewProductServiceItem').textContent = product.is_service_item ? 'Yes' : 'No';
        document.getElementById('viewProductRetailItem').textContent = product.is_retail_item ? 'Yes' : 'No';

        new bootstrap.Modal(document.getElementById('viewProductModal')).show();
    })
    .catch(error => {
        console.error('Error viewing product:', error);
        showToast(`Error viewing product: ${error.message}`, 'error');
    });
}

function editProduct(id) {
    fetch(`/api/inventory/product/${id}`)
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(product => {
        document.getElementById('editProductId').value = product.id;
        document.getElementById('editSku').value = product.sku || '';
        document.getElementById('editName').value = product.name || '';
        document.getElementById('editDescription').value = product.description || '';
        document.getElementById('editCategory').value = product.category_id || '';
        document.getElementById('editUnitOfMeasure').value = product.unit_of_measure || 'pcs';
        document.getElementById('editCurrentStock').value = product.current_stock !== undefined ? product.current_stock : 0;
        document.getElementById('editReorderLevel').value = product.reorder_point !== undefined ? product.reorder_point : 0;
        document.getElementById('editMinStock').value = product.min_stock_level !== undefined ? product.min_stock_level : 0;
        document.getElementById('editMaxStock').value = product.max_stock_level !== undefined ? product.max_stock_level : 0;
        document.getElementById('editCostPrice').value = product.cost_price !== undefined ? product.cost_price : '';
        document.getElementById('editSellingPrice').value = product.selling_price !== undefined ? product.selling_price : '';
        document.getElementById('editBarcode').value = product.barcode || '';
        document.getElementById('editLocation').value = product.location || '';
        document.getElementById('editUsedInServices').checked = product.is_service_item || false;
        document.getElementById('editRetailItem').checked = product.is_retail_item || false;

        const statusTextElement = document.getElementById('editStatusText');
        const statusInfoDiv = document.getElementById('editProductStatus');
        if (product.stock_status) {
            statusTextElement.textContent = product.stock_status.replace('_', ' ').toUpperCase();
            statusInfoDiv.style.display = 'block';
        } else {
            statusInfoDiv.style.display = 'none';
        }

        new bootstrap.Modal(document.getElementById('editProductModal')).show();
    })
    .catch(error => {
        console.error('Error editing product:', error);
        showToast(`Error editing product: ${error.message}`, 'error');
    });
}

function saveEditProduct() {
    const form = document.getElementById('editProductForm');
    const productId = document.getElementById('editProductId').value;
    const formData = new FormData(form);

    const saveButton = form.querySelector('button[onclick="saveEditProduct()"]');
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';

    fetch(`/inventory/products/${productId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
            loadProducts(); // Refresh the product list
        } else {
            throw new Error(data.error || 'Failed to update product');
        }
    })
    .catch(error => {
        console.error('Error saving product edit:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Update Product';
    });
}

function deleteProduct(id) {
    // First, try to get the product name for a more user-friendly confirmation
    fetch(`/api/inventory/product/${id}`)
    .then(response => response.ok ? response.json() : Promise.reject('Failed to fetch product details'))
    .then(product => {
        const productName = product.name || 'this product';
        confirmDeleteProduct(id, productName);
    })
    .catch(error => {
        console.warn('Could not fetch product name, using generic confirmation:', error);
        confirmDeleteProduct(id, 'this product');
    });
}

function confirmDeleteProduct(id, productName) {
    Swal.fire({
        title: 'Delete Product',
        text: `Are you sure you want to delete "${productName}"? This action cannot be undone.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
        focusCancel: true
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/api/inventory/products/${id}/delete`, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast(`Product "${productName}" deleted successfully`, 'success');
                    loadProducts(); // Refresh the list
                } else {
                    throw new Error(data.error || 'Failed to delete product');
                }
            })
            .catch(error => {
                console.error('Error deleting product:', error);
                showToast(`Error deleting product: ${error.message}`, 'error');
            });
        }
    });
}

// --- Category Functions ---
function openAddCategoryModal() {
    new bootstrap.Modal(document.getElementById('addCategoryModal')).show();
}

function saveCategory() {
    const form = document.getElementById('addCategoryForm');
    const formData = new FormData(form);

    const saveButton = form.querySelector('button[onclick="saveCategory()"]');
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';

    fetch('/inventory/categories/add', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
            form.reset();
            location.reload(); // Refresh page to show new category
        } else {
            throw new Error(data.error || 'Failed to add category');
        }
    })
    .catch(error => {
        console.error('Error saving category:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Add Category';
    });
}

function viewCategory(id) {
    fetch(`/api/inventory/categories/${id}`)
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(category => {
        document.getElementById('viewCategoryName').textContent = category.name || 'N/A';
        document.getElementById('viewCategoryDescription').textContent = category.description || 'No description';
        document.getElementById('viewCategoryColor').textContent = category.color_code || '#000000';
        const colorPreview = document.getElementById('viewCategoryColorPreview');
        if(colorPreview) colorPreview.style.backgroundColor = category.color_code || '#000000';
        document.getElementById('viewCategoryProductCount').textContent = category.product_count || 0;
        document.getElementById('viewCategoryStatus').textContent = category.is_active ? 'Active' : 'Inactive';
        document.getElementById('viewCategoryCreatedDate').textContent = category.created_at ? new Date(category.created_at).toLocaleDateString() : 'N/A';

        new bootstrap.Modal(document.getElementById('viewCategoryModal')).show();
    })
    .catch(error => {
        console.error('Error viewing category:', error);
        showToast(`Error viewing category: ${error.message}`, 'error');
    });
}

function editCategory(id) {
    fetch(`/api/inventory/categories/${id}`)
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(category => {
        document.getElementById('editCategoryId').value = category.id;
        document.getElementById('editCategoryName').value = category.name || '';
        document.getElementById('editCategoryDescription').value = category.description || '';
        document.getElementById('editCategoryColor').value = category.color_code || '#007bff';
        document.getElementById('editCategoryActive').checked = category.is_active || false;

        new bootstrap.Modal(document.getElementById('editCategoryModal')).show();
    })
    .catch(error => {
        console.error('Error editing category:', error);
        showToast(`Error editing category: ${error.message}`, 'error');
    });
}

function saveEditCategory() {
    const form = document.getElementById('editCategoryForm');
    const categoryId = document.getElementById('editCategoryId').value;
    const formData = new FormData(form);

    const saveButton = form.querySelector('button[onclick="saveEditCategory()"]');
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';

    fetch(`/api/inventory/categories/${categoryId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
            location.reload(); // Refresh page to show changes
        } else {
            throw new Error(data.error || 'Failed to update category');
        }
    })
    .catch(error => {
        console.error('Error saving category edit:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.innerHTML = 'Save Changes';
    });
}

function deleteCategory(id) {
    // First, get category name for confirmation
    fetch(`/api/inventory/categories/${id}`)
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(category => {
        const categoryName = category.name || 'this category';
        confirmDeleteCategory(id, categoryName);
    })
    .catch(error => {
        console.warn('Could not fetch category name:', error);
        confirmDeleteCategory(id, 'this category');
    });
}

function confirmDeleteCategory(id, categoryName) {
    Swal.fire({
        title: 'Delete Category',
        text: `Are you sure you want to delete "${categoryName}"? This action cannot be undone and may affect associated products.`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc3545',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
        focusCancel: true
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/api/inventory/categories/${id}/delete`, { method: 'DELETE' })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showToast(`Category "${categoryName}" deleted successfully`, 'success');
                    location.reload(); // Refresh page
                } else {
                    throw new Error(data.error || 'Failed to delete category');
                }
            })
            .catch(error => {
                console.error('Error deleting category:', error);
                showToast(`Error deleting category: ${error.message}`, 'error');
            });
        }
    });
}

// --- Consumption Functions ---
function openAddConsumptionModal() {
    // Load products for the dropdown in the modal
    fetch('/api/inventory/products/for-consumption')
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch products for consumption');
        return response.json();
    })
    .then(products => {
        const select = document.querySelector('#addConsumptionModal .consumption-product-select');
        select.innerHTML = '<option value="">Select Product</option>'; // Reset options

        if (products.length === 0) {
            select.add(Object.assign(document.createElement('option'), {
                value: '',
                textContent: 'No products available. Please add products first.',
                disabled: true
            }));
            // Disable the save button if no products are available
            document.querySelector('#addConsumptionModal .btn-primary').disabled = true;
            return;
        }

        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.setAttribute('data-stock', product.current_stock || 0);
            option.setAttribute('data-unit', product.unit_of_measure || 'pcs');
            option.textContent = `${product.name} (${product.sku}) - Available: ${product.current_stock || 0} ${product.unit_of_measure || 'pcs'}`;
            select.appendChild(option);
        });
        // Re-enable the save button
        document.querySelector('#addConsumptionModal .btn-primary').disabled = false;
        new bootstrap.Modal(document.getElementById('addConsumptionModal')).show();
    })
    .catch(error => {
        console.error('Error opening add consumption modal:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

function updateAvailableStock(selectElement) {
    const selectedOption = selectElement.selectedOptions[0];
    const availableStockInput = selectElement.closest('.modal-body').querySelector('.available-stock');

    if (selectedOption && selectedOption.value) {
        const stock = selectedOption.dataset.stock || '0';
        const unit = selectedOption.dataset.unit || 'pcs';
        availableStockInput.value = `${parseFloat(stock).toFixed(2)} ${unit}`;

        // Clear validation error if present
        selectElement.classList.remove('is-invalid');
    } else {
        availableStockInput.value = ''; // Clear if no product selected
    }
}

function validateConsumptionForm(form) {
    let isValid = true;
    const requiredInputs = form.querySelectorAll('[required]');

    requiredInputs.forEach(input => {
        if (!input.value.trim()) {
            input.classList.add('is-invalid');
            isValid = false;
        } else {
            input.classList.remove('is-invalid');
        }
    });

    // Specific validation for quantity used
    const quantityInput = form.querySelector('input[name="quantity_used"]');
    if (quantityInput && quantityInput.value) {
        const quantity = parseFloat(quantityInput.value);
        if (isNaN(quantity) || quantity <= 0) {
            quantityInput.classList.add('is-invalid');
            isValid = false;
        } else {
            // Check if quantity exceeds available stock
            const productSelect = form.querySelector('select[name="product_id"]');
            const selectedOption = productSelect.selectedOptions[0];
            if (selectedOption && selectedOption.value) {
                const availableStock = parseFloat(selectedOption.dataset.stock || 0);
                if (quantity > availableStock) {
                    quantityInput.classList.add('is-invalid');
                    showToast(`Quantity (${quantity}) exceeds available stock (${availableStock}).`, 'error');
                    isValid = false;
                }
            }
        }
    }

    return isValid;
}

function saveConsumption() {
    const form = document.getElementById('addConsumptionForm');
    if (!validateConsumptionForm(form)) {
        return;
    }

    const formData = new FormData(form);

    // Ensure date is in YYYY-MM-DD format
    const dateInput = form.querySelector('input[name="consumption_date"]');
    if (dateInput && dateInput.value) {
        const date = new Date(dateInput.value);
        if (!isNaN(date.getTime())) {
            formData.set('consumption_date', date.toISOString().slice(0, 10));
        } else {
            showToast('Invalid date selected.', 'error');
            dateInput.classList.add('is-invalid');
            return;
        }
    } else {
        showToast('Consumption date is required.', 'error');
        if(dateInput) dateInput.classList.add('is-invalid');
        return;
    }

    const saveButton = form.querySelector('button[onclick="saveConsumption()"]');
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

    fetch('/api/inventory/consumption/add', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Consumption record added successfully.', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addConsumptionModal')).hide();
            form.reset();
            // Refresh data after a short delay to allow modal to close smoothly
            setTimeout(() => {
                loadConsumptionData();
                loadProducts(); // Update product stock levels
            }, 500);
        } else {
            throw new Error(data.error || 'Failed to add consumption record');
        }
    })
    .catch(error => {
        console.error('Error saving consumption:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Add Consumption';
    });
}

function viewConsumption(id) {
    fetch(`/api/inventory/consumption/${id}`)
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(consumption => {
        document.getElementById('viewConsumptionDate').textContent = consumption.consumption_date || 'N/A';
        document.getElementById('viewConsumptionProduct').textContent = consumption.product_name || 'N/A';
        document.getElementById('viewConsumptionSKU').textContent = consumption.product_sku || 'N/A';
        document.getElementById('viewConsumptionQuantity').textContent = consumption.quantity_used !== undefined ? parseFloat(consumption.quantity_used).toFixed(2) : '0.00';
        document.getElementById('viewConsumptionUnit').textContent = consumption.unit_of_measure || 'pcs';
        document.getElementById('viewConsumptionIssuedTo').textContent = consumption.issued_to || 'N/A';
        document.getElementById('viewConsumptionReference').textContent = consumption.reference_doc_no || '';
        document.getElementById('viewConsumptionNotes').textContent = consumption.notes || '';
        document.getElementById('viewConsumptionCreatedBy').textContent = consumption.created_by || '';
        document.getElementById('viewConsumptionCreatedDate').textContent = consumption.created_at ? new Date(consumption.created_at).toLocaleString() : '';

        new bootstrap.Modal(document.getElementById('viewConsumptionModal')).show();
    })
    .catch(error => {
        console.error('Error viewing consumption:', error);
        showToast(`Error viewing consumption: ${error.message}`, 'error');
    });
}

function editConsumption(id) {
    // Fetch both consumption details and available products
    Promise.all([
        fetch(`/api/inventory/consumption/${id}`),
        fetch('/api/inventory/products/for-consumption')
    ])
    .then(responses => Promise.all(responses.map(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
    })))
    .then(([consumption, products]) => {
        const select = document.getElementById('editConsumptionProduct');
        select.innerHTML = '<option value="">Select Product</option>'; // Reset options

        if (products.length === 0) {
            select.add(Object.assign(document.createElement('option'), {
                value: '', textContent: 'No products available.', disabled: true
            }));
        } else {
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.setAttribute('data-stock', product.current_stock || 0);
                option.setAttribute('data-unit', product.unit_of_measure || 'pcs');
                option.textContent = `${product.name} (${product.sku}) - Available: ${product.current_stock || 0} ${product.unit_of_measure || 'pcs'}`;
                if (product.id == consumption.product_id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        document.getElementById('editConsumptionId').value = consumption.id;
        document.getElementById('editOriginalQuantity').value = consumption.quantity_used; // Store original for calculation if needed
        document.getElementById('editConsumptionDate').value = consumption.consumption_date || '';
        document.getElementById('editConsumptionQuantity').value = consumption.quantity_used !== undefined ? consumption.quantity_used : '';
        document.getElementById('editConsumptionIssuedTo').value = consumption.issued_to || '';
        document.getElementById('editConsumptionReference').value = consumption.reference_doc_no || '';
        document.getElementById('editConsumptionNotes').value = consumption.notes || '';

        // Update the available stock display based on the pre-selected product
        updateEditAvailableStock(select);

        new bootstrap.Modal(document.getElementById('editConsumptionModal')).show();
    })
    .catch(error => {
        console.error('Error editing consumption:', error);
        showToast(`Error editing consumption: ${error.message}`, 'error');
    });
}

function updateEditAvailableStock(selectElement) {
    const selectedOption = selectElement.selectedOptions[0];
    const availableStockInput = document.getElementById('editAvailableStock');

    if (selectedOption && selectedOption.value) {
        const stock = selectedOption.dataset.stock || '0';
        const unit = selectedOption.dataset.unit || 'pcs';
        availableStockInput.value = `${parseFloat(stock).toFixed(2)} ${unit}`;
        selectElement.classList.remove('is-invalid'); // Clear validation
    } else {
        availableStockInput.value = '';
    }
}

function saveEditConsumption() {
    const form = document.getElementById('editConsumptionForm');
    if (!validateConsumptionForm(form)) { // Reuse validation logic
        return;
    }

    const consumptionId = document.getElementById('editConsumptionId').value;
    const formData = new FormData(form);

    // Ensure date is in YYYY-MM-DD format
    const dateInput = form.querySelector('input[name="consumption_date"]');
    if (dateInput && dateInput.value) {
        const date = new Date(dateInput.value);
        if (!isNaN(date.getTime())) {
            formData.set('consumption_date', date.toISOString().slice(0, 10));
        } else {
            showToast('Invalid date selected.', 'error');
            dateInput.classList.add('is-invalid');
            return;
        }
    } else {
        showToast('Consumption date is required.', 'error');
        if(dateInput) dateInput.classList.add('is-invalid');
        return;
    }

    const saveButton = form.querySelector('button[onclick="saveEditConsumption()"]');
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';

    fetch(`/api/inventory/consumption/${consumptionId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Consumption record updated successfully.', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editConsumptionModal')).hide();
            setTimeout(() => {
                loadConsumptionData(); // Refresh table
                loadProducts(); // Update product stock levels
            }, 500);
        } else {
            throw new Error(data.error || 'Failed to update consumption record');
        }
    })
    .catch(error => {
        console.error('Error saving consumption edit:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Save Changes';
    });
}

function deleteConsumption(id) {
    // Fetch consumption details to display in confirmation
    fetch(`/api/inventory/consumption/${id}`)
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(consumption => {
        const productName = consumption.product_name || 'Unknown Product';
        const quantity = consumption.quantity_used || 0;
        const unit = consumption.unit_of_measure || 'pcs';
        const date = consumption.consumption_date || 'Unknown Date';

        Swal.fire({
            title: 'Delete Consumption Record',
            html: `Are you sure you want to delete this consumption record?<br><br>
                   <strong>Product:</strong> ${productName}<br>
                   <strong>Quantity:</strong> ${quantity} ${unit}<br>
                   <strong>Date:</strong> ${date}<br><br>
                   <em>This action will restore ${quantity} ${unit} to the product's stock.</em>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete and restore stock!',
            cancelButtonText: 'Cancel',
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/inventory/consumption/${id}/delete`, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showToast(data.message || 'Consumption record deleted and stock restored.', 'success');
                        setTimeout(() => {
                            loadConsumptionData(); // Refresh table
                            loadProducts(); // Update product stock levels
                        }, 500);
                    } else {
                        throw new Error(data.error || 'Failed to delete consumption record');
                    }
                })
                .catch(error => {
                    console.error('Error deleting consumption:', error);
                    showToast(`Error deleting consumption: ${error.message}`, 'error');
                });
            }
        });
    })
    .catch(error => {
        console.error('Error fetching consumption details for deletion:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

// --- Adjustment Functions ---
function loadAdjustmentsData() {
    fetch('/api/inventory/adjustments')
    .then(response => {
        if (!response.ok) throw new Error('Failed to fetch adjustments');
        return response.json();
    })
    .then(data => {
        if (data.records) {
            allAdjustmentsData = data.records;
            applyAdjustmentsFilters(); // Apply filters and render
        } else {
            throw new Error('Invalid data format received for adjustments');
        }
    })
    .catch(error => {
        console.error('Error loading adjustments data:', error);
        showToast(`Error loading adjustments: ${error.message}`, 'error');
        document.getElementById('adjustmentsTable').querySelector('tbody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load adjustments.</td></tr>';
    });
}

function viewAdjustment(id) {
    fetch(`/api/inventory/adjustments/${id}`)
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(adjustment => {
        document.getElementById('viewReferenceId').textContent = adjustment.reference_id || 'N/A';
        document.getElementById('viewAdjustmentDate').textContent = adjustment.adjustment_date || 'N/A';
        document.getElementById('viewCreatedBy').textContent = adjustment.created_by || '';
        document.getElementById('viewCreatedDate').textContent = adjustment.created_date ? new Date(adjustment.created_date).toLocaleString() : '';
        document.getElementById('viewRemarks').textContent = adjustment.remarks || 'No remarks';

        const tbody = document.getElementById('viewItemsTableBody');
        tbody.innerHTML = ''; // Clear previous rows
        let subtotal = 0;
        adjustment.items.forEach(item => {
            const lineTotal = item.quantity_added * item.unit_cost;
            subtotal += lineTotal;
            tbody.innerHTML += `
                <tr>
                    <td>${item.product_name || 'N/A'}</td>
                    <td>${item.quantity_added !== undefined ? parseFloat(item.quantity_added).toFixed(2) : '0.00'}</td>
                    <td>$${item.unit_cost !== undefined ? parseFloat(item.unit_cost).toFixed(2) : '0.00'}</td>
                    <td>$${lineTotal.toFixed(2)}</td>
                </tr>
            `;
        });

        document.getElementById('viewSubtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('viewTax').textContent = `$${adjustment.tax !== undefined ? parseFloat(adjustment.tax).toFixed(2) : '0.00'}`;
        document.getElementById('viewGrandTotal').textContent = `$${adjustment.total_value !== undefined ? parseFloat(adjustment.total_value).toFixed(2) : '0.00'}`;

        new bootstrap.Modal(document.getElementById('viewAdjustmentModal')).show();
    })
    .catch(error => {
        console.error('Error viewing adjustment:', error);
        showToast(`Error viewing adjustment: ${error.message}`, 'error');
    });
}

function editAdjustment(id) {
    fetch(`/api/inventory/adjustments/${id}`)
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(adjustment => {
        document.getElementById('editAdjustmentId').value = adjustment.id;
        document.getElementById('editAdjustmentDate').value = adjustment.adjustment_date || '';
        document.getElementById('editReferenceNo').value = adjustment.reference_id || '';
        document.getElementById('editNotes').value = adjustment.remarks || '';
        document.getElementById('editTax').value = adjustment.tax !== undefined ? adjustment.tax : 0;

        loadEditAdjustmentItems(adjustment.items); // Function to load items into the edit modal

        new bootstrap.Modal(document.getElementById('editAdjustmentModal')).show();
    })
    .catch(error => {
        console.error('Error editing adjustment:', error);
        showToast(`Error editing adjustment: ${error.message}`, 'error');
    });
}

function loadEditAdjustmentItems(items) {
    const container = document.getElementById('editInventoryItems');
    container.innerHTML = ''; // Clear existing items

    if (!items || items.length === 0) {
        // Add a single empty row if no items were loaded
        addEditInventoryItem();
        return;
    }

    items.forEach(item => {
        const newItemRow = createInventoryItemRow(); // Use helper to create row HTML
        container.appendChild(newItemRow);

        const productSelect = newItemRow.querySelector('.product-select');
        const quantityInput = newItemRow.querySelector('.quantity-in');
        const unitCostInput = newItemRow.querySelector('.unit-cost');
        const lineTotalInput = newItemRow.querySelector('.line-total');
        const currentStockInput = newItemRow.querySelector('.current-stock');

        // Populate product dropdown and pre-select the item's product
        loadProductsForEditAdjustment(productSelect, item.product_id);

        // Fill in item details
        quantityInput.value = item.quantity_added !== undefined ? item.quantity_added : '';
        unitCostInput.value = item.unit_cost !== undefined ? parseFloat(item.unit_cost).toFixed(2) : '';
        lineTotalInput.value = item.line_total !== undefined ? parseFloat(item.line_total).toFixed(2) : '';
        currentStockInput.value = item.current_stock !== undefined ? parseFloat(item.current_stock).toFixed(2) : '0.00';

        // Set data attributes for the selected product option if available
        const productOption = Array.from(productSelect.options).find(opt => opt.value == item.product_id);
        if (productOption) {
            productOption.setAttribute('data-stock', item.current_stock || 0);
            productOption.setAttribute('data-cost', item.unit_cost || 0);
        }
    });

    calculateEditSubtotal(); // Recalculate totals after loading all items
}

function createInventoryItemRow() {
    const newItemRow = document.createElement('div');
    newItemRow.classList.add('row', 'mb-2', 'inventory-item');
    newItemRow.innerHTML = `
        <div class="col-md-3">
            <label class="form-label small">Select Product</label>
            <div class="input-group">
                <select name="product_id[]" class="form-select product-select" required onchange="updateCurrentStock(this)">
                    <option value="">Select Product</option>
                </select>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="refreshProductsDropdown(this)" title="Refresh Products">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div class="invalid-feedback" style="display: none;">Please select a product</div>
        </div>
        <div class="col-md-2">
            <label class="form-label small">Current Stock</label>
            <input type="number" name="current_stock[]" class="form-control current-stock" readonly>
        </div>
        <div class="col-md-2">
            <label class="form-label small">Quantity to Add</label>
            <input type="number" name="quantity_in[]" class="form-control quantity-in" step="0.01" required onchange="calculateEditLineTotal(this)">
        </div>
        <div class="col-md-2">
            <label class="form-label small">Unit Cost</label>
            <input type="number" name="unit_cost[]" class="form-control unit-cost" step="0.01" onchange="calculateEditLineTotal(this)">
        </div>
        <div class="col-md-2">
            <label class="form-label small">Line Total</label>
            <input type="number" name="line_total[]" class="form-control line-total" readonly>
        </div>
        <div class="col-md-1">
            <label class="form-label small">&nbsp;</label>
            <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeEditInventoryItem(this)">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    return newItemRow;
}

function addEditInventoryItem() {
    const container = document.getElementById('editInventoryItems');
    const newItemRow = createInventoryItemRow();
    container.appendChild(newItemRow);
    // Load products for the newly added dropdown
    loadProductsForEditAdjustment(newItemRow.querySelector('.product-select'));
}

function loadProductsForEditAdjustment(selectElement, preselectedValue = '') {
    const cachedProducts = localStorage.getItem('inventory.products');
    let productsPromise;

    if (cachedProducts) {
        try {
            const products = JSON.parse(cachedProducts);
            productsPromise = Promise.resolve(products);
        } catch (e) {
            console.warn('Could not parse cached products, fetching fresh data.', e);
            productsPromise = fetchProductsFromAPI();
        }
    } else {
        productsPromise = fetchProductsFromAPI();
    }

    productsPromise.then(products => {
        populateProductDropdown(selectElement, products, preselectedValue);
    }).catch(error => {
        console.error('Error loading products for edit:', error);
        showToast(`Error loading products: ${error.message}`, 'error');
    });
}

function removeEditInventoryItem(button) {
    const items = document.querySelectorAll('#editInventoryItems .inventory-item');
    if (items.length > 1) {
        button.closest('.inventory-item').remove();
        calculateEditSubtotal(); // Recalculate totals
    } else {
        // Clear the last item's fields instead of removing the row
        const itemRow = button.closest('.inventory-item');
        itemRow.querySelector('.product-select').value = '';
        itemRow.querySelector('.current-stock').value = '0.00';
        itemRow.querySelector('.quantity-in').value = '';
        itemRow.querySelector('.unit-cost').value = '0.00';
        itemRow.querySelector('.line-total').value = '0.00';
        calculateEditSubtotal();
    }
}

function calculateEditLineTotal(element) {
    const row = element.closest('.inventory-item');
    const quantityInput = row.querySelector('.quantity-in');
    const unitCostInput = row.querySelector('.unit-cost');
    const lineTotalInput = row.querySelector('.line-total');

    const quantity = parseFloat(quantityInput.value) || 0;
    const unitCost = parseFloat(unitCostInput.value) || 0;
    const lineTotal = quantity * unitCost;

    lineTotalInput.value = lineTotal.toFixed(2);
    calculateEditSubtotal();
}

function calculateEditSubtotal() {
    let subtotal = 0;
    document.querySelectorAll('#editInventoryItems .line-total').forEach(input => {
        subtotal += parseFloat(input.value) || 0;
    });

    document.getElementById('editSubtotal').textContent = `$${subtotal.toFixed(2)}`;
    calculateEditGrandTotal(); // Recalculate grand total as well
}

function calculateEditGrandTotal() {
    const subtotal = parseFloat(document.getElementById('editSubtotal').textContent.replace('$', '')) || 0;
    const tax = parseFloat(document.getElementById('editTax').value) || 0;
    const grandTotal = subtotal + tax;

    document.getElementById('editGrandTotal').textContent = `$${grandTotal.toFixed(2)}`;
}

function saveEditedAdjustment() {
    const form = document.getElementById('editAdjustmentForm');
    const adjustmentId = document.getElementById('editAdjustmentId').value;

    if (!adjustmentId) {
        showToast('Error: Adjustment ID not found.', 'error');
        return;
    }

    // Validate all items before submitting
    let allItemsValid = true;
    const itemRows = document.querySelectorAll('#editInventoryItems .inventory-item');
    itemRows.forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const quantityInput = row.querySelector('.quantity-in');

        if (!productSelect || !productSelect.value) {
            productSelect.classList.add('is-invalid');
            allItemsValid = false;
        }
        if (!quantityInput || !quantityInput.value || parseFloat(quantityInput.value) <= 0) {
            quantityInput.classList.add('is-invalid');
            allItemsValid = false;
        }
    });

    if (!allItemsValid) {
        showToast('Please correct the errors in the item list.', 'error');
        return;
    }

    // Collect item data
    const items = [];
    const productSelects = document.querySelectorAll('#editInventoryItems .product-select');
    const quantityInputs = document.querySelectorAll('#editInventoryItems .quantity-in');
    const unitCostInputs = document.querySelectorAll('#editInventoryItems .unit-cost');

    for (let i = 0; i < productSelects.length; i++) {
        const productId = productSelects[i].value;
        const quantity = parseFloat(quantityInputs[i].value);
        const unitCost = parseFloat(unitCostInputs[i].value);

        if (productId && !isNaN(quantity) && quantity > 0) {
            items.push({
                product_id: parseInt(productId),
                quantity_added: quantity,
                unit_cost: isNaN(unitCost) ? 0 : unitCost
            });
        }
    }

    if (items.length === 0) {
        showToast('Please add at least one valid item to the adjustment.', 'error');
        return;
    }

    const adjustmentDate = document.getElementById('editAdjustmentDate').value;
    const referenceNo = document.getElementById('editReferenceNo').value || '';
    const notes = document.getElementById('editNotes').value || '';
    const tax = parseFloat(document.getElementById('editTax').value) || 0;

    const data = {
        adjustment_date: adjustmentDate,
        reference_id: referenceNo,
        remarks: notes,
        tax: tax,
        items: items
    };

    const saveButton = form.querySelector('button[onclick="saveEditedAdjustment()"]');
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';

    fetch(`/api/inventory/adjustments/${adjustmentId}/edit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Adjustment updated successfully.', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editAdjustmentModal')).hide();
            setTimeout(() => {
                loadAdjustmentsData(); // Refresh adjustments list
                loadProducts(); // Refresh product stock levels
            }, 500);
        } else {
            throw new Error(data.error || 'Failed to update adjustment');
        }
    })
    .catch(error => {
        console.error('Error saving edited adjustment:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Save Changes';
    });
}

function deleteAdjustment(id) {
    // Fetch adjustment details for confirmation
    fetch(`/api/inventory/adjustments/${id}`)
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(adjustment => {
        const refId = adjustment.reference_id || 'this adjustment';
        Swal.fire({
            title: 'Delete Inventory Adjustment',
            html: `Are you sure you want to delete adjustment<strong> "${refId}"</strong>?<br>
                   This action cannot be undone and will reverse the stock changes associated with it.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/inventory/adjustments/${id}/delete`, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showToast(data.message || 'Adjustment deleted successfully.', 'success');
                        loadAdjustmentsData(); // Refresh table
                        loadProducts(); // Refresh product stock levels
                    } else {
                        throw new Error(data.error || 'Failed to delete adjustment');
                    }
                })
                .catch(error => {
                    console.error('Error deleting adjustment:', error);
                    showToast(`Error deleting adjustment: ${error.message}`, 'error');
                });
            }
        });
    })
    .catch(error => {
        console.error('Error fetching adjustment details for deletion:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}


// --- Excel Export Functions ---
function exportToExcel(data, filename, columns) {
    const wb = XLSX.utils.book_new();
    const wsData = [columns.map(col => col.header)]; // Header row

    data.forEach(row => {
        const rowData = columns.map(col => {
            let value = row[col.key];
            // Basic formatting for currency and dates
            if (col.format === 'currency') {
                return parseFloat(value || 0).toFixed(2);
            } else if (col.format === 'date') {
                return value ? new Date(value).toISOString().slice(0, 10) : '';
            }
            return value === undefined || value === null ? '' : value;
        });
        wsData.push(rowData);
    });

    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // Auto-size columns (optional, but good for readability)
    const colWidths = [];
    for (let C = 0; C < columns.length; C++) {
        let maxWidth = columns[C].header.length;
        for (let R = 0; R < data.length; R++) {
            const cellValue = wsData[R+1] ? wsData[R+1][C] : ''; // +1 because wsData[0] is header
            if (cellValue !== undefined && cellValue !== null) {
                maxWidth = Math.max(maxWidth, cellValue.toString().length);
            }
        }
        colWidths.push({ wch: Math.min(maxWidth + 2, 50) }); // Limit width to 50 characters
    }
    ws['!cols'] = colWidths;

    XLSX.utils.book_append_sheet(wb, ws, 'Data');
    XLSX.writeFile(wb, filename);
}

function exportConsumptionFiltered() {
    if (filteredConsumptionData.length === 0) {
        showToast('No consumption data to export.', 'warning');
        return;
    }
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[-T:]/g, '');
    const columns = [
        {header: 'Date', key: 'consumption_date', format: 'date'},
        {header: 'Product', key: 'product_name'},
        {header: 'SKU', key: 'product_sku'},
        {header: 'Qty Used', key: 'quantity_used'},
        {header: 'Unit', key: 'unit_of_measure'},
        {header: 'Issued To', key: 'issued_to'},
        {header: 'Reference ID', key: 'reference_doc_no'},
        {header: 'Notes', key: 'notes'},
        {header: 'Created By', key: 'created_by'}
    ];
    exportToExcel(filteredConsumptionData, `consumption_report_${timestamp}.xlsx`, columns);
    showToast(`Exported ${filteredConsumptionData.length} consumption records to Excel.`, 'success');
}

function exportConsumptionAll() {
    if (allConsumptionData.length === 0) {
        showToast('No consumption data to export.', 'warning');
        return;
    }
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[-T:]/g, '');
    const columns = [
        {header: 'Date', key: 'consumption_date', format: 'date'},
        {header: 'Product', key: 'product_name'},
        {header: 'SKU', key: 'product_sku'},
        {header: 'Qty Used', key: 'quantity_used'},
        {header: 'Unit', key: 'unit_of_measure'},
        {header: 'Issued To', key: 'issued_to'},
        {header: 'Reference ID', key: 'reference_doc_no'},
        {header: 'Notes', key: 'notes'},
        {header: 'Created By', key: 'created_by'}
    ];
    exportToExcel(allConsumptionData, `consumption_report_${timestamp}.xlsx`, columns);
    showToast(`Exported ${allConsumptionData.length} consumption records to Excel.`, 'success');
}

function exportAdjustmentsFiltered() {
    if (filteredAdjustmentsData.length === 0) {
        showToast('No adjustments data to export.', 'warning');
        return;
    }
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[-T:]/g, '');
    const columns = [
        {header: 'Reference ID', key: 'reference_id'},
        {header: 'Adjustment Date', key: 'adjustment_date', format: 'date'},
        {header: 'Number of Items', key: 'items_count'},
        {header: 'Subtotal Value', key: 'subtotal', format: 'currency'},
        {header: 'Total Value', key: 'total_value', format: 'currency'},
        {header: 'Remarks', key: 'remarks'},
        {header: 'Created By', key: 'created_by'}
    ];
    exportToExcel(filteredAdjustmentsData, `inventory_adjustments_${timestamp}.xlsx`, columns);
    showToast(`Exported ${filteredAdjustmentsData.length} adjustment records to Excel.`, 'success');
}

function exportAdjustmentsAll() {
    if (allAdjustmentsData.length === 0) {
        showToast('No adjustments data to export.', 'warning');
        return;
    }
    const timestamp = new Date().toISOString().slice(0, 19).replace(/[-T:]/g, '');
    const columns = [
        {header: 'Reference ID', key: 'reference_id'},
        {header: 'Adjustment Date', key: 'adjustment_date', format: 'date'},
        {header: 'Number of Items', key: 'items_count'},
        {header: 'Subtotal Value', key: 'subtotal', format: 'currency'},
        {header: 'Total Value', key: 'total_value', format: 'currency'},
        {header: 'Remarks', key: 'remarks'},
        {header: 'Created By', key: 'created_by'}
    ];
    exportToExcel(allAdjustmentsData, `inventory_adjustments_${timestamp}.xlsx`, columns);
    showToast(`Exported ${allAdjustmentsData.length} adjustment records to Excel.`, 'success');
}

// --- Helper Functions ---

// Populate product dropdown (used in modals for adding/editing items)
function populateProductDropdown(selectElement, products, preselectedValue = '') {
    selectElement.innerHTML = '<option value="">Select Product</option>'; // Clear existing and add default

    if (!products || products.length === 0) {
        selectElement.add(Object.assign(document.createElement('option'), {
            value: '', textContent: 'No products available.', disabled: true
        }));
        return;
    }

    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id || '';
        option.setAttribute('data-stock', product.current_stock || 0);
        option.setAttribute('data-unit', product.unit_of_measure || 'pcs');
        option.setAttribute('data-cost', product.cost_price || 0); // Assuming cost_price is available

        const currentStock = product.current_stock || 0;
        const unit = product.unit_of_measure || 'pcs';
        const sku = product.sku || 'N/A';
        const name = product.name || 'Unnamed Product';

        option.textContent = `${name} (${sku}) - Current: ${currentStock} ${unit}`;
        selectElement.appendChild(option);
    });

    // Set pre-selected value if provided (used for editing)
    if (preselectedValue) {
        selectElement.value = preselectedValue;
        // Trigger change event to update dependent fields (like current stock)
        const event = new Event('change');
        selectElement.dispatchEvent(event);
    }

    // Add search functionality if the list is large
    if (products.length > 20) {
        addSearchableFeature(selectElement);
    }
}

// Make a select dropdown searchable
function addSearchableFeature(selectElement) {
    const container = selectElement.closest('.input-group') || selectElement.parentElement;

    // Prevent adding multiple search inputs if it already exists
    if (container.querySelector('.product-search')) {
        return;
    }

    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control form-control-sm product-search mb-1'; // Adjust styling as needed
    searchInput.placeholder = 'Type to search products...';

    // Store original options to restore when search term is cleared
    const originalOptions = Array.from(selectElement.options).slice(1); // Exclude the default "Select Product" option

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        selectElement.innerHTML = '<option value="">Select Product</option>'; // Reset options

        originalOptions.forEach(option => {
            if (option.textContent.toLowerCase().includes(searchTerm)) {
                selectElement.appendChild(option.cloneNode(true)); // Append a copy of the option
            }
        });
    });

    container.insertBefore(searchInput, selectElement);
}

// Refresh product list in dropdowns (used when adding new items or editing)
function refreshProductsDropdown(refreshButton) {
    const originalContent = refreshButton.innerHTML;
    refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    refreshButton.disabled = true;

    // Clear localStorage cache for products
    localStorage.removeItem('inventory.products');

    // Fetch fresh data from API
    fetchProductsFromAPI()
    .then(products => {
        // Update all product dropdowns
        document.querySelectorAll('.product-select').forEach(select => {
            populateProductDropdown(select, products, select.value); // Keep current selection if possible
        });
        showToast('Products refreshed successfully', 'success');
    })
    .catch(error => {
        console.error('Error refreshing products:', error);
        showToast(`Error refreshing products: ${error.message}`, 'error');
    })
    .finally(() => {
        refreshButton.innerHTML = originalContent;
        refreshButton.disabled = false;
    });
}

// Fetch products from API and cache them in localStorage
function fetchProductsFromAPI() {
    return fetch('/api/inventory/products/master')
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(products => {
        try {
            localStorage.setItem('inventory.products', JSON.stringify(products));
        } catch (e) {
            console.warn('Could not cache products in localStorage:', e);
        }
        return products;
    });
}

// Handle adding a new item row to the inventory adjustment form
function addInventoryItem() {
    const container = document.getElementById('inventoryItems');
    const newItemRow = createInventoryItemRow(); // Use the same helper function
    container.appendChild(newItemRow);
    // Load products for the new dropdown
    loadProductsForEditAdjustment(newItemRow.querySelector('.product-select'));
}

// Update current stock and line total when product or quantity changes
function updateCurrentStock(selectElement) {
    const row = selectElement.closest('.inventory-item');
    const selectedOption = selectElement.selectedOptions[0];
    const currentStockInput = row.querySelector('.current-stock');
    const unitCostInput = row.querySelector('.unit-cost');
    const quantityInput = row.querySelector('.quantity-in');

    if (selectedOption && selectedOption.value) {
        const stock = selectedOption.dataset.stock || '0';
        const cost = selectedOption.dataset.cost || '0';

        currentStockInput.value = parseFloat(stock).toFixed(2);
        // Auto-fill unit cost if it's empty or zero
        if (!unitCostInput.value || parseFloat(unitCostInput.value) === 0) {
            unitCostInput.value = parseFloat(cost).toFixed(2);
        }
        // Trigger recalculation if quantity is already entered
        if (quantityInput.value) {
            calculateLineTotal(quantityInput);
        }
        selectElement.classList.remove('is-invalid'); // Clear validation
    } else {
        // Clear if no product is selected
        currentStockInput.value = '0.00';
        unitCostInput.value = '0.00';
        row.querySelector('.line-total').value = '0.00';
        calculateSubtotal();
    }
}

// Calculate line total for a single item row
function calculateLineTotal(element) {
    const row = element.closest('.inventory-item');
    const quantityInput = row.querySelector('.quantity-in');
    const unitCostInput = row.querySelector('.unit-cost');
    const lineTotalInput = row.querySelector('.line-total');

    const quantity = parseFloat(quantityInput.value) || 0;
    const unitCost = parseFloat(unitCostInput.value) || 0;
    const lineTotal = quantity * unitCost;

    lineTotalInput.value = lineTotal.toFixed(2);
    calculateSubtotal(); // Recalculate the modal's subtotal
}

// Calculate the subtotal for all items in the modal
function calculateSubtotal() {
    let subtotal = 0;
    document.querySelectorAll('.inventory-item .line-total').forEach(input => {
        subtotal += parseFloat(input.value) || 0;
    });
    document.getElementById('modalSubtotal').textContent = `$${subtotal.toFixed(2)}`;
    calculateGrandTotal(); // Update grand total as well
}

// Calculate the grand total (subtotal + tax) for the modal
function calculateGrandTotal() {
    const subtotal = parseFloat(document.getElementById('modalSubtotal').textContent.replace('$', '')) || 0;
    const tax = parseFloat(document.getElementById('modalTax').value) || 0;
    const grandTotal = subtotal + tax;
    document.getElementById('modalGrandTotal').textContent = `$${grandTotal.toFixed(2)}`;
}

// Remove an item row from the inventory adjustment form
function removeInventoryItem(button) {
    const items = document.querySelectorAll('.inventory-item');
    if (items.length > 1) {
        button.closest('.inventory-item').remove();
        calculateSubtotal(); // Recalculate subtotal after removal
    } else {
        // If it's the last item, clear its fields instead of removing the row
        const itemRow = button.closest('.inventory-item');
        itemRow.querySelector('.product-select').value = '';
        itemRow.querySelector('.current-stock').value = '0.00';
        itemRow.querySelector('.quantity-in').value = '';
        itemRow.querySelector('.unit-cost').value = '0.00';
        itemRow.querySelector('.line-total').value = '0.00';
        calculateSubtotal();
    }
}

// Save the inventory adjustment (add items)
function saveInventoryItems() {
    const form = document.getElementById('addInventoryForm');
    const items = [];

    // Validate and collect item data
    let allItemsValid = true;
    const itemRows = document.querySelectorAll('#inventoryItems .inventory-item');
    itemRows.forEach(row => {
        const productSelect = row.querySelector('.product-select');
        const quantityInput = row.querySelector('.quantity-in');
        const unitCostInput = row.querySelector('.unit-cost');

        if (!productSelect || !productSelect.value) {
            productSelect.classList.add('is-invalid');
            allItemsValid = false;
        }
        if (!quantityInput || !quantityInput.value || parseFloat(quantityInput.value) <= 0) {
            quantityInput.classList.add('is-invalid');
            allItemsValid = false;
        }
        // Unit cost is optional, but if entered, should be valid
        if (unitCostInput && unitCostInput.value && isNaN(parseFloat(unitCostInput.value))) {
            unitCostInput.classList.add('is-invalid');
            allItemsValid = false;
        }

        if (productSelect.value && quantityInput.value && parseFloat(quantityInput.value) > 0) {
            items.push({
                product_id: parseInt(productSelect.value),
                quantity_in: parseFloat(quantityInput.value),
                unit_cost: parseFloat(unitCostInput.value) || 0
            });
        }
    });

    if (items.length === 0) {
        showToast('Please add at least one valid item to the adjustment.', 'error');
        return;
    }
    if (!allItemsValid) {
        showToast('Please correct the errors in the item list.', 'error');
        return;
    }

    const formData = new FormData(form);
    const adjustmentDate = formData.get('adjustment_date') || new Date().toISOString().slice(0, 10);
    const referenceNo = formData.get('reference_no') || '';
    const notes = formData.get('notes') || '';
    const tax = parseFloat(formData.get('modalTax') || '0'); // Access tax value correctly

    const data = {
        adjustment_date: adjustmentDate,
        reference_no: referenceNo,
        remarks: notes,
        tax: tax,
        items: items
    };

    const saveButton = form.querySelector('button[onclick="saveInventoryItems()"]');
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

    fetch('/api/inventory/adjustments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Inventory adjustment saved successfully.', 'success');
            bootstrap.Modal.getInstance(form).hide();
            form.reset(); // Reset the form
            // Reset form-specific elements that reset() doesn't handle
            document.getElementById('modalSubtotal').textContent = '$0.00';
            document.getElementById('modalGrandTotal').textContent = '$0.00';
            document.getElementById('modalTax').value = '0';
            document.querySelector('input[name="adjustment_date"]').value = new Date().toISOString().slice(0, 10); // Reset date

            setTimeout(() => {
                loadAdjustmentsData(); // Refresh adjustments table
                loadProducts(); // Refresh product list to show updated stock
            }, 500);
        } else {
            throw new Error(data.error || 'Failed to save inventory adjustment');
        }
    })
    .catch(error => {
        console.error('Error saving inventory items:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Save Changes';
    });
}


// --- Product Master Modal Functions ---
function openAddProductModal() {
    // Clear and reset the form when opening the modal
    const form = document.getElementById('addProductForm');
    form.reset();
    // Reset any custom validation states if necessary
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    form.querySelectorAll('.invalid-feedback').forEach(el => el.style.display = 'none');

    new bootstrap.Modal(document.getElementById('addProductModal')).show();
}

function saveProduct() {
    const form = document.getElementById('addProductForm');
    // Basic form validation
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }

    const formData = new FormData(form);
    const saveButton = form.querySelector('button[onclick="saveProduct()"]');
    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';

    fetch('/inventory/products/add', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
            loadProducts(); // Refresh the product list
        } else {
            throw new Error(data.error || 'Failed to add product');
        }
    })
    .catch(error => {
        console.error('Error saving product:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        saveButton.disabled = false;
        saveButton.innerHTML = '<i class="fas fa-save me-1"></i>Add Product';
    });
}

// --- Category Modal Functions ---
// (Already defined above, no changes needed here)


// --- Consumption Modal Functions ---
// (Already defined above, no changes needed here)


// --- Adjustment Modal Functions ---
// (Already defined above, no changes needed here)


// --- Product Detail/Edit Modal Functions ---
// (Already defined above, no changes needed here)


// --- Category Detail/Edit Modal Functions ---
// (Already defined above, no changes needed here)


// --- Consumption Detail/Edit Modal Functions ---
// (Already defined above, no changes needed here)


// --- Adjustment Detail/Edit Modal Functions ---
// (Already defined above, no changes needed here)


// --- Initialization and Event Listeners ---
// (Handled by the DOMContentLoaded listener and setup functions)


</script>
{% endblock %}