{% extends "base.html" %}

{% block title %}Inventory Management - Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-boxes me-2"></i>Inventory Management</h2>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" onclick="openAddInventoryModal()">
                        <i class="fas fa-plus me-1"></i>Add Inventory Items
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="openAddProductModal()">
                        <i class="fas fa-box me-1"></i>Add Product
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="openAddCategoryModal()">
                        <i class="fas fa-tags me-1"></i>Add Category
                    </button>
                </div>
            </div>

            <!-- Dashboard Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ stats.total_products }}</h4>
                                    <p class="card-text">Total Products</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-boxes fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ stats.low_stock_count }}</h4>
                                    <p class="card-text">Low Stock Items</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-exclamation-triangle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">{{ stats.out_of_stock_count }}</h4>
                                    <p class="card-text">Out of Stock</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-times-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 class="card-title">${{ "{:.2f}".format(stats.total_value) }}</h4>
                                    <p class="card-text">Inventory Value</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-dollar-sign fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <ul class="nav nav-tabs" id="inventoryTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                        <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="products-tab" data-bs-toggle="tab" data-bs-target="#products" type="button" role="tab">
                        <i class="fas fa-box me-1"></i>Product Master
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">
                        <i class="fas fa-tags me-1"></i>Categories
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="adjustments-tab" data-bs-toggle="tab" data-bs-target="#adjustments" type="button" role="tab">
                        <i class="fas fa-plus-circle me-1"></i>Add Inventory Items
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="consumption-tab" data-bs-toggle="tab" data-bs-target="#consumption" type="button" role="tab">
                        <i class="fas fa-minus-circle me-1"></i>Consumption
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="inventoryTabContent">
                <!-- Dashboard Tab -->
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Stock Level Overview</h5>
                        </div>
                        <div class="card-body">
                            <!-- Critical Alerts -->
                            {% if critical_alerts %}
                            <div class="alert alert-danger mb-3">
                                <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-1"></i>Critical Alerts</h6>
                                {% for alert in critical_alerts %}
                                <div class="mb-1">{{ alert.message }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Recent Stock Movements -->
                            <div class="row">
                                <div class="col-md-12">
                                    <h6><i class="fas fa-history me-1"></i>Recent Stock Movements</h6>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Product</th>
                                                    <th>Type</th>
                                                    <th>Quantity</th>
                                                    <th>Reason</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for movement in recent_movements %}
                                                <tr>
                                                    <td>{{ movement.created_at.strftime('%Y-%m-%d %H:%M') if movement.created_at else 'N/A' }}</td>
                                                    <td>{{ movement.product.name if movement.product else 'Unknown' }}</td>
                                                    <td>
                                                        <span class="badge bg-{{ 'success' if movement.movement_type == 'in' else 'danger' }}">
                                                            {{ movement.movement_type.upper() }}
                                                        </span>
                                                    </td>
                                                    <td>{{ movement.quantity }}</td>
                                                    <td>{{ movement.reason[:50] + '...' if movement.reason and movement.reason|length > 50 else movement.reason or 'N/A' }}</td>
                                                </tr>
                                                {% else %}
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">No recent movements</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Product Master Tab -->
                <div class="tab-pane fade" id="products" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-box me-2"></i>Product Master</h5>
                            <button class="btn btn-primary btn-sm" onclick="openAddProductModal()">
                                <i class="fas fa-plus me-1"></i>Add Product
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="productsTable">
                                    <thead>
                                        <tr>
                                            <th>SKU</th>
                                            <th>Product Name</th>
                                            <th>Category</th>
                                            <th>Unit</th>
                                            <th>Current Stock</th>
                                            <th>Reorder Level</th>
                                            <th>Status</th>
                                            <th>Location</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="productsTableBody">
                                        <!-- Products will be loaded via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Categories Tab -->
                <div class="tab-pane fade" id="categories" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-tags me-2"></i>Categories</h5>
                            <button class="btn btn-primary btn-sm" onclick="openAddCategoryModal()">
                                <i class="fas fa-plus me-1"></i>Add Category
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Color</th>
                                            <th>Products Count</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category in categories %}
                                        <tr>
                                            <td>
                                                <span class="badge" style="background-color: {{ category.color_code }};">
                                                    {{ category.name }}
                                                </span>
                                            </td>
                                            <td>{{ category.description or 'No description' }}</td>
                                            <td>
                                                <div class="color-preview" style="background-color: {{ category.color_code }}; width: 20px; height: 20px; border-radius: 3px; display: inline-block;"></div>
                                                {{ category.color_code }}
                                            </td>
                                            <td>{{ category.products|length }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" onclick="viewCategory({{ category.id }})" title="View">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-outline-secondary" onclick="editCategory({{ category.id }})" title="Edit">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" onclick="deleteCategory({{ category.id }})" title="Delete">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">No categories found</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Inventory Items Tab -->
                <div class="tab-pane fade" id="adjustments" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Inventory Adjustments</h5>
                            <button class="btn btn-primary btn-sm" onclick="openAddAdjustmentModal()">
                                <i class="fas fa-plus me-1"></i>Add Inventory Items
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="adjustmentsTable">
                                    <thead>
                                        <tr>
                                            <th>Reference ID</th>
                                            <th>Adjustment Date</th>
                                            <th>Number of Items</th>
                                            <th>Subtotal Value</th>
                                            <th>Total Value</th>
                                            <th>Remarks</th>
                                            <th>Created By</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="adjustmentsTableBody">
                                        <!-- Adjustment records will be loaded via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Consumption Tab -->
                <div class="tab-pane fade" id="consumption" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-minus-circle me-2"></i>Consumption Records</h5>
                            <button class="btn btn-primary btn-sm" onclick="openAddConsumptionModal()">
                                <i class="fas fa-plus me-1"></i>Add Consumption
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="consumptionTable">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Product</th>
                                            <th>SKU</th>
                                            <th>Quantity Used</th>
                                            <th>Unit</th>
                                            <th>Issued To</th>
                                            <th>Reference</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="consumptionTableBody">
                                        <!-- Consumption records will be loaded via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProductForm">
                <div class="modal-body">
                    <input type="hidden" id="editProductId" name="product_id">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">SKU <span class="text-danger">*</span></label>
                            <input type="text" id="editSku" name="sku" class="form-control" required readonly>
                            <small class="text-muted">SKU cannot be changed after creation</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Product Name <span class="text-danger">*</span></label>
                            <input type="text" id="editName" name="name" class="form-control" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Category</label>
                            <select id="editCategory" name="category_id" class="form-select">
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unit of Measure <span class="text-danger">*</span></label>
                            <select id="editUnitOfMeasure" name="unit_of_measure" class="form-select" required>
                                <option value="pcs">Pieces</option>
                                <option value="kg">Kilograms</option>
                                <option value="g">Grams</option>
                                <option value="ml">Milliliters</option>
                                <option value="l">Liters</option>
                                <option value="m">Meters</option>
                                <option value="cm">Centimeters</option>
                                <option value="box">Box</option>
                                <option value="bottle">Bottle</option>
                                <option value="tube">Tube</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Current Stock</label>
                            <input type="number" id="editCurrentStock" name="current_stock" class="form-control" step="0.01" readonly>
                            <small class="text-muted">Use inventory adjustments to change stock</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Reorder Level</label>
                            <input type="number" id="editReorderLevel" name="reorder_point" class="form-control" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Min Stock Level</label>
                            <input type="number" id="editMinStock" name="min_stock_level" class="form-control" step="0.01">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Max Stock Level</label>
                            <input type="number" id="editMaxStock" name="max_stock_level" class="form-control" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cost Price</label>
                            <input type="number" id="editCostPrice" name="cost_price" class="form-control" step="0.01">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Selling Price</label>
                            <input type="number" id="editSellingPrice" name="selling_price" class="form-control" step="0.01">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Barcode</label>
                            <input type="text" id="editBarcode" name="barcode" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Storage Location</label>
                            <input type="text" id="editLocation" name="location" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="editDescription" name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editUsedInServices" name="is_service_item">
                                <label class="form-check-label" for="editUsedInServices">
                                    Used in Services
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editRetailItem" name="is_retail_item">
                                <label class="form-check-label" for="editRetailItem">
                                    Retail Item
                                </label>
                            </div>
                        </div>
                    </div>
                    <div id="editProductStatus" class="alert alert-info" style="display: none;">
                        <strong>Current Status:</strong> <span id="editStatusText"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditProduct()">
                        <i class="fas fa-save me-1"></i>Update Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Inventory Items Modal -->
<div class="modal fade" id="addInventoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Inventory Items</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addInventoryForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Add stock for existing products. This will increase current stock levels.
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Date of Adjustment</label>
                            <input type="date" name="adjustment_date" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Reference ID</label>
                            <input type="text" name="reference_no" class="form-control" placeholder="Optional reference">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Remarks</label>
                        <textarea name="notes" class="form-control" rows="2" placeholder="Optional remarks"></textarea>
                    </div>

                    <div class="mb-3">
                        <h6>Items</h6>
                        <div id="inventoryItems">
                            <div class="row mb-2 inventory-item">
                                <div class="col-md-3">
                                    <label class="form-label small">Select Product</label>
                                    <div class="input-group">
                                        <select name="product_id[]" class="form-select product-select" required onchange="updateCurrentStock(this)">
                                            <option value="">Select Product</option>
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="refreshProductsDropdown(this)" title="Refresh Products">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback" style="display: none;">Please select a product</div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Current Stock</label>
                                    <input type="number" name="current_stock[]" class="form-control current-stock" readonly>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Quantity to Add</label>
                                    <input type="number" name="quantity_in[]" class="form-control quantity-in" step="0.01" required onchange="calculateLineTotal(this)">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Unit Cost</label>
                                    <input type="number" name="unit_cost[]" class="form-control unit-cost" step="0.01" onchange="calculateLineTotal(this)">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Line Total</label>
                                    <input type="number" name="line_total[]" class="form-control line-total" readonly>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label small">&nbsp;</label>
                                    <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeInventoryItem(this)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addInventoryItem()">
                            <i class="fas fa-plus me-1"></i>Add Item
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4">
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Subtotal:</strong></td>
                                    <td class="text-end"><span id="modalSubtotal">$0.00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Tax (if any):</strong></td>
                                    <td class="text-end">
                                        <input type="number" id="modalTax" class="form-control form-control-sm" step="0.01" value="0" onchange="calculateGrandTotal()">
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Total Value:</strong></td>
                                    <td class="text-end"><strong><span id="modalGrandTotal">$0.00</span></strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveInventoryItems()">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Adjustment Modal -->
<div class="modal fade" id="viewAdjustmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">View Inventory Adjustment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Reference ID:</strong> <span id="viewReferenceId"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Adjustment Date:</strong> <span id="viewAdjustmentDate"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Created By:</strong> <span id="viewCreatedBy"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Created Date:</strong> <span id="viewCreatedDate"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Remarks:</strong>
                    <p id="viewRemarks" class="text-muted"></p>
                </div>
                <div class="mb-3">
                    <h6>Items</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity Added</th>
                                    <th>Unit Cost</th>
                                    <th>Line Total</th>
                                </tr>
                            </thead>
                            <tbody id="viewItemsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8"></div>
                    <div class="col-md-4">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>Subtotal:</strong></td>
                                <td class="text-end"><span id="viewSubtotal"></span></td>
                            </tr>
                            <tr>
                                <td><strong>Tax:</strong></td>
                                <td class="text-end"><span id="viewTax"></span></td>
                            </tr>
                            <tr>
                                <td><strong>Total Value:</strong></td>
                                <td class="text-end"><strong><span id="viewGrandTotal"></span></strong></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Adjustment Modal -->
<div class="modal fade" id="editAdjustmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Inventory Adjustment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editAdjustmentForm">
                <input type="hidden" name="adjustment_id" id="editAdjustmentId">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Editing this adjustment will reverse the original stock changes and apply the new ones.
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Date of Adjustment</label>
                            <input type="date" name="adjustment_date" id="editAdjustmentDate" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Reference ID</label>
                            <input type="text" name="reference_no" id="editReferenceNo" class="form-control" placeholder="Optional reference">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Remarks</label>
                        <textarea name="notes" id="editNotes" class="form-control" rows="2" placeholder="Optional remarks"></textarea>
                    </div>

                    <div class="mb-3">
                        <h6>Items</h6>
                        <div id="editInventoryItems">
                            <!-- Items will be loaded dynamically -->
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addEditInventoryItem()">
                            <i class="fas fa-plus me-1"></i>Add Item
                        </button>
                    </div>

                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4">
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Subtotal:</strong></td>
                                    <td class="text-end"><span id="editSubtotal">$0.00</span></td>
                                </tr>
                                <tr>
                                    <td><strong>Tax (if any):</strong></td>
                                    <td class="text-end">
                                        <input type="number" id="editTax" class="form-control form-control-sm" step="0.01" value="0" onchange="calculateEditGrandTotal()">
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Total Value:</strong></td>
                                    <td class="text-end"><strong><span id="editGrandTotal">$0.00</span></strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedAdjustment()">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProductForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">SKU <span class="text-danger">*</span></label>
                                <input type="text" name="sku" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Product Name <span class="text-danger">*</span></label>
                                <input type="text" name="name" class="form-control" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select name="category_id" class="form-select">
                                    <option value="">Select Category</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Unit of Measure</label>
                                <input type="text" name="unit_of_measure" class="form-control" value="pcs">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Current Stock (read-only)</label>
                                <input type="number" name="current_stock" class="form-control" value="0" readonly>
                                <small class="text-muted">Use "Add Inventory Items" to add stock</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Reorder Point</label>
                                <input type="number" name="reorder_point" class="form-control" value="20" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Min Stock Level</label>
                                <input type="number" name="min_stock_level" class="form-control" value="10" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Max Stock Level</label>
                                <input type="number" name="max_stock_level" class="form-control" value="100" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Cost Price</label>
                                <input type="number" name="cost_price" class="form-control" step="0.01">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Selling Price</label>
                                <input type="number" name="selling_price" class="form-control" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Barcode</label>
                                <input type="text" name="barcode" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Location</label>
                                <input type="text" name="location" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_service_item" id="isServiceItem">
                                <label class="form-check-label" for="isServiceItem">
                                    Used in Services
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_retail_item" id="isRetailItem">
                                <label class="form-check-label" for="isRetailItem">
                                    Retail Item
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">
                        <i class="fas fa-save me-1"></i>Add Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addCategoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Category Name <span class="text-danger">*</span></label>
                        <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="description" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <input type="color" name="color_code" class="form-control" value="#007bff">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategory()">
                        <i class="fas fa-save me-1"></i>Add Category
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Consumption Modal -->
<div class="modal fade" id="addConsumptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Consumption Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addConsumptionForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Product <span class="text-danger">*</span></label>
                        <select name="product_id" class="form-select" required>
                            <option value="">Select Product</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Consumption Date <span class="text-danger">*</span></label>
                        <input type="date" name="consumption_date" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity Used <span class="text-danger">*</span></label>
                        <input type="number" name="quantity_used" class="form-control" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Issued To <span class="text-danger">*</span></label>
                        <input type="text" name="issued_to" class="form-control" required placeholder="Department/Person">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reference/Doc No.</label>
                        <input type="text" name="reference_doc_no" class="form-control" placeholder="Optional reference">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-control" rows="2" placeholder="Optional notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveConsumption()">
                        <i class="fas fa-save me-1"></i>Add Consumption
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loaded successfully');
    console.log('Dashboard JavaScript loaded and ready');

    // Initialize bootstrap components
    console.log('Dashboard widgets initialized');

    // Set default date to today
    document.querySelector('input[name="adjustment_date"]').value = new Date().toISOString().split('T')[0];
    document.querySelector('input[name="consumption_date"]').value = new Date().toISOString().split('T')[0];

    // Load initial data
    loadProducts();
    loadConsumption();
    loadAdjustments();
});

function showToast(message, type = 'info') {
    // Create toast element
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' || type === 'danger' ? 'danger' : 'info'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    // Add to toast container or body
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);

    // Show the toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();

    // Remove after hiding
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function openAddInventoryModal() {
    const modal = new bootstrap.Modal(document.getElementById('addInventoryModal'));
    
    // Load products and then show modal
    loadProductsForAdjustment()
    .then(() => {
        modal.show();
    })
    .catch(error => {
        console.error('Error opening modal:', error);
        showToast('Error loading products. Please try again.', 'error');
    });
}

function loadProductsForAdjustment() {
    return new Promise((resolve, reject) => {
        // First try localStorage if available, otherwise fetch from API
        let productsPromise;
        
        // Check localStorage first
        const cachedProducts = localStorage.getItem('inventory.products');
        if (cachedProducts) {
            try {
                const products = JSON.parse(cachedProducts);
                productsPromise = Promise.resolve(products);
            } catch (e) {
                // If localStorage is corrupted, fall back to API
                productsPromise = fetchProductsFromAPI();
            }
        } else {
            // No cache, fetch from API
            productsPromise = fetchProductsFromAPI();
        }
        
        productsPromise
        .then(products => {
            populateProductDropdowns(products);
            resolve(products);
        })
        .catch(error => {
            console.error('Error loading products:', error);
            reject(error);
        });
    });
}

function fetchProductsFromAPI() {
    return fetch('/api/inventory/products/master')
    .then(response => {
        if (!response.ok) {
            throw new Error('Failed to fetch products');
        }
        return response.json();
    })
    .then(products => {
        // Cache in localStorage for future use
        try {
            localStorage.setItem('inventory.products', JSON.stringify(products));
        } catch (e) {
            console.warn('Could not cache products in localStorage:', e);
        }
        return products;
    });
}

function populateProductDropdowns(products) {
    // Get all product select elements in the inventory modal
    const selects = document.querySelectorAll('#addInventoryModal .product-select');
    
    selects.forEach(select => {
        // Store current selection to preserve it
        const currentValue = select.value;
        
        // Clear existing options
        select.innerHTML = '<option value="">Select Product</option>';
        
        // Handle empty state
        if (!products || products.length === 0) {
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'No products found. Please add products in Product Master.';
            emptyOption.disabled = true;
            select.appendChild(emptyOption);
            
            // Disable save button if no products
            const saveButton = document.querySelector('#addInventoryModal .btn-primary');
            if (saveButton) {
                saveButton.disabled = true;
                saveButton.title = 'No products available. Please add products first.';
            }
            return;
        }
        
        // Enable save button if products exist
        const saveButton = document.querySelector('#addInventoryModal .btn-primary');
        if (saveButton) {
            saveButton.disabled = false;
            saveButton.title = '';
        }
        
        // Add products to dropdown
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id || '';
            option.setAttribute('data-stock', product.current_stock || 0);
            option.setAttribute('data-unit', product.unit_of_measure || 'pcs');
            option.setAttribute('data-cost', product.cost_price || 0);
            
            // Format: Product Name (SKU) - Current: X units
            const currentStock = product.current_stock || 0;
            const unit = product.unit_of_measure || 'pcs';
            const sku = product.sku || 'N/A';
            const name = product.name || 'Unnamed Product';
            
            option.textContent = `${name} (${sku}) - Current: ${currentStock} ${unit}`;
            select.appendChild(option);
        });
        
        // Restore previous selection if valid
        if (currentValue) {
            select.value = currentValue;
            // Trigger change event to update dependent fields
            const event = new Event('change');
            select.dispatchEvent(event);
        }
        
        // Add searchable functionality for large lists
        if (products.length > 20) {
            addSearchableFeature(select);
        }
    });
}

function addSearchableFeature(selectElement) {
    // Simple searchable feature - add a search input above the select
    const container = selectElement.closest('.input-group') || selectElement.parentElement;
    
    // Check if search input already exists
    if (container.querySelector('.product-search')) {
        return;
    }
    
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control form-control-sm product-search mb-1';
    searchInput.placeholder = 'Type to search products...';
    
    // Store original options
    const originalOptions = Array.from(selectElement.options).slice(1); // Skip first empty option
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        
        // Clear current options except the first one
        selectElement.innerHTML = '<option value="">Select Product</option>';
        
        // Filter and add matching options
        originalOptions.forEach(option => {
            if (option.textContent.toLowerCase().includes(searchTerm)) {
                selectElement.appendChild(option.cloneNode(true));
            }
        });
    });
    
    container.insertBefore(searchInput, selectElement);
}

function refreshProductsDropdown(refreshButton) {
    // Add loading state to refresh button
    const originalContent = refreshButton.innerHTML;
    refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    refreshButton.disabled = true;
    
    // Clear localStorage cache
    localStorage.removeItem('inventory.products');
    
    // Fetch fresh data from API
    fetchProductsFromAPI()
    .then(products => {
        populateProductDropdowns(products);
        showToast('Products refreshed successfully', 'success');
    })
    .catch(error => {
        console.error('Error refreshing products:', error);
        showToast('Error refreshing products. Please try again.', 'error');
    })
    .finally(() => {
        // Reset button state
        refreshButton.innerHTML = originalContent;
        refreshButton.disabled = false;
    });
}

function openAddAdjustmentModal() {
    openAddInventoryModal();
}

function updateCurrentStock(selectElement) {
    const selectedOption = selectElement.selectedOptions[0];
    const row = selectElement.closest('.inventory-item');
    const currentStockInput = row.querySelector('.current-stock');
    const unitCostInput = row.querySelector('.unit-cost');
    
    // Defensive defaults - handle missing data gracefully
    if (selectedOption && selectedOption.value) {
        // Auto-fill current stock from product data
        const currentStock = selectedOption.dataset.stock || '0';
        const unitCost = selectedOption.dataset.cost || '0';
        
        currentStockInput.value = parseFloat(currentStock).toFixed(2);
        
        // Auto-fill unit cost if available and not already set
        if (unitCostInput && (!unitCostInput.value || unitCostInput.value === '0')) {
            unitCostInput.value = parseFloat(unitCost).toFixed(2);
        }
        
        // Clear any validation errors
        selectElement.classList.remove('is-invalid');
        const feedback = selectElement.closest('.col-md-3').querySelector('.invalid-feedback');
        if (feedback) {
            feedback.style.display = 'none';
        }
    } else {
        // No product selected - clear dependent fields
        currentStockInput.value = '0.00';
        if (unitCostInput) {
            unitCostInput.value = '0.00';
        }
    }
    
    calculateLineTotal(selectElement);
}

function calculateLineTotal(element) {
    const row = element.closest('.inventory-item');
    const quantityInput = row.querySelector('.quantity-in');
    const unitCostInput = row.querySelector('.unit-cost');
    const lineTotalInput = row.querySelector('.line-total');
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const unitCost = parseFloat(unitCostInput.value) || 0;
    const lineTotal = quantity * unitCost;
    
    lineTotalInput.value = lineTotal.toFixed(2);
    calculateSubtotal();
}

function calculateSubtotal() {
    let subtotal = 0;
    document.querySelectorAll('.line-total').forEach(input => {
        subtotal += parseFloat(input.value) || 0;
    });
    
    document.getElementById('modalSubtotal').textContent = `$${subtotal.toFixed(2)}`;
    calculateGrandTotal();
}

function calculateGrandTotal() {
    const subtotal = parseFloat(document.getElementById('modalSubtotal').textContent.replace('$', '')) || 0;
    const tax = parseFloat(document.getElementById('modalTax').value) || 0;
    const grandTotal = subtotal + tax;
    
    document.getElementById('modalGrandTotal').textContent = `$${grandTotal.toFixed(2)}`;
}

function addInventoryItem() {
    const container = document.getElementById('inventoryItems');
    const newItem = container.firstElementChild.cloneNode(true);

    // Clear values from inputs and selects
    newItem.querySelectorAll('input, select').forEach(input => {
        if (input.type !== 'button') {
            input.value = '';
        }
        // Clear validation classes
        input.classList.remove('is-invalid', 'is-valid');
    });

    // Clear any search inputs that might have been added for searchable dropdowns
    const searchInputs = newItem.querySelectorAll('.product-search');
    searchInputs.forEach(search => search.remove());

    // Hide validation feedback
    const feedbacks = newItem.querySelectorAll('.invalid-feedback');
    feedbacks.forEach(feedback => feedback.style.display = 'none');

    container.appendChild(newItem);

    // Load products for the new dropdown
    const newSelect = newItem.querySelector('.product-select');
    if (newSelect) {
        // Try to get cached products first
        const cachedProducts = localStorage.getItem('inventory.products');
        if (cachedProducts) {
            try {
                const products = JSON.parse(cachedProducts);
                populateProductDropdown(newSelect, products);
            } catch (e) {
                // If cache is corrupted, fetch fresh data
                fetchProductsFromAPI().then(products => {
                    populateProductDropdown(newSelect, products);
                });
            }
        } else {
            // No cache, fetch from API
            fetchProductsFromAPI().then(products => {
                populateProductDropdown(newSelect, products);
            });
        }
    }
}

function populateProductDropdown(selectElement, products) {
    // Clear existing options
    selectElement.innerHTML = '<option value="">Select Product</option>';
    
    // Handle empty state
    if (!products || products.length === 0) {
        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = 'No products found. Please add products in Product Master.';
        emptyOption.disabled = true;
        selectElement.appendChild(emptyOption);
        return;
    }
    
    // Add products to dropdown
    products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id || '';
        option.setAttribute('data-stock', product.current_stock || 0);
        option.setAttribute('data-unit', product.unit_of_measure || 'pcs');
        option.setAttribute('data-cost', product.cost_price || 0);
        
        // Format: Product Name (SKU) - Current: X units
        const currentStock = product.current_stock || 0;
        const unit = product.unit_of_measure || 'pcs';
        const sku = product.sku || 'N/A';
        const name = product.name || 'Unnamed Product';
        
        option.textContent = `${name} (${sku}) - Current: ${currentStock} ${unit}`;
        selectElement.appendChild(option);
    });
    
    // Add searchable functionality for large lists
    if (products.length > 20) {
        addSearchableFeature(selectElement);
    }
}

function removeInventoryItem(button) {
    const items = document.querySelectorAll('.inventory-item');
    if (items.length > 1) {
        button.closest('.inventory-item').remove();
    }
}

function saveInventoryItems() {
    const form = document.getElementById('addInventoryForm');
    const formData = new FormData(form);

    // Get all items
    const items = [];
    const productIds = formData.getAll('product_id[]');
    const quantities = formData.getAll('quantity_in[]');
    const unitCosts = formData.getAll('unit_cost[]');

    for (let i = 0; i < productIds.length; i++) {
        if (productIds[i] && quantities[i]) {
            const quantity = parseFloat(quantities[i]);
            const unitCost = parseFloat(unitCosts[i]) || 0;
            
            if (isNaN(quantity) || quantity <= 0) {
                showToast('Please enter valid quantities greater than 0', 'error');
                return;
            }
            
            items.push({
                product_id: productIds[i],
                quantity_in: quantity,
                unit_cost: unitCost
            });
        }
    }

    if (items.length === 0) {
        showToast('Please add at least one valid item', 'error');
        return;
    }

    const data = {
        adjustment_date: formData.get('adjustment_date') || new Date().toISOString().split('T')[0],
        reference_no: formData.get('reference_no') || '',
        notes: formData.get('notes') || '',
        items: items
    };

    fetch('/api/inventory/adjustments', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('addInventoryModal')).hide();
            form.reset();
            loadProducts(); // Refresh product list
            loadAdjustments(); // Refresh adjustments list
            // Reset form to default values
            document.querySelector('input[name="adjustment_date"]').value = new Date().toISOString().split('T')[0];
            document.getElementById('modalSubtotal').textContent = '$0.00';
            document.getElementById('modalGrandTotal').textContent = '$0.00';
            document.getElementById('modalTax').value = '0';
        } else {
            throw new Error(data.error || 'Failed to add inventory items');
        }
    })
    .catch(error => {
        console.error('Error adding inventory items:', error);
        const errorMessage = error.error || error.message || 'Failed to add inventory items';
        showToast(`Error: ${errorMessage}`, 'error');
    });
}

function openAddProductModal() {
    const modal = new bootstrap.Modal(document.getElementById('addProductModal'));
    modal.show();
}

function saveProduct() {
    const form = document.getElementById('addProductForm');
    const formData = new FormData(form);

    fetch('/inventory/products/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
            form.reset();
            loadProducts(); // Refresh product list
        } else {
            throw new Error(data.error || 'Failed to add product');
        }
    })
    .catch(error => {
        console.error('Error adding product:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

function openAddCategoryModal() {
    const modal = new bootstrap.Modal(document.getElementById('addCategoryModal'));
    modal.show();
}

function saveCategory() {
    const form = document.getElementById('addCategoryForm');
    const formData = new FormData(form);

    fetch('/inventory/categories/add', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected) {
            // Handle redirect response
            showToast('Category added successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addCategoryModal')).hide();
            form.reset();
            location.reload(); // Refresh page to show new category
        } else {
            return response.json();
        }
    })
    .then(data => {
        if (data && data.error) {
            throw new Error(data.error);
        }
    })
    .catch(error => {
        console.error('Error adding category:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

function loadProducts() {
    fetch('/api/inventory/products/master')
    .then(response => response.json())
    .then(products => {
        const tbody = document.getElementById('productsTableBody');
        tbody.innerHTML = '';

        products.forEach(product => {
            const statusClass = product.status === 'out_of_stock' ? 'danger' : 
                               product.status === 'low_stock' ? 'warning' : 
                               product.status === 'reorder_needed' ? 'info' : 'success';

            const row = `
                <tr>
                    <td>${product.sku}</td>
                    <td>${product.name}</td>
                    <td><span class="badge" style="background-color: ${product.category_color};">${product.category}</span></td>
                    <td>${product.unit_of_measure}</td>
                    <td>${product.current_stock}</td>
                    <td>${product.reorder_level}</td>
                    <td><span class="badge bg-${statusClass}">${product.status.replace('_', ' ').toUpperCase()}</span></td>
                    <td>${product.location}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewProduct(${product.id})" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editProduct(${product.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    })
    .catch(error => {
        console.error('Error loading products:', error);
        showToast('Error loading products', 'error');
    });
}

function openAddConsumptionModal() {
    // Load products for the form
    fetch('/api/inventory/products/for-consumption')
    .then(response => response.json())
    .then(products => {
        const select = document.querySelector('#addConsumptionModal select[name="product_id"]');
        select.innerHTML = '<option value="">Select Product</option>';
        products.forEach(product => {
            select.innerHTML += `<option value="${product.id}">${product.name} (${product.sku}) - Available: ${product.current_stock} ${product.unit_of_measure}</option>`;
        });

        const modal = new bootstrap.Modal(document.getElementById('addConsumptionModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error loading products:', error);
        showToast('Error loading products', 'error');
    });
}

function saveConsumption() {
    const form = document.getElementById('addConsumptionForm');
    const formData = new FormData(form);

    fetch('/inventory/consumption/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('addConsumptionModal')).hide();
            form.reset();
            loadConsumption(); // Refresh consumption list
        } else {
            throw new Error(data.error || 'Failed to add consumption record');
        }
    })
    .catch(error => {
        console.error('Error adding consumption:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

function loadConsumption() {
    fetch('/inventory/consumption')
    .then(response => response.json())
    .then(data => {
        const tbody = document.getElementById('consumptionTableBody');
        tbody.innerHTML = '';

        data.records.forEach(record => {
            const row = `
                <tr>
                    <td>${record.consumption_date}</td>
                    <td>${record.product_name}</td>
                    <td>${record.product_sku}</td>
                    <td>${record.quantity_used}</td>
                    <td>${record.unit_of_measure}</td>
                    <td>${record.issued_to}</td>
                    <td>${record.reference_doc_no}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewConsumption(${record.id})" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editConsumption(${record.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteConsumption(${record.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    })
    .catch(error => {
        console.error('Error loading consumption records:', error);
        showToast('Error loading consumption records', 'error');
    });
}

function loadAdjustments() {
    fetch('/api/inventory/adjustments')
    .then(response => response.json())
    .then(data => {
        const tbody = document.getElementById('adjustmentsTableBody');
        tbody.innerHTML = '';

        data.records.forEach(record => {
            const row = `
                <tr>
                    <td>${record.reference_id || 'N/A'}</td>
                    <td>${record.adjustment_date}</td>
                    <td>${record.items_count}</td>
                    <td>$${record.subtotal.toFixed(2)}</td>
                    <td>$${record.total_value.toFixed(2)}</td>
                    <td>${record.remarks || 'N/A'}</td>
                    <td>${record.created_by}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="viewAdjustment(${record.id})" title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="editAdjustment(${record.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteAdjustment(${record.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    })
    .catch(error => {
        console.error('Error loading adjustment records:', error);
        showToast('Error loading adjustment records', 'error');
    });
}

// Product action functions
function viewProduct(id) { 
    showToast('View product functionality to be implemented', 'info'); 
}

function editProduct(id) {
    // Fetch product data and open edit modal
    fetch(`/api/inventory/product/${id}`)
    .then(response => response.json())
    .then(product => {
        if (product.error) {
            throw new Error(product.error);
        }
        
        // Populate the edit modal with product data
        document.getElementById('editProductId').value = product.id;
        document.getElementById('editSku').value = product.sku || '';
        document.getElementById('editName').value = product.name || '';
        document.getElementById('editDescription').value = product.description || '';
        document.getElementById('editCategory').value = product.category_id || '';
        document.getElementById('editUnitOfMeasure').value = product.unit_of_measure || 'pcs';
        document.getElementById('editCurrentStock').value = product.current_stock || 0;
        document.getElementById('editReorderLevel').value = product.reorder_point || 0;
        document.getElementById('editMinStock').value = product.min_stock_level || 0;
        document.getElementById('editMaxStock').value = product.max_stock_level || 0;
        document.getElementById('editCostPrice').value = product.cost_price || 0;
        document.getElementById('editSellingPrice').value = product.selling_price || 0;
        document.getElementById('editBarcode').value = product.barcode || '';
        document.getElementById('editLocation').value = product.location || '';
        document.getElementById('editUsedInServices').checked = product.is_service_item || false;
        document.getElementById('editRetailItem').checked = product.is_retail_item || false;
        
        // Show status if available
        if (product.stock_status) {
            document.getElementById('editStatusText').textContent = product.stock_status.replace('_', ' ').toUpperCase();
            document.getElementById('editProductStatus').style.display = 'block';
        } else {
            document.getElementById('editProductStatus').style.display = 'none';
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error loading product:', error);
        showToast(`Error loading product: ${error.message}`, 'error');
    });
}

function saveEditProduct() {
    const form = document.getElementById('editProductForm');
    const formData = new FormData(form);
    const productId = document.getElementById('editProductId').value;
    
    // Add loading state to button
    const saveButton = document.querySelector('#editProductModal .btn-primary');
    const originalContent = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
    saveButton.disabled = true;
    
    fetch(`/inventory/products/${productId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
            loadProducts(); // Refresh the product list
        } else {
            throw new Error(data.error || 'Failed to update product');
        }
    })
    .catch(error => {
        console.error('Error updating product:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        // Reset button state
        saveButton.innerHTML = originalContent;
        saveButton.disabled = false;
    });
}

function deleteProduct(id) {
    // Find product name first
    fetch(`/api/inventory/product/${id}`)
    .then(response => response.json())
    .then(product => {
        const productName = product.name || 'Unknown Product';
        
        Swal.fire({
            title: 'Delete Product',
            text: `Are you sure you want to delete "${productName}"? This action cannot be undone.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                // Proceed with deletion
                fetch(`/api/inventory/products/${id}/delete`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(`Product "${productName}" deleted successfully`, 'success');
                        loadProducts(); // Refresh table
                    } else {
                        throw new Error(data.error || 'Failed to delete product');
                    }
                })
                .catch(error => {
                    console.error('Error deleting product:', error);
                    showToast(`Error: ${error.message}`, 'error');
                });
            }
        });
    })
    .catch(error => {
        console.error('Error fetching product details:', error);
        // Fallback confirmation without product name
        Swal.fire({
            title: 'Delete Product',
            text: 'Are you sure you want to delete this product? This action cannot be undone.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/inventory/products/${id}/delete`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Product deleted successfully', 'success');
                        loadProducts();
                    } else {
                        throw new Error(data.error || 'Failed to delete product');
                    }
                })
                .catch(error => {
                    console.error('Error deleting product:', error);
                    showToast(`Error: ${error.message}`, 'error');
                });
            }
        });
    });
}
function viewCategory(id) {
    fetch(`/api/inventory/categories/${id}`)
    .then(response => response.json())
    .then(category => {
        if (category.error) {
            throw new Error(category.error);
        }
        
        // Populate view modal
        document.getElementById('viewCategoryName').textContent = category.name;
        document.getElementById('viewCategoryDescription').textContent = category.description || 'No description';
        document.getElementById('viewCategoryColor').textContent = category.color_code;
        document.getElementById('viewCategoryColorPreview').style.backgroundColor = category.color_code;
        document.getElementById('viewCategoryProductCount').textContent = category.product_count || 0;
        document.getElementById('viewCategoryCreatedDate').textContent = category.created_at ? new Date(category.created_at).toLocaleDateString() : 'N/A';
        document.getElementById('viewCategoryStatus').textContent = category.is_active ? 'Active' : 'Inactive';
        
        const modal = new bootstrap.Modal(document.getElementById('viewCategoryModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error loading category:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

function editCategory(id) {
    fetch(`/api/inventory/categories/${id}`)
    .then(response => response.json())
    .then(category => {
        if (category.error) {
            throw new Error(category.error);
        }
        
        // Populate edit modal
        document.getElementById('editCategoryId').value = category.id;
        document.getElementById('editCategoryName').value = category.name;
        document.getElementById('editCategoryDescription').value = category.description || '';
        document.getElementById('editCategoryColor').value = category.color_code;
        document.getElementById('editCategoryActive').checked = category.is_active;
        
        const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error loading category:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

function deleteCategory(id) {
    fetch(`/api/inventory/categories/${id}`)
    .then(response => response.json())
    .then(category => {
        const categoryName = category.name || 'Unknown Category';
        
        Swal.fire({
            title: 'Delete Category',
            text: `Are you sure you want to delete "${categoryName}"? This will affect all products in this category.`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/inventory/categories/${id}/delete`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(`Category "${categoryName}" deleted successfully`, 'success');
                        location.reload(); // Refresh page since categories are server-rendered
                    } else {
                        throw new Error(data.error || 'Failed to delete category');
                    }
                })
                .catch(error => {
                    console.error('Error deleting category:', error);
                    showToast(`Error: ${error.message}`, 'error');
                });
            }
        });
    })
    .catch(error => {
        console.error('Error fetching category details:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}
function viewConsumption(id) {
    fetch(`/api/inventory/consumption/${id}`)
    .then(response => response.json())
    .then(consumption => {
        if (consumption.error) {
            throw new Error(consumption.error);
        }
        
        // Populate view modal
        document.getElementById('viewConsumptionDate').textContent = consumption.consumption_date;
        document.getElementById('viewConsumptionProduct').textContent = consumption.product_name;
        document.getElementById('viewConsumptionSKU').textContent = consumption.product_sku;
        document.getElementById('viewConsumptionQuantity').textContent = consumption.quantity_used;
        document.getElementById('viewConsumptionUnit').textContent = consumption.unit_of_measure;
        document.getElementById('viewConsumptionIssuedTo').textContent = consumption.issued_to;
        document.getElementById('viewConsumptionReference').textContent = consumption.reference_doc_no || 'N/A';
        document.getElementById('viewConsumptionNotes').textContent = consumption.notes || 'No notes';
        document.getElementById('viewConsumptionCreatedBy').textContent = consumption.created_by || 'N/A';
        document.getElementById('viewConsumptionCreatedDate').textContent = consumption.created_at ? new Date(consumption.created_at).toLocaleDateString() : 'N/A';
        
        const modal = new bootstrap.Modal(document.getElementById('viewConsumptionModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error loading consumption:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

function editConsumption(id) {
    fetch(`/api/inventory/consumption/${id}`)
    .then(response => response.json())
    .then(consumption => {
        if (consumption.error) {
            throw new Error(consumption.error);
        }
        
        // Populate edit modal
        document.getElementById('editConsumptionId').value = consumption.id;
        document.getElementById('editConsumptionDate').value = consumption.consumption_date;
        document.getElementById('editConsumptionProduct').value = consumption.product_id;
        document.getElementById('editConsumptionQuantity').value = consumption.quantity_used;
        document.getElementById('editConsumptionIssuedTo').value = consumption.issued_to;
        document.getElementById('editConsumptionReference').value = consumption.reference_doc_no || '';
        document.getElementById('editConsumptionNotes').value = consumption.notes || '';
        
        const modal = new bootstrap.Modal(document.getElementById('editConsumptionModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error loading consumption:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

function deleteConsumption(id) {
    fetch(`/api/inventory/consumption/${id}`)
    .then(response => response.json())
    .then(consumption => {
        const productName = consumption.product_name || 'Unknown Product';
        
        Swal.fire({
            title: 'Delete Consumption Record',
            html: `Are you sure you want to delete this consumption record?<br><br>
                   <strong>Product:</strong> ${productName}<br>
                   <strong>Quantity:</strong> ${consumption.quantity_used} ${consumption.unit_of_measure}<br>
                   <strong>Date:</strong> ${consumption.consumption_date}<br><br>
                   <em>This will restore the stock and create a reversal movement.</em>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/inventory/consumption/${id}/delete`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast(`Consumption record deleted and stock restored`, 'success');
                        loadConsumption(); // Refresh table
                        loadProducts(); // Refresh product table if visible
                    } else {
                        throw new Error(data.error || 'Failed to delete consumption record');
                    }
                })
                .catch(error => {
                    console.error('Error deleting consumption:', error);
                    showToast(`Error: ${error.message}`, 'error');
                });
            }
        });
    })
    .catch(error => {
        console.error('Error fetching consumption details:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

// Adjustment functions
function viewAdjustment(id) {
    fetch(`/api/inventory/adjustments/${id}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Populate view modal
        document.getElementById('viewReferenceId').textContent = data.reference_id || 'N/A';
        document.getElementById('viewAdjustmentDate').textContent = data.adjustment_date;
        document.getElementById('viewCreatedBy').textContent = data.created_by;
        document.getElementById('viewCreatedDate').textContent = data.created_date;
        document.getElementById('viewRemarks').textContent = data.remarks || 'No remarks';
        
        // Populate items table
        const tbody = document.getElementById('viewItemsTableBody');
        tbody.innerHTML = '';
        data.items.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td>${item.product_name}</td>
                    <td>${item.quantity_added}</td>
                    <td>$${item.unit_cost.toFixed(2)}</td>
                    <td>$${item.line_total.toFixed(2)}</td>
                </tr>
            `;
        });
        
        // Populate totals
        document.getElementById('viewSubtotal').textContent = `$${data.subtotal.toFixed(2)}`;
        document.getElementById('viewTax').textContent = `$${data.tax.toFixed(2)}`;
        document.getElementById('viewGrandTotal').textContent = `$${data.total_value.toFixed(2)}`;
        
        const modal = new bootstrap.Modal(document.getElementById('viewAdjustmentModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error loading adjustment:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

function editAdjustment(id) {
    fetch(`/api/inventory/adjustments/${id}`)
    .then(response => response.json())
    .then(adjustment => {
        if (adjustment.error) {
            throw new Error(adjustment.error);
        }
        
        // Populate edit modal
        document.getElementById('editAdjustmentId').value = adjustment.id;
        document.getElementById('editAdjustmentDate').value = adjustment.adjustment_date;
        document.getElementById('editAdjustmentReference').value = adjustment.reference_id || '';
        document.getElementById('editAdjustmentRemarks').value = adjustment.remarks || '';
        
        const modal = new bootstrap.Modal(document.getElementById('editAdjustmentModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error loading adjustment:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

function deleteAdjustment(id) {
    fetch(`/api/inventory/adjustments/${id}`)
    .then(response => response.json())
    .then(adjustment => {
        const referenceId = adjustment.reference_id || 'N/A';
        
        Swal.fire({
            title: 'Delete Adjustment',
            html: `Are you sure you want to delete this inventory adjustment?<br><br>
                   <strong>Reference ID:</strong> ${referenceId}<br>
                   <strong>Date:</strong> ${adjustment.adjustment_date}<br>
                   <strong>Items:</strong> ${adjustment.items_count || 0}<br><br>
                   <em>This will reverse all stock changes and create reversal movements.</em>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel',
            focusCancel: true
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/inventory/adjustments/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Adjustment deleted and stock reversed successfully', 'success');
                        loadAdjustments();
                        loadProducts(); // Refresh product list to show updated stock
                    } else {
                        throw new Error(data.error || 'Failed to delete adjustment');
                    }
                })
                .catch(error => {
                    console.error('Error deleting adjustment:', error);
                    showToast(`Error: ${error.message}`, 'error');
                });
            }
        });
    })
    .catch(error => {
        console.error('Error fetching adjustment details:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

// View Product Modal Functions
function viewProduct(id) {
    fetch(`/api/inventory/product/${id}`)
    .then(response => response.json())
    .then(product => {
        if (product.error) {
            throw new Error(product.error);
        }
        
        // Populate view modal
        document.getElementById('viewProductSKU').textContent = product.sku || 'N/A';
        document.getElementById('viewProductName').textContent = product.name || 'N/A';
        document.getElementById('viewProductDescription').textContent = product.description || 'No description';
        document.getElementById('viewProductCategory').textContent = product.category || 'Uncategorized';
        document.getElementById('viewProductUnit').textContent = product.unit_of_measure || 'pcs';
        document.getElementById('viewProductCurrentStock').textContent = product.current_stock || 0;
        document.getElementById('viewProductReorderLevel').textContent = product.reorder_point || 0;
        document.getElementById('viewProductMinStock').textContent = product.min_stock_level || 0;
        document.getElementById('viewProductMaxStock').textContent = product.max_stock_level || 0;
        document.getElementById('viewProductCostPrice').textContent = `$${(product.cost_price || 0).toFixed(2)}`;
        document.getElementById('viewProductSellingPrice').textContent = `$${(product.selling_price || 0).toFixed(2)}`;
        document.getElementById('viewProductBarcode').textContent = product.barcode || 'N/A';
        document.getElementById('viewProductLocation').textContent = product.location || 'N/A';
        document.getElementById('viewProductStatus').textContent = (product.stock_status || 'unknown').replace('_', ' ').toUpperCase();
        document.getElementById('viewProductServiceItem').textContent = product.is_service_item ? 'Yes' : 'No';
        document.getElementById('viewProductRetailItem').textContent = product.is_retail_item ? 'Yes' : 'No';
        
        const modal = new bootstrap.Modal(document.getElementById('viewProductModal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error loading product:', error);
        showToast(`Error: ${error.message}`, 'error');
    });
}

// Save Category Functions
function saveEditCategory() {
    const form = document.getElementById('editCategoryForm');
    const formData = new FormData(form);
    const categoryId = document.getElementById('editCategoryId').value;
    
    // Add loading state to button
    const saveButton = document.querySelector('#editCategoryModal .btn-primary');
    const originalContent = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
    saveButton.disabled = true;
    
    fetch(`/api/inventory/categories/${categoryId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('editCategoryModal')).hide();
            location.reload(); // Refresh page since categories are server-rendered
        } else {
            throw new Error(data.error || 'Failed to update category');
        }
    })
    .catch(error => {
        console.error('Error updating category:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        // Reset button state
        saveButton.innerHTML = originalContent;
        saveButton.disabled = false;
    });
}

function saveEditConsumption() {
    const form = document.getElementById('editConsumptionForm');
    const formData = new FormData(form);
    const consumptionId = document.getElementById('editConsumptionId').value;
    
    // Add loading state to button
    const saveButton = document.querySelector('#editConsumptionModal .btn-primary');
    const originalContent = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
    saveButton.disabled = true;
    
    fetch(`/api/inventory/consumption/${consumptionId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('editConsumptionModal')).hide();
            loadConsumption(); // Refresh table
        } else {
            throw new Error(data.error || 'Failed to update consumption record');
        }
    })
    .catch(error => {
        console.error('Error updating consumption:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        // Reset button state
        saveButton.innerHTML = originalContent;
        saveButton.disabled = false;
    });
}

function saveEditAdjustment() {
    const form = document.getElementById('editAdjustmentForm');
    const formData = new FormData(form);
    const adjustmentId = document.getElementById('editAdjustmentId').value;
    
    // Add loading state to button
    const saveButton = document.querySelector('#editAdjustmentModal .btn-primary');
    const originalContent = saveButton.innerHTML;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
    saveButton.disabled = true;
    
    fetch(`/api/inventory/adjustments/${adjustmentId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('editAdjustmentModal')).hide();
            loadAdjustments(); // Refresh table
        } else {
            throw new Error(data.error || 'Failed to update adjustment');
        }
    })
    .catch(error => {
        console.error('Error updating adjustment:', error);
        showToast(`Error: ${error.message}`, 'error');
    })
    .finally(() => {
        // Reset button state
        saveButton.innerHTML = originalContent;
        saveButton.disabled = false;
    });
}
</script>

<!-- View Product Modal -->
<div class="modal fade" id="viewProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>SKU:</strong>
                        <p id="viewProductSKU" class="mb-0">N/A</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Product Name:</strong>
                        <p id="viewProductName" class="mb-0">N/A</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Description:</strong>
                        <p id="viewProductDescription" class="mb-0">No description</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Category:</strong>
                        <p id="viewProductCategory" class="mb-0">Uncategorized</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Unit of Measure:</strong>
                        <p id="viewProductUnit" class="mb-0">pcs</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <strong>Current Stock:</strong>
                        <p id="viewProductCurrentStock" class="mb-0">0</p>
                    </div>
                    <div class="col-md-4">
                        <strong>Reorder Level:</strong>
                        <p id="viewProductReorderLevel" class="mb-0">0</p>
                    </div>
                    <div class="col-md-4">
                        <strong>Status:</strong>
                        <p id="viewProductStatus" class="mb-0">UNKNOWN</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Min Stock Level:</strong>
                        <p id="viewProductMinStock" class="mb-0">0</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Max Stock Level:</strong>
                        <p id="viewProductMaxStock" class="mb-0">0</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Cost Price:</strong>
                        <p id="viewProductCostPrice" class="mb-0">$0.00</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Selling Price:</strong>
                        <p id="viewProductSellingPrice" class="mb-0">$0.00</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Barcode:</strong>
                        <p id="viewProductBarcode" class="mb-0">N/A</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Location:</strong>
                        <p id="viewProductLocation" class="mb-0">N/A</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Used in Services:</strong>
                        <p id="viewProductServiceItem" class="mb-0">No</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Retail Item:</strong>
                        <p id="viewProductRetailItem" class="mb-0">No</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- View Category Modal -->
<div class="modal fade" id="viewCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Category Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Category Name:</strong>
                    <p id="viewCategoryName" class="mb-0">N/A</p>
                </div>
                <div class="mb-3">
                    <strong>Description:</strong>
                    <p id="viewCategoryDescription" class="mb-0">No description</p>
                </div>
                <div class="mb-3">
                    <strong>Color:</strong>
                    <div class="d-flex align-items-center">
                        <div id="viewCategoryColorPreview" class="color-preview me-2" style="width: 20px; height: 20px; border-radius: 3px; display: inline-block;"></div>
                        <span id="viewCategoryColor">#000000</span>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Products Count:</strong>
                    <p id="viewCategoryProductCount" class="mb-0">0</p>
                </div>
                <div class="mb-3">
                    <strong>Status:</strong>
                    <p id="viewCategoryStatus" class="mb-0">Active</p>
                </div>
                <div class="mb-3">
                    <strong>Created Date:</strong>
                    <p id="viewCategoryCreatedDate" class="mb-0">N/A</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editCategoryForm">
                <div class="modal-body">
                    <input type="hidden" id="editCategoryId" name="category_id">
                    <div class="mb-3">
                        <label class="form-label">Category Name <span class="text-danger">*</span></label>
                        <input type="text" id="editCategoryName" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea id="editCategoryDescription" name="description" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <input type="color" id="editCategoryColor" name="color_code" class="form-control form-control-color">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" id="editCategoryActive" name="is_active" class="form-check-input" checked>
                            <label for="editCategoryActive" class="form-check-label">Active</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditCategory()">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Consumption Modal -->
<div class="modal fade" id="viewConsumptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Consumption Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Date:</strong>
                        <p id="viewConsumptionDate" class="mb-0">N/A</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Product:</strong>
                        <p id="viewConsumptionProduct" class="mb-0">N/A</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>SKU:</strong>
                        <p id="viewConsumptionSKU" class="mb-0">N/A</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Unit:</strong>
                        <p id="viewConsumptionUnit" class="mb-0">N/A</p>
                    </div>
                </div>
                <div class="mb-3">
                    <strong>Quantity Used:</strong>
                    <p id="viewConsumptionQuantity" class="mb-0">0</p>
                </div>
                <div class="mb-3">
                    <strong>Issued To:</strong>
                    <p id="viewConsumptionIssuedTo" class="mb-0">N/A</p>
                </div>
                <div class="mb-3">
                    <strong>Reference:</strong>
                    <p id="viewConsumptionReference" class="mb-0">N/A</p>
                </div>
                <div class="mb-3">
                    <strong>Notes:</strong>
                    <p id="viewConsumptionNotes" class="mb-0">No notes</p>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Created By:</strong>
                        <p id="viewConsumptionCreatedBy" class="mb-0">N/A</p>
                    </div>
                    <div class="col-md-6">
                        <strong>Created Date:</strong>
                        <p id="viewConsumptionCreatedDate" class="mb-0">N/A</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Consumption Modal -->
<div class="modal fade" id="editConsumptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Consumption</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editConsumptionForm">
                <div class="modal-body">
                    <input type="hidden" id="editConsumptionId" name="consumption_id">
                    <div class="mb-3">
                        <label class="form-label">Date <span class="text-danger">*</span></label>
                        <input type="date" id="editConsumptionDate" name="consumption_date" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Product <span class="text-danger">*</span></label>
                        <select id="editConsumptionProduct" name="product_id" class="form-select" required>
                            <option value="">Select Product</option>
                            <!-- Products will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Quantity Used <span class="text-danger">*</span></label>
                        <input type="number" id="editConsumptionQuantity" name="quantity_used" class="form-control" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Issued To <span class="text-danger">*</span></label>
                        <input type="text" id="editConsumptionIssuedTo" name="issued_to" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reference Document</label>
                        <input type="text" id="editConsumptionReference" name="reference_doc_no" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea id="editConsumptionNotes" name="notes" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEditConsumption()">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}