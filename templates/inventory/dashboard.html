{% extends "base.html" %}

{% block title %}Inventory Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-boxes me-2"></i>Inventory Management</h2>
                    <p class="text-muted mb-0">Comprehensive inventory control with stock tracking and order management</p>
                </div>
                <div>
                    <a href="{{ url_for('export_products') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-download me-1"></i>Export
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Critical Alerts -->
    {% if critical_alerts %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-danger border-0 shadow-sm">
                <h5 class="alert-heading mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>Critical Alerts
                </h5>
                <div class="row">
                    {% for alert in critical_alerts %}
                    <div class="col-md-6 mb-2">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-circle text-danger me-2" style="font-size: 8px;"></i>
                            <strong>{{ alert.product.name }}:</strong>
                            <span class="ms-1">{{ alert.message }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <a href="{{ url_for('inventory_alerts') }}" class="btn btn-sm btn-outline-danger">
                        View All Alerts
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tabbed Interface -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <!-- Tab Navigation -->
                <div class="card-header bg-transparent border-0 pb-0">
                    <ul class="nav nav-tabs border-0" id="inventoryTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="stock-levels-tab" data-bs-toggle="tab"
                                    data-bs-target="#stock-levels" type="button" role="tab"
                                    aria-controls="stock-levels" aria-selected="true">
                                <i class="fas fa-chart-bar me-2"></i>Stock Levels
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="product-master-tab" data-bs-toggle="tab"
                                    data-bs-target="#product-master" type="button" role="tab"
                                    aria-controls="product-master" aria-selected="false">
                                <i class="fas fa-boxes me-1"></i>Product Master
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="categories-tab" data-bs-toggle="tab"
                                    data-bs-target="#categories" type="button" role="tab"
                                    aria-controls="categories" aria-selected="false">
                                <i class="fas fa-tags me-2"></i>Category Management
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="orders-tab" data-bs-toggle="tab"
                                    data-bs-target="#orders" type="button" role="tab"
                                    aria-controls="orders" aria-selected="false">
                                <i class="fas fa-shopping-cart me-2"></i>Purchase Orders
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="consumption-tab" data-bs-toggle="tab"
                                    data-bs-target="#consumption" type="button" role="tab"
                                    aria-controls="consumption" aria-selected="false">
                                <i class="fas fa-minus-circle me-2"></i>Consumption
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Tab Content -->
                <div class="card-body">
                    <div class="tab-content" id="inventoryTabContent">

                        <!-- Stock Levels Tab -->
                        <div class="tab-pane fade show active" id="stock-levels" role="tabpanel" aria-labelledby="stock-levels-tab">

                            <!-- Statistics Cards -->
                            <div class="row mb-4">
                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                                                        <i class="fas fa-cube text-primary fa-2x"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <p class="text-muted mb-1 small">Total Products</p>
                                                    <h3 class="mb-0">{{ stats.total_products }}</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="bg-warning bg-opacity-10 rounded-3 p-3">
                                                        <i class="fas fa-exclamation-triangle text-warning fa-2x"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <p class="text-muted mb-1 small">Low Stock Items</p>
                                                    <h3 class="mb-0 text-warning">{{ stats.low_stock_count }}</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="bg-danger bg-opacity-10 rounded-3 p-3">
                                                        <i class="fas fa-times-circle text-danger fa-2x"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <p class="text-muted mb-1 small">Out of Stock</p>
                                                    <h3 class="mb-0 text-danger">{{ stats.out_of_stock_count }}</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-3 col-md-6 mb-3">
                                    <div class="card border-0 shadow-sm h-100">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="bg-success bg-opacity-10 rounded-3 p-3">
                                                        <i class="fas fa-dollar-sign text-success fa-2x"></i>
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 ms-3">
                                                    <p class="text-muted mb-1 small">Total Value</p>
                                                    <h3 class="mb-0 text-success">${{ "%.2f"|format(stats.total_value) }}</h3>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Stock Movements -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header bg-transparent border-0 pb-0">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h5 class="mb-0">Recent Stock Movements</h5>
                                                <a href="{{ url_for('stock_movements') }}" class="btn btn-sm btn-outline-secondary">
                                                    View All
                                                </a>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            {% if recent_movements %}
                                            <div class="list-group list-group-flush">
                                                {% for movement in recent_movements %}
                                                <div class="list-group-item border-0 px-0">
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0">
                                                            {% if movement.movement_type == 'in' %}
                                                            <i class="fas fa-arrow-up text-success"></i>
                                                            {% elif movement.movement_type == 'out' %}
                                                            <i class="fas fa-arrow-down text-danger"></i>
                                                            {% else %}
                                                            <i class="fas fa-edit text-warning"></i>
                                                            {% endif %}
                                                        </div>
                                                        <div class="flex-grow-1 ms-3">
                                                            <div class="fw-medium">{{ movement.product.name }}</div>
                                                            <small class="text-muted">
                                                                {{ movement.reason or 'Stock movement' }} •
                                                                {{ movement.created_at.strftime('%m/%d/%H:%M') }}
                                                            </small>
                                                        </div>
                                                        <div class="flex-shrink-0">
                                                            <span class="badge bg-light text-dark">
                                                                {% if movement.movement_type == 'in' %}+{% elif movement.movement_type == 'out' %}-{% endif %}{{ movement.quantity }}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% else %}
                                            <div class="text-center text-muted py-4">
                                                <i class="fas fa-history fa-2x mb-3 opacity-50"></i>
                                                <p class="mb-0">No recent stock movements</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Product Master Tab -->
                        <div class="tab-pane fade" id="product-master" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>Product Master</h5>
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                                            <i class="fas fa-plus me-1"></i>Add Product
                                        </button>
                                    </div>

                                    <!-- Filters -->
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" id="searchProducts" placeholder="Search products...">
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="filterCategory">
                                                <option value="">All Categories</option>
                                                {% for category in categories %}
                                                <option value="{{ category.name }}">{{ category.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="filterStatus">
                                                <option value="">All Status</option>
                                                <option value="in_stock">In Stock</option>
                                                <option value="low_stock">Low Stock</option>
                                                <option value="out_of_stock">Out of Stock</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                                <i class="fas fa-undo me-1"></i>Clear
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Products Table -->
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="productsTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>SKU</th>
                                                    <th>Product Name</th>
                                                    <th>Category</th>
                                                    <th>Unit of Measure</th>
                                                    <th>Stock</th>
                                                    <th>Reorder Level</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productMasterTableBody">
                                                <!-- Products will be loaded via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Category Management Tab -->
                        <div class="tab-pane fade" id="categories" role="tabpanel" aria-labelledby="categories-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Category Management</h5>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                    <i class="fas fa-plus me-1"></i>Add Category
                                </button>
                            </div>

                            {% if categories %}
                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Color</th>
                                            <th>Name</th>
                                            <th>Description</th>
                                            <th>Products</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category in categories %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge rounded-pill me-2"
                                                          style="background-color: {{ category.color_code }}; width: 20px; height: 20px;">&nbsp;</span>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="fw-medium">{{ category.name }}</div>
                                            </td>
                                            <td>
                                                <span class="text-muted">{{ category.description or 'No description' }}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-light text-dark">
                                                    {{ category.products|length }} products
                                                </span>
                                            </td>
                                            <td>
                                                {% if category.is_active %}
                                                <span class="badge bg-success">Active</span>
                                                {% else %}
                                                <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ category.created_at.strftime('%m/%d/%Y') }}</small>
                                            </td>
                                            <td>
                                                <div class="d-flex justify-content-end gap-1">
                                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                                            onclick="editCategory({{ category.id }}, '{{ category.name }}', '{{ category.description or '' }}', '{{ category.color_code }}')"
                                                            title="Edit Category">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    {% if category.products|length == 0 %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                                            onclick="deleteCategory({{ category.id }}, '{{ category.name }}')"
                                                            title="Delete Category">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% else %}
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" disabled
                                                            title="Cannot delete - has associated products">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">No Categories Found</h5>
                                <p class="text-muted">Start organizing your inventory by creating categories.</p>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
                                    <i class="fas fa-plus me-1"></i>Create First Category
                                </button>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Purchase Management Tab -->
                        <div class="tab-pane fade" id="purchase" role="tabpanel" aria-labelledby="purchase-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Purchase Management</h5>
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPurchaseModal">
                                    <i class="fas fa-plus me-1"></i>Create Purchase Order
                                </button>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>PO Number</th>
                                            <th>Supplier</th>
                                            <th>Items</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Created</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if purchase_orders %}
                                        {% for order in purchase_orders %}
                                        <tr>
                                            <td>
                                                <div class="fw-medium">{{ order.po_number }}</div>
                                            </td>
                                            <td>{{ order.supplier.name if order.supplier else 'No supplier' }}</td>
                                            <td>
                                                <span class="badge bg-light text-dark">{{ order.items|length }} items</span>
                                            </td>
                                            <td>${{ "%.2f"|format(order.total_amount) }}</td>
                                            <td>
                                                {% if order.status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                                {% elif order.status == 'sent' %}
                                                <span class="badge bg-info">Sent</span>
                                                {% elif order.status == 'received' %}
                                                <span class="badge bg-success">Received</span>
                                                {% else %}
                                                <span class="badge bg-secondary">{{ order.status|title }}</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ order.created_at.strftime('%m/%d/%Y') }}</small>
                                            </td>
                                            <td>
                                                <div class="d-flex justify-content-end gap-1">
                                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                                            title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    {% if order.status == 'pending' %}
                                                    <button type="button" class="btn btn-sm btn-outline-success"
                                                            title="Mark as Sent">
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                        {% else %}
                                        <tr>
                                            <td colspan="7" class="text-center py-4 text-muted">
                                                <i class="fas fa-shopping-cart fa-2x mb-3 opacity-50"></i>
                                                <p class="mb-0">No purchase orders found</p>
                                            </td>
                                        </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Orders Tab -->
                        <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Order Management</h5>
                                <div>
                                    <button type="button" class="btn btn-outline-secondary me-2">
                                        <i class="fas fa-filter me-1"></i>Filter
                                    </button>
                                    <button type="button" class="btn btn-primary">
                                        <i class="fas fa-plus me-1"></i>New Order
                                    </button>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Customer</th>
                                            <th>Items</th>
                                            <th>Total</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="7" class="text-center py-4 text-muted">
                                                <i class="fas fa-clipboard-list fa-2x mb-3 opacity-50"></i>
                                                <p class="mb-0">Order management coming soon</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Consumption Tab -->
                        <div class="tab-pane fade" id="consumption" role="tabpanel" aria-labelledby="consumption-tab">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0">Consumption Management</h5>
                                <div>
                                    <div class="input-group me-3" style="width: 250px;">
                                        <input type="text" id="consumptionSearch" class="form-control" placeholder="Search consumption...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="searchConsumption()">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-outline-success me-2" onclick="exportConsumption()">
                                        <i class="fas fa-download me-1"></i>Export CSV
                                    </button>
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addConsumptionModal">
                                        <i class="fas fa-plus me-1"></i>Record Consumption
                                    </button>
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover align-middle" id="consumptionTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Item</th>
                                            <th>Quantity Used</th>
                                            <th>Unit</th>
                                            <th>Issued To</th>
                                            <th>Reference/Doc No.</th>
                                            <th>Notes</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="consumptionTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center py-4 text-muted">
                                                <div class="spinner-border" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mb-0 mt-2">Loading consumption records...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <nav aria-label="Consumption pagination">
                                <ul class="pagination justify-content-center" id="consumptionPagination">
                                    <!-- Pagination will be generated by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProductForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">SKU <span class="text-danger">*</span></label>
                            <input type="text" name="sku" class="form-control" required>
                            <div class="invalid-feedback">SKU is required.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Product Name <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control" required>
                            <div class="invalid-feedback">Product name is required.</div>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category</label>
                            <select name="category_id" class="form-select">
                                <option value="">Select category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Unit of Measure</label>
                            <select name="unit_of_measure" class="form-select">
                                <option value="pcs">Pieces</option>
                                <option value="kg">Kilograms</option>
                                <option value="g">Grams</option>
                                <option value="l">Liters</option>
                                <option value="ml">Milliliters</option>
                                <option value="box">Boxes</option>
                                <option value="bottle">Bottles</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Initial Stock</label>
                            <input type="number" name="current_stock" class="form-control" value="0" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Reorder Level</label>
                            <input type="number" name="reorder_point" class="form-control" value="20" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Min Stock Level</label>
                            <input type="number" name="min_stock_level" class="form-control" value="10" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Stock Level</label>
                            <input type="number" name="max_stock_level" class="form-control" value="100" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cost Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" name="cost_price" class="form-control" value="0" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Selling Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" name="selling_price" class="form-control" value="0" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Barcode</label>
                            <input type="text" name="barcode" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Storage Location</label>
                            <input type="text" name="location" class="form-control">
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_service_item" id="isServiceItem">
                                <label class="form-check-label" for="isServiceItem">Used in Services</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_retail_item" id="isRetailItem">
                                <label class="form-check-label" for="isRetailItem">Retail Product</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProductForm">
                <div class="modal-body">
                    <input type="hidden" name="product_id" id="editProductId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">SKU</label>
                            <input type="text" name="sku" id="editSku" class="form-control" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Product Name <span class="text-danger">*</span></label>
                            <input type="text" name="name" id="editName" class="form-control" required>
                            <div class="invalid-feedback">Product name is required.</div>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="description" id="editDescription" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category</label>
                            <select name="category_id" id="editCategoryId" class="form-select">
                                <option value="">Select category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Unit of Measure</label>
                            <select name="unit_of_measure" id="editUnitOfMeasure" class="form-select">
                                <option value="pcs">Pieces</option>
                                <option value="kg">Kilograms</option>
                                <option value="g">Grams</option>
                                <option value="l">Liters</option>
                                <option value="ml">Milliliters</option>
                                <option value="box">Boxes</option>
                                <option value="bottle">Bottles</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Reorder Level</label>
                            <input type="number" name="reorder_point" id="editReorderPoint" class="form-control" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Min Stock Level</label>
                            <input type="number" name="min_stock_level" id="editMinStockLevel" class="form-control" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Max Stock Level</label>
                            <input type="number" name="max_stock_level" id="editMaxStockLevel" class="form-control" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cost Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" name="cost_price" id="editCostPrice" class="form-control" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Selling Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" name="selling_price" id="editSellingPrice" class="form-control" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Barcode</label>
                            <input type="text" name="barcode" id="editBarcode" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Storage Location</label>
                            <input type="text" name="location" id="editLocation" class="form-control">
                        </div>
                        <div class="col-12">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_service_item" id="editIsServiceItem">
                                <label class="form-check-label" for="editIsServiceItem">Used in Services</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_retail_item" id="editIsRetailItem">
                                <label class="form-check-label" for="editIsRetailItem">Retail Product</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Add New Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_inventory_category') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="categoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="categoryName" name="name" required>
                        <div class="invalid-feedback">Category name is required.</div>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="categoryDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="categoryColor" class="form-label">Color</label>
                        <input type="color" class="form-control form-control-color" id="categoryColor" name="color_code" value="#007bff">
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Category Modal -->
<div class="modal fade" id="editCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Edit Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editCategoryForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editCategoryName" class="form-label">Category Name</label>
                        <input type="text" class="form-control" id="editCategoryName" name="name" required>
                        <div class="invalid-feedback">Category name is required.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editCategoryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editCategoryDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editCategoryColor" class="form-label">Color</label>
                        <input type="color" class="form-control form-control-color" id="editCategoryColor" name="color_code">
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Category Modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Delete Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                    <h6>Are you sure you want to delete this category?</h6>
                    <p class="text-muted">
                        <strong id="deleteCategoryName"></strong><br>
                        This action cannot be undone.
                    </p>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteCategory()">Delete Category</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Purchase Order Modal -->
<div class="modal fade" id="addPurchaseModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Create Purchase Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center py-4 text-muted">
                    <i class="fas fa-shopping-cart fa-3x mb-3 opacity-50"></i>
                    <p class="mb-0">Purchase order creation form coming soon</p>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Consumption Modal -->
<div class="modal fade" id="addConsumptionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Record Consumption</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addConsumptionForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="consumptionProduct" class="form-label">Product</label>
                        <select class="form-select" id="consumptionProduct" name="product_id" required>
                            <option value="">Select Product...</option>
                        </select>
                        <div class="invalid-feedback">Please select a product.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="consumptionDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="consumptionDate" name="consumption_date" required>
                                <div class="invalid-feedback">Please enter the consumption date.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="consumptionQuantity" class="form-label">Quantity Used</label>
                                <input type="number" step="0.01" min="0.01" class="form-control" id="consumptionQuantity" name="quantity_used" required>
                                <div class="invalid-feedback">Please enter a valid quantity.</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="consumptionIssuedTo" class="form-label">Issued To</label>
                        <input type="text" class="form-control" id="consumptionIssuedTo" name="issued_to" placeholder="Department/Project/Person" required>
                        <div class="invalid-feedback">Please specify who the item was issued to.</div>
                    </div>
                    <div class="mb-3">
                        <label for="consumptionReference" class="form-label">Reference/Doc No.</label>
                        <input type="text" class="form-control" id="consumptionReference" name="reference_doc_no" placeholder="Optional reference number">
                    </div>
                    <div class="mb-3">
                        <label for="consumptionNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="consumptionNotes" name="notes" rows="3" placeholder="Additional notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Record Consumption</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Consumption Modal -->
<div class="modal fade" id="editConsumptionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Edit Consumption</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editConsumptionForm">
                <div class="modal-body">
                    <input type="hidden" name="consumption_id" id="editConsumptionId">
                    <div class="mb-3">
                        <label for="editConsumptionProduct" class="form-label">Product</label>
                        <select class="form-select" id="editConsumptionProduct" name="product_id" required>
                            <option value="">Select Product...</option>
                        </select>
                        <div class="invalid-feedback">Please select a product.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editConsumptionDate" class="form-label">Date</label>
                                <input type="date" class="form-control" id="editConsumptionDate" name="consumption_date" required>
                                <div class="invalid-feedback">Please enter the consumption date.</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editConsumptionQuantity" class="form-label">Quantity Used</label>
                                <input type="number" step="0.01" min="0.01" class="form-control" id="editConsumptionQuantity" name="quantity_used" required>
                                <div class="invalid-feedback">Please enter a valid quantity.</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editConsumptionIssuedTo" class="form-label">Issued To</label>
                        <input type="text" class="form-control" id="editConsumptionIssuedTo" name="issued_to" placeholder="Department/Project/Person" required>
                        <div class="invalid-feedback">Please specify who the item was issued to.</div>
                    </div>
                    <div class="mb-3">
                        <label for="editConsumptionReference" class="form-label">Reference/Doc No.</label>
                        <input type="text" class="form-control" id="editConsumptionReference" name="reference_doc_no" placeholder="Optional reference number">
                    </div>
                    <div class="mb-3">
                        <label for="editConsumptionNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editConsumptionNotes" name="notes" rows="3" placeholder="Additional notes"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Consumption</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Consumption Modal -->
<div class="modal fade" id="deleteConsumptionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Delete Consumption Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                    <h6>Are you sure you want to delete this consumption record?</h6>
                    <p class="text-muted">
                        <strong id="deleteConsumptionDetails"></strong><br>
                        This action will restore the stock level and cannot be undone.
                    </p>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteConsumption()">Delete Record</button>
            </div>
        </div>
    </div>
</div>

<script>
    let allProducts = [];
    let currentPage = 1;
    let currentSearch = '';
    let editingConsumptionId = null; // Variable to store the ID of the consumption record being edited
    let deletingConsumptionId = null; // Variable to store the ID of the consumption record being deleted

    // Initialize Product Master functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Load products for consumption dropdown on initial load
        loadProductsForConsumption();

        // Handle Product Master tab showing to load products if not already loaded
        document.getElementById('product-master-tab').addEventListener('shown.bs.tab', function() {
            // Check if products are already loaded to avoid redundant fetches
            const tbody = document.getElementById('productMasterTableBody');
            if (tbody && tbody.children.length === 0) {
                loadProducts();
            }
        });

        // Reset edit modal when hidden
        const editProductModal = document.getElementById('editProductModal');
        if (editProductModal) {
            editProductModal.addEventListener('hidden.bs.modal', function() {
                const editForm = document.getElementById('editProductForm');
                const submitButton = editForm.querySelector('button[type="submit"]');

                // Reset form state
                editForm.classList.remove('was-validated');
                editForm.reset();

                // Reset button state
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Update Product';
                    delete submitButton.dataset.originalText;
                }

                // Clear validation feedback
                const inputs = editForm.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.classList.remove('is-invalid', 'is-valid');
                });

                const invalidFeedbacks = editForm.querySelectorAll('.invalid-feedback');
                invalidFeedbacks.forEach(feedback => feedback.style.display = 'none');
            });
        }

        // Add product form submission handler
        const addProductForm = document.getElementById('addProductForm');
        if (addProductForm) {
            addProductForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Bootstrap validation
                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                const formData = new FormData(this);

                // Ensure numeric fields are not empty, default to 0 if they are
                const numericFields = ['current_stock', 'min_stock_level', 'max_stock_level', 'reorder_point', 'cost_price', 'selling_price'];
                numericFields.forEach(field => {
                    const value = formData.get(field);
                    if (value === '' || isNaN(value)) {
                        formData.set(field, '0');
                    }
                });

                fetch('/inventory/products/add', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
                        modal.hide();
                        this.reset(); // Clear form
                        this.classList.remove('was-validated'); // Reset validation state
                        loadProducts(); // Reload the Product Master table
                        showToast(data.message || 'Product added successfully', 'success');
                    } else {
                        showToast(data.error || 'Error adding product', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast(`Error adding product: ${error.message}`, 'danger');
                });
            });
        }

        // Edit product form submission handler
        const editProductForm = document.getElementById('editProductForm');
        if (editProductForm) {
            editProductForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const submitButton = this.querySelector('button[type="submit"]');

                // Prevent double submission
                if (submitButton && submitButton.disabled) {
                    return;
                }

                // Bootstrap validation
                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                const formData = new FormData(this);
                const productId = document.getElementById('editProductId').value;

                // Show loading state
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.dataset.originalText = submitButton.innerHTML;
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
                }

                // Ensure numeric fields have valid values
                const numericFields = ['min_stock_level', 'max_stock_level', 'reorder_point', 'cost_price', 'selling_price'];
                numericFields.forEach(field => {
                    const value = formData.get(field);
                    if (value === '' || isNaN(value)) {
                        const defaultValues = {
                            'min_stock_level': '10',
                            'max_stock_level': '100',
                            'reorder_point': '20',
                            'cost_price': '0',
                            'selling_price': '0'
                        };
                        formData.set(field, defaultValues[field]);
                    }
                });

                fetch(`/inventory/products/${productId}/edit`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error(text || 'Server error'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editProductModal'));
                        modal.hide();
                        loadProducts();
                        showToast(data.message || 'Product updated successfully', 'success');
                    } else {
                        showToast(data.error || 'Error updating product', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast(`Error updating product: ${error.message}`, 'danger');
                })
                .finally(() => {
                    // Reset button state regardless of success or failure
                    if (submitButton) {
                        submitButton.disabled = false;
                        if (submitButton.dataset.originalText) {
                            submitButton.innerHTML = submitButton.dataset.originalText;
                            delete submitButton.dataset.originalText;
                        } else {
                            submitButton.innerHTML = 'Update Product';
                        }
                    }
                });
            });
        }

        // Search and filter handlers for Product Master
        document.getElementById('searchProducts').addEventListener('input', filterProducts);
        document.getElementById('filterCategory').addEventListener('change', filterProducts);
        document.getElementById('filterStatus').addEventListener('change', filterProducts);

        // Add consumption form submission handler
        const addConsumptionForm = document.getElementById('addConsumptionForm');
        if (addConsumptionForm) {
            addConsumptionForm.addEventListener('submit', function(e) {
                e.preventDefault();

                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                const formData = new FormData(this);

                fetch('/inventory/consumption/add', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addConsumptionModal'));
                        modal.hide();
                        this.reset(); // Clear form
                        this.classList.remove('was-validated'); // Reset validation state
                        document.getElementById('consumptionDate').value = new Date().toISOString().split('T')[0]; // Reset date
                        loadConsumptionRecords(currentPage, currentSearch); // Reload current view
                        showToast(data.message || 'Consumption recorded successfully', 'success');
                    } else {
                        showToast(data.error || 'Error adding consumption record', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast(`Error adding consumption record: ${error.message}`, 'danger');
                });
            });
        }

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });

    // Load products for the Product Master table
    function loadProducts() {
        fetch('/api/inventory/products/master')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                allProducts = data; // Store all products for filtering
                displayProducts(data);
            })
            .catch(error => {
                console.error('Error loading products:', error);
                const tbody = document.getElementById('productMasterTableBody');
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Error loading products. Please try again later.</td></tr>';
            });
    }

    // Display products in the table, applying filters
    function displayProducts(products) {
        const tbody = document.getElementById('productMasterTableBody');
        tbody.innerHTML = '';

        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No products found.</td></tr>';
            return;
        }

        products.forEach(product => {
            const statusBadgeClass = getStatusClass(product.status);
            const statusText = getStatusText(product.status);
            const categoryDisplay = product.category ?
                `<span class="badge" style="background-color: ${product.category_color};">${product.category}</span>` :
                '<span class="text-muted">-</span>';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.sku}</td>
                <td>${product.name}</td>
                <td>${categoryDisplay}</td>
                <td>${product.unit_of_measure}</td>
                <td>${product.current_stock}</td>
                <td>${product.reorder_level}</td>
                <td><span class="badge ${statusBadgeClass}">${statusText}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editProduct(${product.id})"
                                title="Edit Product" data-bs-toggle="tooltip">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteProduct(${product.id})"
                                title="Delete Product" data-bs-toggle="tooltip">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Re-initialize tooltips after updating table content
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    }

    // Helper function to get status badge class
    function getStatusClass(status) {
        switch(status) {
            case 'out_of_stock': return 'bg-danger';
            case 'low_stock': return 'bg-warning';
            case 'reorder_needed': return 'bg-info';
            case 'in_stock': return 'bg-success';
            default: return 'bg-secondary';
        }
    }

    // Helper function to get status text
    function getStatusText(status) {
        switch(status) {
            case 'out_of_stock': return 'Out of Stock';
            case 'low_stock': return 'Low Stock';
            case 'reorder_needed': return 'Reorder';
            case 'in_stock': return 'In Stock';
            default: return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()); // Capitalize first letter of each word
        }
    }

    // Filter products based on search term and dropdown selections
    function filterProducts() {
        const searchTerm = document.getElementById('searchProducts').value.toLowerCase().trim();
        const categoryFilter = document.getElementById('filterCategory').value;
        const statusFilter = document.getElementById('filterStatus').value;

        let filteredProducts = allProducts.filter(product => {
            const matchesSearch = product.name.toLowerCase().includes(searchTerm) ||
                                product.sku.toLowerCase().includes(searchTerm);
            // Ensure category comparison is case-insensitive and handles empty filter
            const matchesCategory = !categoryFilter || (product.category && product.category.toLowerCase() === categoryFilter.toLowerCase());
            // Ensure status comparison matches the filter value directly
            const matchesStatus = !statusFilter || product.status === statusFilter;

            return matchesSearch && matchesCategory && matchesStatus;
        });

        displayProducts(filteredProducts);
    }

    // Clear search and filter inputs
    function clearFilters() {
        document.getElementById('searchProducts').value = '';
        document.getElementById('filterCategory').value = '';
        document.getElementById('filterStatus').value = '';
        loadProducts(); // Reload with original unfiltered data
    }

    // Populate edit product modal with product details
    function editProduct(id) {
        fetch(`/api/inventory/product/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(product => {
                if (product.error) {
                    throw new Error(product.error);
                }

                // Get the form and submit button
                const editForm = document.getElementById('editProductForm');
                const submitButton = editForm.querySelector('button[type="submit"]');

                // Reset form validation state completely
                editForm.classList.remove('was-validated');
                editForm.reset(); // Clear all form data first

                // Reset submit button state
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'Update Product';
                    delete submitButton.dataset.originalText;
                }

                // Clear any existing validation feedback
                const invalidFeedbacks = editForm.querySelectorAll('.invalid-feedback');
                invalidFeedbacks.forEach(feedback => feedback.style.display = 'none');

                // Remove validation classes from all inputs
                const inputs = editForm.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    input.classList.remove('is-invalid', 'is-valid');
                });

                // Now populate with product data
                document.getElementById('editProductId').value = product.id || '';
                document.getElementById('editSku').value = product.sku || '';
                document.getElementById('editName').value = product.name || '';
                document.getElementById('editDescription').value = product.description || '';
                document.getElementById('editCategoryId').value = product.category_id || '';
                document.getElementById('editUnitOfMeasure').value = product.unit_of_measure || 'pcs';
                document.getElementById('editReorderPoint').value = product.reorder_point !== undefined ? product.reorder_point : 20;
                document.getElementById('editMinStockLevel').value = product.min_stock_level !== undefined ? product.min_stock_level : 10;
                document.getElementById('editMaxStockLevel').value = product.max_stock_level !== undefined ? product.max_stock_level : 100;
                document.getElementById('editCostPrice').value = product.cost_price !== undefined ? product.cost_price : 0;
                document.getElementById('editSellingPrice').value = product.selling_price !== undefined ? product.selling_price : 0;
                document.getElementById('editBarcode').value = product.barcode || '';
                document.getElementById('editLocation').value = product.location || '';
                document.getElementById('editIsServiceItem').checked = product.is_service_item || false;
                document.getElementById('editIsRetailItem').checked = product.is_retail_item || false;

                const editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
                editModal.show();
            })
            .catch(error => {
                console.error('Error loading product:', error);
                showToast(`Error loading product details: ${error.message}`, 'danger');
            });
    }

    // Handle product deletion
    function deleteProduct(id) {
        // First fetch product details to show the product name in confirmation
        fetch(`/api/inventory/product/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch product details');
                }
                return response.json();
            })
            .then(product => {
                // Show confirmation dialog with product name
                Swal.fire({
                    title: 'Delete Product?',
                    html: `Are you sure you want to delete <strong>"${product.name}"</strong>?<br><small class="text-muted">This action cannot be undone!</small>`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'Cancel',
                    focusCancel: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Proceed with deletion
                        fetch(`/inventory/products/${id}/delete`, {
                            method: 'POST'
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                // Reload the products table to reflect changes
                                loadProducts();
                                // Show success message
                                showToast(data.message || `Product "${product.name}" deleted successfully`, 'success');
                            } else {
                                showToast(data.error || 'Error deleting product', 'danger');
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting product:', error);
                            showToast(`Error deleting product: ${error.message}`, 'danger');
                        });
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching product details:', error);
                // Fallback to simple confirmation if we can't get product details
                Swal.fire({
                    title: 'Delete Product?',
                    text: 'Are you sure you want to delete this product? This action cannot be undone!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, delete it!',
                    cancelButtonText: 'Cancel',
                    focusCancel: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Proceed with deletion
                        fetch(`/inventory/products/${id}/delete`, {
                            method: 'POST'
                        })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                loadProducts();
                                showToast(data.message || 'Product deleted successfully', 'success');
                            } else {
                                showToast(data.error || 'Error deleting product', 'danger');
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting product:', error);
                            showToast(`Error deleting product: ${error.message}`, 'danger');
                        });
                    }
                });
            });
    }

    // Load products for dropdowns (e.g., in consumption forms)
    function loadProductsForConsumption() {
        fetch('/api/inventory/products/for-consumption')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(products => {
                const select = document.getElementById('consumptionProduct');
                select.innerHTML = '<option value="">Select a product</option>'; // Reset options

                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (${product.sku}) - ${product.current_stock} ${product.unit_of_measure}`;
                    option.dataset.unitOfMeasure = product.unit_of_measure; // Store unit for potential use
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading products for consumption:', error);
                showToast('Failed to load products for consumption.', 'danger');
            });
    }

    // Populate edit consumption modal
    function editConsumption(id) {
        editingConsumptionId = id; // Store the ID of the consumption record to edit

        fetch(`/api/inventory/consumption/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('editConsumptionId').value = data.id || '';
                document.getElementById('editConsumptionProduct').value = data.product_id || '';
                document.getElementById('editConsumptionDate').value = data.consumption_date || '';
                document.getElementById('editConsumptionQuantity').value = data.quantity_used || '';
                document.getElementById('editConsumptionIssuedTo').value = data.issued_to || '';
                document.getElementById('editConsumptionReference').value = data.reference_doc_no || '';
                document.getElementById('editConsumptionNotes').value = data.notes || '';

                // Reset validation state for the form
                const editForm = document.getElementById('editConsumptionForm');
                editForm.classList.remove('was-validated');

                const modal = new bootstrap.Modal(document.getElementById('editConsumptionModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading consumption record:', error);
                showToast('Error loading consumption record', 'danger');
            });
    }

    // Show delete confirmation modal for consumption record
    function deleteConsumption(id) {
        deletingConsumptionId = id; // Store the ID of the consumption record to delete

        // Fetch product details to display in the confirmation modal
        fetch(`/api/inventory/consumption/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const productName = data.product_name || 'the record';
                const date = data.consumption_date ? new Date(data.consumption_date).toLocaleDateString() : '';
                document.getElementById('deleteConsumptionDetails').textContent = `${productName}${date ? ' on ' + date : ''}`;
                const modal = new bootstrap.Modal(document.getElementById('deleteConsumptionModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error fetching consumption details for deletion:', error);
                // If fetching fails, proceed with a generic message
                document.getElementById('deleteConsumptionDetails').textContent = 'this record';
                const modal = new bootstrap.Modal(document.getElementById('deleteConsumptionModal'));
                modal.show();
            });
    }

    // Confirm and execute deletion of a consumption record
    function confirmDeleteConsumption() {
        fetch(`/inventory/consumption/${deletingConsumptionId}/delete`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Server error'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('deleteConsumptionModal')).hide();
                loadConsumptionRecords(currentPage, currentSearch); // Reload current view
                showToast('Consumption record deleted successfully', 'success');
            } else {
                showToast(data.error || 'Error deleting consumption record', 'danger');
            }
        })
        .catch(error => {
            console.error('Error deleting consumption record:', error);
            showToast(`Error deleting consumption record: ${error.message}`, 'danger');
        });
    }

    // Load consumption records with pagination and search
    function loadConsumptionRecords(page = 1, search = '') {
        currentPage = page;
        currentSearch = search;

        const tbody = document.getElementById('consumptionTableBody');
        // Display loading indicator
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span class="ms-2">Loading consumption records...</span>
                </td>
            </tr>
        `;

        fetch(`/inventory/consumption?page=${page}&search=${encodeURIComponent(search)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                renderConsumptionTable(data.records);
                renderConsumptionPagination(data.pagination);
            })
            .catch(error => {
                console.error('Error loading consumption records:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center py-4 text-muted">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3 opacity-50"></i>
                            <p class="mb-0">Error loading consumption records. Please try again.</p>
                        </td>
                    </tr>
                `;
            });
    }

    // Render the consumption data table
    function renderConsumptionTable(records) {
        const tbody = document.getElementById('consumptionTableBody');

        if (records.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4 text-muted">
                        <i class="fas fa-database fa-2x mb-2 opacity-50"></i>
                        <p class="mb-0">No consumption records found.</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = records.map(record => `
            <tr>
                <td>${record.consumption_date}</td>
                <td>
                    <div class="fw-medium">${record.product_name}</div>
                    <small class="text-muted">SKU: ${record.product_sku}</small>
                </td>
                <td>${record.quantity_used}</td>
                <td>${record.unit_of_measure}</td>
                <td>${record.issued_to}</td>
                <td>${record.reference_doc_no || '-'}</td>
                <td>
                    <span class="text-muted">${record.notes ? (record.notes.length > 30 ? record.notes.substring(0, 30) + '...' : record.notes) : '-'}</span>
                </td>
                <td>
                    <div class="d-flex justify-content-end gap-1">
                        <button type="button" class="btn btn-sm btn-outline-primary"
                                onclick="editConsumption(${record.id})"
                                title="Edit Consumption Record" data-bs-toggle="tooltip">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger"
                                onclick="deleteConsumption(${record.id})"
                                title="Delete Consumption Record" data-bs-toggle="tooltip">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

        // Re-initialize tooltips after updating table content
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    }

    // Render pagination links for consumption records
    function renderConsumptionPagination(pagination) {
        const paginationEl = document.getElementById('consumptionPagination');

        if (pagination.pages <= 1) {
            paginationEl.innerHTML = ''; // Hide pagination if only one page
            return;
        }

        let paginationHTML = '';

        // Previous button
        if (pagination.has_prev) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="loadConsumptionRecords(${pagination.page - 1}, '${currentSearch}')">Previous</a>
                </li>
            `;
        }

        // Page numbers
        const startPage = Math.max(1, pagination.page - 2);
        const endPage = Math.min(pagination.pages, pagination.page + 2);

        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === pagination.page ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadConsumptionRecords(${i}, '${currentSearch}')">${i}</a>
                </li>
            `;
        }

        // Next button
        if (pagination.has_next) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="loadConsumptionRecords(${pagination.page + 1}, '${currentSearch}')">Next</a>
                </li>
            `;
        }

        paginationEl.innerHTML = paginationHTML;
    }

    // Trigger search for consumption records
    function searchConsumption() {
        const searchTerm = document.getElementById('consumptionSearch').value;
        loadConsumptionRecords(1, searchTerm); // Reload from the first page with the new search term
    }

    // Export consumption data to CSV
    function exportConsumption() {
        const search = document.getElementById('consumptionSearch').value;
        window.open(`/inventory/consumption/export?search=${encodeURIComponent(search)}`, '_blank');
    }


    // Tab persistence and initialization
    document.addEventListener('DOMContentLoaded', function() {
        // Set today's date as default for consumption form
        const today = new Date().toISOString().split('T')[0];
        if (document.getElementById('consumptionDate')) {
            document.getElementById('consumptionDate').value = today;
        }

        // Load products for dropdowns
        loadProductsForConsumption();

        // Get the active tab from URL hash or localStorage, default to stock-levels
        const activeTabHash = window.location.hash || localStorage.getItem('inventoryActiveTab');
        const defaultTab = '#stock-levels';
        const targetTab = activeTabHash || defaultTab;

        // Show the correct tab if it's not the default one
        if (targetTab && targetTab !== defaultTab) {
            const tabButton = document.querySelector(`button[data-bs-target="${targetTab}"]`);
            if (tabButton) {
                bootstrap.Tab.getOrCreateInstance(tabButton).show();
            } else {
                // If the hash is invalid or button not found, fall back to default
                localStorage.setItem('inventoryActiveTab', defaultTab);
                window.location.hash = defaultTab;
            }
        } else if (!activeTabHash) {
            // If no hash is present, ensure the default tab is marked as active in localStorage
            localStorage.setItem('inventoryActiveTab', defaultTab);
        }


        // Load consumption records when the consumption tab is shown
        const consumptionTabButton = document.getElementById('consumption-tab');
        if (consumptionTabButton) {
            consumptionTabButton.addEventListener('shown.bs.tab', function() {
                // Load records only if the table is empty, to avoid re-fetching on every switch
                const tbody = document.getElementById('consumptionTableBody');
                if (tbody && tbody.children.length === 0) {
                    loadConsumptionRecords(); // Load with default page and search
                }
            });
        }

        // Save active tab to localStorage and update URL hash when tab changes
        document.querySelectorAll('#inventoryTabs button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(e) {
                const target = e.target.getAttribute('data-bs-target'); // e.g., '#product-master'
                localStorage.setItem('inventoryActiveTab', target);
                // Update URL hash to reflect the active tab
                if (window.location.hash !== target) {
                    window.location.hash = target;
                }
            });
        });

        // Handle form submission for adding a new consumption record
        const addConsumptionForm = document.getElementById('addConsumptionForm');
        if (addConsumptionForm) {
            addConsumptionForm.addEventListener('submit', function(e) {
                e.preventDefault();

                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                const formData = new FormData(this);

                fetch('/inventory/consumption/add', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addConsumptionModal'));
                        modal.hide();
                        this.reset(); // Clear form fields
                        this.classList.remove('was-validated'); // Reset validation state
                        document.getElementById('consumptionDate').value = today; // Reset date to today
                        loadConsumptionRecords(currentPage, currentSearch); // Reload consumption records
                        showToast('Consumption recorded successfully', 'success');
                    } else {
                        showToast(data.error || 'Error recording consumption', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error adding consumption:', error);
                    showToast(`Error recording consumption: ${error.message}`, 'danger');
                });
            });
        }

        // Handle form submission for editing a consumption record
        const editConsumptionForm = document.getElementById('editConsumptionForm');
        if (editConsumptionForm) {
            editConsumptionForm.addEventListener('submit', function(e) {
                e.preventDefault();

                if (!this.checkValidity()) {
                    e.stopPropagation();
                    this.classList.add('was-validated');
                    return;
                }

                const formData = new FormData(this);

                fetch(`/inventory/consumption/${editingConsumptionId}/edit`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'Server error'); });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editConsumptionModal'));
                        modal.hide();
                        loadConsumptionRecords(currentPage, currentSearch); // Reload current view
                        showToast('Consumption updated successfully', 'success');
                    } else {
                        showToast(data.error || 'Error updating consumption', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error updating consumption:', error);
                    showToast(`Error updating consumption: ${error.message}`, 'danger');
                });
            });
        }

        // Allow searching consumption records by pressing Enter key
        const consumptionSearchInput = document.getElementById('consumptionSearch');
        if (consumptionSearchInput) {
            consumptionSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchConsumption();
                }
            });
        }
    });

    // Helper function to display Bootstrap toasts
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        const toastId = `toast-${Date.now()}`;
        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastEl = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastEl);
        toast.show();

        // Clean up toast element after it's hidden
        toastEl.addEventListener('hidden.bs.toast', function() {
            toastEl.remove();
        });
    }

    // Helper function to create a toast container if it doesn't exist
    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        // Position toasts at the top-right corner
        container.style.position = 'fixed';
        container.style.top = '1rem';
        container.style.right = '1rem';
        container.style.zIndex = '1050'; // Ensure toasts are above most other content
        document.body.appendChild(container);
        return container;
    }

    // Initialize tooltips on page load
    document.addEventListener('ready', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    });


    // Category management functions
    function editCategory(id, name, description, colorCode) {
        document.getElementById('editCategoryName').value = name;
        document.getElementById('editCategoryDescription').value = description;
        document.getElementById('editCategoryColor').value = colorCode;
        document.getElementById('editCategoryForm').action = `/inventory/categories/${id}/edit`;

        const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
        modal.show();
    }

    function deleteCategory(id, name) {
        document.getElementById('deleteCategoryName').textContent = name;
        document.getElementById('deleteCategoryForm').dataset.categoryId = id;

        const modal = new bootstrap.Modal(document.getElementById('deleteCategoryModal'));
        modal.show();
    }

    // Handle category deletion
    function confirmDeleteCategory() {
        const categoryId = document.getElementById('deleteCategoryForm').dataset.categoryId;
        const submitButton = document.querySelector('#deleteCategoryModal .btn-danger');
        const originalText = submitButton.innerHTML;

        // Show loading state
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';

        fetch(`/inventory/categories/${categoryId}/delete`, {
            method: 'POST'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to delete category');
            }
            return response.text(); // Categories endpoint returns redirect, not JSON
        })
        .then(() => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteCategoryModal'));
            modal.hide();
            location.reload(); // Reload page to refresh categories table
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error deleting category', 'danger');
        })
        .finally(() => {
            // Reset button state
            submitButton.disabled = false;
            submitButton.innerHTML = originalText;
        });
    }


</script>
{% endblock %}