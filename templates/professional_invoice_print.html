<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Invoice - {{ invoice.invoice_number }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        @media print {
            .no-print { display: none !important; }
            body { font-size: 11px; }
            .invoice-wrapper { box-shadow: none !important; }
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #f8e1f4 0%, #e8f4e8 100%);
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        .invoice-wrapper {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }

        .floral-corner-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #e8b4d8 0%, #f5d5e8 100%);
            clip-path: polygon(0 0, 100% 0, 0 100%);
            opacity: 0.6;
        }

        .floral-corner-bottom {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 150px;
            height: 150px;
            background: linear-gradient(315deg, #ffd700 0%, #ffb347 100%);
            clip-path: polygon(100% 0, 100% 100%, 0 100%);
            opacity: 0.5;
        }

        .invoice-header {
            background: linear-gradient(135deg, #fff 0%, #fdf8fc 100%);
            padding: 30px;
            border-bottom: 2px solid #e8b4d8;
            position: relative;
            z-index: 1;
        }

        .company-name {
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: #8b5a8b;
            margin-bottom: 5px;
        }

        .invoice-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: #6b8e6b;
            font-weight: 600;
        }

        .company-details {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.6;
        }

        .gstin-badge {
            background: linear-gradient(135deg, #8b5a8b 0%, #a070a0 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
            margin-top: 8px;
        }

        .invoice-body {
            padding: 25px 30px;
            position: relative;
            z-index: 1;
        }

        .billing-section {
            display: flex;
            justify-content: space-between;
            margin-bottom: 25px;
            gap: 20px;
        }

        .bill-to-box {
            flex: 1;
            background: #fdf8fc;
            border: 1px solid #e8b4d8;
            border-radius: 10px;
            padding: 15px;
        }

        .bill-to-box h6 {
            color: #8b5a8b;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .invoice-meta {
            flex: 1;
        }

        .invoice-meta-table {
            width: 100%;
        }

        .invoice-meta-table td {
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        .invoice-meta-table td:first-child {
            color: #666;
            font-weight: 500;
        }

        .invoice-meta-table td:last-child {
            color: #333;
            font-weight: 600;
            text-align: right;
        }

        .invoice-number {
            color: #6b8e6b;
            font-size: 1rem;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
        }

        .items-table thead {
            background: linear-gradient(135deg, #f5e6f0 0%, #e8f4e8 100%);
        }

        .items-table th {
            padding: 12px 10px;
            text-align: center;
            color: #6b5a6b;
            font-weight: 600;
            font-size: 0.85rem;
            border-bottom: 2px solid #d4a8d4;
            border-top: 2px solid #d4a8d4;
        }

        .items-table th:first-child,
        .items-table td:first-child {
            text-align: left;
        }

        .items-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0e0f0;
            font-size: 0.85rem;
            vertical-align: top;
        }

        .items-table tbody tr:hover {
            background: #fdf8fc;
        }

        .item-description {
            color: #666;
            font-size: 0.75rem;
            margin-top: 3px;
        }

        .text-center { text-align: center; }
        .text-end { text-align: right; }

        .summary-section {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }

        .amount-words-box {
            flex: 1.2;
            background: linear-gradient(135deg, #fff9e6 0%, #fff5d6 100%);
            border: 1px solid #f0d080;
            border-radius: 10px;
            padding: 15px;
        }

        .amount-words-box h6 {
            color: #b08000;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .amount-words-text {
            font-style: italic;
            color: #805a00;
            font-size: 0.9rem;
        }

        .payment-method-box {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #e0c060;
        }

        .totals-box {
            flex: 1;
            background: #fdf8fc;
            border: 2px solid #d4a8d4;
            border-radius: 10px;
            padding: 15px;
        }

        .totals-table {
            width: 100%;
        }

        .totals-table td {
            padding: 6px 0;
            font-size: 0.9rem;
        }

        .totals-table td:first-child {
            color: #666;
        }

        .totals-table td:last-child {
            text-align: right;
            color: #333;
            font-weight: 500;
        }

        .totals-table .total-row {
            background: linear-gradient(135deg, #8b5a8b 0%, #a070a0 100%);
            color: white;
        }

        .totals-table .total-row td {
            color: white;
            font-weight: 700;
            font-size: 1rem;
            padding: 10px 8px;
        }

        .terms-section {
            background: #fafafa;
            border-top: 1px solid #e0e0e0;
            padding: 20px 30px;
            font-size: 0.75rem;
            color: #666;
        }

        .terms-section h6 {
            color: #555;
            font-size: 0.8rem;
            margin-bottom: 10px;
        }

        .terms-section ol {
            margin: 0;
            padding-left: 20px;
        }

        .terms-section li {
            margin-bottom: 3px;
        }

        .footer-section {
            background: linear-gradient(135deg, #f5e6f0 0%, #e8f4e8 100%);
            padding: 15px 30px;
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .footer-section p {
            margin: 0;
            color: #6b5a6b;
            font-size: 0.85rem;
        }

        .footer-section small {
            color: #888;
            font-size: 0.75rem;
        }

        .btn-print {
            background: linear-gradient(135deg, #8b5a8b 0%, #a070a0 100%);
            border: none;
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 500;
            margin: 5px;
        }

        .btn-print:hover {
            background: linear-gradient(135deg, #7a4a7a 0%, #906090 100%);
            color: white;
        }

        .btn-back {
            background: #6b8e6b;
            border: none;
            color: white;
            padding: 10px 25px;
            border-radius: 25px;
            font-weight: 500;
            margin: 5px;
        }

        .btn-back:hover {
            background: #5a7d5a;
            color: white;
        }

        .flower-icon {
            display: inline-block;
            width: 30px;
            height: 30px;
            margin: 0 10px;
        }

        .flower-icon svg {
            width: 100%;
            height: 100%;
        }

        .decorative-line {
            height: 3px;
            background: linear-gradient(90deg, #e8b4d8, #8b5a8b, #6b8e6b, #e8b4d8);
            margin: 15px 0;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="invoice-wrapper">
        <div class="floral-corner-top"></div>
        <div class="floral-corner-bottom"></div>

        <!-- Header Section -->
        <div class="invoice-header">
            <div class="row align-items-center">
                <div class="col-md-2 text-start">
                    {% if business_logo %}
                    <div class="company-logo">
                        <img src="{{ business_logo }}" alt="{{ gst_config.business_name or 'Company Logo' }}" style="max-height: 80px; max-width: 80px; object-fit: contain; border-radius: 8px;">
                    </div>
                    {% endif %}
                </div>
                <div class="col-md-7 text-center">
                    <div class="company-name">{{ gst_config.business_name or 'Spa & Wellness' }}</div>
                    <div class="company-details">
                        {{ gst_config.business_address or 'Your Business Address' }}<br>
                        Phone: {{ gst_config.business_phone or '+91-XXXXXXXXXX' }} | Email: {{ gst_config.business_email or 'info@yourspa.com' }}
                    </div>
                    <div class="gstin-badge">
                        <strong>GSTIN:</strong> {{ gst_config.gstin_number or '29XXXXX1234Z1Z5' }}
                    </div>
                </div>
                <div class="col-md-3 text-end">
                    <div class="invoice-title">
                        <span class="flower-icon">
                            <svg viewBox="0 0 24 24" fill="#8b5a8b">
                                <path d="M12 2C13.1 2 14 2.9 14 4C14 4.74 13.6 5.39 13 5.73V7H14C17.31 7 20 9.69 20 13C20 15.21 18.77 17.14 17 18.19V21H7V18.19C5.23 17.14 4 15.21 4 13C4 9.69 6.69 7 10 7H11V5.73C10.4 5.39 10 4.74 10 4C10 2.9 10.9 2 12 2M10 9C7.79 9 6 10.79 6 13C6 14.5 6.8 15.77 8 16.46V19H16V16.46C17.2 15.77 18 14.5 18 13C18 10.79 16.21 9 14 9H10Z"/>
                            </svg>
                        </span>
                        INVOICE
                    </div>
                </div>
            </div>
            <div class="decorative-line"></div>
        </div>

        <!-- Invoice Body -->
        <div class="invoice-body">
            <!-- Billing & Invoice Details -->
            <div class="billing-section">
                <div class="bill-to-box">
                    <h6>Bill To:</h6>
                    <strong>{{ invoice.customer.full_name }}</strong><br>
                    {% if invoice.customer.address %}{{ invoice.customer.address }}<br>{% endif %}
                    Phone: {{ invoice.customer.phone }}
                    {% if invoice.customer.email %}<br>Email: {{ invoice.customer.email }}{% endif %}
                </div>
                <div class="invoice-meta">
                    <table class="invoice-meta-table">
                        <tr>
                            <td>Invoice Number:</td>
                            <td class="invoice-number">{{ invoice.invoice_number }}</td>
                        </tr>
                        <tr>
                            <td>Invoice Date:</td>
                            <td>{{ invoice.invoice_date.strftime('%d-%m-%Y') }}</td>
                        </tr>
                        <tr>
                            <td>GST Treatment:</td>
                            <td>{{ 'Interstate (IGST)' if tax_details.get('is_interstate') else 'Intrastate (CGST+SGST)' }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Items Table -->
            <table class="items-table">
                <thead>
                    <tr>
                        <th style="width: 5%;">S.No</th>
                        <th style="width: 30%;">Description</th>
                        <th style="width: 10%;">HSN/SAC</th>
                        <th style="width: 8%;">Qty</th>
                        <th style="width: 12%;">Rate (₹)</th>
                        <th style="width: 12%;">Amount (₹)</th>
                        <th style="width: 10%;">Tax Rate</th>
                        <th style="width: 13%;">Tax Amt (₹)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in invoice_items %}
                    <tr>
                        <td class="text-center">{{ loop.index }}</td>
                        <td>
                            <strong>{{ item.item_name }}</strong>
                            {% if item.description %}<div class="item-description">{{ item.description }}</div>{% endif %}
                            {% if item.batch_name %}<div class="item-description">Batch: {{ item.batch_name }}</div>{% endif %}
                        </td>
                        <td class="text-center">{% if item.item_type == 'service' %}998314{% else %}3304{% endif %}</td>
                        <td class="text-center">{{ item.quantity }}</td>
                        <td class="text-end">{{ "%.2f"|format(item.unit_price) }}</td>
                        <td class="text-end">{{ "%.2f"|format(item.final_amount) }}</td>
                        <td class="text-center">
                            {% if tax_details.get('is_interstate') %}
                                {{ "%.1f"|format(tax_details.get('igst_rate', 0)) }}% IGST
                            {% else %}
                                {{ "%.1f"|format(tax_details.get('cgst_rate', 0)) }}% CGST<br>
                                {{ "%.1f"|format(tax_details.get('sgst_rate', 0)) }}% SGST
                            {% endif %}
                        </td>
                        <td class="text-end">
                            {% set item_tax = (item.final_amount * (tax_details.get('cgst_rate', 0) + tax_details.get('sgst_rate', 0) + tax_details.get('igst_rate', 0)) / 100) %}
                            {{ "%.2f"|format(item_tax) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Summary Section -->
            <div class="summary-section">
                <div class="amount-words-box">
                    <h6>Amount in Words:</h6>
                    <div class="amount-words-text">
                        Rupees {{ amount_in_words }} Only
                    </div>
                    
                    {% if invoice.payment_methods or invoice.payment_method %}
                    <div class="payment-method-box">
                        <strong>Payment Method:</strong>
                        {% if invoice.payment_method %}
                            {{ invoice.payment_method.replace('_', ' ').title() }}: ₹{{ "%.2f"|format(invoice.amount_paid) }}
                        {% elif invoice.payment_methods %}
                            {% set payment_methods = invoice.payment_methods|from_json %}
                            {% for method, amount in payment_methods.items() %}
                                {{ method.replace('_', ' ').title() }}: ₹{{ "%.2f"|format(amount) }}
                                {% if not loop.last %}, {% endif %}
                            {% endfor %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <div class="totals-box">
                    <table class="totals-table">
                        <tr>
                            <td>Subtotal:</td>
                            <td>₹{{ "%.2f"|format(invoice.gross_subtotal) }}</td>
                        </tr>
                        {% if invoice.discount_amount > 0 %}
                        <tr>
                            <td>Discount:</td>
                            <td style="color: #dc3545;">- ₹{{ "%.2f"|format(invoice.discount_amount) }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <td>Taxable Amount:</td>
                            <td>₹{{ "%.2f"|format(invoice.net_subtotal) }}</td>
                        </tr>
                        {% if tax_details.get('is_interstate') %}
                        <tr>
                            <td>IGST ({{ "%.1f"|format(tax_details.get('igst_rate', 0)) }}%):</td>
                            <td>₹{{ "%.2f"|format(tax_details.get('igst_amount', 0)) }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td>CGST ({{ "%.1f"|format(tax_details.get('cgst_rate', 0)) }}%):</td>
                            <td>₹{{ "%.2f"|format(tax_details.get('cgst_amount', 0)) }}</td>
                        </tr>
                        <tr>
                            <td>SGST ({{ "%.1f"|format(tax_details.get('sgst_rate', 0)) }}%):</td>
                            <td>₹{{ "%.2f"|format(tax_details.get('sgst_amount', 0)) }}</td>
                        </tr>
                        {% endif %}
                        {% if tax_details.get('additional_charges', 0) > 0 %}
                        <tr>
                            <td>Additional Charges:</td>
                            <td>₹{{ "%.2f"|format(tax_details.get('additional_charges', 0)) }}</td>
                        </tr>
                        {% endif %}
                        {% if invoice.tips_amount > 0 %}
                        <tr>
                            <td>Tips:</td>
                            <td>₹{{ "%.2f"|format(invoice.tips_amount) }}</td>
                        </tr>
                        {% endif %}
                        <tr class="total-row">
                            <td style="border-radius: 5px 0 0 5px;">Total Amount:</td>
                            <td style="border-radius: 0 5px 5px 0;">₹{{ "%.2f"|format(invoice.total_amount) }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Terms & Conditions -->
        <div class="terms-section">
            <h6>Terms & Conditions:</h6>
            <ol>
                <li>Payment is due within the specified payment terms.</li>
                <li>All services are subject to our standard terms and conditions.</li>
                <li>This is a computer-generated invoice and does not require a physical signature.</li>
                <li>For any queries regarding this invoice, please contact our customer service.</li>
                <li>Cancellation policy applies as per the service agreement.</li>
            </ol>
        </div>

        <!-- Footer -->
        <div class="footer-section">
            <p><strong>Thank you for choosing our services!</strong></p>
            <small>This invoice was generated on {{ invoice.created_at.strftime('%d-%m-%Y at %I:%M %p') }}</small>
        </div>
    </div>

    <!-- Print/Back Buttons -->
    <div class="text-center mt-4 no-print">
        <button onclick="window.print()" class="btn btn-print">
            Print Invoice
        </button>
        <button type="button" class="btn btn-back" onclick="window.history.back()">
            Back
        </button>
    </div>

    <script>
        if (window.location.hash === '#autoprint') {
            setTimeout(() => window.print(), 500);
        }
    </script>
</body>
</html>