<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Invoice - {{ invoice.invoice_number }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .invoice-container { box-shadow: none; }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f0f2f5;
            color: #1a1a2e;
            line-height: 1.5;
            padding: 20px;
        }

        .invoice-container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .header-left h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header-left p {
            opacity: 0.9;
            font-size: 13px;
        }

        .header-right {
            text-align: right;
        }

        .header-right .invoice-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.8;
        }

        .header-right .invoice-number {
            font-size: 20px;
            font-weight: 600;
            margin-top: 5px;
        }

        .content {
            padding: 30px 40px;
        }

        .info-row {
            display: flex;
            gap: 40px;
            margin-bottom: 30px;
        }

        .info-block {
            flex: 1;
        }

        .info-block h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .info-block p {
            font-size: 14px;
            color: #4a4a4a;
            margin-bottom: 3px;
        }

        .info-block .name {
            font-weight: 600;
            color: #1a1a2e;
            font-size: 15px;
        }

        .gstin-tag {
            display: inline-block;
            background: #f0f2f5;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-top: 8px;
        }

        .invoice-details {
            background: #f8f9fc;
            border-radius: 6px;
            padding: 15px 20px;
        }

        .invoice-details table {
            width: 100%;
        }

        .invoice-details td {
            padding: 5px 0;
            font-size: 13px;
        }

        .invoice-details td:first-child {
            color: #666;
        }

        .invoice-details td:last-child {
            text-align: right;
            font-weight: 500;
            color: #1a1a2e;
        }

        .items-section {
            margin-bottom: 25px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
        }

        .items-table thead {
            background: #f8f9fc;
        }

        .items-table th {
            padding: 12px 15px;
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            font-weight: 600;
            border-bottom: 2px solid #e8e8e8;
        }

        .items-table th.text-right { text-align: right; }
        .items-table th.text-center { text-align: center; }

        .items-table td {
            padding: 15px;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .items-table td.text-right { text-align: right; }
        .items-table td.text-center { text-align: center; }

        .item-name {
            font-weight: 500;
            color: #1a1a2e;
        }

        .package-tag {
            display: inline-block;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
        }

        .discount-value {
            color: #11998e;
            font-weight: 500;
        }

        .summary-row {
            display: flex;
            gap: 30px;
            margin-top: 20px;
        }

        .amount-words {
            flex: 1.2;
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            padding: 15px 20px;
        }

        .amount-words h4 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #b45309;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .amount-words p {
            font-size: 14px;
            color: #92400e;
            font-style: italic;
        }

        .payment-info {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #fcd34d;
            font-size: 13px;
            color: #78350f;
        }

        .totals-box {
            flex: 1;
            background: #f8f9fc;
            border-radius: 6px;
            padding: 15px 20px;
        }

        .totals-table {
            width: 100%;
        }

        .totals-table td {
            padding: 6px 0;
            font-size: 13px;
        }

        .totals-table td:first-child { color: #666; }
        .totals-table td:last-child { text-align: right; font-weight: 500; }

        .totals-table .savings td {
            color: #11998e;
        }

        .totals-table .grand-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .totals-table .grand-total td {
            color: white;
            font-weight: 700;
            font-size: 15px;
            padding: 12px 10px;
        }

        .totals-table .grand-total td:first-child {
            border-radius: 4px 0 0 4px;
        }

        .totals-table .grand-total td:last-child {
            border-radius: 0 4px 4px 0;
        }

        .package-summary {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border: 1px solid #28a745;
            border-radius: 6px;
            padding: 12px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .package-summary-label {
            color: #155724;
            font-weight: 500;
            font-size: 14px;
        }

        .package-summary-value {
            color: #155724;
            font-weight: 700;
            font-size: 16px;
        }

        .footer {
            background: #f8f9fc;
            padding: 20px 40px;
            border-top: 1px solid #e8e8e8;
        }

        .terms h4 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .terms ol {
            font-size: 11px;
            color: #888;
            padding-left: 16px;
        }

        .terms li { margin-bottom: 3px; }

        .thank-you {
            text-align: center;
            padding: 20px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .thank-you p {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .thank-you small {
            opacity: 0.8;
            font-size: 11px;
        }

        .btn-group {
            text-align: center;
            margin-top: 20px;
        }

        .btn {
            display: inline-block;
            padding: 12px 30px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            border: none;
            margin: 5px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: #e8e8e8;
            color: #333;
        }

        .btn:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <div class="invoice-container">
        <div class="header">
            <div class="header-left">
                <h1>{{ gst_config.business_name or 'Spa & Wellness' }}</h1>
                <p>{{ gst_config.business_address or 'Business Address' }}</p>
                <p>{{ gst_config.business_phone or 'Phone' }} | {{ gst_config.business_email or 'Email' }}</p>
                <div class="gstin-tag" style="background: rgba(255,255,255,0.2); color: white;">GSTIN: {{ gst_config.gstin_number or 'XXXXXXXXX' }}</div>
            </div>
            <div class="header-right">
                <div class="invoice-label">Tax Invoice</div>
                <div class="invoice-number">{{ invoice.invoice_number }}</div>
                <p style="margin-top: 10px; font-size: 13px;">{{ invoice.invoice_date.strftime('%d %b %Y') }}</p>
            </div>
        </div>

        <div class="content">
            <div class="info-row">
                <div class="info-block">
                    <h3>Bill To</h3>
                    <p class="name">{{ invoice.customer.full_name }}</p>
                    {% if invoice.customer.address %}<p>{{ invoice.customer.address }}</p>{% endif %}
                    <p>{{ invoice.customer.phone }}</p>
                    {% if invoice.customer.email %}<p>{{ invoice.customer.email }}</p>{% endif %}
                </div>
                <div class="info-block">
                    <div class="invoice-details">
                        <table>
                            <tr>
                                <td>Invoice No:</td>
                                <td>{{ invoice.invoice_number }}</td>
                            </tr>
                            <tr>
                                <td>Date:</td>
                                <td>{{ invoice.invoice_date.strftime('%d-%m-%Y') }}</td>
                            </tr>
                            <tr>
                                <td>GST Type:</td>
                                <td>{{ 'Interstate' if tax_details.get('is_interstate') else 'Intrastate' }}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <div class="items-section">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 35%;">Description</th>
                            <th class="text-center" style="width: 8%;">Qty</th>
                            <th class="text-right" style="width: 12%;">Rate</th>
                            <th class="text-right" style="width: 12%;">Amount</th>
                            <th class="text-right" style="width: 12%;">Discount</th>
                            <th class="text-right" style="width: 16%;">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in invoice_items %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <span class="item-name">{{ item.item_name }}</span>
                                {% if item.is_package_deduction and item.package_name %}
                                <span class="package-tag">{{ item.package_name }}</span>
                                {% endif %}
                            </td>
                            <td class="text-center">{{ "%.0f"|format(item.quantity) if item.quantity == item.quantity|int else "%.1f"|format(item.quantity) }}</td>
                            <td class="text-right">{{ "%.2f"|format(item.unit_price) }}</td>
                            <td class="text-right">{{ "%.2f"|format(item.original_amount or (item.quantity * item.unit_price)) }}</td>
                            <td class="text-right">
                                {% if item.deduction_amount and item.deduction_amount > 0 %}
                                <span class="discount-value">-{{ "%.2f"|format(item.deduction_amount) }}</span>
                                {% else %}
                                <span style="color: #ccc;">-</span>
                                {% endif %}
                            </td>
                            <td class="text-right" style="font-weight: 600;">{{ "%.2f"|format(item.final_amount) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% set package_items = invoice_items | selectattr('is_package_deduction') | list %}
            {% if package_items %}
            {% set total_pkg_savings = namespace(value=0) %}
            {% for item in package_items %}
                {% set total_pkg_savings.value = total_pkg_savings.value + (item.deduction_amount or 0) %}
            {% endfor %}
            {% if total_pkg_savings.value > 0 %}
            <div class="package-summary">
                <span class="package-summary-label">Package Benefits Applied</span>
                <span class="package-summary-value">You Save: ₹{{ "%.2f"|format(total_pkg_savings.value) }}</span>
            </div>
            {% endif %}
            {% endif %}

            <div class="summary-row">
                <div class="amount-words">
                    <h4>Amount in Words</h4>
                    <p>Rupees {{ amount_in_words }} Only</p>
                    {% if invoice.payment_method %}
                    <div class="payment-info">
                        <strong>Payment:</strong> {{ invoice.payment_method.replace('_', ' ').title() }}
                    </div>
                    {% endif %}
                </div>

                <div class="totals-box">
                    <table class="totals-table">
                        <tr>
                            <td>Subtotal</td>
                            <td>₹{{ "%.2f"|format(invoice.gross_subtotal) }}</td>
                        </tr>
                        {% set total_package_discount = namespace(value=0) %}
                        {% for item in invoice_items %}
                            {% if item.is_package_deduction and item.deduction_amount %}
                                {% set total_package_discount.value = total_package_discount.value + item.deduction_amount %}
                            {% endif %}
                        {% endfor %}
                        {% if total_package_discount.value > 0 %}
                        <tr class="savings">
                            <td>Package Savings</td>
                            <td>-₹{{ "%.2f"|format(total_package_discount.value) }}</td>
                        </tr>
                        {% endif %}
                        {% if invoice.discount_amount > 0 %}
                        <tr>
                            <td>Discount</td>
                            <td style="color: #dc3545;">-₹{{ "%.2f"|format(invoice.discount_amount) }}</td>
                        </tr>
                        {% endif %}
                        {% if tax_details.get('is_interstate') %}
                        <tr>
                            <td>IGST ({{ "%.1f"|format(tax_details.get('igst_rate', 0)) }}%)</td>
                            <td>₹{{ "%.2f"|format(tax_details.get('igst_amount', 0)) }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td>CGST ({{ "%.1f"|format(tax_details.get('cgst_rate', 0)) }}%)</td>
                            <td>₹{{ "%.2f"|format(tax_details.get('cgst_amount', 0)) }}</td>
                        </tr>
                        <tr>
                            <td>SGST ({{ "%.1f"|format(tax_details.get('sgst_rate', 0)) }}%)</td>
                            <td>₹{{ "%.2f"|format(tax_details.get('sgst_amount', 0)) }}</td>
                        </tr>
                        {% endif %}
                        {% if invoice.tips_amount > 0 %}
                        <tr>
                            <td>Tips</td>
                            <td>₹{{ "%.2f"|format(invoice.tips_amount) }}</td>
                        </tr>
                        {% endif %}
                        <tr class="grand-total">
                            <td>Total</td>
                            <td>₹{{ "%.2f"|format(invoice.total_amount) }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="terms">
                <h4>Terms & Conditions</h4>
                <ol>
                    <li>Payment is due as per agreed terms.</li>
                    <li>This is a computer-generated invoice.</li>
                    <li>For queries, contact our customer service.</li>
                </ol>
            </div>
        </div>

        <div class="thank-you">
            <p><strong>Thank you for your business!</strong></p>
            <small>Invoice generated on {{ invoice.created_at.strftime('%d %b %Y, %I:%M %p') }}</small>
        </div>
    </div>

    <div class="btn-group no-print">
        <button onclick="window.print()" class="btn btn-primary">Print Invoice</button>
        <button onclick="window.history.back()" class="btn btn-secondary">Back</button>
    </div>

    <script>
        if (window.location.hash === '#autoprint') {
            setTimeout(() => window.print(), 500);
        }
    </script>
</body>
</html>
