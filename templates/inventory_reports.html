
{% extends "base.html" %}

{% block title %}Inventory Reports - Spa Management{% endblock %}

{% block body_class %}reports-page{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header with Gradient -->
    <div class="page-header mb-4 p-4 rounded-3 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="d-flex justify-content-between align-items-center">
            <div class="text-white">
                <h1 class="page-header-title mb-2 text-white">
                    <i class="fas fa-chart-line me-2"></i>Inventory Reports
                </h1>
                <p class="mb-0 opacity-75">Generate comprehensive inventory reports with detailed analytics</p>
            </div>
            <a href="{{ url_for('inventory_dashboard') }}" class="btn btn-light btn-lg">
                <i class="fas fa-arrow-left me-2"></i>Back to Inventory
            </a>
        </div>
    </div>

    <!-- Quick Stats Cards with Enhanced Design -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm h-100 position-relative overflow-hidden">
                <div class="stat-gradient stat-gradient-blue"></div>
                <div class="card-body text-center position-relative">
                    <div class="stat-icon mb-3">
                        <i class="fas fa-cubes fa-3x text-primary"></i>
                    </div>
                    <h6 class="text-muted mb-2 text-uppercase small fw-bold">Total Products</h6>
                    <h2 class="mb-0 fw-bold text-primary">{{ total_products or 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm h-100 position-relative overflow-hidden">
                <div class="stat-gradient stat-gradient-orange"></div>
                <div class="card-body text-center position-relative">
                    <div class="stat-icon mb-3">
                        <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                    </div>
                    <h6 class="text-muted mb-2 text-uppercase small fw-bold">Low Stock Items</h6>
                    <h2 class="mb-0 fw-bold text-warning">{{ low_stock_count or 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm h-100 position-relative overflow-hidden">
                <div class="stat-gradient stat-gradient-red"></div>
                <div class="card-body text-center position-relative">
                    <div class="stat-icon mb-3">
                        <i class="fas fa-calendar-times fa-3x text-danger"></i>
                    </div>
                    <h6 class="text-muted mb-2 text-uppercase small fw-bold">Expiring Soon</h6>
                    <h2 class="mb-0 fw-bold text-danger">{{ expiring_count or 0 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm h-100 position-relative overflow-hidden">
                <div class="stat-gradient stat-gradient-green"></div>
                <div class="card-body text-center position-relative">
                    <div class="stat-icon mb-3">
                        <i class="fas fa-dollar-sign fa-3x text-success"></i>
                    </div>
                    <h6 class="text-muted mb-2 text-uppercase small fw-bold">Total Stock Value</h6>
                    <h2 class="mb-0 fw-bold text-success">₹{{ "{:,.2f}".format(total_stock_value or 0) }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Selection Card -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-gradient-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>Select Report Type
            </h5>
        </div>
        <div class="card-body p-4">
            <form method="GET" id="reportForm" action="{{ url_for('inventory_reports') }}">
                <div class="row g-4">
                    <!-- Report Type Selection -->
                    <div class="col-md-4">
                        <label for="report_type" class="form-label fw-semibold">
                            <i class="fas fa-file-alt me-1"></i>Choose Report Type:
                        </label>
                        <select class="form-select form-select-lg" id="report_type" name="report_type" required>
                            <option value="">-- Select Report Type --</option>
                            <option value="stock_levels">Stock Levels Report</option>
                            <option value="consumption">Consumption Report (Custom Date Range)</option>
                            <option value="low_stock">Low Stock Alert Report</option>
                            <option value="expiry">Expiry Alert Report</option>
                            <option value="stock_value">Stock Value Report</option>
                            <option value="adjustments">Stock Adjustments Report</option>
                            <option value="category_wise">Category-wise Stock Report</option>
                            <option value="location_wise">Location-wise Stock Report</option>
                        </select>
                    </div>

                    <!-- Date Range Section -->
                    <div id="dateRangeSection" class="col-md-8" style="display: none;">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-calendar-alt me-1"></i>Date Range:
                        </label>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <input type="date" class="form-control form-control-lg" id="start_date" name="start_date" 
                                       value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}">
                            </div>
                            <div class="col-md-6">
                                <input type="date" class="form-control form-control-lg" id="end_date" name="end_date"
                                       value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}">
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-lg px-5" id="generateBtn">
                            <i class="fas fa-chart-bar me-2"></i>Generate Report
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-lg px-5 ms-2" onclick="window.location.href='{{ url_for('inventory_reports') }}'">
                            <i class="fas fa-redo me-2"></i>Reset
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Results Section -->
    {% if consumption_data or adjustment_data or stock_levels or expiring_items or low_stock_items or category_summary or location_summary %}
    <div class="card shadow-sm border-0">
        <div class="card-header bg-gradient-success text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Report Results
                    {% if start_date and end_date %}
                    - {{ start_date.strftime('%d %b %Y') }} to {{ end_date.strftime('%d %b %Y') }}
                    {% endif %}
                </h5>
                <button class="btn btn-light btn-sm" onclick="exportToExcel()">
                    <i class="fas fa-download me-1"></i>Export to Excel
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0" id="reportTable">
                    <thead class="table-dark">
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-light">
            <div class="text-muted small" id="reportFooter">
                <i class="fas fa-info-circle me-1"></i>
                <span id="recordCount">Total Records: 0</span>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #34a853 0%, #16a34a 100%);
}

.page-header-title {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.stat-card {
    transition: all 0.3s ease;
    border-radius: 16px;
}

.stat-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 16px 32px rgba(0, 0, 0, 0.2) !important;
}

.stat-gradient {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    opacity: 0;
    transition: all 0.3s ease;
}

.stat-card:hover .stat-gradient {
    opacity: 1;
}

.stat-gradient-blue {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
}

.stat-gradient-orange {
    background: linear-gradient(90deg, #f59e0b 0%, #ea580c 100%);
}

.stat-gradient-red {
    background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
}

.stat-gradient-green {
    background: linear-gradient(90deg, #10b981 0%, #059669 100%);
}

.stat-icon {
    opacity: 0.7;
    transition: all 0.3s ease;
}

.stat-card:hover .stat-icon {
    opacity: 1;
    transform: scale(1.15) rotate(5deg);
}

.form-select-lg, .form-control-lg {
    border-radius: 0.5rem;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
}

.form-select-lg:focus, .form-control-lg:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.table-hover tbody tr:hover {
    background-color: rgba(102, 126, 234, 0.05);
    transform: translateX(2px);
    transition: all 0.2s ease;
}

#generateBtn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
}

#generateBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
}

.card {
    transition: all 0.3s ease;
    border-radius: 12px;
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
}

.badge-low-stock {
    background-color: #f59e0b;
    color: white;
}

.badge-out-of-stock {
    background-color: #ef4444;
    color: white;
}

.badge-in-stock {
    background-color: #10b981;
    color: white;
}

.badge-critical {
    background-color: #dc2626;
    color: white;
    animation: pulse 2s infinite;
}

.badge-high {
    background-color: #f59e0b;
    color: white;
}

.badge-medium {
    background-color: #3b82f6;
    color: white;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportTypeSelect = document.getElementById('report_type');
    const dateRangeSection = document.getElementById('dateRangeSection');
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');

    // Show/hide date range based on report type
    reportTypeSelect.addEventListener('change', function() {
        const reportsNeedingDateRange = ['consumption', 'adjustments'];

        if (reportsNeedingDateRange.includes(this.value)) {
            dateRangeSection.style.display = 'block';
            startDateInput.required = true;
            endDateInput.required = true;

            // Set default dates if empty
            if (!startDateInput.value || !endDateInput.value) {
                const today = new Date();
                const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
                endDateInput.value = today.toISOString().split('T')[0];
                startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
            }
        } else {
            dateRangeSection.style.display = 'none';
            startDateInput.required = false;
            endDateInput.required = false;
        }
    });

    // Trigger change event on page load if report type is already selected
    if (reportTypeSelect.value) {
        reportTypeSelect.dispatchEvent(new Event('change'));
    }

    // Populate report table if data exists
    populateReportTable();
});

function populateReportTable() {
    const tableHeader = document.getElementById('tableHeader');
    const tableBody = document.getElementById('tableBody');
    const recordCount = document.getElementById('recordCount');
    
    if (!tableHeader || !tableBody) return;

    // Data from backend
    const consumptionData = {{ consumption_data.data | tojson | safe if consumption_data else '[]' }};
    const adjustmentData = {{ adjustment_data.data | tojson | safe if adjustment_data else '[]' }};
    const stockLevels = {{ stock_levels | tojson | safe if stock_levels else '[]' }};
    const expiringItems = {{ expiring_items | tojson | safe if expiring_items else '[]' }};
    const lowStockItems = {{ low_stock_items | tojson | safe if low_stock_items else '[]' }};
    const categorySummary = {{ category_summary | tojson | safe if category_summary else '[]' }};
    const locationSummary = {{ location_summary | tojson | safe if location_summary else '[]' }};

    let headers = [];
    let data = [];
    let reportType = '';

    // Determine which report to display
    if (consumptionData.length > 0) {
        reportType = 'consumption';
        headers = ['Date', 'Product', 'Batch', 'Quantity', 'Unit Cost', 'Total Cost', 'Issued To', 'Purpose', 'Created By'];
        data = consumptionData.map(item => [
            new Date(item.date).toLocaleDateString(),
            item.product_name,
            item.batch_name,
            item.quantity,
            '₹' + item.unit_cost.toFixed(2),
            '₹' + item.total_cost.toFixed(2),
            item.issued_to || '-',
            item.purpose || '-',
            item.created_by
        ]);
    } else if (adjustmentData.length > 0) {
        reportType = 'adjustments';
        headers = ['Date', 'Type', 'Product', 'Batch', 'Quantity', 'Remarks', 'Created By'];
        data = adjustmentData.map(item => [
            new Date(item.date).toLocaleDateString(),
            `<span class="badge ${item.type === 'add' ? 'bg-success' : 'bg-danger'}">${item.type.toUpperCase()}</span>`,
            item.product_name,
            item.batch_name,
            item.quantity,
            item.remarks || '-',
            item.created_by
        ]);
    } else if (stockLevels.length > 0) {
        reportType = 'stock_levels';
        headers = ['SKU', 'Product', 'Category', 'Stock', 'Batches', 'Value', 'Status', 'Unit'];
        data = stockLevels.map(item => [
            item.sku,
            item.product_name,
            item.category,
            item.total_stock,
            item.batch_count,
            '₹' + item.stock_value.toFixed(2),
            `<span class="badge badge-${item.stock_status === 'in_stock' ? 'in-stock' : item.stock_status === 'low_stock' ? 'low-stock' : 'out-of-stock'}">${item.stock_status.replace('_', ' ').toUpperCase()}</span>`,
            item.unit_of_measure
        ]);
    } else if (expiringItems.length > 0) {
        reportType = 'expiry';
        headers = ['Batch', 'Product', 'Location', 'Expiry Date', 'Days to Expiry', 'Quantity', 'Value', 'Severity'];
        data = expiringItems.map(item => [
            item.batch_name,
            item.product_name,
            item.location,
            new Date(item.expiry_date).toLocaleDateString(),
            item.days_to_expiry,
            item.quantity,
            '₹' + item.stock_value.toFixed(2),
            `<span class="badge badge-${item.severity}">${item.severity.toUpperCase()}</span>`
        ]);
    } else if (lowStockItems.length > 0) {
        reportType = 'low_stock';
        headers = ['SKU', 'Product', 'Category', 'Current Stock', 'Batches', 'Unit'];
        data = lowStockItems.map(item => [
            item.sku,
            item.product_name,
            item.category,
            `<span class="badge badge-low-stock">${item.current_stock}</span>`,
            item.batch_count,
            item.unit_of_measure
        ]);
    } else if (categorySummary.length > 0) {
        reportType = 'category_wise';
        headers = ['Category', 'Products', 'Total Stock', 'Total Value'];
        data = categorySummary.map(item => [
            item.category_name,
            item.total_products,
            item.total_stock,
            '₹' + item.total_value.toFixed(2)
        ]);
    } else if (locationSummary.length > 0) {
        reportType = 'location_wise';
        headers = ['Location', 'Type', 'Batches', 'Products', 'Total Value'];
        data = locationSummary.map(item => [
            item.location_name,
            item.location_type,
            item.total_batches,
            item.unique_products,
            '₹' + item.total_value.toFixed(2)
        ]);
    }

    if (headers.length > 0) {
        // Populate headers
        tableHeader.innerHTML = headers.map(h => `<th>${h}</th>`).join('');
        
        // Populate data
        tableBody.innerHTML = data.map(row => 
            `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`
        ).join('');

        // Update record count
        recordCount.textContent = `Total Records: ${data.length}`;
    }
}

function exportToExcel() {
    const table = document.getElementById('reportTable');
    if (!table) {
        alert('No report data to export');
        return;
    }

    let csv = [];
    const rows = table.querySelectorAll('tr');

    for (let i = 0; i < rows.length; i++) {
        const row = [];
        const cols = rows[i].querySelectorAll('td, th');

        for (let j = 0; j < cols.length; j++) {
            // Get text content and clean it
            let data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ');
            data = data.replace(/"/g, '""');
            row.push('"' + data + '"');
        }

        csv.push(row.join(','));
    }

    const csvString = csv.join('\n');
    const reportType = document.getElementById('report_type').value || 'report';
    const filename = `inventory_${reportType}_${new Date().toISOString().split('T')[0]}.csv`;

    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');

    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showNotification('Report exported successfully!', 'success');
    }
}

function showNotification(message, type) {
    // Simple notification function
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>
{% endblock %}
