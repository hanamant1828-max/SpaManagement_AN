<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Unaki Appointment Booking - Multi-Service</title>
        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Font Awesome -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />
        <!-- Bootstrap JavaScript Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary-color: #4f46e5;
                --primary-hover: #4338ca;
                --success-color: #10b981;
                --danger-color: #ef4444;
                --warning-color: #f59e0b;
                --info-color: #06b6d4;
                --border-color: #e5e7eb;
                --hover-bg: #f9fafb;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                background-attachment: fixed;
                min-height: 100vh;
                color: #1f2937;
                overflow-x: hidden;
                overflow-y: auto;
            }

            /* Top Navigation Bar */
            .calendar-top-nav {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 64px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 24px;
                z-index: 100;
                box-shadow: var(--shadow-md);
            }

            .calendar-logo {
                font-size: 20px;
                font-weight: 700;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .calendar-logo i {
                -webkit-text-fill-color: #667eea;
            }

            .calendar-date-nav {
                display: flex;
                align-items: center;
                gap: 16px;
                background: white;
                padding: 8px 12px;
                border-radius: 12px;
                box-shadow: var(--shadow-sm);
                border: 1px solid var(--border-color);
            }

            .date-nav-btn {
                width: 36px;
                height: 36px;
                border-radius: 8px;
                border: none;
                background: var(--hover-bg);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
                color: #6b7280;
            }

            .date-nav-btn:hover {
                background: var(--primary-color);
                color: white;
                transform: scale(1.05);
            }

            .date-nav-btn:active {
                transform: scale(0.95);
            }

            .current-date-display {
                font-size: 15px;
                font-weight: 600;
                color: #1f2937;
                min-width: 220px;
                text-align: center;
            }

            .date-today-btn {
                padding: 6px 12px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                background: white;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                color: #6b7280;
            }

            .date-today-btn:hover {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .calendar-actions {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .action-btn {
                padding: 10px 18px;
                border-radius: 10px;
                border: none;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .action-btn-primary {
                background: var(--primary-color);
                color: white;
                box-shadow: var(--shadow-md);
            }

            .action-btn-primary:hover {
                background: var(--primary-hover);
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .action-btn-primary:active {
                transform: translateY(0);
            }

            .action-icon {
                width: 40px;
                height: 40px;
                border-radius: 10px;
                border: 1px solid var(--border-color);
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
                color: #6b7280;
            }

            .action-icon:hover {
                background: var(--hover-bg);
                color: var(--primary-color);
                transform: scale(1.05);
            }

            /* Main Layout */
            .calendar-main-layout {
                position: fixed;
                top: 64px;
                left: 0;
                right: 0;
                bottom: 0;
                display: flex;
                background: white;
                overflow: hidden;
                margin: 12px;
                border-radius: 16px;
                box-shadow: var(--shadow-xl);
                position: relative;
            }

            /* Horizontal alignment guides */
            .calendar-main-layout::before {
                content: "";
                position: absolute;
                top: 60px; /* Account for timeline header */
                left: 0;
                right: 0;
                bottom: 0;
                background-image: repeating-linear-gradient(
                    to bottom,
                    transparent 0,
                    transparent 109px,
                    rgba(79, 70, 229, 0.08) 109px,
                    rgba(79, 70, 229, 0.08) 110px
                );
                pointer-events: none;
                z-index: 1;
            }

            /* Staff Sidebar */
            .staff-sidebar {
                width: 280px;
                flex-shrink: 0;
                background: #ffffff;
                border-right: 2px solid var(--border-color);
                overflow-y: auto;
                overflow-x: hidden;
                position: relative;
                z-index: 2;
                max-height: 100%;
            }

            .staff-sidebar-header {
                height: 60px;
                background: white;
                border-bottom: 2px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 20px;
                font-weight: 700;
                font-size: 14px;
                color: #1f2937;
                position: sticky;
                top: 0;
                z-index: 10;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .staff-count {
                background: var(--primary-color);
                color: white;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }

            .staff-row {
                height: 110px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                padding: 16px 20px;
                gap: 14px;
                cursor: pointer;
                transition: all 0.3s;
                background: #ffffff;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }

            .staff-row:nth-of-type(odd) {
                background: #fafbfc;
            }

            .staff-row:nth-of-type(even) {
                background: #ffffff;
            }

            .staff-row:hover {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                transform: none;
                box-shadow: none;
            }

            .staff-row:hover .staff-avatar {
                transform: scale(1.1);
                box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
            }

            .staff-row:hover .staff-name,
            .staff-row:hover .staff-role,
            .staff-row:hover .staff-status {
                color: white;
            }

            .staff-avatar {
                width: 56px;
                height: 56px;
                border-radius: 14px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 700;
                font-size: 20px;
                flex-shrink: 0;
                transition: all 0.3s;
                box-shadow: var(--shadow-md);
            }

            .staff-info {
                flex: 1;
                min-width: 0;
            }

            .staff-name {
                font-size: 15px;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .staff-role {
                font-size: 13px;
                color: #6b7280;
                margin-bottom: 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .staff-status {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-size: 11px;
                font-weight: 500;
                color: var(--success-color);
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--success-color);
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            /* Timeline Panel */
            .timeline-panel {
                flex: 1;
                overflow-x: auto;
                overflow-y: auto;
                background: #ffffff;
                position: relative;
                z-index: 2;
            }

            /* Add shadow indicators for horizontal scroll */
            .timeline-panel::after {
                content: "";
                position: sticky;
                right: 0;
                top: 0;
                width: 40px;
                height: 100%;
                background: linear-gradient(
                    to left,
                    rgba(255, 255, 255, 0.8) 0%,
                    transparent 100%
                );
                pointer-events: none;
                float: right;
            }

            .timeline-header {
                height: 60px;
                background: white;
                border-bottom: 2px solid var(--border-color);
                display: flex;
                position: sticky;
                top: 0;
                z-index: 9;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            }

            /* Scroll indicator hint */
            .timeline-header::after {
                content: "← Scroll horizontally →";
                position: absolute;
                bottom: -20px;
                right: 20px;
                background: rgba(79, 70, 229, 0.9);
                color: white;
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                pointer-events: none;
                animation: scrollHintFade 3s ease-in-out infinite;
            }

            @keyframes scrollHintFade {
                0%,
                100% {
                    opacity: 0;
                }
                50% {
                    opacity: 1;
                }
            }

            .timeline-hour {
                min-width: 140px;
                flex-shrink: 0;
                border-right: 1px solid #e5e7eb;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                font-size: 13px;
                color: #1f2937;
                transition: all 0.2s;
            }

            .timeline-hour:hover {
                background: var(--hover-bg);
            }

            .hour-label {
                font-size: 14px;
                font-weight: 700;
            }

            .hour-period {
                font-size: 11px;
                color: #9ca3af;
                margin-top: 2px;
            }

            /* Timeline Grid */
            .timeline-grid {
                position: relative;
                min-width: max-content;
            }

            .timeline-row {
                height: 110px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                position: relative;
                transition: background 0.2s;
            }

            .timeline-row:nth-child(odd) {
                background: #fafbfc;
            }

            .timeline-row:nth-child(even) {
                background: #ffffff;
            }

            .timeline-row:hover {
                background: rgba(79, 70, 229, 0.02);
            }

            .timeline-hour-slot {
                min-width: 140px;
                flex-shrink: 0;
                position: relative;
                background: transparent;
                border-right: 1px solid #e5e7eb;
                cursor: pointer;
                transition: all 0.2s;
            }

            .timeline-hour-slot:hover {
                background: linear-gradient(
                    to bottom,
                    rgba(79, 70, 229, 0.03),
                    rgba(79, 70, 229, 0.05)
                );
            }

            .timeline-hour-slot:hover::after {
                content: "+";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 24px;
                color: var(--primary-color);
                font-weight: 600;
                opacity: 0.3;
            }

            /* 15-minute interval lines */
            .interval-marker {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 1px;
                background: #f3f4f6;
            }

            .interval-15 {
                left: 25%;
            }
            .interval-30 {
                left: 50%;
                background: #e5e7eb;
            }
            .interval-45 {
                left: 75%;
            }

            /* Appointment Block */
            .appointment-block {
                position: absolute;
                top: 8px;
                bottom: 8px;
                border-radius: 10px;
                border-left: 4px solid;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                padding: 12px;
                cursor: move;
                transition: all 0.2s;
                overflow: hidden;
                z-index: 5;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }

            .appointment-block:hover {
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
                transform: translateY(-2px) scale(1.02);
                z-index: 10;
            }

            .appointment-block.dragging {
                opacity: 0.6;
                cursor: grabbing;
                z-index: 100;
            }

            .appointment-header {
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                margin-bottom: 8px;
            }

            .appointment-client {
                font-size: 14px;
                font-weight: 700;
                color: #1f2937;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex: 1;
            }

            .appointment-status {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--success-color);
                flex-shrink: 0;
                margin-left: 8px;
            }

            .appointment-service {
                font-size: 12px;
                color: #6b7280;
                margin-bottom: 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .appointment-footer {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-top: auto;
            }

            .appointment-time {
                font-size: 11px;
                font-weight: 600;
                color: #9ca3af;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .appointment-duration {
                font-size: 10px;
                background: rgba(0, 0, 0, 0.05);
                padding: 2px 8px;
                border-radius: 12px;
                font-weight: 600;
            }

            /* Service type colors - More vibrant */
            .service-massage {
                border-left-color: #3b82f6;
                background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            }
            .service-facial {
                border-left-color: #a855f7;
                background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            }
            .service-manicure {
                border-left-color: #f43f5e;
                background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
            }
            .service-pedicure {
                border-left-color: #78350f;
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            }
            .service-haircut {
                border-left-color: #22c55e;
                background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            }
            .service-waxing {
                border-left-color: #f97316;
                background: linear-gradient(135deg, #ffeedd5 0%, #fed7aa 100%);
            }
            .service-default {
                border-left-color: #6b7280;
                background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            }

            /* Current Time Indicator */
            .current-time-line {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 2px;
                background: var(--danger-color);
                z-index: 20;
                pointer-events: none;
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            }

            .current-time-line::before {
                content: "";
                position: absolute;
                top: -6px;
                left: -6px;
                width: 14px;
                height: 14px;
                background: var(--danger-color);
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
                animation: currentTimePulse 2s infinite;
            }

            .current-time-label {
                position: absolute;
                top: 16px;
                left: 6px;
                background: var(--danger-color);
                color: white;
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
                box-shadow: var(--shadow-md);
            }

            @keyframes currentTimePulse {
                0%,
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.2);
                    opacity: 0.8;
                }
            }

            /* Context Menu - Enhanced */
            .context-menu {
                position: fixed;
                background: white;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                box-shadow: var(--shadow-xl);
                padding: 8px;
                min-width: 220px;
                z-index: 1000;
                display: none;
                animation: contextMenuFadeIn 0.2s ease;
            }

            @keyframes contextMenuFadeIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .context-menu.show {
                display: block;
            }

            .context-menu-item {
                padding: 12px 16px;
                cursor: pointer;
                font-size: 14px;
                color: #1f2937;
                display: flex;
                align-items: center;
                gap: 12px;
                transition: all 0.2s;
                border-radius: 8px;
                font-weight: 500;
            }

            .context-menu-item:hover {
                background: var(--hover-bg);
                color: var(--primary-color);
                transform: translateX(4px);
            }

            .context-menu-item i {
                width: 18px;
                text-align: center;
            }

            .context-menu-divider {
                height: 1px;
                background: var(--border-color);
                margin: 8px 0;
            }

            .context-menu-item.danger:hover {
                background: #fee;
                color: var(--danger-color);
            }

            /* Multiple Appointments Styles */
            .appointment-row {
                border: 2px solid #e5e7eb;
                border-radius: 12px;
                padding: 20px;
                margin-bottom: 16px;
                background: white;
                transition: all 0.2s;
                position: relative;
            }

            .appointment-row:hover {
                border-color: var(--primary-color);
                box-shadow: 0 4px 12px rgba(79, 70, 229, 0.1);
            }

            .appointment-row.selected {
                border-color: var(--primary-color);
                background: linear-gradient(135deg, #f8faff 0%, #f3f4f6 100%);
            }

            .appointment-row-header {
                display: flex;
                justify-content: between;
                align-items: center;
                margin-bottom: 16px;
            }

            .appointment-number {
                background: var(--primary-color);
                color: white;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                font-size: 14px;
            }

            .remove-appointment-btn {
                background: var(--danger-color);
                color: white;
                border: none;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            }

            .remove-appointment-btn:hover {
                background: #dc2626;
                transform: scale(1.1);
            }

            .add-appointment-btn {
                background: var(--success-color);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: all 0.2s;
                margin: 20px 0;
            }

            .add-appointment-btn:hover {
                background: #059669;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            }

            .booking-summary {
                background: linear-gradient(135deg, #f8faff 0%, #f3f4f6 100%);
                border: 2px solid var(--primary-color);
                border-radius: 12px;
                padding: 20px;
                margin: 20px 0;
            }

            .summary-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }

            .summary-row:last-child {
                margin-bottom: 0;
                font-weight: 700;
                font-size: 18px;
                border-top: 1px solid var(--border-color);
                padding-top: 12px;
                margin-top: 12px;
            }

            .timeline-preview {
                background: white;
                border-radius: 8px;
                padding: 12px;
                margin-top: 12px;
                border: 1px solid var(--border-color);
            }

            .timeline-bar {
                height: 40px;
                background: #f3f4f6;
                border-radius: 6px;
                position: relative;
                overflow: hidden;
            }

            .timeline-appointment {
                position: absolute;
                top: 4px;
                bottom: 4px;
                border-radius: 4px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                font-weight: 600;
                color: white;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            }

            /* Loading State */
            .loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.95);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 50;
                backdrop-filter: blur(5px);
            }

            .loading-overlay.show {
                display: flex;
            }

            .spinner {
                width: 50px;
                height: 50px;
                border: 4px solid #e5e7eb;
                border-top-color: var(--primary-color);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* Scrollbar Styling */
            ::-webkit-scrollbar {
                width: 14px;
                height: 14px;
            }

            ::-webkit-scrollbar-track {
                background: #f3f4f6;
                border-radius: 10px;
                border: 2px solid #e5e7eb;
            }

            ::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
                border: 2px solid #f3f4f6;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, #5a67d8 0%, #6b3fa0 100%);
            }

            ::-webkit-scrollbar-corner {
                background: #f3f4f6;
            }

            /* Empty State */
            .empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: #9ca3af;
                padding: 60px 40px;
                text-align: center;
            }

            .empty-state i {
                font-size: 64px;
                margin-bottom: 20px;
                opacity: 0.3;
            }

            .empty-state h3 {
                font-size: 18px;
                font-weight: 600;
                color: #4b5563;
                margin-bottom: 8px;
            }

            .empty-state p {
                font-size: 14px;
                color: #9ca3af;
                margin: 0;
            }

            /* Client Profile Preview */
            .client-profile-preview {
                background: linear-gradient(135deg, #f8faff 0%, #f3f4f6 100%);
                border: 1px solid var(--border-color);
                border-radius: 12px;
                padding: 16px;
                margin-top: 12px;
                display: none;
            }

            .client-profile-preview.show {
                display: block;
                animation: fadeIn 0.3s ease;
            }

            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .client-info-row {
                display: flex;
                justify-content: space-between;
                margin-bottom: 8px;
            }

            .client-info-row:last-child {
                margin-bottom: 0;
            }

            .client-info-label {
                font-weight: 600;
                color: #6b7280;
            }

            .client-info-value {
                color: #1f2937;
            }

            /* Responsive */
            @media (max-width: 1024px) {
                .staff-sidebar {
                    width: 240px;
                }

                .timeline-hour {
                    min-width: 110px;
                }

                .timeline-hour-slot {
                    min-width: 110px;
                }
            }

            @media (max-width: 768px) {
                .calendar-main-layout {
                    margin: 8px;
                    border-radius: 12px;
                }

                .staff-sidebar {
                    width: 200px;
                }

                .timeline-hour {
                    min-width: 90px;
                }

                .timeline-hour-slot {
                    min-width: 90px;
                }

                .staff-row {
                    height: 90px;
                    padding: 12px;
                }

                .staff-avatar {
                    width: 48px;
                    height: 48px;
                    font-size: 18px;
                }

                .calendar-logo span {
                    display: none;
                }

                .current-date-display {
                    min-width: 150px;
                    font-size: 13px;
                }

                /* Hide stats on mobile */
                .calendar-top-nav > div:nth-child(3) > div:first-child {
                    display: none;
                }
            }
        </style>
    </head>
    <body>
        <!-- Tooltip -->
        <div class="tooltip-custom" id="tooltip"></div>

        <div class="calendar-wrapper">
            <!-- Fixed Top Navigation -->
            <div class="calendar-top-nav">
                <div class="calendar-logo">
                    <i class="fas fa-calendar-check"></i>
                    <span>Unaki Booking</span>
                </div>

                <div class="calendar-date-nav">
                    <button
                        class="date-nav-btn"
                        onclick="navigateDate(-1)"
                        data-tooltip="Previous Day"
                    >
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button
                        class="date-today-btn"
                        onclick="navigateToToday()"
                        data-tooltip="Go to Today"
                    >
                        Today
                    </button>
                    <div class="current-date-display" id="currentDateDisplay">
                        {{ today_date }}
                    </div>
                    <button
                        class="date-nav-btn"
                        onclick="navigateDate(1)"
                        data-tooltip="Next Day"
                    >
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div style="display: flex; align-items: center; gap: 16px">
                    <!-- Quick Stats in Top Bar -->
                    <div style="display: flex; gap: 12px">
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                padding: 8px 12px;
                                background: white;
                                border-radius: 10px;
                                border: 1px solid var(--border-color);
                            "
                        >
                            <i
                                class="fas fa-calendar-check"
                                style="color: var(--primary-color)"
                            ></i>
                            <div>
                                <div
                                    style="
                                        font-size: 16px;
                                        font-weight: 700;
                                        color: #1f2937;
                                    "
                                    id="totalBookings"
                                >
                                    0
                                </div>
                                <div style="font-size: 10px; color: #6b7280">
                                    Total
                                </div>
                            </div>
                        </div>
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                padding: 8px 12px;
                                background: white;
                                border-radius: 10px;
                                border: 1px solid var(--border-color);
                            "
                        >
                            <i
                                class="fas fa-check-circle"
                                style="color: var(--success-color)"
                            ></i>
                            <div>
                                <div
                                    style="
                                        font-size: 16px;
                                        font-weight: 700;
                                        color: #1f2937;
                                    "
                                    id="completedBookings"
                                >
                                    0
                                </div>
                                <div style="font-size: 10px; color: #6b7280">
                                    Done
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="calendar-actions">
                        <button
                            class="action-btn action-btn-primary"
                            onclick="openMultiBookModal()"
                        >
                            <i class="fas fa-plus-circle"></i>
                            New Multi-Appointment
                        </button>
                        <button
                            class="action-icon"
                            onclick="refreshSchedule()"
                            data-tooltip="Refresh Schedule"
                        >
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <a
                            href="{{ url_for('dashboard') }}"
                            class="action-icon"
                            data-tooltip="Back to Dashboard"
                        >
                            <i class="fas fa-home"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Layout -->
            <div class="calendar-main-layout">
                <!-- Staff Sidebar -->
                <div class="staff-sidebar">
                    <!-- Header: 60px height -->
                    <div class="staff-sidebar-header">
                        <span>Staff Members</span>
                        <span class="staff-count"
                            >{{ staff_members|length if staff_members else 0
                            }}</span
                        >
                    </div>

                    <!-- Staff rows start here - each 110px height, matching timeline rows exactly -->
                    <div class="staff-list">
                        {% if staff_members %} {% for staff in staff_members %}
                        <div
                            class="staff-row staff-row-{{ loop.index }}"
                            data-staff-id="{{ staff.id }}"
                            data-tooltip="Click to filter by {{ staff.first_name }}"
                        >
                            <div class="staff-avatar">
                                {{ (staff.first_name[:1] +
                                staff.last_name[:1]).upper() if staff.first_name
                                and staff.last_name else
                                staff.username[:2].upper() }}
                            </div>
                            <div class="staff-info">
                                <div class="staff-name">
                                    {{ staff.first_name }} {{ staff.last_name if
                                    staff.last_name else '' }}
                                </div>
                                <div class="staff-role">
                                    {{ staff.role or 'Therapist' }}
                                </div>
                                <div class="staff-status">
                                    <span class="status-dot"></span>
                                    Available
                                </div>
                            </div>
                        </div>
                        {% endfor %} {% else %}
                        <div class="empty-state">
                            <i class="fas fa-user-plus"></i>
                            <h3>No Staff Members</h3>
                            <p>
                                Add staff members to start booking appointments
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Timeline Panel -->
                <div class="timeline-panel">
                    <!-- Timeline Header: 60px height (matches staff header) -->
                    <div class="timeline-header">
                        {% for hour in range(9, 22) %}
                        <div
                            class="timeline-hour"
                            data-tooltip="Click any slot to book"
                        >
                            <span class="hour-label">
                                {{ '%d:00' % hour if hour < 12 else ('12:00' if
                                hour == 12 else '%d:00' % (hour - 12)) }}
                            </span>
                            <span class="hour-period"
                                >{{ 'AM' if hour < 12 else 'PM' }}</span
                            >
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Timeline Grid -->
                    <!-- Each timeline-row is 110px height, perfectly matching each staff-row -->
                    <div class="timeline-grid" id="timelineGrid">
                        {% if staff_members %} {% for staff in staff_members %}
                        <div
                            class="timeline-row"
                            data-staff-id="{{ staff.id }}"
                        >
                            {% for hour in range(9, 22) %}
                            <div
                                class="timeline-hour-slot"
                                data-hour="{{ hour }}"
                                data-staff-id="{{ staff.id }}"
                                onclick="handleSlotClick(event, {{ staff.id }}, {{ hour }}, 0)"
                            >
                                <div class="interval-marker interval-15"></div>
                                <div class="interval-marker interval-30"></div>
                                <div class="interval-marker interval-45"></div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %} {% else %}
                        <div class="empty-state">
                            <i class="fas fa-calendar-plus"></i>
                            <h3>Ready to Start Booking</h3>
                            <p>
                                Add staff members to begin scheduling
                                appointments
                            </p>
                        </div>
                        {% endif %}

                        <!-- Current Time Line -->
                        <div
                            class="current-time-line"
                            id="currentTimeLine"
                            style="display: none"
                        >
                            <div
                                class="current-time-label"
                                id="currentTimeLabel"
                            >
                                Now
                            </div>
                        </div>
                    </div>

                    <!-- Loading Overlay -->
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context Menu -->
        <div class="context-menu" id="contextMenu">
            <div class="context-menu-item" onclick="viewAppointmentDetails()">
                <i class="fas fa-eye"></i>
                View Details
            </div>
            <div class="context-menu-item" onclick="editAppointment()">
                <i class="fas fa-edit"></i>
                Edit Appointment
            </div>
            <div class="context-menu-item" onclick="checkInAppointment()">
                <i class="fas fa-user-check"></i>
                Check In Client
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item" onclick="duplicateAppointment()">
                <i class="fas fa-copy"></i>
                Duplicate
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item danger" onclick="cancelAppointment()">
                <i class="fas fa-times-circle"></i>
                Cancel Appointment
            </div>
        </div>

        <!-- Multiple Appointments Booking Modal -->
        <div class="modal fade" id="multiBookModal" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
                <div
                    class="modal-content"
                    style="
                        border-radius: 16px;
                        border: none;
                        box-shadow: var(--shadow-xl);
                        max-height: 90vh;
                    "
                >
                    <div
                        class="modal-header"
                        style="
                            border-bottom: 2px solid var(--border-color);
                            padding: 20px 24px;
                            background: linear-gradient(
                                135deg,
                                #667eea 0%,
                                #764ba2 100%
                            );
                        "
                    >
                        <h5
                            class="modal-title"
                            style="
                                font-weight: 700;
                                font-size: 20px;
                                color: white;
                            "
                        >
                            <i class="fas fa-calendar-plus me-2"></i>
                            Book Multiple Appointments - Single Client
                        </h5>
                        <button
                            type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body" style="padding: 24px">
                        <!-- Client Information Section -->
                        <div class="mb-4">
                            <h6
                                style="
                                    color: var(--primary-color);
                                    font-weight: 700;
                                    margin-bottom: 16px;
                                "
                            >
                                <i class="fas fa-user-circle"></i>
                                Client Information
                            </h6>

                            <!-- Client Selection -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        <i
                                            class="fas fa-users me-2"
                                            style="color: var(--primary-color)"
                                        ></i>
                                        Select Client *
                                    </label>
                                    <select
                                        id="multiClientSelect"
                                        class="form-select"
                                        required
                                        onchange="showClientPreview(this.value)"
                                        style="
                                            border-radius: 10px;
                                            padding: 12px;
                                        "
                                    >
                                        <option value="">Select a client...</option>
                                        <option value="new">
                                            + Add New Client
                                        </option>
                                        {% if clients %} {% for client in clients
                                        %}
                                        <option
                                            value="{{ client.id }}"
                                            data-phone="{{ client.phone }}"
                                            data-email="{{ client.email }}"
                                            data-visits="{{ client.total_visits or 0 }}"
                                            data-last-visit="{{ client.last_visit.strftime('%Y-%m-%d') if client.last_visit else 'Never' }}"
                                        >
                                            {{ client.full_name }}
                                        </option>
                                        {% endfor %} {% endif %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <!-- New Client Fields -->
                                    <div id="newClientFieldsMulti" style="display: none">
                                        <label class="form-label fw-semibold">
                                            <i
                                                class="fas fa-user-plus me-2"
                                                style="color: var(--primary-color)"
                                            ></i>
                                            New Client Name *
                                        </label>
                                        <input
                                            type="text"
                                            id="newClientNameMulti"
                                            class="form-control"
                                            placeholder="Enter new client name"
                                            style="
                                                border-radius: 10px;
                                                padding: 12px;
                                            "
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- Client Profile Preview -->
                            <div class="client-profile-preview" id="clientProfilePreview">
                                <div class="client-info-row">
                                    <span class="client-info-label">Phone:</span>
                                    <span class="client-info-value" id="previewPhone">-</span>
                                </div>
                                <div class="client-info-row">
                                    <span class="client-info-label">Email:</span>
                                    <span class="client-info-value" id="previewEmail">-</span>
                                </div>
                                <div class="client-info-row">
                                    <span class="client-info-label">Total Visits:</span>
                                    <span class="client-info-value" id="previewVisits">0</span>
                                </div>
                                <div class="client-info-row">
                                    <span class="client-info-label">Last Visit:</span>
                                    <span class="client-info-value" id="previewLastVisit">Never</span>
                                </div>
                            </div>
                        </div>

                        <!-- Appointments List Section -->
                        <div class="mb-4">
                            <h6
                                style="
                                    color: var(--primary-color);
                                    font-weight: 700;
                                    margin-bottom: 16px;
                                "
                            >
                                <i class="fas fa-list"></i>
                                Appointment(s)
                            </h6>

                            <div id="appointmentsList">
                                <!-- First appointment row (always present) -->
                                <div class="appointment-row" data-appointment-index="1">
                                    <div class="appointment-row-header">
                                        <div class="appointment-number">1</div>
                                        <h6 style="margin: 0; flex: 1; padding-left: 12px">Appointment #1</h6>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Service *</label>
                                            <select class="form-select service-select" required onchange="updateAppointmentDetails(1)">
                                                <option value="">Select service...</option>
                                                {% if services %} {% for service in services %}
                                                <option
                                                    value="{{ service.id }}"
                                                    data-duration="{{ service.duration }}"
                                                    data-price="{{ service.price }}"
                                                >
                                                    {{ service.name }} - ${{ service.price }} ({{ service.duration }} min)
                                                </option>
                                                {% endfor %} {% endif %}
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Assigned Staff *</label>
                                            <select class="form-select staff-select" required>
                                                <option value="">Select staff...</option>
                                                {% if staff_members %} {% for staff in staff_members %}
                                                <option value="{{ staff.id }}">
                                                    {{ staff.first_name }} {{ staff.last_name }}
                                                </option>
                                                {% endfor %} {% endif %}
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Date *</label>
                                            <input type="date" class="form-control date-input" required value="{{ today }}">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Start Time *</label>
                                            <input type="time" class="form-control time-input" required onchange="updateEndTime(1)">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">End Time</label>
                                            <input type="time" class="form-control end-time-input" readonly
                                                   style="background-color: #f8f9fa;">
                                        </div>
                                        <div class="col-12 mb-3">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <small class="text-muted">
                                                        <i class="fas fa-clock me-1"></i>
                                                        Duration: <span class="duration-display">- minutes</span>
                                                    </small>
                                                </div>
                                                <div class="col-md-6 text-end">
                                                    <small class="text-muted">
                                                        <i class="fas fa-dollar-sign me-1"></i>
                                                        Price: $<span class="price-display">0.00</span>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Add Another Appointment Button -->
                            <button
                                type="button"
                                class="add-appointment-btn"
                                onclick="addAnotherAppointment()"
                            >
                                <i class="fas fa-plus"></i>
                                Add Another Appointment
                            </button>
                        </div>

                        <!-- Booking Summary Section -->
                        <div class="booking-summary">
                            <h6 style="color: var(--primary-color); font-weight: 700; margin-bottom: 16px;">
                                <i class="fas fa-calculator"></i>
                                Booking Summary
                            </h6>

                            <div class="summary-row">
                                <span>Total Appointments:</span>
                                <strong id="totalAppointments">1</strong>
                            </div>
                            <div class="summary-row">
                                <span>Total Duration:</span>
                                <strong id="totalDuration">0 minutes</strong>
                            </div>
                            <div class="summary-row">
                                <span>Total Price:</span>
                                <strong id="totalPrice">$0.00</strong>
                            </div>

                            <!-- Timeline Preview -->
                            <div class="timeline-preview">
                                <label style="font-weight: 600; margin-bottom: 8px;">Timeline Preview:</label>
                                <div class="timeline-bar" id="timelineBarPreview">
                                    <small style="position: absolute; top: -20px; left: 0; font-size: 10px; color: #6b7280;">9 AM</small>
                                    <small style="position: absolute; top: -20px; right: 0; font-size: 10px; color: #6b7280;">6 PM</small>
                                </div>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-sticky-note me-2" style="color: var(--primary-color)"></i>
                                General Notes
                            </label>
                            <textarea
                                id="generalNotes"
                                class="form-control"
                                rows="3"
                                placeholder="Any special instructions or notes for all appointments..."
                                style="border-radius: 10px;"
                            ></textarea>
                        </div>
                    </div>

                    <!-- Modal Footer -->
                    <div class="modal-footer" style="padding: 20px 24px; border-top: 2px solid var(--border-color);">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                            style="padding: 10px 20px; border-radius: 8px;"
                        >
                            <i class="fas fa-times me-2"></i>
                            Cancel
                        </button>
                        <button
                            type="button"
                            class="btn btn-primary"
                            id="bookAllAppointments"
                            onclick="bookAppointments()"
                            style="
                                padding: 10px 20px;
                                border-radius: 8px;
                                background: var(--primary-color);
                                border-color: var(--primary-color);
                            "
                        >
                            <i class="fas fa-calendar-check me-2"></i>
                            Book All Appointments
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Include existing JavaScript -->
        <script src="{{ url_for('static', filename='js/main.js') }}"></script>
        <script src="{{ url_for('static', filename='js/appointment_context_menu.js') }}"></script>

        <!-- Enhanced Multiple Appointments JavaScript -->
        <script>
            let appointmentCounter = 1;
            let scheduleData = null;

            // Get current date for display
            function getCurrentDateForDisplay() {
                const today = new Date();
                const options = {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                };
                return today.toLocaleDateString('en-US', options);
            }

            // Get current date in YYYY-MM-DD format
            function getCurrentDateString() {
                const today = new Date();
                return today.toISOString().split('T')[0];
            }

            // Navigate date function
            function navigateDate(direction) {
                console.log(`🗓️ Navigating date by ${direction} days`);

                const currentDateStr = (window.currentSelectedDate || getCurrentDateString()).trim();
                const currentDate = new Date(currentDateStr);
                const newDate = new Date(currentDate);
                newDate.setDate(currentDate.getDate() + direction);

                const newDateStr = newDate.toISOString().split('T')[0];
                window.currentSelectedDate = newDateStr;

                // Update display
                updateCurrentDateDisplay(newDate);

                // Refresh schedule
                refreshSchedule();
            }

            // Navigate to today
            function navigateToToday() {
                console.log('🏠 Navigating to today');
                const today = getCurrentDateString();
                window.currentSelectedDate = today;

                // Update display
                updateCurrentDateDisplay(new Date());

                // Refresh schedule
                refreshSchedule();
            }

            // Update date display
            function updateCurrentDateDisplay(date) {
                const displayElement = document.getElementById('currentDateDisplay');
                if (displayElement) {
                    const options = {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    };
                    displayElement.textContent = date.toLocaleDateString('en-US', options);
                }
            }

            // Load schedule data from API
            async function loadScheduleData(date) {
                console.log('🔄 Starting schedule render...');

                try {
                    showLoadingOverlay(true);

                    // Use provided date or current selected date, ensure it's trimmed
                    const targetDate = (date || window.currentSelectedDate || getCurrentDateString()).trim();

                    // Fetch schedule data with properly encoded date
                    const response = await fetch(`/api/unaki/schedule?date=${encodeURIComponent(targetDate)}`);
                    const data = await response.json();

                    console.log('📊 Schedule data:', data);

                    if (data.success) {
                        return data;
                    } else {
                        console.error('Failed to load schedule data:', data.error);
                        showNotification('Failed to load schedule data: ' + (data.error || 'Unknown error'), 'error');
                        return { staff: [], appointments: [], breaks: [] };
                    }
                } catch (error) {
                    console.error('Error loading schedule data:', error);
                    showNotification('Error loading schedule. Please refresh the page.', 'error');
                    return { staff: [], appointments: [], breaks: [] };
                } finally {
                    showLoadingOverlay(false);
                }
            }

            // Initialize the page
            document.addEventListener('DOMContentLoaded', function() {
                console.log('🚀 Unaki Booking System initialized');

                // Initialize current date
                const today = getCurrentDateString();
                window.currentSelectedDate = today;
                updateCurrentDateDisplay(new Date());

                console.log('📅 Initial date set to:', today);

                // Load initial schedule
                refreshSchedule();

                // Setup current time indicator
                setupCurrentTimeIndicator();

                // Setup keyboard shortcuts
                setupKeyboardShortcuts();

                // Initialize context menu
                setTimeout(() => {
                    if (typeof reinitializeContextMenu === 'function') {
                        reinitializeContextMenu();
                    }
                }, 1000);
            });


            function openMultiBookModal() {
                const modal = new bootstrap.Modal(document.getElementById('multiBookModal'));
                resetMultiBookForm();
                modal.show();
            }

            function resetMultiBookForm() {
                appointmentCounter = 1;
                document.getElementById('multiClientSelect').value = '';
                document.getElementById('clientProfilePreview').classList.remove('show');
                document.getElementById('newClientFieldsMulti').style.display = 'none';

                // Reset appointments list to just one appointment
                const appointmentsList = document.getElementById('appointmentsList');
                appointmentsList.innerHTML = createAppointmentRow(1);

                updateBookingSummary();
                updateTimelinePreview();
            }

            function showClientPreview(clientId) {
                const preview = document.getElementById('clientProfilePreview');
                const newClientFields = document.getElementById('newClientFieldsMulti');

                if (clientId === 'new') {
                    preview.classList.remove('show');
                    newClientFields.style.display = 'block';
                    // Clear new client name if it was previously filled
                    document.getElementById('newClientNameMulti').value = '';
                    return;
                } else {
                    newClientFields.style.display = 'none';
                }

                if (!clientId) {
                    preview.classList.remove('show');
                    return;
                }

                const option = document.querySelector(`#multiClientSelect option[value="${clientId}"]`);
                if (option) {
                    document.getElementById('previewPhone').textContent = option.dataset.phone || '-';
                    document.getElementById('previewEmail').textContent = option.dataset.email || '-';
                    document.getElementById('previewVisits').textContent = option.dataset.visits || '0';
                    document.getElementById('previewLastVisit').textContent = option.dataset.lastVisit || 'Never';
                    preview.classList.add('show');
                }
            }

            function createAppointmentRow(index) {
                // Get today's date in YYYY-MM-DD format
                const today = new Date().toISOString().split('T')[0];

                return `
                    <div class="appointment-row" data-appointment-index="${index}">
                        <div class="appointment-row-header">
                            <div class="appointment-number">${index}</div>
                            <h6 style="margin: 0; flex: 1; padding-left: 12px">Appointment #${index}</h6>
                            ${index > 1 ? `
                                <button type="button" class="remove-appointment-btn" onclick="removeAppointment(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Service *</label>
                                <select class="form-select service-select" required onchange="updateAppointmentDetails(${index})">
                                    <option value="">Select service...</option>
                                    {% if services %} {% for service in services %}
                                    <option
                                        value="{{ service.id }}"
                                        data-duration="{{ service.duration }}"
                                        data-price="{{ service.price }}"
                                    >
                                        {{ service.name }} - ${{ service.price }} ({{ service.duration }} min)
                                    </option>
                                    {% endfor %} {% endif %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Assigned Staff *</label>
                                <select class="form-select staff-select" required>
                                    <option value="">Select staff...</option>
                                    {% if staff_members %} {% for staff in staff_members %}
                                    <option value="{{ staff.id }}">
                                        {{ staff.first_name }} {{ staff.last_name }}
                                    </option>
                                    {% endfor %} {% endif %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Date *</label>
                                <input type="date" class="form-control date-input" required value="${today}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Start Time *</label>
                                <input type="time" class="form-control time-input" required onchange="updateEndTime(${index})">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-control end-time-input" readonly
                                       style="background-color: #f8f9fa;">
                            </div>
                            <div class="col-12 mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            Duration: <span class="duration-display">- minutes</span>
                                        </small>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <small class="text-muted">
                                            <i class="fas fa-dollar-sign me-1"></i>
                                            Price: $<span class="price-display">0.00</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            function addAnotherAppointment() {
                appointmentCounter++;
                const appointmentsList = document.getElementById('appointmentsList');
                appointmentsList.insertAdjacentHTML('beforeend', createAppointmentRow(appointmentCounter));
                updateBookingSummary();
                updateTimelinePreview();
            }

            function removeAppointment(index) {
                const appointmentRow = document.querySelector(`[data-appointment-index="${index}"]`);
                if (appointmentRow) {
                    appointmentRow.remove();
                    updateBookingSummary();
                    // Update appointment numbers if needed, but for now, just re-render summary and preview
                    updateTimelinePreview();
                }
            }

            function updateAppointmentDetails(index) {
                const appointmentRow = document.querySelector(`[data-appointment-index="${index}"]`);
                const serviceSelect = appointmentRow.querySelector('.service-select');
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

                if (selectedOption.value) {
                    const duration = selectedOption.dataset.duration;
                    const price = selectedOption.dataset.price;

                    appointmentRow.querySelector('.duration-display').textContent = duration + ' minutes';
                    appointmentRow.querySelector('.price-display').textContent = parseFloat(price).toFixed(2);

                    updateEndTime(index);
                    updateBookingSummary();
                    updateTimelinePreview();
                } else {
                    // Reset if no service is selected
                    appointmentRow.querySelector('.duration-display').textContent = '- minutes';
                    appointmentRow.querySelector('.price-display').textContent = '0.00';
                    appointmentRow.querySelector('.end-time-input').value = '';
                    updateBookingSummary();
                    updateTimelinePreview();
                }
            }

            function updateEndTime(index) {
                const appointmentRow = document.querySelector(`[data-appointment-index="${index}"]`);
                const timeInput = appointmentRow.querySelector('.time-input');
                const endTimeInput = appointmentRow.querySelector('.end-time-input');
                const serviceSelect = appointmentRow.querySelector('.service-select');
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

                if (timeInput.value && selectedOption.value) {
                    const startTime = timeInput.value;
                    const duration = parseInt(selectedOption.dataset.duration);

                    const [hours, minutes] = startTime.split(':').map(Number);
                    const startDate = new Date();
                    startDate.setHours(hours, minutes, 0, 0);

                    const endDate = new Date(startDate.getTime() + duration * 60000);
                    const endTime = endDate.toTimeString().slice(0, 5);

                    endTimeInput.value = endTime;
                    updateTimelinePreview();
                } else {
                    endTimeInput.value = ''; // Clear end time if start time or service is missing
                }
            }

            function updateBookingSummary() {
                const appointmentRows = document.querySelectorAll('.appointment-row');
                let totalCount = appointmentRows.length;
                let totalDuration = 0;
                let totalPrice = 0;

                appointmentRows.forEach(row => {
                    const serviceSelect = row.querySelector('.service-select');
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

                    if (selectedOption && selectedOption.value) {
                        totalDuration += parseInt(selectedOption.dataset.duration);
                        totalPrice += parseFloat(selectedOption.dataset.price);
                    }
                });

                document.getElementById('totalAppointments').textContent = totalCount;
                document.getElementById('totalDuration').textContent = totalDuration + ' minutes';
                document.getElementById('totalPrice').textContent = '$' + totalPrice.toFixed(2);
            }

            function updateTimelinePreview() {
                const timelineBar = document.getElementById('timelineBarPreview');
                timelineBar.innerHTML = `
                    <small style="position: absolute; top: -20px; left: 0; font-size: 10px; color: #6b7280;">9 AM</small>
                    <small style="position: absolute; top: -20px; right: 0; font-size: 10px; color: #6b7280;">6 PM</small>
                `; // Reset and add labels

                const appointmentRows = document.querySelectorAll('.appointment-row');
                const appointments = [];

                appointmentRows.forEach(row => {
                    const timeInput = row.querySelector('.time-input');
                    const serviceSelect = row.querySelector('.service-select');
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];

                    if (timeInput.value && selectedOption && selectedOption.value) {
                        const startTime = timeInput.value;
                        const duration = parseInt(selectedOption.dataset.duration);
                        const serviceName = selectedOption.textContent.split(' - ')[0];

                        appointments.push({
                            startTime,
                            duration,
                            serviceName
                        });
                    }
                });

                // Sort appointments by start time
                appointments.sort((a, b) => a.startTime.localeCompare(b.startTime));

                // Add appointments to timeline (simplified visualization)
                appointments.forEach((apt, index) => {
                    const [hours, minutes] = apt.startTime.split(':').map(Number);
                    // Calculate minutes from 9 AM (which is 9 * 60 minutes from midnight)
                    const startMinutesFrom9AM = (hours - 9) * 60 + minutes;
                    // Total duration of the visible timeline in minutes (9 AM to 6 PM = 9 hours = 540 minutes)
                    const totalTimelineMinutes = 9 * 60;

                    const leftPercentage = (startMinutesFrom9AM / totalTimelineMinutes) * 100;
                    // Ensure width calculation considers the total timeline duration
                    const widthPercentage = (apt.duration / totalTimelineMinutes) * 100;

                    const colors = ['#3b82f6', '#a855f7', '#f43f5e', '#22c55e', '#f97316'];
                    const color = colors[index % colors.length];

                    const appointmentElement = document.createElement('div');
                    appointmentElement.className = 'timeline-appointment';
                    appointmentElement.style.left = leftPercentage + '%';
                    appointmentElement.style.width = Math.max(widthPercentage, 2) + '%'; // Minimum width to be visible
                    appointmentElement.style.backgroundColor = color;
                    appointmentElement.textContent = apt.serviceName.substring(0, 10) + (apt.serviceName.length > 10 ? '...' : '');
                    appointmentElement.title = `${apt.serviceName} (${apt.startTime} - ${apt.duration} min)`;

                    timelineBar.appendChild(appointmentElement);
                });
            }

            // Function to collect appointment data from the form
            function collectAppointmentData() {
                const appointments = [];
                document.querySelectorAll('.appointment-row').forEach((row, index) => {
                    const serviceSelect = row.querySelector('.service-select');
                    const staffSelect = row.querySelector('.staff-select');
                    const dateInput = row.querySelector('.date-input');
                    const timeInput = row.querySelector('.time-input');
                    const endTimeInput = row.querySelector('.end-time-input');
                    const serviceOption = serviceSelect.options[serviceSelect.selectedIndex];

                    const selectedClientId = document.getElementById('multiClientSelect').value;
                    const clientNameInput = document.getElementById('newClientNameMulti');
                    const generalNotesInput = document.getElementById('generalNotes');

                    const appointmentData = {
                        appointmentIndex: index + 1, // For display/debugging
                        serviceId: serviceSelect.value,
                        service: serviceOption.textContent.split(' - ')[0], // Extract service name
                        duration: serviceOption.dataset.duration,
                        price: serviceOption.dataset.price,
                        staffId: staffSelect.value,
                        date: dateInput.value,
                        startTime: timeInput.value,
                        endTime: endTimeInput.value,
                        clientId: selectedClientId === 'new' ? null : (selectedClientId || null),
                        clientName: selectedClientId === 'new' ? clientNameInput.value.trim() : (selectedClientId ? document.querySelector(`#multiClientSelect option[value="${selectedClientId}"]`).textContent.trim() : ''),
                        clientPhone: selectedClientId === 'new' ? '' : (selectedClientId ? document.querySelector(`#multiClientSelect option[value="${selectedClientId}"]`).dataset.phone : ''),
                        clientEmail: selectedClientId === 'new' ? '' : (selectedClientId ? document.querySelector(`#multiClientSelect option[value="${selectedClientId}"]`).dataset.email : ''),
                        notes: generalNotesInput.value.trim()
                    };
                    appointments.push(appointmentData);
                });
                return appointments;
            }

            // Function to validate a single appointment
            function validateAppointment(appointment, index) {
                if (!appointment.serviceId) {
                    return { isValid: false, error: `Appointment #${index}: Please select a service.` };
                }
                if (!appointment.staffId) {
                    return { isValid: false, error: `Appointment #${index}: Please select an assigned staff.` };
                }
                if (!appointment.date) {
                    return { isValid: false, error: `Appointment #${index}: Please select a date.` };
                }
                if (!appointment.startTime) {
                    return { isValid: false, error: `Appointment #${index}: Please select a start time.` };
                }
                if (!appointment.endTime) {
                    return { isValid: false, error: `Appointment #${index}: End time is missing. Ensure duration is correctly set.` };
                }
                // Add more validations as needed (e.g., checking for conflicts if possible client-side)
                return { isValid: true, error: null };
            }

            // Helper function to show alerts
            function showAlert(message, type = 'info') {
                // Use Bootstrap's toast or a custom alert system if available
                // For simplicity, using alert() for now
                alert(message);
                console.log(`Alert (${type.toUpperCase()}): ${message}`);
            }


            // Book appointments function with improved error handling
            async function bookAppointments() {
                console.log('📝 Starting appointment booking process...');

                const appointments = collectAppointmentData();
                if (appointments.length === 0) {
                    showAlert('Please add at least one appointment before booking.', 'warning');
                    return;
                }

                console.log('📋 Collected appointments:', appointments);

                // Validate all appointments
                for (let i = 0; i < appointments.length; i++) {
                    const apt = appointments[i];
                    const validation = validateAppointment(apt, i + 1);
                    if (!validation.isValid) {
                        showAlert(validation.error, 'danger');
                        return;
                    }
                }

                // Show loading state
                const bookBtn = document.getElementById('bookAllAppointments');
                const originalText = bookBtn.innerHTML;
                bookBtn.disabled = true;
                bookBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Booking...';

                try {
                    // Book each appointment with improved error handling
                    const results = [];
                    for (let i = 0; i < appointments.length; i++) {
                        const apt = appointments[i];
                        console.log(`🔄 Booking appointment ${i + 1}:`, apt);

                        // Ensure all required fields are present and properly formatted
                        const bookingData = {
                            staffId: parseInt(apt.staffId),
                            clientName: apt.clientName.trim(),
                            serviceType: apt.service.trim(),
                            startTime: apt.startTime,
                            endTime: apt.endTime,
                            date: apt.date || getCurrentDate(),
                            clientPhone: apt.clientPhone || '',
                            clientEmail: apt.clientEmail || '',
                            notes: apt.notes || '',
                            clientId: apt.clientId ? parseInt(apt.clientId) : null
                        };

                        console.log(`📤 Sending booking data:`, bookingData);

                        const response = await fetch('/api/unaki/appointments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(bookingData)
                        });

                        // Check if response is OK
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error(`HTTP Error ${response.status}:`, errorText);
                            throw new Error(`Server error (${response.status}): ${errorText}`);
                        }

                        let result;
                        try {
                            result = await response.json();
                        } catch (parseError) {
                            console.error('JSON parse error:', parseError);
                            throw new Error('Invalid response from server. Please try again.');
                        }

                        console.log(`📊 Booking result ${i + 1}:`, result);

                        if (result.success) {
                            results.push({
                                success: true,
                                appointment: apt,
                                id: result.appointmentId,
                                message: result.message
                            });
                        } else {
                            throw new Error(result.error || `Booking failed for appointment ${i + 1}`);
                        }
                    }

                    // All bookings successful
                    console.log('🎉 All appointments booked successfully:', results);
                    showAlert(`Successfully booked ${results.length} appointment(s)!`, 'success');

                    // Reset form and reload schedule
                    resetBookingForm();
                    await loadScheduleData();

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('multiBookModal'));
                    if (modal) {
                        modal.hide();
                    }

                } catch (error) {
                    console.error('❌ Booking error:', error);
                    let errorMessage = 'Error booking appointments. ';

                    if (error.message.includes('fetch')) {
                        errorMessage += 'Network error. Please check your connection and try again.';
                    } else if (error.message.includes('Server error')) {
                        errorMessage += 'Server error. Please try again in a moment.';
                    } else {
                        errorMessage += error.message || 'Please check all fields and try again.';
                    }

                    showAlert(errorMessage, 'danger');
                } finally {
                    // Reset button state
                    bookBtn.disabled = false;
                    bookBtn.innerHTML = originalText;
                }
            }

            // Helper function to get current date
            function getCurrentDate() {
                const today = new Date();
                return today.toISOString().split('T')[0];
            }

            // Function to reset the multi-book form
            function resetBookingForm() {
                document.getElementById('multiClientSelect').value = '';
                document.getElementById('clientProfilePreview').classList.remove('show');
                document.getElementById('newClientFieldsMulti').style.display = 'none';
                document.getElementById('newClientNameMulti').value = '';

                const appointmentsList = document.getElementById('appointmentsList');
                appointmentsList.innerHTML = createAppointmentRow(1); // Reset to one appointment

                document.getElementById('generalNotes').value = '';
                updateBookingSummary();
                updateTimelinePreview();
            }

            // Initialize event listeners for dynamic content
            function initializeEventListeners() {
                // Add event listeners for dynamic content
                document.addEventListener('change', function(e) {
                    if (e.target.classList.contains('service-select')) {
                        const appointmentRow = e.target.closest('.appointment-row');
                        const index = appointmentRow.dataset.appointmentIndex;
                        updateAppointmentDetails(index);
                    }

                    if (e.target.classList.contains('time-input')) {
                        const appointmentRow = e.target.closest('.appointment-row');
                        const index = appointmentRow.dataset.appointmentIndex;
                        updateEndTime(index);
                    }
                });
            }

            // Load schedule data and existing functions
            function loadScheduleData(date) { // Renamed from 'refreshSchedule' to avoid conflict
                const currentDate = document.getElementById('currentDateDisplay').textContent;

                fetch(`/api/unaki/schedule?date=${encodeURIComponent(currentDate)}`)
                    .then(response => response.json())
                    .then(data => {
                        scheduleData = data;
                        renderSchedule(data);
                        updateStats(data);
                    })
                    .catch(error => {
                        console.error('Error loading schedule:', error);
                    });
            }

            function renderSchedule(data) {
                if (!data.success) {
                    console.error('Schedule data load failed:', data.error);
                    return;
                }

                console.log('🔄 Starting schedule render...');
                console.log('📊 Schedule data:', data);

                const timelineGrid = document.getElementById('timelineGrid');

                // Clear existing appointments
                document.querySelectorAll('.appointment-block').forEach(block => block.remove());

                // Render appointments
                if (data.appointments) {
                    data.appointments.forEach(appointment => {
                        const staffRow = timelineGrid.querySelector(`[data-staff-id="${appointment.staffId}"]`);
                        if (staffRow) {
                            const appointmentBlock = createAppointmentBlock(appointment);
                            staffRow.appendChild(appointmentBlock);
                        }
                    });
                }

                console.log('✅ Schedule rendered successfully');

                // Reinitialize context menu
                console.log('🔄 Reinitializing context menu after schedule render...');
                initializeContextMenu(); // Assuming this function exists and is needed
            }

            function createAppointmentBlock(appointment) {
                const block = document.createElement('div');
                block.className = 'appointment-block service-default'; // Default class
                block.dataset.appointmentId = appointment.id;

                // Calculate position
                const startTime = appointment.startTime;
                const [hours, minutes] = startTime.split(':').map(Number);
                const startHour = hours;
                const startMinute = minutes;

                // Position calculation (140px per hour, starting from 9 AM)
                // Offset from 9 AM in hours
                const hourOffset = startHour - 9;
                // Offset from the start of the hour in fractions of an hour
                const minuteOffset = startMinute / 60;
                // Total offset in hours from 9 AM
                const totalHourOffset = hourOffset + minuteOffset;
                // Position in pixels (140px per hour)
                const leftPosition = totalHourOffset * 140;

                // Width calculation based on duration
                const durationHours = appointment.duration / 60;
                // Width in pixels (140px per hour), subtract a small amount for spacing/margins if needed
                const width = durationHours * 140 - 8;

                block.style.left = leftPosition + 'px';
                block.style.width = Math.max(width, 80) + 'px'; // Ensure a minimum width

                // Determine service type for styling
                let serviceType = 'default';
                if (appointment.service) {
                    const serviceLower = appointment.service.toLowerCase();
                    if (serviceLower.includes('massage')) serviceType = 'massage';
                    else if (serviceLower.includes('facial')) serviceType = 'facial';
                    else if (serviceLower.includes('manicure')) serviceType = 'manicure';
                    else if (serviceLower.includes('pedicure')) serviceType = 'pedicure';
                    else if (serviceLower.includes('haircut')) serviceType = 'haircut';
                    else if (serviceLower.includes('waxing')) serviceType = 'waxing';
                    // Add more service type mappings as needed
                }

                block.className = `appointment-block service-${serviceType}`;

                block.innerHTML = `
                    <div class="appointment-header">
                        <div class="appointment-client">${appointment.clientName}</div>
                        <div class="appointment-status"></div>
                    </div>
                    <div class="appointment-service">${appointment.service}</div>
                    <div class="appointment-footer">
                        <div class="appointment-time">
                            <i class="fas fa-clock"></i>
                            ${startTime}
                        </div>
                        <div class="appointment-duration">${appointment.duration}m</div>
                    </div>
                `;

                console.log(`🔍 Setting appointment block ID: ${appointment.id} for ${appointment.clientName}`);

                // Add event listeners for drag and context menu
                block.draggable = true;
                block.ondragstart = (e) => {
                    block.classList.add("dragging");
                    e.dataTransfer.effectAllowed = "move";
                    e.dataTransfer.setData("appointmentId", appointment.id);
                };
                block.ondragend = () => {
                    block.classList.remove("dragging");
                };
                block.onclick = () => viewAppointment(appointment.id); // Assuming viewAppointment exists
                block.oncontextmenu = (e) => {
                    showContextMenu(e, appointment.id); // Assuming showContextMenu exists
                    return false;
                };

                return block;
            }

            function updateStats(data) {
                document.getElementById('totalBookings').textContent = data.appointments ? data.appointments.length : 0;
                const completed = data.appointments ? data.appointments.filter(apt => apt.status === 'completed').length : 0;
                document.getElementById('completedBookings').textContent = completed;
            }

            function updateCurrentDate() {
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                document.getElementById('currentDateDisplay').textContent = dateStr;
            }

            function navigateDate(direction) {
                const currentDisplay = document.getElementById('currentDateDisplay');
                const currentDate = new Date(currentDisplay.textContent);
                currentDate.setDate(currentDate.getDate() + direction);

                const newDateStr = currentDate.toISOString().split('T')[0];
                currentDisplay.textContent = newDateStr;
                window.currentSelectedDate = newDateStr; // Ensure window.currentSelectedDate is updated

                loadScheduleData(); // Use loadScheduleData to fetch and render
            }


            function navigateToToday() {
                updateCurrentDate();
                window.currentSelectedDate = getCurrentDateString(); // Ensure window.currentSelectedDate is updated
                loadScheduleData(); // Use loadScheduleData to fetch and render
            }

            function refreshSchedule() {
                loadScheduleData(); // Use loadScheduleData to fetch and render
            }

            function handleSlotClick(event, staffId, hour, minute) {
                console.log(`Slot clicked: Staff ${staffId}, ${hour}:${minute.toString().padStart(2, '0')}`);
                // For now, open the multi-book modal
                openMultiBookModal();
            }

            // Context menu functions (stubs) - These should ideally link to actual logic
            function viewAppointmentDetails() {
                console.log('View appointment details');
                // Implement actual view details logic, possibly using selectedAppointmentId
            }

            function editAppointment() {
                console.log('Edit appointment');
                // Implement actual edit logic
            }

            function checkInAppointment() {
                console.log('Check in appointment');
                // Implement actual check-in logic
            }

            function duplicateAppointment() {
                console.log('Duplicate appointment');
                // Implement actual duplicate logic
            }

            function cancelAppointment() {
                console.log('Cancel appointment');
                // Implement actual cancel logic
            }

            // Assume initializeContextMenu is defined elsewhere or integrate its logic here
            function initializeContextMenu() {
                // This function would typically set up event listeners for showing/hiding the context menu
                // and updating the selectedAppointmentId based on the right-clicked element.
                // For now, it's a placeholder.
                console.log("ContextMenu initialization placeholder.");
            }

            // Dummy function for context menu to avoid errors if not defined elsewhere
            function showContextMenu(event, appointmentId) {
                console.log(`Context menu requested for appointment ${appointmentId}`);
                // In a real scenario, you'd show the context menu here
                // For now, just prevent default and log.
                event.preventDefault();
                // Example: Add 'show' class to context menu element and position it
                // document.getElementById('contextMenu').classList.add('show');
                // document.getElementById('contextMenu').style.left = event.pageX + 'px';
                // document.getElementById('contextMenu').style.top = event.pageY + 'px';
            }

            // Dummy function to avoid errors
            function hideContextMenu() {
                console.log("Context menu hide requested.");
                // Example: document.getElementById('contextMenu').classList.remove('show');
            }

            // Dummy function for viewing appointment
            function viewAppointment(appointmentId) {
                console.log(`Viewing appointment: ${appointmentId}`);
                // Implement actual viewing logic
            }

            // Dummy function for showing loading overlay
            function showLoadingOverlay(show) {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.toggle('show', show);
                }
            }

            // Dummy function for showing notifications
            function showNotification(message, type) {
                console.log(`Notification (${type}): ${message}`);
                // In a real app, this would display a toast or alert
            }

            // Dummy function for setting up current time indicator
            function setupCurrentTimeIndicator() {
                console.log("Setting up current time indicator...");
                // Placeholder for logic to update the current time line
            }

            // Dummy function for setting up keyboard shortcuts
            function setupKeyboardShortcuts() {
                console.log("Setting up keyboard shortcuts...");
                // Placeholder for keyboard shortcut logic
            }

            // Dummy function for reinitializing context menu
            function reinitializeContextMenu() {
                console.log("Reinitializing context menu...");
                // Placeholder for context menu reinitialization
            }

        </script>
    </body>
</html>