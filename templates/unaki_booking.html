<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unaki Appointment Booking</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100;
        }

        .booking-modal .modal-content {
            @apply rounded-xl border-none shadow-2xl;
        }
        .booking-modal .modal-header {
            @apply bg-blue-600 text-white rounded-t-xl;
        }
        .booking-modal .form-input {
            @apply rounded-lg border-gray-300 px-4 py-2;
        }
        .booking-modal .btn-primary {
            @apply bg-blue-600 border-none px-5 py-2.5 rounded-lg transition-colors duration-200 hover:bg-blue-700;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 200px repeat(10, minmax(100px, 1fr));
            grid-template-rows: auto;
            grid-auto-rows: 60px; /* Reduced height for compactness */
            height: 80vh;
            overflow: auto;
            border: 1px solid #9ca3af;
        }

        .grid-cell {
            @apply p-2 text-center text-sm font-semibold text-gray-700 border border-gray-300;
        }

        .time-header {
            @apply grid-cell bg-blue-50 flex items-center justify-center border-l-2 border-gray-400;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .time-header:first-of-type {
            @apply border-l;
        }

        .staff-cell {
            @apply grid-cell flex flex-col items-start justify-center bg-gray-50;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        
        .appointment-cell {
            @apply relative;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            box-sizing: border-box;
        }
        .appointment-cell:nth-child(2n+1) {
            border-right-style: dashed;
        }

        .appointment-block {
            @apply absolute z-20 bg-blue-600 text-white rounded-md p-1 md:p-2 shadow-md hover:shadow-lg transition-shadow duration-200 cursor-pointer overflow-hidden text-ellipsis;
        }
        
        .break-block {
            @apply absolute z-20 bg-yellow-400 text-gray-800 rounded-md p-1 md:p-2 shadow-md cursor-pointer overflow-hidden text-ellipsis;
        }

        /* Dashed lines for 30-minute intervals */
        .half-hour-line {
            @apply absolute top-1/2 left-0 w-full border-t border-dashed border-gray-400;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-5 md:p-10">
    <div class="container mx-auto">
        <!-- Header -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="text-center md:text-left">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                        <i class="fas fa-calendar-alt text-blue-500 mr-2"></i>
                        Unaki Appointment Booking
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">Interactive flexible scheduling system</p>
                </div>
                <div class="flex flex-col md:flex-row items-center gap-4">
                    <div class="flex flex-col items-start">
                        <label for="scheduleDate" class="text-xs text-gray-500 mb-1">Schedule Date:</label>
                        <input type="date" id="scheduleDate" class="form-input text-sm rounded-md border border-gray-300 p-2" onchange="window.bookingSystem.loadScheduleForDate()" />
                    </div>
                    <button class="flex items-center justify-center bg-gray-100 text-gray-600 text-sm font-medium py-2 px-4 rounded-lg shadow-sm transition-all duration-200 hover:bg-gray-200 active:bg-gray-300" onclick="window.bookingSystem.refreshSchedule()">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <button class="flex items-center justify-center bg-green-500 text-white text-sm font-medium py-2 px-4 rounded-lg shadow-md transition-all duration-200 hover:bg-green-600 active:bg-green-700" onclick="window.bookingSystem.seedSampleData()" id="seedDataBtn">
                        <i class="fas fa-database mr-2"></i>Load Sample Data
                    </button>
                </div>
            </div>
            <div class="mt-4 text-center md:text-left">
                <div id="userIdDisplay" class="text-xs text-gray-400"></div>
            </div>
        </div>

        <!-- Schedule Container -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden relative min-h-[600px]">
            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center z-50 transition-opacity duration-300" style="display: none;">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-500 border-t-transparent"></div>
                    <p class="text-gray-500 mt-2">Loading schedule...</p>
                </div>
            </div>

            <!-- Main Schedule Grid -->
            <div id="scheduleGrid" class="schedule-grid">
                <!-- Top-left empty cell -->
                <div class="grid-cell bg-gray-100"></div>

                <!-- Time header cells (generated dynamically) -->

                <!-- Staff cells and appointment cells (generated dynamically) -->
            </div>
        </div>
        
        <!-- Legend -->
        <div class="mt-6 flex flex-wrap gap-4 justify-center md:justify-start">
            <div class="flex items-center gap-2">
                <span class="w-5 h-4 bg-blue-600 rounded-sm"></span>
                <span class="text-sm text-gray-600">Appointments</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-5 h-4 bg-yellow-400 rounded-sm"></span>
                <span class="text-sm text-gray-600">Break Time</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-5 h-4 bg-blue-600 bg-opacity-50 border-2 border-blue-600 border-dashed rounded-sm"></span>
                <span class="text-sm text-gray-600">New Booking</span>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-gray-900 bg-opacity-50">
        <div class="modal-content bg-white p-6 rounded-xl shadow-lg w-full max-w-lg mx-4 md:mx-0">
            <div class="modal-header flex items-center justify-between p-4 rounded-t-xl bg-blue-600">
                <h5 class="text-lg font-semibold text-white">
                    <i class="fas fa-calendar-plus mr-2"></i>
                    New Appointment
                </h5>
                <button type="button" class="text-white opacity-70 hover:opacity-100" onclick="window.bookingSystem.closeBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="bookingForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Client Name *</label>
                            <input type="text" class="form-input w-full" id="clientName" required>
                        </div>
                        <div class="col-span-1">
                            <label for="clientPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input type="tel" class="form-input w-full" id="clientPhone">
                        </div>
                        <div class="col-span-1">
                            <label for="serviceType" class="block text-sm font-medium text-gray-700 mb-1">Service *</label>
                            <select class="form-input w-full" id="serviceType" required>
                                <option value="">Select Service</option>
                                <option value="Facial Treatment">Facial Treatment</option>
                                <option value="Massage Therapy">Massage Therapy</option>
                                <option value="Manicure">Manicure</option>
                                <option value="Pedicure">Pedicure</option>
                                <option value="Waxing">Waxing</option>
                                <option value="Hair Cut">Hair Cut</option>
                                <option value="Hair Coloring">Hair Coloring</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label for="assignedStaff" class="block text-sm font-medium text-gray-700 mb-1">Staff Member *</label>
                            <select class="form-input w-full" id="assignedStaff" required></select>
                        </div>
                        <div class="col-span-1">
                            <label for="startTime" class="block text-sm font-medium text-gray-700 mb-1">Start Time *</label>
                            <input type="time" class="form-input w-full" id="startTime" required>
                        </div>
                        <div class="col-span-1">
                            <label for="endTime" class="block text-sm font-medium text-gray-700 mb-1">End Time *</label>
                            <input type="time" class="form-input w-full" id="endTime" required>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="appointmentNotes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <textarea class="form-input w-full resize-none" id="appointmentNotes" rows="3"></textarea>
                    </form>
                </div>
                <div class="modal-footer p-4 border-t border-gray-200 flex justify-end gap-2">
                    <button type="button" class="bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors" onclick="window.bookingSystem.closeBookingModal()">Cancel</button>
                    <button type="button" class="btn-primary" id="bookAppointmentBtn">
                        <i class="fas fa-check mr-2"></i>Book Appointment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Local Storage Implementation -->
    <script>
        // Simple localStorage-based data management
        const STORAGE_KEY_PREFIX = 'unaki-schedule-';
        
        function getStorageKey(date) {
            return STORAGE_KEY_PREFIX + date;
        }
        
        function saveToLocalStorage(date, data) {
            try {
                localStorage.setItem(getStorageKey(date), JSON.stringify(data));
                console.log('Data saved to localStorage for date:', date);
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                return false;
            }
        }
        
        function loadFromLocalStorage(date) {
            try {
                const data = localStorage.getItem(getStorageKey(date));
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return null;
            }
        }

        class UnakiBookingSystem {
            constructor() {
                this.staff = [];
                this.appointments = [];
                this.breaks = [];
                this.isDragging = false;
                this.dragStart = null;
                this.dragStaffIndex = null;
                this.tempBlock = null;
                this.currentDate = new Date().toISOString().split('T')[0];

                this.init();
            }

            async init() {
                try {
                    console.log('Unaki Booking System initialized successfully');
                    this.setupEventListeners();
                    this.setCurrentDate();
                    this.loadScheduleData();
                } catch (error) {
                    console.error("Error initializing Unaki Booking System:", error);
                    this.showNotification("Error initializing booking system. Please check the console for details.", 'error');
                }
            }

            async loadScheduleData() {
                console.log('Loading schedule data for:', this.currentDate);
                this.showLoading(true);

                // Try to load from localStorage first
                const localData = loadFromLocalStorage(this.currentDate);
                if (localData) {
                    this.staff = localData.staff || [];
                    this.appointments = localData.appointments || [];
                    this.breaks = localData.breaks || [];
                    console.log('Schedule data loaded:', {
                        staff: this.staff.length,
                        appointments: this.appointments.length,
                        breaks: this.breaks.length
                    });
                    this.renderSchedule();
                    this.showNotification('Schedule loaded from local storage.', 'success', 2000);
                } else {
                    // Try to load from Flask API if localStorage is empty
                    try {
                        const response = await fetch(`/api/unaki/schedule/${this.currentDate}`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                this.staff = data.staff || [];
                                this.appointments = data.appointments || [];
                                this.breaks = data.breaks || [];
                                
                                // Save to localStorage for future use
                                this.saveScheduleData();
                                
                                console.log('Schedule data loaded from API:', {
                                    staff: this.staff.length,
                                    appointments: this.appointments.length,
                                    breaks: this.breaks.length
                                });
                                this.renderSchedule();
                                this.showNotification('Schedule loaded from server.', 'success', 2000);
                            } else {
                                throw new Error(data.error || 'Failed to load schedule');
                            }
                        } else {
                            throw new Error('Server error');
                        }
                    } catch (error) {
                        console.log("No schedule found for this date. Displaying empty grid.");
                        this.staff = [];
                        this.appointments = [];
                        this.breaks = [];
                        this.renderSchedule();
                        this.showNotification('No schedule found for this date. Use "Load Sample Data" to begin.', 'info', 5000);
                    }
                }
                this.showLoading(false);
            }

            saveScheduleData() {
                const data = {
                    staff: this.staff,
                    appointments: this.appointments,
                    breaks: this.breaks,
                    lastUpdated: new Date().toISOString()
                };
                saveToLocalStorage(this.currentDate, data);
            }

            showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                overlay.style.display = show ? 'flex' : 'none';
            }

            timeToPixels(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const totalMinutes = (hours - 8) * 60 + minutes;
                return (totalMinutes / 60) * 100;
            }

            pixelsToTime(pixels) {
                const totalMinutes = (pixels / 100) * 60;
                const hours = Math.floor(totalMinutes / 60) + 8;
                const minutes = Math.round(totalMinutes % 60);
                const formattedHours = String(hours).padStart(2, '0');
                const formattedMinutes = String(minutes).padStart(2, '0');
                return `${formattedHours}:${formattedMinutes}`;
            }

            setupEventListeners() {
                const grid = document.getElementById('scheduleGrid');
                grid.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                document.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                document.addEventListener('mouseup', (e) => this.handleMouseUp(e));

                const bookBtn = document.getElementById('bookAppointmentBtn');
                bookBtn.addEventListener('click', () => this.bookAppointment());
            }

            loadScheduleForDate() {
                this.currentDate = document.getElementById('scheduleDate').value;
                this.loadScheduleData();
            }
            
            refreshSchedule() {
                this.loadScheduleData();
            }

            async seedSampleData() {
                this.showLoading(true);

                const sampleData = {
                    staff: [
                        { id: 1, name: 'Sarah Johnson', specialty: 'Facial Specialist', shift_start: '09:00', shift_end: '17:00', is_working: true },
                        { id: 2, name: 'Michael Chen', specialty: 'Massage Therapist', shift_start: '10:00', shift_end: '18:00', is_working: true },
                        { id: 3, name: 'Emily Rodriguez', specialty: 'Hair Stylist', shift_start: '08:00', shift_end: '16:00', is_working: true },
                        { id: 4, name: 'James Wilson', specialty: 'Nail Technician', shift_start: '09:30', shift_end: '17:30', is_working: true },
                        { id: 5, name: 'Linda Davis', specialty: 'Makeup Artist', shift_start: '11:00', shift_end: '19:00', is_working: true }
                    ],
                    appointments: [
                        { staffId: 1, clientName: 'Jessica Brown', service: 'Deep Cleansing Facial', startTime: '09:00', endTime: '10:30', clientPhone: '555-1234', notes: 'Client requested a deep clean facial.' },
                        { staffId: 2, clientName: 'Robert Taylor', service: 'Swedish Massage', startTime: '10:00', endTime: '11:00', clientPhone: '555-5678', notes: 'Focus on shoulder and neck pain.' },
                        { staffId: 3, clientName: 'Linda Anderson', service: 'Hair Cut & Style', startTime: '10:30', endTime: '12:00', clientPhone: '555-9012', notes: 'Quick trim.' },
                        { staffId: 5, clientName: 'Olivia Martinez', service: 'Morning Makeup', startTime: '10:00', endTime: '10:30', clientPhone: '555-3456', notes: 'For a morning event.' },
                        { staffId: 4, clientName: 'Chris Evans', service: 'Classic Manicure', startTime: '13:00', endTime: '14:00', clientPhone: '555-7890', notes: 'First-time client.' }
                    ],
                    breaks: [
                        { staffId: 1, reason: 'Lunch Break', startTime: '12:00', endTime: '12:30' },
                        { staffId: 2, reason: 'Quick Break', startTime: '15:00', endTime: '15:15' },
                        { staffId: 3, reason: 'Lunch Break', startTime: '13:00', endTime: '13:30' },
                        { staffId: 5, reason: 'Out of Office', startTime: '12:00', endTime: '14:00' }
                    ],
                    lastUpdated: new Date().toISOString()
                };

                try {
                    // Save to localStorage
                    if (saveToLocalStorage(this.currentDate, sampleData)) {
                        // Update current data
                        this.staff = sampleData.staff;
                        this.appointments = sampleData.appointments;
                        this.breaks = sampleData.breaks;
                        
                        // Re-render the schedule
                        this.renderSchedule();
                        
                        console.log('Sample data loaded successfully.');
                        this.showNotification('Sample data loaded!', 'success');
                    } else {
                        throw new Error('Failed to save to localStorage');
                    }
                } catch (error) {
                    console.error('Error loading sample data:', error);
                    this.showNotification('Error loading sample data: ' + error.message, 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            handleMouseDown(e) {
                const grid = document.getElementById('scheduleGrid');
                const rect = grid.getBoundingClientRect();
                
                const gridX = e.clientX - rect.left;
                const gridY = e.clientY - rect.top;

                const staffHeight = 60; // Fixed height for each staff member row
                const headerHeight = 60; // Height of the time header row
                const staffIndex = Math.floor((gridY - headerHeight) / staffHeight);

                if (gridX < 200 || gridY < headerHeight || staffIndex < 0 || staffIndex >= this.staff.length) return;
                
                const timeStartPx = gridX - 200;
                
                this.isDragging = true;
                this.dragStart = timeStartPx;
                this.dragStaffIndex = staffIndex;
                this.createTempBlock(timeStartPx, 0, this.dragStaffIndex);
            }

            handleMouseMove(e) {
                if (!this.isDragging || !this.tempBlock) return;
                const grid = document.getElementById('scheduleGrid');
                const rect = grid.getBoundingClientRect();
                const gridX = e.clientX - rect.left - 200;
                const startX = Math.min(this.dragStart, gridX);
                const width = Math.abs(gridX - this.dragStart);
                const finalWidth = Math.max(width, 20);
                this.tempBlock.style.left = `${startX}px`;
                this.tempBlock.style.width = `${finalWidth}px`;
            }

            handleMouseUp(e) {
                if (!this.isDragging || !this.tempBlock) return;
                const grid = document.getElementById('scheduleGrid');
                const rect = grid.getBoundingClientRect();
                const gridX = e.clientX - rect.left - 200;
                
                const startX = Math.min(this.dragStart, gridX);
                const endX = Math.max(this.dragStart, gridX);
                const width = endX - startX;

                if (width >= 20) {
                    const startTime = this.pixelsToTime(startX);
                    const endTime = this.pixelsToTime(endX);
                    const staffId = this.staff[this.dragStaffIndex].id;
                    this.openBookingModal(staffId, startTime, endTime);
                }

                this.isDragging = false;
                this.dragStart = null;
                this.dragStaffIndex = null;
                if (this.tempBlock) {
                    this.tempBlock.remove();
                    this.tempBlock = null;
                }
            }

            closeBookingModal() {
                const modal = document.getElementById('bookingModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }

            createTempBlock(left, width, staffIndex) {
                const grid = document.getElementById('scheduleGrid');
                const staffHeight = 60;
                const headerHeight = 60;
                
                this.tempBlock = document.createElement('div');
                this.tempBlock.className = 'absolute z-30 transition-all duration-100 ease-in-out bg-blue-600 bg-opacity-50 border-2 border-blue-600 border-dashed rounded-md pointer-events-none';
                this.tempBlock.style.top = `${headerHeight + staffIndex * staffHeight + 2}px`;
                this.tempBlock.style.height = `${staffHeight - 4}px`;
                this.tempBlock.style.left = `${200 + left}px`;
                this.tempBlock.style.width = `${Math.max(width, 20)}px`;

                grid.appendChild(this.tempBlock);
            }

            openBookingModal(staffId, startTime, endTime) {
                const modal = document.getElementById('bookingModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');

                const staffSelect = document.getElementById('assignedStaff');
                staffSelect.innerHTML = '';
                this.staff.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.id;
                    option.textContent = `${staff.name} - ${staff.specialty}`;
                    option.selected = staff.id === staffId;
                    staffSelect.appendChild(option);
                });

                document.getElementById('startTime').value = startTime;
                document.getElementById('endTime').value = endTime;
                document.getElementById('clientName').value = '';
                document.getElementById('clientPhone').value = '';
                document.getElementById('serviceType').value = '';
                document.getElementById('appointmentNotes').value = '';
            }

            async bookAppointment() {
                const form = document.getElementById('bookingForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const bookBtn = document.getElementById('bookAppointmentBtn');
                bookBtn.disabled = true;
                bookBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Booking...';

                try {
                    const appointmentData = {
                        staffId: parseInt(document.getElementById('assignedStaff').value),
                        clientName: document.getElementById('clientName').value,
                        service: document.getElementById('serviceType').value,
                        startTime: document.getElementById('startTime').value,
                        endTime: document.getElementById('endTime').value,
                        clientPhone: document.getElementById('clientPhone').value,
                        notes: document.getElementById('appointmentNotes').value,
                        date: this.currentDate
                    };

                    console.log('Sending appointment data:', appointmentData);

                    // Try to save to Flask API first
                    try {
                        const response = await fetch('/api/unaki/appointments', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(appointmentData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Appointment saved to database:', result);
                        } else {
                            const errorData = await response.json();
                            console.log('API error:', errorData);
                            // Continue to save locally even if API fails
                        }
                    } catch (apiError) {
                        console.log('API request failed, saving locally only:', apiError);
                    }

                    // Always save to localStorage
                    this.appointments.push(appointmentData);
                    this.saveScheduleData();
                    
                    // Re-render the schedule
                    this.renderSchedule();
                    
                    console.log('Appointment booked successfully.');
                    this.showNotification('Appointment booked successfully!', 'success');
                    this.closeBookingModal();
                } catch (error) {
                    console.error('Error booking appointment:', error);
                    this.showNotification('Error booking appointment: ' + error.message, 'error');
                } finally {
                    bookBtn.disabled = false;
                    bookBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Book Appointment';
                }
            }

            closeBookingModal() {
                const modal = document.getElementById('bookingModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                
                // Clear form fields
                document.getElementById('clientName').value = '';
                document.getElementById('clientPhone').value = '';
                document.getElementById('serviceType').value = '';
                document.getElementById('appointmentNotes').value = '';
            }

            setCurrentDate() {
                const dateInput = document.getElementById('scheduleDate');
                if (dateInput) {
                    dateInput.value = this.currentDate;
                }
            }

            renderSchedule() {
                const grid = document.getElementById('scheduleGrid');
                grid.innerHTML = '';

                if (this.staff.length === 0) {
                    grid.innerHTML = `<div class="absolute inset-0 flex items-center justify-center text-center text-gray-400 p-4">No staff members found.<br>Please use the "Load Sample Data" button to get started.</div>`;
                    return;
                }

                // Create the top-left empty cell
                const emptyCell = document.createElement('div');
                emptyCell.className = 'grid-cell bg-gray-100 sticky top-0 left-0 z-20';
                grid.appendChild(emptyCell);

                // Create the horizontal time header cells
                const timeIntervals = 10;
                for (let i = 0; i < timeIntervals; i++) {
                    const time = 8 + i;
                    const timeString = `${time % 12 === 0 ? 12 : time % 12}:00 ${time >= 12 ? 'PM' : 'AM'}`;
                    const timeHeader = document.createElement('div');
                    timeHeader.className = 'time-header';
                    timeHeader.textContent = timeString;
                    grid.appendChild(timeHeader);
                }

                // Create staff cells and their corresponding appointment cells
                this.staff.forEach(staff => {
                    const staffCell = document.createElement('div');
                    staffCell.className = 'staff-cell';
                    staffCell.innerHTML = `
                        <div class="font-semibold text-gray-800">${staff.name}</div>
                        <div class="text-xs text-gray-500">${staff.specialty}</div>
                    `;
                    grid.appendChild(staffCell);

                    for (let i = 0; i < timeIntervals; i++) {
                        const apptCell = document.createElement('div');
                        apptCell.className = 'appointment-cell';
                        grid.appendChild(apptCell);
                    }
                });

                this.renderAppointments();
            }

            renderAppointments() {
                const grid = document.getElementById('scheduleGrid');
                
                // Remove existing appointment blocks before re-rendering
                grid.querySelectorAll('.appointment-block, .break-block, .temp-block').forEach(el => el.remove());
                
                const renderBlock = (data, type) => {
                    const staffIndex = this.staff.findIndex(s => s.id === data.staffId);
                    if (staffIndex === -1) return;

                    const block = document.createElement('div');
                    block.className = `absolute z-20 rounded-md p-1 md:p-2 shadow-md hover:shadow-lg transition-shadow duration-200 cursor-pointer overflow-hidden text-ellipsis ${type === 'break' ? 'bg-yellow-400 text-gray-800 break-block' : 'bg-blue-600 text-white appointment-block'}`;
                    
                    const staffHeight = 60;
                    const topOffset = 60 + staffIndex * staffHeight;
                    const leftOffset = 200 + this.timeToPixels(data.startTime);
                    const width = this.timeToPixels(data.endTime) - this.timeToPixels(data.startTime);

                    block.style.top = `${topOffset + 2}px`;
                    block.style.height = `${staffHeight - 4}px`;
                    block.style.left = `${leftOffset + 2}px`;
                    block.style.width = `${width - 4}px`;

                    block.innerHTML = `
                        <div class="font-bold text-sm leading-tight">${type === 'break' ? '<i class="fas fa-coffee mr-1"></i>Break' : data.clientName}</div>
                        <div class="text-xs opacity-90 leading-tight">${type === 'break' ? data.reason : data.service}</div>
                        <div class="text-[10px] opacity-80 mt-1 leading-none">${data.startTime} - ${data.endTime}</div>
                    `;
                    block.title = `${type === 'break' ? data.reason : data.clientName + ' - ' + data.service}\n${data.startTime} - ${data.endTime}${data.clientPhone ? '\nPhone: ' + data.clientPhone : ''}${data.notes ? '\nNotes: ' + data.notes : ''}`;
                    grid.appendChild(block);
                };

                this.appointments.forEach(appt => renderBlock(appt, 'appointment'));
                this.breaks.forEach(breakItem => renderBlock(breakItem, 'break'));
            }

            showNotification(message, type = 'info', duration = 5000) {
                const notification = document.createElement('div');
                let bgColor = 'bg-blue-500';
                if (type === 'success') bgColor = 'bg-green-500';
                if (type === 'error') bgColor = 'bg-red-500';
                notification.className = `fixed top-5 left-1/2 -translate-x-1/2 z-[1000] p-4 rounded-lg shadow-xl text-white font-medium transition-all duration-300 transform-gpu opacity-0 scale-95 ${bgColor}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('opacity-100', 'scale-100');
                }, 10);

                setTimeout(() => {
                    notification.classList.remove('opacity-100', 'scale-100');
                    notification.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }
        
        let bookingSystem;
        window.bookingSystem = null;
        document.addEventListener('DOMContentLoaded', function() {
            try {
                bookingSystem = new UnakiBookingSystem();
                window.bookingSystem = bookingSystem;
                console.log('Unaki Booking System initialized successfully');
            } catch (error) {
                console.error('Error initializing booking system:', error);
            }
        });
    </script>
</body>
</html>
