<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, and-width, initial-scale=1.0" />
        <title>Unaki Appointment Booking - Premium Timeline</title>
        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Font Awesome -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />
        <!-- Appointment Context Menu Script - Load first -->
        <script src="{{ url_for('static', filename='js/appointment_context_menu.js') }}"></script>
        <!-- Bootstrap JavaScript Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary-color: #4f46e5;
                --primary-hover: #4338ca;
                --success-color: #10b981;
                --danger-color: #ef4444;
                --warning-color: #f59e0b;
                --info-color: #06b6d4;
                --border-color: #e5e7eb;
                --hover-bg: #f9fafb;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                overflow: hidden;
                color: #1f2937;
            }

            /* Top Navigation Bar */
            .calendar-top-nav {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 64px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 24px;
                z-index: 100;
                box-shadow: var(--shadow-md);
            }

            .calendar-logo {
                font-size: 20px;
                font-weight: 700;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .calendar-logo i {
                -webkit-text-fill-color: #667eea;
            }

            .calendar-date-nav {
                display: flex;
                align-items: center;
                gap: 16px;
                background: white;
                padding: 8px 12px;
                border-radius: 12px;
                box-shadow: var(--shadow-sm);
                border: 1px solid var(--border-color);
            }

            .date-nav-btn {
                width: 36px;
                height: 36px;
                border-radius: 8px;
                border: none;
                background: var(--hover-bg);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
                color: #6b7280;
            }

            .date-nav-btn:hover {
                background: var(--primary-color);
                color: white;
                transform: scale(1.05);
            }

            .date-nav-btn:active {
                transform: scale(0.95);
            }

            .current-date-display {
                font-size: 15px;
                font-weight: 600;
                color: #1f2937;
                min-width: 220px;
                text-align: center;
            }

            .date-today-btn {
                padding: 6px 12px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                background: white;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                color: #6b7280;
            }

            .date-today-btn:hover {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .calendar-actions {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .action-btn {
                padding: 10px 18px;
                border-radius: 10px;
                border: none;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .action-btn-primary {
                background: var(--primary-color);
                color: white;
                box-shadow: var(--shadow-md);
            }

            .action-btn-primary:hover {
                background: var(--primary-hover);
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .action-btn-primary:active {
                transform: translateY(0);
            }

            .action-icon {
                width: 40px;
                height: 40px;
                border-radius: 10px;
                border: 1px solid var(--border-color);
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
                color: #6b7280;
            }

            .action-icon:hover {
                background: var(--hover-bg);
                color: var(--primary-color);
                transform: scale(1.05);
            }

            /* Main Layout */
            .calendar-main-layout {
                position: fixed;
                top: 64px;
                left: 0;
                right: 0;
                bottom: 0;
                display: flex;
                background: white;
                overflow: visible; /* Changed from hidden to allow scrollbars */
                margin: 12px;
                border-radius: 16px;
                box-shadow: var(--shadow-xl);
            }

            /* Horizontal alignment guides */
            .calendar-main-layout::before {
                content: "";
                position: absolute;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 0;
                background-image: repeating-linear-gradient(
                    to bottom,
                    transparent 0,
                    transparent 109px,
                    rgba(79, 70, 229, 0.08) 109px,
                    rgba(79, 70, 229, 0.08) 110px
                );
                pointer-events: none;
                z-index: 1;
            }

            /* Staff Sidebar */
            .staff-sidebar {
                width: 280px;
                flex-shrink: 0;
                background: #ffffff;
                border-right: 2px solid var(--border-color);
                overflow-y: auto;
                overflow-x: hidden;
                position: relative;
                z-index: 2;
                scrollbar-gutter: stable;
            }

            .staff-sidebar-header {
                height: 60px;
                background: white;
                border-bottom: 2px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 20px;
                font-weight: 700;
                font-size: 14px;
                color: #1f2937;
                position: sticky;
                top: 0;
                z-index: 10;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .staff-count {
                background: var(--primary-color);
                color: white;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }

            .staff-row {
                height: 110px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                padding: 16px 20px;
                gap: 14px;
                cursor: pointer;
                transition: all 0.3s;
                background: #ffffff;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }

            .staff-row:nth-of-type(odd) {
                background: #fafbfc;
            }

            .staff-row:nth-of-type(even) {
                background: #ffffff;
            }

            .staff-row:hover {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                transform: none;
                box-shadow: none;
            }

            .staff-row:hover .staff-avatar {
                transform: scale(1.1);
                box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
            }

            .staff-row:hover .staff-name,
            .staff-row:hover .staff-role,
            .staff-row:hover .staff-status {
                color: white;
            }

            .staff-avatar {
                width: 56px;
                height: 56px;
                border-radius: 14px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 700;
                font-size: 20px;
                flex-shrink: 0;
                transition: all 0.3s;
                box-shadow: var(--shadow-md);
            }

            .staff-info {
                flex: 1;
                min-width: 0;
            }

            .staff-name {
                font-size: 15px;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .staff-role {
                font-size: 13px;
                color: #6b7280;
                margin-bottom: 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .staff-status {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-size: 11px;
                font-weight: 500;
                color: var(--success-color);
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--success-color);
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            /* Timeline Panel - Enhanced for scrolling */
            .timeline-panel {
                flex: 1;
                overflow: auto !important; /* Force scrollbars when needed */
                background: #ffffff;
                position: relative;
                z-index: 2;
                -webkit-overflow-scrolling: touch;
                scrollbar-gutter: stable;
                overscroll-behavior: contain;
            }

            .timeline-header {
                height: 60px;
                background: white;
                border-bottom: 2px solid var(--border-color);
                display: flex;
                position: sticky;
                top: 0;
                z-index: 9;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            }

            .timeline-hour {
                min-width: 140px;
                flex-shrink: 0;
                border-right: 1px solid #e5e7eb;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                font-size: 13px;
                color: #1f2937;
                transition: all 0.2s;
            }

            .timeline-hour:hover {
                background: var(--hover-bg);
            }

            .hour-label {
                font-size: 14px;
                font-weight: 700;
            }

            .hour-period {
                font-size: 11px;
                color: #9ca3af;
                margin-top: 2px;
            }

            /* Timeline Grid */
            .timeline-grid {
                position: relative;
                min-width: max-content;
                min-height: 100%;
            }

            .timeline-row {
                height: 110px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                position: relative;
                transition: background 0.2s;
            }

            .timeline-row:nth-child(odd) {
                background: #fafbfc;
            }

            .timeline-row:nth-child(even) {
                background: #ffffff;
            }

            .timeline-row:hover {
                background: rgba(79, 70, 229, 0.02);
            }

            .timeline-hour-slot {
                min-width: 140px;
                flex-shrink: 0;
                position: relative;
                background: transparent;
                border-right: 1px solid #e5e7eb;
                cursor: pointer;
                transition: all 0.2s;
            }

            .timeline-hour-slot:hover {
                background: linear-gradient(
                    to bottom,
                    rgba(79, 70, 229, 0.03),
                    rgba(79, 70, 229, 0.05)
                );
            }

            .timeline-hour-slot:hover::after {
                content: "+";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 24px;
                color: var(--primary-color);
                font-weight: 600;
                opacity: 0.3;
            }

            /* 15-minute interval lines */
            .interval-marker {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 1px;
                background: #f3f4f6;
            }

            .interval-15 {
                left: 25%;
            }
            .interval-30 {
                left: 50%;
                background: #e5e7eb;
            }
            .interval-45 {
                left: 75%;
            }

            /* Appointment Block */
            .appointment-block {
                position: absolute;
                top: 8px;
                bottom: 8px;
                border-radius: 10px;
                border-left: 4px solid;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                padding: 12px;
                cursor: move;
                transition: all 0.2s;
                overflow: hidden;
                z-index: 5;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
                user-select: none;
            }

            .appointment-block:hover {
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
                transform: translateY(-2px) scale(1.02);
                z-index: 10;
            }

            .appointment-block:active {
                transform: scale(0.98);
            }

            /* Mobile touch indicator */
            @media (max-width: 768px) {
                .appointment-block::after {
                    content: "âœŽ";
                    position: absolute;
                    top: 4px;
                    right: 4px;
                    font-size: 10px;
                    color: rgba(0, 0, 0, 0.3);
                    pointer-events: none;
                }

                .appointment-block {
                    cursor: pointer;
                }
            }

            .appointment-block.dragging {
                opacity: 0.6;
                cursor: grabbing;
                z-index: 100;
            }

            /* Shift Overlays */
            .shift-overlay {
                position: absolute;
                top: 0;
                bottom: 0;
                pointer-events: none;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1;
                border-radius: 6px;
                opacity: 0.75;
            }

            .shift-overlay-break {
                background: linear-gradient(135deg, rgba(245, 158, 11, 0.3), rgba(251, 191, 36, 0.3));
                border: 1px dashed rgba(245, 158, 11, 0.5);
            }

            .shift-overlay-out-of-office {
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.4), rgba(252, 165, 165, 0.4));
                border: 1px dashed rgba(239, 68, 68, 0.6);
            }

            .shift-overlay-off-duty {
                background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(156, 163, 175, 0.2));
                border: 1px dashed rgba(107, 114, 128, 0.4);
            }

            .overlay-label {
                font-size: 11px;
                font-weight: 600;
                color: rgba(0, 0, 0, 0.7);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            }

            .shift-overlay-break .overlay-label {
                color: rgba(180, 83, 9, 0.9);
            }

            .shift-overlay-out-of-office .overlay-label {
                color: rgba(153, 27, 27, 0.9);
            }

            .shift-overlay-off-duty .overlay-label {
                color: rgba(55, 65, 81, 0.7);
            }

            .appointment-header {
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                margin-bottom: 8px;
            }

            .appointment-client {
                font-size: 14px;
                font-weight: 700;
                color: #1f2937;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex: 1;
            }

            .appointment-status {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--success-color);
                flex-shrink: 0;
                margin-left: 8px;
            }

            .appointment-service {
                font-size: 12px;
                color: #6b7280;
                margin-bottom: 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .appointment-footer {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-top: auto;
            }

            .appointment-time {
                font-size: 11px;
                font-weight: 600;
                color: #9ca3af;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .appointment-duration {
                font-size: 10px;
                background: rgba(0, 0, 0, 0.05);
                padding: 2px 8px;
                border-radius: 12px;
                font-weight: 600;
            }

            /* Service type colors - More vibrant */
            .service-massage {
                border-left-color: #3b82f6;
                background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            }
            .service-facial {
                border-left-color: #a855f7;
                background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            }
            .service-manicure {
                border-left-color: #f43f5e;
                background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
            }
            .service-pedicure {
                border-left-color: #78350f;
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            }
            .service-haircut {
                border-left-color: #22c55e;
                background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            }
            .service-waxing {
                border-left-color: #f97316;
                background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);
            }
            .service-default {
                border-left-color: #6b7280;
                background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            }

            /* Current Time Indicator */
            .current-time-line {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 2px;
                background: var(--danger-color);
                z-index: 20;
                pointer-events: none;
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            }

            .current-time-line::before {
                content: "";
                position: absolute;
                top: -6px;
                left: -6px;
                width: 14px;
                height: 14px;
                background: var(--danger-color);
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
                animation: currentTimePulse 2s infinite;
            }

            .current-time-label {
                position: absolute;
                top: 16px;
                left: 6px;
                background: var(--danger-color);
                color: white;
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
                box-shadow: var(--shadow-md);
            }

            @keyframes currentTimePulse {
                0%,
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.2);
                    opacity: 0.8;
                }
            }

            /* Context Menu - Enhanced */
            .context-menu {
                position: fixed;
                background: white;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                box-shadow: var(--shadow-xl);
                padding: 8px;
                min-width: 220px;
                z-index: 1000;
                display: none;
                animation: contextMenuFadeIn 0.2s ease;
            }

            @keyframes contextMenuFadeIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .context-menu.show {
                display: block;
            }

            .context-menu-item {
                padding: 12px 16px;
                cursor: pointer;
                font-size: 14px;
                color: #1f2937;
                display: flex;
                align-items: center;
                gap: 12px;
                transition: all 0.2s;
                border-radius: 8px;
                font-weight: 500;
            }

            .context-menu-item:hover {
                background: var(--hover-bg);
                color: var(--primary-color);
                transform: translateX(4px);
            }

            .context-menu-item i {
                width: 18px;
                text-align: center;
            }

            .context-menu-divider {
                height: 1px;
                background: var(--border-color);
                margin: 8px 0;
            }

            .context-menu-item.danger:hover {
                background: #fee;
                color: var(--danger-color);
            }

            /* Multiple Appointments Section */
            .appointments-container {
                max-height: 400px;
                overflow-y: auto;
                border: 2px solid var(--border-color);
                border-radius: 12px;
                padding: 16px;
                background: #fafbfc;
            }

            .appointment-card {
                background: white;
                border: 2px solid transparent;
                border-radius: 10px;
                padding: 16px;
                margin-bottom: 12px;
                transition: all 0.2s;
                position: relative;
            }

            .appointment-card:hover {
                border-color: var(--primary-color);
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            .appointment-card.duplicate {
                border-color: var(--warning-color);
                background: #fffbeb;
            }

            .appointment-number {
                position: absolute;
                top: -8px;
                left: 16px;
                background: var(--primary-color);
                color: white;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }

            .remove-appointment {
                position: absolute;
                top: 8px;
                right: 8px;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                border: none;
                background: var(--danger-color);
                color: white;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .remove-appointment:hover {
                background: #dc2626;
                transform: scale(1.1);
            }

            .add-appointment-btn {
                width: 100%;
                padding: 12px;
                border: 2px dashed var(--primary-color);
                background: transparent;
                color: var(--primary-color);
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .add-appointment-btn:hover {
                background: var(--primary-color);
                color: white;
                transform: scale(1.02);
            }

            /* Tooltip */
            .tooltip-custom {
                position: fixed;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 500;
                z-index: 10000;
                pointer-events: none;
                display: none;
                white-space: nowrap;
                box-shadow: var(--shadow-lg);
            }

            .tooltip-custom.show {
                display: block;
                animation: tooltipFadeIn 0.2s ease;
            }

            @keyframes tooltipFadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            /* Loading State */
            .loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.95);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 50;
                backdrop-filter: blur(5px);
            }

            .loading-overlay.show {
                display: flex;
            }

            .spinner {
                width: 50px;
                height: 50px;
                border: 4px solid #e5e7eb;
                border-top-color: var(--primary-color);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* Enhanced Scrollbar Styling - WebKit (Chrome, Safari, Edge) */
            ::-webkit-scrollbar {
                width: 14px;
                height: 14px;
            }

            ::-webkit-scrollbar-track {
                background: #f3f4f6;
                border-radius: 10px;
                border: 2px solid #ffffff;
            }

            ::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #9ca3af 0%, #6b7280 100%);
                border-radius: 10px;
                border: 3px solid #f3f4f6;
                transition: background 0.2s;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);
            }

            ::-webkit-scrollbar-thumb:active {
                background: linear-gradient(180deg, #4b5563 0%, #374151 100%);
            }

            ::-webkit-scrollbar-corner {
                background: #f3f4f6;
            }

            /* Firefox Scrollbar Styling */
            .timeline-panel,
            .staff-sidebar,
            .appointments-container {
                scrollbar-width: auto;
                scrollbar-color: #9ca3af #f3f4f6;
            }

            /* Empty State */
            .empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: #9ca3af;
                padding: 60px 40px;
                text-align: center;
            }

            .empty-state i {
                font-size: 64px;
                margin-bottom: 20px;
                opacity: 0.3;
            }

            .empty-state h3 {
                font-size: 18px;
                font-weight: 600;
                color: #4b5563;
                margin-bottom: 8px;
            }

            .empty-state p {
                font-size: 14px;
                color: #9ca3af;
                margin: 0;
            }

            /* Quick Stats Bar */
            .quick-stats {
                display: flex;
                gap: 8px;
                padding: 12px 20px;
                background: white;
                border-bottom: 1px solid var(--border-color);
            }

            .stat-card {
                flex: 1;
                background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
                padding: 12px 16px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                gap: 12px;
                transition: all 0.2s;
            }

            .stat-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            .stat-icon {
                width: 40px;
                height: 40px;
                border-radius: 10px;
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
            }

            .stat-info h4 {
                font-size: 20px;
                font-weight: 700;
                color: #1f2937;
                margin: 0;
            }

            .stat-info p {
                font-size: 12px;
                color: #6b7280;
                margin: 0;
            }

            /* Responsive */
            @media (max-width: 1024px) {
                .staff-sidebar {
                    width: 240px;
                }

                .timeline-hour {
                    min-width: 110px;
                }

                .timeline-hour-slot {
                    min-width: 110px;
                }
            }

            @media (max-width: 768px) {
                .calendar-main-layout {
                    margin: 8px;
                    border-radius: 12px;
                }

                .staff-sidebar {
                    width: 200px;
                }

                .timeline-hour {
                    min-width: 90px;
                }

                .timeline-hour-slot {
                    min-width: 90px;
                }

                .staff-row {
                    height: 90px;
                    padding: 12px;
                }

                .staff-avatar {
                    width: 48px;
                    height: 48px;
                    font-size: 18px;
                }

                .calendar-logo span {
                    display: none;
                }

                .current-date-display {
                    min-width: 150px;
                    font-size: 13px;
                }

                .calendar-top-nav > div:nth-child(3) > div:first-child {
                    display: none;
                }

                .calendar-main-layout::after {
                    content: "ðŸ’¡ Tap appointment to edit";
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 8px 16px;
                    border-radius: 20px;
                    font-size: 12px;
                    pointer-events: none;
                    z-index: 1000;
                    animation: fadeInOut 3s ease-in-out;
                }

                @keyframes fadeInOut {
                    0%,
                    100% {
                        opacity: 0;
                    }
                    10%,
                    90% {
                        opacity: 1;
                    }
                }

                .modal-dialog {
                    margin: 0;
                    max-width: 100%;
                    height: 100%;
                }

                .modal-content {
                    height: 100%;
                    border-radius: 0 !important;
                }

                /* Mobile scrollbar - thinner on touch devices */
                ::-webkit-scrollbar {
                    width: 8px;
                    height: 8px;
                }
            }

            /* Validation Styles */
            .is-invalid {
                border-color: #dc3545 !important;
                background-color: #fff5f5 !important;
            }

            .is-valid {
                border-color: #28a745 !important;
                background-color: #f0fff4 !important;
            }

            .validation-error {
                color: #dc3545;
                font-size: 0.875rem;
                margin-top: 0.25rem;
            }

            .submit-btn-disabled {
                opacity: 0.6;
                cursor: not-allowed !important;
            }
        </style>
    </head>
    <body>
        <!-- Tooltip -->
        <div class="tooltip-custom" id="tooltip"></div>

        <div class="calendar-wrapper">
            <!-- Fixed Top Navigation -->
            <div class="calendar-top-nav">
                <div class="calendar-logo">
                    <i class="fas fa-calendar-check"></i>
                    <span>Unaki Booking</span>
                </div>

                <div class="calendar-date-nav">
                    <button
                        class="date-nav-btn"
                        onclick="navigateDate(-1)"
                        data-tooltip="Previous Day"
                    >
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button
                        class="date-today-btn"
                        onclick="navigateToToday()"
                        data-tooltip="Go to Today"
                    >
                        Today
                    </button>
                    <div class="current-date-display" id="currentDateDisplay">
                        {{ today_date }}
                    </div>
                    <button
                        class="date-nav-btn"
                        onclick="navigateDate(1)"
                        data-tooltip="Next Day"
                    >
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div style="display: flex; align-items: center; gap: 16px">
                    <!-- Quick Stats in Top Bar -->
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 8px 12px;
                            background: white;
                            border-radius: 10px;
                            border: 1px solid var(--border-color);
                        "
                    >
                        <i
                            class="fas fa-calendar-check"
                            style="color: var(--primary-color)"
                        ></i>
                        <div>
                            <div
                                style="
                                    font-size: 16px;
                                    font-weight: 700;
                                    color: #1f2937;
                                "
                                id="totalBookings"
                            >
                                0
                            </div>
                            <div style="font-size: 10px; color: #6b7280">
                                Total
                            </div>
                        </div>
                    </div>
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 8px 12px;
                            background: white;
                            border-radius: 10px;
                            border: 1px solid var(--border-color);
                        "
                    >
                        <i
                            class="fas fa-check-circle"
                            style="color: var(--success-color)"
                        ></i>
                        <div>
                            <div
                                style="
                                    font-size: 16px;
                                    font-weight: 700;
                                    color: #1f2937;
                                "
                                id="completedBookings"
                            >
                                0
                            </div>
                            <div style="font-size: 10px; color: #6b7280">
                                Done
                            </div>
                        </div>
                    </div>

                    <div class="calendar-actions">
                        <button
                            class="action-btn action-btn-primary"
                            onclick="openMultiBookModal()"
                        >
                            <i class="fas fa-plus-circle"></i>
                            New Appointment
                        </button>
                        <button
                            class="action-icon"
                            onclick="refreshSchedule()"
                            data-tooltip="Refresh Schedule"
                        >
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <a
                            href="{{ url_for('dashboard') }}"
                            class="action-icon"
                            data-tooltip="Back to Dashboard"
                        >
                            <i class="fas fa-home"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Layout -->
            <div class="calendar-main-layout">
                <!-- Staff Sidebar -->
                <div class="staff-sidebar">
                    <!-- Header: 60px height -->
                    <div class="staff-sidebar-header">
                        <span>Staff Members</span>
                        <span class="staff-count"
                            >{{ staff_members|length if staff_members else 0
                            }}</span
                        >
                    </div>

                    <!-- Staff rows start here - each 110px height, matching timeline rows exactly -->
                    <div class="staff-list">
                        {% if staff_members %} {% for staff in staff_members %}
                        <div
                            class="staff-row staff-row-{{ loop.index }}"
                            data-staff-id="{{ staff.id }}"
                            data-tooltip="Click to filter by {{ staff.first_name }}"
                        >
                            <div class="staff-avatar">
                                {{ (staff.first_name[:1] +
                                staff.last_name[:1]).upper() if staff.first_name
                                and staff.last_name else
                                staff.username[:2].upper() }}
                            </div>
                            <div class="staff-info">
                                <div class="staff-name">
                                    {{ staff.first_name }} {{ staff.last_name if
                                    staff.last_name else '' }}
                                </div>
                                <div class="staff-role">
                                    {{ staff.role or 'Therapist' }}
                                </div>
                                <div class="staff-status">
                                    <span class="status-dot"></span>
                                    Available
                                </div>
                            </div>
                        </div>
                        {% endfor %} {% else %}
                        <div class="empty-state">
                            <i class="fas fa-user-plus"></i>
                            <h3>No Staff Members</h3>
                            <p>
                                Add staff members to start booking appointments
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Timeline Panel -->
                <div class="timeline-panel">
                    <!-- Timeline Header: 60px height (matches staff header) -->
                    <div class="timeline-header">
                        {% for hour in range(9, 22) %}
                        <div
                            class="timeline-hour"
                            data-tooltip="Click any slot to book"
                        >
                            <span class="hour-label">
                                {{ '%d:00' % hour if hour < 12 else ('12:00' if
                                hour == 12 else '%d:00' % (hour - 12)) }}
                            </span>
                            <span class="hour-period"
                                >{{ 'AM' if hour < 12 else 'PM' }}</span
                            >
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Timeline Grid -->
                    <!-- Each timeline-row is 110px height, perfectly matching each staff-row -->
                    <div class="timeline-grid" id="timelineGrid">
                        {% if staff_members %} {% for staff in staff_members %}
                        <div
                            class="timeline-row"
                            data-staff-id="{{ staff.id }}"
                        >
                            {% for hour in range(9, 22) %}
                            <div
                                class="timeline-hour-slot"
                                data-hour="{{ hour }}"
                                data-staff-id="{{ staff.id }}"
                                onclick="handleSlotClick(event, {{ staff.id }}, {{ hour }}, 0)"
                            >
                                <div class="interval-marker interval-15"></div>
                                <div class="interval-marker interval-30"></div>
                                <div class="interval-marker interval-45"></div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %} {% else %}
                        <div class="empty-state">
                            <i class="fas fa-calendar-plus"></i>
                            <h3>Ready to Start Booking</h3>
                            <p>
                                Add staff members to begin scheduling
                                appointments
                            </p>
                        </div>
                        {% endif %}

                        <!-- Current Time Line -->
                        <div
                            class="current-time-line"
                            id="currentTimeLine"
                            style="display: none"
                        >
                            <div
                                class="current-time-label"
                                id="currentTimeLabel"
                            >
                                Now
                            </div>
                        </div>
                    </div>

                    <!-- Loading Overlay -->
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context Menu -->
        <div class="context-menu" id="contextMenu">
            <div class="context-menu-item" onclick="viewAppointmentDetails()">
                <i class="fas fa-eye"></i>
                View Details
            </div>
            <div class="context-menu-item" onclick="editAppointment()">
                <i class="fas fa-edit"></i>
                Edit Appointment
            </div>
            <div class="context-menu-item" onclick="checkInAppointment()">
                <i class="fas fa-user-check"></i>
                Check In Client
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item" onclick="duplicateAppointment()">
                <i class="fas fa-copy"></i>
                Duplicate
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item" onclick="goToBilling()">
                <i class="fas fa-dollar-sign"></i>
                Go to Billing
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item danger" onclick="cancelAppointment()">
                <i class="fas fa-times-circle"></i>
                Cancel Appointment
            </div>
        </div>

        <!-- Edit Appointment Modal -->
        <div class="modal fade" id="editAppointmentModal" tabindex="-1">
            <div
                class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable"
            >
                <div
                    class="modal-content"
                    style="
                        border-radius: 16px;
                        border: none;
                        box-shadow: var(--shadow-xl);
                        max-height: 90vh;
                    "
                >
                    <div
                        class="modal-header"
                        style="
                            border-bottom: 2px solid var(--border-color);
                            padding: 20px 24px;
                        "
                    >
                        <h5
                            class="modal-title"
                            style="font-weight: 700; font-size: 18px"
                        >
                            <i
                                class="fas fa-edit me-2"
                                style="color: var(--warning-color)"
                            ></i>
                            Edit Appointment
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body" style="padding: 24px">
                        <input type="hidden" id="editAppointmentId" />

                        <!-- Client Information -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-user me-2"
                                        style="color: var(--primary-color)"
                                    ></i>
                                    Client Name *
                                </label>
                                <input
                                    type="text"
                                    id="editClientName"
                                    class="form-control"
                                    readonly
                                    style="
                                        background: #f9fafb;
                                        border-radius: 10px;
                                        padding: 12px;
                                    "
                                />
                            </div>
                        </div>

                        <!-- Service and Staff -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-concierge-bell me-2"
                                        style="color: var(--primary-color)"
                                    ></i>
                                    Service *
                                </label>
                                <select
                                    id="editServiceSelect"
                                    class="form-select"
                                    required
                                    style="border-radius: 10px; padding: 12px"
                                >
                                    <option value="">Select service...</option>
                                    {% if services %} {% for service in services
                                    %}
                                    <option
                                        value="{{ service.id }}"
                                        data-duration="{{ service.duration or 60 }}"
                                        data-price="{{ service.price }}"
                                    >
                                        {{ service.name }} ({{ service.duration
                                        or 60 }} min - â‚¹{{
                                        "%.2f"|format(service.price) }})
                                    </option>
                                    {% endfor %} {% endif %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-user-md me-2"
                                        style="color: var(--primary-color)"
                                    ></i>
                                    Staff Member *
                                </label>
                                <select
                                    id="editStaffSelect"
                                    class="form-select"
                                    required
                                    style="border-radius: 10px; padding: 12px"
                                >
                                    <option value="">
                                        Select staff member...
                                    </option>
                                    {% if staff_members %} {% for staff in
                                    staff_members %}
                                    <option value="{{ staff.id }}">
                                        {{ staff.first_name }} {{
                                        staff.last_name if staff.last_name else
                                        '' }}
                                    </option>
                                    {% endfor %} {% endif %}
                                </select>
                            </div>
                        </div>

                        <!-- Date and Time -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-calendar me-2"
                                        style="color: var(--primary-color)"
                                    ></i>
                                    Date *
                                </label>
                                <input
                                    type="date"
                                    id="editAppointmentDate"
                                    class="form-control"
                                    required
                                    style="border-radius: 10px; padding: 12px"
                                />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-clock me-2"
                                        style="color: var(--primary-color)"
                                    ></i>
                                    Start Time *
                                </label>
                                <input
                                    type="time"
                                    id="editStartTime"
                                    class="form-control"
                                    required
                                    style="border-radius: 10px; padding: 12px"
                                />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-clock me-2"
                                        style="color: var(--success-color)"
                                    ></i>
                                    End Time
                                </label>
                                <input
                                    type="time"
                                    id="editEndTime"
                                    class="form-control"
                                    readonly
                                    style="
                                        border-radius: 10px;
                                        padding: 12px;
                                        background: #f0fdf4;
                                        font-weight: 600;
                                        color: var(--success-color);
                                    "
                                />
                            </div>
                        </div>

                        <!-- Conflict Warning -->
                        <div
                            id="editConflictAlert"
                            class="alert alert-warning d-none"
                            style="border-radius: 10px"
                        >
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="editConflictMessage"></span>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i
                                    class="fas fa-sticky-note me-2"
                                    style="color: var(--primary-color)"
                                ></i>
                                Notes
                            </label>
                            <textarea
                                id="editNotes"
                                class="form-control"
                                rows="3"
                                placeholder="Add any special instructions or notes..."
                                style="border-radius: 10px; padding: 12px"
                            ></textarea>
                        </div>
                    </div>
                    <div
                        class="modal-footer"
                        style="
                            border-top: 2px solid var(--border-color);
                            padding: 16px 24px;
                        "
                    >
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                            style="border-radius: 10px; padding: 10px 20px"
                        >
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button
                            type="button"
                            class="btn btn-primary"
                            onclick="saveEditedAppointment()"
                            style="
                                border-radius: 10px;
                                padding: 10px 20px;
                                background: var(--warning-color);
                                border: none;
                            "
                        >
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Multi-Appointment Booking Modal -->
        <div class="modal fade" id="multiBookModal" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div
                    class="modal-content"
                    style="
                        border-radius: 16px;
                        border: none;
                        box-shadow: var(--shadow-xl);
                    "
                >
                    <div
                        class="modal-header"
                        style="
                            border-bottom: 2px solid var(--border-color);
                            padding: 20px 24px;
                        "
                    >
                        <h5
                            class="modal-title"
                            style="font-weight: 700; font-size: 18px"
                        >
                            <i
                                class="fas fa-calendar-plus me-2"
                                style="color: var(--primary-color)"
                            ></i>
                            Book Multiple Appointments
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body" style="padding: 24px">
                        <!-- Client Information Section -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-user me-2"
                                        style="color: var(--primary-color)"
                                    ></i>
                                    Select Client *
                                </label>
                                <select
                                    id="multiClientSelect"
                                    class="form-select"
                                    required
                                    style="border-radius: 10px; padding: 12px"
                                >
                                    <option value="">Choose a client...</option>
                                    {% if clients %} {% for client in clients %}
                                    <option
                                        value="{{ client.id }}"
                                        data-phone="{{ client.phone }}"
                                        data-email="{{ client.email or '' }}"
                                    >
                                        {{ client.first_name }} {{
                                        client.last_name }} - {{ client.phone }}
                                    </option>
                                    {% endfor %} {% endif %}
                                </select>
                                <small class="text-muted mt-1 d-block">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Select from existing clients or
                                    <a
                                        href="{{ url_for('customers') }}"
                                        target="_blank"
                                        >add a new client</a
                                    >
                                </small>
                            </div>
                        </div>

                        <!-- Customer's Existing Appointments Display -->
                        <div id="customerExistingAppointments" class="mb-4" style="display: none;">
                            <div class="alert alert-info" style="border-radius: 10px;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong><i class="fas fa-calendar-check me-2"></i>Customer's Booked Appointments</strong>
                                    <small id="customerAppointmentsCount" class="badge bg-primary">0</small>
                                </div>
                                <div id="customerAppointmentsList" style="max-height: 200px; overflow-y: auto;">
                                    <small class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Loading...</small>
                                </div>
                            </div>
                        </div>

                        <!-- Appointments Section -->
                        <div class="mb-4">
                            <div
                                style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    margin-bottom: 16px;
                                "
                            >
                                <label
                                    class="form-label fw-semibold mb-0"
                                    style="font-size: 16px"
                                >
                                    <i
                                        class="fas fa-calendar-alt me-2"
                                        style="color: var(--primary-color)"
                                    ></i>
                                    Appointments
                                </label>
                                <span
                                    id="appointmentCount"
                                    style="
                                        background: var(--primary-color);
                                        color: white;
                                        padding: 4px 12px;
                                        border-radius: 20px;
                                        font-size: 12px;
                                        font-weight: 600;
                                    "
                                >
                                    1 Appointment
                                </span>
                            </div>

                            <div
                                class="appointments-container"
                                id="appointmentsContainer"
                            >
                                <!-- First appointment card (template) -->
                                <div
                                    class="appointment-card"
                                    data-appointment-index="0"
                                >
                                    <div class="appointment-number">1</div>
                                    <button
                                        type="button"
                                        class="remove-appointment d-none"
                                        onclick="removeAppointment(0)"
                                    >
                                        <i class="fas fa-times"></i>
                                    </button>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label
                                                class="form-label fw-semibold"
                                            >
                                                <i
                                                    class="fas fa-concierge-bell me-2"
                                                    style="
                                                        color: var(
                                                            --primary-color
                                                        );
                                                    "
                                                ></i>
                                                Service *
                                            </label>
                                            <select
                                                class="form-select service-select"
                                                required
                                                style="
                                                    border-radius: 10px;
                                                    padding: 12px;
                                                "
                                            >
                                                <option value="">
                                                    Select service...
                                                </option>
                                                {% if services %} {% for service
                                                in services %}
                                                <option
                                                    value="{{ service.id }}"
                                                    data-duration="{{ service.duration or 60 }}"
                                                    data-price="{{ service.price }}"
                                                >
                                                    {{ service.name }} ({{
                                                    service.duration or 60 }}
                                                    min - â‚¹{{
                                                    "%.2f"|format(service.price)
                                                    }})
                                                </option>
                                                {% endfor %} {% endif %}
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label
                                                class="form-label fw-semibold"
                                            >
                                                <i
                                                    class="fas fa-user-md me-2"
                                                    style="
                                                        color: var(
                                                            --primary-color
                                                        );
                                                    "
                                                ></i>
                                                Staff Member *
                                            </label>
                                            <select
                                                class="form-select staff-select"
                                                required
                                                style="
                                                    border-radius: 10px;
                                                    padding: 12px;
                                                "
                                            >
                                                <option value="">
                                                    Select staff member...
                                                </option>
                                                {% if staff_members %} {% for
                                                staff in staff_members %}
                                                <option value="{{ staff.id }}">
                                                    {{ staff.first_name }} {{
                                                    staff.last_name if
                                                    staff.last_name else '' }}
                                                </option>
                                                {% endfor %} {% endif %}
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label
                                                class="form-label fw-semibold"
                                            >
                                                <i
                                                    class="fas fa-calendar me-2"
                                                    style="
                                                        color: var(
                                                            --primary-color
                                                        );
                                                    "
                                                ></i>
                                                Date *
                                            </label>
                                            <input
                                                type="date"
                                                class="form-control appointment-date"
                                                value="{{ today }}"
                                                required
                                                style="
                                                    border-radius: 10px;
                                                    padding: 12px;
                                                "
                                            />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label
                                                class="form-label fw-semibold"
                                            >
                                                <i
                                                    class="fas fa-clock me-2"
                                                    style="
                                                        color: var(
                                                            --primary-color
                                                        );
                                                    "
                                                ></i>
                                                Start Time *
                                            </label>
                                            <input
                                                type="time"
                                                class="form-control start-time"
                                                value="09:00"
                                                required
                                                style="
                                                    border-radius: 10px;
                                                    padding: 12px;
                                                "
                                            />
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label
                                                class="form-label fw-semibold"
                                            >
                                                <i
                                                    class="fas fa-clock me-2"
                                                    style="
                                                        color: var(
                                                            --success-color
                                                        );
                                                    "
                                                ></i>
                                                End Time
                                            </label>
                                            <input
                                                type="time"
                                                class="form-control end-time"
                                                readonly
                                                style="
                                                    border-radius: 10px;
                                                    padding: 12px;
                                                    background: #f0fdf4;
                                                    font-weight: 600;
                                                    color: var(--success-color);
                                                "
                                            />
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12">
                                            <div
                                                id="conflictAlert0"
                                                class="alert alert-warning d-none"
                                                style="border-radius: 10px"
                                            >
                                                <i
                                                    class="fas fa-exclamation-triangle me-2"
                                                ></i>
                                                <span
                                                    class="conflict-message"
                                                ></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Add Another Appointment Button -->
                            <button
                                type="button"
                                class="add-appointment-btn"
                                onclick="addAppointment()"
                            >
                                <i class="fas fa-plus-circle"></i>
                                Add Another Appointment
                            </button>
                        </div>

                        <!-- Summary Section -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div
                                    style="
                                        background: linear-gradient(
                                            135deg,
                                            #dbeafe 0%,
                                            #bfdbfe 100%
                                        );
                                        padding: 16px;
                                        border-radius: 10px;
                                    "
                                >
                                    <label
                                        class="form-label fw-semibold"
                                        style="
                                            color: #1e40af;
                                            margin-bottom: 8px;
                                        "
                                    >
                                        <i
                                            class="fas fa-hourglass-half me-2"
                                        ></i>
                                        Total Duration
                                    </label>
                                    <div
                                        style="
                                            font-size: 28px;
                                            font-weight: 700;
                                            color: #1e40af;
                                        "
                                        id="multiTotalDuration"
                                    >
                                        0 min
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div
                                    style="
                                        background: linear-gradient(
                                            135deg,
                                            #a7f3d0 0%,
                                            #a7f3d0 100%
                                        );
                                        padding: 16px;
                                        border-radius: 10px;
                                    "
                                >
                                    <label
                                        class="form-label fw-semibold"
                                        style="
                                            color: #065f46;
                                            margin-bottom: 8px;
                                        "
                                    >
                                        <i class="fas fa-dollar-sign me-2"></i>
                                        Total Price
                                    </label>
                                    <div
                                        style="
                                            font-size: 28px;
                                            font-weight: 700;
                                            color: #065f46;
                                        "
                                        id="multiTotalPrice"
                                    >
                                        $0.00
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div
                                    style="
                                        background: linear-gradient(
                                            135deg,
                                            #fef3c7 0%,
                                            #fde68a 100%
                                        );
                                        padding: 16px;
                                        border-radius: 10px;
                                    "
                                >
                                    <label
                                        class="form-label fw-semibold"
                                        style="
                                            color: #78350f;
                                            margin-bottom: 8px;
                                        "
                                    >
                                        <i class="fas fa-users me-2"></i>
                                        Staff Required
                                    </label>
                                    <div
                                        style="
                                            font-size: 28px;
                                            font-weight: 700;
                                            color: #78350f;
                                        "
                                        id="multiStaffCount"
                                    >
                                        0
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i
                                    class="fas fa-sticky-note me-2"
                                    style="color: var(--primary-color)"
                                ></i>
                                Notes
                            </label>
                            <textarea
                                id="multiNotes"
                                class="form-control"
                                rows="3"
                                placeholder="Add any special instructions or notes for all appointments..."
                                style="border-radius: 10px; padding: 12px"
                            ></textarea>
                        </div>
                    </div>
                    <div
                        class="modal-footer"
                        style="
                            border-top: 2px solid var(--border-color);
                            padding: 16px 24px;
                        "
                    >
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                            style="border-radius: 10px; padding: 10px 20px"
                        >
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button
                            type="button"
                            class="btn btn-success"
                            onclick="submitMultiAppointment()"
                            style="
                                border-radius: 10px;
                                padding: 10px 20px;
                                background: var(--primary-color);
                                border: none;
                            "
                        >
                            <i class="fas fa-check-circle me-2"></i>Book All
                            Appointments
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Global variables
            let selectedAppointmentId = null;
            const currentDate = "{{ today }}";
            let bookingsData = [];
            let appointmentCounter = 1; // Renamed from appointmentCount to avoid confusion

            // ==========================================
            // INITIALIZATION AND EVENT HANDLERS
            // ==========================================

            // Initialize on page load
            document.addEventListener("DOMContentLoaded", function () {
                loadBookings();
                loadShiftSchedule(); // Load shift data with breaks and OOO
                updateCurrentTimeLine();
                setInterval(updateCurrentTimeLine, 60000);
                setupTooltips();
                setupEventListeners();
                setupScrollSync(); // Setup scroll synchronization
                reinitializeContextMenu(); // Initialize context menu

                document.addEventListener("click", function () {
                    hideContextMenu();
                });

                // Keyboard shortcuts
                document.addEventListener("keydown", function (e) {
                    if (e.key === "n" && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        openMultiBookModal();
                    }
                    if (e.key === "r" && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        refreshSchedule();
                    }
                });
            });

            // Setup event listeners for dynamic updates
            function setupEventListeners() {
                document.addEventListener("change", function (e) {
                    // Listen for changes in appointment cards
                    if (
                        e.target &&
                        e.target.classList &&
                        (e.target.classList.contains("service-select") ||
                        e.target.classList.contains("start-time") ||
                        e.target.classList.contains("appointment-date") ||
                        e.target.classList.contains("staff-select"))
                    ) {
                        const appointmentCard =
                            e.target.closest(".appointment-card");
                        if (appointmentCard) {
                            const index = parseInt(
                                appointmentCard.dataset.appointmentIndex,
                            );
                            calculateEndTime(index);
                            checkConflicts(index); // Check conflicts for the specific card
                            updateSummary(); // Update overall summary
                            updateSubmitButton(); // Update submit button state
                        }
                    }
                });

                // Add listeners for blur events as well for validation
                document.addEventListener("blur", function (e) {
                    if (
                        e.target &&
                        e.target.classList &&
                        (e.target.classList.contains("service-select") ||
                        e.target.classList.contains("start-time") ||
                        e.target.classList.contains("appointment-date") ||
                        e.target.classList.contains("staff-select"))
                    ) {
                        const appointmentCard =
                            e.target.closest(".appointment-card");
                        if (appointmentCard) {
                            const index = parseInt(
                                appointmentCard.dataset.appointmentIndex,
                            );
                            checkConflicts(index);
                            updateSubmitButton();
                        }
                    }
                });
            }

            // Setup tooltips for interactive elements
            function setupTooltips() {
                const tooltip = document.getElementById("tooltip");
                const elementsWithTooltip =
                    document.querySelectorAll("[data-tooltip]");

                elementsWithTooltip.forEach((element) => {
                    element.addEventListener("mouseenter", function (e) {
                        const text = this.getAttribute("data-tooltip");
                        tooltip.textContent = text;
                        tooltip.classList.add("show");

                        const rect = this.getBoundingClientRect();
                        tooltip.style.left =
                            rect.left +
                            rect.width / 2 -
                            tooltip.offsetWidth / 2 +
                            "px";
                        tooltip.style.top = rect.bottom + 8 + "px";
                    });

                    element.addEventListener("mouseleave", function () {
                        tooltip.classList.remove("show");
                    });
                });
            }

            // Setup scroll synchronization between timeline panel and staff sidebar
            function setupScrollSync() {
                const panel = document.querySelector(".timeline-panel");
                const staff = document.querySelector(".staff-sidebar");
                const header = document.querySelector(".timeline-header");

                if (!panel || !staff || !header) return;

                // Flags to avoid feedback loop during scroll events
                let syncingFromPanel = false;
                let syncingFromStaff = false;

                // Sync timeline panel scroll to staff sidebar and keep header aligned
                panel.addEventListener(
                    "scroll",
                    () => {
                        if (!syncingFromStaff) {
                            syncingFromPanel = true;
                            staff.scrollTop = panel.scrollTop;
                        }
                        syncingFromStaff = false;

                        // Keep sticky header aligned with horizontal scroll
                        header.style.transform = `translateX(-${panel.scrollLeft}px)`;
                    },
                    { passive: true },
                );

                // Sync staff sidebar scroll to timeline panel
                staff.addEventListener(
                    "scroll",
                    () => {
                        if (!syncingFromPanel) {
                            syncingFromStaff = true;
                            panel.scrollTop = staff.scrollTop;
                        }
                        syncingFromPanel = false;
                    },
                    { passive: true },
                );
            }

            // ==========================================
            // DATA LOADING AND RENDERING
            // ==========================================

            // Load bookings from the server
            function loadBookings() {
                const overlay = document.getElementById("loadingOverlay");
                overlay.classList.add("show");

                fetch("/api/unaki/get-bookings?date=" + currentDate)
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then((data) => {
                        if (data.success) {
                            // Filter out cancelled appointments from view
                            bookingsData = (data.bookings || []).filter(
                                (b) => b.status !== "cancelled",
                            );
                            renderBookings();
                            updateStats();
                        } else {
                            console.error("Failed to load bookings:", data.error);
                            showNotification("Failed to load bookings.", "error");
                        }
                    })
                    .catch((error) => {
                        console.error("Error loading bookings:", error);
                        // Show user-friendly error message
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'alert alert-danger m-3';
                        errorMessage.innerHTML = `
                            <strong>Error loading schedule data</strong><br>
                            ${error.message || 'Unable to load appointments. Please refresh the page.'}
                        `;

                        const container = document.querySelector('.calendar-main-layout'); // Changed container selector
                        if (container) {
                            container.insertBefore(errorMessage, container.firstChild);
                        }

                        // Auto-hide after 5 seconds
                        setTimeout(() => {
                            errorMessage.remove();
                        }, 5000);
                        showNotification("An error occurred while loading bookings.", "error");
                    })
                    .finally(() => {
                        overlay.classList.remove("show");
                    });
            }

            // Load shift schedule data with breaks and out-of-office info
            function loadShiftSchedule() {
                fetch("/api/unaki/schedule?date=" + currentDate)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!data.success) {
                            throw new Error(data.error || 'Failed to load schedule');
                        }
                        renderShiftOverlays(data.staff);
                    })
                    .catch((error) => {
                        console.error('Error loading shift schedule:', error);
                        // Show user-friendly error message
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'alert alert-danger m-3';
                        errorMessage.innerHTML = `
                            <strong>Error loading schedule data</strong><br>
                            ${error.message || 'Unable to load schedule. Please refresh the page.'}
                        `;

                        const container = document.querySelector('.calendar-main-layout'); // Changed container selector
                        if (container) {
                            container.insertBefore(errorMessage, container.firstChild);
                        }

                        // Auto-hide after 5 seconds
                        setTimeout(() => {
                            errorMessage.remove();
                        }, 5000);
                    });
            }

            // Render shift overlays (breaks, OOO, off-duty)
            function renderShiftOverlays(staffData) {
                // Remove existing overlays
                document.querySelectorAll(".shift-overlay").forEach((el) => el.remove());

                staffData.forEach((staff) => {
                    const row = document.querySelector(`.timeline-row[data-staff-id="${staff.id}"]`);
                    if (!row) return;

                    // Helper to convert time to position
                    function timeToPosition(timeStr) {
                        const [hours, minutes] = timeStr.split(':').map(Number);
                        const hoursSince9AM = hours - 9 + minutes / 60;
                        return hoursSince9AM * 140; // 140px per hour
                    }

                    // Helper to calculate width
                    function calculateWidth(startTime, endTime) {
                        const [startH, startM] = startTime.split(':').map(Number);
                        const [endH, endM] = endTime.split(':').map(Number);
                        const startMinutes = startH * 60 + startM;
                        const endMinutes = endH * 60 + endM;
                        const durationHours = (endMinutes - startMinutes) / 60;
                        return durationHours * 140;
                    }

                    // Render off-duty overlay (gray) - before shift start
                    if (staff.shift_start && staff.shift_start !== '09:00') {
                        const offDutyStart = createOverlay('off-duty', 0, timeToPosition(staff.shift_start));
                        row.appendChild(offDutyStart);
                    }

                    // Render off-duty overlay (gray) - after shift end
                    if (staff.shift_end && staff.shift_end !== '22:00') {
                        const offDutyEndPos = timeToPosition(staff.shift_end);
                        const gridEnd = 13 * 140; // 22:00 - 9:00 = 13 hours
                        const offDutyEnd = createOverlay('off-duty', offDutyEndPos, gridEnd - offDutyEndPos);
                        row.appendChild(offDutyEnd);
                    }

                    // Render break overlays (yellow)
                    if (staff.breaks && staff.breaks.length > 0) {
                        staff.breaks.forEach((breakTime) => {
                            if (breakTime.start && breakTime.end) {
                                const left = timeToPosition(breakTime.start);
                                const width = calculateWidth(breakTime.start, breakTime.end);
                                const breakOverlay = createOverlay('break', left, width);
                                row.appendChild(breakOverlay);
                            }
                        });
                    }

                    // Render out-of-office overlays (red)
                    if (staff.ooo && staff.ooo.length > 0) {
                        staff.ooo.forEach((oooTime) => {
                            if (oooTime.start && oooTime.end) {
                                const left = timeToPosition(oooTime.start);
                                const width = calculateWidth(oooTime.start, oooTime.end);
                                const oooOverlay = createOverlay('out-of-office', left, width);
                                if (oooTime.reason) {
                                    oooOverlay.title = oooTime.reason;
                                }
                                row.appendChild(oooOverlay);
                            }
                        });
                    }
                });
            }

            // Create overlay element
            function createOverlay(type, left, width) {
                const overlay = document.createElement('div');
                overlay.className = `shift-overlay shift-overlay-${type}`;
                overlay.style.left = `${left}px`;
                overlay.style.width = `${width}px`;

                // Add label based on type
                if (type === 'break') {
                    overlay.innerHTML = '<span class="overlay-label">Break</span>';
                } else if (type === 'out-of-office') {
                    overlay.innerHTML = '<span class="overlay-label">OOO</span>';
                } else if (type === 'off-duty') {
                    overlay.innerHTML = '<span class="overlay-label">Off Duty</span>';
                }

                return overlay;
            }

            // Update the displayed statistics (total and completed bookings)
            function updateStats() {
                // Only count non-cancelled appointments
                const total = bookingsData.filter(
                    (b) => b.status !== "cancelled",
                ).length;
                const completed = bookingsData.filter(
                    (b) => b.status === "completed",
                ).length;

                document.getElementById("totalBookings").textContent = total;
                document.getElementById("completedBookings").textContent =
                    completed;
            }

            // Render all bookings onto the timeline grid
            function renderBookings() {
                // Remove existing appointment blocks
                document
                    .querySelectorAll(".appointment-block")
                    .forEach((el) => el.remove());

                bookingsData.forEach((booking) => {
                    const row = document.querySelector(
                        `.timeline-row[data-staff-id="${booking.staff_id}"]`,
                    );
                    if (!row) return; // Skip if no matching row found

                    const startHour = parseFloat(booking.start_hour);
                    const startMinute = parseFloat(booking.start_minute);
                    const hoursSince9AM = startHour - 9 + startMinute / 60;
                    const leftPosition = hoursSince9AM * 140; // 140px per hour slot

                    const durationHours = booking.duration / 60;
                    const width = Math.max(durationHours * 140, 80); // Minimum width of 80px

                    const serviceType = booking.service_type || "default"; // Use service type for styling

                    const block = document.createElement("div");
                    block.className = `appointment-block service-${serviceType}`;
                    block.style.left = `${leftPosition}px`;
                    block.style.width = `${width}px`;
                    block.dataset.appointmentId = booking.id;
                    block.draggable = true; // Enable dragging for appointments

                    // Populate block content
                    block.innerHTML = `
            <div class="appointment-header">
                <div class="appointment-client">${booking.client_name}</div>
                <div class="appointment-status"></div>
            </div>
            <div class="appointment-service">${booking.service_names}</div>
            <div class="appointment-footer">
                <div class="appointment-time">
                    <i class="fas fa-clock"></i>
                    ${booking.start_time}
                </div>
                <div class="appointment-duration">${booking.duration}m</div>
            </div>
        `;

                    row.appendChild(block);
                });

                // Reinitialize context menu for dynamically added appointments
                if (window.appointmentContextMenu && typeof window.appointmentContextMenu.reinitializeForAppointments === 'function') {
                    console.log('ðŸ”„ Reinitializing context menu after rendering bookings');
                    window.appointmentContextMenu.reinitializeForAppointments();
                } else {
                    console.error('âŒ AppointmentContextMenu or its reinitialize function not available');
                }
            }

            // ==========================================
            // MULTI-APPOINTMENT MODAL FUNCTIONS
            // ==========================================

            // Open the multi-appointment booking modal
            function openMultiBookModal() {
                const modal = new bootstrap.Modal(
                    document.getElementById("multiBookModal"),
                );
                appointmentCounter = 1; // Reset counter for new modal instance
                resetMultiBookModal(); // Reset modal to default state
                modal.show();
            }

            // Reset modal to its initial state with one appointment card
            function resetMultiBookModal() {
                document.getElementById("multiClientSelect").value = "";
                document.getElementById("multiNotes").value = "";

                const container = document.getElementById(
                    "appointmentsContainer",
                );
                const firstCard = container.querySelector(".appointment-card");

                // Remove all but the first appointment card
                container
                    .querySelectorAll(".appointment-card:not(:first-child)")
                    .forEach((card) => card.remove());

                // Reset the first card to its default state
                if (firstCard) {
                    firstCard.dataset.appointmentIndex = "0";
                    firstCard.querySelector(".appointment-number").textContent =
                        "1";
                    firstCard
                        .querySelector(".remove-appointment")
                        .classList.add("d-none"); // Hide remove button for the only card
                    firstCard.querySelector(".service-select").value = "";
                    firstCard.querySelector(".staff-select").value = "";
                    firstCard.querySelector(".appointment-date").value =
                        "{{ today }}"; // Default to today's date
                    firstCard.querySelector(".start-time").value = "09:00"; // Default start time
                    firstCard.querySelector(".end-time").value = ""; // Clear end time
                    firstCard.querySelector(".alert").classList.add("d-none"); // Hide conflict alert
                    firstCard.classList.remove("duplicate"); // Remove duplicate styling
                    clearAllFieldErrors(firstCard); // Clear any previous validation errors
                }

                updateAppointmentCount();
                updateSummary();
                updateSubmitButton(); // Ensure button is enabled/disabled correctly
            }

            // Add a new appointment card to the modal
            function addAppointment() {
                const container = document.getElementById(
                    "appointmentsContainer",
                );
                const newIndex = appointmentCounter++; // Increment counter for new card

                const appointmentCardHTML = createAppointmentCard(newIndex);
                container.insertAdjacentHTML('beforeend', appointmentCardHTML);

                // Setup validation listeners for the newly added card
                setupRealtimeValidation();
                updateSubmitButton(); // Update submit button state
                updateAppointmentCount();
                updateRemoveButtonsVisibility();
            }

            // Helper function to create the HTML for a new appointment card
            function createAppointmentCard(index) {
                return `
        <div class="appointment-card" data-appointment-index="${index}">
            <div class="appointment-number">${index + 1}</div>
            <button type="button" class="remove-appointment" onclick="removeAppointment(${index})">
                <i class="fas fa-times"></i>
            </button>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="fas fa-concierge-bell me-2" style="color: var(--primary-color);"></i>
                        Service *
                    </label>
                    <select class="form-select service-select" required style="border-radius: 10px; padding: 12px;">
                        <option value="">Select service...</option>
                        {% if services %}
                        {% for service in services %}
                            <option value="{{ service.id }}" 
                                    data-duration="{{ service.duration or 60 }}"
                                    data-price="{{ service.price }}">
                                {{ service.name }} ({{ service.duration or 60 }} min - â‚¹{{ "%.2f"|format(service.price) }})
                            </option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="fas fa-user-md me-2" style="color: var(--primary-color);"></i>
                        Staff Member *
                    </label>
                    <select class="form-select staff-select" required style="border-radius: 10px; padding: 12px;">
                        <option value="">Select staff member...</option>
                        {% if staff_members %}
                        {% for staff in staff_members %}
                            <option value="{{ staff.id }}">
                                {{ staff.first_name }} {{ staff.last_name if staff.last_name else '' }}
                            </option>
                        {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="fas fa-calendar me-2" style="color: var(--primary-color);"></i>
                        Date *
                    </label>
                    <input type="date" class="form-control appointment-date" 
                           value="{{ today }}" required style="border-radius: 10px; padding: 12px;">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="fas fa-clock me-2" style="color: var(--primary-color);"></i>
                        Start Time *
                    </label>
                    <input type="time" class="form-control start-time" 
                           value="09:00" required style="border-radius: 10px; padding: 12px;">
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-semibold">
                        <i class="fas fa-clock me-2" style="color: var(--success-color);"></i>
                        End Time
                    </label>
                    <input type="time" class="form-control end-time" readonly
                           style="border-radius: 10px; padding: 12px; background: #f0fdf4; font-weight: 600; color: var(--success-color);">
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <div id="conflictAlert${index}" class="alert alert-warning d-none" style="border-radius: 10px;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span class="conflict-message"></span>
                    </div>
                </div>
            </div>
        </div>
    `;
            }

            // Remove an appointment card from the modal
            function removeAppointment(index) {
                const card = document.querySelector(
                    `[data-appointment-index="${index}"]`,
                );
                if (card) {
                    card.remove();
                    updateAppointmentCount();
                    updateRemoveButtonsVisibility();
                    updateSummary();
                    updateSubmitButton(); // Update button state after removal
                }
            }

            // Update the displayed count of appointments
            function updateAppointmentCount() {
                const count =
                    document.querySelectorAll(".appointment-card").length;
                document.getElementById("appointmentCount").textContent =
                    `${count} Appointment${count !== 1 ? "s" : ""}`;
            }

            // Update the visibility of remove buttons (only show if more than one card exists)
            function updateRemoveButtonsVisibility() {
                const cards = document.querySelectorAll(".appointment-card");
                cards.forEach((card, index) => {
                    const removeBtn = card.querySelector(".remove-appointment");
                    if (cards.length > 1) {
                        removeBtn.classList.remove("d-none");
                    } else {
                        removeBtn.classList.add("d-none");
                    }
                });
            }

            // Calculate and set the end time based on selected service duration and start time
            function calculateEndTime(index) {
                const card = document.querySelector(
                    `[data-appointment-index="${index}"]`,
                );
                if (!card) return;

                const serviceSelect = card.querySelector(".service-select");
                const startTimeInput = card.querySelector(".start-time");
                const endTimeInput = card.querySelector(".end-time");

                const selectedOption = serviceSelect.selectedOptions[0];
                const startTime = startTimeInput.value;

                if (!selectedOption || !startTime) {
                    endTimeInput.value = ""; // Clear end time if service or start time is missing
                    return;
                }

                const duration =
                    parseInt(selectedOption.dataset.duration) || 60; // Default to 60 minutes
                const [hours, minutes] = startTime.split(':').map(Number);
                const startDate = new Date();
                startDate.setHours(hours, minutes, 0, 0); // Set hours, minutes, seconds, ms

                // Calculate end date by adding duration
                const endDate = new Date(
                    startDate.getTime() + duration * 60000, // duration in milliseconds
                );
                const endTimeStr = endDate.toTimeString().slice(0, 5); // Format as HH:MM
                endTimeInput.value = endTimeStr;
            }

            // Check for conflicts for a specific appointment card
            function checkConflicts(appointmentIndex) { // Renamed parameter for clarity
                const appointment = document.querySelector(`[data-appointment-index="${appointmentIndex}"]`);
                if (!appointment) return;

                const staffSelect = appointment.querySelector('.staff-select');
                const dateInput = appointment.querySelector('.appointment-date');
                const startTimeInput = appointment.querySelector('.start-time');
                const endTimeInput = appointment.querySelector('.end-time');
                const conflictAlert = appointment.querySelector(`#conflictAlert${appointmentIndex}`);
                const conflictMessageSpan = conflictAlert?.querySelector('.conflict-message');

                // Clear previous conflict styling and message
                if (conflictAlert) conflictAlert.classList.add('d-none');
                appointment.classList.remove('duplicate');
                clearFieldError(staffSelect); // Clear staff conflict error if any
                clearFieldError(startTimeInput); // Clear time conflict error if any

                // Only proceed if all essential fields are filled
                if (
                    !staffSelect.value ||
                    !dateInput.value ||
                    !startTimeInput.value ||
                    !endTimeInput.value
                ) {
                    return; // Not enough info to check conflicts
                }

                const staffId = parseInt(staffSelect.value);
                const date = dateInput.value;
                const startTime = startTimeInput.value;
                const endTime = endTimeInput.value;

                let conflictFound = false;

                // Check against existing bookings from bookingsData
                bookingsData.forEach(booking => {
                    if (booking.staff_id == staffId && booking.appointment_date === date) {
                        const bookingStart = booking.start_time;
                        const bookingEnd = booking.end_time;

                        if (timesOverlap(startTime, endTime, bookingStart, bookingEnd)) {
                            const message = `Staff member is already booked from ${formatTime(bookingStart)} to ${formatTime(bookingEnd)}`;
                            if (conflictMessageSpan) conflictMessageSpan.textContent = message;
                            if (conflictAlert) conflictAlert.classList.remove('d-none');
                            appointment.classList.add('duplicate');
                            showFieldError(staffSelect, message); // Show error on staff select
                            conflictFound = true;
                        }
                    }
                });

                // Check for conflicts within the current multi-booking session
                const currentAppointments = document.querySelectorAll('.appointment-card');
                currentAppointments.forEach((otherCard, otherIndex) => {
                    if (parseInt(otherCard.dataset.appointmentIndex) === appointmentIndex) return; // Skip self-comparison

                    const otherStaffSelect = otherCard.querySelector('.staff-select');
                    const otherDateInput = otherCard.querySelector('.appointment-date');
                    const otherStartTimeInput = otherCard.querySelector('.start-time');
                    const otherEndTimeInput = otherCard.querySelector('.end-time');

                    if (otherStaffSelect.value && otherDateInput.value && otherStartTimeInput.value && otherEndTimeInput.value) {
                        if (parseInt(otherStaffSelect.value) === staffId && otherDateInput.value === date) {
                            if (timesOverlap(startTime, endTime, otherStartTimeInput.value, otherEndTimeInput.value)) {
                                const message = `Conflict with Appointment #${otherIndex + 1}`;
                                if (conflictMessageSpan) conflictMessageSpan.textContent = message;
                                if (conflictAlert) conflictAlert.classList.remove('d-none');
                                appointment.classList.add('duplicate');
                                showFieldError(startTimeInput, message); // Show error on start time
                                conflictFound = true;
                            }
                        }
                    }
                });

                // Check against shift constraints (breaks, out-of-office, shift hours) via backend
                fetch('/api/unaki/check-conflicts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        staff_id: staffId,
                        start_time: startTime,
                        end_time: endTime,
                        date: date
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.shift_violation) {
                        const message = data.reason || 'Shift constraint violation';
                        if (conflictMessageSpan) conflictMessageSpan.textContent = message;
                        if (conflictAlert) conflictAlert.classList.remove('d-none');
                        appointment.classList.add('duplicate');
                        showFieldError(startTimeInput, message);
                    } else if (data.has_conflicts && data.conflicts && data.conflicts.length > 0) {
                        const booking = data.conflicts[0];
                        const message = `Conflicts with ${booking.client_name || 'booking'} (${booking.start_time} - ${booking.end_time})`;
                        if (conflictMessageSpan) conflictMessageSpan.textContent = message;
                        if (conflictAlert) conflictAlert.classList.remove('d-none');
                        appointment.classList.add('duplicate');
                        showFieldError(startTimeInput, message);
                    }
                })
                .catch(error => {
                    console.error('Error checking shift conflicts:', error);
                });
            }

            // Update the summary section (total duration, price, staff count)
            function updateSummary() {
                let totalDuration = 0;
                let totalPrice = 0;
                const staffSet = new Set();

                document
                    .querySelectorAll(".appointment-card")
                    .forEach((card) => {
                        const serviceSelect =
                            card.querySelector(".service-select");
                        const staffSelect = card.querySelector(".staff-select");

                        if (serviceSelect.value) {
                            const selectedOption =
                                serviceSelect.selectedOptions[0];
                            const duration =
                                parseInt(selectedOption.dataset.duration) || 60;
                            const price =
                                parseFloat(selectedOption.dataset.price) || 0;

                            totalDuration += duration;
                            totalPrice += price;
                        }

                        if (staffSelect.value) {
                            staffSet.add(staffSelect.value);
                        }
                    });

                document.getElementById("multiTotalDuration").textContent =
                    `${totalDuration} min`;
                document.getElementById("multiTotalPrice").textContent =
                    `$${totalPrice.toFixed(2)}`;
                document.getElementById("multiStaffCount").textContent =
                    staffSet.size;
            }

            // ==========================================
            // SUBMISSION AND VALIDATION LOGIC
            // ==========================================

            function submitMultiAppointment() {
                console.log('ðŸ“ Starting multi-appointment submission...');

                // Get client information
                const clientSelect = document.getElementById('multiClientSelect');
                const clientId = clientSelect?.value;
                const clientName = clientSelect?.options[clientSelect.selectedIndex]?.text;

                if (!clientId) {
                    showNotification('âš ï¸ Please select a client', 'error');
                    return;
                }

                // Check for past appointments on submission
                const now = new Date();
                const appointments = document.querySelectorAll('.appointment-card');
                let hasPastAppointment = false;

                appointments.forEach(appointment => {
                    const date = appointment.querySelector('.appointment-date')?.value;
                    const startTime = appointment.querySelector('.start-time')?.value;
                    if (date && startTime) {
                        const appointmentDateTime = new Date(`${date}T${startTime}`);
                        if (appointmentDateTime < now) {
                            hasPastAppointment = true;
                        }
                    }
                });

                if (hasPastAppointment) {
                    if (!confirm('âš ï¸ One or more appointments are scheduled in the past. Do you want to proceed anyway?')) {
                        return;
                    }
                }

                // Final validation check before submission
                const errors = validateAllAppointments();

                if (errors.length > 0) {
                    // Display validation errors to the user
                    const errorList = errors.map((err, i) => `${i + 1}. ${err}`).join('\n');
                    showNotification(`Please fix the following errors:\n\n${errorList}`, 'error');

                    // Focus the first invalid field for easier correction
                    const firstInvalidField = document.querySelector('.is-invalid');
                    if (firstInvalidField) {
                        firstInvalidField.focus();
                    }
                    return; // Stop submission if there are errors
                }

                // Proceed with booking if validation passes
                const appointmentCards = document.querySelectorAll('.appointment-card');
                const appointmentsToBook = [];

                // Gather appointment data from each card
                appointmentCards.forEach((card) => {
                    const serviceSelect = card.querySelector('.service-select');
                    const staffSelect = card.querySelector('.staff-select');
                    const dateInput = card.querySelector('.appointment-date');
                    const startTimeInput = card.querySelector('.start-time');
                    const endTimeInput = card.querySelector('.end-time');

                    const serviceId = serviceSelect.value;
                    const serviceName = serviceSelect.options[serviceSelect.selectedIndex]?.text;
                    const staffId = staffSelect.value;
                    const date = dateInput.value;
                    const startTime = startTimeInput.value;
                    const endTime = endTimeInput.value;

                    // Only include appointments with all required fields filled
                    if (serviceId && serviceName && staffId && date && startTime && endTime) {
                        appointmentsToBook.push({
                            service_id: serviceId,
                            service_name: serviceName,
                            staff_id: staffId,
                            client_name: clientName,
                            date: date,
                            start_time: startTime,
                            end_time: endTime
                        });
                    }
                });

                // Ensure at least one valid appointment is selected
                if (appointmentsToBook.length === 0) {
                    showNotification('Please add at least one valid appointment', 'error');
                    return;
                }

                // Show loading overlay during submission
                const overlay = document.getElementById("loadingOverlay");
                overlay.classList.add("show");

                // Submit each appointment individually
                const bookingPromises = appointmentsToBook.map((appointment) => {
                    return fetch("/api/unaki/book-appointment", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            ...appointment,
                            client_id: clientId,
                            notes: document.getElementById('multiNotes').value.trim()
                        }),
                    });
                });

                // Wait for all booking requests to complete
                Promise.all(bookingPromises)
                    .then((responses) =>
                        Promise.all(responses.map((r) => r.json())), // Parse JSON responses
                    )
                    .then((results) => {
                        overlay.classList.remove("show"); // Hide loading overlay

                        const successCount = results.filter(
                            (r) => r.success,
                        ).length;
                        const totalCount = results.length;

                        // Handle successful booking
                        if (successCount === totalCount) {
                            bootstrap.Modal.getInstance(
                                document.getElementById("multiBookModal"),
                            ).hide(); // Close the modal
                            showNotification(
                                `Successfully booked ${successCount} appointments!`,
                                "success",
                            );
                            loadBookings(); // Refresh the schedule view
                        } else {
                            // Handle partial or failed bookings
                            const failures = results.filter((r) => !r.success);
                            let errorMsg = `Booked ${successCount}/${totalCount} appointments.\n\nErrors:\n`;
                            failures.forEach((failure, index) => {
                                errorMsg += `- ${failure.error || "Unknown error"}\n`;
                            });
                            alert(errorMsg); // Show detailed errors
                        }
                    })
                    .catch((error) => {
                        overlay.classList.remove("show");
                        console.error("Error during booking submission:", error);
                        showNotification("An error occurred while booking appointments.", "error");
                    });
            }

            // ==========================================
            // VALIDATION FUNCTIONS
            // ==========================================

            function validateClientSelection() {
                const clientSelect = document.getElementById('multiClientSelect');
                const clientId = clientSelect.value;

                if (!clientId) {
                    showFieldError(clientSelect, 'Please select a client before booking');
                    return false;
                }

                clearFieldError(clientSelect);
                return true;
            }

            function validateAppointmentCard(card, index) {
                const errors = [];
                const appointmentNum = index + 1;

                // Validate Service
                const serviceSelect = card.querySelector('.service-select');
                if (!serviceSelect.value) {
                    errors.push(`Service is required for Appointment #${appointmentNum}`);
                    showFieldError(serviceSelect, `Service is required for Appointment #${appointmentNum}`);
                } else {
                    clearFieldError(serviceSelect);
                }

                // Validate Staff (CRITICAL)
                const staffSelect = card.querySelector('.staff-select');
                if (!staffSelect.value) {
                    errors.push(`Staff member is required for Appointment #${appointmentNum}`);
                    showFieldError(staffSelect, `Staff member is required for Appointment #${appointmentNum}`);
                } else {
                    clearFieldError(staffSelect);
                }

                // Validate Date
                const dateInput = card.querySelector('.appointment-date');
                const dateValue = dateInput.value;
                if (!dateValue) {
                    errors.push(`Date is required for Appointment #${appointmentNum}`);
                    showFieldError(dateInput, `Date is required for Appointment #${appointmentNum}`);
                } else {
                    const selectedDate = new Date(dateValue);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (selectedDate < today) {
                        errors.push('Cannot book appointments in the past');
                        showFieldError(dateInput, 'Cannot book appointments in the past');
                    } else {
                        clearFieldError(dateInput);
                    }
                }

                // Validate Start Time
                const timeInput = card.querySelector('.start-time');
                const timeValue = timeInput.value;
                if (!timeValue) {
                    errors.push(`Start time is required for Appointment #${appointmentNum}`);
                    showFieldError(timeInput, `Start time is required for Appointment #${appointmentNum}`);
                } else {
                    // Check business hours (09:00 - 21:00)
                    const [hours, minutes] = timeValue.split(':').map(Number);
                    if (hours < 9 || hours >= 21) {
                        errors.push('Time must be between 9:00 AM and 9:00 PM');
                        showFieldError(timeInput, 'Time must be between 9:00 AM and 9:00 PM');
                    } else if (dateValue === new Date().toISOString().split('T')[0]) {
                        // If date is today, check if time is in future
                        const now = new Date();
                        const selectedTime = new Date();
                        selectedTime.setHours(hours, minutes, 0, 0);

                        if (selectedTime <= now) {
                            errors.push('Cannot book appointments in the past');
                            showFieldError(timeInput, 'Cannot book appointments in the past');
                        } else {
                            clearFieldError(timeInput);
                        }
                    } else {
                        clearFieldError(timeInput);
                    }
                }

                // Validate End Time
                const endTimeInput = card.querySelector('.end-time');
                const endTimeValue = endTimeInput.value;
                if (!endTimeValue) {
                    errors.push(`End time is required for Appointment #${appointmentNum}`);
                    showFieldError(endTimeInput, `End time is required for Appointment #${appointmentNum}`);
                } else {
                    clearFieldError(endTimeInput);
                }

                return errors;
            }

            function detectConflicts() {
                const appointmentCards = document.querySelectorAll('.appointment-card');
                const conflicts = [];
                const currentAppointments = [];

                // Collect current appointments from the modal
                appointmentCards.forEach((card, index) => {
                    const staffId = card.querySelector('.staff-select').value;
                    const date = card.querySelector('.appointment-date').value;
                    const startTime = card.querySelector('.start-time').value;
                    const endTime = card.querySelector('.end-time').value;

                    // Only consider appointments with all necessary fields
                    if (staffId && date && startTime && endTime) {
                        currentAppointments.push({
                            index,
                            card,
                            staffId,
                            date,
                            startTime,
                            endTime
                        });
                    }
                });

                // Check for conflicts with existing bookings loaded from the server
                currentAppointments.forEach(apt => {
                    bookingsData.forEach(booking => {
                        // Check if same staff and same date
                        if (booking.staff_id == apt.staffId && booking.appointment_date === apt.date) {
                            const bookingStart = booking.start_time;
                            const bookingEnd = booking.end_time;

                            // Check for time overlap
                            if (timesOverlap(apt.startTime, apt.endTime, bookingStart, bookingEnd)) {
                                conflicts.push({
                                    card: apt.card,
                                    index: apt.index,
                                    message: `Staff member is already booked from ${formatTime(bookingStart)} to ${formatTime(bookingEnd)}`
                                });
                            }
                        }
                    });

                    // Check for conflicts within the current multi-booking session
                    currentAppointments.forEach(otherApt => {
                        // Ensure it's not comparing the same appointment card and check for overlap
                        if (apt.index !== otherApt.index &&
                            apt.staffId === otherApt.staffId &&
                            apt.date === otherApt.date) {
                            if (timesOverlap(apt.startTime, apt.endTime, otherApt.startTime, otherApt.endTime)) {
                                conflicts.push({
                                    card: apt.card,
                                    index: apt.index,
                                    message: `Conflict with Appointment #${otherApt.index + 1}`
                                });
                            }
                        }
                    });
                });

                // Apply duplicate styling and error messages to conflicting cards
                appointmentCards.forEach(card => card.classList.remove('duplicate')); // Clear previous duplicate styling
                conflicts.forEach(conflict => {
                    conflict.card.classList.add('duplicate'); // Add styling for conflict
                    // Find the relevant field to display the error message on (e.g., staff select)
                    const errorField = conflict.card.querySelector('.staff-select') || conflict.card.querySelector('.start-time');
                    showFieldError(errorField, conflict.message);
                });

                return conflicts;
            }

            // Helper function to check if two time ranges overlap
            function timesOverlap(start1, end1, start2, end2) {
                // Overlap occurs if start1 is before end2 AND end1 is after start2
                return (start1 < end2 && end1 > start2);
            }

            // Apply 'is-invalid' class and show error message for a field
            function showFieldError(field, message) {
                field.classList.add('is-invalid');
                field.classList.remove('is-valid');

                // Remove any existing error message for this field
                const existingError = field.parentElement.querySelector('.validation-error');
                if (existingError) {
                    existingError.remove();
                }

                // Create and append the new error message div
                const errorDiv = document.createElement('div');
                errorDiv.className = 'validation-error text-danger small mt-1';
                errorDiv.textContent = message;
                field.parentElement.appendChild(errorDiv);
            }

            // Remove 'is-invalid' and 'is-valid' classes, and clear error message
            function clearFieldError(field) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');

                const errorDiv = field.parentElement.querySelector('.validation-error');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }

            // Clear all validation error styling from fields within a card
            function clearAllFieldErrors(card) {
                card.querySelectorAll('.form-control, .form-select').forEach(field => {
                    field.classList.remove('is-invalid', 'is-valid');
                    const errorDiv = field.parentElement.querySelector('.validation-error');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                });
                card.classList.remove('duplicate');
            }

            // Validate all appointments in the modal and return a list of errors
            function validateAllAppointments() {
                const errors = [];

                // Validate client selection first
                if (!validateClientSelection()) {
                    errors.push('Client selection is required');
                }

                // Validate each individual appointment card
                const appointmentCards = document.querySelectorAll('.appointment-card');
                appointmentCards.forEach((card, index) => {
                    const cardErrors = validateAppointmentCard(card, index);
                    errors.push(...cardErrors); // Add errors from the card to the main list
                });

                // Check for conflicts between appointments
                const conflicts = detectConflicts();
                if (conflicts.length > 0) {
                    // Add conflict messages to the errors list
                    conflicts.forEach(conflict => {
                        errors.push(conflict.message);
                    });
                }

                return errors;
            }

            // Update the disabled state of the submit button based on validation status
            function updateSubmitButton() {
                // Find the submit button (assuming it has a specific class or attribute)
                const submitBtn = document.querySelector('.modal-footer .btn-success[onclick="submitMultiAppointment()"]');
                if (!submitBtn) return; // Exit if button not found

                const errors = validateAllAppointments(); // Get current validation errors

                if (errors.length > 0) {
                    // Disable button if there are errors
                    submitBtn.disabled = true;
                    submitBtn.classList.add('submit-btn-disabled');
                    submitBtn.title = 'Please complete all required fields and resolve conflicts';
                } else {
                    // Enable button if no errors
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('submit-btn-disabled');
                    submitBtn.title = ''; // Clear tooltip
                }
            }

            // ==========================================
            // CUSTOMER EXISTING APPOINTMENTS
            // ==========================================

            function loadCustomerExistingAppointments(customerId) {
                const container = document.getElementById('customerExistingAppointments');
                const listDiv = document.getElementById('customerAppointmentsList');
                const countBadge = document.getElementById('customerAppointmentsCount');

                if (!customerId) {
                    // Hide the section if no customer selected
                    container.style.display = 'none';
                    return;
                }

                // Show loading state
                container.style.display = 'block';
                listDiv.innerHTML = '<small class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Loading...</small>';

                // Fetch customer appointments
                fetch(`/api/unaki/customer-appointments/${customerId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.bookings && data.bookings.length > 0) {
                            countBadge.textContent = data.bookings.length;
                            displayCustomerAppointments(data.bookings);
                        } else {
                            countBadge.textContent = '0';
                            listDiv.innerHTML = '<small class="text-muted"><i class="fas fa-info-circle me-1"></i>No upcoming appointments</small>';
                        }
                    })
                    .catch(err => {
                        console.error('Error loading customer appointments:', err);
                        listDiv.innerHTML = '<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error loading appointments</small>';
                    });
            }

            function displayCustomerAppointments(appointments) {
                const listDiv = document.getElementById('customerAppointmentsList');

                let html = '<div class="list-group list-group-flush">';
                appointments.forEach(apt => {
                    const date = new Date(apt.appointment_date);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric',
                        year: 'numeric'
                    });

                    const statusColor = apt.status === 'confirmed' ? 'success' : 
                                       apt.status === 'scheduled' ? 'primary' : 'secondary';

                    html += `
                        <div class="list-group-item px-2 py-2" style="border: none; border-bottom: 1px solid #eee;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="fw-semibold" style="font-size: 0.9rem;">
                                        <i class="fas fa-spa me-1" style="color: var(--primary-color);"></i>
                                        ${apt.service_names}
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>${formattedDate}
                                        <i class="fas fa-clock ms-2 me-1"></i>${apt.start_time} - ${apt.end_time}
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-user-nurse me-1"></i>${apt.staff_name}
                                    </small>
                                </div>
                                <span class="badge bg-${statusColor}" style="font-size: 0.7rem;">${apt.status}</span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';

                listDiv.innerHTML = html;
            }

            // ==========================================
            // REAL-TIME VALIDATION SETUP
            // ==========================================

            // Setup event listeners for real-time validation on input/change/blur events
            function setupRealtimeValidation() {
                // Client selection validation
                const clientSelect = document.getElementById('multiClientSelect');
                if (clientSelect) {
                    clientSelect.addEventListener('change', () => {
                        validateClientSelection();
                        updateSubmitButton(); // Re-evaluate submit button state
                        loadCustomerExistingAppointments(clientSelect.value); // Load customer's appointments
                    });
                }

                // Setup validation for all appointment cards
                const appointmentCards = document.querySelectorAll('.appointment-card');
                appointmentCards.forEach((card, index) => {
                    // Service validation (on blur and change)
                    const serviceSelect = card.querySelector('.service-select');
                    if (serviceSelect) {
                        serviceSelect.addEventListener('blur', () => {
                            validateAppointmentCard(card, index);
                            updateSubmitButton();
                        });
                        serviceSelect.addEventListener('change', () => {
                            validateAppointmentCard(card, index);
                            calculateEndTime(index); // Recalculate end time on service change
                            checkConflicts(index); // Re-check conflicts
                            updateSubmitButton();
                        });
                    }

                    // Staff validation (on blur and change)
                    const staffSelect = card.querySelector('.staff-select');
                    if (staffSelect) {
                        staffSelect.addEventListener('blur', () => {
                            validateAppointmentCard(card, index);
                            detectConflicts(); // Re-check conflicts
                            updateSubmitButton();
                        });
                        staffSelect.addEventListener('change', () => {
                            validateAppointmentCard(card, index);
                            detectConflicts(); // Re-check conflicts
                            updateSubmitButton();
                        });
                    }

                    // Date validation (on change)
                    const dateInput = card.querySelector('.appointment-date');
                    if (dateInput) {
                        dateInput.addEventListener('change', () => {
                            validateAppointmentCard(card, index);
                            detectConflicts(); // Re-check conflicts
                            updateSubmitButton();
                        });
                    }

                    // Time validation (on blur and change)
                    const timeInput = card.querySelector('.start-time');
                    if (timeInput) {
                        timeInput.addEventListener('blur', () => {
                            validateAppointmentCard(card, index);
                            calculateEndTime(index); // Recalculate end time on time change
                            detectConflicts(); // Re-check conflicts
                            updateSubmitButton();
                        });
                        timeInput.addEventListener('change', () => {
                            validateAppointmentCard(card, index);
                            calculateEndTime(index); // Recalculate end time on time change
                            detectConflicts(); // Re-check conflicts
                            updateSubmitButton();
                        });
                    }
                });
            }

            // ==========================================
            // NAVIGATION AND UTILITY FUNCTIONS
            // ==========================================

            // Navigate to a different date
            function navigateDate(days) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() + days);
                const newDate = date.toISOString().split("T")[0];
                window.location.href = `{{ url_for('unaki_booking') }}?date=${newDate}`;
            }

            // Navigate back to the current date
            function navigateToToday() {
                const today = new Date().toISOString().split("T")[0];
                window.location.href = `{{ url_for('unaki_booking') }}?date=${today}`;
            }

            // Refresh the schedule view by reloading bookings
            function refreshSchedule() {
                loadBookings();
                loadShiftSchedule(); // Also refresh shift overlays

                // Visual feedback for refresh button
                const btn = event.target.closest(".action-icon");
                btn.style.transform = "rotate(360deg)";
                setTimeout(() => {
                    btn.style.transform = "rotate(0deg)";
                }, 600);
            }

            // Handle clicks on timeline slots to open the booking modal
            function handleSlotClick(event, staffId, hour, minute) {
                event.stopPropagation(); // Prevent event bubbling

                const slot = event.currentTarget;
                const rect = slot.getBoundingClientRect();
                const clickX = event.clientX - rect.left; // X coordinate of click within the slot
                const slotWidth = rect.width; // Width of the time slot (assuming 1 hour slot width)

                // Calculate the minute offset based on click position within the hour slot
                // Assuming each slot is 140px wide (representing 1 hour)
                // 15 minutes = 140px * (15/60) = 35px
                const minuteOffset =
                    Math.floor(((clickX / slotWidth) * 60) / 15) * 15; // Snap to nearest 15 min
                const time = `${String(hour).padStart(2, "0")}:${String(minuteOffset).padStart(2, "0")}`;

                openMultiBookModalWithData(staffId, currentDate, time);
            }

            // Open the multi-booking modal and pre-fill the first appointment
            function openMultiBookModalWithData(staffId, date, time) {
                openMultiBookModal(); // This function also calls setupRealtimeValidation

                // Pre-fill the first appointment card
                const firstCard = document.querySelector(".appointment-card");
                if (firstCard) {
                    firstCard.querySelector(".staff-select").value = staffId;
                    firstCard.querySelector(".appointment-date").value = date;
                    firstCard.querySelector(".start-time").value = time;
                    calculateEndTime(0); // Calculate end time based on default service
                    checkConflicts(0); // Check conflicts for the pre-filled card
                    updateSubmitButton(); // Ensure button state is correct initially
                }
            }

            // Show a notification message (using alert as a placeholder)
            function showNotification(message, type) {
                // In a real app, replace this with a more sophisticated notification system (e.g., toast)
                alert(message);
            }

            // View appointment details (placeholder)
            function viewAppointment(appointmentId) {
                selectedAppointmentId = appointmentId;
                alert("View appointment " + appointmentId);
            }

            // ==========================================
            // CONTEXT MENU FUNCTIONS
            // ==========================================

            // Show context menu on right-click of an appointment block
            function showContextMenu(event, appointmentId) {
                event.preventDefault(); // Prevent default context menu
                console.log('ðŸŽ¯ showContextMenu called for appointment:', appointmentId);
                if (window.appointmentContextMenu) {
                    window.appointmentContextMenu.showContextMenu(event.pageX, event.pageY, appointmentId);
                } else {
                    console.error('âŒ AppointmentContextMenu not available');
                }
            }

            // Hide the context menu
            function hideContextMenu() {
                if (window.appointmentContextMenu) {
                    window.appointmentContextMenu.hideContextMenu();
                }
            }

            // Action: View Appointment Details
            function viewAppointmentDetails() {
                if (selectedAppointmentId && window.appointmentContextMenu) {
                    window.appointmentContextMenu.viewAppointment(selectedAppointmentId);
                }
            }

            // Action: Edit Appointment
            function editAppointment() {
                if (selectedAppointmentId) {
                    if (window.appointmentContextMenu && typeof window.appointmentContextMenu.editAppointment === 'function') {
                        window.appointmentContextMenu.editAppointment(selectedAppointmentId);
                    } else {
                        // Fallback to opening the local edit modal if context menu function is unavailable
                        const id = parseInt(selectedAppointmentId, 10);
                        const booking = bookingsData.find((b) => b.id === id);
                        if (booking) {
                            openEditModal(booking);
                        } else {
                            console.error(`Booking with ID ${id} not found in bookingsData`);
                        }
                    }
                }
                hideContextMenu();
            }

            // Action: Check In Client (placeholder)
            function checkInAppointment() {
                if (selectedAppointmentId) {
                    alert("Check in appointment " + selectedAppointmentId);
                }
                hideContextMenu();
            }

            // Action: Duplicate Appointment (placeholder)
            function duplicateAppointment() {
                if (selectedAppointmentId) {
                    alert("Duplicate appointment " + selectedAppointmentId);
                }
                hideContextMenu();
            }

            // Action: Cancel Appointment
            function cancelAppointment() {
                if (
                    selectedAppointmentId &&
                    confirm("Are you sure you want to cancel this appointment?")
                ) {
                    // Implement actual cancellation logic via API call here
                    alert("Cancel appointment " + selectedAppointmentId);
                }
                hideContextMenu();
            }

            // Action: Go to Billing Page (integrated)
            function goToBilling() {
                if (selectedAppointmentId) {
                    // Fetch client ID associated with the appointment to redirect to integrated billing
                    fetch(
                        `/api/unaki/get-appointment-client/${selectedAppointmentId}`,
                    )
                        .then((response) => response.json())
                        .then((data) => {
                            if (data.success && data.client_id) {
                                // Redirect to integrated billing page with client ID
                                window.open(
                                    `{{ url_for('integrated_billing') }}?client_id=${data.client_id}`,
                                    "_blank",
                                );
                            } else {
                                alert(
                                    "Could not retrieve client information for this appointment.",
                                );
                            }
                        })
                        .catch((error) => {
                            console.error("Error fetching client data:", error);
                            alert(
                                "An error occurred while fetching client data.",
                            );
                        });
                }
                hideContextMenu();
            }

            // ==========================================
            // TIME AND DATE FUNCTIONS
            // ==========================================

            // Update the current time line indicator on the schedule
            function updateCurrentTimeLine() {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                // Only display the time line if it's within business hours (9 AM to 10 PM)
                if (currentHour >= 9 && currentHour < 22) {
                    const timeLine = document.getElementById("currentTimeLine");
                    const timeLabel =
                        document.getElementById("currentTimeLabel");

                    const hoursSince9AM = currentHour - 9;
                    const minuteOffset = currentMinute / 60;
                    const leftPosition = (hoursSince9AM + minuteOffset) * 140; // Position based on time

                    const timeStr = now.toLocaleTimeString("en-US", {
                        hour: "2-digit",
                        minute: "2-digit",
                        hour12: true, // Use 12-hour format
                    });

                    timeLabel.textContent = timeStr; // Update time label
                    timeLine.style.left = leftPosition + "px"; // Set horizontal position
                    timeLine.style.display = "block"; // Make the time line visible
                } else {
                    // Hide time line if outside business hours
                    document.getElementById("currentTimeLine").style.display = "none";
                }
            }

            // Helper function to format time for display (e.g., from "09:00" to "9:00 AM")
            function formatTime(timeStr) {
                if (!timeStr) return "";
                const [hours, minutes] = timeStr.split(':').map(Number);
                const period = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 === 0 ? 12 : hours % 12;
                return `${displayHours}:${String(minutes).padStart(2, '0')} ${period}`;
            }


            // Add JavaScript functions for auto-calculating and updating end times
            document.addEventListener('DOMContentLoaded', function() {
                const serviceSelects = document.querySelectorAll('.service-select');
                serviceSelects.forEach(select => {
                    select.addEventListener('change', function() {
                        updateEndTime(this);
                    });
                });

                // Also add change listeners to start times
                const startTimeInputs = document.querySelectorAll('.start-time');
                startTimeInputs.forEach(input => {
                    input.addEventListener('change', function() {
                        updateAppointmentEndTime(this);
                    });
                });
            });

            // Calculate edit modal end time based on service duration and start time
            function calculateEditEndTime() {
                const serviceSelect = document.getElementById('editServiceSelect');
                const startTimeInput = document.getElementById('editStartTime');
                const endTimeInput = document.getElementById('editEndTime');

                if (!serviceSelect || !startTimeInput || !endTimeInput) {
                    return;
                }

                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                const duration = parseInt(selectedOption.getAttribute('data-duration')) || 60;
                const startTime = startTimeInput.value;

                if (startTime) {
                    const endTime = calculateEndTimeFromStart(startTime, duration);
                    endTimeInput.value = endTime;
                }
            }

            // Update end time for appointment cards within the multi-book modal
            function updateAppointmentEndTime(startTimeElement) {
                const appointmentCard = startTimeElement.closest('.appointment-card');
                if (!appointmentCard) return;

                const serviceSelect = appointmentCard.querySelector('.service-select');
                const endTimeInput = appointmentCard.querySelector('.end-time');

                if (!serviceSelect || !endTimeInput) return;

                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                const duration = parseInt(selectedOption.getAttribute('data-duration')) || 60;
                const startTime = startTimeElement.value;

                if (startTime && duration) {
                    const endTime = calculateEndTimeFromStart(startTime, duration);
                    endTimeInput.value = endTime;
                }
            }

            // Helper function to calculate end time from start time and duration
            function calculateEndTimeFromStart(startTime, durationMinutes) {
                if (!startTime) return '';

                const [hours, minutes] = startTime.split(':').map(Number);
                const startDate = new Date();
                startDate.setHours(hours, minutes, 0, 0);

                const endDate = new Date(startDate.getTime() + durationMinutes * 60000);

                const endHours = String(endDate.getHours()).padStart(2, '0');
                const endMinutes = String(endDate.getMinutes()).padStart(2, '0');

                return `${endHours}:${endMinutes}`;
            }

            // Update end time when a service is selected in the multi-book modal
            function updateEndTime(serviceSelect) {
                const card = serviceSelect.closest('.appointment-card');
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                const duration = parseInt(selectedOption.getAttribute('data-duration')) || 60;
                const startTimeInput = card.querySelector('.start-time');
                const endTimeInput = card.querySelector('.end-time');

                if (startTimeInput && endTimeInput) {
                    const startTime = startTimeInput.value || '09:00';
                    const endTime = calculateEndTimeFromStart(startTime, duration);
                    endTimeInput.value = endTime;
                }
            }

            // Update edit modal end time when service or start time changes
            document.addEventListener('DOMContentLoaded', function() {
                const editServiceSelect = document.getElementById('editServiceSelect');
                const editStartTime = document.getElementById('editStartTime');

                if (editServiceSelect) {
                    editServiceSelect.addEventListener('change', calculateEditEndTime);
                }

                if (editStartTime) {
                    editStartTime.addEventListener('change', calculateEditEndTime);
                }
            });


            // ==========================================
            // CONTEXT MENU INITIALIZATION
            // ==========================================

            // Initialize context menu when the DOM is fully loaded
            document.addEventListener('DOMContentLoaded', function() {
                // Wait a moment to ensure appointmentContextMenu is loaded
                setTimeout(function() {
                    if (window.appointmentContextMenu) {
                        console.log('âœ… AppointmentContextMenu is available');
                        // Reinitialize the context menu for any existing appointments
                        if (typeof window.appointmentContextMenu.reinitializeForAppointments === 'function') {
                            window.appointmentContextMenu.reinitializeForAppointments();
                        }
                    } else {
                        console.error('âŒ AppointmentContextMenu not loaded or available');
                    }
                }, 100); // Small delay
            });

        </script>
    </body>
</html>