<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Unaki Appointment Booking - Premium Timeline</title>

        <!-- External Resources -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />

        <!-- Select2 CSS for searchable dropdowns -->
        <link
            href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
            rel="stylesheet"
        />

        <!-- jQuery MUST be loaded first -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- Select2 JS -->
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <!-- Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Context Menu -->
        <script src="{{ url_for('static', filename='js/appointment_context_menu.js') }}"></script>

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary-color: #4f46e5;
                --primary-hover: #4338ca;
                --success-color: #10b981;
                --danger-color: #ef4444;
                --warning-color: #f59e0b;
                --info-color: #06b6d4;
                --border-color: #e5e7eb;
                --hover-bg: #f9fafb;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                overflow: hidden;
                color: #1f2937;
            }

            /* ==================== TOP NAVIGATION ==================== */
            .calendar-top-nav {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 64px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 24px;
                z-index: 100;
                box-shadow: var(--shadow-md);
            }

            .calendar-logo {
                font-size: 20px;
                font-weight: 700;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .calendar-logo i {
                -webkit-text-fill-color: #667eea;
            }

            .calendar-date-nav {
                display: flex;
                align-items: center;
                gap: 16px;
                background: white;
                padding: 8px 12px;
                border-radius: 12px;
                box-shadow: var(--shadow-sm);
                border: 1px solid var(--border-color);
            }

            .date-nav-btn {
                width: 36px;
                height: 36px;
                border-radius: 8px;
                border: none;
                background: var(--hover-bg);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
                color: #6b7280;
            }

            .date-nav-btn:hover {
                background: var(--primary-color);
                color: white;
                transform: scale(1.05);
            }

            .current-date-display {
                font-size: 15px;
                font-weight: 600;
                color: #1f2937;
                min-width: 220px;
                text-align: center;
            }

            .date-today-btn {
                padding: 6px 12px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                background: white;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                color: #6b7280;
            }

            .date-today-btn:hover {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .calendar-actions {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .action-btn {
                padding: 10px 18px;
                border-radius: 10px;
                border: none;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .action-btn-primary {
                background: var(--primary-color);
                color: white;
                box-shadow: var(--shadow-md);
            }

            .action-btn-primary:hover {
                background: var(--primary-hover);
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .action-icon {
                width: 40px;
                height: 40px;
                border-radius: 10px;
                border: 1px solid var(--border-color);
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
                color: #6b7280;
            }

            .action-icon:hover {
                background: var(--hover-bg);
                color: var(--primary-color);
                transform: scale(1.05);
            }

            /* ==================== MAIN LAYOUT ==================== */
            .calendar-main-layout {
                position: fixed;
                top: 64px;
                left: 0;
                right: 0;
                bottom: 0;
                display: flex;
                background: white;
                overflow: visible;
                margin: 12px;
                border-radius: 16px;
                box-shadow: var(--shadow-xl);
            }

            .calendar-main-layout::before {
                content: "";
                position: absolute;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 0;
                background-image: repeating-linear-gradient(
                    to bottom,
                    transparent 0,
                    transparent 109px,
                    rgba(79, 70, 229, 0.08) 109px,
                    rgba(79, 70, 229, 0.08) 110px
                );
                pointer-events: none;
                z-index: 1;
            }

            /* ==================== STAFF SIDEBAR ==================== */
            .staff-sidebar {
                width: 280px;
                flex-shrink: 0;
                background: #ffffff;
                border-right: 2px solid var(--border-color);
                overflow-y: auto;
                position: relative;
                z-index: 2;
                scrollbar-gutter: stable;
            }

            .staff-sidebar-header {
                height: 60px;
                background: white;
                border-bottom: 2px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 20px;
                font-weight: 700;
                font-size: 14px;
                color: #1f2937;
                position: sticky;
                top: 0;
                z-index: 10;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .staff-count {
                background: var(--primary-color);
                color: white;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }

            .staff-row {
                height: 110px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                padding: 16px 20px;
                gap: 14px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .staff-row:nth-of-type(odd) {
                background: #fafbfc;
            }
            .staff-row:nth-of-type(even) {
                background: #ffffff;
            }

            .staff-row:hover {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .staff-row:hover .staff-avatar {
                transform: scale(1.1);
                box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
            }

            .staff-row:hover .staff-name,
            .staff-row:hover .staff-role,
            .staff-row:hover .staff-status {
                color: white;
            }

            .staff-avatar {
                width: 56px;
                height: 56px;
                border-radius: 14px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 700;
                font-size: 20px;
                flex-shrink: 0;
                transition: all 0.3s;
                box-shadow: var(--shadow-md);
            }

            .staff-info {
                flex: 1;
                min-width: 0;
            }

            .staff-name {
                font-size: 15px;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .staff-role {
                font-size: 13px;
                color: #6b7280;
                margin-bottom: 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .staff-status {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-size: 11px;
                font-weight: 500;
                color: var(--success-color);
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--success-color);
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            /* ==================== TIMELINE PANEL ==================== */
            .timeline-panel {
                flex: 1;
                overflow: auto;
                background: #ffffff;
                position: relative;
                z-index: 2;
                -webkit-overflow-scrolling: touch;
                scrollbar-gutter: stable;
            }

            .timeline-header {
                height: 60px;
                background: white;
                border-bottom: 2px solid var(--border-color);
                display: flex;
                position: sticky;
                top: 0;
                left: 0;
                z-index: 9;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
                overflow: hidden;
            }

            .timeline-header-inner {
                display: flex;
                transition: transform 0.05s linear;
            }

            .timeline-hour {
                min-width: 140px;
                flex-shrink: 0;
                border-right: 1px solid #e5e7eb;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                font-size: 13px;
                color: #1f2937;
                transition: all 0.2s;
            }

            .timeline-hour:hover {
                background: var(--hover-bg);
            }

            .hour-label {
                font-size: 14px;
                font-weight: 700;
            }

            .hour-period {
                font-size: 11px;
                color: #9ca3af;
                margin-top: 2px;
            }

            .timeline-grid {
                position: relative;
                min-width: max-content;
                min-height: 100%;
            }

            .timeline-row {
                height: 110px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                position: relative;
                transition: background 0.2s;
            }

            .timeline-row:nth-child(odd) {
                background: #fafbfc;
            }
            .timeline-row:nth-child(even) {
                background: #ffffff;
            }
            .timeline-row:hover {
                background: rgba(79, 70, 229, 0.02);
            }

            .timeline-hour-slot {
                min-width: 140px;
                flex-shrink: 0;
                position: relative;
                background: transparent;
                border-right: 1px solid #e5e7eb;
                cursor: pointer;
                transition: all 0.2s;
            }

            .timeline-hour-slot:hover {
                background: linear-gradient(
                    to bottom,
                    rgba(79, 70, 229, 0.03),
                    rgba(79, 70, 229, 0.05)
                );
            }

            .timeline-hour-slot:hover::after {
                content: "+";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 24px;
                color: var(--primary-color);
                font-weight: 600;
                opacity: 0.3;
            }

            .interval-marker {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 1px;
                background: #f3f4f6;
            }

            .interval-15 {
                left: 25%;
            }
            .interval-30 {
                left: 50%;
                background: #e5e7eb;
            }
            .interval-45 {
                left: 75%;
            }

            /* ==================== APPOINTMENT BLOCKS ==================== */
            .appointment-block {
                position: absolute;
                top: 8px;
                bottom: 8px;
                border-radius: 10px;
                border-left: 4px solid;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                padding: 12px;
                cursor: move;
                transition: all 0.2s;
                overflow: hidden;
                z-index: 5;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                user-select: none;
            }

            .appointment-block:hover {
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
                transform: translateY(-2px) scale(1.02);
                z-index: 10;
            }

            .appointment-block.dragging {
                opacity: 0.6;
                cursor: grabbing;
                z-index: 100;
            }

            .appointment-block.paid {
                background: #ffe4e6 !important;
                border-left-color: #f87171 !important;
            }

            .appointment-block.paid .appointment-client {
                color: #991b1b;
            }

            .appointment-block.paid .appointment-service {
                color: #b91c1c;
            }

            .appointment-header {
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                margin-bottom: 8px;
            }

            .appointment-client {
                font-size: 14px;
                font-weight: 700;
                color: #1f2937;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex: 1;
            }

            .appointment-status {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--success-color);
                flex-shrink: 0;
                margin-left: 8px;
            }

            .appointment-service {
                font-size: 12px;
                color: #6b7280;
                margin-bottom: 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .appointment-footer {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-top: auto;
            }

            .appointment-time {
                font-size: 11px;
                font-weight: 600;
                color: #9ca3af;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .appointment-duration {
                font-size: 10px;
                background: rgba(0, 0, 0, 0.05);
                padding: 2px 8px;
                border-radius: 12px;
                font-weight: 600;
            }

            /* Service Colors */
            .service-massage {
                border-left-color: #3b82f6;
                background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            }
            .service-facial {
                border-left-color: #a855f7;
                background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            }
            .service-manicure {
                border-left-color: #f43f5e;
                background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
            }
            .service-pedicure {
                border-left-color: #78350f;
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            }
            .service-haircut {
                border-left-color: #22c55e;
                background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            }
            .service-waxing {
                border-left-color: #f97316;
                background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);
            }
            .service-default {
                border-left-color: #6b7280;
                background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            }

            /* ==================== SHIFT OVERLAYS ==================== */
            .shift-overlay {
                position: absolute;
                top: 0;
                bottom: 0;
                pointer-events: none;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1;
                border-radius: 6px;
                opacity: 0.75;
            }

            .shift-overlay-break {
                background: linear-gradient(
                    135deg,
                    rgba(245, 158, 11, 0.3),
                    rgba(251, 191, 36, 0.3)
                );
                border: 1px dashed rgba(245, 158, 11, 0.5);
            }

            .shift-overlay-out-of-office {
                background: linear-gradient(
                    135deg,
                    rgba(239, 68, 68, 0.4),
                    rgba(252, 165, 165, 0.4)
                );
                border: 1px dashed rgba(239, 68, 68, 0.6);
            }

            .shift-overlay-off-duty {
                background: linear-gradient(
                    135deg,
                    rgba(107, 114, 128, 0.2),
                    rgba(156, 163, 175, 0.2)
                );
                border: 1px dashed rgba(107, 114, 128, 0.4);
            }

            .shift-overlay-holiday {
                background: rgba(99, 102, 241, 0.25);
                border: 1px dashed rgba(99, 102, 241, 0.5);
            }

            .overlay-label {
                font-size: 11px;
                font-weight: 600;
                color: rgba(0, 0, 0, 0.7);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            }

            /* ==================== CURRENT TIME LINE ==================== */
            .current-time-line {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 2px;
                background: var(--danger-color);
                z-index: 20;
                pointer-events: none;
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            }

            .current-time-line::before {
                content: "";
                position: absolute;
                top: -6px;
                left: -6px;
                width: 14px;
                height: 14px;
                background: var(--danger-color);
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
                animation: currentTimePulse 2s infinite;
            }

            .current-time-label {
                position: absolute;
                top: 16px;
                left: 6px;
                background: var(--danger-color);
                color: white;
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
                box-shadow: var(--shadow-md);
            }

            @keyframes currentTimePulse {
                0%,
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.2);
                    opacity: 0.8;
                }
            }

            /* ==================== CONTEXT MENU ==================== */
            .context-menu {
                position: fixed;
                background: white;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                box-shadow: var(--shadow-xl);
                padding: 8px;
                min-width: 220px;
                z-index: 1000;
                display: none;
                animation: contextMenuFadeIn 0.2s ease;
            }

            @keyframes contextMenuFadeIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .context-menu.show {
                display: block;
            }

            .context-menu-item {
                padding: 12px 16px;
                cursor: pointer;
                font-size: 14px;
                color: #1f2937;
                display: flex;
                align-items: center;
                gap: 12px;
                transition: all 0.2s;
                border-radius: 8px;
                font-weight: 500;
            }

            .context-menu-item:hover {
                background: var(--hover-bg);
                color: var(--primary-color);
                transform: translateX(4px);
            }

            .context-menu-item i {
                width: 18px;
                text-align: center;
            }

            .context-menu-divider {
                height: 1px;
                background: var(--border-color);
                margin: 8px 0;
            }

            .context-menu-item.danger:hover {
                background: #fee;
                color: var(--danger-color);
            }

            /* ==================== MODAL STYLES ==================== */
            /* Booking Modal - Base Level */
            #multiBookModal {
                z-index: 1055 !important;
            }
            .modal-backdrop:nth-of-type(1) {
                z-index: 1050 !important;
            }

            /* Quick Add Client Modal - Higher Level */
            #quickAddClientModal {
                z-index: 1065 !important;
            }
            .modal-backdrop:nth-of-type(2) {
                z-index: 1060 !important;
            }

            /* Ensure modal content is above backdrop */
            .modal.show {
                z-index: 1055;
            }
            .modal-backdrop.show {
                z-index: 1050;
            }

            /* When second modal opens */
            .modal.show ~ .modal.show {
                z-index: 1065 !important;
            }

            .modal-dialog {
                max-height: 90vh;
            }

            .modal-dialog.modal-xl {
                max-width: 1200px;
            }

            .modal-body {
                max-height: calc(90vh - 120px);
                overflow-y: auto;
            }

            #appointmentsContainer {
                /* Container for appointment cards - no height restrictions */
                display: flex;
                flex-direction: column;
                gap: 0;
            }

            .appointment-card {
                background: white;
                border: 2px solid transparent;
                border-radius: 10px;
                padding: 16px;
                margin-bottom: 12px;
                transition: all 0.2s;
                position: relative;
            }

            .appointment-card:hover {
                border-color: var(--primary-color);
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
            }

            .appointment-card.duplicate {
                border-color: var(--warning-color);
                background: #fffbeb;
            }

            .appointment-number {
                position: absolute;
                top: -8px;
                left: 16px;
                background: var(--primary-color);
                color: white;
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }

            .remove-appointment {
                position: absolute;
                top: 8px;
                right: 8px;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                border: none;
                background: var(--danger-color);
                color: white;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .remove-appointment:hover {
                background: #dc2626;
                transform: scale(1.1);
            }

            .add-appointment-btn {
                width: 100%;
                padding: 12px;
                border: 2px dashed var(--primary-color);
                background: transparent;
                color: var(--primary-color);
                border-radius: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }

            .add-appointment-btn:hover {
                background: var(--primary-color);
                color: white;
                transform: scale(1.02);
            }

            /* ==================== VALIDATION ==================== */
            .is-invalid {
                border-color: #dc3545 !important;
                background-color: #fff5f5 !important;
            }

            .is-valid {
                border-color: #28a745 !important;
                background-color: #f0fff4 !important;
            }

            .validation-error {
                color: #dc3545;
                font-size: 0.875rem;
                margin-top: 0.25rem;
            }

            /* ==================== UTILITY STYLES ==================== */
            .tooltip-custom {
                position: fixed;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 500;
                z-index: 10000;
                pointer-events: none;
                display: none;
                white-space: nowrap;
                box-shadow: var(--shadow-lg);
            }

            .tooltip-custom.show {
                display: block;
                animation: tooltipFadeIn 0.2s ease;
            }

            @keyframes tooltipFadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.95);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 50;
                backdrop-filter: blur(5px);
            }

            .loading-overlay.show {
                display: flex;
            }

            .spinner {
                width: 50px;
                height: 50px;
                border: 4px solid #e5e7eb;
                border-top-color: var(--primary-color);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            @keyframes shake {
                0%,
                100% {
                    transform: translateX(0);
                }
                10%,
                30%,
                50%,
                70%,
                90% {
                    transform: translateX(-5px);
                }
                20%,
                40%,
                60%,
                80% {
                    transform: translateX(5px);
                }
            }

            /* Enhanced validation states */
            .form-control.is-valid,
            .form-select.is-valid {
                border-color: #10b981 !important;
                background-image: none;
            }

            .form-control.is-invalid,
            .form-select.is-invalid {
                border-color: #ef4444 !important;
                background-image: none;
            }

            .validation-icon {
                transition: all 0.3s ease;
            }

            /* ==================== SCROLLBAR ==================== */
            ::-webkit-scrollbar {
                width: 14px;
                height: 14px;
            }

            ::-webkit-scrollbar-track {
                background: #f3f4f6;
                border-radius: 10px;
                border: 2px solid #ffffff;
            }

            ::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #9ca3af 0%, #6b7280 100%);
                border-radius: 10px;
                border: 3px solid #f3f4f6;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);
            }

            /* ==================== RESPONSIVE ==================== */
            @media (max-width: 1024px) {
                .staff-sidebar {
                    width: 240px;
                }
                .timeline-hour,
                .timeline-hour-slot {
                    min-width: 110px;
                }
            }

            @media (max-width: 768px) {
                .calendar-main-layout {
                    margin: 8px;
                    border-radius: 12px;
                }
                .staff-sidebar {
                    width: 200px;
                }
                .timeline-hour,
                .timeline-hour-slot {
                    min-width: 90px;
                }
                .staff-row {
                    height: 90px;
                    padding: 12px;
                }
                .staff-avatar {
                    width: 48px;
                    height: 48px;
                    font-size: 18px;
                }
                .calendar-logo span {
                    display: none;
                }
                .current-date-display {
                    min-width: 150px;
                    font-size: 13px;
                }
                ::-webkit-scrollbar {
                    width: 8px;
                    height: 8px;
                }
            }
        </style>
    </head>
    <body>
        <!-- Tooltip -->
        <div class="tooltip-custom" id="tooltip"></div>

        <div class="calendar-wrapper">
            <!-- Top Navigation -->
            <div class="calendar-top-nav">
                <div class="calendar-logo">
                    <i class="fas fa-calendar-check"></i>
                    <span>Unaki Booking</span>
                </div>

                <div class="calendar-date-nav">
                    <button
                        class="date-nav-btn"
                        onclick="navigateDate(-1)"
                        data-tooltip="Previous Day"
                    >
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button
                        class="date-today-btn"
                        onclick="navigateToToday()"
                        data-tooltip="Go to Today"
                    >
                        Today
                    </button>
                    <div class="current-date-display" id="currentDateDisplay">
                        {{ today_date }}
                    </div>
                    <button
                        class="date-nav-btn"
                        onclick="navigateDate(1)"
                        data-tooltip="Next Day"
                    >
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div style="display: flex; align-items: center; gap: 16px">
                    <!-- Stats -->
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 8px 12px;
                            background: white;
                            border-radius: 10px;
                            border: 1px solid var(--border-color);
                        "
                    >
                        <i
                            class="fas fa-calendar-check"
                            style="color: var(--primary-color)"
                        ></i>
                        <div>
                            <div
                                style="
                                    font-size: 16px;
                                    font-weight: 700;
                                    color: #1f2937;
                                "
                                id="totalBookings"
                            >
                                0
                            </div>
                            <div style="font-size: 10px; color: #6b7280">
                                Total
                            </div>
                        </div>
                    </div>
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 8px 12px;
                            background: white;
                            border-radius: 10px;
                            border: 1px solid var(--border-color);
                        "
                    >
                        <i
                            class="fas fa-check-circle"
                            style="color: var(--success-color)"
                        ></i>
                        <div>
                            <div
                                style="
                                    font-size: 16px;
                                    font-weight: 700;
                                    color: #1f2937;
                                "
                                id="completedBookings"
                            >
                                0
                            </div>
                            <div style="font-size: 10px; color: #6b7280">
                                Done
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="calendar-actions">
                        <button
                            class="action-btn action-btn-primary"
                            onclick="openMultiBookModal()"
                        >
                            <i class="fas fa-plus-circle"></i>
                            New Appointment
                        </button>
                        <a
                            href="{{ url_for('shift_scheduler.shift_scheduler') }}"
                            class="action-btn"
                            style="
                                background: var(--warning-color);
                                color: white;
                                text-decoration: none;
                            "
                        >
                            <i class="fas fa-calendar-check"></i>
                            Shift Scheduler
                        </a>
                        <button class="action-icon" onclick="refreshSchedule()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <a
                            href="{{ url_for('dashboard') }}"
                            class="action-btn"
                            style="
                                background: var(--info-color);
                                color: white;
                                text-decoration: none;
                            "
                        >
                            <i class="fas fa-home"></i>
                            Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Layout -->
            <div class="calendar-main-layout">
                <!-- Staff Sidebar -->
                <div class="staff-sidebar">
                    <div class="staff-sidebar-header">
                        <span>Staff Members</span>
                        <span class="staff-count"
                            >{{ staff_members|length if staff_members else 0
                            }}</span
                        >
                    </div>

                    <div class="staff-list">
                        {% if staff_members %} {% for staff in staff_members %}
                        <div
                            class="staff-row staff-row-{{ loop.index }}"
                            data-staff-id="{{ staff.id }}"
                        >
                            <div class="staff-avatar">
                                {{ (staff.first_name[:1] +
                                staff.last_name[:1]).upper() if staff.first_name
                                and staff.last_name else
                                staff.username[:2].upper() }}
                            </div>
                            <div class="staff-info">
                                <div class="staff-name">
                                    {{ staff.first_name }} {{ staff.last_name if
                                    staff.last_name else '' }}
                                </div>
                                <div class="staff-role">
                                    {{ staff.role or 'Therapist' }}
                                </div>
                                <div class="staff-status">
                                    <span class="status-dot"></span>
                                    Available
                                </div>
                            </div>
                        </div>
                        {% endfor %} {% endif %}
                    </div>
                </div>

                <!-- Timeline Panel -->
                <div class="timeline-panel">
                    <div class="timeline-header">
                        <div
                            class="timeline-header-inner"
                            id="timelineHeaderInner"
                        >
                            {% for hour in range(9, 22) %}
                            <div class="timeline-hour">
                                <span class="hour-label"
                                    >{{ '%d:00' % hour if hour < 12 else
                                    ('12:00' if hour == 12 else '%d:00' % (hour
                                    - 12)) }}</span
                                >
                                <span class="hour-period"
                                    >{{ 'AM' if hour < 12 else 'PM' }}</span
                                >
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="timeline-grid" id="timelineGrid">
                        {% if staff_members %} {% for staff in staff_members %}
                        <div
                            class="timeline-row"
                            data-staff-id="{{ staff.id }}"
                        >
                            {% for hour in range(9, 22) %}
                            <div
                                class="timeline-hour-slot"
                                data-hour="{{ hour }}"
                                data-staff-id="{{ staff.id }}"
                                onclick="handleSlotClick(event, {{ staff.id }}, {{ hour }}, 0)"
                            >
                                <div class="interval-marker interval-15"></div>
                                <div class="interval-marker interval-30"></div>
                                <div class="interval-marker interval-45"></div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %} {% endif %}

                        <div
                            class="current-time-line"
                            id="currentTimeLine"
                            style="display: none"
                        >
                            <div
                                class="current-time-label"
                                id="currentTimeLabel"
                            >
                                Now
                            </div>
                        </div>
                    </div>

                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context Menu -->
        <div class="context-menu" id="contextMenu">
            <div class="context-menu-item" onclick="viewAppointmentDetails()">
                <i class="fas fa-eye"></i>View Details
            </div>
            <div class="context-menu-item" onclick="editAppointment()">
                <i class="fas fa-edit"></i>Edit Appointment
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item danger" onclick="cancelAppointment()">
                <i class="fas fa-times-circle"></i>Cancel Appointment
            </div>
        </div>

        <!-- Quick Add Client Modal -->
        <div class="modal fade" id="quickAddClientModal" tabindex="-1" aria-labelledby="quickAddClientModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="quickAddClientModalLabel">Quick Add Client</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="quickAddClientForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="quickFirstName" class="form-label">First Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="quickFirstName" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="quickLastName" class="form-label">Last Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="quickLastName" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="quickPhone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                                <input type="tel" class="form-control" id="quickPhone" pattern="[0-9]{10,}" required>
                                <div class="invalid-feedback">Please enter a valid 10-digit phone number.</div>
                            </div>
                            <div class="mb-3">
                                <label for="quickEmail" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="quickEmail">
                            </div>
                            <div class="mb-3">
                                <label for="quickGender" class="form-label">Gender <span class="text-danger">*</span></label>
                                <select id="quickGender" class="form-select" required>
                                    <option value="">Select gender...</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveQuickClientBtn" onclick="saveQuickClient()">Add Client</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Appointment Modal -->
        <div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editAppointmentModalLabel">Edit Appointment</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editAppointmentForm">
                            <input type="hidden" id="editAppointmentId">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editClientName" class="form-label">Client Name</label>
                                    <input type="text" class="form-control" id="editClientName" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label for="editAppointmentDate" class="form-label">Date</label>
                                    <input type="date" class="form-control" id="editAppointmentDate">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editServiceSelect" class="form-label">Service</label>
                                    <select id="editServiceSelect" class="form-select select2-dropdown" required>
                                        <option value="">Select service...</option>
                                        {% if services %}
                                            {% for service in services %}
                                            <option value="{{ service.id }}" data-duration="{{ service.duration or 60 }}" data-price="{{ service.price }}">
                                                {{ service.name }} ({{ service.duration or 60 }} min - {{ "%.2f"|format(service.price) }})
                                            </option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="editStaffSelect" class="form-label">Staff Member</label>
                                    <select id="editStaffSelect" class="form-select select2-dropdown" required>
                                        <option value="">Select staff member...</option>
                                        {% if staff_members %}
                                            {% for staff in staff_members %}
                                            <option value="{{ staff.id }}">{{ staff.first_name }} {{ staff.last_name if staff.last_name else '' }}</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="editStartTime" class="form-label">Start Time</label>
                                    <input type="time" class="form-control" id="editStartTime" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="editEndTime" class="form-label">End Time</label>
                                    <input type="time" class="form-control" id="editEndTime" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label for="editStatus" class="form-label">Status</label>
                                    <select id="editStatus" class="form-select">
                                        <option value="scheduled">Scheduled</option>
                                        <option value="confirmed">Confirmed</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                        <option value="noshow">No Show</option>
                                    </select>
                                </div>
                            </div>
                             <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="editPaymentStatus" class="form-label">Payment Status</label>
                                    <select id="editPaymentStatus" class="form-select">
                                        <option value="pending">Pending</option>
                                        <option value="paid">Paid</option>
                                        <option value="failed">Failed</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editNotes" class="form-label">Notes</label>
                                <textarea class="form-control" id="editNotes" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveEditedAppointment()">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Multi-Book Modal -->
        <div
            class="modal fade"
            id="multiBookModal"
            data-bs-backdrop="static"
            data-bs-keyboard="false"
            tabindex="-1"
            aria-labelledby="multiBookModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="multiBookModalLabel">New Appointments</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row mb-3 align-items-end">
                            <div class="col-md-4">
                                <label for="multiClientSelect" class="form-label">Select Client</label>
                                <select id="multiClientSelect" class="form-select select2-dropdown" required style="border-radius: 10px; padding: 12px; border: 2px solid #e2e8f0; transition: all 0.3s;">
                                    <option value="">Choose a client...</option>
                                    {% for client in clients %}
                                    <option value="{{ client.id }}" data-phone="{{ client.phone }}" data-email="{{ client.email or '' }}">
                                        {{ client.first_name }} {{ client.last_name }} - {{ client.phone }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="validation-icon ms-2" style="display: none;">
                                    <i class="fas fa-check-circle text-success"></i>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-outline-primary w-100" onclick="openQuickAddClient()">
                                    <i class="fas fa-plus me-1"></i>New Client
                                </button>
                            </div>
                            <div class="col-md-6">
                                <label for="multiNotes" class="form-label">Notes</label>
                                <input type="text" id="multiNotes" class="form-control" placeholder="e.g., Client is running late...">
                            </div>
                        </div>

                        <div id="appointmentsContainer">
                            <!-- Appointment cards will be added here -->
                        </div>

                        <button type="button" class="add-appointment-btn mt-3" onclick="addAppointment()">
                            <i class="fas fa-plus-circle"></i> Add Another Appointment
                        </button>

                        <!-- Summary Section -->
                        <div id="bookingSummary" class="mt-4 p-3 border rounded" style="background-color: #f9fafb; border-color: var(--border-color); display: none;">
                            <h6 class="mb-3 fw-semibold">Booking Summary</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <p class="mb-0">Total Duration: <strong id="multiTotalDuration">0 min</strong></p>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-0">Total Price: <strong id="multiTotalPrice">0.00</strong></p>
                                </div>
                                <div class="col-md-4">
                                    <p class="mb-0">Staff Members: <strong id="multiStaffCount">0</strong></p>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-secondary" id="bookAllAppointments" onclick="submitMultiAppointment()" disabled>
                            <i class="fas fa-calendar-check me-2"></i>Book All Appointments
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ==========================================
            // GLOBAL VARIABLES & STATE
            // ==========================================
            let selectedAppointmentId = null;
            const currentDate = "{{ today }}";
            let bookingsData = [];
            let appointmentCounter = 0; // Initialize counter to 0

            // ==========================================
            // TIME FORMAT CONVERSION - 12-HOUR AM/PM ONLY
            // ==========================================

            // Convert 24-hour time to 12-hour AM/PM format
            function convertTo12Hour(time24) {
                if (!time24) return '';

                const [hours, minutes] = time24.split(':');
                let hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';

                hour = hour % 12 || 12;

                return `${hour}:${minutes} ${ampm}`;
            }

            // Convert 12-hour AM/PM time to 24-hour format
            function convertTo24Hour(time12, ampm) {
                let [hours, minutes] = time12.split(':');
                hours = parseInt(hours);

                if (ampm === 'PM' && hours !== 12) {
                    hours += 12;
                } else if (ampm === 'AM' && hours === 12) {
                    hours = 0;
                }

                return `${hours.toString().padStart(2, '0')}:${minutes}`;
            }

            // Validate time input (HH:MM format with proper ranges)
            function validateTimeInput(timeStr, ampm) {
                // Regex: H:MM or HH:MM format
                const timeRegex = /^([0-9]|0[0-9]|1[0-2]):([0-5][0-9])$/;

                if (!timeRegex.test(timeStr)) {
                    return { valid: false, error: 'Invalid time format. Use HH:MM (e.g., 2:30)' };
                }

                const [hours, minutes] = timeStr.split(':').map(Number);

                // Validate hours (1-12 for 12-hour format)
                if (hours < 1 || hours > 12) {
                    return { valid: false, error: 'Hours must be between 1 and 12' };
                }

                // Validate minutes (0-59)
                if (minutes < 0 || minutes > 59) {
                    return { valid: false, error: 'Minutes must be between 0 and 59' };
                }

                // Validate AM/PM
                if (ampm !== 'AM' && ampm !== 'PM') {
                    return { valid: false, error: 'Please specify AM or PM' };
                }

                return { valid: true };
            }

            // Populate time dropdown with 15-minute intervals
            function populateTimeDropdown(selectElement, selectedTime = '09:00') {
                const times = [];

                // Generate times from 9:00 AM to 9:00 PM
                for (let hour = 9; hour <= 21; hour++) {
                    for (let minute = 0; minute < 60; minute += 15) {
                        const time24 = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        const time12 = convertTo12Hour(time24);
                        times.push({ value: time24, label: time12 });
                    }
                }

                // Clear existing options except the first one
                selectElement.innerHTML = '<option value="">Select time...</option>';

                // Add time options
                times.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time.value;
                    option.textContent = time.label;
                    if (time.value === selectedTime) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                });
            }

            // Helper function to update the hidden 24-hour time input based on manual inputs
            function updateHiddenTimeInput(hourInput, minuteInput, periodSelect, hiddenInput) {
                const hour = parseInt(hourInput.value) || 9;
                const minute = parseInt(minuteInput.value) || 0;
                const period = periodSelect.value;

                // Convert to 24-hour format
                let hour24 = hour;
                if (period === 'PM' && hour !== 12) {
                    hour24 = hour + 12;
                } else if (period === 'AM' && hour === 12) {
                    hour24 = 0;
                }

                // Format as HH:MM
                const timeString = `${String(hour24).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                hiddenInput.value = timeString;

                console.log(`Time updated: ${hour}:${String(minute).padStart(2, '0')} ${period}  ${timeString}`);
            }

            // Handle start time selection change
            function handleStartTimeChange(selectElement) {
                const card = selectElement.closest('[data-appointment-index]');
                if (!card) return;

                const index = parseInt(card.dataset.appointmentIndex);
                const hiddenInput = card.querySelector('.start-time-24h');

                if (hiddenInput && selectElement.value) {
                    hiddenInput.value = selectElement.value;
                    updateAppointmentEndTime(card);
                    checkConflictsRealtime(index);
                    updateSummary();
                    updateSubmitButton();

                    // Show validation icon
                    const validationIcon = selectElement.closest('.col-md-4').querySelector('.validation-icon');
                    if (validationIcon) validationIcon.style.display = 'inline-block';
                    selectElement.style.borderColor = '#10b981';
                }
            }

            // Handle time selection change (legacy function for compatibility)
            function handleTimeChange(selectElement) {
                handleStartTimeChange(selectElement);
            }

            // ==========================================
            // INITIALIZATION
            // ==========================================
            document.addEventListener("DOMContentLoaded", function() {
                initializeApp();
                setupEventListeners();
                setupTooltips();
                setupScrollSync();
                initializeSearchableDropdowns();

                // Initialize 12-hour time displays on page load
                setTimeout(() => {
                    syncAll12HourDisplays();
                }, 100);
            });

            function initializeApp() {
                loadBookings();
                loadShiftSchedule();
                updateCurrentTimeLine();
                setInterval(updateCurrentTimeLine, 60000);

                // Close context menu on click outside
                document.addEventListener("click", hideContextMenu);

                // Keyboard shortcuts
                document.addEventListener("keydown", function(e) {
                    if (e.key === "n" && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        openMultiBookModal();
                    }
                    if (e.key === "r" && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        refreshSchedule();
                    }
                });

                // Initialize context menu
                setTimeout(() => {
                    if (window.appointmentContextMenu?.reinitializeForAppointments) {
                        window.appointmentContextMenu.reinitializeForAppointments();
                    }
                }, 100);
            }

            // ==========================================
            // EVENT LISTENERS
            // ==========================================
            function setupEventListeners() {
                // Handle Quick Add Client modal z-index on show
                const quickAddModal = document.getElementById('quickAddClientModal');
                if (quickAddModal) {
                    quickAddModal.addEventListener('show.bs.modal', function() {
                        this.style.zIndex = '1065';
                        setTimeout(() => {
                            const backdrops = document.querySelectorAll('.modal-backdrop');
                            if (backdrops.length > 0) {
                                backdrops[backdrops.length - 1].style.zIndex = '1060';
                            }
                        }, 50);
                    });

                    quickAddModal.addEventListener('hidden.bs.modal', function() {
                        const bookingModal = document.getElementById('multiBookModal');
                        if (bookingModal && bookingModal.classList.contains('show')) {
                            bookingModal.style.zIndex = '1055';
                            const backdrop = document.querySelector('.modal-backdrop');
                            if (backdrop) {
                                backdrop.style.zIndex = '1050';
                            }
                        }
                    });
                }

                // Multi-booking form changes
                document.addEventListener("change", function(e) {
                    if (e.target.matches('.service-select, .appointment-date, .staff-select')) {
                        const card = e.target.closest(".appointment-card");
                        if (card) {
                            const index = parseInt(card.dataset.appointmentIndex);
                            calculateEndTime(index);
                            checkConflicts(index);
                            updateSummary();
                            updateSubmitButton();
                        }
                    }
                });

                // Edit modal changes
                const editServiceSelect = document.getElementById('editServiceSelect');
                const editStartTime = document.getElementById('editStartTime');
                if (editServiceSelect) editServiceSelect.addEventListener('change', calculateEditEndTime);
                if (editStartTime) editStartTime.addEventListener('change', calculateEditEndTime);

                // Client selection - handle both native and Select2 events
                const clientSelect = document.getElementById('multiClientSelect');
                if (clientSelect) {
                    // Native change event
                    clientSelect.addEventListener('change', () => {
                        validateClientSelection();
                        loadCustomerExistingAppointments(clientSelect.value);
                        updateSubmitButton();
                    });

                    // Select2 select event
                    $(clientSelect).on('select2:select', function(e) {
                        validateClientSelection();
                        loadCustomerExistingAppointments(this.value);
                        updateSubmitButton();
                    });

                    // Select2 clear event
                    $(clientSelect).on('select2:clear', function(e) {
                        validateClientSelection();
                        loadCustomerExistingAppointments('');
                        updateSubmitButton();
                    });
                }
            }

            function setupTooltips() {
                const tooltip = document.getElementById("tooltip");
                document.querySelectorAll("[data-tooltip]").forEach(element => {
                    element.addEventListener("mouseenter", function(e) {
                        tooltip.textContent = this.getAttribute("data-tooltip");
                        tooltip.classList.add("show");
                        const rect = this.getBoundingClientRect();
                        tooltip.style.left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2 + "px";
                        tooltip.style.top = rect.bottom + 8 + "px";
                    });
                    element.addEventListener("mouseleave", () => tooltip.classList.remove("show"));
                });
            }

            function setupScrollSync() {
                const panel = document.querySelector(".timeline-panel");
                const staff = document.querySelector(".staff-sidebar");
                const headerInner = document.getElementById("timelineHeaderInner");

                if (!panel || !staff || !headerInner) return;

                let syncingFromPanel = false;
                let syncingFromStaff = false;

                panel.addEventListener("scroll", () => {
                    if (!syncingFromStaff) {
                        syncingFromPanel = true;
                        staff.scrollTop = panel.scrollTop;
                    }
                    syncingFromStaff = false;
                    headerInner.style.transform = `translateX(-${panel.scrollLeft}px)`;
                }, { passive: true });

                staff.addEventListener("scroll", () => {
                    if (!syncingFromPanel) {
                        syncingFromStaff = true;
                        panel.scrollTop = staff.scrollTop;
                    }
                    syncingFromPanel = false;
                }, { passive: true });
            }

            function initializeSearchableDropdowns() {
                if (typeof $.fn.select2 !== 'undefined') {
                    // Destroy existing Select2 instances first
                    $('.select2-dropdown.select2-hidden-accessible').select2('destroy');

                    // Initialize Select2
                    $('.select2-dropdown').select2({
                        dropdownParent: $('#multiBookModal'),
                        width: '100%',
                        placeholder: function() {
                            return $(this).find('option:first').text();
                        },
                        allowClear: true
                    });

                    //  FIX: Trigger change event when Select2 value changes
                    $('.select2-dropdown').on('select2:select', function(e) {
                        const card = $(this).closest('.appointment-card')[0];
                        if (card) {
                            const index = parseInt(card.dataset.appointmentIndex);
                            calculateEndTime(index);
                            checkConflicts(index);
                            updateSummary();
                            updateSubmitButton();
                        }
                    });

                    // Handle clearing
                    $('.select2-dropdown').on('select2:unselecting', function(e) {
                        e.preventDefault();
                        $(this).val('').trigger('change');

                        const card = $(this).closest('.appointment-card')[0];
                        if (card) {
                            const index = parseInt(card.dataset.appointmentIndex);
                            calculateEndTime(index);
                            checkConflicts(index);
                            updateSummary();
                            updateSubmitButton();
                        }
                    });

                    $('.select2-dropdown').on('select2:clear', function(e) {
                        const card = $(this).closest('.appointment-card')[0];
                        if (card) {
                            const index = parseInt(card.dataset.appointmentIndex);
                            calculateEndTime(index);
                            checkConflicts(index);
                            updateSummary();
                            updateSubmitButton();
                        }
                    });

                    // Re-initialize when new appointments are added
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.addedNodes.length) {
                                // Destroy and reinit new dropdowns
                                $('.select2-dropdown').not('.select2-hidden-accessible').each(function() {
                                    $(this).select2({
                                        dropdownParent: $('#multiBookModal'),
                                        width: '100%',
                                        placeholder: $(this).find('option:first').text(),
                                        allowClear: true
                                    });

                                    // Add event handlers to new dropdowns
                                    $(this).on('select2:select', function(e) {
                                        const card = $(this).closest('.appointment-card')[0];
                                        if (card) {
                                            const index = parseInt(card.dataset.appointmentIndex);
                                            calculateEndTime(index);
                                            checkConflicts(index);
                                            updateSummary();
                                            updateSubmitButton();
                                        }
                                    });

                                    $(this).on('select2:unselecting', function(e) {
                                        e.preventDefault();
                                        $(this).val('').trigger('change');

                                        const card = $(this).closest('.appointment-card')[0];
                                        if (card) {
                                            const index = parseInt(card.dataset.appointmentIndex);
                                            calculateEndTime(index);
                                            checkConflicts(index);
                                            updateSummary();
                                            updateSubmitButton();
                                        }
                                    });

                                    $(this).on('select2:clear', function(e) {
                                        const card = $(this).closest('.appointment-card')[0];
                                        if (card) {
                                            const index = parseInt(card.dataset.appointmentIndex);
                                            calculateEndTime(index);
                                            checkConflicts(index);
                                            updateSummary();
                                            updateSubmitButton();
                                        }
                                    });
                                });
                            }
                        });
                    });

                    const container = document.getElementById('appointmentsContainer');
                    if (container) {
                        observer.observe(container, { childList: true, subtree: true });
                    }
                }
            }
            // ==========================================
            // DATA LOADING
            // ==========================================
            function loadBookings() {
                showLoading(true);
                fetch("/api/unaki/get-bookings?date=" + currentDate)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Filter out cancelled appointments
                            bookingsData = (data.bookings || []).filter(b => b.status !== "cancelled");
                            renderBookings();
                            updateStats();
                        } else {
                            showNotification("Failed to load bookings: " + data.error, "error");
                        }
                    })
                    .catch(error => {
                        console.error("Error loading bookings:", error);
                        showNotification("An error occurred while loading bookings.", "error");
                    })
                    .finally(() => showLoading(false));
            }

            function loadShiftSchedule() {
                fetch("/api/unaki/schedule?date=" + currentDate)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            renderShiftOverlays(data.staff);
                        }
                    })
                    .catch(error => console.error('Error loading shift schedule:', error));
            }

            function loadCustomerExistingAppointments(customerId) {
                const container = document.getElementById('customerExistingAppointments');
                const listDiv = document.getElementById('customerAppointmentsList');
                const countBadge = document.getElementById('customerAppointmentsCount');

                if (!customerId) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';
                listDiv.innerHTML = '<small class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Loading...</small>';

                fetch(`/api/unaki/customer-appointments/${customerId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.bookings?.length > 0) {
                            countBadge.textContent = data.bookings.length;
                            displayCustomerAppointments(data.bookings);
                        } else {
                            countBadge.textContent = '0';
                            listDiv.innerHTML = '<small class="text-muted"><i class="fas fa-info-circle me-1"></i>No upcoming appointments</small>';
                        }
                    })
                    .catch(err => {
                        console.error('Error loading customer appointments:', err);
                        listDiv.innerHTML = '<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error loading appointments</small>';
                    });
            }

            function displayCustomerAppointments(appointments) {
                const listDiv = document.getElementById('customerAppointmentsList');
                let html = '<div class="list-group list-group-flush">';

                appointments.forEach(apt => {
                    const date = new Date(apt.appointment_date);
                    const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const statusColor = apt.status === 'confirmed' ? 'success' : apt.status === 'scheduled' ? 'primary' : 'secondary';

                    html += `
                        <div class="list-group-item px-2 py-2" style="border: none; border-bottom: 1px solid #eee;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="fw-semibold" style="font-size: 0.9rem;">
                                        <i class="fas fa-spa me-1" style="color: var(--primary-color);"></i>${apt.service_names || apt.service_name || 'Service'}
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>${formattedDate}
                                        <i class="fas fa-clock ms-2 me-1"></i>${apt.start_time} - ${apt.end_time}
                                    </small>
                                    <br>
                                    <small class="text-muted"><i class="fas fa-user-nurse me-1"></i>${apt.staff_name}</small>
                                </div>
                                <span class="badge bg-${statusColor}" style="font-size: 0.7rem;">${apt.status}</span>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                listDiv.innerHTML = html;
            }

            // ==========================================
            // RENDERING
            // ==========================================
            function renderBookings() {
                console.log(' Rendering bookings:', bookingsData.length);

                // Clear existing appointments
                document.querySelectorAll('.appointment-block').forEach(block => block.remove());

                // Show all bookings (including paid ones)
                const visibleBookings = bookingsData;
                console.log(` Rendering ${visibleBookings.length} bookings`);

                // Render each booking
                visibleBookings.forEach(booking => {
                    const row = document.querySelector(`.timeline-row[data-staff-id="${booking.staff_id}"]`);
                    if (!row) return;

                    const startHour = parseFloat(booking.start_hour);
                    const startMinute = parseFloat(booking.start_minute);
                    const hoursSince9AM = startHour - 9 + startMinute / 60;
                    const leftPosition = hoursSince9AM * 140;
                    const durationHours = booking.duration / 60;
                    const width = Math.max(durationHours * 140, 80);
                    const serviceType = booking.service_type || "default";

                    const block = document.createElement("div");
                    // Add 'paid' class if payment status is 'paid' or 'success'
                    const isPaid = booking.payment_status === 'paid' || booking.payment_status === 'success';
                    block.className = `appointment-block service-${serviceType}${isPaid ? ' paid' : ''}`;
                    block.style.left = `${leftPosition}px`;
                    block.style.width = `${width}px`;
                    block.dataset.appointmentId = booking.id;
                    block.draggable = true;

                    block.innerHTML = `
                        <div class="appointment-header">
                            <div class="appointment-client">${booking.client_name}</div>
                            <div class="appointment-status"></div>
                        </div>
                        <div class="appointment-service">${booking.service_names || booking.service_name || 'Service'}</div>
                        <div class="appointment-footer">
                            <div class="appointment-time">
                                <i class="fas fa-clock"></i>${booking.start_time}
                            </div>
                            <div class="appointment-duration">${booking.duration}m</div>
                        </div>
                    `;

                    row.appendChild(block);
                });

                // Reinitialize context menu
                if (window.appointmentContextMenu?.reinitializeForAppointments) {
                    window.appointmentContextMenu.reinitializeForAppointments();
                }
            }

            function renderShiftOverlays(staffData) {
                document.querySelectorAll(".shift-overlay").forEach(el => el.remove());
                if (!staffData?.length) return;

                staffData.forEach(staff => {
                    const row = document.querySelector(`.timeline-row[data-staff-id="${staff.id}"]`);
                    if (!row) return;

                    const timeToPosition = (timeStr) => {
                        if (!timeStr) return 0;
                        const [hours, minutes] = timeStr.split(':').map(Number);
                        return (hours - 9 + minutes / 60) * 140;
                    };

                    const calculateWidth = (startTime, endTime) => {
                        if (!startTime || !endTime) return 0;
                        const [startH, startM] = startTime.split(':').map(Number);
                        const [endH, endM] = endTime.split(':').map(Number);
                        return Math.max(0, ((endH * 60 + endM) - (startH * 60 + startM)) / 60 * 140);
                    };

                    const createOverlay = (type, left, width, label) => {
                        const overlay = document.createElement('div');
                        overlay.className = `shift-overlay shift-overlay-${type}`;
                        overlay.style.left = `${left}px`;
                        overlay.style.width = `${width}px`;
                        overlay.innerHTML = `<span class="overlay-label">${label}</span>`;
                        return overlay;
                    };

                    // Holiday/Off-day overlays
                    const HOLIDAY_STATUSES = ['holiday'];
                    const OFFDAY_STATUSES = ['off', 'absent', 'leave', 'weekoff', 'not_scheduled', 'offday'];

                    if (staff.day_status && HOLIDAY_STATUSES.includes(staff.day_status)) {
                        row.appendChild(createOverlay('holiday', 0, 13 * 140, 'Holiday'));
                        return;
                    }

                    if (!staff.is_working || !staff.shift_start || !staff.shift_end ||
                        (staff.day_status && OFFDAY_STATUSES.includes(staff.day_status))) {
                        row.appendChild(createOverlay('off-duty', 0, 13 * 140, 'Off Day'));
                        return;
                    }

                    // Before/After shift overlays
                    if (staff.shift_start && staff.shift_start !== '09:00') {
                        const width = timeToPosition(staff.shift_start);
                        if (width > 0) row.appendChild(createOverlay('off-duty', 0, width, 'Before Shift'));
                    }

                    if (staff.shift_end && staff.shift_end !== '22:00') {
                        const left = timeToPosition(staff.shift_end);
                        const width = 13 * 140 - left;
                        if (width > 0) row.appendChild(createOverlay('off-duty', left, width, 'After Shift'));
                    }

                    // Break overlays
                    if (staff.breaks?.length) {
                        staff.breaks.forEach(breakTime => {
                            if (breakTime?.start && breakTime?.end) {
                                const left = timeToPosition(breakTime.start);
                                const width = calculateWidth(breakTime.start, breakTime.end);
                                if (width > 0) row.appendChild(createOverlay('break', left, width, 'Break Time'));
                            }
                        });
                    }

                    // Out-of-office overlays
                    if (staff.ooo?.length) {
                        staff.ooo.forEach(oooTime => {
                            if (oooTime?.start && oooTime?.end) {
                                const left = timeToPosition(oooTime.start);
                                const width = calculateWidth(oooTime.start, oooTime.end);
                                if (width > 0) {
                                    const overlay = createOverlay('out-of-office', left, width, oooTime.reason || 'Out of Office');
                                    if (oooTime.reason) overlay.title = oooTime.reason;
                                    row.appendChild(overlay);
                                }
                            }
                        });
                    }
                });
            }

            function updateStats() {
                const total = bookingsData.length;
                const completed = bookingsData.filter(b => b.status === 'completed').length;
                const paid = bookingsData.filter(b => b.payment_status === 'paid').length;
                const pending = bookingsData.filter(b => b.payment_status === 'pending').length;

                document.getElementById('totalBookings').textContent = total;
                document.getElementById('completedBookings').textContent = completed;

                // Log payment status breakdown
                console.log(` Stats Update:
                    Total: ${total}
                    Completed: ${completed}
                    Paid (hidden): ${paid}
                    Pending (visible): ${pending}
                `);
            }

            function updateCurrentTimeLine() {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                if (currentHour >= 9 && currentHour < 22) {
                    const timeLine = document.getElementById("currentTimeLine");
                    const timeLabel = document.getElementById("currentTimeLabel");
                    const hoursSince9AM = currentHour - 9;
                    const leftPosition = (hoursSince9AM + currentMinute / 60) * 140;

                    timeLabel.textContent = now.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", hour12: true });
                    timeLine.style.left = leftPosition + "px";
                    timeLine.style.display = "block";
                } else {
                    document.getElementById("currentTimeLine").style.display = "none";
                }
            }

            // ==========================================
            // QUICK ADD CLIENT
            // ==========================================
            function openQuickAddClient() {
                const modalEl = document.getElementById("quickAddClientModal");
                const modal = new bootstrap.Modal(modalEl, {
                    backdrop: 'static',
                    keyboard: true
                });
                document.getElementById('quickAddClientForm').reset();
                modal.show();

                // Ensure proper z-index stacking
                setTimeout(() => {
                    if (modalEl) {
                        modalEl.style.zIndex = '1065';
                    }
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    if (backdrops.length > 0) {
                        backdrops[backdrops.length - 1].style.zIndex = '1060';
                    }
                }, 100);
            }

            async function saveQuickClient() {
                console.log(' saveQuickClient() called');

                // Get form values
                const firstName = document.getElementById('quickFirstName').value.trim();
                const lastName = document.getElementById('quickLastName').value.trim();
                const phone = document.getElementById('quickPhone').value.trim();
                const email = document.getElementById('quickEmail').value.trim();
                const gender = document.getElementById('quickGender').value;

                console.log(' Form values:', { firstName, lastName, phone, email, gender });

                // Validation
                if (!firstName || !lastName || !phone || !gender) {
                    console.error(' Validation failed - missing required fields');
                    showNotification('Please fill in all required fields (First Name, Last Name, Phone, Gender)', 'error');
                    return;
                }

                // Phone validation
                if (phone.length < 10) {
                    console.error(' Invalid phone number');
                    showNotification('Please enter a valid phone number (at least 10 digits)', 'error');
                    return;
                }

                console.log(' Validation passed');

                // Get save button by ID
                const submitBtn = document.getElementById('saveQuickClientBtn');

                if (!submitBtn) {
                    console.error(' Save button not found!');
                    return;
                }

                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

                const clientData = {
                    first_name: firstName,
                    last_name: lastName,
                    phone: phone,
                    email: email,
                    gender: gender,
                };

                console.log(' Sending data to API:', clientData);

                try {
                    const response = await fetch("/api/unaki/quick-add-client", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(clientData),
                    });

                    console.log(' Response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log(' Response data:', result);

                    if (result.success) {
                        console.log(' Client saved successfully:', result.client);

                        showNotification(result.message || 'Client added successfully!', 'success');

                        // Close modal
                        const modalEl = document.getElementById('quickAddClientModal');
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) {
                            modal.hide();
                        }

                        quickAddForm.reset();

                        // Auto-select the newly added client in the multi-booking form
                        const clientSelect = document.getElementById('multiClientSelect');
                        if (clientSelect && result.client) {
                            // Add new option to select with data attributes
                            const option = new Option(
                                `${result.client.first_name} ${result.client.last_name} - ${result.client.phone}`,
                                result.client.id,
                                true,
                                true
                            );
                            option.setAttribute('data-phone', result.client.phone);
                            option.setAttribute('data-email', result.client.email || '');
                            clientSelect.add(option);

                            // Trigger change event for Select2
                            $(clientSelect).trigger('change');

                            console.log(' Client added to dropdown');
                        }
                    } else {
                        console.error(' Server returned error:', result.error);
                        showNotification(result.error || 'Failed to create client', 'error');
                    }
                } catch (error) {
                    console.error(" Error saving client:", error);
                    showNotification('Failed to create client: ' + error.message, 'error');
                } finally {
                    // Re-enable submit button
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                    console.log(' saveQuickClient() completed');
                }
            }

            // Placeholder for loadClients function if it's needed for refreshing the dropdown
            async function loadClients() {
                // This function should ideally fetch the latest client list and update the #multiClientSelect dropdown.
                // For now, we'll assume the page reload or manual refresh handles this,
                // or that the added option is sufficient. If not, implement fetching and updating here.
                console.log("Refreshing client list (implementation needed if not handled by page reload)");
                // Example:
                // const response = await fetch('/api/clients');
                // const clients = await response.json();
                // const clientSelect = document.getElementById('multiClientSelect');
                // clientSelect.innerHTML = '<option value="">Choose a client...</option>'; // Clear existing
                // clients.forEach(client => {
                //     const option = document.createElement('option');
                //     option.value = client.id;
                //     option.textContent = `${client.first_name} ${client.last_name} - ${client.phone}`;
                //     clientSelect.appendChild(option);
                // });
                // $(clientSelect).select2({ dropdownParent: $('#multiBookModal'), width: '100%' }); // Re-initialize select2
            }


            // ==========================================
            // MULTI-BOOKING MODAL
            // ==========================================
            function openMultiBookModal() {
                console.log(' Opening multi-book modal');

                try {
                    // Reset the modal
                    resetMultiBookModal();

                    // Get the modal element
                    const modalElement = document.getElementById('multiBookModal');

                    if (!modalElement) {
                        console.error(' Modal element #multiBookModal not found!');
                        alert('Error: Booking modal not found. Please refresh the page.');
                        return;
                    }

                    // Show the modal using Bootstrap
                    const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                    modal.show();

                    console.log(' Multi-book modal opened successfully');
                } catch (error) {
                    console.error(' Error opening modal:', error);
                    alert('Error opening booking form. Please refresh the page and try again.');
                }
            }

            // Initialize real-time validation for an appointment card
            function initializeAppointmentCardValidation(card) {
                const index = parseInt(card.dataset.appointmentIndex);

                // Initialize time input fields and event listeners
                const startTimeSelect = card.querySelector('.start-time-select');
                const hiddenStartTimeInput = card.querySelector('.start-time-24h');
                const endTimeSelect = card.querySelector('.end-time-select'); // The visible dropdown
                const endTimeDisplay = card.querySelector('.end-time-display'); // The read-only display input
                const hiddenEndTimeInput = card.querySelector('.end-time-24h'); // Hidden input for end time

                if (startTimeSelect && hiddenStartTimeInput && endTimeSelect && endTimeDisplay && hiddenEndTimeInput) {
                    const updateAndValidateTime = () => {
                        // Update hidden start time input from the selected value
                        if (startTimeSelect.value) {
                            hiddenStartTimeInput.value = startTimeSelect.value;
                        }

                        // Update end time based on service and updated start time
                        updateAppointmentEndTime(card);

                        // Trigger validation and conflict check
                        checkConflictsRealtime(index);
                        updateSummary();
                        updateSubmitButton();

                        // Show validation icon and color for start time select
                        const parentCol = startTimeSelect.closest('.col-md-4');
                        if (parentCol) {
                            const validationIcon = parentCol.querySelector('.validation-icon');
                            if (validationIcon) validationIcon.style.display = 'inline-block';
                            startTimeSelect.style.borderColor = '#10b981';
                        }
                    };

                    startTimeSelect.addEventListener('change', updateAndValidateTime);

                    // Set initial value if available (e.g., when card is first created)
                    if (hiddenStartTimeInput.value && startTimeSelect.value === "") { // Only if not already set by populateTimeDropdown
                        const [h24, m] = hiddenStartTimeInput.value.split(':');
                        const hour24 = parseInt(h24);
                        const period = hour24 >= 12 ? 'PM' : 'AM';
                        const hour12 = hour24 % 12 || 12;
                        const minutes = m;

                        // Find the correct option in the dropdown
                        const optionToSelect = Array.from(startTimeSelect.options).find(option => option.value === hiddenStartTimeInput.value);
                        if (optionToSelect) {
                            startTimeSelect.value = hiddenStartTimeInput.value;
                            // Trigger the updateAndValidateTime function after setting the value
                            setTimeout(updateAndValidateTime, 0);
                        }
                    }
                }

                // Add real-time validation for service selection
                const serviceSelect = card.querySelector('.service-select');
                if (serviceSelect) {
                    serviceSelect.addEventListener('change', function() {
                        const validationIcon = this.closest('.col-md-6').querySelector('.validation-icon');
                        if (this.value) {
                            if (validationIcon) validationIcon.style.display = 'inline-block';
                            this.style.borderColor = '#10b981';
                            calculateEndTime(index); // Recalculate end time based on new service duration
                            updateSummary();
                            checkConflictsRealtime(index);
                        } else {
                            if (validationIcon) validationIcon.style.display = 'none';
                            this.style.borderColor = '#e2e8f0';
                        }
                        updateSubmitButton();
                    });
                }

                // Add real-time validation for staff selection
                const staffSelect = card.querySelector('.staff-select');
                if (staffSelect) {
                    staffSelect.addEventListener('change', function() {
                        const validationIcon = this.closest('.col-md-6').querySelector('.validation-icon');
                        if (this.value) {
                            if (validationIcon) validationIcon.style.display = 'inline-block';
                            this.style.borderColor = '#10b981';
                            checkConflictsRealtime(index);
                        } else {
                            if (validationIcon) validationIcon.style.display = 'none';
                            this.style.borderColor = '#e2e8f0';
                        }
                        updateSubmitButton();
                    });
                }

                // Add real-time validation for date selection
                const dateInput = card.querySelector('.appointment-date');
                if (dateInput) {
                    dateInput.addEventListener('change', function() {
                        const validationIcon = this.closest('.col-md-4').querySelector('.validation-icon');
                        if (this.value) {
                            if (validationIcon) validationIcon.style.display = 'inline-block';
                            this.style.borderColor = '#10b981';
                            checkConflictsRealtime(index);
                        } else {
                            if (validationIcon) validationIcon.style.display = 'none';
                            this.style.borderColor = '#e2e8f0';
                        }
                        updateSubmitButton();
                    });
                }
            }

            function resetMultiBookModal() {
                console.log(' Resetting multi-book modal');

                try {
                    // Get the appointments container
                    const container = document.getElementById('appointmentsContainer');
                    if (!container) {
                        console.error(' Appointments container not found!');
                        return;
                    }

                    // Clear all appointment cards
                    container.innerHTML = '';

                    // Reset counter
                    appointmentCounter = 0; // Reset counter to 0, first add will make it 1

                    // Add first appointment card
                    addAppointmentCard(); // Call the correct function to add the card

                    // Reset and hide summary
                    const summary = document.getElementById('bookingSummary');
                    if (summary) {
                        summary.style.display = 'none';
                    }

                    // Reset client selection
                    const clientSelect = document.getElementById('multiClientSelect');
                    if (clientSelect) {
                        $(clientSelect).val(null).trigger('change'); // Clear and re-initialize Select2
                    }

                    // Reset notes
                    document.getElementById('multiNotes').value = '';

                    console.log(' Multi-book modal reset complete');
                } catch (error) {
                    console.error(' Error resetting modal:', error);
                }
            }

            function addAppointmentCard() {
                // This function is intended to add a single appointment card,
                // likely called by resetMultiBookModal.
                // The previous implementation was calling addAppointment() which adds subsequent cards.
                const newAppointmentIndex = appointmentCounter; // Use the current counter value

                const newAppointment = `
                    <div class="appointment-card multi-appointment-row" data-appointment-index="${newAppointmentIndex}">
                        <div class="appointment-number">${newAppointmentIndex + 1}</div>
                        <button type="button" class="remove-appointment d-none" onclick="removeAppointment(${newAppointmentIndex})">
                            <i class="fas fa-times"></i>
                        </button>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-concierge-bell me-2" style="color: var(--primary-color);"></i>Service
                                    <span class="validation-icon ms-2" style="display: none;">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </span>
                                </label>
                                <select name="service_id" class="form-select service-select select2-dropdown" required style="border-radius: 10px; padding: 12px; width: 100%; border: 2px solid #e2e8f0; transition: all 0.3s;">
                                    <option value="">Select service...</option>
                                    {% if services %}
                                        {% for service in services %}
                                        <option value="{{ service.id }}" data-duration="{{ service.duration or 60 }}" data-price="{{ service.price }}">
                                            {{ service.name }} ({{ service.duration or 60 }} min - {{ "%.2f"|format(service.price) }})
                                        </option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-user-md me-2" style="color: var(--primary-color);"></i>Staff Member
                                    <span class="validation-icon ms-2" style="display: none;">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </span>
                                </label>
                                <select name="staff_id" class="form-select staff-select select2-dropdown" required style="border-radius: 10px; padding: 12px; border: 2px solid #e2e8f0; transition: all 0.3s;">
                                    <option value="">Select staff member...</option>
                                    {% if staff_members %}
                                        {% for staff in staff_members %}
                                        <option value="{{ staff.id }}">{{ staff.first_name }} {{ staff.last_name if staff.last_name else '' }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-calendar me-2" style="color: var(--primary-color);"></i>Date
                                    <span class="validation-icon ms-2" style="display: none;">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </span>
                                </label>
                                <input type="date" name="date" class="form-control appointment-date" value="{{ today }}" required style="border-radius: 10px; padding: 12px; border: 2px solid #e2e8f0; transition: all 0.3s;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-clock me-2" style="color: var(--primary-color);"></i>Start Time
                                    <span class="validation-icon ms-2" style="display: none;">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </span>
                                </label>
                                <select name="start_time" class="form-select start-time-select" required onchange="handleStartTimeChange(this)" style="border-radius: 10px; padding: 12px; border: 2px solid #e2e8f0; transition: all 0.3s;">
                                    <option value="">Select time...</option>
                                </select>
                                <input type="hidden" name="start_time_24h" class="start-time-24h" value="09:00">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-clock me-2" style="color: var(--success-color);"></i>End Time
                                    <span class="validation-icon ms-2" style="display: none;">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </span>
                                </label>
                                <select name="end_time" class="form-select end-time-select" style="border-radius: 10px; padding: 12px; font-weight: 600; color: var(--success-color); border: 2px solid #e2e8f0; transition: all 0.3s;">
                                    <option value="">Auto-calculated...</option>
                                </select>
                                <input type="hidden" name="end_time_24h" class="end-time-24h">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div id="conflictAlert${newAppointmentIndex}" class="alert alert-warning d-none" style="border-radius: 10px">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span class="conflict-message"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('appointmentsContainer').insertAdjacentHTML('beforeend', newAppointment);

                // Initialize the manual time input fields and their listeners for the new card
                const newCard = document.querySelector(`[data-appointment-index="${newAppointmentIndex}"]`);
                if (newCard) {
                    initializeAppointmentCardValidation(newCard);
                    // Ensure the end time select is cleared initially
                    const endTimeSelect = newCard.querySelector('.end-time-select');
                    if (endTimeSelect) {
                        endTimeSelect.innerHTML = '<option value="">Auto-calculated...</option>';
                    }
                }
            }

            function addAppointment() {
                appointmentCounter++; // Increment counter for new appointment index
                const newAppointmentIndex = appointmentCounter; // Use the incremented counter as index

                const newAppointment = `
                    <div class="appointment-card multi-appointment-row" data-appointment-index="${newAppointmentIndex}">
                        <div class="appointment-number">${newAppointmentIndex + 1}</div>
                        <button type="button" class="remove-appointment" onclick="removeAppointment(${newAppointmentIndex})">
                            <i class="fas fa-times"></i>
                        </button>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-concierge-bell me-2" style="color: var(--primary-color);"></i>Service
                                    <span class="validation-icon ms-2" style="display: none;">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </span>
                                </label>
                                <select name="service_id" class="form-select service-select select2-dropdown" required style="border-radius: 10px; padding: 12px; width: 100%; border: 2px solid #e2e8f0; transition: all 0.3s;">
                                    <option value="">Select service...</option>
                                    {% if services %}
                                        {% for service in services %}
                                        <option value="{{ service.id }}" data-duration="{{ service.duration or 60 }}" data-price="{{ service.price }}">
                                            {{ service.name }} ({{ service.duration or 60 }} min - {{ "%.2f"|format(service.price) }})
                                        </option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-user-md me-2" style="color: var(--primary-color);"></i>Staff Member
                                    <span class="validation-icon ms-2" style="display: none;">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </span>
                                </label>
                                <select name="staff_id" class="form-select staff-select select2-dropdown" required style="border-radius: 10px; padding: 12px; border: 2px solid #e2e8f0; transition: all 0.3s;">
                                    <option value="">Select staff member...</option>
                                    {% if staff_members %}
                                        {% for staff in staff_members %}
                                        <option value="{{ staff.id }}">{{ staff.first_name }} {{ staff.last_name if staff.last_name else '' }}</option>
                                        {% endfor %}
                                    {% endif %}
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-calendar me-2" style="color: var(--primary-color);"></i>Date
                                    <span class="validation-icon ms-2" style="display: none;">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </span>
                                </label>
                                <input type="date" name="date" class="form-control appointment-date" value="{{ today }}" required style="border-radius: 10px; padding: 12px; border: 2px solid #e2e8f0; transition: all 0.3s;">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-clock me-2" style="color: var(--primary-color);"></i>Start Time
                                    <span class="validation-icon ms-2" style="display: none;">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </span>
                                </label>
                                <select name="start_time" class="form-select start-time-select" required onchange="handleStartTimeChange(this)" style="border-radius: 10px; padding: 12px; border: 2px solid #e2e8f0; transition: all 0.3s;">
                                    <option value="">Select time...</option>
                                </select>
                                <input type="hidden" name="start_time_24h" class="start-time-24h" value="09:00">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label fw-semibold">
                                    <i class="fas fa-clock me-2" style="color: var(--success-color);"></i>End Time
                                    <span class="validation-icon ms-2" style="display: none;">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </span>
                                </label>
                                <select name="end_time" class="form-select end-time-select" style="border-radius: 10px; padding: 12px; font-weight: 600; color: var(--success-color); border: 2px solid #e2e8f0; transition: all 0.3s;">
                                    <option value="">Auto-calculated...</option>
                                </select>
                                <input type="hidden" name="end_time_24h" class="end-time-24h">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div id="conflictAlert${newAppointmentIndex}" class="alert alert-warning d-none" style="border-radius: 10px">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span class="conflict-message"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('appointmentsContainer').insertAdjacentHTML('beforeend', newAppointment);

                // Populate time dropdown for the newly added card
                const newCard = document.querySelector(`[data-appointment-index="${newAppointmentIndex}"]`);
                if (newCard) {
                    // Initialize the manual time input fields and their listeners
                    initializeAppointmentCardValidation(newCard);
                    // Also ensure the end time select is cleared initially
                    const endTimeSelect = newCard.querySelector('.end-time-select');
                    if (endTimeSelect) {
                        endTimeSelect.innerHTML = '<option value="">Auto-calculated...</option>';
                    }
                }

                // Reinitialize Select2 for the new dropdowns
                initializeSearchableDropdowns();

                updateAppointmentCount();
                updateRemoveButtonsVisibility(); // Ensure remove buttons are shown correctly
                updateSummary();
                updateSubmitButton();
            }

            function removeAppointment(index) {
                const card = document.querySelector(`[data-appointment-index="${index}"]`);
                if (card) {
                    card.remove();
                    updateAppointmentCount();
                    updateRemoveButtonsVisibility();
                    updateSummary();
                    updateSubmitButton();
                }
            }

            function updateAppointmentEndTime(card) {
                const serviceSelect = card.querySelector('.service-select');
                const startTimeInput = card.querySelector('.start-time-24h'); // Use hidden 24h input
                const endTimeInput = card.querySelector('.end-time-24h');     // Use hidden 24h input
                const endTimeSelect = card.querySelector('.end-time-select'); // The visible dropdown
                const endTimeDisplay = card.querySelector('.end-time-display'); // The read-only display input

                if (!serviceSelect || !startTimeInput || !endTimeInput || !endTimeSelect || !endTimeDisplay) return;

                const selectedOption = serviceSelect.selectedOptions[0];
                const startTime = startTimeInput.value;

                if (!selectedOption || !startTime) {
                    endTimeInput.value = "";
                    endTimeDisplay.value = "";
                    endTimeSelect.innerHTML = '<option value="">Select time...</option>'; // Clear options
                    return;
                }

                const duration = parseInt(selectedOption.dataset.duration) || 60;
                const endTime = calculateEndTimeFromDuration(startTime, duration);
                endTimeInput.value = endTime;
                endTimeDisplay.value = convertTo12Hour(endTime); // Update the display

                // Update the visible end time dropdown to reflect the calculated end time
                // and provide options after it.
                endTimeSelect.innerHTML = ""; // Clear existing options
                const endTimeOption = document.createElement('option');
                endTimeOption.value = endTime;
                endTimeOption.textContent = endTimeDisplay.value; // Use the formatted 12-hour time
                endTimeOption.selected = true;
                endTimeSelect.appendChild(endTimeOption);

                // Add options for times after the calculated end time, up to a reasonable limit (e.g., 22:00)
                let currentTime = new Date();
                currentTime.setHours(parseInt(endTime.split(':')[0]), parseInt(endTime.split(':')[1]), 0, 0);

                for (let i = 1; i <= 20; i++) { // Add up to 20 more 15-min intervals
                    currentTime.setMinutes(currentTime.getMinutes() + 15);
                    const nextHour = currentTime.getHours();
                    const nextMinute = currentTime.getMinutes();

                    if (nextHour >= 22) break; // Stop if we reach end of working day

                    const nextTime24 = `${String(nextHour).padStart(2, '0')}:${String(nextMinute).padStart(2, '0')}`;
                    const nextTime12 = convertTo12Hour(nextTime24);
                    const option = document.createElement('option');
                    option.value = nextTime24;
                    option.textContent = nextTime12;
                    if (nextTime24 === endTime) option.selected = true; // Keep the calculated one selected
                    endTimeSelect.appendChild(option);
                }
            }

            function updateAppointmentCount() {
                const count = document.querySelectorAll(".appointment-card").length;
                document.getElementById("appointmentCount").textContent = `${count} Appointment${count !== 1 ? "s" : ""}`;
            }

            function updateRemoveButtonsVisibility() {
                const cards = document.querySelectorAll(".appointment-card");
                cards.forEach(card => {
                    const removeBtn = card.querySelector(".remove-appointment");
                    removeBtn.classList.toggle("d-none", cards.length <= 1);
                });
            }

            function calculateEndTime(index) {
                const card = document.querySelector(`[data-appointment-index="${index}"]`);
                if (!card) return;
                updateAppointmentEndTime(card);

                // Sync 12-hour displays after calculation
                setTimeout(() => {
                    syncAll12HourDisplays();
                }, 50);
            }

            function calculateEditEndTime() {
                const serviceSelect = document.getElementById('editServiceSelect');
                const startTimeInput = document.getElementById('editStartTime');
                const endTimeInput = document.getElementById('editEndTime');

                if (!serviceSelect || !startTimeInput || !endTimeInput) return;

                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                const duration = parseInt(selectedOption.dataset.duration) || 60;
                const startTime = startTimeInput.value;
                const endTime = calculateEndTimeFromDuration(startTime, duration);
                endTimeInput.value = endTime;
            }

            // Real-time conflict checking with visual feedback
            function checkConflictsRealtime(appointmentIndex) {
                const appointment = document.querySelector(`[data-appointment-index="${appointmentIndex}"]`);
                if (!appointment) return;

                const staffSelect = appointment.querySelector('.staff-select');
                const dateInput = appointment.querySelector('.appointment-date');
                const startTimeInput = appointment.querySelector('.start-time-24h'); // Use hidden 24h input
                const endTimeInput = appointment.querySelector('.end-time-24h');     // Use hidden 24h input
                const conflictAlert = appointment.querySelector(`#conflictAlert${appointmentIndex}`);
                const conflictMessageSpan = conflictAlert?.querySelector('.conflict-message');

                // Reset conflict state
                if (conflictAlert) conflictAlert.classList.add('d-none');
                appointment.classList.remove('duplicate');

                // Reset visual feedback colors for relevant fields
                staffSelect.style.borderColor = '#e2e8f0';
                dateInput.style.borderColor = '#e2e8f0';
                const timeInputsContainer = appointment.querySelector('.col-md-4:has(.start-time-24h)'); // Find the column containing time inputs
                if (timeInputsContainer) {
                    timeInputsContainer.querySelectorAll('input, select').forEach(el => el.style.borderColor = '#e2e8f0');
                }


                // Don't check if any required field is missing or invalid
                if (!staffSelect.value || !dateInput.value || !startTimeInput.value || !endTimeInput.value || endTimeInput.value <= startTimeInput.value) {
                    return;
                }

                const staffId = parseInt(staffSelect.value);
                const date = dateInput.value;
                const startTime = startTimeInput.value;
                const endTime = endTimeInput.value;

                const timesOverlap = (start1, end1, start2, end2) => start1 < end2 && end1 > start2;

                let hasConflict = false;

                // Check against existing bookings
                bookingsData.forEach(booking => {
                    if (booking.staff_id == staffId && booking.appointment_date === date) {
                        if (timesOverlap(startTime, endTime, booking.start_time, booking.end_time)) {
                            const message = ` Staff member is already booked from ${convertTo12Hour(booking.start_time)} to ${convertTo12Hour(booking.end_time)}`;
                            if (conflictMessageSpan) conflictMessageSpan.textContent = message;
                            if (conflictAlert) {
                                conflictAlert.classList.remove('d-none');
                                conflictAlert.style.animation = 'shake 0.5s';
                            }
                            appointment.classList.add('duplicate');
                            hasConflict = true;

                            // Visual feedback on fields
                            staffSelect.style.borderColor = '#ef4444';
                            dateInput.style.borderColor = '#ef4444';
                            if (timeInputsContainer) {
                                timeInputsContainer.querySelectorAll('input, select').forEach(el => el.style.borderColor = '#ef4444');
                            }
                        }
                    }
                });

                // Check against other appointments in the same booking session
                const bulkClientSelect = document.getElementById('multiClientSelect');
                const isBulkBookingForSameCustomer = bulkClientSelect && bulkClientSelect.value;

                document.querySelectorAll('.appointment-card').forEach((otherCard, otherIndex) => {
                    // Skip checking against self
                    if (parseInt(otherCard.dataset.appointmentIndex) === appointmentIndex) return;

                    const otherStaffSelect = otherCard.querySelector('.staff-select');
                    const otherDateInput = otherCard.querySelector('.appointment-date');
                    const otherStartTimeInput = otherCard.querySelector('.start-time-24h'); // Use hidden 24h input
                    const otherEndTimeInput = otherCard.querySelector('.end-time-24h');     // Use hidden 24h input

                    // Ensure other card has valid data before checking
                    if (otherStaffSelect.value && otherDateInput.value && otherStartTimeInput.value && otherEndTimeInput.value && otherEndTimeInput.value > otherStartTimeInput.value) {
                        // Check for STAFF conflicts (same staff, same time)
                        if (parseInt(otherStaffSelect.value) === staffId && otherDateInput.value === date) {
                            if (timesOverlap(startTime, endTime, otherStartTimeInput.value, otherEndTimeInput.value)) {
                                const message = ` Conflict with Appointment #${otherIndex + 1} - Same staff at same time`;
                                if (conflictMessageSpan) conflictMessageSpan.textContent = message;
                                if (conflictAlert) {
                                    conflictAlert.classList.remove('d-none');
                                    conflictAlert.style.animation = 'shake 0.5s';
                                }
                                appointment.classList.add('duplicate');
                                hasConflict = true;

                                // Visual feedback
                                staffSelect.style.borderColor = '#ef4444';
                                dateInput.style.borderColor = '#ef4444';
                                if (timeInputsContainer) {
                                    timeInputsContainer.querySelectorAll('input, select').forEach(el => el.style.borderColor = '#ef4444');
                                }
                            }
                        }

                        // Check for CUSTOMER conflicts (same customer can't have overlapping appointments)
                        if (isBulkBookingForSameCustomer && otherDateInput.value === date) {
                            if (timesOverlap(startTime, endTime, otherStartTimeInput.value, otherEndTimeInput.value)) {
                                const message = ` Conflict with Appointment #${otherIndex + 1} - Customer can't be in two places at once`;
                                if (conflictMessageSpan) conflictMessageSpan.textContent = message;
                                if (conflictAlert) {
                                    conflictAlert.classList.remove('d-none');
                                    conflictAlert.style.animation = 'shake 0.5s';
                                }
                                appointment.classList.add('duplicate');
                                hasConflict = true;

                                // Visual feedback
                                dateInput.style.borderColor = '#ef4444';
                                if (timeInputsContainer) {
                                    timeInputsContainer.querySelectorAll('input, select').forEach(el => el.style.borderColor = '#ef4444');
                                }
                            }
                        }
                    }
                });

                // Check shift constraints via backend (real-time)
                fetch('/api/unaki/check-conflicts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ staff_id: staffId, start_time: startTime, end_time: endTime, date: date })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.shift_violation || (data.has_conflicts && data.conflicts?.length)) {
                        const message = data.reason || (data.conflicts?.[0] ?
                            `Conflicts with ${data.conflicts[0].client_name || 'booking'} (${convertTo12Hour(data.conflicts[0].start_time)} - ${convertTo12Hour(data.conflicts[0].end_time)})` :
                            'Shift constraint violation');
                        if (conflictMessageSpan) conflictMessageSpan.textContent = ` ${message}`;
                        if (conflictAlert) {
                            conflictAlert.classList.remove('d-none');
                            conflictAlert.style.animation = 'shake 0.5s';
                        }
                        appointment.classList.add('duplicate');
                        hasConflict = true;

                        // Visual feedback
                        staffSelect.style.borderColor = '#ef4444';
                        dateInput.style.borderColor = '#ef4444';
                        if (timeInputsContainer) {
                            timeInputsContainer.querySelectorAll('input, select').forEach(el => el.style.borderColor = '#ef4444');
                        }
                    } else if (!hasConflict) {
                        // No conflicts found by any check, reset to valid state
                        staffSelect.style.borderColor = '#10b981';
                        dateInput.style.borderColor = '#10b981';
                        if (timeInputsContainer) {
                            timeInputsContainer.querySelectorAll('input, select').forEach(el => el.style.borderColor = '#10b981');
                        }
                    }
                })
                .catch(error => console.error('Error checking conflicts:', error));
            }

            // Legacy function for backward compatibility
            function checkConflicts(appointmentIndex) {
                checkConflictsRealtime(appointmentIndex);
            }

            function updateSummary() {
                let totalDuration = 0, totalPrice = 0;
                const staffSet = new Set();

                document.querySelectorAll(".appointment-card").forEach(card => {
                    const serviceSelect = card.querySelector(".service-select");
                    const staffSelect = card.querySelector(".staff-select");

                    if (serviceSelect.value) {
                        const selectedOption = serviceSelect.selectedOptions[0];
                        totalDuration += parseInt(selectedOption.dataset.duration) || 60;
                        totalPrice += parseFloat(selectedOption.dataset.price) || 0;
                    }

                    if (staffSelect.value) staffSet.add(staffSelect.value);
                });

                document.getElementById("multiTotalDuration").textContent = `${totalDuration} min`;
                document.getElementById("multiTotalPrice").textContent = `${totalPrice.toFixed(2)}`;
                document.getElementById("multiStaffCount").textContent = staffSet.size;
            }

            // ==========================================
            // VALIDATION
            // ==========================================

            // Validate all appointments before booking
            function validateAllAppointments() {
                const appointments = document.querySelectorAll('.appointment-card');
                if (appointments.length === 0) {
                    return false;
                }

                for (const appointment of appointments) {
                    const serviceSelect = appointment.querySelector('.service-select');
                    const staffSelect = appointment.querySelector('.staff-select');
                    const startTimeInput = appointment.querySelector('.start-time-24h'); // Use hidden 24h input
                    const endTimeInput = appointment.querySelector('.end-time-24h');     // Use hidden 24h input

                    // Check if values exist and are not empty/default
                    if (!serviceSelect?.value || serviceSelect.value === '' ||
                        !staffSelect?.value || staffSelect.value === '' ||
                        !startTimeInput?.value || startTimeInput.value === '' ||
                        !endTimeInput?.value || endTimeInput.value === '' ||
                        endTimeInput.value <= startTimeInput.value) { // Also check if end time is not before start time
                        return false;
                    }
                    // Also check for duplicates/conflicts (visual indicator)
                    if (appointment.classList.contains('duplicate')) {
                        return false;
                    }
                }

                return true;
            }

            // Update Book All button state
            function updateBookAllButton() {
                const bookAllBtn = document.getElementById('bookAllAppointments');
                if (bookAllBtn) {
                    const isValid = validateAllAppointments();
                    bookAllBtn.disabled = !isValid;

                    // Visual feedback
                    if (isValid) {
                        bookAllBtn.classList.remove('btn-secondary');
                        bookAllBtn.classList.add('btn-primary');
                    } else {
                        bookAllBtn.classList.remove('btn-primary');
                        bookAllBtn.classList.add('btn-secondary');
                    }
                }
            }

            function validateClientSelection() {
                const clientSelect = document.getElementById('multiClientSelect');
                return !!clientSelect.value;
            }

            function updateSubmitButton() {
                const submitBtn = document.getElementById('bookAllAppointments');
                if (!submitBtn) return;

                const hasClient = validateClientSelection();
                const isValidAppointments = validateAllAppointments();

                const allValid = hasClient && isValidAppointments;

                submitBtn.disabled = !allValid;
                submitBtn.classList.toggle('btn-secondary', !allValid);
                submitBtn.classList.toggle('btn-primary', allValid);
            }

            // ==========================================
            // SUBMISSION
            // ==========================================
            async function submitMultiAppointment() {
                const clientDropdown = document.getElementById('multiClientSelect');
                if (!clientDropdown?.value) {
                    showNotification(' Please select a client before booking', 'error');
                    return;
                }

                const appointmentRows = document.querySelectorAll('.multi-appointment-row');
                if (appointmentRows.length === 0) {
                    showNotification(' Please add at least one appointment', 'error');
                    return;
                }

                const appointments = [];
                appointmentRows.forEach(row => {
                    const serviceSelect = row.querySelector('.service-select');
                    const staffSelect = row.querySelector('.staff-select');
                    const dateInput = row.querySelector('.appointment-date');
                    const startTimeInput = row.querySelector('.start-time-24h'); // Use hidden 24h input
                    const endTimeInput = row.querySelector('.end-time-24h');     // Use hidden 24h input
                    const notesTextarea = document.getElementById('multiNotes');

                    // Ensure to get the text of the selected option for names
                    const staffOption = staffSelect.options[staffSelect.selectedIndex];
                    const serviceOption = serviceSelect.options[serviceSelect.selectedIndex];

                    appointments.push({
                        client_name: clientDropdown.options[clientDropdown.selectedIndex].text.split(' - ')[0],
                        client_phone: clientDropdown.selectedOptions[0]?.dataset.phone || '', // Use optional chaining
                        client_email: clientDropdown.selectedOptions[0]?.dataset.email || '', // Use optional chaining
                        staff_id: staffSelect.value,
                        staff_name: staffOption ? staffOption.text : '',
                        service_id: serviceSelect.value,
                        service_name: serviceOption ? serviceOption.text.split(' (')[0].trim() : '',
                        service_duration: parseInt(serviceOption.dataset.duration) || 60,
                        service_price: parseFloat(serviceOption.dataset.price) || 0,
                        appointment_date: dateInput.value,
                        start_time: startTimeInput.value,
                        end_time: endTimeInput.value,
                        notes: notesTextarea.value
                    });
                });

                const bookButton = document.getElementById('bookAllAppointments');
                if (bookButton) {
                    bookButton.disabled = true;
                    bookButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Booking...';
                }

                let successCount = 0;
                let errorMessages = [];

                for (let i = 0; i < appointments.length; i++) {
                    const appointment = appointments[i];
                    try {
                        const response = await fetch('/api/unaki/book-appointment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                client_name: appointment.client_name,
                                client_phone: appointment.client_phone,
                                client_email: appointment.client_email,
                                staff_id: parseInt(appointment.staff_id),
                                service_id: parseInt(appointment.service_id),
                                service_name: appointment.service_name,
                                service_duration: appointment.service_duration,
                                service_price: appointment.service_price,
                                appointment_date: appointment.appointment_date,
                                start_time: appointment.start_time,
                                end_time: appointment.end_time,
                                notes: appointment.notes
                            })
                        });

                        const result = await response.json();
                        if (result.success) {
                            successCount++;
                        } else {
                            errorMessages.push(` Appointment ${i + 1}: ${result.error || result.message || 'Unknown error'}`);
                        }
                    } catch (error) {
                        console.error(`Error booking appointment ${i + 1}:`, error);
                        errorMessages.push(` Appointment ${i + 1}: Network error`);
                    }
                }

                if (bookButton) {
                    bookButton.disabled = false;
                    bookButton.innerHTML = '<i class="fas fa-check-circle me-2"></i>Book All Appointments';
                }

                if (successCount === appointments.length) {
                    showNotification(` All ${successCount} appointment(s) booked successfully!`, 'success');
                    bootstrap.Modal.getInstance(document.getElementById('multiBookModal')).hide();
                    loadBookings();
                } else if (successCount > 0) {
                    showNotification(` ${successCount} of ${appointments.length} appointments booked.\n\nErrors:\n${errorMessages.join('\n')}`, 'warning');
                    loadBookings(); // Reload to show successful bookings
                } else {
                    showNotification(` Booking failed:\n${errorMessages.join('\n')}`, 'error');
                }
            }

            // ==========================================
            // NAVIGATION & UTILITIES
            // ==========================================
            function navigateDate(days) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() + days);
                window.location.href = `{{ url_for('unaki_booking') }}?date=${date.toISOString().split("T")[0]}`;
            }

            function navigateToToday() {
                window.location.href = `{{ url_for('unaki_booking') }}?date=${new Date().toISOString().split("T")[0]}`;
            }

            function refreshSchedule() {
                loadBookings();
                loadShiftSchedule();
                const btn = event.target.closest(".action-icon");
                if (btn) {
                    btn.style.transform = "rotate(360deg)";
                    setTimeout(() => btn.style.transform = "rotate(0deg)", 600);
                }
            }

            function handleSlotClick(event, staffId, hour, minute) {
                event.stopPropagation();
                const slot = event.currentTarget;
                const rect = slot.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                // Calculate minute offset based on click position within the slot
                const slotWidth = rect.width; // Width of the time slot (should be 140px)
                const timeFraction = clickX / slotWidth; // Fraction of the hour clicked
                const totalMinutes = Math.floor(timeFraction * 60); // Total minutes from the start of the hour
                const roundedMinutes = Math.floor(totalMinutes / 15) * 15; // Round to nearest 15 minutes

                const time = `${String(hour).padStart(2, "0")}:${String(roundedMinutes).padStart(2, "0")}`;

                openMultiBookModal();

                // Set values in the first appointment card
                const firstCard = document.querySelector('.appointment-card[data-appointment-index="0"]'); // Assuming first card has index 0 after reset
                if (firstCard) {
                    firstCard.querySelector(".staff-select").value = staffId;
                    firstCard.querySelector(".appointment-date").value = currentDate;

                    // Update start time dropdown
                    const startTimeSelect = firstCard.querySelector('.start-time-select');
                    if (startTimeSelect) {
                        // Find and select the correct option, then trigger change
                        const optionToSelect = Array.from(startTimeSelect.options).find(option => option.value === time);
                        if (optionToSelect) {
                            startTimeSelect.value = time;
                            // Manually trigger the onchange event to update hidden fields and end time
                            startTimeSelect.dispatchEvent(new Event('change'));
                        }
                    }
                }
            }

            function showLoading(show) {
                document.getElementById("loadingOverlay").classList.toggle("show", show);
            }

            function showNotification(message, type) {
                // Replace this with your actual toast implementation if available
                // For now, using alert for simplicity.
                alert(message);
            }

            function hideContextMenu() {
                if (window.appointmentContextMenu) {
                    window.appointmentContextMenu.hideContextMenu();
                }
            }

            function viewAppointmentDetails() {
                if (selectedAppointmentId && window.appointmentContextMenu) {
                    window.appointmentContextMenu.viewAppointment(selectedAppointmentId);
                }
            }

            function editAppointment() {
                if (selectedAppointmentId && window.appointmentContextMenu?.editAppointment) {
                    window.appointmentContextMenu.editAppointment(selectedAppointmentId);
                }
                hideContextMenu();
            }

            function cancelAppointment() {
                if (selectedAppointmentId && confirm("Are you sure you want to cancel this appointment?")) {
                    // Implement cancellation logic here
                    alert("Cancel appointment " + selectedAppointmentId);
                }
                hideContextMenu();
            }

            function saveEditedAppointment() {
                const appointmentId = document.getElementById('editAppointmentId').value;
                const serviceSelect = document.getElementById('editServiceSelect');
                const serviceId = serviceSelect.value;
                const serviceName = serviceSelect.selectedOptions[0]?.text.split(' (')[0].trim();
                const staffId = document.getElementById('editStaffSelect').value;
                const appointmentDate = document.getElementById('editAppointmentDate').value;
                const startTime = document.getElementById('editStartTime').value;
                const endTime = document.getElementById('editEndTime').value;
                const notes = document.getElementById('editNotes').value;
                const status = document.getElementById('editStatus').value;
                const paymentStatus = document.getElementById('editPaymentStatus').value;

                if (!serviceId || !staffId || !appointmentDate || !startTime || !endTime) {
                    showToast('Please fill all required fields', 'error');
                    return;
                }

                const updateData = {
                    service_id: parseInt(serviceId),
                    service_name: serviceName,
                    staff_id: parseInt(staffId),
                    appointment_date: appointmentDate,
                    start_time: startTime,
                    end_time: endTime,
                    notes: notes,
                    status: status,
                    payment_status: paymentStatus
                };

                console.log(' Saving appointment with payment status:', paymentStatus, 'and status:', status);

                fetch(`/api/unaki/bookings/${appointmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log(' Update response:', data);
                    if (data.success) {
                        showToast(data.message || 'Appointment updated successfully', 'success');

                        // Show special message if payment status changed to paid and completed
                        if (paymentStatus === 'paid' && status === 'completed') {
                            showToast('Payment marked as paid. Appointment will be hidden from view.', 'info');
                            // Force page reload after 1 second to ensure UI updates
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            bootstrap.Modal.getInstance(document.getElementById('editAppointmentModal')).hide();
                            loadBookings();
                        }
                    } else {
                        showToast(data.error || 'Failed to update appointment', 'error');
                    }
                })
                .catch(error => {
                    console.error(' Error updating appointment:', error);
                    showToast('Error updating appointment', 'error');
                });
            }

            function showEditModal(appointmentData) {
                console.log(' Showing edit appointment modal:', appointmentData);

                // Populate form fields
                document.getElementById('editAppointmentId').value = appointmentData.id;
                document.getElementById('editClientName').value = appointmentData.client_name;
                document.getElementById('editAppointmentDate').value = appointmentData.appointment_date;
                document.getElementById('editStartTime').value = appointmentData.start_time;
                document.getElementById('editEndTime').value = appointmentData.end_time;
                document.getElementById('editNotes').value = appointmentData.notes || '';

                // Set service dropdown
                const serviceSelect = document.getElementById('editServiceSelect');
                if (appointmentData.service_id) {
                    serviceSelect.value = appointmentData.service_id;
                    // Trigger change event to ensure end time is calculated if needed
                    serviceSelect.dispatchEvent(new Event('change'));
                }

                // Set staff dropdown
                const staffSelect = document.getElementById('editStaffSelect');
                staffSelect.value = appointmentData.staff_id;

                // Set status dropdown
                const statusSelect = document.getElementById('editStatus');
                statusSelect.value = appointmentData.status || 'scheduled';

                // Set payment status dropdown
                const paymentStatusSelect = document.getElementById('editPaymentStatus');
                paymentStatusSelect.value = appointmentData.payment_status || 'pending';

                // Show modal
                const editModal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
                editModal.show();

                // Update end time when service changes
                serviceSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const duration = parseInt(selectedOption.dataset.duration) || 60;
                    const startTime = document.getElementById('editStartTime').value;

                    if (startTime) {
                        const endTime = calculateEndTimeFromDuration(startTime, duration);
                        document.getElementById('editEndTime').value = endTime;
                    }
                });

                // Update end time when start time changes
                document.getElementById('editStartTime').addEventListener('change', function() {
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    const duration = parseInt(selectedOption.dataset.duration) || 60;
                    const endTime = calculateEndTimeFromDuration(this.value, duration);
                    document.getElementById('editEndTime').value = endTime;
                });
            }

            // Helper function to calculate end time based on start time and duration
            function calculateEndTimeFromDuration(startTime, durationMinutes) {
                const [hours, minutes] = startTime.split(':').map(Number);
                const startDate = new Date();
                startDate.setHours(hours, minutes, 0, 0);
                const endDate = new Date(startDate.getTime() + durationMinutes * 60000);
                return endDate.toTimeString().slice(0, 5);
            }

            // Helper function to show toast notifications (if you have a toast library integrated)
            function showToast(message, type = 'info') {
                // Replace this with your actual toast implementation
                console.log(`Toast (${type}): ${message}`);
                alert(`${type.toUpperCase()}: ${message}`);
            }

            // Initialize Book All button state on page load and when modal is shown/appointments added
            document.addEventListener('DOMContentLoaded', () => {
                updateBookAllButton(); // Initial state on page load

                // Re-validate when modal is shown
                const multiBookModal = document.getElementById('multiBookModal');
                if (multiBookModal) {
                    multiBookModal.addEventListener('shown.bs.modal', function() {
                        updateBookAllButton();
                        // Handle Select2 integration
                        console.log(' Multi-book modal shown, initializing dropdowns...');
                        initializeSearchableDropdowns();

                        // Ensure first card's time dropdown is populated
                        // Find the first card, which should have index 0 after reset
                        const firstCard = document.querySelector('.appointment-card[data-appointment-index="0"]');
                        if (firstCard) {
                            const startTimeSelect = firstCard.querySelector('.start-time-select');
                            // Check if the dropdown needs population (e.g., has only the default option)
                            if (startTimeSelect && startTimeSelect.options.length <= 1) {
                                console.log(' Re-populating start time dropdown on modal show');
                                populateTimeDropdown(startTimeSelect, '09:00');
                            }
                        }
                    });
                }

                // Re-validate when appointments are added
                const addAppointmentBtn = document.querySelector('.add-appointment-btn');
                if (addAppointmentBtn) {
                    addAppointmentBtn.addEventListener('click', function() {
                        // Use setTimeout to ensure the new appointment card is rendered before validation
                        setTimeout(() => {
                            updateBookAllButton();
                        }, 100);
                    });
                }
            });

            // Event delegation for dynamically added appointments
            document.getElementById('appointmentsContainer').addEventListener('change', function(e) {
                if (e.target.matches('.service-select, .staff-select, .appointment-date, .start-time-select')) { // Trigger on change of start time select
                    const appointmentCard = e.target.closest('.appointment-card');
                    if (appointmentCard) {
                        // Update end time if service or start time changed
                        if (e.target.matches('.service-select') || e.target.matches('.start-time-select')) {
                            updateAppointmentEndTime(appointmentCard);
                        }
                        // Re-check conflicts
                        const index = parseInt(appointmentCard.dataset.appointmentIndex);
                        checkConflicts(index);
                        updateSummary();
                        updateSubmitButton(); // Update button state after changes
                    }
                }
            });

             // Also trigger on input events for immediate feedback (e.g., time input)
            document.getElementById('appointmentsContainer').addEventListener('input', function(e) {
                if (e.target.matches('.time-hour, .time-minute, .time-period')) { // Listen to manual time inputs
                    const appointmentCard = e.target.closest('.appointment-card');
                    if (appointmentCard) {
                        const index = parseInt(appointmentCard.dataset.appointmentIndex);
                        const hourInput = appointmentCard.querySelector('.time-hour');
                        const minuteInput = appointmentCard.querySelector('.time-minute');
                        const periodSelect = appointmentCard.querySelector('.time-period');
                        const hiddenInput = appointmentCard.querySelector('.start-time-24h');

                        updateHiddenTimeInput(hourInput, minuteInput, periodSelect, hiddenInput);
                        updateAppointmentEndTime(appointmentCard);
                        updateSubmitButton(); // Update button state after changes
                    }
                }
            });

             // Sync 12-hour displays when page loads and after appointments are added/modified
            function syncAll12HourDisplays() {
                document.querySelectorAll('.appointment-card').forEach(card => {
                    const startTime24h = card.querySelector('.start-time-24h')?.value;
                    const endTime24h = card.querySelector('.end-time-24h')?.value;

                    // Update manual input fields for start time
                    if (startTime24h) {
                        const [h24, m] = startTime24h.split(':');
                        const hour24 = parseInt(h24);
                        const minute = parseInt(m);
                        const period = hour24 >= 12 ? 'PM' : 'AM';
                        const hour12 = hour24 % 12 || 12;

                        const hourInput = card.querySelector('.time-hour');
                        const minuteInput = card.querySelector('.time-minute');
                        const periodSelect = card.querySelector('.time-period');

                        if (hourInput) hourInput.value = hour12;
                        if (minuteInput) minuteInput.value = String(minute).padStart(2, '0'); // Ensure minute is two digits
                        if (periodSelect) periodSelect.value = period;
                    }

                    // Update visible end time display
                    const endTimeDisplay = card.querySelector('.end-time-display');
                    if (endTimeDisplay) {
                        endTimeDisplay.value = endTime24h ? convertTo12Hour(endTime24h) : '';
                    }
                });
            }
        </script>
    </body>
</html>