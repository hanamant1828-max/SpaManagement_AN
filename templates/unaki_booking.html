<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unaki Appointment Booking - Professional Spa Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .booking-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .booking-header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .booking-header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .booking-header p {
            color: #718096;
            font-size: 1.1rem;
        }

        /* Multiple Booking Section */
        .multiple-booking-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .client-search-section {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }

        .btn-secondary {
            background: #718096;
            color: white;
        }

        .client-info-display {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }

        .client-info-display h4 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .booking-services-section {
            margin-top: 30px;
        }

        .service-booking-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .service-booking-item.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .remove-service-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f56565;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
        }

        .row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .col-md-3, .col-md-4, .col-md-6 {
            flex: 1;
            min-width: 200px;
        }

        .add-service-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .booking-summary {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .total-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: #2d3748;
            padding: 10px 0;
            border-top: 2px solid #e2e8f0;
        }

        /* Schedule Grid Styles */
        .schedule-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-top: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .date-selector {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 220px repeat(60, 25px);
            border: 3px solid #2d3748;
            border-radius: 12px;
            overflow: hidden;
            min-width: 1820px;
        }

        .grid-header {
            background: #2d3748;
            color: white;
            padding: 12px;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            border-right: 1px solid #4a5568;
        }

        .time-header {
            background: #4a5568;
            color: white;
            padding: 8px 4px;
            font-size: 0.7rem;
            text-align: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            border-right: 1px solid #667eea;
        }

        .time-header.hour-mark {
            background: #2d3748;
            font-weight: 600;
            border-right: 2px solid #667eea;
        }

        .time-header.half-hour {
            background: #718096;
            border-right: 1px solid #a0aec0;
        }

        .staff-cell {
            background: #2d3748;
            color: white;
            padding: 15px 10px;
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 1px solid #4a5568;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .time-slot {
            min-height: 60px;
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            position: relative;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .time-slot:hover {
            background: #e3f2fd;
        }

        .time-slot.available {
            background: #f0fff4;
        }

        .time-slot.available:hover {
            background: #c6f6d5;
        }

        .appointment-block {
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 10;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .break-block {
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 10;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }

        .alert-warning {
            background: #fffbeb;
            border: 1px solid #fbd38d;
            color: #744210;
        }

        .alert-info {
            background: #ebf8ff;
            border: 1px solid #90cdf4;
            color: #2c5282;
        }

        @media (max-width: 768px) {
            .booking-header h1 {
                font-size: 2rem;
            }

            .row {
                flex-direction: column;
            }

            .schedule-grid {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="booking-container">
        <!-- Header -->
        <div class="booking-header">
            <h1>ðŸŒ¸ Unaki Spa Booking System</h1>
            <p>Professional appointment scheduling with multiple service bookings</p>
        </div>

        <!-- Multiple Booking Section -->
        <div class="multiple-booking-section">
            <h2 class="section-title">
                <i class="fas fa-calendar-plus"></i>
                Multiple Service Booking
            </h2>

            <!-- Client Search Section -->
            <div class="client-search-section">
                <h3 style="margin-bottom: 15px; color: #2d3748;">
                    <i class="fas fa-search"></i>
                    Find Client by Phone Number
                </h3>

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="clientPhone">Phone Number</label>
                            <input type="tel" id="clientPhone" class="form-control" placeholder="Enter client phone number" maxlength="15">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-primary" onclick="searchClient()" style="width: 100%;">
                                <i class="fas fa-search"></i> Search Client
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-success" onclick="showAddClientModal()" style="width: 100%;">
                                <i class="fas fa-user-plus"></i> Add New Client
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Client Info Display -->
                <div id="clientInfoDisplay" class="client-info-display" style="display: none;">
                    <h4><i class="fas fa-user"></i> Client Information</h4>
                    <div id="clientDetails"></div>
                </div>
            </div>

            <!-- Booking Services Section -->
            <div class="booking-services-section">
                <h3 style="margin-bottom: 20px; color: #2d3748;">
                    <i class="fas fa-spa"></i>
                    Service Bookings
                </h3>

                <button type="button" class="add-service-btn" onclick="addServiceBooking()">
                    <i class="fas fa-plus"></i> Add Service Booking
                </button>

                <div id="serviceBookingsContainer">
                    <!-- Service booking items will be added here -->
                </div>

                <!-- Booking Summary -->
                <div class="booking-summary" id="bookingSummary" style="display: none;">
                    <h4 style="margin-bottom: 15px; color: #2d3748;">
                        <i class="fas fa-receipt"></i>
                        Booking Summary
                    </h4>
                    <div id="summaryDetails"></div>
                    <div class="total-info">
                        <span>Total Duration:</span>
                        <span id="totalDuration">0 minutes</span>
                    </div>
                    <div class="total-info">
                        <span>Total Amount:</span>
                        <span id="totalAmount">â‚¹0</span>
                    </div>
                    <button type="button" class="btn btn-success" onclick="confirmAllBookings()" style="width: 100%; margin-top: 15px;">
                        <i class="fas fa-check"></i> Confirm All Bookings
                    </button>
                </div>
            </div>
        </div>

        <!-- Schedule Display -->
        <div class="schedule-container">
            <h2 class="section-title">
                <i class="fas fa-calendar-alt"></i>
                Today's Schedule
            </h2>

            <!-- Date Selector -->
            <div class="date-selector">
                <label for="scheduleDate" style="font-weight: 600; color: #4a5568;">Select Date:</label>
                <input type="date" id="scheduleDate" class="form-control" style="width: 200px;" onchange="loadSchedule()">
                <button type="button" class="btn btn-secondary" onclick="goToToday()">
                    <i class="fas fa-calendar-day"></i> Today
                </button>
                <button type="button" class="btn btn-primary" onclick="loadSchedule()">
                    <i class="fas fa-sync"></i> Refresh Schedule
                </button>
            </div>

            <!-- Schedule Grid -->
            <div style="overflow-x: auto; padding-bottom: 10px;">
                <div id="scheduleGrid" class="schedule-grid" style="min-width: 1820px;">
                    <!-- Grid content will be generated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Client Modal -->
    <div class="modal fade" id="addClientModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus"></i>
                        Add New Client
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addClientForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="newClientFirstName">First Name *</label>
                                    <input type="text" id="newClientFirstName" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="newClientLastName">Last Name *</label>
                                    <input type="text" id="newClientLastName" class="form-control" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="newClientPhone">Phone Number *</label>
                            <input type="tel" id="newClientPhone" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="newClientEmail">Email</label>
                            <input type="email" id="newClientEmail" class="form-control">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="newClientGender">Gender</label>
                                    <select id="newClientGender" class="form-control">
                                        <option value="">Select Gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="newClientDOB">Date of Birth</label>
                                    <input type="date" id="newClientDOB" class="form-control">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addNewClient()">
                        <i class="fas fa-save"></i> Add Client
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let currentClient = null;
        let serviceBookings = [];
        let services = [];
        let staff = [];
        let scheduleData = {};

        // Initialize the system
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            setTodayDate();
            loadSchedule();
        });

        // Load initial data
        async function loadInitialData() {
            try {
                // Load services
                const servicesResponse = await fetch('/api/unaki/services');
                if (servicesResponse.ok) {
                    services = await servicesResponse.json();
                } else {
                     console.error('Failed to load services');
                     services = []; // Set to empty array if fetch fails
                }

                // Load staff
                const staffResponse = await fetch('/api/unaki/staff');
                if (staffResponse.ok) {
                    staff = await staffResponse.json();
                } else {
                    console.error('Failed to load staff');
                    staff = []; // Set to empty array if fetch fails
                }

                console.log('Loaded services:', services.length);
                console.log('Loaded staff:', staff.length);
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }

        // Set today's date in the date picker
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('scheduleDate').value = today;
        }

        // Go to today
        function goToToday() {
            setTodayDate();
            loadSchedule();
        }

        // Search client by phone number
        async function searchClient() {
            const phone = document.getElementById('clientPhone').value.trim();

            if (!phone) {
                alert('Please enter a phone number');
                return;
            }

            try {
                const response = await fetch(`/api/unaki/clients/search?phone=${encodeURIComponent(phone)}`);

                if (response.ok) {
                    const client = await response.json();
                    currentClient = client;
                    displayClientInfo(client);
                } else if (response.status === 404) {
                    currentClient = null;
                    document.getElementById('clientInfoDisplay').style.display = 'none';
                    alert('Client not found. Please add a new client.');
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error searching client:', error);
                alert('Error searching for client. Please try again.');
            }
        }

        // Display client information
        function displayClientInfo(client) {
            const display = document.getElementById('clientInfoDisplay');
            const details = document.getElementById('clientDetails');

            details.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <strong>Name:</strong><br>
                        ${client.first_name} ${client.last_name}
                    </div>
                    <div class="col-md-4">
                        <strong>Phone:</strong><br>
                        ${client.phone}
                    </div>
                    <div class="col-md-4">
                        <strong>Email:</strong><br>
                        ${client.email || 'Not provided'}
                    </div>
                </div>
            `;

            display.style.display = 'block';
        }

        // Show add client modal
        function showAddClientModal() {
            const phone = document.getElementById('clientPhone').value.trim();
            if (phone) {
                document.getElementById('newClientPhone').value = phone;
            }

            const modal = new bootstrap.Modal(document.getElementById('addClientModal'));
            modal.show();
        }

        // Add new client
        async function addNewClient() {
            const formData = {
                first_name: document.getElementById('newClientFirstName').value.trim(),
                last_name: document.getElementById('newClientLastName').value.trim(),
                phone: document.getElementById('newClientPhone').value.trim(),
                email: document.getElementById('newClientEmail').value.trim(),
                gender: document.getElementById('newClientGender').value,
                date_of_birth: document.getElementById('newClientDOB').value
            };

            if (!formData.first_name || !formData.last_name || !formData.phone) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const response = await fetch('/api/unaki/clients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const newClient = await response.json();
                    currentClient = newClient;
                    document.getElementById('clientPhone').value = newClient.phone;
                    displayClientInfo(newClient);

                    // Close modal and reset form
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addClientModal'));
                    modal.hide();
                    document.getElementById('addClientForm').reset();

                    alert('Client added successfully!');
                } else {
                    const error = await response.json();
                    alert('Error adding client: ' + error.message);
                }
            } catch (error) {
                console.error('Error adding client:', error);
                alert('Error adding client. Please try again.');
            }
        }

        // Add service booking
        function addServiceBooking() {
            if (!currentClient) {
                alert('Please search and select a client first');
                return;
            }

            const bookingId = Date.now();
            const booking = {
                id: bookingId,
                service_id: '',
                staff_id: '',
                appointment_date: '',
                start_time: '',
                duration: 0,
                price: 0,
                notes: ''
            };

            serviceBookings.push(booking);
            renderServiceBooking(booking);
            updateBookingSummary();
        }

        // Render service booking form
        function renderServiceBooking(booking) {
            const container = document.getElementById('serviceBookingsContainer');

            const bookingDiv = document.createElement('div');
            bookingDiv.className = 'service-booking-item';
            bookingDiv.id = `booking-${booking.id}`;

            bookingDiv.innerHTML = `
                <button type="button" class="remove-service-btn" onclick="removeServiceBooking(${booking.id})">
                    <i class="fas fa-times"></i>
                </button>

                <h4 style="margin-bottom: 15px; color: #2d3748;">
                    <i class="fas fa-spa"></i>
                    Service Booking #${serviceBookings.length}
                </h4>

                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Select Service *</label>
                            <select class="form-control" onchange="updateServiceDetails(${booking.id}, this.value)">
                                <option value="">Choose Service</option>
                                ${services.map(service => `
                                    <option value="${service.id}" data-duration="${service.duration}" data-price="${service.price}">
                                        ${service.name} (${service.duration} min - â‚¹${service.price})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Select Staff *</label>
                            <select class="form-control" onchange="updateStaffSelection(${booking.id}, this.value)">
                                <option value="">Choose Staff</option>
                                ${staff.map(member => `
                                    <option value="${member.id}">
                                        ${member.name} - ${member.specialty}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Date *</label>
                            <input type="date" class="form-control" onchange="updateBookingDate(${booking.id}, this.value)">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Start Time *</label>
                            <input type="time" class="form-control" onchange="updateStartTime(${booking.id}, this.value)">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Duration</label>
                            <input type="number" class="form-control" id="duration-${booking.id}" readonly>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Price</label>
                            <input type="number" class="form-control" id="price-${booking.id}" readonly>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>End Time</label>
                            <input type="time" class="form-control" id="endtime-${booking.id}" readonly>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Notes</label>
                    <textarea class="form-control" rows="2" placeholder="Additional notes..." onchange="updateNotes(${booking.id}, this.value)"></textarea>
                </div>
            `;

            container.appendChild(bookingDiv);
        }

        // Update service details
        function updateServiceDetails(bookingId, serviceId) {
            const booking = serviceBookings.find(b => b.id === bookingId);
            if (!booking) return;

            booking.service_id = serviceId;

            if (serviceId) {
                const service = services.find(s => s.id == serviceId);
                if (service) {
                    booking.duration = service.duration;
                    booking.price = service.price;

                    document.getElementById(`duration-${bookingId}`).value = service.duration;
                    document.getElementById(`price-${bookingId}`).value = service.price;

                    updateEndTime(bookingId);
                }
            } else {
                // Reset duration and price if no service is selected
                booking.duration = 0;
                booking.price = 0;
                document.getElementById(`duration-${bookingId}`).value = '';
                document.getElementById(`price-${bookingId}`).value = '';
                document.getElementById(`endtime-${bookingId}`).value = '';
            }

            updateBookingSummary();
        }

        // Update staff selection
        function updateStaffSelection(bookingId, staffId) {
            const booking = serviceBookings.find(b => b.id === bookingId);
            if (booking) {
                booking.staff_id = staffId;
            }
        }

        // Update booking date
        function updateBookingDate(bookingId, date) {
            const booking = serviceBookings.find(b => b.id === bookingId);
            if (booking) {
                booking.appointment_date = date;
            }
        }

        // Update start time and calculate end time
        function updateStartTime(bookingId, startTime) {
            const booking = serviceBookings.find(b => b.id === bookingId);
            if (booking) {
                booking.start_time = startTime;
                updateEndTime(bookingId);
            }
        }

        // Update end time based on start time and duration
        function updateEndTime(bookingId) {
            const booking = serviceBookings.find(b => b.id === bookingId);
            if (!booking || !booking.start_time || !booking.duration) return;

            const [hours, minutes] = booking.start_time.split(':').map(Number);
            const startMinutes = hours * 60 + minutes;
            const endMinutes = startMinutes + booking.duration;

            const endHours = Math.floor(endMinutes / 60);
            const endMins = endMinutes % 60;

            const endTime = `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;
            document.getElementById(`endtime-${bookingId}`).value = endTime;
        }

        // Update notes
        function updateNotes(bookingId, notes) {
            const booking = serviceBookings.find(b => b.id === bookingId);
            if (booking) {
                booking.notes = notes;
            }
        }

        // Remove service booking
        function removeServiceBooking(bookingId) {
            serviceBookings = serviceBookings.filter(b => b.id !== bookingId);
            document.getElementById(`booking-${bookingId}`).remove();
            updateBookingSummary();
        }

        // Update booking summary
        function updateBookingSummary() {
            const summaryDiv = document.getElementById('bookingSummary');
            const summaryDetails = document.getElementById('summaryDetails');

            if (serviceBookings.length === 0) {
                summaryDiv.style.display = 'none';
                return;
            }

            let totalDuration = 0;
            let totalAmount = 0;
            let summaryHTML = '';

            serviceBookings.forEach((booking, index) => {
                const service = services.find(s => s.id == booking.service_id);
                const staffMember = staff.find(s => s.id == booking.staff_id);

                totalDuration += booking.duration;
                totalAmount += booking.price;

                summaryHTML += `
                    <div style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                        <strong>Service ${index + 1}:</strong>
                        ${service ? service.name : 'Not selected'}
                        ${staffMember ? `with ${staffMember.name}` : ''}
                        ${booking.appointment_date && booking.start_time ?
                            `on ${booking.appointment_date} at ${booking.start_time}` : ''}
                        (${booking.duration} min - â‚¹${booking.price})
                    </div>
                `;
            });

            summaryDetails.innerHTML = summaryHTML;
            document.getElementById('totalDuration').textContent = `${totalDuration} minutes`;
            document.getElementById('totalAmount').textContent = `â‚¹${totalAmount}`;

            summaryDiv.style.display = 'block';
        }

        // Confirm all bookings
        async function confirmAllBookings() {
            if (!currentClient) {
                alert('Please select a client first');
                return;
            }

            // Validate all bookings
            for (let booking of serviceBookings) {
                if (!booking.service_id || !booking.staff_id || !booking.appointment_date || !booking.start_time) {
                    alert('Please complete all required fields for all service bookings');
                    return;
                }
            }

            try {
                const bookingData = {
                    client_id: currentClient.id,
                    bookings: serviceBookings.map(booking => ({
                        service_id: booking.service_id,
                        staff_id: booking.staff_id,
                        appointment_date: booking.appointment_date,
                        start_time: booking.start_time,
                        duration: booking.duration,
                        price: booking.price,
                        notes: booking.notes
                    }))
                };

                const response = await fetch('/api/unaki/bookings/multiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Successfully booked ${result.booked_count} appointments!`);

                    // Reset form
                    serviceBookings = [];
                    document.getElementById('serviceBookingsContainer').innerHTML = '';
                    updateBookingSummary();
                    loadSchedule();
                } else {
                    const error = await response.json();
                    alert('Error booking appointments: ' + error.message);
                }
            } catch (error) {
                console.error('Error confirming bookings:', error);
                alert('Error confirming bookings. Please try again.');
            }
        }

        // Load and display schedule
        async function loadSchedule() {
            const selectedDate = document.getElementById('scheduleDate').value;

            try {
                const response = await fetch(`/api/unaki/schedule?date=${selectedDate}`);
                if (response.ok) {
                    scheduleData = await response.json();
                    renderScheduleGrid();
                } else {
                     console.error('Failed to load schedule');
                     scheduleData = { appointments: [], breaks: [] }; // Reset schedule data on error
                     renderScheduleGrid(); // Render empty grid
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
                scheduleData = { appointments: [], breaks: [] }; // Reset schedule data on error
                renderScheduleGrid(); // Render empty grid
            }
        }

        // Render schedule grid
        function renderScheduleGrid() {
            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';

            // Create time slots (10-minute intervals from 8 AM to 6 PM)
            const timeSlots = [];
            for (let hour = 8; hour < 18; hour++) {
                for (let minute = 0; minute < 60; minute += 10) {
                    timeSlots.push({
                        hour,
                        minute,
                        time: `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`
                    });
                }
            }

            // Header row for Staff / Time
            const headerCell = document.createElement('div');
            headerCell.className = 'grid-header';
            headerCell.textContent = 'Staff / Time';
            grid.appendChild(headerCell);

            // Time headers
            timeSlots.forEach((slot, index) => {
                const timeHeader = document.createElement('div');
                timeHeader.className = 'time-header';

                if (slot.minute === 0) {
                    timeHeader.classList.add('hour-mark');
                    timeHeader.textContent = `${slot.hour}:00`;
                } else if (slot.minute === 30) {
                    timeHeader.classList.add('half-hour');
                    timeHeader.textContent = ':30';
                } else {
                    timeHeader.textContent = `:${slot.minute}`;
                }
                grid.appendChild(timeHeader);
            });

            // Staff rows
            staff.forEach(staffMember => {
                // Staff name cell
                const staffCell = document.createElement('div');
                staffCell.className = 'staff-cell';
                staffCell.innerHTML = `
                    <div>${staffMember.name}</div>
                    <small>${staffMember.specialty}</small>
                `;
                grid.appendChild(staffCell);

                // Time slots for this staff member
                timeSlots.forEach(slot => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot available';
                    timeSlot.onclick = () => quickBook(staffMember.id, slot.time);

                    // Check for appointments or breaks
                    const appointment = findAppointmentAtTime(staffMember.id, slot.time);
                    const breakTime = findBreakAtTime(staffMember.id, slot.time);

                    if (appointment) {
                        const appointmentBlock = document.createElement('div');
                        appointmentBlock.className = 'appointment-block';
                        appointmentBlock.textContent = `${appointment.client_name} - ${appointment.service}`;
                        appointmentBlock.title = `Client: ${appointment.client_name}\nService: ${appointment.service}\nTime: ${appointment.start_time} - ${appointment.end_time}`;
                        timeSlot.appendChild(appointmentBlock);
                        timeSlot.className = 'time-slot booked';
                    } else if (breakTime) {
                        const breakBlock = document.createElement('div');
                        breakBlock.className = 'break-block';
                        breakBlock.textContent = breakTime.break_type;
                        timeSlot.appendChild(breakBlock);
                        timeSlot.className = 'time-slot break';
                    } else {
                        // If no appointment or break, ensure it's marked as available
                        timeSlot.className = 'time-slot available';
                    }

                    grid.appendChild(timeSlot);
                });
            });
        }

        // Find appointment at specific time
        function findAppointmentAtTime(staffId, time) {
            if (!scheduleData || !scheduleData.appointments) return null;

            return scheduleData.appointments.find(apt =>
                apt.staff_id === staffId &&
                apt.start_time <= time &&
                apt.end_time > time
            );
        }

        // Find break at specific time
        function findBreakAtTime(staffId, time) {
            if (!scheduleData || !scheduleData.breaks) return null;

            return scheduleData.breaks.find(brk =>
                brk.staff_id === staffId &&
                brk.start_time <= time &&
                brk.end_time > time
            );
        }

        // Quick book function (clicking on time slot)
        function quickBook(staffId, time) {
            if (!currentClient) {
                alert('Please search and select a client first');
                return;
            }

            // Add a new service booking
            addServiceBooking();

            // Get the last added booking
            const lastBooking = serviceBookings[serviceBookings.length - 1];
            const bookingDiv = document.getElementById(`booking-${lastBooking.id}`);

            // Pre-fill staff and time
            const staffSelect = bookingDiv.querySelector('select[onchange*="updateStaffSelection"]');
            const timeInput = bookingDiv.querySelector('input[type="time"]');
            const dateInput = bookingDiv.querySelector('input[type="date"]');

            staffSelect.value = staffId;
            updateStaffSelection(lastBooking.id, staffId);

            timeInput.value = time;
            updateStartTime(lastBooking.id, time);

            const selectedDate = document.getElementById('scheduleDate').value;
            dateInput.value = selectedDate;
            updateBookingDate(lastBooking.id, selectedDate);

            // Scroll to the new booking
            bookingDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>