
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unaki Appointment Booking - Premium Timeline</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Bootstrap JavaScript Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    --primary-color: #4f46e5;
    --primary-hover: #4338ca;
    --success-color: #10b981;
    --danger-color: #ef4444;
    --warning-color: #f59e0b;
    --info-color: #06b6d4;
    --border-color: #e5e7eb;
    --hover-bg: #f9fafb;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    overflow: hidden;
    color: #1f2937;
}

/* Top Navigation Bar */
.calendar-top-nav {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 64px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    z-index: 100;
    box-shadow: var(--shadow-md);
}

.calendar-logo {
    font-size: 20px;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: flex;
    align-items: center;
    gap: 10px;
}

.calendar-logo i {
    -webkit-text-fill-color: #667eea;
}

.calendar-date-nav {
    display: flex;
    align-items: center;
    gap: 16px;
    background: white;
    padding: 8px 12px;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
}

.date-nav-btn {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    border: none;
    background: var(--hover-bg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    color: #6b7280;
}

.date-nav-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: scale(1.05);
}

.date-nav-btn:active {
    transform: scale(0.95);
}

.current-date-display {
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
    min-width: 220px;
    text-align: center;
}

.date-today-btn {
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid var(--border-color);
    background: white;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    color: #6b7280;
}

.date-today-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.calendar-actions {
    display: flex;
    align-items: center;
    gap: 10px;
}

.action-btn {
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.action-btn-primary {
    background: var(--primary-color);
    color: white;
    box-shadow: var(--shadow-md);
}

.action-btn-primary:hover {
    background: var(--primary-hover);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.action-btn-primary:active {
    transform: translateY(0);
}

.action-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    color: #6b7280;
}

.action-icon:hover {
    background: var(--hover-bg);
    color: var(--primary-color);
    transform: scale(1.05);
}

/* Main Layout */
.calendar-main-layout {
    position: fixed;
    top: 64px;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    background: white;
    overflow: hidden;
    margin: 12px;
    border-radius: 16px;
    box-shadow: var(--shadow-xl);
    position: relative;
}

/* Horizontal alignment guides */
.calendar-main-layout::before {
    content: '';
    position: absolute;
    top: 60px; /* Account for timeline header */
    left: 0;
    right: 0;
    bottom: 0;
    background-image: repeating-linear-gradient(
        to bottom,
        transparent 0,
        transparent 109px,
        rgba(79, 70, 229, 0.08) 109px,
        rgba(79, 70, 229, 0.08) 110px
    );
    pointer-events: none;
    z-index: 1;
}

/* Staff Sidebar */
.staff-sidebar {
    width: 280px;
    flex-shrink: 0;
    background: #ffffff;
    border-right: 2px solid var(--border-color);
    overflow-y: auto;
    overflow-x: hidden;
    position: relative;
    z-index: 2;
}

.staff-sidebar-header {
    height: 60px;
    background: white;
    border-bottom: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    font-weight: 700;
    font-size: 14px;
    color: #1f2937;
    position: sticky;
    top: 0;
    z-index: 10;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.staff-count {
    background: var(--primary-color);
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.staff-row {
    height: 110px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    padding: 16px 20px;
    gap: 14px;
    cursor: pointer;
    transition: all 0.3s;
    background: #ffffff;
    margin: 0;
    border-radius: 0;
    box-shadow: none;
}

.staff-row:nth-of-type(odd) {
    background: #fafbfc;
}

.staff-row:nth-of-type(even) {
    background: #ffffff;
}

.staff-row:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    transform: none;
    box-shadow: none;
}

.staff-row:hover .staff-avatar {
    transform: scale(1.1);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
}

.staff-row:hover .staff-name,
.staff-row:hover .staff-role,
.staff-row:hover .staff-status {
    color: white;
}

.staff-avatar {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 20px;
    flex-shrink: 0;
    transition: all 0.3s;
    box-shadow: var(--shadow-md);
}

.staff-info {
    flex: 1;
    min-width: 0;
}

.staff-name {
    font-size: 15px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.staff-role {
    font-size: 13px;
    color: #6b7280;
    margin-bottom: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.staff-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    font-weight: 500;
    color: var(--success-color);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success-color);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Timeline Panel */
.timeline-panel {
    flex: 1;
    overflow: auto;
    background: #ffffff;
    position: relative;
    z-index: 2;
}

.timeline-header {
    height: 60px;
    background: white;
    border-bottom: 2px solid var(--border-color);
    display: flex;
    position: sticky;
    top: 0;
    z-index: 9;
    box-shadow: 0 2px 4px rgba(0,0,0,0.03);
}

.timeline-hour {
    min-width: 140px;
    flex-shrink: 0;
    border-right: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 13px;
    color: #1f2937;
    transition: all 0.2s;
}

.timeline-hour:hover {
    background: var(--hover-bg);
}

.hour-label {
    font-size: 14px;
    font-weight: 700;
}

.hour-period {
    font-size: 11px;
    color: #9ca3af;
    margin-top: 2px;
}

/* Timeline Grid */
.timeline-grid {
    position: relative;
    min-width: max-content;
}

.timeline-row {
    height: 110px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    position: relative;
    transition: background 0.2s;
}

.timeline-row:nth-child(odd) {
    background: #fafbfc;
}

.timeline-row:nth-child(even) {
    background: #ffffff;
}

.timeline-row:hover {
    background: rgba(79, 70, 229, 0.02);
}

.timeline-hour-slot {
    min-width: 140px;
    flex-shrink: 0;
    position: relative;
    background: transparent;
    border-right: 1px solid #e5e7eb;
    cursor: pointer;
    transition: all 0.2s;
}

.timeline-hour-slot:hover {
    background: linear-gradient(to bottom, rgba(79, 70, 229, 0.03), rgba(79, 70, 229, 0.05));
}

.timeline-hour-slot:hover::after {
    content: '+';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: var(--primary-color);
    font-weight: 600;
    opacity: 0.3;
}

/* 15-minute interval lines */
.interval-marker {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 1px;
    background: #f3f4f6;
}

.interval-15 { left: 25%; }
.interval-30 { left: 50%; background: #e5e7eb; }
.interval-45 { left: 75%; }

/* Appointment Block */
.appointment-block {
    position: absolute;
    top: 8px;
    bottom: 8px;
    border-radius: 10px;
    border-left: 4px solid;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    padding: 12px;
    cursor: move;
    transition: all 0.2s;
    overflow: hidden;
    z-index: 5;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    -webkit-tap-highlight-color: rgba(0,0,0,0.1);
    user-select: none;
}

.appointment-block:hover {
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    transform: translateY(-2px) scale(1.02);
    z-index: 10;
}

.appointment-block:active {
    transform: scale(0.98);
}

/* Mobile touch indicator */
@media (max-width: 768px) {
    .appointment-block::after {
        content: 'âœŽ';
        position: absolute;
        top: 4px;
        right: 4px;
        font-size: 10px;
        color: rgba(0,0,0,0.3);
        pointer-events: none;
    }
    
    .appointment-block {
        cursor: pointer;
    }
}

.appointment-block.dragging {
    opacity: 0.6;
    cursor: grabbing;
    z-index: 100;
}

.appointment-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 8px;
}

.appointment-client {
    font-size: 14px;
    font-weight: 700;
    color: #1f2937;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
}

.appointment-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success-color);
    flex-shrink: 0;
    margin-left: 8px;
}

.appointment-service {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 6px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.appointment-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: auto;
}

.appointment-time {
    font-size: 11px;
    font-weight: 600;
    color: #9ca3af;
    display: flex;
    align-items: center;
    gap: 4px;
}

.appointment-duration {
    font-size: 10px;
    background: rgba(0,0,0,0.05);
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
}

/* Service type colors - More vibrant */
.service-massage { 
    border-left-color: #3b82f6; 
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
}
.service-facial { 
    border-left-color: #a855f7; 
    background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
}
.service-manicure { 
    border-left-color: #f43f5e; 
    background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
}
.service-pedicure { 
    border-left-color: #78350f; 
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
}
.service-haircut { 
    border-left-color: #22c55e; 
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
}
.service-waxing { 
    border-left-color: #f97316; 
    background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);
}
.service-default { 
    border-left-color: #6b7280; 
    background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
}

/* Current Time Indicator */
.current-time-line {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--danger-color);
    z-index: 20;
    pointer-events: none;
    box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
}

.current-time-line::before {
    content: '';
    position: absolute;
    top: -6px;
    left: -6px;
    width: 14px;
    height: 14px;
    background: var(--danger-color);
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    animation: currentTimePulse 2s infinite;
}

.current-time-label {
    position: absolute;
    top: 16px;
    left: 6px;
    background: var(--danger-color);
    color: white;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    white-space: nowrap;
    box-shadow: var(--shadow-md);
}

@keyframes currentTimePulse {
    0%, 100% { 
        transform: scale(1);
        opacity: 1;
    }
    50% { 
        transform: scale(1.2);
        opacity: 0.8;
    }
}

/* Context Menu - Enhanced */
.context-menu {
    position: fixed;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 12px;
    box-shadow: var(--shadow-xl);
    padding: 8px;
    min-width: 220px;
    z-index: 1000;
    display: none;
    animation: contextMenuFadeIn 0.2s ease;
}

@keyframes contextMenuFadeIn {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.context-menu.show {
    display: block;
}

.context-menu-item {
    padding: 12px 16px;
    cursor: pointer;
    font-size: 14px;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
    border-radius: 8px;
    font-weight: 500;
}

.context-menu-item:hover {
    background: var(--hover-bg);
    color: var(--primary-color);
    transform: translateX(4px);
}

.context-menu-item i {
    width: 18px;
    text-align: center;
}

.context-menu-divider {
    height: 1px;
    background: var(--border-color);
    margin: 8px 0;
}

.context-menu-item.danger:hover {
    background: #fee;
    color: var(--danger-color);
}

/* Multiple Appointments Section */
.appointments-container {
    max-height: 400px;
    overflow-y: auto;
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 16px;
    background: #fafbfc;
}

.appointment-card {
    background: white;
    border: 2px solid transparent;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s;
    position: relative;
}

.appointment-card:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.appointment-card.duplicate {
    border-color: var(--warning-color);
    background: #fffbeb;
}

.appointment-number {
    position: absolute;
    top: -8px;
    left: 16px;
    background: var(--primary-color);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
}

.remove-appointment {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: var(--danger-color);
    color: white;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.remove-appointment:hover {
    background: #dc2626;
    transform: scale(1.1);
}

.add-appointment-btn {
    width: 100%;
    padding: 12px;
    border: 2px dashed var(--primary-color);
    background: transparent;
    color: var(--primary-color);
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.add-appointment-btn:hover {
    background: var(--primary-color);
    color: white;
    transform: scale(1.02);
}

/* Tooltip */
.tooltip-custom {
    position: fixed;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    z-index: 10000;
    pointer-events: none;
    display: none;
    white-space: nowrap;
    box-shadow: var(--shadow-lg);
}

.tooltip-custom.show {
    display: block;
    animation: tooltipFadeIn 0.2s ease;
}

@keyframes tooltipFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* Loading State */
.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 50;
    backdrop-filter: blur(5px);
}

.loading-overlay.show {
    display: flex;
}

.spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #e5e7eb;
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Scrollbar Styling */
::-webkit-scrollbar {
    width: 12px;
    height: 12px;
}

::-webkit-scrollbar-track {
    background: #f3f4f6;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 10px;
    border: 2px solid #f3f4f6;
}

::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
}

/* Empty State */
.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: #9ca3af;
    padding: 60px 40px;
    text-align: center;
}

.empty-state i {
    font-size: 64px;
    margin-bottom: 20px;
    opacity: 0.3;
}

.empty-state h3 {
    font-size: 18px;
    font-weight: 600;
    color: #4b5563;
    margin-bottom: 8px;
}

.empty-state p {
    font-size: 14px;
    color: #9ca3af;
    margin: 0;
}

/* Quick Stats Bar */
.quick-stats {
    display: flex;
    gap: 8px;
    padding: 12px 20px;
    background: white;
    border-bottom: 1px solid var(--border-color);
}

.stat-card {
    flex: 1;
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    padding: 12px 16px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
}

.stat-info h4 {
    font-size: 20px;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
}

.stat-info p {
    font-size: 12px;
    color: #6b7280;
    margin: 0;
}

/* Responsive */
@media (max-width: 1024px) {
    .staff-sidebar {
        width: 240px;
    }

    .timeline-hour {
        min-width: 110px;
    }

    .timeline-hour-slot {
        min-width: 110px;
    }
}

@media (max-width: 768px) {
    .calendar-main-layout {
        margin: 8px;
        border-radius: 12px;
    }

    .staff-sidebar {
        width: 200px;
    }

    .timeline-hour {
        min-width: 90px;
    }

    .timeline-hour-slot {
        min-width: 90px;
    }

    .staff-row {
        height: 90px;
        padding: 12px;
    }

    .staff-avatar {
        width: 48px;
        height: 48px;
        font-size: 18px;
    }

    .calendar-logo span {
        display: none;
    }

    .current-date-display {
        min-width: 150px;
        font-size: 13px;
    }

    /* Hide stats on mobile */
    .calendar-top-nav > div:nth-child(3) > div:first-child {
        display: none;
    }
    
    /* Mobile edit instructions */
    .calendar-main-layout::after {
        content: 'ðŸ’¡ Tap appointment to edit';
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        pointer-events: none;
        z-index: 1000;
        animation: fadeInOut 3s ease-in-out;
    }
    
    @keyframes fadeInOut {
        0%, 100% { opacity: 0; }
        10%, 90% { opacity: 1; }
    }
    
    /* Make modal full screen on mobile */
    .modal-dialog {
        margin: 0;
        max-width: 100%;
        height: 100%;
    }
    
    .modal-content {
        height: 100%;
        border-radius: 0 !important;
    }
}
    </style>
</head>
<body>
    <!-- Tooltip -->
    <div class="tooltip-custom" id="tooltip"></div>

    <div class="calendar-wrapper">
        <!-- Fixed Top Navigation -->
        <div class="calendar-top-nav">
            <div class="calendar-logo">
                <i class="fas fa-calendar-check"></i>
                <span>Unaki Booking</span>
            </div>

            <div class="calendar-date-nav">
                <button class="date-nav-btn" onclick="navigateDate(-1)" data-tooltip="Previous Day">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="date-today-btn" onclick="navigateToToday()" data-tooltip="Go to Today">
                    Today
                </button>
                <div class="current-date-display" id="currentDateDisplay">
                    {{ today_date }}
                </div>
                <button class="date-nav-btn" onclick="navigateDate(1)" data-tooltip="Next Day">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <div style="display: flex; align-items: center; gap: 16px;">
                <!-- Quick Stats in Top Bar -->
                <div style="display: flex; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border-radius: 10px; border: 1px solid var(--border-color);">
                        <i class="fas fa-calendar-check" style="color: var(--primary-color);"></i>
                        <div>
                            <div style="font-size: 16px; font-weight: 700; color: #1f2937;" id="totalBookings">0</div>
                            <div style="font-size: 10px; color: #6b7280;">Total</div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border-radius: 10px; border: 1px solid var(--border-color);">
                        <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                        <div>
                            <div style="font-size: 16px; font-weight: 700; color: #1f2937;" id="completedBookings">0</div>
                            <div style="font-size: 10px; color: #6b7280;">Done</div>
                        </div>
                    </div>
                </div>

                <div class="calendar-actions">
                    <button class="action-btn action-btn-primary" onclick="openMultiBookModal()">
                        <i class="fas fa-plus-circle"></i>
                        New Appointment
                    </button>
                    <button class="action-icon" onclick="refreshSchedule()" data-tooltip="Refresh Schedule">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="action-icon" data-tooltip="Back to Dashboard">
                        <i class="fas fa-home"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="calendar-main-layout">
            <!-- Staff Sidebar -->
            <div class="staff-sidebar">
                <!-- Header: 60px height -->
                <div class="staff-sidebar-header">
                    <span>Staff Members</span>
                    <span class="staff-count">{{ staff_members|length if staff_members else 0 }}</span>
                </div>

                <!-- Staff rows start here - each 110px height, matching timeline rows exactly -->
                <div class="staff-list">
                {% if staff_members %}
                {% for staff in staff_members %}
                <div class="staff-row staff-row-{{ loop.index }}" data-staff-id="{{ staff.id }}" data-tooltip="Click to filter by {{ staff.first_name }}">
                    <div class="staff-avatar">
                        {{ (staff.first_name[:1] + staff.last_name[:1]).upper() if staff.first_name and staff.last_name else staff.username[:2].upper() }}
                    </div>
                    <div class="staff-info">
                        <div class="staff-name">{{ staff.first_name }} {{ staff.last_name if staff.last_name else '' }}</div>
                        <div class="staff-role">{{ staff.role or 'Therapist' }}</div>
                        <div class="staff-status">
                            <span class="status-dot"></span>
                            Available
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-user-plus"></i>
                    <h3>No Staff Members</h3>
                    <p>Add staff members to start booking appointments</p>
                </div>
                {% endif %}
                </div>
            </div>

            <!-- Timeline Panel -->
            <div class="timeline-panel">
                <!-- Timeline Header: 60px height (matches staff header) -->
                <div class="timeline-header">
                    {% for hour in range(9, 22) %}
                    <div class="timeline-hour" data-tooltip="Click any slot to book">
                        <span class="hour-label">
                            {{ '%d:00' % hour if hour < 12 else ('12:00' if hour == 12 else '%d:00' % (hour - 12)) }}
                        </span>
                        <span class="hour-period">{{ 'AM' if hour < 12 else 'PM' }}</span>
                    </div>
                    {% endfor %}
                </div>

                <!-- Timeline Grid -->
                <!-- Each timeline-row is 110px height, perfectly matching each staff-row -->
                <div class="timeline-grid" id="timelineGrid">
                    {% if staff_members %}
                    {% for staff in staff_members %}
                    <div class="timeline-row" data-staff-id="{{ staff.id }}">
                        {% for hour in range(9, 22) %}
                        <div class="timeline-hour-slot" 
                             data-hour="{{ hour }}"
                             data-staff-id="{{ staff.id }}"
                             onclick="handleSlotClick(event, {{ staff.id }}, {{ hour }}, 0)">
                            <div class="interval-marker interval-15"></div>
                            <div class="interval-marker interval-30"></div>
                            <div class="interval-marker interval-45"></div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-calendar-plus"></i>
                        <h3>Ready to Start Booking</h3>
                        <p>Add staff members to begin scheduling appointments</p>
                    </div>
                    {% endif %}

                    <!-- Current Time Line -->
                    <div class="current-time-line" id="currentTimeLine" style="display: none;">
                        <div class="current-time-label" id="currentTimeLabel">Now</div>
                    </div>
                </div>

                <!-- Loading Overlay -->
                <div class="loading-overlay" id="loadingOverlay">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="viewAppointmentDetails()">
            <i class="fas fa-eye"></i>
            View Details
        </div>
        <div class="context-menu-item" onclick="editAppointment()">
            <i class="fas fa-edit"></i>
            Edit Appointment
        </div>
        <div class="context-menu-item" onclick="checkInAppointment()">
            <i class="fas fa-user-check"></i>
            Check In Client
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="duplicateAppointment()">
            <i class="fas fa-copy"></i>
            Duplicate
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" onclick="cancelAppointment()">
            <i class="fas fa-times-circle"></i>
            Cancel Appointment
        </div>
    </div>

    <!-- Edit Appointment Modal -->
    <div class="modal fade" id="editAppointmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: var(--shadow-xl); max-height: 90vh;">
                <div class="modal-header" style="border-bottom: 2px solid var(--border-color); padding: 20px 24px;">
                    <h5 class="modal-title" style="font-weight: 700; font-size: 18px;">
                        <i class="fas fa-edit me-2" style="color: var(--warning-color);"></i>
                        Edit Appointment
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <input type="hidden" id="editAppointmentId">
                    
                    <!-- Client Information -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-user me-2" style="color: var(--primary-color);"></i>
                                Client Name *
                            </label>
                            <input type="text" id="editClientName" class="form-control" readonly style="background: #f9fafb; border-radius: 10px; padding: 12px;">
                        </div>
                    </div>

                    <!-- Service and Staff -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-concierge-bell me-2" style="color: var(--primary-color);"></i>
                                Service *
                            </label>
                            <select id="editServiceSelect" class="form-select" required style="border-radius: 10px; padding: 12px;">
                                <option value="">Select service...</option>
                                {% if services %}
                                {% for service in services %}
                                    <option value="{{ service.id }}" 
                                            data-duration="{{ service.duration or 60 }}"
                                            data-price="{{ service.price }}">
                                        {{ service.name }} ({{ service.duration or 60 }} min - ${{ "%.2f"|format(service.price) }})
                                    </option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-user-md me-2" style="color: var(--primary-color);"></i>
                                Staff Member *
                            </label>
                            <select id="editStaffSelect" class="form-select" required style="border-radius: 10px; padding: 12px;">
                                <option value="">Select staff member...</option>
                                {% if staff_members %}
                                {% for staff in staff_members %}
                                    <option value="{{ staff.id }}">
                                        {{ staff.first_name }} {{ staff.last_name if staff.last_name else '' }}
                                    </option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </div>
                    </div>

                    <!-- Date and Time -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-calendar me-2" style="color: var(--primary-color);"></i>
                                Date *
                            </label>
                            <input type="date" id="editAppointmentDate" class="form-control" 
                                   required style="border-radius: 10px; padding: 12px;">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-clock me-2" style="color: var(--primary-color);"></i>
                                Start Time *
                            </label>
                            <input type="time" id="editStartTime" class="form-control" 
                                   required style="border-radius: 10px; padding: 12px;">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-clock me-2" style="color: var(--success-color);"></i>
                                End Time
                            </label>
                            <input type="time" id="editEndTime" class="form-control" readonly
                                   style="border-radius: 10px; padding: 12px; background: #f0fdf4; font-weight: 600; color: var(--success-color);">
                        </div>
                    </div>

                    <!-- Conflict Warning -->
                    <div id="editConflictAlert" class="alert alert-warning d-none" style="border-radius: 10px;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="editConflictMessage"></span>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-sticky-note me-2" style="color: var(--primary-color);"></i>
                            Notes
                        </label>
                        <textarea id="editNotes" class="form-control" rows="3" 
                                  placeholder="Add any special instructions or notes..."
                                  style="border-radius: 10px; padding: 12px;"></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 2px solid var(--border-color); padding: 16px 24px;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                            style="border-radius: 10px; padding: 10px 20px;">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveEditedAppointment()"
                            style="border-radius: 10px; padding: 10px 20px; background: var(--warning-color); border: none;">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Multi-Appointment Booking Modal -->
    <div class="modal fade" id="multiBookModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: var(--shadow-xl);">
                <div class="modal-header" style="border-bottom: 2px solid var(--border-color); padding: 20px 24px;">
                    <h5 class="modal-title" style="font-weight: 700; font-size: 18px;">
                        <i class="fas fa-calendar-plus me-2" style="color: var(--primary-color);"></i>
                        Book Multiple Appointments
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="padding: 24px;">
                    <!-- Client Information Section -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-user me-2" style="color: var(--primary-color);"></i>
                                Select Client *
                            </label>
                            <select id="multiClientSelect" class="form-select" required style="border-radius: 10px; padding: 12px;">
                                <option value="">Choose a client...</option>
                                {% if clients %}
                                {% for client in clients %}
                                <option value="{{ client.id }}" 
                                        data-phone="{{ client.phone }}" 
                                        data-email="{{ client.email or '' }}">
                                    {{ client.first_name }} {{ client.last_name }} - {{ client.phone }}
                                </option>
                                {% endfor %}
                                {% endif %}
                            </select>
                            <small class="text-muted mt-1 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Select from existing clients or <a href="{{ url_for('customers') }}" target="_blank">add a new client</a>
                            </small>
                        </div>
                    </div>

                    <!-- Appointments Section -->
                    <div class="mb-4">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <label class="form-label fw-semibold mb-0" style="font-size: 16px;">
                                <i class="fas fa-calendar-alt me-2" style="color: var(--primary-color);"></i>
                                Appointments
                            </label>
                            <span id="appointmentCount" style="background: var(--primary-color); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                1 Appointment
                            </span>
                        </div>
                        
                        <div class="appointments-container" id="appointmentsContainer">
                            <!-- First appointment card (template) -->
                            <div class="appointment-card" data-appointment-index="0">
                                <div class="appointment-number">1</div>
                                <button type="button" class="remove-appointment d-none" onclick="removeAppointment(0)">
                                    <i class="fas fa-times"></i>
                                </button>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-concierge-bell me-2" style="color: var(--primary-color);"></i>
                                            Service *
                                        </label>
                                        <select class="form-select service-select" required style="border-radius: 10px; padding: 12px;">
                                            <option value="">Select service...</option>
                                            {% if services %}
                                            {% for service in services %}
                                                <option value="{{ service.id }}" 
                                                        data-duration="{{ service.duration or 60 }}"
                                                        data-price="{{ service.price }}">
                                                    {{ service.name }} ({{ service.duration or 60 }} min - ${{ "%.2f"|format(service.price) }})
                                                </option>
                                            {% endfor %}
                                            {% endif %}
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-user-md me-2" style="color: var(--primary-color);"></i>
                                            Staff Member *
                                        </label>
                                        <select class="form-select staff-select" required style="border-radius: 10px; padding: 12px;">
                                            <option value="">Select staff member...</option>
                                            {% if staff_members %}
                                            {% for staff in staff_members %}
                                                <option value="{{ staff.id }}">
                                                    {{ staff.first_name }} {{ staff.last_name if staff.last_name else '' }}
                                                </option>
                                            {% endfor %}
                                            {% endif %}
                                        </select>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-calendar me-2" style="color: var(--primary-color);"></i>
                                            Date *
                                        </label>
                                        <input type="date" class="form-control appointment-date" 
                                               value="{{ today }}" required style="border-radius: 10px; padding: 12px;">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-clock me-2" style="color: var(--primary-color);"></i>
                                            Start Time *
                                        </label>
                                        <input type="time" class="form-control start-time" 
                                               value="09:00" required style="border-radius: 10px; padding: 12px;">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-clock me-2" style="color: var(--success-color);"></i>
                                            End Time
                                        </label>
                                        <input type="time" class="form-control end-time" readonly
                                               style="border-radius: 10px; padding: 12px; background: #f0fdf4; font-weight: 600; color: var(--success-color);">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-12">
                                        <div id="conflictAlert0" class="alert alert-warning d-none" style="border-radius: 10px;">
                                            <i class="fas fa-exclamation-triangle me-2"></i>
                                            <span class="conflict-message"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Add Another Appointment Button -->
                        <button type="button" class="add-appointment-btn" onclick="addAppointment()">
                            <i class="fas fa-plus-circle"></i>
                            Add Another Appointment
                        </button>
                    </div>

                    <!-- Summary Section -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 16px; border-radius: 10px;">
                                <label class="form-label fw-semibold" style="color: #1e40af; margin-bottom: 8px;">
                                    <i class="fas fa-hourglass-half me-2"></i>
                                    Total Duration
                                </label>
                                <div style="font-size: 28px; font-weight: 700; color: #1e40af;" id="multiTotalDuration">
                                    0 min
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 16px; border-radius: 10px;">
                                <label class="form-label fw-semibold" style="color: #065f46; margin-bottom: 8px;">
                                    <i class="fas fa-dollar-sign me-2"></i>
                                    Total Price
                                </label>
                                <div style="font-size: 28px; font-weight: 700; color: #065f46;" id="multiTotalPrice">
                                    $0.00
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 16px; border-radius: 10px;">
                                <label class="form-label fw-semibold" style="color: #78350f; margin-bottom: 8px;">
                                    <i class="fas fa-users me-2"></i>
                                    Staff Required
                                </label>
                                <div style="font-size: 28px; font-weight: 700; color: #78350f;" id="multiStaffCount">
                                    0
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="fas fa-sticky-note me-2" style="color: var(--primary-color);"></i>
                            Notes
                        </label>
                        <textarea id="multiNotes" class="form-control" rows="3" 
                                  placeholder="Add any special instructions or notes for all appointments..."
                                  style="border-radius: 10px; padding: 12px;"></textarea>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 2px solid var(--border-color); padding: 16px 24px;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                            style="border-radius: 10px; padding: 10px 20px;">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="processMultiBooking()"
                            style="border-radius: 10px; padding: 10px 20px; background: var(--primary-color); border: none;">
                        <i class="fas fa-check-circle me-2"></i>Book All Appointments
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
// Global variables
let selectedAppointmentId = null;
const currentDate = '{{ today }}';
let bookingsData = [];
let appointmentCounter = 1;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBookings();
    updateCurrentTimeLine();
    setInterval(updateCurrentTimeLine, 60000);
    setupTooltips();
    setupEventListeners();

    document.addEventListener('click', function() {
        hideContextMenu();
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'n' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            openMultiBookModal();
        }
        if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            refreshSchedule();
        }
    });
});

// Setup event listeners
function setupEventListeners() {
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('service-select') || 
            e.target.classList.contains('start-time') ||
            e.target.classList.contains('appointment-date') ||
            e.target.classList.contains('staff-select')) {
            
            const appointmentCard = e.target.closest('.appointment-card');
            if (appointmentCard) {
                const index = parseInt(appointmentCard.dataset.appointmentIndex);
                calculateEndTime(index);
                checkConflicts(index);
                updateSummary();
            }
        }
    });
}

// Setup tooltips
function setupTooltips() {
    const tooltip = document.getElementById('tooltip');
    const elementsWithTooltip = document.querySelectorAll('[data-tooltip]');

    elementsWithTooltip.forEach(element => {
        element.addEventListener('mouseenter', function(e) {
            const text = this.getAttribute('data-tooltip');
            tooltip.textContent = text;
            tooltip.classList.add('show');

            const rect = this.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
            tooltip.style.top = (rect.bottom + 8) + 'px';
        });

        element.addEventListener('mouseleave', function() {
            tooltip.classList.remove('show');
        });
    });
}

// Load bookings
function loadBookings() {
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.add('show');

    fetch('/api/unaki/get-bookings?date=' + currentDate)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bookingsData = data.bookings || [];
                renderBookings();
                updateStats();
            }
        })
        .catch(error => {
            console.error('Error loading bookings:', error);
        })
        .finally(() => {
            overlay.classList.remove('show');
        });
}

// Update stats
function updateStats() {
    const total = bookingsData.length;
    const completed = bookingsData.filter(b => b.status === 'completed').length;

    document.getElementById('totalBookings').textContent = total;
    document.getElementById('completedBookings').textContent = completed;
}

// Render bookings
function renderBookings() {
    document.querySelectorAll('.appointment-block').forEach(el => el.remove());

    bookingsData.forEach(booking => {
        const row = document.querySelector(`.timeline-row[data-staff-id="${booking.staff_id}"]`);
        if (!row) return;

        const startHour = parseFloat(booking.start_hour);
        const startMinute = parseFloat(booking.start_minute);
        const hoursSince9AM = startHour - 9 + (startMinute / 60);
        const leftPosition = hoursSince9AM * 140;

        const durationHours = booking.duration / 60;
        const width = Math.max(durationHours * 140, 80);

        const serviceType = booking.service_type || 'default';

        const block = document.createElement('div');
        block.className = `appointment-block service-${serviceType}`;
        block.style.left = `${leftPosition}px`;
        block.style.width = `${width}px`;
        block.dataset.appointmentId = booking.id;
        block.draggable = true;

        block.onclick = () => viewAppointment(booking.id);
        block.oncontextmenu = (e) => { showContextMenu(e, booking.id); return false; };

        // Drag events
        block.ondragstart = (e) => {
            block.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('appointmentId', booking.id);
        };

        block.ondragend = () => {
            block.classList.remove('dragging');
        };

        block.innerHTML = `
            <div class="appointment-header">
                <div class="appointment-client">${booking.client_name}</div>
                <div class="appointment-status"></div>
            </div>
            <div class="appointment-service">${booking.service_names}</div>
            <div class="appointment-footer">
                <div class="appointment-time">
                    <i class="fas fa-clock"></i>
                    ${booking.start_time}
                </div>
                <div class="appointment-duration">${booking.duration}m</div>
            </div>
        `;

        row.appendChild(block);
    });
}

// Open multi-booking modal
function openMultiBookModal() {
    const modal = new bootstrap.Modal(document.getElementById('multiBookModal'));
    appointmentCounter = 1;
    resetMultiBookModal();
    modal.show();
}

// Reset modal to initial state
function resetMultiBookModal() {
    document.getElementById('multiClientSelect').value = '';
    document.getElementById('multiNotes').value = '';
    
    // Reset appointments container to single appointment
    const container = document.getElementById('appointmentsContainer');
    const firstCard = container.querySelector('.appointment-card');
    
    // Clear all cards except first
    container.querySelectorAll('.appointment-card:not(:first-child)').forEach(card => card.remove());
    
    // Reset first card
    if (firstCard) {
        firstCard.dataset.appointmentIndex = '0';
        firstCard.querySelector('.appointment-number').textContent = '1';
        firstCard.querySelector('.remove-appointment').classList.add('d-none');
        firstCard.querySelector('.service-select').value = '';
        firstCard.querySelector('.staff-select').value = '';
        firstCard.querySelector('.appointment-date').value = '{{ today }}';
        firstCard.querySelector('.start-time').value = '09:00';
        firstCard.querySelector('.end-time').value = '';
        firstCard.querySelector('.alert').classList.add('d-none');
    }
    
    updateAppointmentCount();
    updateSummary();
}

// Add new appointment
function addAppointment() {
    const container = document.getElementById('appointmentsContainer');
    const newIndex = appointmentCounter++;
    
    const appointmentCard = document.createElement('div');
    appointmentCard.className = 'appointment-card';
    appointmentCard.dataset.appointmentIndex = newIndex;
    
    appointmentCard.innerHTML = `
        <div class="appointment-number">${newIndex + 1}</div>
        <button type="button" class="remove-appointment" onclick="removeAppointment(${newIndex})">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">
                    <i class="fas fa-concierge-bell me-2" style="color: var(--primary-color);"></i>
                    Service *
                </label>
                <select class="form-select service-select" required style="border-radius: 10px; padding: 12px;">
                    <option value="">Select service...</option>
                    {% if services %}
                    {% for service in services %}
                        <option value="{{ service.id }}" 
                                data-duration="{{ service.duration or 60 }}"
                                data-price="{{ service.price }}">
                            {{ service.name }} ({{ service.duration or 60 }} min - ${{ "%.2f"|format(service.price) }})
                        </option>
                    {% endfor %}
                    {% endif %}
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label fw-semibold">
                    <i class="fas fa-user-md me-2" style="color: var(--primary-color);"></i>
                    Staff Member *
                </label>
                <select class="form-select staff-select" required style="border-radius: 10px; padding: 12px;">
                    <option value="">Select staff member...</option>
                    {% if staff_members %}
                    {% for staff in staff_members %}
                        <option value="{{ staff.id }}">
                            {{ staff.first_name }} {{ staff.last_name if staff.last_name else '' }}
                        </option>
                    {% endfor %}
                    {% endif %}
                </select>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">
                    <i class="fas fa-calendar me-2" style="color: var(--primary-color);"></i>
                    Date *
                </label>
                <input type="date" class="form-control appointment-date" 
                       value="{{ today }}" required style="border-radius: 10px; padding: 12px;">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">
                    <i class="fas fa-clock me-2" style="color: var(--primary-color);"></i>
                    Start Time *
                </label>
                <input type="time" class="form-control start-time" 
                       value="09:00" required style="border-radius: 10px; padding: 12px;">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label fw-semibold">
                    <i class="fas fa-clock me-2" style="color: var(--success-color);"></i>
                    End Time
                </label>
                <input type="time" class="form-control end-time" readonly
                       style="border-radius: 10px; padding: 12px; background: #f0fdf4; font-weight: 600; color: var(--success-color);">
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div id="conflictAlert${newIndex}" class="alert alert-warning d-none" style="border-radius: 10px;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span class="conflict-message"></span>
                </div>
            </div>
        </div>
    `;
    
    container.appendChild(appointmentCard);
    updateAppointmentCount();
    updateRemoveButtonsVisibility();
}

// Remove appointment
function removeAppointment(index) {
    const card = document.querySelector(`[data-appointment-index="${index}"]`);
    if (card) {
        card.remove();
        updateAppointmentCount();
        updateRemoveButtonsVisibility();
        updateSummary();
    }
}

// Update appointment count
function updateAppointmentCount() {
    const count = document.querySelectorAll('.appointment-card').length;
    document.getElementById('appointmentCount').textContent = 
        `${count} Appointment${count !== 1 ? 's' : ''}`;
    
    // Update numbers
    document.querySelectorAll('.appointment-card').forEach((card, index) => {
        card.querySelector('.appointment-number').textContent = index + 1;
    });
}

// Update remove buttons visibility
function updateRemoveButtonsVisibility() {
    const cards = document.querySelectorAll('.appointment-card');
    cards.forEach((card, index) => {
        const removeBtn = card.querySelector('.remove-appointment');
        if (cards.length > 1) {
            removeBtn.classList.remove('d-none');
        } else {
            removeBtn.classList.add('d-none');
        }
    });
}

// Calculate end time for appointment
function calculateEndTime(index) {
    const card = document.querySelector(`[data-appointment-index="${index}"]`);
    if (!card) return;
    
    const serviceSelect = card.querySelector('.service-select');
    const startTimeInput = card.querySelector('.start-time');
    const endTimeInput = card.querySelector('.end-time');
    
    const selectedOption = serviceSelect.selectedOptions[0];
    const startTime = startTimeInput.value;
    
    if (!selectedOption || !startTime) {
        endTimeInput.value = '';
        return;
    }
    
    const duration = parseInt(selectedOption.dataset.duration) || 60;
    const [hours, minutes] = startTime.split(':').map(Number);
    const startDate = new Date();
    startDate.setHours(hours, minutes, 0);
    
    const endDate = new Date(startDate.getTime() + duration * 60000);
    const endTimeStr = endDate.toTimeString().substr(0, 5);
    endTimeInput.value = endTimeStr;
}

// Check for conflicts
function checkConflicts(index) {
    const card = document.querySelector(`[data-appointment-index="${index}"]`);
    if (!card) return;
    
    const staffSelect = card.querySelector('.staff-select');
    const dateInput = card.querySelector('.appointment-date');
    const startTimeInput = card.querySelector('.start-time');
    const endTimeInput = card.querySelector('.end-time');
    const conflictAlert = card.querySelector('.alert');
    
    if (!staffSelect.value || !dateInput.value || !startTimeInput.value || !endTimeInput.value) {
        conflictAlert.classList.add('d-none');
        card.classList.remove('duplicate');
        return;
    }
    
    const staffId = parseInt(staffSelect.value);
    const date = dateInput.value;
    const startTime = startTimeInput.value;
    const endTime = endTimeInput.value;
    
    // Check against existing bookings
    let hasConflict = false;
    let conflictMessage = '';
    
    // Check internal conflicts (within this booking session)
    const allCards = document.querySelectorAll('.appointment-card');
    allCards.forEach((otherCard, otherIndex) => {
        if (otherCard === card) return;
        
        const otherStaffSelect = otherCard.querySelector('.staff-select');
        const otherDateInput = otherCard.querySelector('.appointment-date');
        const otherStartTime = otherCard.querySelector('.start-time');
        const otherEndTime = otherCard.querySelector('.end-time');
        
        if (otherStaffSelect.value && otherDateInput.value && 
            otherStartTime.value && otherEndTime.value) {
            
            if (parseInt(otherStaffSelect.value) === staffId && 
                otherDateInput.value === date) {
                
                // Check time overlap
                if (startTime < otherEndTime.value && endTime > otherStartTime.value) {
                    hasConflict = true;
                    conflictMessage = `Conflicts with Appointment #${otherIndex + 1} (${otherStartTime.value} - ${otherEndTime.value})`;
                }
            }
        }
    });
    
    if (hasConflict) {
        conflictAlert.classList.remove('d-none');
        conflictAlert.querySelector('.conflict-message').textContent = conflictMessage;
        card.classList.add('duplicate');
    } else {
        conflictAlert.classList.add('d-none');
        card.classList.remove('duplicate');
    }
}

// Update summary
function updateSummary() {
    let totalDuration = 0;
    let totalPrice = 0;
    const staffSet = new Set();
    
    document.querySelectorAll('.appointment-card').forEach(card => {
        const serviceSelect = card.querySelector('.service-select');
        const staffSelect = card.querySelector('.staff-select');
        
        if (serviceSelect.value) {
            const selectedOption = serviceSelect.selectedOptions[0];
            const duration = parseInt(selectedOption.dataset.duration) || 60;
            const price = parseFloat(selectedOption.dataset.price) || 0;
            
            totalDuration += duration;
            totalPrice += price;
        }
        
        if (staffSelect.value) {
            staffSet.add(staffSelect.value);
        }
    });
    
    document.getElementById('multiTotalDuration').textContent = `${totalDuration} min`;
    document.getElementById('multiTotalPrice').textContent = `$${totalPrice.toFixed(2)}`;
    document.getElementById('multiStaffCount').textContent = staffSet.size;
}

// Process multi-booking
function processMultiBooking() {
    const clientSelect = document.getElementById('multiClientSelect');
    const clientId = clientSelect.value;
    const notes = document.getElementById('multiNotes').value.trim();
    
    if (!clientId) {
        alert('Please select a client');
        return;
    }
    
    // Get client details from selected option
    const selectedOption = clientSelect.options[clientSelect.selectedIndex];
    const clientName = selectedOption.text.split(' - ')[0]; // Extract name before phone
    const clientPhone = selectedOption.dataset.phone;
    
    const appointments = [];
    const cards = document.querySelectorAll('.appointment-card');
    
    // Validate all appointments
    let hasErrors = false;
    cards.forEach((card, index) => {
        const serviceSelect = card.querySelector('.service-select');
        const staffSelect = card.querySelector('.staff-select');
        const dateInput = card.querySelector('.appointment-date');
        const startTimeInput = card.querySelector('.start-time');
        const endTimeInput = card.querySelector('.end-time');
        
        if (!serviceSelect.value || !staffSelect.value || !dateInput.value || 
            !startTimeInput.value || !endTimeInput.value) {
            alert(`Please complete all fields for Appointment #${index + 1}`);
            hasErrors = true;
            return;
        }
        
        // Check for conflicts
        if (card.classList.contains('duplicate')) {
            alert(`Please resolve conflicts for Appointment #${index + 1}`);
            hasErrors = true;
            return;
        }
        
        const selectedService = serviceSelect.selectedOptions[0];
        appointments.push({
            client_id: clientId,
            client_name: clientName,
            client_phone: clientPhone,
            service_id: serviceSelect.value,
            service_name: selectedService.textContent.split('(')[0].trim(),
            staff_id: staffSelect.value,
            appointment_date: dateInput.value,
            start_time: startTimeInput.value,
            end_time: endTimeInput.value,
            notes: notes
        });
    });
    
    if (hasErrors) return;
    
    // Show loading
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.add('show');
    
    // Book all appointments
    const bookingPromises = appointments.map(appointment => {
        return fetch('/api/unaki/book-appointment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(appointment)
        });
    });
    
    Promise.all(bookingPromises)
        .then(responses => Promise.all(responses.map(r => r.json())))
        .then(results => {
            overlay.classList.remove('show');
            
            const successCount = results.filter(r => r.success).length;
            const totalCount = results.length;
            
            if (successCount === totalCount) {
                bootstrap.Modal.getInstance(document.getElementById('multiBookModal')).hide();
                showNotification(`Successfully booked ${successCount} appointments for ${clientName}!`, 'success');
                loadBookings();
            } else {
                const failures = results.filter(r => !r.success);
                let errorMsg = `Booked ${successCount}/${totalCount} appointments.\n\nErrors:\n`;
                failures.forEach((failure, index) => {
                    errorMsg += `- ${failure.error || 'Unknown error'}\n`;
                });
                alert(errorMsg);
            }
        })
        .catch(error => {
            overlay.classList.remove('show');
            console.error('Error:', error);
            showNotification('An error occurred while booking appointments', 'error');
        });
}

// Navigate date
function navigateDate(days) {
    const date = new Date(currentDate);
    date.setDate(date.getDate() + days);
    const newDate = date.toISOString().split('T')[0];
    window.location.href = `{{ url_for('unaki_booking') }}?date=${newDate}`;
}

// Navigate to today
function navigateToToday() {
    const today = new Date().toISOString().split('T')[0];
    window.location.href = `{{ url_for('unaki_booking') }}?date=${today}`;
}

// Refresh schedule
function refreshSchedule() {
    loadBookings();
    
    // Visual feedback
    const btn = event.target.closest('.action-icon');
    btn.style.transform = 'rotate(360deg)';
    setTimeout(() => {
        btn.style.transform = 'rotate(0deg)';
    }, 600);
}

// Handle slot click
function handleSlotClick(event, staffId, hour, minute) {
    event.stopPropagation();
    
    const slot = event.currentTarget;
    const rect = slot.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const slotWidth = rect.width;
    
    const minuteOffset = Math.floor((clickX / slotWidth) * 60 / 15) * 15;
    const time = `${String(hour).padStart(2, '0')}:${String(minuteOffset).padStart(2, '0')}`;
    
    openMultiBookModalWithData(staffId, currentDate, time);
}

// Open modal with pre-filled data
function openMultiBookModalWithData(staffId, date, time) {
    openMultiBookModal();
    
    // Pre-fill first appointment
    const firstCard = document.querySelector('.appointment-card');
    if (firstCard) {
        firstCard.querySelector('.staff-select').value = staffId;
        firstCard.querySelector('.appointment-date').value = date;
        firstCard.querySelector('.start-time').value = time;
        calculateEndTime(0);
    }
}

// Show notification
function showNotification(message, type) {
    alert(message);
}

// View appointment
function viewAppointment(appointmentId) {
    selectedAppointmentId = appointmentId;
    alert('View appointment ' + appointmentId);
}

// Context menu functions
function showContextMenu(event, appointmentId) {
    event.preventDefault();
    selectedAppointmentId = appointmentId;
    
    const contextMenu = document.getElementById('contextMenu');
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';
    contextMenu.classList.add('show');
}

function hideContextMenu() {
    const contextMenu = document.getElementById('contextMenu');
    contextMenu.classList.remove('show');
}

function viewAppointmentDetails() {
    if (selectedAppointmentId) {
        alert('View details for appointment ' + selectedAppointmentId);
    }
    hideContextMenu();
}

function editAppointment() {
    if (selectedAppointmentId) {
        const id = parseInt(selectedAppointmentId, 10);
        const booking = bookingsData.find(b => b.id === id);
        if (booking) {
            openEditModal(booking);
        } else {
            console.error(`Booking with ID ${id} not found in bookingsData`);
        }
    }
    hideContextMenu();
}

function openEditModal(booking) {
    // Populate modal with booking data
    document.getElementById('editAppointmentId').value = booking.id;
    document.getElementById('editClientName').value = booking.client_name;
    document.getElementById('editServiceSelect').value = booking.service_id || '';
    document.getElementById('editStaffSelect').value = booking.staff_id;
    document.getElementById('editAppointmentDate').value = booking.appointment_date;
    document.getElementById('editStartTime').value = booking.start_time;
    document.getElementById('editEndTime').value = booking.end_time;
    document.getElementById('editNotes').value = booking.notes || '';
    
    // Clear conflict alert
    document.getElementById('editConflictAlert').classList.add('d-none');
    
    // Setup event listeners for auto-calculation
    const serviceSelect = document.getElementById('editServiceSelect');
    const startTime = document.getElementById('editStartTime');
    
    serviceSelect.onchange = calculateEditEndTime;
    startTime.onchange = calculateEditEndTime;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
    modal.show();
}

function calculateEditEndTime() {
    const serviceSelect = document.getElementById('editServiceSelect');
    const startTimeInput = document.getElementById('editStartTime');
    const endTimeInput = document.getElementById('editEndTime');
    
    const selectedOption = serviceSelect.selectedOptions[0];
    const startTime = startTimeInput.value;
    
    if (!selectedOption || !startTime) {
        endTimeInput.value = '';
        return;
    }
    
    const duration = parseInt(selectedOption.dataset.duration) || 60;
    const [hours, minutes] = startTime.split(':').map(Number);
    const startDate = new Date();
    startDate.setHours(hours, minutes, 0);
    
    const endDate = new Date(startDate.getTime() + duration * 60000);
    const endTimeStr = endDate.toTimeString().substr(0, 5);
    endTimeInput.value = endTimeStr;
    
    // Check for conflicts
    checkEditConflicts();
}

function checkEditConflicts() {
    const appointmentId = parseInt(document.getElementById('editAppointmentId').value);
    const staffId = parseInt(document.getElementById('editStaffSelect').value);
    const date = document.getElementById('editAppointmentDate').value;
    const startTime = document.getElementById('editStartTime').value;
    const endTime = document.getElementById('editEndTime').value;
    const conflictAlert = document.getElementById('editConflictAlert');
    const conflictMessage = document.getElementById('editConflictMessage');
    
    if (!staffId || !date || !startTime || !endTime) {
        conflictAlert.classList.add('d-none');
        return;
    }
    
    // Check against existing bookings (excluding current appointment)
    const conflicts = bookingsData.filter(b => 
        b.id !== appointmentId &&
        b.staff_id === staffId &&
        b.appointment_date === date &&
        startTime < b.end_time &&
        endTime > b.start_time
    );
    
    if (conflicts.length > 0) {
        const conflict = conflicts[0];
        conflictMessage.textContent = `Conflicts with existing appointment: ${conflict.client_name} (${conflict.start_time} - ${conflict.end_time})`;
        conflictAlert.classList.remove('d-none');
    } else {
        conflictAlert.classList.add('d-none');
    }
}

function saveEditedAppointment() {
    const appointmentId = document.getElementById('editAppointmentId').value;
    const serviceId = document.getElementById('editServiceSelect').value;
    const staffId = document.getElementById('editStaffSelect').value;
    const date = document.getElementById('editAppointmentDate').value;
    const startTime = document.getElementById('editStartTime').value;
    const endTime = document.getElementById('editEndTime').value;
    const notes = document.getElementById('editNotes').value;
    
    // Validation
    if (!serviceId || !staffId || !date || !startTime || !endTime) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Check for conflicts
    if (!document.getElementById('editConflictAlert').classList.contains('d-none')) {
        if (!confirm('There is a scheduling conflict. Do you want to proceed anyway?')) {
            return;
        }
    }
    
    const overlay = document.getElementById('loadingOverlay');
    overlay.classList.add('show');
    
    // Get service name from select
    const serviceSelect = document.getElementById('editServiceSelect');
    const serviceName = serviceSelect.selectedOptions[0].text.split('(')[0].trim();
    
    const updateData = {
        service_id: serviceId,
        service_name: serviceName,
        staff_id: staffId,
        appointment_date: date,
        start_time: startTime,
        end_time: endTime,
        notes: notes
    };
    
    fetch(`/api/unaki/bookings/${appointmentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        overlay.classList.remove('show');
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editAppointmentModal')).hide();
            showNotification('Appointment updated successfully!', 'success');
            loadBookings();
        } else {
            alert('Error updating appointment: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        overlay.classList.remove('show');
        console.error('Error:', error);
        alert('Error updating appointment. Please try again.');
    });
}

function checkInAppointment() {
    if (selectedAppointmentId) {
        alert('Check in appointment ' + selectedAppointmentId);
    }
    hideContextMenu();
}

function duplicateAppointment() {
    if (selectedAppointmentId) {
        alert('Duplicate appointment ' + selectedAppointmentId);
    }
    hideContextMenu();
}

function cancelAppointment() {
    if (selectedAppointmentId && confirm('Are you sure you want to cancel this appointment?')) {
        alert('Cancel appointment ' + selectedAppointmentId);
    }
    hideContextMenu();
}

// Update current time line
function updateCurrentTimeLine() {
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    
    if (currentHour >= 9 && currentHour < 22) {
        const timeLine = document.getElementById('currentTimeLine');
        const timeLabel = document.getElementById('currentTimeLabel');
        
        const hoursSince9AM = currentHour - 9;
        const minuteOffset = currentMinute / 60;
        const leftPosition = (hoursSince9AM + minuteOffset) * 140;
        
        const timeStr = now.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        
        timeLabel.textContent = timeStr;
        timeLine.style.left = leftPosition + 'px';
        timeLine.style.display = 'block';
    }
}
    </script>
</body>
</html>
