<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Unaki Appointment Booking - Multi-Service</title>
        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- Font Awesome -->
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <!-- Google Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />
        <!-- Bootstrap JavaScript Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary-color: #4f46e5;
                --primary-hover: #4338ca;
                --success-color: #10b981;
                --danger-color: #ef4444;
                --warning-color: #f59e0b;
                --info-color: #06b6d4;
                --border-color: #e5e7eb;
                --hover-bg: #f9fafb;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                background-attachment: fixed;
                min-height: 100vh;
                color: #1f2937;
                overflow-x: hidden;
                overflow-y: auto;
            }

            /* Top Navigation Bar */
            .calendar-top-nav {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 64px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 24px;
                z-index: 100;
                box-shadow: var(--shadow-md);
            }

            .calendar-logo {
                font-size: 20px;
                font-weight: 700;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .calendar-logo i {
                -webkit-text-fill-color: #667eea;
            }

            .calendar-date-nav {
                display: flex;
                align-items: center;
                gap: 16px;
                background: white;
                padding: 8px 12px;
                border-radius: 12px;
                box-shadow: var(--shadow-sm);
                border: 1px solid var(--border-color);
            }

            .date-nav-btn {
                width: 36px;
                height: 36px;
                border-radius: 8px;
                border: none;
                background: var(--hover-bg);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
                color: #6b7280;
            }

            .date-nav-btn:hover {
                background: var(--primary-color);
                color: white;
                transform: scale(1.05);
            }

            .date-nav-btn:active {
                transform: scale(0.95);
            }

            .current-date-display {
                font-size: 15px;
                font-weight: 600;
                color: #1f2937;
                min-width: 220px;
                text-align: center;
            }

            .date-today-btn {
                padding: 6px 12px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                background: white;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                color: #6b7280;
            }

            .date-today-btn:hover {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .calendar-actions {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .action-btn {
                padding: 10px 18px;
                border-radius: 10px;
                border: none;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .action-btn-primary {
                background: var(--primary-color);
                color: white;
                box-shadow: var(--shadow-md);
            }

            .action-btn-primary:hover {
                background: var(--primary-hover);
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .action-btn-primary:active {
                transform: translateY(0);
            }

            .action-icon {
                width: 40px;
                height: 40px;
                border-radius: 10px;
                border: 1px solid var(--border-color);
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
                color: #6b7280;
            }

            .action-icon:hover {
                background: var(--hover-bg);
                color: var(--primary-color);
                transform: scale(1.05);
            }

            /* Main Layout */
            .calendar-main-layout {
                position: fixed;
                top: 64px;
                left: 0;
                right: 0;
                bottom: 0;
                display: flex;
                background: white;
                overflow: hidden;
                margin: 12px;
                border-radius: 16px;
                box-shadow: var(--shadow-xl);
                position: relative;
            }

            /* Horizontal alignment guides */
            .calendar-main-layout::before {
                content: "";
                position: absolute;
                top: 60px; /* Account for timeline header */
                left: 0;
                right: 0;
                bottom: 0;
                background-image: repeating-linear-gradient(
                    to bottom,
                    transparent 0,
                    transparent 109px,
                    rgba(79, 70, 229, 0.08) 109px,
                    rgba(79, 70, 229, 0.08) 110px
                );
                pointer-events: none;
                z-index: 1;
            }

            /* Staff Sidebar */
            .staff-sidebar {
                width: 280px;
                flex-shrink: 0;
                background: #ffffff;
                border-right: 2px solid var(--border-color);
                overflow-y: auto;
                overflow-x: hidden;
                position: relative;
                z-index: 2;
                max-height: 100%;
            }

            .staff-sidebar-header {
                height: 60px;
                background: white;
                border-bottom: 2px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 20px;
                font-weight: 700;
                font-size: 14px;
                color: #1f2937;
                position: sticky;
                top: 0;
                z-index: 10;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .staff-count {
                background: var(--primary-color);
                color: white;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }

            .staff-row {
                height: 110px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                padding: 16px 20px;
                gap: 14px;
                cursor: pointer;
                transition: all 0.3s;
                background: #ffffff;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
            }

            .staff-row:nth-of-type(odd) {
                background: #fafbfc;
            }

            .staff-row:nth-of-type(even) {
                background: #ffffff;
            }

            .staff-row:hover {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                transform: none;
                box-shadow: none;
            }

            .staff-row:hover .staff-avatar {
                transform: scale(1.1);
                box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
            }

            .staff-row:hover .staff-name,
            .staff-row:hover .staff-role,
            .staff-row:hover .staff-status {
                color: white;
            }

            .staff-avatar {
                width: 56px;
                height: 56px;
                border-radius: 14px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 700;
                font-size: 20px;
                flex-shrink: 0;
                transition: all 0.3s;
                box-shadow: var(--shadow-md);
            }

            .staff-info {
                flex: 1;
                min-width: 0;
            }

            .staff-name {
                font-size: 15px;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .staff-role {
                font-size: 13px;
                color: #6b7280;
                margin-bottom: 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .staff-status {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-size: 11px;
                font-weight: 500;
                color: var(--success-color);
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--success-color);
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            /* Timeline Panel */
            .timeline-panel {
                flex: 1;
                overflow-x: auto;
                overflow-y: auto;
                background: #ffffff;
                position: relative;
                z-index: 2;
            }

            /* Add shadow indicators for horizontal scroll */
            .timeline-panel::after {
                content: "";
                position: sticky;
                right: 0;
                top: 0;
                width: 40px;
                height: 100%;
                background: linear-gradient(
                    to left,
                    rgba(255, 255, 255, 0.8) 0%,
                    transparent 100%
                );
                pointer-events: none;
                float: right;
            }

            .timeline-header {
                height: 60px;
                background: white;
                border-bottom: 2px solid var(--border-color);
                display: flex;
                position: sticky;
                top: 0;
                z-index: 9;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
            }

            /* Scroll indicator hint */
            .timeline-header::after {
                content: "← Scroll horizontally →";
                position: absolute;
                bottom: -20px;
                right: 20px;
                background: rgba(79, 70, 229, 0.9);
                color: white;
                padding: 4px 12px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                pointer-events: none;
                animation: scrollHintFade 3s ease-in-out infinite;
            }

            @keyframes scrollHintFade {
                0%,
                100% {
                    opacity: 0;
                }
                50% {
                    opacity: 1;
                }
            }

            .timeline-hour {
                min-width: 140px;
                flex-shrink: 0;
                border-right: 1px solid #e5e7eb;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                font-size: 13px;
                color: #1f2937;
                transition: all 0.2s;
            }

            .timeline-hour:hover {
                background: var(--hover-bg);
            }

            .hour-label {
                font-size: 14px;
                font-weight: 700;
            }

            .hour-period {
                font-size: 11px;
                color: #9ca3af;
                margin-top: 2px;
            }

            /* Timeline Grid */
            .timeline-grid {
                position: relative;
                min-width: max-content;
            }

            .timeline-row {
                height: 110px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                position: relative;
                transition: background 0.2s;
            }

            .timeline-row:nth-child(odd) {
                background: #fafbfc;
            }

            .timeline-row:nth-child(even) {
                background: #ffffff;
            }

            .timeline-row:hover {
                background: rgba(79, 70, 229, 0.02);
            }

            .timeline-hour-slot {
                min-width: 140px;
                flex-shrink: 0;
                position: relative;
                background: transparent;
                border-right: 1px solid #e5e7eb;
                cursor: pointer;
                transition: all 0.2s;
            }

            .timeline-hour-slot:hover {
                background: linear-gradient(
                    to bottom,
                    rgba(79, 70, 229, 0.03),
                    rgba(79, 70, 229, 0.05)
                );
            }

            .timeline-hour-slot:hover::after {
                content: "+";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 24px;
                color: var(--primary-color);
                font-weight: 600;
                opacity: 0.3;
            }

            /* 15-minute interval lines */
            .interval-marker {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 1px;
                background: #f3f4f6;
            }

            .interval-15 {
                left: 25%;
            }
            .interval-30 {
                left: 50%;
                background: #e5e7eb;
            }
            .interval-45 {
                left: 75%;
            }

            /* Appointment Block */
            .appointment-block {
                position: absolute;
                top: 8px;
                bottom: 8px;
                border-radius: 10px;
                border-left: 4px solid;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                padding: 12px;
                cursor: move;
                transition: all 0.2s;
                overflow: hidden;
                z-index: 5;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }

            .appointment-block:hover {
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
                transform: translateY(-2px) scale(1.02);
                z-index: 10;
            }

            .appointment-block.dragging {
                opacity: 0.6;
                cursor: grabbing;
                z-index: 100;
            }

            .appointment-header {
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                margin-bottom: 8px;
            }

            .appointment-client {
                font-size: 14px;
                font-weight: 700;
                color: #1f2937;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex: 1;
            }

            .appointment-status {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--success-color);
                flex-shrink: 0;
                margin-left: 8px;
            }

            .appointment-service {
                font-size: 12px;
                color: #6b7280;
                margin-bottom: 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .appointment-footer {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-top: auto;
            }

            .appointment-time {
                font-size: 11px;
                font-weight: 600;
                color: #9ca3af;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .appointment-duration {
                font-size: 10px;
                background: rgba(0, 0, 0, 0.05);
                padding: 2px 8px;
                border-radius: 12px;
                font-weight: 600;
            }

            /* Service type colors - More vibrant */
            .service-massage {
                border-left-color: #3b82f6;
                background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            }
            .service-facial {
                border-left-color: #a855f7;
                background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            }
            .service-manicure {
                border-left-color: #f43f5e;
                background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
            }
            .service-pedicure {
                border-left-color: #78350f;
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            }
            .service-haircut {
                border-left-color: #22c55e;
                background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            }
            .service-waxing {
                border-left-color: #f97316;
                background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);
            }
            .service-default {
                border-left-color: #6b7280;
                background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            }

            /* Current Time Indicator */
            .current-time-line {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 2px;
                background: var(--danger-color);
                z-index: 20;
                pointer-events: none;
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            }

            .current-time-line::before {
                content: "";
                position: absolute;
                top: -6px;
                left: -6px;
                width: 14px;
                height: 14px;
                background: var(--danger-color);
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
                animation: currentTimePulse 2s infinite;
            }

            .current-time-label {
                position: absolute;
                top: 16px;
                left: 6px;
                background: var(--danger-color);
                color: white;
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
                box-shadow: var(--shadow-md);
            }

            @keyframes currentTimePulse {
                0%,
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.2);
                    opacity: 0.8;
                }
            }

            /* Context Menu - Enhanced */
            .context-menu {
                position: fixed;
                background: white;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                box-shadow: var(--shadow-xl);
                padding: 8px;
                min-width: 220px;
                z-index: 1000;
                display: none;
                animation: contextMenuFadeIn 0.2s ease;
            }

            @keyframes contextMenuFadeIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .context-menu.show {
                display: block;
            }

            .context-menu-item {
                padding: 12px 16px;
                cursor: pointer;
                font-size: 14px;
                color: #1f2937;
                display: flex;
                align-items: center;
                gap: 12px;
                transition: all 0.2s;
                border-radius: 8px;
                font-weight: 500;
            }

            .context-menu-item:hover {
                background: var(--hover-bg);
                color: var(--primary-color);
                transform: translateX(4px);
            }

            .context-menu-item i {
                width: 18px;
                text-align: center;
            }

            .context-menu-divider {
                height: 1px;
                background: var(--border-color);
                margin: 8px 0;
            }

            .context-menu-item.danger:hover {
                background: #fee;
                color: var(--danger-color);
            }

            /* Service Selection Checkboxes */
            .service-checkbox-item {
                display: flex;
                align-items: center;
                cursor: pointer;
            }

            .service-checkbox-item:hover {
                border-color: var(--primary-color) !important;
                background: #f8f9ff !important;
                transform: translateX(4px);
            }

            .service-checkbox-item:has(.form-check-input:checked) {
                border-color: var(--primary-color) !important;
                background: linear-gradient(
                    135deg,
                    #e0e7ff 0%,
                    #f3e8ff 100%
                ) !important;
            }

            .service-checkbox:checked {
                background-color: var(--primary-color);
                border-color: var(--primary-color);
            }

            /* Tooltip */
            .tooltip-custom {
                position: fixed;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 500;
                z-index: 10000;
                pointer-events: none;
                display: none;
                white-space: nowrap;
                box-shadow: var(--shadow-lg);
            }

            .tooltip-custom.show {
                display: block;
                animation: tooltipFadeIn 0.2s ease;
            }

            @keyframes tooltipFadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            /* Loading State */
            .loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.95);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 50;
                backdrop-filter: blur(5px);
            }

            .loading-overlay.show {
                display: flex;
            }

            .spinner {
                width: 50px;
                height: 50px;
                border: 4px solid #e5e7eb;
                border-top-color: var(--primary-color);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* Scrollbar Styling */
            ::-webkit-scrollbar {
                width: 14px;
                height: 14px;
            }

            ::-webkit-scrollbar-track {
                background: #f3f4f6;
                border-radius: 10px;
                border: 2px solid #e5e7eb;
            }

            ::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 10px;
                border: 2px solid #f3f4f6;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, #5a67d8 0%, #6b3fa0 100%);
            }

            ::-webkit-scrollbar-corner {
                background: #f3f4f6;
            }

            /* Empty State */
            .empty-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: #9ca3af;
                padding: 60px 40px;
                text-align: center;
            }

            .empty-state i {
                font-size: 64px;
                margin-bottom: 20px;
                opacity: 0.3;
            }

            .empty-state h3 {
                font-size: 18px;
                font-weight: 600;
                color: #4b5563;
                margin-bottom: 8px;
            }

            .empty-state p {
                font-size: 14px;
                color: #9ca3af;
                margin: 0;
            }

            /* Responsive */
            @media (max-width: 1024px) {
                .staff-sidebar {
                    width: 240px;
                }

                .timeline-hour {
                    min-width: 110px;
                }

                .timeline-hour-slot {
                    min-width: 110px;
                }
            }

            @media (max-width: 768px) {
                .calendar-main-layout {
                    margin: 8px;
                    border-radius: 12px;
                }

                .staff-sidebar {
                    width: 200px;
                }

                .timeline-hour {
                    min-width: 90px;
                }

                .timeline-hour-slot {
                    min-width: 90px;
                }

                .staff-row {
                    height: 90px;
                    padding: 12px;
                }

                .staff-avatar {
                    width: 48px;
                    height: 48px;
                    font-size: 18px;
                }

                .calendar-logo span {
                    display: none;
                }

                .current-date-display {
                    min-width: 150px;
                    font-size: 13px;
                }

                /* Hide stats on mobile */
                .calendar-top-nav > div:nth-child(3) > div:first-child {
                    display: none;
                }
            }
        </style>
    </head>
    <body>
        <!-- Tooltip -->
        <div class="tooltip-custom" id="tooltip"></div>

        <div class="calendar-wrapper">
            <!-- Fixed Top Navigation -->
            <div class="calendar-top-nav">
                <div class="calendar-logo">
                    <i class="fas fa-calendar-check"></i>
                    <span>Unaki Booking</span>
                </div>

                <div class="calendar-date-nav">
                    <button
                        class="date-nav-btn"
                        onclick="navigateDate(-1)"
                        data-tooltip="Previous Day"
                    >
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button
                        class="date-today-btn"
                        onclick="navigateToToday()"
                        data-tooltip="Go to Today"
                    >
                        Today
                    </button>
                    <div class="current-date-display" id="currentDateDisplay">
                        {{ today_date }}
                    </div>
                    <button
                        class="date-nav-btn"
                        onclick="navigateDate(1)"
                        data-tooltip="Next Day"
                    >
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div style="display: flex; align-items: center; gap: 16px">
                    <!-- Quick Stats in Top Bar -->
                    <div style="display: flex; gap: 12px">
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                padding: 8px 12px;
                                background: white;
                                border-radius: 10px;
                                border: 1px solid var(--border-color);
                            "
                        >
                            <i
                                class="fas fa-calendar-check"
                                style="color: var(--primary-color)"
                            ></i>
                            <div>
                                <div
                                    style="
                                        font-size: 16px;
                                        font-weight: 700;
                                        color: #1f2937;
                                    "
                                    id="totalBookings"
                                >
                                    0
                                </div>
                                <div style="font-size: 10px; color: #6b7280">
                                    Total
                                </div>
                            </div>
                        </div>
                        <div
                            style="
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                padding: 8px 12px;
                                background: white;
                                border-radius: 10px;
                                border: 1px solid var(--border-color);
                            "
                        >
                            <i
                                class="fas fa-check-circle"
                                style="color: var(--success-color)"
                            ></i>
                            <div>
                                <div
                                    style="
                                        font-size: 16px;
                                        font-weight: 700;
                                        color: #1f2937;
                                    "
                                    id="completedBookings"
                                >
                                    0
                                </div>
                                <div style="font-size: 10px; color: #6b7280">
                                    Done
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="calendar-actions">
                        <button
                            class="action-btn action-btn-primary"
                            onclick="openQuickBookModal()"
                        >
                            <i class="fas fa-plus-circle"></i>
                            New Appointment
                        </button>
                        <button
                            class="action-icon"
                            onclick="refreshSchedule()"
                            data-tooltip="Refresh Schedule"
                        >
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <a
                            href="{{ url_for('dashboard') }}"
                            class="action-icon"
                            data-tooltip="Back to Dashboard"
                        >
                            <i class="fas fa-home"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Layout -->
            <div class="calendar-main-layout">
                <!-- Staff Sidebar -->
                <div class="staff-sidebar">
                    <!-- Header: 60px height -->
                    <div class="staff-sidebar-header">
                        <span>Staff Members</span>
                        <span class="staff-count"
                            >{{ staff_members|length if staff_members else 0
                            }}</span
                        >
                    </div>

                    <!-- Staff rows start here - each 110px height, matching timeline rows exactly -->
                    <div class="staff-list">
                        {% if staff_members %} {% for staff in staff_members %}
                        <div
                            class="staff-row staff-row-{{ loop.index }}"
                            data-staff-id="{{ staff.id }}"
                            data-tooltip="Click to filter by {{ staff.first_name }}"
                        >
                            <div class="staff-avatar">
                                {{ (staff.first_name[:1] +
                                staff.last_name[:1]).upper() if staff.first_name
                                and staff.last_name else
                                staff.username[:2].upper() }}
                            </div>
                            <div class="staff-info">
                                <div class="staff-name">
                                    {{ staff.first_name }} {{ staff.last_name if
                                    staff.last_name else '' }}
                                </div>
                                <div class="staff-role">
                                    {{ staff.role or 'Therapist' }}
                                </div>
                                <div class="staff-status">
                                    <span class="status-dot"></span>
                                    Available
                                </div>
                            </div>
                        </div>
                        {% endfor %} {% else %}
                        <div class="empty-state">
                            <i class="fas fa-user-plus"></i>
                            <h3>No Staff Members</h3>
                            <p>
                                Add staff members to start booking appointments
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Timeline Panel -->
                <div class="timeline-panel">
                    <!-- Timeline Header: 60px height (matches staff header) -->
                    <div class="timeline-header">
                        {% for hour in range(9, 22) %}
                        <div
                            class="timeline-hour"
                            data-tooltip="Click any slot to book"
                        >
                            <span class="hour-label">
                                {{ '%d:00' % hour if hour < 12 else ('12:00' if
                                hour == 12 else '%d:00' % (hour - 12)) }}
                            </span>
                            <span class="hour-period"
                                >{{ 'AM' if hour < 12 else 'PM' }}</span
                            >
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Timeline Grid -->
                    <!-- Each timeline-row is 110px height, perfectly matching each staff-row -->
                    <div class="timeline-grid" id="timelineGrid">
                        {% if staff_members %} {% for staff in staff_members %}
                        <div
                            class="timeline-row"
                            data-staff-id="{{ staff.id }}"
                        >
                            {% for hour in range(9, 22) %}
                            <div
                                class="timeline-hour-slot"
                                data-hour="{{ hour }}"
                                data-staff-id="{{ staff.id }}"
                                onclick="handleSlotClick(event, {{ staff.id }}, {{ hour }}, 0)"
                            >
                                <div class="interval-marker interval-15"></div>
                                <div class="interval-marker interval-30"></div>
                                <div class="interval-marker interval-45"></div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %} {% else %}
                        <div class="empty-state">
                            <i class="fas fa-calendar-plus"></i>
                            <h3>Ready to Start Booking</h3>
                            <p>
                                Add staff members to begin scheduling
                                appointments
                            </p>
                        </div>
                        {% endif %}

                        <!-- Current Time Line -->
                        <div
                            class="current-time-line"
                            id="currentTimeLine"
                            style="display: none"
                        >
                            <div
                                class="current-time-label"
                                id="currentTimeLabel"
                            >
                                Now
                            </div>
                        </div>
                    </div>

                    <!-- Loading Overlay -->
                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context Menu -->
        <div class="context-menu" id="contextMenu">
            <div class="context-menu-item" onclick="viewAppointmentDetails()">
                <i class="fas fa-eye"></i>
                View Details
            </div>
            <div class="context-menu-item" onclick="editAppointment()">
                <i class="fas fa-edit"></i>
                Edit Appointment
            </div>
            <div class="context-menu-item" onclick="checkInAppointment()">
                <i class="fas fa-user-check"></i>
                Check In Client
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item" onclick="duplicateAppointment()">
                <i class="fas fa-copy"></i>
                Duplicate
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item danger" onclick="cancelAppointment()">
                <i class="fas fa-times-circle"></i>
                Cancel Appointment
            </div>
        </div>

        <!-- Quick Book Modal - Multi-Service -->
        <div class="modal fade" id="quickBookModal" tabindex="-1">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div
                    class="modal-content"
                    style="
                        border-radius: 16px;
                        border: none;
                        box-shadow: var(--shadow-xl);
                    "
                >
                    <div
                        class="modal-header"
                        style="
                            border-bottom: 2px solid var(--border-color);
                            padding: 20px 24px;
                            background: linear-gradient(
                                135deg,
                                #667eea 0%,
                                #764ba2 100%
                            );
                        "
                    >
                        <h5
                            class="modal-title"
                            style="
                                font-weight: 700;
                                font-size: 20px;
                                color: white;
                            "
                        >
                            <i class="fas fa-calendar-plus me-2"></i>
                            Book Multiple Services - Quick & Easy
                        </h5>
                        <button
                            type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body" style="padding: 24px">
                        <form
                            id="quickBookForm"
                            action="/api/unaki/create-appointment"
                            method="POST"
                        >
                            <!-- Client Information -->
                            <div class="row mb-4">
                                <div class="col-12 mb-3">
                                    <h6
                                        style="
                                            color: var(--primary-color);
                                            font-weight: 700;
                                            margin-bottom: 16px;
                                        "
                                    >
                                        <i class="fas fa-user-circle"></i>
                                        Client Information
                                    </h6>
                                </div>
                                <!-- Client Selection Dropdown -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">
                                        <i
                                            class="fas fa-users me-2"
                                            style="color: var(--primary-color)"
                                        ></i>
                                        Select Client *
                                    </label>
                                    <select
                                        id="clientSelect"
                                        name="client_id"
                                        class="form-select"
                                        required
                                        onchange="populateClientInfo(this.value)"
                                        style="
                                            border-radius: 10px;
                                            padding: 12px;
                                        "
                                    >
                                        <option value="">Select a client...</option>
                                        <option value="new">
                                            + Add New Client
                                        </option>
                                        {% if clients %} {% for client in clients
                                        %}
                                        <option
                                            value="{{ client.id }}"
                                            data-phone="{{ client.phone }}"
                                        >
                                            {{ client.name }}
                                        </option>
                                        {% endfor %} {% endif %}
                                    </select>
                                </div>

                                <!-- New Client Fields -->
                                <div
                                    id="newClientFields"
                                    style="display: none"
                                    class="row w-100 m-0"
                                >
                                    <div class="col-md-6 mb-3 ps-0">
                                        <label class="form-label fw-semibold">
                                            <i
                                                class="fas fa-user me-2"
                                                style="color: var(--primary-color)"
                                            ></i>
                                            New Client Name *
                                        </label>
                                        <input
                                            type="text"
                                            id="newClientName"
                                            name="new_client_name"
                                            class="form-control"
                                            placeholder="Enter new client name"
                                            style="
                                                border-radius: 10px;
                                                padding: 12px;
                                            "
                                        />
                                        <input
                                            type="hidden"
                                            id="clientName"
                                            name="client_name"
                                        />
                                    </div>
                                    <div class="col-md-6 mb-3 pe-0">
                                        <label class="form-label fw-semibold">
                                            <i
                                                class="fas fa-phone me-2"
                                                style="color: var(--primary-color)"
                                            ></i>
                                            Client Phone
                                        </label>
                                        <input
                                            type="tel"
                                            id="clientPhone"
                                            name="client_phone"
                                            class="form-control"
                                            placeholder="Enter phone number"
                                            style="
                                                border-radius: 10px;
                                                padding: 12px;
                                            "
                                        />
                                    </div>
                                </div>

                                <!-- Existing Client Fields (will be populated by JS) -->
                                <div id="existingClientFields">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold">
                                            <i
                                                class="fas fa-user me-2"
                                                style="color: var(--primary-color)"
                                            ></i>
                                            Client Name
                                        </label>
                                        <input
                                            type="text"
                                            id="clientName"
                                            name="client_name"
                                            class="form-control"
                                            readonly
                                            style="
                                                border-radius: 10px;
                                                padding: 12px;
                                                background-color: #e9ecef;
                                            "
                                        />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold">
                                            <i
                                                class="fas fa-phone me-2"
                                                style="color: var(--primary-color)"
                                            ></i>
                                            Client Phone
                                        </label>
                                        <input
                                            type="tel"
                                            id="clientPhone"
                                            name="client_phone"
                                            class="form-control"
                                            readonly
                                            style="
                                                border-radius: 10px;
                                                padding: 12px;
                                                background-color: #e9ecef;
                                            "
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- Service Selection -->
                            <div class="mb-4">
                                <h6
                                    style="
                                        color: var(--primary-color);
                                        font-weight: 700;
                                        margin-bottom: 16px;
                                    "
                                >
                                    <i class="fas fa-spa"></i> Select Services
                                    (Check all that apply)
                                </h6>
                                <div
                                    style="
                                        max-height: 350px;
                                        overflow-y: auto;
                                        border: 2px solid #e5e7eb;
                                        border-radius: 12px;
                                        padding: 16px;
                                        background: #fafbfc;
                                    "
                                >
                                    {% if services %} {% for service in services
                                    %}
                                    <div
                                        id="serviceItem{{ service.id }}"
                                        class="form-check service-checkbox-item"
                                        style="
                                            padding: 14px;
                                            margin-bottom: 10px;
                                            background: white;
                                            border-radius: 10px;
                                            border: 2px solid #e5e7eb;
                                            transition: all 0.2s;
                                        "
                                    >
                                        <input
                                            class="form-check-input service-checkbox"
                                            type="checkbox"
                                            value="{{ service.id }}"
                                            id="service{{ service.id }}"
                                            data-duration="{{ service.duration or 60 }}"
                                            data-price="{{ service.price }}"
                                            data-name="{{ service.name }}"
                                            style="
                                                width: 22px;
                                                height: 22px;
                                                margin-top: 0;
                                            "
                                        />
                                        <label
                                            class="form-check-label"
                                            for="service{{ service.id }}"
                                            style="
                                                cursor: pointer;
                                                margin-left: 14px;
                                                flex: 1;
                                            "
                                        >
                                            <div
                                                style="
                                                    display: flex;
                                                    justify-content: space-between;
                                                    align-items: center;
                                                "
                                            >
                                                <div>
                                                    <strong
                                                        style="
                                                            font-size: 15px;
                                                            color: #1f2937;
                                                        "
                                                        >{{ service.name
                                                        }}</strong
                                                    >
                                                    <div
                                                        style="
                                                            font-size: 13px;
                                                            color: #6b7280;
                                                            margin-top: 4px;
                                                        "
                                                    >
                                                        <i
                                                            class="fas fa-clock"
                                                            style="
                                                                font-size: 11px;
                                                            "
                                                        ></i>
                                                        {{ service.duration or
                                                        60 }} minutes {% if
                                                        service.category %} •
                                                        <span
                                                            style="
                                                                background: #e5e7eb;
                                                                padding: 2px 8px;
                                                                border-radius: 4px;
                                                                font-size: 11px;
                                                            "
                                                            >{{ service.category
                                                            }}</span
                                                        >
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <span
                                                    style="
                                                        font-weight: 700;
                                                        color: var(
                                                            --primary-color
                                                        );
                                                        font-size: 18px;
                                                    "
                                                >
                                                    ${{
                                                    "%.2f"|format(service.price)
                                                    }}
                                                </span>
                                            </div>
                                        </label>
                                    </div>
                                    {% endfor %} {% else %}
                                    <div class="text-center text-muted py-4">
                                        <i
                                            class="fas fa-exclamation-circle fa-2x mb-3"
                                        ></i>
                                        <p>No services available</p>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Staff Selection for each service -->
                                <div
                                    id="serviceStaffSelections"
                                    style="margin-top: 16px; display: none"
                                >
                                    {% if services %} {% for service in services
                                    %}
                                    <div
                                        id="staffSelection{{ service.id }}"
                                        style="
                                            display: none;
                                            margin-bottom: 12px;
                                            padding: 12px;
                                            background: #f9fafb;
                                            border-radius: 10px;
                                            border: 1px solid var(--border-color);
                                        "
                                    >
                                        <label
                                            class="form-label fw-semibold me-2"
                                            style="color: #1f2937"
                                        >
                                            <i
                                                class="fas fa-user-md me-2"
                                                style="
                                                    color: var(--primary-color);
                                                "
                                            ></i>
                                            Assign Staff for {{ service.name }}:
                                        </label>
                                        <select
                                            id="staffSelect{{ service.id }}"
                                            name="staff_id_service_{{ service.id }}"
                                            class="form-select service-staff-select"
                                            style="
                                                flex-grow: 1;
                                                border-radius: 8px;
                                                padding: 8px;
                                            "
                                        >
                                            <option value="">
                                                Select Staff
                                            </option>
                                            {% if staff_members %} {% for staff
                                            in staff_members %}
                                            <option value="{{ staff.id }}">
                                                {{ staff.first_name }} {{
                                                staff.last_name if
                                                staff.last_name else '' }}
                                            </option>
                                            {% endfor %} {% endif %}
                                        </select>
                                    </div>
                                    {% endfor %} {% endif %}
                                </div>

                                <!-- Selected Services Summary -->
                                <div
                                    id="selectedServicesSummary"
                                    style="
                                        margin-top: 16px;
                                        padding: 16px;
                                        background: linear-gradient(
                                            135deg,
                                            #e0e7ff 0%,
                                            #f3e8ff 100%
                                        );
                                        border-radius: 12px;
                                        display: none;
                                    "
                                >
                                    <div
                                        style="
                                            font-weight: 700;
                                            color: #4338ca;
                                            margin-bottom: 12px;
                                            font-size: 15px;
                                        "
                                    >
                                        <i class="fas fa-check-double"></i>
                                        Selected Services:
                                    </div>
                                    <div
                                        id="selectedServicesList"
                                        style="
                                            font-size: 13px;
                                            color: #1f2937;
                                            line-height: 1.8;
                                        "
                                    ></div>
                                </div>
                            </div>

                            <!-- Appointment Details -->
                            <div class="mb-4">
                                <h6
                                    style="
                                        color: var(--primary-color);
                                        font-weight: 700;
                                        margin-bottom: 16px;
                                    "
                                >
                                    <i class="fas fa-calendar-day"></i>
                                    Appointment Details
                                </h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold">
                                            <i
                                                class="fas fa-user-md me-2"
                                                style="
                                                    color: var(--primary-color);
                                                "
                                            ></i>
                                            Assigned Staff *
                                        </label>
                                        <select
                                            id="quickStaff"
                                            name="staff_id"
                                            class="form-select"
                                            required
                                            style="
                                                border-radius: 10px;
                                                padding: 12px;
                                            "
                                        >
                                            <option value="">
                                                Select staff member...
                                            </option>
                                            {% if staff_members %} {% for staff
                                            in staff_members %}
                                            <option value="{{ staff.id }}">
                                                {{ staff.first_name }} {{
                                                staff.last_name if
                                                staff.last_name else '' }}
                                            </option>
                                            {% endfor %} {% endif %}
                                        </select>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label fw-semibold">
                                            <i
                                                class="fas fa-calendar me-2"
                                                style="
                                                    color: var(--primary-color);
                                                "
                                            ></i>
                                            Date *
                                        </label>
                                        <input
                                            type="date"
                                            id="quickDate"
                                            name="booking_date"
                                            class="form-control"
                                            value="{{ today }}"
                                            required
                                            style="
                                                border-radius: 10px;
                                                padding: 12px;
                                            "
                                        />
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label fw-semibold">
                                            <i
                                                class="fas fa-clock me-2"
                                                style="
                                                    color: var(--primary-color);
                                                "
                                            ></i>
                                            Start Time *
                                        </label>
                                        <input
                                            type="time"
                                            id="quickTime"
                                            name="start_time"
                                            class="form-control"
                                            value="09:00"
                                            required
                                            style="
                                                border-radius: 10px;
                                                padding: 12px;
                                            "
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- Summary Cards -->
                            <div class="row mb-3">
                                <div class="col-md-4 mb-3">
                                    <div
                                        style="
                                            background: linear-gradient(
                                                135deg,
                                                #dbeafe 0%,
                                                #bfdbfe 100%
                                            );
                                            padding: 20px;
                                            border-radius: 12px;
                                            text-align: center;
                                        "
                                    >
                                        <label
                                            class="form-label fw-semibold"
                                            style="
                                                color: #1e40af;
                                                margin-bottom: 10px;
                                                font-size: 13px;
                                            "
                                        >
                                            <i
                                                class="fas fa-hourglass-half"
                                            ></i>
                                            TOTAL DURATION
                                        </label>
                                        <div
                                            style="
                                                font-size: 32px;
                                                font-weight: 800;
                                                color: #1e40af;
                                            "
                                            id="totalDurationDisplay"
                                        >
                                            0 min
                                        </div>
                                        <input
                                            type="hidden"
                                            id="totalDuration"
                                            name="total_duration"
                                            value="0"
                                        />
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div
                                        style="
                                            background: linear-gradient(
                                                135deg,
                                                #d1fae5 0%,
                                                #a7f3d0 100%
                                            );
                                            padding: 20px;
                                            border-radius: 12px;
                                            text-align: center;
                                        "
                                    >
                                        <label
                                            class="form-label fw-semibold"
                                            style="
                                                color: #065f46;
                                                margin-bottom: 10px;
                                                font-size: 13px;
                                            "
                                        >
                                            <i class="fas fa-dollar-sign"></i>
                                            TOTAL PRICE
                                        </label>
                                        <div
                                            style="
                                                font-size: 32px;
                                                font-weight: 800;
                                                color: #065f46;
                                            "
                                            id="totalPriceDisplay"
                                        >
                                            $0.00
                                        </div>
                                        <input
                                            type="hidden"
                                            id="totalPrice"
                                            name="total_price"
                                            value="0"
                                        />
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div
                                        style="
                                            background: linear-gradient(
                                                135deg,
                                                #fef3c7 0%,
                                                #fde68a 100%
                                            );
                                            padding: 20px;
                                            border-radius: 12px;
                                            text-align: center;
                                        "
                                    >
                                        <label
                                            class="form-label fw-semibold"
                                            style="
                                                color: #92400e;
                                                margin-bottom: 10px;
                                                font-size: 13px;
                                            "
                                        >
                                            <i class="fas fa-clock"></i> END
                                            TIME
                                        </label>
                                        <div
                                            style="
                                                font-size: 32px;
                                                font-weight: 800;
                                                color: #92400e;
                                            "
                                            id="endTimeDisplay"
                                        >
                                            --:--
                                        </div>
                                        <input
                                            type="hidden"
                                            id="endTime"
                                            name="end_time"
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- Notes -->
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-sticky-note me-2"
                                        style="color: var(--primary-color)"
                                    ></i>
                                    Notes
                                </label>
                                <textarea
                                    id="quickNotes"
                                    name="notes"
                                    class="form-control"
                                    rows="3"
                                    placeholder="Add any special instructions or notes..."
                                    style="border-radius: 10px; padding: 12px"
                                ></textarea>
                            </div>
                        </form>
                    </div>
                    <div
                        class="modal-footer"
                        style="
                            border-top: 2px solid var(--border-color);
                            padding: 16px 24px;
                            background: #f9fafb;
                        "
                    >
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                            style="
                                border-radius: 10px;
                                padding: 12px 24px;
                                font-weight: 600;
                            "
                        >
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button
                            type="button"
                            class="btn btn-primary"
                            onclick="processQuickBook()"
                            style="
                                border-radius: 10px;
                                padding: 12px 24px;
                                background: var(--primary-color);
                                border: none;
                                font-weight: 600;
                                font-size: 15px;
                            "
                        >
                            <i class="fas fa-check-circle me-2"></i>Book All
                            Services
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Global variables
            let selectedAppointmentId = null;
            const currentDate = "{{ today }}";
            let bookingsData = [];

            // Initialize on page load
            document.addEventListener("DOMContentLoaded", function () {
                loadBookings();
                updateCurrentTimeLine();
                setInterval(updateCurrentTimeLine, 60000);

                setupTooltips();

                document.addEventListener("click", function () {
                    hideContextMenu();
                });

                // Setup service checkbox listeners
                const serviceCheckboxes =
                    document.querySelectorAll(".service-checkbox");
                if (serviceCheckboxes.length > 0) {
                    serviceCheckboxes.forEach((checkbox) => {
                        checkbox.addEventListener(
                            "change",
                            calculateDurationAndPrice,
                        );
                    });
                }

                const startTimeInput = document.getElementById("quickTime");
                if (startTimeInput) {
                    startTimeInput.addEventListener("change", calculateEndTime);
                }

                // Keyboard shortcuts
                document.addEventListener("keydown", function (e) {
                    if (e.key === "n" && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        openQuickBookModal();
                    }
                    if (e.key === "r" && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        refreshSchedule();
                    }
                });
            });

            // Setup tooltips
            function setupTooltips() {
                const tooltip = document.getElementById("tooltip");
                const elementsWithTooltip =
                    document.querySelectorAll("[data-tooltip]");

                elementsWithTooltip.forEach((element) => {
                    element.addEventListener("mouseenter", function (e) {
                        const text = this.getAttribute("data-tooltip");
                        tooltip.textContent = text;
                        tooltip.classList.add("show");

                        const rect = this.getBoundingClientRect();
                        tooltip.style.left =
                            rect.left +
                            rect.width / 2 -
                            tooltip.offsetWidth / 2 +
                            "px";
                        tooltip.style.top = rect.bottom + 8 + "px";
                    });

                    element.addEventListener("mouseleave", function () {
                        tooltip.classList.remove("show");
                    });
                });
            }

            // Load bookings
            function loadBookings() {
                const overlay = document.getElementById("loadingOverlay");
                overlay.classList.add("show");

                fetch("/api/unaki/schedule?date=" + currentDate)
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            bookingsData = data.appointments || [];
                            renderBookings();
                            updateStats();
                        }
                    })
                    .catch((error) => {
                        console.error("Error loading bookings:", error);
                    })
                    .finally(() => {
                        overlay.classList.remove("show");
                    });
            }

            // Update stats
            function updateStats() {
                const total = bookingsData.length;
                const completed = bookingsData.filter(
                    (b) => b.status === "completed",
                ).length;

                document.getElementById("totalBookings").textContent = total;
                document.getElementById("completedBookings").textContent =
                    completed;
            }

            // Render bookings
            function renderBookings() {
                document
                    .querySelectorAll(".appointment-block")
                    .forEach((el) => el.remove());

                bookingsData.forEach((booking) => {
                    const row = document.querySelector(
                        `.timeline-row[data-staff-id="${booking.staffId}"]`,
                    );
                    if (!row) return;

                    const [startHour, startMinute] = booking.startTime
                        .split(":")
                        .map(Number);
                    const hoursSince9AM = startHour - 9 + startMinute / 60;
                    const leftPosition = hoursSince9AM * 140;

                    const durationHours = booking.duration / 60;
                    const width = Math.max(durationHours * 140, 80);

                    const serviceType = (booking.service || "")
                        .toLowerCase()
                        .replace(/\s+/g, "-");

                    const block = document.createElement("div");
                    block.className = `appointment-block service-${serviceType}`;
                    block.style.left = `${leftPosition}px`;
                    block.style.width = `${width}px`;
                    block.dataset.appointmentId = booking.id;
                    block.draggable = true;

                    block.onclick = () => viewAppointment(booking.id);
                    block.oncontextmenu = (e) => {
                        showContextMenu(e, booking.id);
                        return false;
                    };

                    block.ondragstart = (e) => {
                        block.classList.add("dragging");
                        e.dataTransfer.effectAllowed = "move";
                        e.dataTransfer.setData("appointmentId", booking.id);
                    };

                    block.ondragend = () => {
                        block.classList.remove("dragging");
                    };

                    block.innerHTML = `
            <div class="appointment-header">
                <div class="appointment-client">${booking.clientName}</div>
                <div class="appointment-status"></div>
            </div>
            <div class="appointment-service">${booking.service}</div>
            <div class="appointment-footer">
                <div class="appointment-time">
                    <i class="fas fa-clock"></i>
                    ${booking.startTime}
                </div>
                <div class="appointment-duration">${booking.duration}m</div>
            </div>
        `;

                    row.appendChild(block);
                });
            }

            // Calculate total duration and price from selected services
            function calculateDurationAndPrice() {
                const checkboxes = document.querySelectorAll(
                    ".service-checkbox:checked",
                );

                let totalDuration = 0;
                let totalPrice = 0;
                let selectedServices = [];

                checkboxes.forEach((checkbox) => {
                    const duration = parseInt(checkbox.dataset.duration) || 60;
                    const price = parseFloat(checkbox.dataset.price) || 0;
                    const name = checkbox.dataset.name;

                    totalDuration += duration;
                    totalPrice += price;
                    selectedServices.push({ name, duration, price });
                });

                // Update duration and price displays
                document.getElementById("totalDuration").value = totalDuration;
                document.getElementById("totalDurationDisplay").textContent =
                    totalDuration + " min";
                document.getElementById("totalPrice").value =
                    totalPrice.toFixed(2);
                document.getElementById("totalPriceDisplay").textContent =
                    "$" + totalPrice.toFixed(2);

                // Update selected services summary
                const summary = document.getElementById(
                    "selectedServicesSummary",
                );
                const list = document.getElementById("selectedServicesList");

                if (selectedServices.length > 0) {
                    summary.style.display = "block";
                    list.innerHTML = selectedServices
                        .map(
                            (s, i) =>
                                `<div style="padding: 6px 0; display: flex; justify-content: space-between; ${i > 0 ? "border-top: 1px solid rgba(67, 56, 202, 0.2); padding-top: 8px; margin-top: 6px;" : ""}">
                <span><strong>${s.name}</strong> <span style="color: #6b7280;">(${s.duration} min)</span></span>
                <span style="color: #4338ca; font-weight: 700;">$${s.price.toFixed(2)}</span>
            </div>`,
                        )
                        .join("");
                } else {
                    summary.style.display = "none";
                }

                calculateEndTime();
            }

            // Calculate end time
            function calculateEndTime() {
                const startTime = document.getElementById("quickTime").value;
                const duration =
                    parseInt(document.getElementById("totalDuration").value) ||
                    0;

                if (!startTime || duration === 0) {
                    document.getElementById("endTime").value = "";
                    document.getElementById("endTimeDisplay").textContent =
                        "--:--";
                    return;
                }

                const [hours, minutes] = startTime.split(":").map(Number);
                const startDate = new Date();
                startDate.setHours(hours, minutes, 0);

                const endDate = new Date(
                    startDate.getTime() + duration * 60000,
                );
                const endTimeStr = endDate.toTimeString().substr(0, 5);

                document.getElementById("endTime").value = endTimeStr;
                document.getElementById("endTimeDisplay").textContent =
                    endTimeStr;
            }

            // Navigate date
            function navigateDate(days) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() + days);
                const newDate = date.toISOString().split("T")[0];
                window.location.href = `{{ url_for('unaki_booking') }}?date=${newDate}`;
            }

            // Navigate to today
            function navigateToToday() {
                const today = new Date().toISOString().split("T")[0];
                window.location.href = `{{ url_for('unaki_booking') }}?date=${today}`;
            }

            // Refresh schedule
            function refreshSchedule() {
                loadBookings();

                const btn = event.target.closest(".action-icon");
                btn.style.transform = "rotate(360deg)";
                setTimeout(() => {
                    btn.style.transform = "rotate(0deg)";
                }, 600);
            }

            // Handle slot click
            function handleSlotClick(event, staffId, hour, minute) {
                event.stopPropagation();

                const slot = event.currentTarget;
                const rect = slot.getBoundingClientRect();
                const clickX = event.clientX - rect.left;
                const slotWidth = rect.width;

                const minuteOffset =
                    Math.floor(((clickX / slotWidth) * 60) / 15) * 15;
                const time = `${String(hour).padStart(2, "0")}:${String(minuteOffset).padStart(2, "0")}`;

                openQuickBookModalWithData(staffId, currentDate, time);
            }

            // Open modal
            function openQuickBookModal() {
                const modal = new bootstrap.Modal(
                    document.getElementById("quickBookModal"),
                );
                modal.show();
            }

            // Open modal with data
            function openQuickBookModalWithData(staffId, date, time) {
                document.getElementById("quickStaff").value = staffId;
                document.getElementById("quickDate").value = date;
                document.getElementById("quickTime").value = time;
                calculateEndTime();
                openQuickBookModal();
            }

            // Process booking
            function processQuickBook() {
                const form = document.getElementById("quickBookForm");

                // Validate form
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                // Check if at least one service is selected
                const selectedServices = document.querySelectorAll(
                    ".service-checkbox:checked",
                );
                if (selectedServices.length === 0) {
                    alert("Please select at least one service");
                    return;
                }

                const overlay = document.getElementById("loadingOverlay");
                overlay.classList.add("show");

                // Get form data
                const formData = new FormData(form);
                const serviceIds = Array.from(selectedServices).map(
                    (s) => s.value,
                );

                const data = {
                    clientName: formData.get("client_name"),
                    clientPhone: formData.get("client_phone"),
                    staffId: parseInt(formData.get("staff_id")),
                    serviceType: Array.from(selectedServices)
                        .map((s) => s.dataset.name)
                        .join(", "),
                    startTime: formData.get("start_time"),
                    endTime: document.getElementById("endTime").value,
                    date: formData.get("booking_date"),
                    notes: formData.get("notes") || "",
                };

                // Submit via AJAX
                fetch("/api/unaki/create-appointment", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                })
                    .then((response) => response.json())
                    .then((result) => {
                        overlay.classList.remove("show");
                        if (result.success) {
                            bootstrap.Modal.getInstance(
                                document.getElementById("quickBookModal"),
                            ).hide();
                            showNotification(
                                "Appointment(s) booked successfully!",
                                "success",
                            );
                            loadBookings();
                            form.reset();
                            // Clear all checkboxes
                            document
                                .querySelectorAll(".service-checkbox")
                                .forEach((cb) => (cb.checked = false));
                            calculateDurationAndPrice();
                        } else {
                            showNotification(
                                "Error: " +
                                    (result.error ||
                                        "Failed to book appointment"),
                                "error",
                            );
                        }
                    })
                    .catch((error) => {
                        overlay.classList.remove("show");
                        console.error("Error:", error);
                        showNotification(
                            "An error occurred while booking",
                            "error",
                        );
                    });
            }

            // Show notification
            function showNotification(message, type) {
                alert(message);
            }

            // View appointment
            function viewAppointment(appointmentId) {
                selectedAppointmentId = appointmentId;
                alert("View appointment " + appointmentId);
            }

            // Context menu
            function showContextMenu(event, appointmentId) {
                event.preventDefault();
                selectedAppointmentId = appointmentId;

                const contextMenu = document.getElementById("contextMenu");
                contextMenu.style.left = event.pageX + "px";
                contextMenu.style.top = event.pageY + "px";
                contextMenu.classList.add("show");
            }

            function hideContextMenu() {
                const contextMenu = document.getElementById("contextMenu");
                contextMenu.classList.remove("show");
            }

            function viewAppointmentDetails() {
                if (selectedAppointmentId) {
                    alert(
                        "View details for appointment " + selectedAppointmentId,
                    );
                }
                hideContextMenu();
            }

            function editAppointment() {
                if (selectedAppointmentId) {
                    alert("Edit appointment " + selectedAppointmentId);
                }
                hideContextMenu();
            }

            function checkInAppointment() {
                if (selectedAppointmentId) {
                    alert("Check in appointment " + selectedAppointmentId);
                }
                hideContextMenu();
            }

            function duplicateAppointment() {
                if (selectedAppointmentId) {
                    alert("Duplicate appointment " + selectedAppointmentId);
                }
                hideContextMenu();
            }

            function cancelAppointment() {
                if (
                    selectedAppointmentId &&
                    confirm("Are you sure you want to cancel this appointment?")
                ) {
                    alert("Cancel appointment " + selectedAppointmentId);
                }
                hideContextMenu();
            }

            // Update current time line
            function updateCurrentTimeLine() {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                if (currentHour >= 9 && currentHour < 22) {
                    const timeLine = document.getElementById("currentTimeLine");
                    const timeLabel =
                        document.getElementById("currentTimeLabel");

                    const hoursSince9AM = currentHour - 9;
                    const minuteOffset = currentMinute / 60;
                    const leftPosition = (hoursSince9AM + minuteOffset) * 140;

                    const timeStr = now.toLocaleTimeString("en-US", {
                        hour: "2-digit",
                        minute: "2-digit",
                        hour12: true,
                    });

                    timeLabel.textContent = timeStr;
                    timeLine.style.left = leftPosition + "px";
                    timeLine.style.display = "block";
                }
            }

            // Client selection functionality
            function populateClientInfo(clientId) {
                const clientSelect = document.getElementById('clientSelect');
                const clientPhone = document.getElementById('clientPhone');
                const clientNameHidden = document.getElementById('clientName');
                const newClientFields = document.getElementById('newClientFields');
                const existingClientFields = document.getElementById('existingClientFields');

                // Hide all client fields initially
                newClientFields.style.display = 'none';
                existingClientFields.style.display = 'none';
                clientPhone.removeAttribute('readonly');
                clientNameHidden.removeAttribute('readonly');
                clientPhone.style.backgroundColor = '';
                clientNameHidden.style.backgroundColor = '';


                if (clientId === 'new') {
                    // Show new client fields
                    newClientFields.style.display = 'flex'; // Use flex to align columns properly
                    newClientFields.classList.add('row', 'w-100', 'm-0'); // Add Bootstrap row classes
                    clientPhone.value = '';
                    clientNameHidden.value = ''; // Clear the hidden field for new client
                    document.getElementById('newClientName').value = ''; // Clear the visible new client name field
                    document.getElementById('newClientName').required = true;
                } else if (clientId) {
                    // Populate existing client info
                    existingClientFields.style.display = 'flex'; // Use flex to align columns properly
                    existingClientFields.classList.add('row', 'w-100', 'm-0'); // Add Bootstrap row classes
                    const selectedOption = clientSelect.options[clientSelect.selectedIndex];
                    const phone = selectedOption.getAttribute('data-phone') || '';
                    clientPhone.value = phone;
                    clientNameHidden.value = selectedOption.textContent.trim(); // Set hidden field
                    document.getElementById('newClientName').value = ''; // Clear new client name field
                    document.getElementById('newClientName').required = false;

                    // Make fields readonly for existing clients
                    clientPhone.readOnly = true;
                    clientNameHidden.readOnly = true;
                    clientPhone.style.backgroundColor = '#e9ecef';
                    clientNameHidden.style.backgroundColor = '#e9ecef';
                } else {
                    // Clear all fields if no client is selected
                    clientPhone.value = '';
                    clientNameHidden.value = '';
                    document.getElementById('newClientName').value = '';
                }
            }

            // Service staff selection toggle
            function toggleServiceStaffSelection(serviceId, isChecked) {
                const staffSelectionDiv = document.getElementById('staffSelection' + serviceId);
                const serviceItem = document.getElementById('serviceItem' + serviceId);
                const staffSelect = document.getElementById('staffSelect' + serviceId);

                if (isChecked) {
                    staffSelectionDiv.style.display = 'flex'; // Use flex to align items
                    serviceItem.style.borderColor = 'var(--primary-color)';
                    serviceItem.style.background = 'linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%)';
                    staffSelect.required = true;
                } else {
                    staffSelectionDiv.style.display = 'none';
                    serviceItem.style.borderColor = '#e5e7eb';
                    serviceItem.style.background = 'white';
                    staffSelect.required = false;
                    staffSelect.value = ''; // Reset staff selection
                }
                updateSelectedServicesSummary();
            }

            // Update selected services summary
            function updateSelectedServicesSummary() {
                const selectedServices = [];
                let totalDuration = 0;
                let totalPrice = 0;

                document.querySelectorAll('.service-checkbox:checked').forEach(checkbox => {
                    const serviceId = checkbox.value;
                    const serviceName = checkbox.getAttribute('data-name');
                    const duration = parseInt(checkbox.getAttribute('data-duration'));
                    const price = parseFloat(checkbox.getAttribute('data-price'));

                    const staffSelect = document.getElementById('staffSelect' + serviceId);
                    const staffName = staffSelect.options[staffSelect.selectedIndex]?.text || 'Not Selected';

                    selectedServices.push({
                        name: serviceName,
                        duration: duration,
                        price: price,
                        staff: staffName
                    });

                    totalDuration += duration;
                    totalPrice += price;
                });

                // Update summary display
                const summary = document.getElementById('selectedServicesSummary');
                const summaryList = document.getElementById('selectedServicesList');

                if (selectedServices.length > 0) {
                    summary.style.display = 'block';
                    summaryList.innerHTML = selectedServices.map(service => 
                        `<div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 6px; border-left: 3px solid var(--primary-color);">
                            <strong>${service.name}</strong> - $${service.price.toFixed(2)} (${service.duration} min)<br>
                            <small style="color: #6b7280;"><i class="fas fa-user-md"></i> Staff: ${service.staff}</small>
                        </div>`
                    ).join('');
                } else {
                    summary.style.display = 'none';
                }

                // Update totals
                document.getElementById('totalDurationDisplay').textContent = totalDuration + ' min';
                document.getElementById('totalPriceDisplay').textContent = '$' + totalPrice.toFixed(2);

                // Calculate end time
                const startTime = document.getElementById('quickTime').value;
                if (startTime && totalDuration > 0) {
                    const [hours, minutes] = startTime.split(':').map(Number);
                    const startDate = new Date();
                    startDate.setHours(hours, minutes, 0, 0);
                    const endDate = new Date(startDate.getTime() + totalDuration * 60000);
                    const endTime = endDate.toTimeString().slice(0, 5);
                    document.getElementById('endTimeDisplay').textContent = endTime;
                    document.getElementById('endTime').value = endTime;
                } else {
                    document.getElementById('endTimeDisplay').textContent = '--:--';
                    document.getElementById('endTime').value = '';
                }
            }

            // Add event listeners for staff selections
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('service-staff-select')) {
                    updateSelectedServicesSummary();
                }
            });

            // Add event listener for new client name input to update hidden field
            document.getElementById('newClientName').addEventListener('input', function() {
                document.getElementById('clientName').value = this.value;
            });

            // Update form submission to handle new client creation and service staff assignment
            document.getElementById('quickBookForm').addEventListener('submit', function(e) {
                e.preventDefault();

                const clientSelect = document.getElementById('clientSelect');
                const newClientNameInput = document.getElementById('newClientName');
                const clientNameHidden = document.getElementById('clientName');
                const clientPhone = document.getElementById('clientPhone');

                // Ensure client name and phone are set correctly before submission
                if (clientSelect.value === 'new') {
                    if (!newClientNameInput.value.trim()) {
                        alert('Please enter the client name for the new client.');
                        newClientNameInput.focus();
                        return;
                    }
                    clientNameHidden.value = newClientNameInput.value.trim();
                    // Phone number is optional for new clients, so no extra check needed here unless required by backend
                } else if (!clientSelect.value) {
                     alert('Please select a client or add a new one.');
                     clientSelect.focus();
                     return;
                } else {
                    // For existing clients, the hidden clientName and phone fields are already populated by populateClientInfo
                    // No need to change clientNameHidden.value here
                }


                // Validate that all selected services have staff assigned
                const selectedServicesCheckboxes = document.querySelectorAll('.service-checkbox:checked');
                for (let i = 0; i < selectedServicesCheckboxes.length; i++) {
                    const serviceId = selectedServicesCheckboxes[i].value;
                    const staffSelect = document.getElementById('staffSelect' + serviceId);
                    if (!staffSelect || !staffSelect.value) {
                        const serviceName = selectedServicesCheckboxes[i].getAttribute('data-name');
                        alert(`Please select a staff member for ${serviceName}`);
                        staffSelect.focus();
                        return;
                    }
                }

                if (selectedServicesCheckboxes.length === 0) {
                    alert('Please select at least one service.');
                    return;
                }

                // Prepare data for submission
                const formData = new FormData(form);
                const appointmentData = {
                    client_id: clientSelect.value === 'new' ? null : clientSelect.value,
                    client_name: clientNameHidden.value,
                    client_phone: clientPhone.value,
                    staff_id: parseInt(document.getElementById('quickStaff').value), // Main staff for the appointment slot
                    booking_date: formData.get('booking_date'),
                    start_time: formData.get('start_time'),
                    end_time: document.getElementById('endTime').value,
                    notes: formData.get('notes') || '',
                    services: []
                };

                selectedServicesCheckboxes.forEach(checkbox => {
                    const serviceId = checkbox.value;
                    appointmentData.services.push({
                        service_id: parseInt(serviceId),
                        staff_id: parseInt(document.getElementById('staffSelect' + serviceId).value)
                    });
                });

                // Submit data via AJAX
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.add('show');

                fetch("/api/unaki/create-appointment", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(appointmentData),
                })
                .then(response => response.json())
                .then(result => {
                    overlay.classList.remove('show');
                    if (result.success) {
                        bootstrap.Modal.getInstance(document.getElementById('quickBookModal')).hide();
                        showNotification("Appointment(s) booked successfully!", "success");
                        loadBookings(); // Reload bookings to show the new appointment
                        form.reset(); // Reset form fields
                        // Clear all checkboxes and summary
                        document.querySelectorAll('.service-checkbox').forEach(cb => cb.checked = false);
                        document.getElementById('selectedServicesSummary').style.display = 'none';
                        document.getElementById('selectedServicesList').innerHTML = '';
                        document.getElementById('totalDurationDisplay').textContent = '0 min';
                        document.getElementById('totalPriceDisplay').textContent = '$0.00';
                        document.getElementById('endTimeDisplay').textContent = '--:--';
                        document.getElementById('quickStaff').value = ''; // Reset main staff
                        document.getElementById('quickTime').value = '09:00'; // Reset time
                        // Reset client selection
                        const clientSelectElement = document.getElementById('clientSelect');
                        clientSelectElement.value = '';
                        populateClientInfo(''); // Clear client fields

                    } else {
                        showNotification("Error: " + (result.error || "Failed to book appointment"), "error");
                    }
                })
                .catch(error => {
                    overlay.classList.remove('show');
                    console.error("Error:", error);
                    showNotification("An error occurred while booking", "error");
                });
            });

            // Initialize service selection listeners
            document.querySelectorAll('.service-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    toggleServiceStaffSelection(this.value, this.checked);
                });
            });

            // Initial call to set up client fields based on default selection (if any)
            document.addEventListener('DOMContentLoaded', function() {
                populateClientInfo(document.getElementById('clientSelect').value);
                const serviceCheckboxes = document.querySelectorAll('.service-checkbox');
                serviceCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        toggleServiceStaffSelection(checkbox.value, true);
                    }
                });
                updateSelectedServicesSummary(); // Update summary on load if services are pre-checked
            });

        </script>
    </body>
</html>