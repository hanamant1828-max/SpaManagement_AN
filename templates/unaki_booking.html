<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unaki Appointment Booking - Professional Spa Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Animation Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- Appointment Context Menu -->
    <script src="{{ url_for('static', filename='js/appointment_context_menu.js') }}"></script>
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin: 20px;
            min-height: calc(100vh - 40px);
        }

        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            position: relative;
            overflow: hidden;
        }

        .header-section::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        .schedule-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e2e8f0;
            margin: 20px;
            position: relative;
        }

        .schedule-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid #e2e8f0;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 240px repeat(144, 45px);
            border-radius: 16px;
            overflow: hidden;
            background: white;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border: 2px solid #e2e8f0;
        }

        .time-header, .staff-cell, .time-slot {
            border-right: 1px solid #e2e8f0;
            border-bottom: 1px solid #e2e8f0;
            padding: 16px 8px;
            text-align: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .time-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-weight: 700;
            font-size: 10px;
            color: white;
            border-bottom: 2px solid #4f46e5;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .staff-cell {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            text-align: left;
            font-weight: 700;
            position: relative;
            transition: all 0.3s ease;
            border-right: 3px solid #667eea;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 12px 16px;
        }

        .staff-cell:hover {
            background: linear-gradient(135deg, #edf2f7 0%, #e2e8f0 100%);
            transform: translateX(3px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .staff-name {
            font-size: 14px;
            color: #1a202c;
            margin-bottom: 4px;
            font-weight: 700;
            line-height: 1.2;
        }

        .staff-role {
            font-size: 10px;
            color: #4a5568;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            opacity: 0.8;
            background: rgba(102, 126, 234, 0.1);
            padding: 2px 6px;
            border-radius: 8px;
            display: inline-block;
        }

        .time-slot {
            min-height: 90px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            border-radius: 4px;
            margin: 1px;
        }

        .time-slot:hover {
            background: linear-gradient(135deg, #e6f3ff 0%, #cce7ff 100%);
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            border: 2px solid #667eea;
            z-index: 10;
        }

        .time-slot:empty::after {
            content: '‚úö';
            font-size: 20px;
            color: #cbd5e0;
            font-weight: 300;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .time-slot:empty:hover::after {
            opacity: 1;
            color: #667eea;
            transform: scale(1.2);
        }

        .appointment-block {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 8px 10px;
            font-size: 11px;
            line-height: 1.3;
            cursor: pointer;
            min-height: 70px;
            z-index: 15;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            overflow: hidden;
            width: calc(100% - 2px);
        }

        .appointment-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, rgba(255,255,255,0.5), transparent, rgba(255,255,255,0.5));
        }

        .appointment-block:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        .appointment-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .appointment-block:hover .appointment-actions {
            opacity: 1;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 8px;
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .edit-btn {
            color: #f0e68c;
        }
        .edit-btn:hover {
            background: rgba(240, 230, 140, 0.3);
        }

        .delete-btn {
            color: #f08080;
        }
        .delete-btn:hover {
            background: rgba(240, 128, 128, 0.3);
        }

        .appointment-client {
            font-weight: 700;
            margin-bottom: 2px;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .appointment-service {
            font-size: 9px;
            opacity: 0.9;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .appointment-time {
            font-size: 8px;
            opacity: 0.8;
            font-weight: 500;
            margin-top: auto;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 4px;
            border-radius: 4px;
            text-align: center;
        }

        .break-block {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border-radius: 12px;
            padding: 8px;
            font-size: 11px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            cursor: default;
            min-height: 70px;
            z-index: 15;
            border: 2px solid #fc8181;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }

        .header-controls {
            padding: 2rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid #e2e8f0;
            position: relative;
        }

        .header-controls::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-outline-secondary {
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: #667eea;
            border-radius: 12px;
            padding: 10px 20px;
            transition: all 0.3s ease;
            background: white;
            font-weight: 500;
        }

        .btn-outline-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .stats-row {
            padding: 2rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
            position: relative;
        }

        .stat-item {
            text-align: center;
            padding: 1.5rem;
            background: white;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            transition: all 0.4s ease;
            border: 1px solid rgba(226, 232, 240, 0.6);
            position: relative;
            overflow: hidden;
        }

        .stat-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eeaa, #764ba2);
        }

        .stat-item:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 50px rgba(102, 126, 234, 0.2);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .modal-content {
            border-radius: 24px;
            border: none;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 2rem;
            position: relative;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="1" fill="white" opacity="0.1"/><circle cx="80" cy="80" r="1" fill="white" opacity="0.1"/><circle cx="40" cy="60" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }

        .form-control, .form-select {
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            padding: 12px 16px;
            transition: all 0.3s ease;
            font-size: 14px;
            background: white;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #667eea;
            z-index: 10000;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.4s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #10b981;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .time-input-group {
            position: relative;
        }

        .time-input-group input {
            padding-left: 40px;
        }

        .time-input-group::before {
            content: 'üïê';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
        }

        .tooltip-custom {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .schedule-grid-container {
            overflow-x: auto;
            padding: 20px;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f5f9;
        }

        .schedule-grid-container::-webkit-scrollbar {
            height: 8px;
        }

        .schedule-grid-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .schedule-grid-container::-webkit-scrollbar-thumb {
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
        }

        .quick-actions {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .quick-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            margin-bottom: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .quick-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 16px;
            }

            .schedule-grid {
                grid-template-columns: 180px repeat(144, 35px);
            }

            .header-controls {
                padding: 1rem;
            }

            .stat-item {
                padding: 1rem;
            }

            .stat-number {
                font-size: 2rem;
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .service-category-massage { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
        .service-category-facial { background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%); }
        .service-category-hair { background: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%); }
        .service-category-nails { background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%); }
        .service-category-body { background: linear-gradient(135deg, #38b2ac 0%, #319795 100%); }

        /* Conflict Detection Styles */
        .conflict-warning {
            color: #ef4444;
            font-size: 11px;
            font-weight: 600;
            margin-top: 5px;
            display: block;
        }

        .suggested-time {
            color: #3b82f6;
            cursor: pointer;
            text-decoration: underline;
            font-size: 12px;
            margin-left: 5px;
        }

        .suggested-time:hover {
            color: #2563eb;
        }

        .conflict-detected-slot {
            border: 2px solid #ef4444 !important;
            background-color: rgba(239, 68, 68, 0.1) !important;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content animate__animated animate__fadeIn">
            <div class="loading-spinner"></div>
            <h5 class="fw-bold text-primary mb-2">Loading Schedule</h5>
            <p class="text-muted mb-0">Preparing your appointment calendar...</p>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container animate__animated animate__fadeInUp">
        <!-- Header Section -->
        <div class="header-section">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="me-4">
                                <div style="width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-calendar-check" style="font-size: 2rem; color: white;"></i>
                                </div>
                            </div>
                            <div>
                                <h1 class="h2 mb-2 fw-bold">
                                    Unaki Appointment Booking
                                </h1>
                                <p class="mb-0 opacity-75" style="font-size: 1.1rem;">
                                    <i class="fas fa-sparkles me-2"></i>
                                    Professional Spa Management System
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <div class="d-flex justify-content-end align-items-center gap-3">
                            <div class="text-end">
                                <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 12px;">
                                    <div class="fw-bold" style="font-size: 1.25rem;" id="currentTime">--:--</div>
                                    <div class="opacity-75" style="font-size: 0.9rem;" id="currentDate">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Header Controls -->
        <div class="header-controls">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <div class="me-4">
                            <label class="form-label mb-2 d-block fw-semibold">
                                <i class="fas fa-calendar-day me-2 text-primary"></i>Select Date:
                            </label>
                            <div class="position-relative">
                                <input type="date" id="scheduleDate" class="form-control ps-5" onchange="showLoadingAndLoad()" style="min-width: 200px;">
                                <i class="fas fa-calendar-alt position-absolute top-50 translate-middle-y ms-3 text-muted"></i>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary" onclick="navigateDate(-1)" title="Previous Day">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="navigateDate(1)" title="Next Day">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="goToToday()" title="Today">
                                <i class="fas fa-home me-2"></i>Today
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <div class="d-flex justify-content-end gap-3">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bookingModal" title="Book New Appointment">
                            <i class="fas fa-calendar-plus me-2"></i>
                            <span class="d-none d-sm-inline">Book Appointment</span>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="showLoadingAndRefresh()" title="Refresh Schedule">
                            <i class="fas fa-sync-alt me-2"></i>
                            <span class="d-none d-md-inline">Refresh</span>
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Quick Actions">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" onclick="loadSampleData()">
                                    <i class="fas fa-database me-2"></i>Load Sample Data
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="clearAllData()">
                                    <i class="fas fa-trash me-2"></i>Clear All Data
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="exportSchedule()">
                                    <i class="fas fa-download me-2"></i>Export Schedule
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="printSchedule()">
                                    <i class="fas fa-print me-2"></i>Print Schedule
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Stats Row -->
        <div class="stats-row">
            <div class="row g-4">
                <div class="col-6 col-lg-3">
                    <div class="stat-item fade-in">
                        <div class="stat-number" id="totalAppointments">0</div>
                        <div class="stat-label">
                            <i class="fas fa-calendar-check me-1"></i>Appointments
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-item fade-in">
                        <div class="stat-number" id="activeStaff">0</div>
                        <div class="stat-label">
                            <i class="fas fa-users me-1"></i>Staff on Duty
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-item fade-in">
                        <div class="stat-number" id="availableSlots">0</div>
                        <div class="stat-label">
                            <i class="fas fa-clock me-1"></i>Available Slots
                        </div>
                    </div>
                </div>
                <div class="col-6 col-lg-3">
                    <div class="stat-item fade-in">
                        <div class="stat-number" id="utilizationRate">0%</div>
                        <div class="stat-label">
                            <i class="fas fa-chart-line me-1"></i>Utilization
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Schedule Grid -->
        <div class="schedule-container">
            <div class="schedule-grid-container">
                <div id="scheduleGrid" class="schedule-grid" style="min-width: 6200px; position: relative;">
                    <!-- Grid content will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Progress Bar for Loading -->
        <div id="progressBar" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #667eea, #764ba2); z-index: 10000;"></div>
    </div>

    <!-- Enhanced Multi-Service Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-calendar-plus me-2"></i>
                        Create New Appointment
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="bookingForm">
                        <!-- Client Information Section -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-user me-2 text-primary"></i>Client *
                                    </label>
                                    <select id="clientSelect" class="form-select" required>
                                        <option value="">Select Client</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-user-plus me-2 text-success"></i>New Client Name
                                    </label>
                                    <input type="text" id="clientName" class="form-control" placeholder="Enter new client name">
                                </div>
                            </div>
                        </div>

                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-phone me-2 text-info"></i>Phone
                                    </label>
                                    <input type="tel" id="clientPhone" class="form-control" placeholder="+1 (555) 123-4567">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-envelope me-2 text-warning"></i>Email
                                    </label>
                                    <input type="email" id="clientEmail" class="form-control" placeholder="client@example.com">
                                </div>
                            </div>
                        </div>

                        <!-- Services Section -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">
                                    <i class="fas fa-spa me-2 text-primary"></i>Services *
                                </h6>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addServiceRow()">
                                    <i class="fas fa-plus me-1"></i>Add Service
                                </button>
                            </div>

                            <div id="servicesContainer">
                                <!-- Services will be dynamically added here -->
                            </div>
                        </div>

                        <!-- Totals Section -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-12">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="form-label">Total Duration</label>
                                                <input type="text" id="totalDuration" class="form-control" readonly>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Subtotal</label>
                                                <input type="text" id="subtotalPrice" class="form-control" readonly>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Discount ($)</label>
                                                <input type="number" id="discountAmount" class="form-control" value="0" min="0" step="0.01" onchange="calculateTotals()">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label fw-bold">Grand Total</label>
                                                <input type="text" id="grandTotal" class="form-control fw-bold" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-sticky-note me-2 text-info"></i>Notes
                            </label>
                            <textarea id="appointmentNotes" class="form-control" rows="3" placeholder="Any special requests or notes..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-info" onclick="checkAvailability()">
                        <i class="fas fa-search me-2"></i>Check Availability
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="bookMultiServiceAppointment()">
                        <i class="fas fa-check me-2"></i>Book Appointment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Floating Buttons -->
    <div class="quick-actions">
        <button class="quick-action-btn" onclick="openQuickBookingModal()" title="Quick Book">
            <i class="fas fa-plus"></i>
        </button>
        <button class="quick-action-btn" onclick="showLoadingAndRefresh()" title="Refresh">
            <i class="fas fa-sync-alt"></i>
        </button>
        <button class="quick-action-btn" onclick="scrollToTop()" title="Scroll to Top">
            <i class="fas fa-arrow-up"></i>
        </button>
    </div>

    <!-- Edit Appointment Modal -->
    <div class="modal fade" id="editAppointmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-edit me-2"></i>
                        Edit Appointment
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="editAppointmentForm">
                        <input type="hidden" id="editAppointmentId">

                        <!-- Client Information -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-user me-2 text-primary"></i>Client Name *
                                    </label>
                                    <input type="text" id="editClientName" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-phone me-2 text-info"></i>Phone
                                    </label>
                                    <input type="tel" id="editClientPhone" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-spa me-2 text-primary"></i>Service *
                                    </label>
                                    <select id="editServiceSelect" class="form-select" required>
                                        <option value="">Select Service</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-user-tie me-2 text-success"></i>Staff *
                                    </label>
                                    <select id="editStaffSelect" class="form-select" required>
                                        <option value="">Select Staff</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Date and Time -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-calendar me-2 text-warning"></i>Date *
                                    </label>
                                    <input type="date" id="editAppointmentDate" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-clock me-2 text-info"></i>Start Time *
                                    </label>
                                    <input type="time" id="editStartTime" class="form-control" required onchange="updateEditEndTime()">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-clock me-2 text-secondary"></i>End Time
                                    </label>
                                    <input type="time" id="editEndTime" class="form-control" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Status and Notes -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-flag me-2 text-warning"></i>Status
                                    </label>
                                    <select id="editStatus" class="form-select">
                                        <option value="scheduled">Scheduled</option>
                                        <option value="confirmed">Confirmed</option>
                                        <option value="in_progress">In Progress</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                        <option value="no_show">No Show</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-dollar-sign me-2 text-success"></i>Service Price
                                    </label>
                                    <input type="number" id="editServicePrice" class="form-control" step="0.01" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-sticky-note me-2 text-info"></i>Notes
                            </label>
                            <textarea id="editAppointmentNotes" class="form-control" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" onclick="updateAppointment()">
                        <i class="fas fa-save me-2"></i>Update Appointment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 11000;"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Enhanced JavaScript with better UX
        let scheduleData = {
            staff: [],
            appointments: [],
            breaks: []
        };

        let isDragging = false;
        let dragStart = null;
        let dragSelection = null;
        let currentDate = new Date().toISOString().split('T')[0];

        // Enhanced notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();

            const bgClass = {
                'success': 'bg-success',
                'error': 'bg-danger',
                'warning': 'bg-warning',
                'info': 'bg-info'
            }[type] || 'bg-info';

            const iconClass = {
                'success': 'fas fa-check-circle',
                'error': 'fas fa-exclamation-circle',
                'warning': 'fas fa-exclamation-triangle',
                'info': 'fas fa-info-circle'
            }[type] || 'fas fa-info-circle';

            const toastHTML = `
                <div id="${toastId}" class="toast ${bgClass} text-white" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${bgClass} text-white border-0">
                        <i class="${iconClass} me-2"></i>
                        <strong class="me-auto">Notification</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);

            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { delay: duration });
            toast.show();

            // Remove from DOM after hidden
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        // Enhanced loading functions
        function showLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.add('show');

            // Show progress bar
            const progressBar = document.getElementById('progressBar');
            progressBar.style.display = 'block';
            progressBar.style.animation = 'shimmer 2s linear infinite';
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('show');

            // Hide progress bar
            setTimeout(() => {
                const progressBar = document.getElementById('progressBar');
                progressBar.style.display = 'none';
            }, 300);
        }

        function showLoadingAndLoadSample() {
            showLoading();
            setTimeout(() => {
                loadSampleData();
                hideLoading();
            }, 800);
        }

        function showLoadingAndLoad() {
            showLoading();
            setTimeout(() => {
                loadScheduleForDate();
                hideLoading();
            }, 800);
        }

        function showLoadingAndRefresh() {
            showLoading();
            setTimeout(() => {
                refreshSchedule();
                hideLoading();
            }, 600);
        }

        // Enhanced date navigation
        function navigateDate(direction) {
            const dateInput = document.getElementById('scheduleDate');
            const currentDate = new Date(dateInput.value);
            currentDate.setDate(currentDate.getDate() + direction);
            dateInput.value = currentDate.toISOString().split('T')[0];
            showLoadingAndLoad();
        }

        function goToToday() {
            const dateInput = document.getElementById('scheduleDate');
            dateInput.value = new Date().toISOString().split('T')[0];
            showLoadingAndLoad();
        }

        // Update current time and date
        function updateCurrentDateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Quick actions
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function exportSchedule() {
            showNotification('Exporting schedule...', 'info');
            // Implementation for export functionality
            setTimeout(() => {
                showNotification('Schedule exported successfully!', 'success');
            }, 2000);
        }

        function printSchedule() {
            window.print();
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all appointment data? This action cannot be undone.')) {
                showLoading();

                fetch('/api/unaki/clear-all-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data.success) {
                        showNotification(data.message, 'success');
                        // Reload the schedule after clearing data
                        loadScheduleForDate();
                    } else {
                        showNotification('Error clearing data: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error clearing data:', error);
                    showNotification('Error clearing data. Please try again.', 'error');
                });
            }
        }

        // Multi-service booking system
        let serviceRowCount = 0;
        let servicesData = [];
        let staffData = [];

        // Enhanced appointment booking
        function openQuickBookingModal() {
            const modal = new bootstrap.Modal(document.getElementById('bookingModal'));

            // Reset form
            const form = document.getElementById('bookingForm');
            if (form) form.reset();

            // Clear services container and add first service row
            const servicesContainer = document.getElementById('servicesContainer');
            servicesContainer.innerHTML = '';
            serviceRowCount = 0;
            addServiceRow();

            modal.show();

            // Focus on client selection
            setTimeout(() => {
                document.getElementById('clientName').focus();
            }, 500);
        }

        // Add a new service row
        function addServiceRow() {
            serviceRowCount++;
            const servicesContainer = document.getElementById('servicesContainer');

            const serviceRow = document.createElement('div');
            serviceRow.className = 'service-row mb-3 p-3 border rounded';
            serviceRow.id = `serviceRow_${serviceRowCount}`;

            serviceRow.innerHTML = `
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Service *</label>
                        <select class="form-select service-select" data-row="${serviceRowCount}" required>
                            <option value="">Select Service</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Staff *</label>
                        <select class="form-select staff-select" data-row="${serviceRowCount}" required>
                            <option value="">Select Staff</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Start Time *</label>
                        <input type="time" class="form-control start-time" data-row="${serviceRowCount}" required onchange="updateServiceEndTime(${serviceRowCount})">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">End Time</label>
                        <input type="time" class="form-control end-time" data-row="${serviceRowCount}" readonly>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Price ($)</label>
                        <input type="number" class="form-control service-price" data-row="${serviceRowCount}" step="0.01" readonly>
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeServiceRow(${serviceRowCount})" ${serviceRowCount === 1 ? 'style="display:none"' : ''}>
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;

            servicesContainer.appendChild(serviceRow);

            // Populate dropdowns
            populateServiceDropdown(serviceRowCount);
            populateStaffDropdown(serviceRowCount);

            // Add event listeners
            setupServiceRowEventListeners(serviceRowCount);

            // Set default start time for services
            if (serviceRowCount === 1) {
                const now = new Date();
                const nextHour = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours() + 1, 0);
                const timeString = nextHour.toTimeString().slice(0, 5);
                serviceRow.querySelector('.start-time').value = timeString;
            } else {
                // For subsequent services, start after the previous service ends
                const previousRows = document.querySelectorAll('.service-row');
                const lastRow = previousRows[previousRows.length - 2]; // Get previous row
                if (lastRow) {
                    const lastEndTime = lastRow.querySelector('.end-time').value;
                    if (lastEndTime) {
                        serviceRow.querySelector('.start-time').value = lastEndTime;
                    }
                }
            }
        }

        // Remove a service row
        function removeServiceRow(rowId) {
            const serviceRow = document.getElementById(`serviceRow_${rowId}`);
            if (serviceRow) {
                serviceRow.remove();
                calculateTotals();

                // Show remove button on remaining rows if more than one
                const remainingRows = document.querySelectorAll('.service-row');
                remainingRows.forEach((row, index) => {
                    const removeBtn = row.querySelector('.btn-outline-danger');
                    if (remainingRows.length > 1) {
                        removeBtn.style.display = 'block';
                    } else {
                        removeBtn.style.display = 'none';
                    }
                });
            }
        }

        // Populate service dropdown
        function populateServiceDropdown(rowId) {
            const serviceSelect = document.querySelector(`[data-row="${rowId}"].service-select`);
            if (serviceSelect && servicesData.length > 0) {
                serviceSelect.innerHTML = '<option value="">Select Service</option>';
                servicesData.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id || service.name;
                    option.textContent = `${service.name} ($${service.price}) - ${service.duration}min`;
                    option.dataset.price = service.price;
                    option.dataset.duration = service.duration;
                    serviceSelect.appendChild(option);
                });
            }
        }

        // Populate staff dropdown
        function populateStaffDropdown(rowId) {
            const staffSelect = document.querySelector(`[data-row="${rowId}"].staff-select`);
            if (staffSelect && staffData.length > 0) {
                staffSelect.innerHTML = '<option value="">Select Staff</option>';
                staffData.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.id;
                    option.textContent = `${staff.name} (${staff.specialty || staff.role || 'Staff'})`;
                    staffSelect.appendChild(option);
                });

                // Auto-select first available staff for better UX
                if (staffData.length > 0) {
                    staffSelect.value = staffData[0].id;
                }
            }
        }

        // Setup event listeners for service row
        function setupServiceRowEventListeners(rowId) {
            const serviceSelect = document.querySelector(`[data-row="${rowId}"].service-select`);
            const priceInput = document.querySelector(`[data-row="${rowId}"].service-price`);

            serviceSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.dataset.price) {
                    priceInput.value = selectedOption.dataset.price;
                    updateServiceEndTime(rowId);
                    calculateTotals();
                }
            });
        }

        // Update end time for a specific service
        function updateServiceEndTime(rowId) {
            const startTimeInput = document.querySelector(`[data-row="${rowId}"].start-time`);
            const endTimeInput = document.querySelector(`[data-row="${rowId}"].end-time`);
            const serviceSelect = document.querySelector(`[data-row="${rowId}"].service-select`);

            if (startTimeInput.value && serviceSelect.value) {
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                const duration = parseInt(selectedOption.dataset.duration) || 60;

                const startTime = new Date(`2000-01-01T${startTimeInput.value}:00`);
                const endTime = new Date(startTime.getTime() + duration * 60000);
                endTimeInput.value = endTime.toTimeString().slice(0, 5);
            }
        }

        // Calculate totals
        function calculateTotals() {
            let totalDuration = 0;
            let subtotal = 0;

            document.querySelectorAll('.service-row').forEach(row => {
                const serviceSelect = row.querySelector('.service-select');
                const priceInput = row.querySelector('.service-price');

                if (serviceSelect.value && priceInput.value) {
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    const duration = parseInt(selectedOption.dataset.duration) || 0;
                    const price = parseFloat(priceInput.value) || 0;

                    totalDuration += duration;
                    subtotal += price;
                }
            });

            // Update totals display
            const hours = Math.floor(totalDuration / 60);
            const minutes = totalDuration % 60;
            const durationText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;

            document.getElementById('totalDuration').value = durationText;
            document.getElementById('subtotalPrice').value = `$${subtotal.toFixed(2)}`;

            const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
            const grandTotal = Math.max(0, subtotal - discount);
            document.getElementById('grandTotal').value = `$${grandTotal.toFixed(2)}`;
        }

        // Check availability for all services
        function checkAvailability() {
            const services = [];
            let isValid = true;
            let conflicts = [];

            document.querySelectorAll('.service-row').forEach(row => {
                const serviceSelect = row.querySelector('.service-select');
                const staffSelect = row.querySelector('.staff-select');
                const startTime = row.querySelector('.start-time');
                const endTime = row.querySelector('.end-time');

                if (!serviceSelect.value || !staffSelect.value || !startTime.value || !endTime.value) {
                    isValid = false;
                    return;
                }

                services.push({
                    service: serviceSelect.options[serviceSelect.selectedIndex].text,
                    staff: staffSelect.options[staffSelect.selectedIndex].text,
                    staffId: parseInt(staffSelect.value),
                    startTime: startTime.value,
                    endTime: endTime.value
                });
            });

            if (!isValid) {
                showNotification('Please fill in all service details before checking availability', 'warning');
                return;
            }

            console.log('üîç Checking availability for services:', services);

            // Enhanced overlap detection - check for any time conflicts between new services
            for (let i = 0; i < services.length; i++) {
                for (let j = i + 1; j < services.length; j++) {
                    if (services[i].staffId === services[j].staffId) {
                        const start1 = timeToMinutes(services[i].startTime);
                        const end1 = timeToMinutes(services[i].endTime);
                        const start2 = timeToMinutes(services[j].startTime);
                        const end2 = timeToMinutes(services[j].endTime);

                        // Check for overlap: appointments overlap if start1 < end2 AND start2 < end1
                        if (start1 < end2 && start2 < end1) {
                            conflicts.push(`${services[i].staff} has overlapping appointments: ${services[i].startTime}-${services[i].endTime} conflicts with ${services[j].startTime}-${services[j].endTime}`);
                        }
                    }
                }
            }

            // Check against existing appointments in the schedule
            services.forEach((service, index) => {
                const staffId = service.staffId;
                const serviceStart = timeToMinutes(service.startTime);
                const serviceEnd = timeToMinutes(service.endTime);

                // Check against existing appointments
                scheduleData.appointments.forEach(existingApt => {
                    if (existingApt.staffId === staffId) {
                        const existingStart = timeToMinutes(existingApt.startTime);
                        const existingEnd = timeToMinutes(existingApt.endTime);

                        if (serviceStart < existingEnd && serviceEnd > existingStart) {
                            conflicts.push(`${service.staff} conflicts with existing appointment: ${existingApt.clientName} (${existingApt.startTime}-${existingApt.endTime})`);
                        }
                    }
                });
            });

            // Show availability results
            let availabilityText = 'Availability Check Results:\n\n';
            services.forEach((service, index) => {
                const serviceConflicts = conflicts.filter(c => c.includes(service.staff));
                const hasConflicts = serviceConflicts.length > 0;

                availabilityText += `${index + 1}. ${service.service}\n`;
                availabilityText += `   Staff: ${service.staff}\n`;
                availabilityText += `   Time: ${service.startTime} - ${service.endTime}\n`;
                availabilityText += `   Status: ${hasConflicts ? '‚ö†Ô∏è Conflict Detected' : '‚úÖ Available'}\n\n`;
            });

            if (conflicts.length > 0) {
                availabilityText += 'Conflicts Found:\n' + conflicts.join('\n');
                showNotification('Time conflicts detected! Please adjust the schedule.', 'warning');
            } else {
                showNotification('All services are available!', 'success');
            }

            // Use modal instead of alert for better UX
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${conflicts.length > 0 ? '‚ö†Ô∏è Availability Check Results' : '‚úÖ Availability Check Results'}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre style="white-space: pre-wrap; font-family: inherit;">${availabilityText}</pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            ${conflicts.length === 0 ? '<button type="button" class="btn btn-primary" onclick="bookMultiServiceAppointment(); bootstrap.Modal.getInstance(this.closest(\'.modal\')).hide();">Book Appointments</button>' : ''}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();

            // Clean up modal after hiding
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        // Book multi-service appointment
        function bookMultiServiceAppointment() {
            const clientSelect = document.getElementById('clientSelect');
            const clientName = document.getElementById('clientName');

            // Validate client selection
            if (!clientSelect.value && !clientName.value) {
                showNotification('Please select a client or enter a new client name', 'error');
                return;
            }

            // Validate services
            const serviceRows = document.querySelectorAll('.service-row');
            if (serviceRows.length === 0) {
                showNotification('Please add at least one service', 'error');
                return;
            }

            let isValid = true;
            const services = [];

            serviceRows.forEach((row, index) => {
                const serviceSelect = row.querySelector('.service-select');
                const staffSelect = row.querySelector('.staff-select');
                const startTime = row.querySelector('.start-time');
                const endTime = row.querySelector('.end-time');
                const price = row.querySelector('.service-price');

                if (!serviceSelect.value || !staffSelect.value || !startTime.value) {
                    isValid = false;
                    return;
                }

                services.push({
                    serviceName: serviceSelect.options[serviceSelect.selectedIndex].text.split(' (')[0],
                    serviceId: serviceSelect.value,
                    staffId: staffSelect.value,
                    staffName: staffSelect.options[staffSelect.selectedIndex].text,
                    startTime: startTime.value,
                    endTime: endTime.value,
                    price: parseFloat(price.value) || 0,
                    duration: parseInt(serviceSelect.options[serviceSelect.selectedIndex].dataset.duration) || 60
                });
            });

            if (!isValid) {
                showNotification('Please fill in all required fields for each service', 'error');
                return;
            }

            // Prepare booking data
            const bookingData = {
                clientId: clientSelect.value,
                clientName: clientName.value,
                clientPhone: document.getElementById('clientPhone').value,
                clientEmail: document.getElementById('clientEmail').value,
                services: services,
                notes: document.getElementById('appointmentNotes').value,
                discount: parseFloat(document.getElementById('discountAmount').value) || 0,
                totalAmount: parseFloat(document.getElementById('grandTotal').value.replace('$', '')) || 0,
                appointmentDate: currentDate
            };

            console.log('Booking multi-service appointment:', bookingData);

            // Show booking in progress
            showLoading();

            // Process each service booking
            bookMultipleServices(bookingData);
        }

        // Process multiple service bookings
        function bookMultipleServices(bookingData) {
            console.log('üìã Processing multiple service bookings:', bookingData);

            const promises = bookingData.services.map((service, index) => {
                const serviceBookingData = {
                    clientId: bookingData.clientId,
                    clientName: bookingData.clientName || document.getElementById('clientSelect').options[document.getElementById('clientSelect').selectedIndex]?.text,
                    clientPhone: bookingData.clientPhone,
                    clientEmail: bookingData.clientEmail,
                    staffId: parseInt(service.staffId),
                    staffName: service.staffName.split(' (')[0],
                    serviceName: service.serviceName,
                    serviceDuration: service.duration,
                    servicePrice: service.price,
                    date: bookingData.appointmentDate,
                    startTime: service.startTime,
                    endTime: service.endTime,
                    notes: bookingData.notes + (index > 0 ? ` (Service ${index + 1} of ${bookingData.services.length})` : ''),
                    amount_charged: service.price - (bookingData.discount / bookingData.services.length)
                };

                console.log(` uitgenodigd Sending booking request ${index + 1}:`, serviceBookingData);

                return fetch('/api/unaki/book-appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(serviceBookingData)
                });
            });

            Promise.all(promises)
                .then(responses => {
                    console.log('üì• Received responses:', responses);
                    return Promise.all(responses.map(async (response, index) => {
                        const text = await response.text();
                        console.log(`Response ${index + 1}:`, text);
                        try {
                            return JSON.parse(text);
                        } catch (e) {
                            console.error(`Failed to parse response ${index + 1}:`, e);
                            return { success: false, error: 'Invalid response format' };
                        }
                    }));
                })
                .then(results => {
                    hideLoading();
                    console.log('üìä All results:', results);

                    const successCount = results.filter(result => result.success).length;
                    const totalCount = results.length;
                    const failedResults = results.filter(result => !result.success);

                    if (successCount === totalCount) {
                        showNotification(`All ${totalCount} services booked successfully!`, 'success');

                        // Close modal and refresh schedule
                        const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
                        if (modal) modal.hide();

                        // Reset form
                        document.getElementById('bookingForm').reset();
                        const servicesContainer = document.getElementById('servicesContainer');
                        servicesContainer.innerHTML = '';
                        serviceRowCount = 0;

                        loadScheduleForDate();
                    } else {
                        let errorMessage = `${successCount} of ${totalCount} services booked successfully. `;
                        if (failedResults.length > 0) {
                            const errors = failedResults.map(r => r.error).join('; ');
                            errorMessage += `Failures: ${errors}`;
                        }
                        showNotification(errorMessage, 'warning');

                        // Reload schedule to show successful bookings
                        loadScheduleForDate();
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('‚ùå Error booking appointments:', error);
                    showNotification('Network error while booking appointments. Please try again.', 'error');
                });
        }

        // Load sample data function
        function loadSampleData() {
            showNotification('Loading sample data...', 'info');

            fetch('/api/unaki/load-sample-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    // Reload the schedule after loading sample data
                    loadScheduleForDate();
                } else {
                    showNotification('Error loading sample data: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error loading sample data:', error);
                showNotification('Error loading sample data: HTTP error! status: 502', 'error');
            });
        }

        // Enhanced time display functions
        function updateTimeDisplay(input) {
            if (!input.value) return;

            const [hours, minutes] = input.value.split(':');
            const time = new Date();
            time.setHours(parseInt(hours), parseInt(minutes));

            const display = time.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });

            const displayElement = document.getElementById(input.id + 'Display');
            if (displayElement) {
                displayElement.textContent = display;
            }
        }

        function updateEndTime() {
            const startTime = document.getElementById('startTime').value;
            const duration = parseInt(document.getElementById('appointmentDuration').value);

            if (startTime && duration) {
                const [hours, minutes] = startTime.split(':');
                const startDate = new Date();
                startDate.setHours(parseInt(hours), parseInt(minutes));

                const endDate = new Date(startDate.getTime() + duration * 60000);
                const endTimeString = endDate.toTimeString().slice(0, 5);

                document.getElementById('endTime').value = endTimeString;
                updateTimeDisplay(document.getElementById('endTime'));
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            showLoading();
            document.getElementById('scheduleDate').value = currentDate;

            // Update time every second
            updateCurrentDateTime();
            setInterval(updateCurrentDateTime, 1000);

            // Load initial data
            Promise.all([
                loadScheduleForDate(),
                loadServices(),
                loadStaff(),
                loadClients()
            ]).then(() => {
                hideLoading();
                showNotification('Schedule loaded successfully!', 'success', 3000);
            }).catch(error => {
                console.error('Error loading initial data:', error);
                hideLoading();
                showNotification('Error loading schedule data', 'error');
            });

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'n':
                            e.preventDefault();
                            openQuickBookingModal();
                            break;
                        case 'r':
                            e.preventDefault();
                            showLoadingAndRefresh();
                            break;
                    }
                }
            });
        });

        // Rest of the existing JavaScript functions with enhanced error handling and UX improvements
        // (keeping all the existing functionality but with better user feedback)

        // Configuration
        const SCHEDULE_CONFIG = {
            startHour: 8,
            endHour: 20,
            slotMinutes: 5,
            staffColumnWidth: 240,
            timeSlotWidth: 45
        };

        function generateTimeSlots() {
            const slots = [];
            const totalSlots = (SCHEDULE_CONFIG.endHour - SCHEDULE_CONFIG.startHour) * (60 / SCHEDULE_CONFIG.slotMinutes);

            for (let i = 0; i < totalSlots; i++) {
                const totalMinutes = SCHEDULE_CONFIG.startHour * 60 + (i * SCHEDULE_CONFIG.slotMinutes);
                const hour = Math.floor(totalMinutes / 60);
                const minute = totalMinutes % 60;

                const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                const displayTime = formatDisplayTime(hour, minute);

                slots.push({
                    time: timeStr,
                    display: displayTime,
                    index: i
                });
            }
            return slots;
        }

        function formatDisplayTime(hour, minute) {
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);

            if (minute % 15 === 0) {
                const displayMinute = minute === 0 ? '' : `:${minute.toString().padStart(2, '0')}`;
                return `${displayHour}${displayMinute}${period}`;
            } else if (minute % 5 === 0) {
                return `:${minute.toString().padStart(2, '0')}`;
            }
            return '';
        }

        // Enhanced API functions with better error handling
        function loadServices() {
            return fetch('/api/unaki/services')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(services => {
                    console.log('Loaded services:', Array.isArray(services) ? services.length : 'Invalid data');

                    // Store services data globally for multi-service booking
                    servicesData = services || [];

                    const serviceSelect = document.getElementById('serviceType');
                    if (serviceSelect && Array.isArray(services)) {
                        serviceSelect.innerHTML = '<option value="">Select Service</option>';

                        const servicesByCategory = {};
                        services.forEach(service => {
                            const category = service.category || 'General';
                            if (!servicesByCategory[category]) {
                                servicesByCategory[category] = [];
                            }
                            servicesByCategory[category].push(service);
                        });

                        Object.keys(servicesByCategory).sort().forEach(category => {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = category;

                            servicesByCategory[category].forEach(service => {
                                const option = document.createElement('option');
                                option.value = service.name;
                                option.textContent = `${service.name} (${service.duration} min)`;
                                option.dataset.serviceId = service.id;
                                option.dataset.duration = service.duration;
                                option.dataset.price = service.price;
                                optgroup.appendChild(option);
                            });

                            serviceSelect.appendChild(optgroup);
                        });

                        serviceSelect.addEventListener('change', function() {
                            const selectedOption = this.options[this.selectedIndex];
                            if (selectedOption && selectedOption.dataset.duration) {
                                const durationSelect = document.getElementById('appointmentDuration');
                                if (durationSelect) {
                                    durationSelect.value = selectedOption.dataset.duration;
                                    updateEndTime();
                                }
                            }
                        });
                    }

                    return services;
                })
                .catch(error => {
                    console.error('Failed to load services:', error);
                    showNotification('Failed to load services', 'error');
                    return [];
                });
        }

        function loadStaff() {
            return fetch('/api/unaki/staff')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(staff => {
                    console.log('Loaded staff:', Array.isArray(staff) ? staff.length : 'Invalid data');

                    // Store staff data globally for multi-service booking
                    staffData = staff || [];

                    const staffSelect = document.getElementById('staffSelect');
                    if (staffSelect && Array.isArray(staff)) {
                        staffSelect.innerHTML = '<option value="">Select Staff</option>';
                        staff.forEach(member => {
                            const option = document.createElement('option');
                            option.value = member.id;
                            option.textContent = `${member.name} (${member.specialty || member.role || 'Staff'})`;
                            staffSelect.appendChild(option);
                        });
                    }
                    return staff;
                })
                .catch(error => {
                    console.error('Failed to load staff:', error);
                    showNotification('Failed to load staff', 'error');
                    return [];
                });
        }

        function loadClients() {
            return fetch('/api/unaki/clients')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(clients => {
                    console.log('Loaded clients:', Array.isArray(clients) ? clients.length : 'Invalid data');

                    const clientSelect = document.getElementById('clientSelect');
                    if (clientSelect && Array.isArray(clients)) {
                        clientSelect.innerHTML = '<option value="">Select Client</option>';

                        clients.forEach(client => {
                            const option = document.createElement('option');
                            option.value = client.id;
                            option.textContent = `${client.name}`;
                            option.dataset.phone = client.phone || '';
                            option.dataset.email = client.email || '';
                            clientSelect.appendChild(option);
                        });

                        clientSelect.addEventListener('change', function() {
                            const selectedOption = this.options[this.selectedIndex];
                            if (selectedOption && selectedOption.value) {
                                document.getElementById('clientName').value = selectedOption.textContent;
                                document.getElementById('clientPhone').value = selectedOption.dataset.phone || '';
                                document.getElementById('clientEmail').value = selectedOption.dataset.email || '';
                                document.getElementById('clientName').placeholder = 'Selected: ' + selectedOption.textContent;
                            } else {
                                document.getElementById('clientName').value = '';
                                document.getElementById('clientPhone').value = '';
                                document.getElementById('clientEmail').value = '';
                                document.getElementById('clientName').placeholder = 'Enter new client name';
                            }
                        });
                    }

                    return clients;
                })
                .catch(error => {
                    console.error('Failed to load clients:', error);
                    showNotification('Failed to load clients', 'error');
                    return [];
                });
        }

        function loadScheduleForDate() {
            currentDate = document.getElementById('scheduleDate').value;
            console.log('Loading schedule for date:', currentDate);

            fetch(`/api/unaki/schedule?date=${currentDate}`)
                .then(response => {
                    console.log('Schedule API response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(text => {
                    console.log('Schedule API raw response:', text.substring(0, 200) + '...');
                    try {
                        const data = JSON.parse(text);
                        if (data.success) {
                            scheduleData = {
                                staff: data.staff || [],
                                appointments: data.appointments || [],
                                breaks: data.breaks || []
                            };
                            console.log('Schedule data loaded:', scheduleData);

                            const adminAppointments = scheduleData.appointments.filter(apt => apt.staffId === 11);
                            console.log(`üîç Admin User (ID: 11) appointments found: ${adminAppointments.length}`);
                            adminAppointments.forEach((apt, index) => {
                                console.log(`   ${index + 1}. ${apt.clientName} - ${apt.service} (${apt.startTime} - ${apt.endTime})`);
                            });
                        } else {
                            console.error('Failed to load schedule:', data.error);
                            scheduleData = { staff: [], appointments: [], breaks: [] };
                            showNotification('Failed to load schedule: ' + data.error, 'error');
                        }
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError);
                        scheduleData = { staff: [], appointments: [], breaks: [] };
                        showNotification('Error parsing schedule data', 'error');
                    }
                    renderSchedule();
                    updateStats();
                })
                .catch(error => {
                    console.error('Error loading schedule:', error);
                    scheduleData = { staff: [], appointments: [], breaks: [] };
                    renderSchedule();
                    updateStats();
                    showNotification('Error loading schedule data', 'error');
                });
        }

        function loadSampleData() {
            console.log('Loading sample data...');
            showNotification('Loading sample data...', 'info');

            scheduleData = {
                staff: [],
                appointments: [],
                breaks: []
            };

            const grid = document.getElementById('scheduleGrid');
            if (grid) {
                grid.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3 text-muted">Loading fresh data...</p></div>';
            }

            fetch('/api/unaki/load-sample-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => {
                console.log('Sample data API response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(text => {
                console.log('Sample data API raw response:', text.substring(0, 200) + '...');
                try {
                    const data = JSON.parse(text);
                    if (data.success) {
                        console.log('Sample data loaded:', data.message);
                        loadScheduleForDate();
                        showNotification('Sample data loaded successfully!', 'success', 3000);
                    } else {
                        console.error('Failed to load sample data:', data.error);
                        showNotification('Failed to load sample data: ' + data.error, 'error', 5000);
                    }
                } catch (parseError) {
                    console.error('JSON parse error in sample data:', parseError);
                    showNotification('Error parsing sample data response', 'error', 5000);
                }
            })
            .catch(error => {
                console.error('Error loading sample data:', error);
                showNotification('Error loading sample data: ' + error.message, 'error', 5000);
            });
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all appointment data? This will remove all bookings for today.')) {
                console.log('Clearing all data...');
                showNotification('Clearing all data...', 'info');

                handleClearAllData() // Call the new API handler
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            scheduleData = {
                                staff: [],
                                appointments: [],
                                breaks: []
                            };
                            renderSchedule();
                            updateStats();
                            showNotification('All appointment data cleared!', 'success', 2000);
                        } else {
                            showNotification('Failed to clear data: ' + data.error, 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error clearing data:', error);
                        showNotification('Error clearing data: ' + error.message, 'error');
                    });
            }
        }

        // Add clear all data API endpoint handler
        function handleClearAllData() {
            return fetch('/api/unaki/bookings', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
        }

        // Generate schedule grid HTML
        function generateScheduleGrid() {
            const grid = document.getElementById('scheduleGrid');
            const timeSlots = generateTimeSlots();

            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `${SCHEDULE_CONFIG.staffColumnWidth}px repeat(${timeSlots.length}, ${SCHEDULE_CONFIG.timeSlotWidth}px)`;

            // Create header row
            const emptyCorner = document.createElement('div');
            emptyCorner.className = 'time-header';
            emptyCorner.innerHTML = '<strong style="writing-mode: horizontal-tb;">üë• Staff</strong>';
            grid.appendChild(emptyCorner);

            // Time headers
            timeSlots.forEach(slot => {
                const timeHeader = document.createElement('div');
                timeHeader.className = 'time-header';
                timeHeader.textContent = slot.display;
                grid.appendChild(timeHeader);
            });

            // Create staff rows
            scheduleData.staff.forEach(staff => {
                // Staff name cell
                const staffCell = document.createElement('div');
                staffCell.className = 'staff-cell';
                staffCell.innerHTML = `
                    <div class="staff-name">${staff.name}</div>
                    <div class="staff-role">${staff.specialty || 'Staff'}</div>
                `;
                grid.appendChild(staffCell);

                // Time slot cells for this staff member
                timeSlots.forEach((slot, slotIndex) => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.dataset.staffId = staff.id;
                    timeSlot.dataset.time = slot.time;
                    timeSlot.dataset.slotIndex = slotIndex;

                    timeSlot.addEventListener('click', (e) => {
                        if (!timeSlot.classList.contains('has-appointments')) {
                            handleSlotClick(staff.id, slot.time, e);
                        }
                    });

                    grid.appendChild(timeSlot);
                });
            });

            renderAppointments();
        }

        function renderAppointments() {
            const grid = document.getElementById('scheduleGrid');
            const timeSlots = generateTimeSlots();

            grid.querySelectorAll('.appointment-block').forEach(block => block.remove());

            const appointmentsByStaff = {};
            scheduleData.appointments.forEach(appointment => {
                if (!appointmentsByStaff[appointment.staffId]) {
                    appointmentsByStaff[appointment.staffId] = [];
                }
                appointmentsByStaff[appointment.staffId].push(appointment);
            });

            Object.keys(appointmentsByStaff).forEach(staffId => {
                const staffAppointments = appointmentsByStaff[staffId];

                staffAppointments.sort((a, b) => {
                    const timeA = a.startTime.split(':').map(Number);
                    const timeB = b.startTime.split(':').map(Number);
                    return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
                });

                staffAppointments.forEach((appointment, appointmentIndex) => {
                    const startSlotIndex = getSlotIndexFromTime(appointment.startTime);
                    if (startSlotIndex === -1) return;

                    let overlapIndex = 0;
                    let totalOverlaps = 1;

                    for (let i = 0; i < appointmentIndex; i++) {
                        const prevAppointment = staffAppointments[i];
                        if (appointmentsOverlap(prevAppointment, appointment)) {
                            overlapIndex++;
                            totalOverlaps = Math.max(totalOverlaps, overlapIndex + 1);
                        }
                    }

                    for (let i = appointmentIndex + 1; i < staffAppointments.length; i++) {
                        const nextAppointment = staffAppointments[i];
                        if (appointmentsOverlap(appointment, nextAppointment)) {
                            totalOverlaps++;
                        }
                    }

                    const appointmentBlock = createAppointmentBlock(appointment, startSlotIndex, overlapIndex, totalOverlaps);

                    const startTimeSlotCell = grid.querySelector(`[data-staff-id="${staffId}"][data-slot-index="${startSlotIndex}"]`);
                    if (startTimeSlotCell) {
                        const durationMinutes = getTimeDifferenceInMinutes(appointment.startTime, appointment.endTime);
                        const durationSlots = Math.ceil(durationMinutes / SCHEDULE_CONFIG.slotMinutes);

                        for (let i = 0; i < durationSlots; i++) {
                            const slotCell = grid.querySelector(`[data-staff-id="${staffId}"][data-slot-index="${startSlotIndex + i}"]`);
                            if (slotCell) {
                                slotCell.classList.add('has-appointments');
                            }
                        }

                        startTimeSlotCell.style.position = 'relative';
                        startTimeSlotCell.appendChild(appointmentBlock);
                    }
                });
            });
        }

        function createAppointmentBlock(appointment, startSlotIndex, overlapIndex, totalOverlaps) {
            const appointmentBlock = document.createElement('div');
            appointmentBlock.className = 'appointment-block';

            // Add appointment ID for context menu functionality
            if (appointment.id) {
                appointmentBlock.setAttribute('data-appointment-id', appointment.id);
                appointmentBlock.dataset.appointmentId = appointment.id;
                console.log(`üîç Setting appointment block ID: ${appointment.id} for ${appointment.clientName}`);
            }

            const serviceCategory = getServiceCategory(appointment.service || appointment.serviceType);
            let serviceCategoryClass = '';
            if (serviceCategory) {
                appointmentBlock.classList.add('service-category-' + serviceCategory);
                serviceCategoryClass = 'service-category-' + serviceCategory;
            }

            const startTime = appointment.startTime;
            const endTime = appointment.endTime;
            const durationMinutes = getTimeDifferenceInMinutes(startTime, endTime);
            const durationSlots = Math.ceil(durationMinutes / SCHEDULE_CONFIG.slotMinutes);

            // Calculate gradient based on category
            let gradientStyle = `linear-gradient(135deg, #667eea 0%, #764ba2 100%)`; // Default gradient
            switch (serviceCategory) {
                case 'massage': gradientStyle = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)'; break;
                case 'facial': gradientStyle = 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)'; break;
                case 'hair': gradientStyle = 'linear-gradient(135deg, #9f7aea 0%, #805ad5 100%)'; break;
                case 'nails': gradientStyle = 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)'; break;
                case 'body': gradientStyle = 'linear-gradient(135deg, #38b2ac 0%, #319795 100%)'; break;
            }

            // Set basic styles
            appointmentBlock.style.cssText = `
                background: ${gradientStyle};
                color: white;
                border-radius: 12px;
                padding: 8px 10px;
                font-size: 11px;
                line-height: 1.3;
                cursor: pointer;
                min-height: 70px;
                z-index: 15;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                position: absolute;
                top: 2px;
                left: 2px;
                right: 2px;
                transition: all 0.3s ease;
                border: 1px solid rgba(255, 255, 255, 0.3);
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
                overflow: hidden;
                width: ${(durationSlots * SCHEDULE_CONFIG.timeSlotWidth) - 4}px;
            `;

            // Add appointment content
            appointmentBlock.innerHTML = `
                <div class="appointment-client" style="font-weight: 700; margin-bottom: 2px; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${appointment.clientName}
                </div>
                <div class="appointment-service" style="font-size: 9px; opacity: 0.9; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    ${appointment.service}
                </div>
                <div class="appointment-time" style="font-size: 8px; opacity: 0.8; font-weight: 500; margin-top: auto; background: rgba(255, 255, 255, 0.2); padding: 2px 4px; border-radius: 4px; text-align: center;">
                    ${appointment.startTime} - ${appointment.endTime}
                </div>
            `;

            // Add click handler
            appointmentBlock.addEventListener('click', (e) => {
                e.stopPropagation();
                handleAppointmentClick(appointment);
            });

            // Add context menu handler
            appointmentBlock.addEventListener('contextmenu', function(event) {
                console.log(`üéØ Right-click detected on appointment ${appointment.id} (${appointment.clientName})`);
                handleAppointmentRightClick(event);
            });

            // Add hover effects
            appointmentBlock.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px) scale(1.02)';
                this.style.boxShadow = '0 8px 30px rgba(102, 126, 234, 0.6)';
            });

            appointmentBlock.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0) scale(1)';
                this.style.boxShadow = '0 4px 20px rgba(102, 126, 234, 0.4)';
            });

            return appointmentBlock;
        }


        // Helper functions
        function appointmentsOverlap(apt1, apt2) {
            const start1 = timeToMinutes(apt1.startTime);
            const end1 = timeToMinutes(apt1.endTime);
            const start2 = timeToMinutes(apt2.startTime);
            const end2 = timeToMinutes(apt2.endTime);

            return start1 < end2 && start2 < end1;
        }

        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function getSlotIndexFromTime(timeStr) {
            const [hour, minute] = timeStr.split(':').map(Number);
            const totalMinutes = hour * 60 + minute;
            const startMinutes = SCHEDULE_CONFIG.startHour * 60;
            const slotIndex = Math.floor((totalMinutes - startMinutes) / SCHEDULE_CONFIG.slotMinutes);

            if (slotIndex < 0 || hour < SCHEDULE_CONFIG.startHour || hour >= SCHEDULE_CONFIG.endHour) {
                return -1;
            }

            return slotIndex;
        }

        function getTimeDifferenceInMinutes(startTime, endTime) {
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const [endHour, endMinute] = endTime.split(':').map(Number);

            const startTotalMinutes = startHour * 60 + startMinute;
            const endTotalMinutes = endHour * 60 + endMinute;

            return endTotalMinutes - startTotalMinutes;
        }

        function getServiceCategory(serviceType) {
            if (!serviceType) return '';

            const service = serviceType.toLowerCase();
            if (service.includes('massage') || service.includes('therapy')) return 'massage';
            if (service.includes('facial') || service.includes('skin')) return 'facial';
            if (service.includes('hair') || service.includes('cut') || service.includes('style')) return 'hair';
            if (service.includes('nail') || service.includes('mani') || service.includes('pedi')) return 'nails';
            if (service.includes('body') || service.includes('wrap') || service.includes('scrub')) return 'body';

            return '';
        }

        function handleSlotClick(staffId, timeStr, event) {
            const modal = new bootstrap.Modal(document.getElementById('bookingModal'));

            const staffSelect = document.getElementById('staffSelect');
            if (staffSelect) {
                staffSelect.value = staffId;
            }

            const startTimeInput = document.getElementById('startTime');
            if (startTimeInput) {
                startTimeInput.value = timeStr;
                updateEndTime();
                updateTimeDisplay(startTimeInput);
            }

            modal.show();
        }

        function handleAppointmentClick(appointment) {
            showNotification(`Appointment: ${appointment.clientName} - ${appointment.service}`, 'info', 3000);
        }

        function editAppointment(appointmentId) {
            console.log('Editing appointment:', appointmentId);

            // Find the appointment in the schedule data
            const appointment = scheduleData.appointments.find(apt => apt.id === appointmentId);
            if (!appointment) {
                showNotification('Appointment not found', 'error');
                return;
            }

            console.log('Found appointment to edit:', appointment);

            // Ensure dropdowns are populated first
            Promise.all([
                populateEditServiceDropdown(),
                populateEditStaffDropdown()
            ]).then(() => {
                // Populate the edit form
                document.getElementById('editAppointmentId').value = appointmentId;
                document.getElementById('editClientName').value = appointment.clientName;
                document.getElementById('editClientPhone').value = appointment.clientPhone || '';

                // Set service by name (find matching option)
                const serviceSelect = document.getElementById('editServiceSelect');
                let foundService = false;
                for (let option of serviceSelect.options) {
                    if (option.value === appointment.serviceName || option.textContent.includes(appointment.serviceName)) {
                        serviceSelect.value = option.value;
                        foundService = true;
                        break;
                    }
                }
                // If not found by name, try to find by ID if available
                if (!foundService && appointment.serviceId) {
                    serviceSelect.value = appointment.serviceId;
                }

                document.getElementById('editStaffSelect').value = appointment.staffId;
                document.getElementById('editAppointmentDate').value = appointment.appointment_date || currentDate;
                document.getElementById('editStartTime').value = appointment.startTime;
                document.getElementById('editEndTime').value = appointment.endTime;
                document.getElementById('editStatus').value = appointment.status || 'confirmed';
                document.getElementById('editServicePrice').value = appointment.amount || 0;
                document.getElementById('editAppointmentNotes').value = appointment.notes || '';

                // Update end time and price when service or start time changes
                updateEditEndTime();
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.price) {
                    document.getElementById('editServicePrice').value = selectedOption.dataset.price;
                }

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
                modal.show();
            });
        }

        function populateEditServiceDropdown() {
            const serviceSelect = document.getElementById('editServiceSelect');
            if (serviceSelect && servicesData.length > 0) {
                serviceSelect.innerHTML = '<option value="">Select Service</option>';
                servicesData.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id || service.name; // Use ID if available, otherwise name
                    option.textContent = `${service.name} ($${service.price}) - ${service.duration}min`;
                    option.dataset.price = service.price;
                    option.dataset.duration = service.duration;
                    serviceSelect.appendChild(option);
                });

                // Add event listener for service selection changes
                serviceSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    if (selectedOption && selectedOption.dataset.price) {
                        document.getElementById('editServicePrice').value = selectedOption.dataset.price;
                        updateEditEndTime();
                    }
                });
            }
        }

        function populateEditStaffDropdown() {
            const staffSelect = document.getElementById('editStaffSelect');
            if (staffSelect && staffData.length > 0) {
                staffSelect.innerHTML = '<option value="">Select Staff</option>';
                staffData.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.id;
                    option.textContent = `${staff.name} (${staff.specialty || staff.role || 'Staff'})`;
                    staffSelect.appendChild(option);
                });
            }
        }

        function updateEditEndTime() {
            const startTime = document.getElementById('editStartTime').value;
            const serviceSelect = document.getElementById('editServiceSelect');

            if (startTime && serviceSelect.value) {
                const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                const duration = parseInt(selectedOption.dataset.duration) || 60;

                const startDateTime = new Date(`2000-01-01T${startTime}:00`);
                const endDateTime = new Date(startDateTime.getTime() + duration * 60000);
                document.getElementById('editEndTime').value = endDateTime.toTimeString().slice(0, 5);
            }
        }

        // Update appointment function - handles saving changes from edit modal
        function updateAppointment() {
            const appointmentId = document.getElementById('editAppointmentId').value;
            if (!appointmentId) {
                showNotification('No appointment selected for update', 'error');
                return;
            }

            // Collect form data
            const formData = {
                client_name: document.getElementById('editClientName').value,
                client_phone: document.getElementById('editClientPhone').value,
                service_name: document.getElementById('editServiceSelect').options[document.getElementById('editServiceSelect').selectedIndex].text,
                staff_id: document.getElementById('editStaffSelect').value,
                start_time: document.getElementById('editStartTime').value,
                end_time: document.getElementById('editEndTime').value,
                status: document.getElementById('editStatus').value,
                notes: document.getElementById('editAppointmentNotes').value,
                service_price: document.getElementById('editServicePrice').value
            };

            // Validate required fields
            if (!formData.client_name || !formData.service_name || !formData.staff_id || !formData.start_time) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            // Show loading state
            const updateBtn = document.querySelector('[onclick="updateAppointment()"]');
            const originalText = updateBtn.innerHTML;
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
            updateBtn.disabled = true;

            // Send update request
            fetch(`/api/unaki/appointments/${appointmentId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    showNotification('Appointment updated successfully!', 'success');

                    // Close the modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editAppointmentModal'));
                    modal.hide();

                    // Refresh the schedule
                    loadScheduleData();
                } else {
                    throw new Error(data.message || 'Failed to update appointment');
                }
            })
            .catch(error => {
                console.error('Error updating appointment:', error);
                showNotification('Failed to update appointment: ' + error.message, 'error');
            })
            .finally(() => {
                // Restore button state
                updateBtn.innerHTML = originalText;
                updateBtn.disabled = false;
            });
        }

        function deleteAppointment(appointmentId) {
            if (confirm('Are you sure you want to delete this appointment?')) {
                showNotification(`Deleting appointment ID: ${appointmentId}...`, 'info');
                fetch(`/api/unaki/appointments/${appointmentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reason: 'Deleted by user'
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showNotification('Appointment deleted successfully!', 'success');
                        refreshSchedule(); // Reload schedule to reflect deletion
                    } else {
                        showNotification('Failed to delete appointment: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error deleting appointment:', error);
                    showNotification('Error deleting appointment', 'error');
                });
            }
        }

        function updateStats() {
            document.getElementById('totalAppointments').textContent = scheduleData.appointments.length;
            document.getElementById('activeStaff').textContent = scheduleData.staff.length;

            const totalSlots = scheduleData.staff.length * 144; // 144 slots per staff (12 hours * 12 slots per hour)
            const occupiedSlots = scheduleData.appointments.reduce((total, apt) => {
                const duration = getTimeDifferenceInMinutes(apt.startTime, apt.endTime);
                return total + Math.ceil(duration / 5);
            }, 0);

            const availableSlots = totalSlots - occupiedSlots;
            const utilization = totalSlots > 0 ? Math.round((occupiedSlots / totalSlots) * 100) : 0;

            document.getElementById('availableSlots').textContent = availableSlots;
            document.getElementById('utilizationRate').textContent = utilization + '%';

            // Animate stats
            document.querySelectorAll('.stat-item').forEach((item, index) => {
                setTimeout(() => {
                    item.classList.add('updated');
                    setTimeout(() => item.classList.remove('updated'), 600);
                }, index * 100);
            });
        }

        function refreshSchedule() {
            loadScheduleForDate();
        }

        function bookAppointment() {
            // Enhanced booking function with validation and feedback
            const form = document.getElementById('bookingForm');
            const formData = new FormData(form);

            // Validate required fields
            const clientName = document.getElementById('clientName').value ||
                             document.getElementById('clientSelect').options[document.getElementById('clientSelect').selectedIndex]?.text;
            const serviceType = document.getElementById('serviceType').value;
            const staffId = document.getElementById('staffSelect').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;

            if (!clientName || !serviceType || !staffId || !startTime || !endTime) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            showNotification('Booking appointment...', 'info');

            // Simulate API call
            setTimeout(() => {
                showNotification('Appointment booked successfully!', 'success');

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
                if (modal) modal.hide();

                // Refresh schedule
                setTimeout(() => {
                    refreshSchedule();
                }, 500);
            }, 1500);
        }

        // Conflict Detection Functions
        function checkRealTimeConflicts(selectedStaffId, selectedServiceId, startTime, endTime) {
            const conflicts = [];
            const selectedStartTime = timeToMinutes(startTime);
            const selectedEndTime = timeToMinutes(endTime);

            scheduleData.appointments.forEach(appointment => {
                if (appointment.staffId === selectedStaffId) {
                    const existingStartTime = timeToMinutes(appointment.startTime);
                    const existingEndTime = timeToMinutes(appointment.endTime);

                    if (selectedStartTime < existingEndTime && selectedEndTime > existingStartTime) {
                        conflicts.push({
                            appointment: appointment,
                            message: `Conflict with ${appointment.clientName} (${appointment.startTime} - ${appointment.endTime})`
                        });
                    }
                }
            });

            return conflicts;
        }

        function selectSuggestedTime(time) {
            // This function would update the start time input in the modal and trigger re-checking
            const startTimeInput = document.querySelector('.service-row.active .start-time'); // Assuming active row
            if (startTimeInput) {
                startTimeInput.value = time;
                updateServiceEndTime(startTimeInput.dataset.row);
                performConflictCheck(startTimeInput.dataset.row); // Re-check for the specific row
            }
        }

        function performConflictCheck(rowId) {
            const serviceSelect = document.querySelector(`[data-row="${rowId}"].service-select`);
            const staffSelect = document.querySelector(`[data-row="${rowId}"].staff-select`);
            const startTimeInput = document.querySelector(`[data-row="${rowId}"].start-time`);
            const endTimeInput = document.querySelector(`[data-row="${rowId}"].end-time`);
            const conflictWarningElement = document.querySelector(`[data-row="${rowId}"] .conflict-warning`);
            const timeSlotElements = document.querySelectorAll(`[data-staff-id="${staffSelect.value}"]`); // Get all slots for the selected staff

            // Clear previous warnings and highlighting
            if (conflictWarningElement) conflictWarningElement.remove();
            timeSlotElements.forEach(slot => slot.classList.remove('conflict-detected-slot'));

            if (!serviceSelect.value || !staffSelect.value || !startTimeInput.value || !endTimeInput.value) {
                return; // Not enough info to check
            }

            const serviceDuration = parseInt(serviceSelect.options[serviceSelect.selectedIndex].dataset.duration) || 60;
            const conflicts = checkRealTimeConflicts(staffSelect.value, serviceSelect.value, startTimeInput.value, endTimeInput.value);

            if (conflicts.length > 0) {
                const warningMessage = `Conflict Detected! ${conflicts.map(c => c.message).join(', ')}`;
                const warningDiv = document.createElement('div');
                warningDiv.className = 'conflict-warning';
                warningDiv.innerHTML = warningMessage;

                // Add suggested times if needed
                const suggestedTimes = generateSuggestedTimes(staffSelect.value, startTimeInput.value, serviceDuration);
                if (suggestedTimes.length > 0) {
                    const suggestionsHTML = suggestedTimes.map(time =>
                        `<span class="suggested-time" onclick="selectSuggestedTime('${time}')">${time}</span>`
                    ).join(' ');
                    warningDiv.innerHTML += ` Suggest alternative: ${suggestionsHTML}`;
                }

                // Append warning below the start time input for the specific row
                const parentDiv = startTimeInput.closest('.row');
                if (parentDiv) {
                    parentDiv.parentNode.insertBefore(warningDiv, parentDiv.nextSibling);
                }

                // Highlight conflicting slots in the schedule grid (simplified highlighting)
                const conflictingSlots = getConflictingSlots(staffSelect.value, startTimeInput.value, endTimeInput.value);
                conflictingSlots.forEach(slotIndex => {
                    const slotElement = document.querySelector(`[data-staff-id="${staffSelect.value}"][data-slot-index="${slotIndex}"]`);
                    if (slotElement) slotElement.classList.add('conflict-detected-slot');
                });

            }
        }

        function getConflictingSlots(staffId, startTime, endTime) {
            const conflicting = [];
            const selectedStart = timeToMinutes(startTime);
            const selectedEnd = timeToMinutes(endTime);

            scheduleData.appointments.forEach(apt => {
                if (apt.staffId === staffId) {
                    const aptStart = timeToMinutes(apt.startTime);
                    const aptEnd = timeToMinutes(apt.endTime);

                    if (selectedStart < aptEnd && selectedEnd > aptStart) {
                        // Add all slots covered by the conflict
                        for (let i = getSlotIndexFromTime(apt.startTime); i < getSlotIndexFromTime(apt.endTime); i++) {
                            if (i >= 0) conflicting.push(i);
                        }
                        for (let i = getSlotIndexFromTime(startTime); i < getSlotIndexFromTime(endTime); i++) {
                            if (i >= 0) conflicting.push(i);
                        }
                    }
                }
            });
            return [...new Set(conflicting)]; // Unique slots
        }

        function generateSuggestedTimes(staffId, startTime, durationMinutes) {
            const suggestions = [];
            const currentSlotIndex = getSlotIndexFromTime(startTime);
            const scheduleStartMinutes = SCHEDULE_CONFIG.startHour * 60;
            const scheduleEndMinutes = SCHEDULE_CONFIG.endHour * 60;

            // Check for next few available slots
            for (let i = 1; i <= 5; i++) { // Suggest up to 5 alternatives
                const nextSlotIndex = currentSlotIndex + i;
                const nextSlotTimeMinutes = scheduleStartMinutes + (nextSlotIndex * SCHEDULE_CONFIG.slotMinutes);

                if (nextSlotTimeMinutes >= scheduleEndMinutes) break; // Don't go beyond schedule end

                const nextStartTimeStr = formatTimeFromMinutes(nextSlotTimeMinutes);
                const nextEndTimeStr = formatTimeFromMinutes(nextSlotTimeMinutes + durationMinutes);

                // Ensure the suggested slot is within the schedule hours
                if (timeToMinutes(nextEndTimeStr) > scheduleEndMinutes) continue;

                const conflicts = checkRealTimeConflicts(staffId, null, nextStartTimeStr, nextEndTimeStr);
                if (conflicts.length === 0) {
                    suggestions.push(nextStartTimeStr);
                } else {
                    // If the conflict is not with the *same* appointment, we can skip slots occupied by it
                    // This logic needs to be more robust for complex scenarios
                }
            }
            return suggestions;
        }

        function formatTimeFromMinutes(totalMinutes) {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }


        function clearConflictWarning(rowId) {
            const warningElement = document.querySelector(`[data-row="${rowId}"] .conflict-warning`);
            if (warningElement) {
                warningElement.remove();
            }
            // Also remove highlighting from slots
            const staffId = document.querySelector(`[data-row="${rowId}"].staff-select`).value;
            const timeSlotElements = document.querySelectorAll(`[data-staff-id="${staffId}"]`);
            timeSlotElements.forEach(slot => slot.classList.remove('conflict-detected-slot'));
        }

        // Make functions globally available
        window.showLoadingAndLoadSample = showLoadingAndLoadSample;
        window.openQuickBookingModal = openQuickBookingModal;
        window.clearAllData = clearAllData;
        window.loadSampleData = loadSampleData;
        window.bookAppointment = bookAppointment;
        window.showLoadingAndLoad = showLoadingAndLoad;
        window.showLoadingAndRefresh = showLoadingAndRefresh;
        window.updateEndTime = updateEndTime;
        window.updateTimeDisplay = updateTimeDisplay;
        window.navigateDate = navigateDate;
        window.goToToday = goToToday;
        window.exportSchedule = exportSchedule;
        window.printSchedule = printSchedule;
        window.scrollToTop = scrollToTop;

        // Conflict detection functions
        window.checkRealTimeConflicts = checkRealTimeConflicts;
        window.selectSuggestedTime = selectSuggestedTime;
        window.performConflictCheck = performConflictCheck;
        window.clearConflictWarning = clearConflictWarning;

        // Edit appointment functionality
        // (The editAppointment, populateEditServiceDropdown, populateEditStaffDropdown, and updateEditEndTime functions have been updated above)

        // New functions for edit/delete
        window.editAppointment = editAppointment;
        window.deleteAppointment = deleteAppointment;
        window.updateAppointment = updateAppointment;
        window.viewAppointmentDetails = function(appointmentId) { /* Placeholder for viewing details */ };

        function renderSchedule() {
            try {
                console.log('üîÑ Starting schedule render...');
                console.log('üìä Schedule data:', scheduleData);

                if (!scheduleData || !scheduleData.staff || !scheduleData.appointments) {
                    console.error('‚ùå Invalid schedule data:', scheduleData);
                    document.getElementById('scheduleGrid').innerHTML = '<div class="text-center p-5 text-danger">No schedule data available</div>';
                    hideLoading();
                    return;
                }

                generateScheduleGrid();

                // Reinitialize context menu after schedule is rendered
                console.log('üîÑ Reinitializing context menu after schedule render...');
                if (window.reinitializeContextMenu) {
                    setTimeout(() => {
                        window.reinitializeContextMenu();
                    }, 100);
                }

                // Show stats
                updateStats();
                hideLoading();
                console.log(`üìä Schedule loaded: ${scheduleData.appointments.length} appointments, ${scheduleData.staff.length} staff members`);

            } catch (error) {
                console.error('‚ùå Error building schedule grid:', error);
                console.error('Error details:', error.stack);
                hideLoading();
                showNotification('Error loading schedule. Please refresh and try again.', 'error');

                // Show basic error message in grid
                const grid = document.getElementById('scheduleGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div class="text-center p-5 text-danger">
                            <h5>Error Loading Schedule</h5>
                            <p>Please refresh the page and try again.</p>
                            <button class="btn btn-primary" onclick="location.reload()">Refresh Page</button>
                        </div>
                    `;
                }
            }
        }

        // Helper function to get service color
        function getServiceColor(serviceName) {
            const colors = {
                'facial': '#e3f2fd',
                'massage': '#f3e5f5',
                'manicure': '#e8f5e8',
                'pedicure': '#fff3e0',
                'hair': '#fce4ec',
                'body': '#e0f2f1'
            };

            const key = serviceName ? serviceName.toLowerCase() : 'default';
            for (const [service, color] of Object.entries(colors)) {
                if (key.includes(service)) {
                    return color;
                }
            }
            return '#f5f5f5';
        }

        // Helper function for notifications
        function showNotification(message, type = 'info') {
            console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
            // You can implement a toast notification system here
            alert(message);
        }

        // Helper function to refresh schedule
        function refreshSchedule() {
            console.log('üîÑ Refreshing schedule');
            loadScheduleForDate();
        }
    </script>
</body>
</html>