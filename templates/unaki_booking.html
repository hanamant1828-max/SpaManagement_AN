<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Unaki Appointment Booking - Premium Timeline</title>

        <!-- External Resources -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
            rel="stylesheet"
        />

        <!-- Select2 CSS for searchable dropdowns -->
        <link
            href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
            rel="stylesheet"
        />

        <!-- jQuery MUST be loaded first -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <!-- Select2 JS -->
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <!-- Bootstrap -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Context Menu -->
        <script src="{{ url_for('static', filename='js/appointment_context_menu.js') }}"></script>

        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            :root {
                --primary-color: #4f46e5;
                --primary-hover: #4338ca;
                --success-color: #10b981;
                --danger-color: #ef4444;
                --warning-color: #f59e0b;
                --info-color: #06b6d4;
                --border-color: #e5e7eb;
                --hover-bg: #f9fafb;
                --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
                --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            }

            body {
                font-family:
                    "Inter",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                overflow: hidden;
                color: #1f2937;
            }

            /* ==================== TOP NAVIGATION ==================== */
            .calendar-top-nav {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 64px;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 24px;
                z-index: 100;
                box-shadow: var(--shadow-md);
            }

            .calendar-logo {
                font-size: 20px;
                font-weight: 700;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .calendar-logo i {
                -webkit-text-fill-color: #667eea;
            }

            .calendar-date-nav {
                display: flex;
                align-items: center;
                gap: 16px;
                background: white;
                padding: 8px 12px;
                border-radius: 12px;
                box-shadow: var(--shadow-sm);
                border: 1px solid var(--border-color);
            }

            .date-nav-btn {
                width: 36px;
                height: 36px;
                border-radius: 8px;
                border: none;
                background: var(--hover-bg);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
                color: #6b7280;
            }

            .date-nav-btn:hover {
                background: var(--primary-color);
                color: white;
                transform: scale(1.05);
            }

            .current-date-display {
                font-size: 15px;
                font-weight: 600;
                color: #1f2937;
                min-width: 220px;
                text-align: center;
            }

            .date-today-btn {
                padding: 6px 12px;
                border-radius: 8px;
                border: 1px solid var(--border-color);
                background: white;
                font-size: 13px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                color: #6b7280;
            }

            .date-today-btn:hover {
                background: var(--primary-color);
                color: white;
                border-color: var(--primary-color);
            }

            .calendar-actions {
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .action-btn {
                padding: 10px 18px;
                border-radius: 10px;
                border: none;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .action-btn-primary {
                background: var(--primary-color);
                color: white;
                box-shadow: var(--shadow-md);
            }

            .action-btn-primary:hover {
                background: var(--primary-hover);
                transform: translateY(-2px);
                box-shadow: var(--shadow-lg);
            }

            .action-icon {
                width: 40px;
                height: 40px;
                border-radius: 10px;
                border: 1px solid var(--border-color);
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s;
                color: #6b7280;
            }

            .action-icon:hover {
                background: var(--hover-bg);
                color: var(--primary-color);
                transform: scale(1.05);
            }

            /* ==================== MAIN LAYOUT ==================== */
            .calendar-main-layout {
                position: fixed;
                top: 64px;
                left: 0;
                right: 0;
                bottom: 0;
                display: flex;
                background: white;
                overflow: visible;
                margin: 12px;
                border-radius: 16px;
                box-shadow: var(--shadow-xl);
            }

            .calendar-main-layout::before {
                content: "";
                position: absolute;
                top: 60px;
                left: 0;
                right: 0;
                bottom: 0;
                background-image: repeating-linear-gradient(
                    to bottom,
                    transparent 0,
                    transparent 109px,
                    rgba(79, 70, 229, 0.08) 109px,
                    rgba(79, 70, 229, 0.08) 110px
                );
                pointer-events: none;
                z-index: 1;
            }

            /* ==================== STAFF SIDEBAR ==================== */
            .staff-sidebar {
                width: 280px;
                flex-shrink: 0;
                background: #ffffff;
                border-right: 2px solid var(--border-color);
                overflow-y: auto;
                position: relative;
                z-index: 2;
                scrollbar-gutter: stable;
            }

            .staff-sidebar-header {
                height: 60px;
                background: white;
                border-bottom: 2px solid var(--border-color);
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0 20px;
                font-weight: 700;
                font-size: 14px;
                color: #1f2937;
                position: sticky;
                top: 0;
                z-index: 10;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .staff-count {
                background: var(--primary-color);
                color: white;
                padding: 4px 10px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
            }

            .staff-row {
                height: 110px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                align-items: center;
                padding: 16px 20px;
                gap: 14px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .staff-row:nth-of-type(odd) {
                background: #fafbfc;
            }
            .staff-row:nth-of-type(even) {
                background: #ffffff;
            }

            .staff-row:hover {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .staff-row:hover .staff-avatar {
                transform: scale(1.1);
                box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.5);
            }

            .staff-row:hover .staff-name,
            .staff-row:hover .staff-role,
            .staff-row:hover .staff-status {
                color: white;
            }

            .staff-avatar {
                width: 56px;
                height: 56px;
                border-radius: 14px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: 700;
                font-size: 20px;
                flex-shrink: 0;
                transition: all 0.3s;
                box-shadow: var(--shadow-md);
            }

            .staff-info {
                flex: 1;
                min-width: 0;
            }

            .staff-name {
                font-size: 15px;
                font-weight: 600;
                color: #1f2937;
                margin-bottom: 4px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .staff-role {
                font-size: 13px;
                color: #6b7280;
                margin-bottom: 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .staff-status {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                font-size: 11px;
                font-weight: 500;
                color: var(--success-color);
            }

            .status-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--success-color);
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            /* ==================== TIMELINE PANEL ==================== */
            .timeline-panel {
                flex: 1;
                overflow: auto;
                background: #ffffff;
                position: relative;
                z-index: 2;
                -webkit-overflow-scrolling: touch;
                scrollbar-gutter: stable;
            }

            .timeline-header {
                height: 60px;
                background: white;
                border-bottom: 2px solid var(--border-color);
                display: flex;
                position: sticky;
                top: 0;
                left: 0;
                z-index: 9;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
                overflow: hidden;
            }

            .timeline-header-inner {
                display: flex;
                transition: transform 0.05s linear;
            }

            .timeline-hour {
                min-width: 140px;
                flex-shrink: 0;
                border-right: 1px solid #e5e7eb;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                font-size: 13px;
                color: #1f2937;
                transition: all 0.2s;
            }

            .timeline-hour:hover {
                background: var(--hover-bg);
            }

            .hour-label {
                font-size: 14px;
                font-weight: 700;
            }

            .hour-period {
                font-size: 11px;
                color: #9ca3af;
                margin-top: 2px;
            }

            .timeline-grid {
                position: relative;
                min-width: max-content;
                min-height: 100%;
            }

            .timeline-row {
                height: 110px;
                border-bottom: 1px solid var(--border-color);
                display: flex;
                position: relative;
                transition: background 0.2s;
            }

            .timeline-row:nth-child(odd) {
                background: #fafbfc;
            }
            .timeline-row:nth-child(even) {
                background: #ffffff;
            }
            .timeline-row:hover {
                background: rgba(79, 70, 229, 0.02);
            }

            .timeline-hour-slot {
                min-width: 140px;
                flex-shrink: 0;
                position: relative;
                background: transparent;
                border-right: 1px solid #e5e7eb;
                cursor: pointer;
                transition: all 0.2s;
            }

            .timeline-hour-slot:hover {
                background: linear-gradient(
                    to bottom,
                    rgba(79, 70, 229, 0.03),
                    rgba(79, 70, 229, 0.05)
                );
            }

            .timeline-hour-slot:hover::after {
                content: "+";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 24px;
                color: var(--primary-color);
                font-weight: 600;
                opacity: 0.3;
            }

            .interval-marker {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 1px;
                background: #f3f4f6;
            }

            .interval-15 {
                left: 25%;
            }
            .interval-30 {
                left: 50%;
                background: #e5e7eb;
            }
            .interval-45 {
                left: 75%;
            }

            /* ==================== APPOINTMENT BLOCKS ==================== */
            .appointment-block {
                position: absolute;
                top: 8px;
                bottom: 8px;
                border-radius: 10px;
                border-left: 4px solid;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
                padding: 12px;
                cursor: move;
                transition: all 0.2s;
                overflow: hidden;
                z-index: 5;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                user-select: none;
            }

            .appointment-block:hover {
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
                transform: translateY(-2px) scale(1.02);
                z-index: 10;
            }

            .appointment-block.dragging {
                opacity: 0.6;
                cursor: grabbing;
                z-index: 100;
            }

            .appointment-block.paid {
                background: #ffe4e6 !important;
                border-left-color: #f87171 !important;
            }

            .appointment-block.paid .appointment-client {
                color: #991b1b;
            }

            .appointment-block.paid .appointment-service {
                color: #b91c1c;
            }

            .appointment-header {
                display: flex;
                align-items: flex-start;
                justify-content: space-between;
                margin-bottom: 8px;
            }

            .appointment-client {
                font-size: 14px;
                font-weight: 700;
                color: #1f2937;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex: 1;
            }

            .appointment-status {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--success-color);
                flex-shrink: 0;
                margin-left: 8px;
            }

            .appointment-service {
                font-size: 12px;
                color: #6b7280;
                margin-bottom: 6px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .appointment-footer {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-top: auto;
            }

            .appointment-time {
                font-size: 11px;
                font-weight: 600;
                color: #9ca3af;
                display: flex;
                align-items: center;
                gap: 4px;
            }

            .appointment-duration {
                font-size: 10px;
                background: rgba(0, 0, 0, 0.05);
                padding: 2px 8px;
                border-radius: 12px;
                font-weight: 600;
            }

            /* Service Colors */
            .service-massage {
                border-left-color: #3b82f6;
                background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            }
            .service-facial {
                border-left-color: #a855f7;
                background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            }
            .service-manicure {
                border-left-color: #f43f5e;
                background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
            }
            .service-pedicure {
                border-left-color: #78350f;
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            }
            .service-haircut {
                border-left-color: #22c55e;
                background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            }
            .service-waxing {
                border-left-color: #f97316;
                background: linear-gradient(135deg, #ffedd5 0%, #fed7aa 100%);
            }
            .service-default {
                border-left-color: #6b7280;
                background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            }

            /* ==================== SHIFT OVERLAYS ==================== */
            .shift-overlay {
                position: absolute;
                top: 0;
                bottom: 0;
                pointer-events: none;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1;
                border-radius: 6px;
                opacity: 0.75;
            }

            .shift-overlay-break {
                background: linear-gradient(
                    135deg,
                    rgba(245, 158, 11, 0.3),
                    rgba(251, 191, 36, 0.3)
                );
                border: 1px dashed rgba(245, 158, 11, 0.5);
            }

            .shift-overlay-out-of-office {
                background: linear-gradient(
                    135deg,
                    rgba(239, 68, 68, 0.4),
                    rgba(252, 165, 165, 0.4)
                );
                border: 1px dashed rgba(239, 68, 68, 0.6);
            }

            .shift-overlay-off-duty {
                background: linear-gradient(
                    135deg,
                    rgba(107, 114, 128, 0.2),
                    rgba(156, 163, 175, 0.2)
                );
                border: 1px dashed rgba(107, 114, 128, 0.4);
            }

            .shift-overlay-holiday {
                background: rgba(99, 102, 241, 0.25);
                border: 1px dashed rgba(99, 102, 241, 0.5);
            }

            .overlay-label {
                font-size: 11px;
                font-weight: 600;
                color: rgba(0, 0, 0, 0.7);
                text-transform: uppercase;
                letter-spacing: 0.5px;
                text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            }

            /* ==================== CURRENT TIME LINE ==================== */
            .current-time-line {
                position: absolute;
                top: 0;
                bottom: 0;
                width: 2px;
                background: var(--danger-color);
                z-index: 20;
                pointer-events: none;
                box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            }

            .current-time-line::before {
                content: "";
                position: absolute;
                top: -6px;
                left: -6px;
                width: 14px;
                height: 14px;
                background: var(--danger-color);
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
                animation: currentTimePulse 2s infinite;
            }

            .current-time-label {
                position: absolute;
                top: 16px;
                left: 6px;
                background: var(--danger-color);
                color: white;
                padding: 4px 8px;
                border-radius: 6px;
                font-size: 11px;
                font-weight: 600;
                white-space: nowrap;
                box-shadow: var(--shadow-md);
            }

            @keyframes currentTimePulse {
                0%,
                100% {
                    transform: scale(1);
                    opacity: 1;
                }
                50% {
                    transform: scale(1.2);
                    opacity: 0.8;
                }
            }

            /* ==================== CONTEXT MENU ==================== */
            .context-menu {
                position: fixed;
                background: white;
                border: 1px solid var(--border-color);
                border-radius: 12px;
                box-shadow: var(--shadow-xl);
                padding: 8px;
                min-width: 220px;
                z-index: 1000;
                display: none;
                animation: contextMenuFadeIn 0.2s ease;
            }

            @keyframes contextMenuFadeIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            .context-menu.show {
                display: block;
            }

            .context-menu-item {
                padding: 12px 16px;
                cursor: pointer;
                font-size: 14px;
                color: #1f2937;
                display: flex;
                align-items: center;
                gap: 12px;
                transition: all 0.2s;
                border-radius: 8px;
                font-weight: 500;
            }

            .context-menu-item:hover {
                background: var(--hover-bg);
                color: var(--primary-color);
                transform: translateX(4px);
            }

            .context-menu-item i {
                width: 18px;
                text-align: center;
            }

            .context-menu-divider {
                height: 1px;
                background: var(--border-color);
                margin: 8px 0;
            }

            .context-menu-item.danger:hover {
                background: #fee;
                color: var(--danger-color);
            }

            /* ==================== MODAL STYLES ==================== */
            /* Quick Add Client Modal - Higher Level */
            #quickAddClientModal {
                z-index: 1065 !important;
            }
            .modal-backdrop:nth-of-type(2) {
                z-index: 1060 !important;
            }

            /* Ensure modal content is above backdrop */
            .modal.show {
                z-index: 1055;
            }
            .modal-backdrop.show {
                z-index: 1050;
            }

            /* When second modal opens */
            .modal.show ~ .modal.show {
                z-index: 1065 !important;
            }

            .modal-dialog {
                max-height: 90vh;
            }

            .modal-dialog.modal-xl {
                max-width: 1200px;
            }

            .modal-body {
                max-height: calc(90vh - 120px);
                overflow-y: auto;
            }

            /* ==================== VALIDATION ==================== */
            .is-invalid {
                border-color: #dc3545 !important;
                background-color: #fff5f5 !important;
            }

            .is-valid {
                border-color: #28a745 !important;
                background-color: #f0fff4 !important;
            }

            .validation-error {
                color: #dc3545;
                font-size: 0.875rem;
                margin-top: 0.25rem;
            }

            /* ==================== UTILITY STYLES ==================== */
            .tooltip-custom {
                position: fixed;
                background: rgba(0, 0, 0, 0.9);
                color: white;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 12px;
                font-weight: 500;
                z-index: 10000;
                pointer-events: none;
                display: none;
                white-space: nowrap;
                box-shadow: var(--shadow-lg);
            }

            .tooltip-custom.show {
                display: block;
                animation: tooltipFadeIn 0.2s ease;
            }

            @keyframes tooltipFadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(255, 255, 255, 0.95);
                display: none;
                align-items: center;
                justify-content: center;
                z-index: 50;
                backdrop-filter: blur(5px);
            }

            .loading-overlay.show {
                display: flex;
            }

            .spinner {
                width: 50px;
                height: 50px;
                border: 4px solid #e5e7eb;
                border-top-color: var(--primary-color);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            @keyframes shake {
                0%,
                100% {
                    transform: translateX(0);
                }
                10%,
                30%,
                50%,
                70%,
                90% {
                    transform: translateX(-5px);
                }
                20%,
                40%,
                60%,
                80% {
                    transform: translateX(5px);
                }
            }

            /* Enhanced validation states */
            .form-control.is-valid,
            .form-select.is-valid {
                border-color: #10b981 !important;
                background-image: none;
            }

            .form-control.is-invalid,
            .form-select.is-invalid {
                border-color: #ef4444 !important;
                background-image: none;
            }

            .validation-icon {
                transition: all 0.3s ease;
            }

            /* ==================== SCROLLBAR ==================== */
            ::-webkit-scrollbar {
                width: 14px;
                height: 14px;
            }

            ::-webkit-scrollbar-track {
                background: #f3f4f6;
                border-radius: 10px;
                border: 2px solid #ffffff;
            }

            ::-webkit-scrollbar-thumb {
                background: linear-gradient(180deg, #9ca3af 0%, #6b7280 100%);
                border-radius: 10px;
                border: 3px solid #f3f4f6;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(180deg, #6b7280 0%, #4b5563 100%);
            }

            /* ==================== RESPONSIVE ==================== */
            @media (max-width: 1024px) {
                .staff-sidebar {
                    width: 240px;
                }
                .timeline-hour,
                .timeline-hour-slot {
                    min-width: 110px;
                }
            }

            @media (max-width: 768px) {
                .calendar-main-layout {
                    margin: 8px;
                    border-radius: 12px;
                }
                .staff-sidebar {
                    width: 200px;
                }
                .timeline-hour,
                .timeline-hour-slot {
                    min-width: 90px;
                }
                .staff-row {
                    height: 90px;
                    padding: 12px;
                }
                .staff-avatar {
                    width: 48px;
                    height: 48px;
                    font-size: 18px;
                }
                .calendar-logo span {
                    display: none;
                }
                .current-date-display {
                    min-width: 150px;
                    font-size: 13px;
                }
                ::-webkit-scrollbar {
                    width: 8px;
                    height: 8px;
                }
            }
        </style>
    </head>
    <body>
        <!-- Tooltip -->
        <div class="tooltip-custom" id="tooltip"></div>

        <div class="calendar-wrapper">
            <!-- Top Navigation -->
            <div class="calendar-top-nav">
                <div class="calendar-logo">
                    <i class="fas fa-calendar-check"></i>
                    <span>Unaki Booking</span>
                </div>

                <div class="calendar-date-nav">
                    <button
                        class="date-nav-btn"
                        onclick="navigateDate(-1)"
                        data-tooltip="Previous Day"
                    >
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button
                        class="date-today-btn"
                        onclick="navigateToToday()"
                        data-tooltip="Go to Today"
                    >
                        Today
                    </button>
                    <div class="current-date-display" id="currentDateDisplay">
                        {{ today_date }}
                    </div>
                    <button
                        class="date-nav-btn"
                        onclick="navigateDate(1)"
                        data-tooltip="Next Day"
                    >
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

                <div style="display: flex; align-items: center; gap: 16px">
                    <!-- Stats -->
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 8px 12px;
                            background: white;
                            border-radius: 10px;
                            border: 1px solid var(--border-color);
                        "
                    >
                        <i
                            class="fas fa-calendar-check"
                            style="color: var(--primary-color)"
                        ></i>
                        <div>
                            <div
                                style="
                                    font-size: 16px;
                                    font-weight: 700;
                                    color: #1f2937;
                                "
                                id="totalBookings"
                            >
                                0
                            </div>
                            <div style="font-size: 10px; color: #6b7280">
                                Total
                            </div>
                        </div>
                    </div>
                    <div
                        style="
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            padding: 8px 12px;
                            background: white;
                            border-radius: 10px;
                            border: 1px solid var(--border-color);
                        "
                    >
                        <i
                            class="fas fa-check-circle"
                            style="color: var(--success-color)"
                        ></i>
                        <div>
                            <div
                                style="
                                    font-size: 16px;
                                    font-weight: 700;
                                    color: #1f2937;
                                "
                                id="completedBookings"
                            >
                                0
                            </div>
                            <div style="font-size: 10px; color: #6b7280">
                                Done
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="calendar-actions">
                        <a
                            href="{{ url_for('multi_appointment_booking') }}"
                            class="action-btn action-btn-primary"
                            style="text-decoration: none;"
                        >
                            <i class="fas fa-plus-circle"></i>
                            New Appointment
                        </a>
                        <a
                            href="{{ url_for('shift_scheduler.shift_scheduler') }}"
                            class="action-btn"
                            style="
                                background: var(--warning-color);
                                color: white;
                                text-decoration: none;
                            "
                        >
                            <i class="fas fa-calendar-check"></i>
                            Shift Scheduler
                        </a>
                        <button class="action-icon" onclick="refreshSchedule()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <a
                            href="{{ url_for('dashboard') }}"
                            class="action-btn"
                            style="
                                background: var(--info-color);
                                color: white;
                                text-decoration: none;
                            "
                        >
                            <i class="fas fa-home"></i>
                            Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Layout -->
            <div class="calendar-main-layout">
                <!-- Staff Sidebar -->
                <div class="staff-sidebar">
                    <div class="staff-sidebar-header">
                        <span>Staff Members</span>
                        <span class="staff-count"
                            >{{ staff_members|length if staff_members else 0
                            }}</span
                        >
                    </div>

                    <div class="staff-list">
                        {% if staff_members %} {% for staff in staff_members %}
                        <div
                            class="staff-row staff-row-{{ loop.index }}"
                            data-staff-id="{{ staff.id }}"
                        >
                            <div class="staff-avatar">
                                {{ (staff.first_name[:1] +
                                staff.last_name[:1]).upper() if staff.first_name
                                and staff.last_name else
                                staff.username[:2].upper() }}
                            </div>
                            <div class="staff-info">
                                <div class="staff-name">
                                    {{ staff.first_name }} {{ staff.last_name if
                                    staff.last_name else '' }}
                                </div>
                                <div class="staff-role">
                                    {{ staff.role or 'Therapist' }}
                                </div>
                                <div class="staff-status">
                                    <span class="status-dot"></span>
                                    Available
                                </div>
                            </div>
                        </div>
                        {% endfor %} {% endif %}
                    </div>
                </div>

                <!-- Timeline Panel -->
                <div class="timeline-panel">
                    <div class="timeline-header">
                        <div
                            class="timeline-header-inner"
                            id="timelineHeaderInner"
                        >
                            {% for hour in range(9, 22) %}
                            <div class="timeline-hour">
                                <span class="hour-label"
                                    >{{ '%d:00' % hour if hour < 12 else
                                    ('12:00' if hour == 12 else '%d:00' % (hour
                                    - 12)) }}</span
                                >
                                <span class="hour-period"
                                    >{{ 'AM' if hour < 12 else 'PM' }}</span
                                >
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="timeline-grid" id="timelineGrid">
                        {% if staff_members %} {% for staff in staff_members %}
                        <div
                            class="timeline-row"
                            data-staff-id="{{ staff.id }}"
                        >
                            {% for hour in range(9, 22) %}
                            <div
                                class="timeline-hour-slot"
                                data-hour="{{ hour }}"
                                data-staff-id="{{ staff.id }}"
                                onclick="handleSlotClick(event, {{ staff.id }}, {{ hour }}, 0)"
                            >
                                <div class="interval-marker interval-15"></div>
                                <div class="interval-marker interval-30"></div>
                                <div class="interval-marker interval-45"></div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %} {% endif %}

                        <div
                            class="current-time-line"
                            id="currentTimeLine"
                            style="display: none"
                        >
                            <div
                                class="current-time-label"
                                id="currentTimeLabel"
                            >
                                Now
                            </div>
                        </div>
                    </div>

                    <div class="loading-overlay" id="loadingOverlay">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context Menu -->
        <div class="context-menu" id="contextMenu">
            <div class="context-menu-item" onclick="viewAppointmentDetails()">
                <i class="fas fa-eye"></i>View Details
            </div>
            <div class="context-menu-item" onclick="editAppointment()">
                <i class="fas fa-edit"></i>Edit Appointment
            </div>
            <div class="context-menu-divider"></div>
            <div class="context-menu-item danger" onclick="cancelAppointment()">
                <i class="fas fa-times-circle"></i>Cancel Appointment
            </div>
        </div>

        <script>
            // Cancel all appointments for a specific customer from Unaki booking view
            function cancelAllCustomerAppointments(customerId, customerName) {
                if (!customerId) {
                    alert('Please select a customer first');
                    return;
                }

                // Get all appointments for this customer
                fetch(`/api/unaki/customer-appointments/${customerId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.bookings) {
                            const activeAppointments = data.bookings.filter(
                                apt => apt.status === 'scheduled' || apt.status === 'confirmed'
                            );

                            if (activeAppointments.length === 0) {
                                alert('No active appointments found for this customer');
                                return;
                            }

                            const appointmentsList = activeAppointments.map(apt =>
                                `- ${apt.service_name} on ${apt.appointment_date} at ${apt.start_time}`
                            ).join('\n');

                            const confirmMessage = `Are you sure you want to cancel ALL ${activeAppointments.length} appointment(s) for ${customerName}?\n\nAppointments:\n${appointmentsList}`;

                            if (confirm(confirmMessage)) {
                                // Cancel all appointments using PATCH endpoint
                                const cancelPromises = activeAppointments.map(apt =>
                                    fetch(`/api/unaki/bookings/${apt.id}`, {
                                        method: 'PATCH',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({ status: 'cancelled' })
                                    }).then(r => r.json())
                                );

                                Promise.all(cancelPromises)
                                    .then(results => {
                                        const successCount = results.filter(r => r.success).length;
                                        const failCount = results.length - successCount;

                                        if (failCount === 0) {
                                            alert(`✅ Successfully cancelled all ${successCount} appointments for ${customerName}`);
                                            // Refresh the schedule
                                            refreshSchedule();
                                        } else {
                                            alert(`⚠️ Cancelled ${successCount} appointments, ${failCount} failed`);
                                            refreshSchedule();
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error cancelling appointments:', error);
                                        alert('Error cancelling appointments. Please try again.');
                                    });
                            }
                        } else {
                            alert('Failed to load customer appointments');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading appointments:', error);
                        alert('Error loading customer appointments');
                    });
            }
        </script>

        <!-- Edit Appointment Modal -->
        <div class="modal fade" id="editAppointmentModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div
                    class="modal-content"
                    style="
                        border-radius: 16px;
                        border: none;
                        box-shadow: var(--shadow-xl);
                    "
                >
                    <div
                        class="modal-header"
                        style="
                            border-bottom: 2px solid var(--border-color);
                            padding: 20px 24px;
                        "
                    >
                        <h5
                            class="modal-title"
                            style="font-weight: 700; font-size: 18px"
                        >
                            <i
                                class="fas fa-edit me-2"
                                style="color: var(--warning-color)"
                            ></i
                            >Edit Appointment
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body" style="padding: 24px">
                        <input type="hidden" id="editAppointmentId" />

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-user me-2"
                                        style="color: var(--primary-color)"
                                    ></i
                                    >Client Name
                                </label>
                                <input
                                    type="text"
                                    id="editClientName"
                                    class="form-control"
                                    readonly
                                    style="
                                        background: #f9fafb;
                                        border-radius: 10px;
                                        padding: 12px;
                                    "
                                />
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-semibold">
                                        <i
                                            class="fas fa-concierge-bell me-2"
                                            style="color: var(--primary-color)"
                                        ></i
                                        >Service
                                    </label>
                                    <select
                                        id="editServiceSelect"
                                        class="form-select service-select"
                                        required
                                        style="
                                            border-radius: 10px;
                                            padding: 12px;
                                            width: 100%;
                                        "
                                    >
                                        <option value="">
                                            Select service...
                                        </option>
                                        {% if services %} {% for service in
                                        services %}
                                        <option
                                            value="{{ service.id }}"
                                            data-duration="{{ service.duration or 60 }}"
                                            data-price="{{ service.price }}"
                                        >
                                            {{ service.name }} ({{
                                            service.duration or 60 }} min - ₹{{
                                            "%.2f"|format(service.price) }})
                                        </option>
                                        {% endfor %} {% endif %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-semibold">
                                        <i
                                            class="fas fa-user-md me-2"
                                            style="color: var(--primary-color)"
                                        ></i
                                        >Staff Member
                                    </label>
                                    <select
                                        id="editStaffSelect"
                                        class="form-select"
                                        required
                                        style="
                                            border-radius: 10px;
                                            padding: 12px;
                                        "
                                    >
                                        <option value="">
                                            Select staff member...
                                        </option>
                                        {% if staff_members %} {% for staff in
                                        staff_members %}
                                        <option value="{{ staff.id }}">
                                            {{ staff.first_name }} {{
                                            staff.last_name if staff.last_name
                                            else '' }}
                                        </option>
                                        {% endfor %} {% endif %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-semibold">
                                        <i
                                            class="fas fa-info-circle me-2"
                                            style="color: var(--primary-color)"
                                        ></i
                                        >Status
                                    </label>
                                    <select
                                        id="editStatus"
                                        class="form-select"
                                        required
                                        style="
                                            border-radius: 10px;
                                            padding: 12px;
                                        "
                                    >
                                        <option value="scheduled">
                                            Scheduled
                                        </option>
                                        <option value="confirmed">
                                            Confirmed
                                        </option>
                                        <option value="in_progress">
                                            In Progress
                                        </option>
                                        <option value="completed">
                                            Completed
                                        </option>
                                        <option value="cancelled">
                                            Cancelled
                                        </option>
                                        <option value="no_show">No Show</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label fw-semibold">
                                        <i
                                            class="fas fa-money-bill-wave me-2"
                                            style="color: var(--success-color)"
                                        ></i
                                        >Payment Status
                                    </label>
                                    <select
                                        id="editPaymentStatus"
                                        class="form-select"
                                        required
                                        style="
                                            border-radius: 10px;
                                            padding: 12px;
                                        "
                                    >
                                        <option value="pending">Pending</option>
                                        <option value="partial">Partial</option>
                                        <option value="paid">Paid</option>
                                        <option value="cancelled">
                                            Cancelled
                                        </option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-calendar me-2"
                                        style="color: var(--primary-color)"
                                    ></i
                                    >Date
                                </label>
                                <input
                                    type="date"
                                    id="editAppointmentDate"
                                    class="form-control"
                                    required
                                    style="border-radius: 10px; padding: 12px"
                                />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-clock me-2"
                                        style="color: var(--primary-color)"
                                    ></i
                                    >Start Time
                                </label>
                                <input
                                    type="time"
                                    id="editStartTime"
                                    class="form-control"
                                    required
                                    style="border-radius: 10px; padding: 12px"
                                />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-clock me-2"
                                        style="color: var(--success-color)"
                                    ></i
                                    >End Time
                                </label>
                                <input
                                    type="time"
                                    id="editEndTime"
                                    class="form-control"
                                    readonly
                                    style="
                                        border-radius: 10px;
                                        padding: 12px;
                                        background: #f0fdf4;
                                        font-weight: 600;
                                        color: var(--success-color);
                                    "
                                />
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">
                                <i
                                    class="fas fa-sticky-note me-2"
                                    style="color: var(--primary-color)"
                                ></i
                                >Notes
                            </label>
                            <textarea
                                id="editNotes"
                                class="form-control"
                                rows="3"
                                style="border-radius: 10px; padding: 12px"
                            ></textarea>
                        </div>
                    </div>
                    <div
                        class="modal-footer"
                        style="
                            border-top: 2px solid var(--border-color);
                            padding: 16px 24px;
                        "
                    >
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                            style="border-radius: 10px; padding: 10px 20px"
                        >
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button
                            type="button"
                            class="btn btn-primary"
                            onclick="saveEditedAppointment()"
                            style="
                                border-radius: 10px;
                                padding: 10px 20px;
                                background: var(--warning-color);
                                border: none;
                            "
                        >
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Add Client Modal -->
        <div class="modal fade" id="quickAddClientModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div
                    class="modal-content"
                    style="
                        border-radius: 16px;
                        border: none;
                        box-shadow: var(--shadow-xl);
                    "
                >
                    <div
                        class="modal-header"
                        style="
                            border-bottom: 2px solid var(--border-color);
                            padding: 20px 24px;
                        "
                    >
                        <h5
                            class="modal-title"
                            style="font-weight: 700; font-size: 18px"
                        >
                            <i
                                class="fas fa-user-plus me-2"
                                style="color: var(--primary-color)"
                            ></i
                            >Quick Add New Client
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                        ></button>
                    </div>
                    <div class="modal-body" style="padding: 24px">
                        <form id="quickAddClientForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i
                                            class="fas fa-user me-2"
                                            style="color: var(--primary-color)"
                                        ></i
                                        >First Name *
                                    </label>
                                    <input
                                        type="text"
                                        id="quickFirstName"
                                        class="form-control"
                                        required
                                        style="
                                            border-radius: 10px;
                                            padding: 12px;
                                        "
                                    />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold">
                                        <i
                                            class="fas fa-user me-2"
                                            style="color: var(--primary-color)"
                                        ></i
                                        >Last Name *
                                    </label>
                                    <input
                                        type="text"
                                        id="quickLastName"
                                        class="form-control"
                                        required
                                        style="
                                            border-radius: 10px;
                                            padding: 12px;
                                        "
                                    />
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-phone me-2"
                                        style="color: var(--primary-color)"
                                    ></i
                                    >Phone Number *
                                </label>
                                <input
                                    type="tel"
                                    id="quickPhone"
                                    class="form-control"
                                    required
                                    style="border-radius: 10px; padding: 12px"
                                />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-envelope me-2"
                                        style="color: var(--primary-color)"
                                    ></i
                                    >Email
                                </label>
                                <input
                                    type="email"
                                    id="quickEmail"
                                    class="form-control"
                                    style="border-radius: 10px; padding: 12px"
                                />
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-semibold">
                                    <i
                                        class="fas fa-venus-mars me-2"
                                        style="color: var(--primary-color)"
                                    ></i
                                    >Gender *
                                </label>
                                <select
                                    id="quickGender"
                                    class="form-select"
                                    required
                                    style="border-radius: 10px; padding: 12px"
                                >
                                    <option value="">Select gender...</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div
                        class="modal-footer"
                        style="
                            border-top: 2px solid var(--border-color);
                            padding: 16px 24px;
                        "
                    >
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                            style="border-radius: 10px; padding: 10px 20px"
                        >
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button
                            type="button"
                            class="btn btn-primary"
                            id="saveQuickClientBtn"
                            onclick="saveQuickClient()"
                            style="
                                border-radius: 10px;
                                padding: 10px 20px;
                                background: var(--primary-color);
                                border: none;
                            "
                        >
                            <i class="fas fa-save me-2"></i>Save Client
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <script>
            // ==========================================
            // GLOBAL VARIABLES & STATE
            // ==========================================
            let selectedAppointmentId = null;
            const currentDate = "{{ today }}";
            let bookingsData = [];
            let appointmentCounter = 1;

            // ==========================================
            // TIME FORMAT CONVERSION - 12-HOUR AM/PM ONLY
            // ==========================================

            // Convert 24-hour time to 12-hour AM/PM format
            function convertTo12Hour(time24) {
                if (!time24) return '';

                const [hours, minutes] = time24.split(':');
                let hour = parseInt(hours);
                const ampm = hour >= 12 ? 'PM' : 'AM';

                hour = hour % 12 || 12;

                return `${hour}:${minutes} ${ampm}`;
            }

            // Convert 12-hour AM/PM time to 24-hour format
            function convertTo24Hour(time12, ampm) {
                let [hours, minutes] = time12.split(':');
                hours = parseInt(hours);

                if (ampm === 'PM' && hours !== 12) {
                    hours += 12;
                } else if (ampm === 'AM' && hours === 12) {
                    hours = 0;
                }

                return `${hours.toString().padStart(2, '0')}:${minutes}`;
            }

            // Validate time input (HH:MM format with proper ranges)
            function validateTimeInput(timeStr, ampm) {
                // Regex: H:MM or HH:MM format
                const timeRegex = /^([0-9]|0[0-9]|1[0-2]):([0-5][0-9])$/;

                if (!timeRegex.test(timeStr)) {
                    return { valid: false, error: 'Invalid time format. Use HH:MM (e.g., 2:30)' };
                }

                const [hours, minutes] = timeStr.split(':').map(Number);

                // Validate hours (1-12 for 12-hour format)
                if (hours < 1 || hours > 12) {
                    return { valid: false, error: 'Hours must be between 1 and 12' };
                }

                // Validate minutes (0-59)
                if (minutes < 0 || minutes > 59) {
                    return { valid: false, error: 'Minutes must be between 0 and 59' };
                }

                // Validate AM/PM
                if (ampm !== 'AM' && ampm !== 'PM') {
                    return { valid: false, error: 'Please specify AM or PM' };
                }

                return { valid: true };
            }

            // Populate time dropdown with 15-minute intervals
            function populateTimeOptions(selectElement, startHour = 9, endHour = 21, selectedTime = '09:00') {
                selectElement.innerHTML = '';

                for (let hour = startHour; hour <= endHour; hour++) {
                    for (let minute = 0; minute < 60; minute += 15) {
                        const time24 = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        const time12 = convertTo12Hour(time24);
                        const option = document.createElement('option');
                        option.value = time24;
                        option.textContent = time12;
                        if (time24 === selectedTime) {
                            option.selected = true;
                        }
                        selectElement.appendChild(option);
                    }
                }
            }


            // ==========================================
            // INITIALIZATION
            // ==========================================
            document.addEventListener("DOMContentLoaded", function() {
                initializeApp();
                setupEventListeners();
                setupTooltips();
                setupScrollSync();
                initializeSearchableDropdowns();
            });

            function initializeApp() {
                loadBookings();
                loadShiftSchedule();
                updateCurrentTimeLine();
                setInterval(updateCurrentTimeLine, 60000);

                // Close context menu on click outside
                document.addEventListener("click", hideContextMenu);

                // Keyboard shortcuts
                document.addEventListener("keydown", function(e) {
                    if (e.key === "r" && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        refreshSchedule();
                    }
                });

                // Initialize context menu
                setTimeout(() => {
                    if (window.appointmentContextMenu?.reinitializeForAppointments) {
                        window.appointmentContextMenu.reinitializeForAppointments();
                    }
                }, 100);
            }

            // ==========================================
            // EVENT LISTENERS
            // ==========================================
            function setupEventListeners() {
                // Handle Quick Add Client modal z-index on show
                const quickAddModal = document.getElementById('quickAddClientModal');
                if (quickAddModal) {
                    quickAddModal.addEventListener('show.bs.modal', function() {
                        this.style.zIndex = '1065';
                        setTimeout(() => {
                            const backdrops = document.querySelectorAll('.modal-backdrop');
                            if (backdrops.length > 0) {
                                backdrops[backdrops.length - 1].style.zIndex = '1060';
                            }
                        }, 50);
                    });

                }

                // Edit modal changes
                const editServiceSelect = document.getElementById('editServiceSelect');
                const editStartTime = document.getElementById('editStartTime');
                if (editServiceSelect) editServiceSelect.addEventListener('change', calculateEditEndTime);
                if (editStartTime) editStartTime.addEventListener('change', calculateEditEndTime);
            }

            function setupTooltips() {
                const tooltip = document.getElementById("tooltip");
                document.querySelectorAll("[data-tooltip]").forEach(element => {
                    element.addEventListener("mouseenter", function(e) {
                        tooltip.textContent = this.getAttribute("data-tooltip");
                        tooltip.classList.add("show");
                        const rect = this.getBoundingClientRect();
                        tooltip.style.left = rect.left + rect.width / 2 - tooltip.offsetWidth / 2 + "px";
                        tooltip.style.top = rect.bottom + 8 + "px";
                    });
                    element.addEventListener("mouseleave", () => tooltip.classList.remove("show"));
                });
            }

            function setupScrollSync() {
                const panel = document.querySelector(".timeline-panel");
                const staff = document.querySelector(".staff-sidebar");
                const headerInner = document.getElementById("timelineHeaderInner");

                if (!panel || !staff || !headerInner) return;

                let syncingFromPanel = false;
                let syncingFromStaff = false;

                panel.addEventListener("scroll", () => {
                    if (!syncingFromStaff) {
                        syncingFromPanel = true;
                        staff.scrollTop = panel.scrollTop;
                    }
                    syncingFromStaff = false;
                    headerInner.style.transform = `translateX(-${panel.scrollLeft}px)`;
                }, { passive: true });

                staff.addEventListener("scroll", () => {
                    if (!syncingFromPanel) {
                        syncingFromStaff = true;
                        panel.scrollTop = staff.scrollTop;
                    }
                    syncingFromPanel = false;
                }, { passive: true });
            }

            function initializeSearchableDropdowns() {
                if (typeof $.fn.select2 !== 'undefined') {
                    // Destroy existing Select2 instances first
                    $('.select2-dropdown.select2-hidden-accessible').select2('destroy');

                    // Initialize Select2 for edit modal
                    $('.select2-dropdown').select2({
                        width: '100%',
                        placeholder: function() {
                            return $(this).find('option:first').text();
                        },
                        allowClear: true
                    });
                }
            }
            // ==========================================
            // DATA LOADING
            // ==========================================
            function loadBookings() {
                showLoading(true);
                fetch("/api/unaki/get-bookings?date=" + currentDate)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Filter out cancelled appointments
                            bookingsData = (data.bookings || []).filter(b => b.status !== "cancelled");
                            renderBookings();
                            updateStats();
                        } else {
                            showNotification("Failed to load bookings: " + data.error, "error");
                        }
                    })
                    .catch(error => {
                        console.error("Error loading bookings:", error);
                        showNotification("An error occurred while loading bookings.", "error");
                    })
                    .finally(() => showLoading(false));
            }

            function loadShiftSchedule() {
                fetch("/api/unaki/schedule?date=" + currentDate)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            renderShiftOverlays(data.staff);
                        }
                    })
                    .catch(error => console.error('Error loading shift schedule:', error));
            }

            function loadCustomerExistingAppointments(customerId) {
                const container = document.getElementById('customerExistingAppointments');
                const listDiv = document.getElementById('customerAppointmentsList');
                const countBadge = document.getElementById('customerAppointmentsCount');

                if (!customerId) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';
                listDiv.innerHTML = '<small class="text-muted"><i class="fas fa-spinner fa-spin me-1"></i>Loading...</small>';

                fetch(`/api/unaki/customer-appointments/${customerId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.bookings?.length > 0) {
                            countBadge.textContent = data.bookings.length;
                            displayCustomerAppointments(data.bookings);
                        } else {
                            countBadge.textContent = '0';
                            listDiv.innerHTML = '<small class="text-muted"><i class="fas fa-info-circle me-1"></i>No upcoming appointments</small>';
                        }
                    })
                    .catch(err => {
                        console.error('Error loading customer appointments:', err);
                        listDiv.innerHTML = '<small class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Error loading appointments</small>';
                    });
            }

            function displayCustomerAppointments(appointments) {
                const listDiv = document.getElementById('customerAppointmentsList');
                let html = '<div class="list-group list-group-flush">';

                appointments.forEach(apt => {
                    const date = new Date(apt.appointment_date);
                    const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    const statusColor = apt.status === 'confirmed' ? 'success' : apt.status === 'scheduled' ? 'primary' : 'secondary';

                    html += `
                        <div class="list-group-item px-2 py-2" style="border: none; border-bottom: 1px solid #eee;">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="fw-semibold" style="font-size: 0.9rem;">
                                        <i class="fas fa-spa me-1" style="color: var(--primary-color);"></i>${apt.service_names || apt.service_name || 'Service'}
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar me-1"></i>${formattedDate}
                                        <i class="fas fa-clock ms-2 me-1"></i>${apt.start_time} - ${apt.end_time}
                                    </small>
                                    <br>
                                    <small class="text-muted"><i class="fas fa-user-nurse me-1"></i>${apt.staff_name}</small>
                                </div>
                                <span class="badge bg-${statusColor}" style="font-size: 0.7rem;">${apt.status}</span>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                listDiv.innerHTML = html;
            }

            // ==========================================
            // RENDERING
            // ==========================================
            function renderBookings() {
                console.log('📋 Rendering bookings:', bookingsData.length);

                // Clear existing appointments
                document.querySelectorAll('.appointment-block').forEach(block => block.remove());

                // Show all bookings (including paid ones)
                const visibleBookings = bookingsData;
                console.log(`📊 Rendering ${visibleBookings.length} bookings`);

                // Render each booking
                visibleBookings.forEach(booking => {
                    const row = document.querySelector(`.timeline-row[data-staff-id="${booking.staff_id}"]`);
                    if (!row) return;

                    const startHour = parseFloat(booking.start_hour);
                    const startMinute = parseFloat(booking.start_minute);
                    const hoursSince9AM = startHour - 9 + startMinute / 60;
                    const leftPosition = hoursSince9AM * 140;
                    
                    // Calculate actual duration from start_time and end_time
                    let durationMinutes = booking.duration; // Default fallback
                    if (booking.start_time && booking.end_time) {
                        const [startH, startM] = booking.start_time.split(':').map(Number);
                        const [endH, endM] = booking.end_time.split(':').map(Number);
                        durationMinutes = (endH * 60 + endM) - (startH * 60 + startM);
                        console.log(`⏱️ Calculated duration for ${booking.client_name}: ${booking.start_time} to ${booking.end_time} = ${durationMinutes} minutes (was ${booking.duration})`);
                    }
                    const durationHours = durationMinutes / 60;
                    const width = Math.max(durationHours * 140, 80);
                    const serviceType = booking.service_type || "default";

                    const block = document.createElement("div");
                    // Add 'paid' class if payment status is 'paid' or 'success'
                    const isPaid = booking.payment_status === 'paid' || booking.payment_status === 'success';
                    block.className = `appointment-block service-${serviceType}${isPaid ? ' paid' : ''}`;
                    block.style.left = `${leftPosition}px`;
                    block.style.width = `${width}px`;
                    block.dataset.appointmentId = booking.id;
                    block.draggable = true;

                    block.innerHTML = `
                        <div class="appointment-header">
                            <div class="appointment-client">${booking.client_name}</div>
                            <div class="appointment-status"></div>
                        </div>
                        <div class="appointment-service">${booking.service_names || booking.service_name || 'Service'}</div>
                        <div class="appointment-footer">
                            <div class="appointment-time">
                                <i class="fas fa-clock"></i>${booking.start_time}
                            </div>
                            <div class="appointment-duration">${durationMinutes}m</div>
                        </div>
                    `;

                    row.appendChild(block);
                });

                // Reinitialize context menu
                if (window.appointmentContextMenu?.reinitializeForAppointments) {
                    window.appointmentContextMenu.reinitializeForAppointments();
                }
            }

            function renderShiftOverlays(staffData) {
                document.querySelectorAll(".shift-overlay").forEach(el => el.remove());
                if (!staffData?.length) return;

                staffData.forEach(staff => {
                    const row = document.querySelector(`.timeline-row[data-staff-id="${staff.id}"]`);
                    if (!row) return;

                    const timeToPosition = (timeStr) => {
                        if (!timeStr) return 0;
                        const [hours, minutes] = timeStr.split(':').map(Number);
                        return (hours - 9 + minutes / 60) * 140;
                    };

                    const calculateWidth = (startTime, endTime) => {
                        if (!startTime || !endTime) return 0;
                        const [startH, startM] = startTime.split(':').map(Number);
                        const [endH, endM] = endTime.split(':').map(Number);
                        return Math.max(0, ((endH * 60 + endM) - (startH * 60 + startM)) / 60 * 140);
                    };

                    const createOverlay = (type, left, width, label) => {
                        const overlay = document.createElement('div');
                        overlay.className = `shift-overlay shift-overlay-${type}`;
                        overlay.style.left = `${left}px`;
                        overlay.style.width = `${width}px`;
                        overlay.innerHTML = `<span class="overlay-label">${label}</span>`;
                        return overlay;
                    };

                    // Holiday/Off-day overlays
                    const HOLIDAY_STATUSES = ['holiday'];
                    const OFFDAY_STATUSES = ['off', 'absent', 'leave', 'weekoff', 'not_scheduled', 'offday'];

                    if (staff.day_status && HOLIDAY_STATUSES.includes(staff.day_status)) {
                        row.appendChild(createOverlay('holiday', 0, 13 * 140, 'Holiday'));
                        return;
                    }

                    if (!staff.is_working || !staff.shift_start || !staff.shift_end ||
                        (staff.day_status && OFFDAY_STATUSES.includes(staff.day_status))) {
                        row.appendChild(createOverlay('off-duty', 0, 13 * 140, 'Off Day'));
                        return;
                    }

                    // Before/After shift overlays
                    if (staff.shift_start && staff.shift_start !== '09:00') {
                        const width = timeToPosition(staff.shift_start);
                        if (width > 0) row.appendChild(createOverlay('off-duty', 0, width, 'Before Shift'));
                    }

                    if (staff.shift_end && staff.shift_end !== '22:00') {
                        const left = timeToPosition(staff.shift_end);
                        const width = 13 * 140 - left;
                        if (width > 0) row.appendChild(createOverlay('off-duty', left, width, 'After Shift'));
                    }

                    // Break overlays
                    if (staff.breaks?.length) {
                        staff.breaks.forEach(breakTime => {
                            if (breakTime?.start && breakTime?.end) {
                                const left = timeToPosition(breakTime.start);
                                const width = calculateWidth(breakTime.start, breakTime.end);
                                if (width > 0) row.appendChild(createOverlay('break', left, width, 'Break Time'));
                            }
                        });
                    }

                    // Out-of-office overlays
                    if (staff.ooo?.length) {
                        staff.ooo.forEach(oooTime => {
                            if (oooTime?.start && oooTime?.end) {
                                const left = timeToPosition(oooTime.start);
                                const width = calculateWidth(oooTime.start, oooTime.end);
                                if (width > 0) {
                                    const overlay = createOverlay('out-of-office', left, width, oooTime.reason || 'Out of Office');
                                    if (oooTime.reason) overlay.title = oooTime.reason;
                                    row.appendChild(overlay);
                                }
                            }
                        });
                    }
                });
            }

            function updateStats() {
                const total = bookingsData.length;
                const completed = bookingsData.filter(b => b.status === 'completed').length;
                const paid = bookingsData.filter(b => b.payment_status === 'paid').length;
                const pending = bookingsData.filter(b => b.payment_status === 'pending').length;

                document.getElementById('totalBookings').textContent = total;
                document.getElementById('completedBookings').textContent = completed;

                // Log payment status breakdown
                console.log(`📊 Stats Update:
                    Total: ${total}
                    Completed: ${completed}
                    Paid (hidden): ${paid}
                    Pending (visible): ${pending}
                `);
            }

            function updateCurrentTimeLine() {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                if (currentHour >= 9 && currentHour < 22) {
                    const timeLine = document.getElementById("currentTimeLine");
                    const timeLabel = document.getElementById("currentTimeLabel");
                    const hoursSince9AM = currentHour - 9;
                    const leftPosition = (hoursSince9AM + currentMinute / 60) * 140;

                    timeLabel.textContent = now.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", hour12: true });
                    timeLine.style.left = leftPosition + "px";
                    timeLine.style.display = "block";
                } else {
                    document.getElementById("currentTimeLine").style.display = "none";
                }
            }

            // ==========================================
            // QUICK ADD CLIENT
            // ==========================================
            function openQuickAddClient() {
                const modalEl = document.getElementById("quickAddClientModal");
                const modal = new bootstrap.Modal(modalEl, {
                    backdrop: 'static',
                    keyboard: true
                });
                document.getElementById('quickAddClientForm').reset();
                modal.show();

                // Ensure proper z-index stacking
                setTimeout(() => {
                    if (modalEl) {
                        modalEl.style.zIndex = '1065';
                    }
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    if (backdrops.length > 0) {
                        backdrops[backdrops.length - 1].style.zIndex = '1060';
                    }
                }, 100);
            }

            async function saveQuickClient() {
                console.log('🔵 saveQuickClient() called');

                // Get form values
                const firstName = document.getElementById('quickFirstName').value.trim();
                const lastName = document.getElementById('quickLastName').value.trim();
                const phone = document.getElementById('quickPhone').value.trim();
                const email = document.getElementById('quickEmail').value.trim();
                const gender = document.getElementById('quickGender').value;

                console.log('📋 Form values:', { firstName, lastName, phone, email, gender });

                // Validation
                if (!firstName || !lastName || !phone || !gender) {
                    console.error('❌ Validation failed - missing required fields');
                    showNotification('Please fill in all required fields (First Name, Last Name, Phone, Gender)', 'error');
                    return;
                }

                // Phone validation
                if (phone.length < 10) {
                    console.error('❌ Invalid phone number');
                    showNotification('Please enter a valid phone number (at least 10 digits)', 'error');
                    return;
                }

                console.log('✅ Validation passed');

                // Get save button by ID
                const submitBtn = document.getElementById('saveQuickClientBtn');

                if (!submitBtn) {
                    console.error('❌ Save button not found!');
                    return;
                }

                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

                const clientData = {
                    first_name: firstName,
                    last_name: lastName,
                    phone: phone,
                    email: email,
                    gender: gender,
                };

                console.log('📤 Sending data to API:', clientData);

                try {
                    const response = await fetch("/api/unaki/quick-add-client", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(clientData),
                    });

                    console.log('📥 Response status:', response.status);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log('📥 Response data:', result);

                    if (result.success) {
                        console.log('✅ Client saved successfully:', result.client);

                        showNotification(result.message || 'Client added successfully!', 'success');

                        // Close modal
                        const modalEl = document.getElementById('quickAddClientModal');
                        const modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) {
                            modal.hide();
                        }

                        quickAddForm.reset();
                    } else {
                        console.error('❌ Server returned error:', result.error);
                        showNotification(result.error || 'Failed to create client', 'error');
                    }
                } catch (error) {
                    console.error("❌ Error saving client:", error);
                    showNotification('Failed to create client: ' + error.message, 'error');
                } finally {
                    // Re-enable submit button
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                    console.log('🔵 saveQuickClient() completed');
                }
            }



            // ==========================================
            // NAVIGATION FUNCTIONS
            // ==========================================
            function navigateDate(days) {
                const date = new Date(currentDate);
                date.setDate(date.getDate() + days);
                window.location.href = `{{ url_for('unaki_booking') }}?date=${date.toISOString().split("T")[0]}`;
            }

            function navigateToToday() {
                window.location.href = `{{ url_for('unaki_booking') }}?date=${new Date().toISOString().split("T")[0]}`;
            }

            function refreshSchedule() {
                loadBookings();
                loadShiftSchedule();
                const btn = event.target.closest(".action-icon");
                if (btn) {
                    btn.style.transform = "rotate(360deg)";
                    setTimeout(() => btn.style.transform = "rotate(0deg)", 600);
                }
            }

            // Handle empty slot clicks - redirect to multi-appointment booking page
            function handleSlotClick(event, staffId, hour, minute) {
                event.preventDefault();
                event.stopPropagation();

                const selectedDate = currentDate;
                const startTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;

                // Redirect to multi-appointment booking page with pre-filled data
                window.location.href = `/multi-appointment-booking?date=${selectedDate}&staff_id=${staffId}&time=${startTime}`;
            }

            function showLoading(show) {
                document.getElementById("loadingOverlay").classList.toggle("show", show);
            }

            function showNotification(message, type) {
                // Replace this with your actual toast implementation if available
                // For now, using alert for simplicity.
                alert(message);
            }

            function hideContextMenu() {
                if (window.appointmentContextMenu) {
                    window.appointmentContextMenu.hideContextMenu();
                }
            }

            function viewAppointmentDetails() {
                if (selectedAppointmentId && window.appointmentContextMenu) {
                    window.appointmentContextMenu.viewAppointment(selectedAppointmentId);
                }
            }

            function editAppointment() {
                if (selectedAppointmentId && window.appointmentContextMenu?.editAppointment) {
                    window.appointmentContextMenu.editAppointment(selectedAppointmentId);
                }
                hideContextMenu();
            }

            function cancelAppointment() {
                if (selectedAppointmentId && confirm("Are you sure you want to cancel this appointment?")) {
                    // Implement cancellation logic here
                    alert("Cancel appointment " + selectedAppointmentId);
                }
                hideContextMenu();
            }

            function saveEditedAppointment() {
                const appointmentId = document.getElementById('editAppointmentId').value;
                const serviceSelect = document.getElementById('editServiceSelect');
                const serviceId = serviceSelect.value;
                const serviceName = serviceSelect.selectedOptions[0]?.text.split(' (')[0].trim();
                const staffId = document.getElementById('editStaffSelect').value;
                const appointmentDate = document.getElementById('editAppointmentDate').value;
                const startTime = document.getElementById('editStartTime').value;
                const endTime = document.getElementById('editEndTime').value;
                const notes = document.getElementById('editNotes').value;
                const status = document.getElementById('editStatus').value;
                const paymentStatus = document.getElementById('editPaymentStatus').value;

                if (!serviceId || !staffId || !appointmentDate || !startTime || !endTime) {
                    showToast('Please fill all required fields', 'error');
                    return;
                }

                const updateData = {
                    service_id: parseInt(serviceId),
                    service_name: serviceName,
                    staff_id: parseInt(staffId),
                    appointment_date: appointmentDate,
                    start_time: startTime,
                    end_time: endTime,
                    notes: notes,
                    status: status,
                    payment_status: paymentStatus
                };

                console.log('💾 Saving appointment with payment status:', paymentStatus, 'and status:', status);

                fetch(`/api/unaki/bookings/${appointmentId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                })
                .then(response => response.json())
                .then(data => {
                    console.log('✅ Update response:', data);
                    if (data.success) {
                        showToast(data.message || 'Appointment updated successfully', 'success');

                        // Show special message if payment status changed to paid and completed
                        if (paymentStatus === 'paid' && status === 'completed') {
                            showToast('Payment marked as paid. Appointment will be hidden from view.', 'info');
                            // Force page reload after 1 second to ensure UI updates
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        } else {
                            bootstrap.Modal.getInstance(document.getElementById('editAppointmentModal')).hide();
                            loadBookings();
                        }
                    } else {
                        showToast(data.error || 'Failed to update appointment', 'error');
                    }
                })
                .catch(error => {
                    console.error('❌ Error updating appointment:', error);
                    showToast('Error updating appointment', 'error');
                });
            }

            function showEditModal(appointmentData) {
                console.log('✏️ Showing edit appointment modal:', appointmentData);

                // Populate form fields
                document.getElementById('editAppointmentId').value = appointmentData.id;
                document.getElementById('editClientName').value = appointmentData.client_name;
                document.getElementById('editAppointmentDate').value = appointmentData.appointment_date;
                document.getElementById('editStartTime').value = appointmentData.start_time;
                document.getElementById('editEndTime').value = appointmentData.end_time;
                document.getElementById('editNotes').value = appointmentData.notes || '';

                // Set service dropdown
                const serviceSelect = document.getElementById('editServiceSelect');
                if (appointmentData.service_id) {
                    serviceSelect.value = appointmentData.service_id;
                    // Trigger change event to ensure end time is calculated if needed
                    serviceSelect.dispatchEvent(new Event('change'));
                }

                // Set staff dropdown
                const staffSelect = document.getElementById('editStaffSelect');
                staffSelect.value = appointmentData.staff_id;

                // Set status dropdown
                const statusSelect = document.getElementById('editStatus');
                statusSelect.value = appointmentData.status || 'scheduled';

                // Set payment status dropdown
                const paymentStatusSelect = document.getElementById('editPaymentStatus');
                paymentStatusSelect.value = appointmentData.payment_status || 'pending';

                // Show modal
                const editModal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
                editModal.show();

                // Update end time when service changes
                serviceSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const duration = parseInt(selectedOption.dataset.duration) || 60;
                    const startTime = document.getElementById('editStartTime').value;

                    if (startTime) {
                        const endTime = calculateEndTimeFromDuration(startTime, duration);
                        document.getElementById('editEndTime').value = endTime;
                    }
                });

                // Update end time when start time changes
                document.getElementById('editStartTime').addEventListener('change', function() {
                    const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
                    const duration = parseInt(selectedOption.dataset.duration) || 60;
                    const endTime = calculateEndTimeFromDuration(this.value, duration);
                    document.getElementById('editEndTime').value = endTime;
                });
            }

            // Helper function to calculate end time based on start time and duration
            function calculateEndTimeFromDuration(startTime, durationMinutes) {
                const [hours, minutes] = startTime.split(':').map(Number);
                const startDate = new Date();
                startDate.setHours(hours, minutes, 0, 0);
                const endDate = new Date(startDate.getTime() + durationMinutes * 60000);
                return endDate.toTimeString().slice(0, 5);
            }

            // Helper function to show toast notifications (if you have a toast library integrated)
            function showToast(message, type = 'info') {
                // Replace this with your actual toast implementation
                console.log(`Toast (${type}): ${message}`);
                alert(`${type.toUpperCase()}: ${message}`);
            }

        </script>
    </body>
</html>