
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unaki Appointment Booking - Professional Spa Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
        }

        .schedule-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .schedule-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 32px 64px -12px rgba(0, 0, 0, 0.35);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 220px repeat(8, 1fr);
            border: none;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .time-header, .staff-cell, .time-slot {
            border: 1px solid rgba(226, 232, 240, 0.6);
            padding: 16px 12px;
            text-align: center;
            position: relative;
            transition: all 0.2s ease;
        }

        .time-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            font-weight: 600;
            font-size: 13px;
            color: #475569;
            border-bottom: 2px solid #667eea;
            position: relative;
            overflow: hidden;
        }

        .time-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .staff-cell {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            text-align: left;
            font-weight: 600;
            border-right: 3px solid rgba(102, 126, 234, 0.3);
            position: relative;
            transition: all 0.3s ease;
        }

        .staff-cell:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transform: translateX(2px);
        }

        .staff-name {
            font-size: 15px;
            color: #212529;
            margin-bottom: 2px;
        }

        .staff-role {
            font-size: 12px;
            color: #6c757d;
            font-weight: normal;
        }

        .time-slot {
            min-height: 70px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 6px;
            margin: 1px;
        }

        .time-slot:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .time-slot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .time-slot:hover::before {
            opacity: 1;
        }

        .appointment-block {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 13px;
            line-height: 1.4;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            min-height: 66px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            position: relative;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .appointment-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .appointment-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            border-radius: 12px;
            z-index: -1;
        }

        .appointment-client {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .appointment-service {
            font-size: 11px;
            opacity: 0.9;
        }

        .break-block {
            background: #f59e0b;
            color: white;
            border-radius: 4px;
            padding: 6px 8px;
            font-size: 12px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: default;
            min-height: 56px;
            z-index: 10;
        }

        .drag-selection {
            position: absolute;
            background: rgba(37, 99, 235, 0.2);
            border: 2px dashed #2563eb;
            border-radius: 4px;
            z-index: 100;
            pointer-events: none;
        }

        .header-controls {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            background: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-outline-secondary {
            border: 2px solid rgba(102, 126, 234, 0.3);
            color: #667eea;
            border-radius: 12px;
            padding: 10px 20px;
            transition: all 0.3s ease;
            background: white;
        }

        .btn-outline-secondary:hover {
            background: #667eea;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            border: none;
            padding: 24px;
        }

        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-control, .form-select {
            border-radius: 12px;
            border: 2px solid rgba(226, 232, 240, 0.8);
            padding: 12px 16px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .stats-row {
            padding: 24px 32px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
            position: relative;
        }

        .stats-row::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            border: 1px solid rgba(226, 232, 240, 0.6);
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .header-controls {
            padding: 32px;
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
            background: linear-gradient(135deg, white 0%, #f8fafc 100%);
            position: relative;
        }

        .header-controls::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-3"></div>
            <div class="text-muted fw-medium">Loading schedule data...</div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <div class="schedule-container">
                    <!-- Header Controls -->
                    <div class="header-controls">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-gradient-primary rounded-circle p-3 me-3 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                        <i class="fas fa-calendar-check text-white fa-lg"></i>
                                    </div>
                                    <div>
                                        <h2 class="h3 mb-1 fw-bold" style="color: #1e293b;">
                                            Unaki Appointment Booking
                                        </h2>
                                        <p class="text-muted mb-0 fw-medium">
                                            <i class="fas fa-hand-pointer me-2 text-primary"></i>
                                            Drag to select time slots and create appointments
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <div class="row g-3 justify-content-end">
                                    <div class="col-auto">
                                        <label class="form-label mb-2 d-block text-start fw-semibold">
                                            <i class="fas fa-calendar-day me-2 text-primary"></i>Select Date:
                                        </label>
                                        <div class="position-relative">
                                            <input type="date" id="scheduleDate" class="form-control ps-5" onchange="showLoadingAndLoad()">
                                            <i class="fas fa-calendar-alt position-absolute top-50 translate-middle-y ms-3 text-muted"></i>
                                        </div>
                                    </div>
                                    <div class="col-auto d-flex align-items-end gap-2">
                                        <button class="btn btn-outline-secondary" onclick="showLoadingAndRefresh()" title="Refresh Schedule">
                                            <i class="fas fa-sync-alt me-2"></i>
                                            <span class="d-none d-md-inline">Refresh</span>
                                        </button>
                                        <button class="btn btn-primary" onclick="showLoadingAndLoadSample()" title="Load Demo Data">
                                            <i class="fas fa-magic me-2"></i>
                                            <span class="d-none d-sm-inline">Demo Data</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Row -->
                    <div class="stats-row">
                        <div class="row">
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number" id="totalAppointments">0</div>
                                    <div class="stat-label">Appointments</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number" id="activeStaff">0</div>
                                    <div class="stat-label">Staff on Duty</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number" id="availableSlots">0</div>
                                    <div class="stat-label">Available Slots</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="stat-item">
                                    <div class="stat-number" id="utilizationRate">0%</div>
                                    <div class="stat-label">Utilization</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule Grid -->
                    <div id="scheduleGrid" class="schedule-grid">
                        <!-- Grid content will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-calendar-plus me-2"></i>
                        New Appointment
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bookingForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Client Name *</label>
                                    <input type="text" id="clientName" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" id="clientPhone" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Service *</label>
                                    <select id="serviceType" class="form-select" required>
                                        <option value="">Select Service</option>
                                        <option value="Deep Cleansing Facial">Deep Cleansing Facial</option>
                                        <option value="Swedish Massage">Swedish Massage</option>
                                        <option value="Hair Cut & Style">Hair Cut & Style</option>
                                        <option value="Classic Manicure">Classic Manicure</option>
                                        <option value="Pedicure">Pedicure</option>
                                        <option value="Waxing">Waxing</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Staff *</label>
                                    <select id="staffSelect" class="form-select" required></select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Start Time *</label>
                                    <input type="time" id="startTime" class="form-control" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Duration *</label>
                                    <select id="appointmentDuration" class="form-select" required onchange="updateEndTime()">
                                        <option value="30">30 minutes</option>
                                        <option value="45">45 minutes</option>
                                        <option value="60" selected>1 hour</option>
                                        <option value="90">1 hour 30 minutes</option>
                                        <option value="120">2 hours</option>
                                        <option value="150">2 hours 30 minutes</option>
                                        <option value="180">3 hours</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">End Time *</label>
                                    <input type="time" id="endTime" class="form-control" required readonly>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea id="appointmentNotes" class="form-control" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="bookAppointment()">Book Appointment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let scheduleData = {
            staff: [],
            appointments: [],
            breaks: []
        };

        let isDragging = false;
        let dragStart = null;
        let dragSelection = null;
        let currentDate = new Date().toISOString().split('T')[0];

        // Loading overlay functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showLoadingAndLoad() {
            showLoading();
            setTimeout(() => {
                loadScheduleForDate();
                hideLoading();
            }, 800);
        }

        function showLoadingAndRefresh() {
            showLoading();
            setTimeout(() => {
                refreshSchedule();
                hideLoading();
            }, 600);
        }

        function showLoadingAndLoadSample() {
            showLoading();
            setTimeout(() => {
                loadSampleData();
                hideLoading();
            }, 1000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showLoading();
            document.getElementById('scheduleDate').value = currentDate;
            
            setTimeout(() => {
                loadScheduleForDate();
                hideLoading();
            }, 1200);
            
            // Add event listener for start time changes
            document.getElementById('startTime').addEventListener('change', updateEndTime);
        });

        function generateTimeSlots() {
            const slots = [];
            for (let hour = 8; hour < 16; hour++) {
                const timeStr = `${hour.toString().padStart(2, '0')}:00`;
                let displayTime;
                if (hour <= 12) {
                    displayTime = `${hour}:00 AM`;
                } else {
                    displayTime = `${hour - 12}:00 PM`;
                }
                if (hour === 12) {
                    displayTime = '12:00 PM';
                }
                slots.push({ time: timeStr, display: displayTime });
            }
            return slots;
        }

        function loadScheduleForDate() {
            currentDate = document.getElementById('scheduleDate').value;
            
            // Try to load from localStorage or API
            const localData = localStorage.getItem(`schedule-${currentDate}`);
            if (localData) {
                scheduleData = JSON.parse(localData);
                renderSchedule();
                updateStats();
            } else {
                // Load empty schedule
                scheduleData = { staff: [], appointments: [], breaks: [] };
                renderSchedule();
                updateStats();
            }
        }

        function loadSampleData() {
            scheduleData = {
                staff: [
                    { id: 1, name: 'Sarah Johnson', role: 'Facial Specialist' },
                    { id: 2, name: 'Michael Chen', role: 'Massage Therapist' },
                    { id: 3, name: 'Emily Rodriguez', role: 'Hair Stylist' },
                    { id: 4, name: 'James Wilson', role: 'Nail Technician' },
                    { id: 5, name: 'Linda Davis', role: 'Makeup Artist' }
                ],
                appointments: [
                    // 1.5 hour appointments
                    { id: 1, staffId: 1, clientName: 'Jessica Brown', service: 'Deep Cleansing Facial', startTime: '09:00', endTime: '10:30', duration: 90 },
                    { id: 2, staffId: 2, clientName: 'Amanda White', service: 'Hot Stone Massage', startTime: '08:30', endTime: '10:00', duration: 90 },
                    { id: 3, staffId: 5, clientName: 'Linda Anderson', service: 'Hair Cut & Color', startTime: '10:30', endTime: '12:00', duration: 90 },
                    
                    // 2 hour appointments
                    { id: 4, staffId: 3, clientName: 'Maria Garcia', service: 'Full Hair Treatment', startTime: '13:00', endTime: '15:00', duration: 120 },
                    { id: 5, staffId: 1, clientName: 'Emma Thompson', service: 'Premium Facial Package', startTime: '11:00', endTime: '13:00', duration: 120 },
                    
                    // 45 minute appointments
                    { id: 6, staffId: 4, clientName: 'Robert Taylor', service: 'Express Manicure', startTime: '09:00', endTime: '09:45', duration: 45 },
                    { id: 7, staffId: 4, clientName: 'Sophie Miller', service: 'Quick Pedicure', startTime: '10:15', endTime: '11:00', duration: 45 },
                    
                    // 30 minute appointments
                    { id: 8, staffId: 2, clientName: 'David Brown', service: 'Consultation', startTime: '11:00', endTime: '11:30', duration: 30 },
                    { id: 9, staffId: 5, clientName: 'Kate Wilson', service: 'Eyebrow Shaping', startTime: '14:00', endTime: '14:30', duration: 30 }
                ],
                breaks: [
                    { id: 1, staffId: 2, startTime: '12:00', endTime: '12:30', reason: 'Lunch Break' },
                    { id: 2, staffId: 4, startTime: '14:00', endTime: '14:15', reason: 'Coffee Break' },
                    { id: 3, staffId: 1, startTime: '13:30', endTime: '14:00', reason: 'Lunch Break' },
                    { id: 4, staffId: 3, startTime: '12:00', endTime: '13:00', reason: 'Lunch Hour' }
                ]
            };

            // Save to localStorage
            localStorage.setItem(`schedule-${currentDate}`, JSON.stringify(scheduleData));
            
            renderSchedule();
            updateStats();
        }

        function renderSchedule() {
            const grid = document.getElementById('scheduleGrid');
            const timeSlots = generateTimeSlots();
            
            // Clear grid
            grid.innerHTML = '';
            
            // Create header row
            const emptyCorner = document.createElement('div');
            emptyCorner.className = 'time-header';
            emptyCorner.innerHTML = '<strong>Staff</strong>';
            grid.appendChild(emptyCorner);

            timeSlots.forEach(slot => {
                const timeHeader = document.createElement('div');
                timeHeader.className = 'time-header';
                timeHeader.textContent = slot.display;
                grid.appendChild(timeHeader);
            });

            // Create staff rows
            scheduleData.staff.forEach(staff => {
                // Staff name cell
                const staffCell = document.createElement('div');
                staffCell.className = 'staff-cell';
                staffCell.innerHTML = `
                    <div class="staff-name">${staff.name}</div>
                    <div class="staff-role">${staff.role}</div>
                `;
                grid.appendChild(staffCell);

                // Time slots for this staff member
                timeSlots.forEach((slot, slotIndex) => {
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    timeSlot.dataset.staffId = staff.id;
                    timeSlot.dataset.time = slot.time;
                    
                    // Check for appointments that start at this time
                    const appointment = scheduleData.appointments.find(apt => 
                        apt.staffId === staff.id && apt.startTime === slot.time
                    );
                    
                    // Check if this slot is occupied by an ongoing appointment
                    const ongoingAppointment = scheduleData.appointments.find(apt => {
                        if (apt.staffId !== staff.id) return false;
                        
                        const aptStartHour = parseInt(apt.startTime.split(':')[0]);
                        const aptStartMinute = parseInt(apt.startTime.split(':')[1]);
                        const aptEndHour = parseInt(apt.endTime.split(':')[0]);
                        const aptEndMinute = parseInt(apt.endTime.split(':')[1]);
                        
                        const slotHour = parseInt(slot.time.split(':')[0]);
                        const slotMinute = parseInt(slot.time.split(':')[1]);
                        
                        const aptStartTime = aptStartHour * 60 + aptStartMinute;
                        const aptEndTime = aptEndHour * 60 + aptEndMinute;
                        const slotTime = slotHour * 60 + slotMinute;
                        
                        return slotTime >= aptStartTime && slotTime < aptEndTime;
                    });
                    
                    // Check for breaks that start at this time
                    const breakItem = scheduleData.breaks.find(brk => 
                        brk.staffId === staff.id && brk.startTime === slot.time
                    );
                    
                    // Check if this slot is occupied by an ongoing break
                    const ongoingBreak = scheduleData.breaks.find(brk => {
                        if (brk.staffId !== staff.id) return false;
                        
                        const brkStartHour = parseInt(brk.startTime.split(':')[0]);
                        const brkStartMinute = parseInt(brk.startTime.split(':')[1]);
                        const brkEndHour = parseInt(brk.endTime.split(':')[0]);
                        const brkEndMinute = parseInt(brk.endTime.split(':')[1]);
                        
                        const slotHour = parseInt(slot.time.split(':')[0]);
                        const slotMinute = parseInt(slot.time.split(':')[1]);
                        
                        const brkStartTime = brkStartHour * 60 + brkStartMinute;
                        const brkEndTime = brkEndHour * 60 + brkEndMinute;
                        const slotTime = slotHour * 60 + slotMinute;
                        
                        return slotTime >= brkStartTime && slotTime < brkEndTime;
                    });

                    if (appointment) {
                        // Calculate span based on duration
                        const duration = appointment.duration || 60;
                        const durationText = duration >= 60 ? 
                            `${Math.floor(duration / 60)}h ${duration % 60 > 0 ? duration % 60 + 'm' : ''}`.trim() :
                            `${duration}m`;
                        
                        // Calculate the actual width based on exact duration in minutes
                        // Each time slot represents 60 minutes, so calculate percentage
                        let blockWidth = '100%';
                        
                        if (duration <= 60) {
                            // For appointments 60 minutes or less, calculate percentage of current slot
                            const widthPercentage = (duration / 60) * 100;
                            blockWidth = `${widthPercentage}%`;
                        } else {
                            // For appointments longer than 60 minutes, span multiple slots
                            const fullSlots = Math.floor(duration / 60);
                            const remainingMinutes = duration % 60;
                            const remainingPercentage = remainingMinutes > 0 ? (remainingMinutes / 60) * 100 : 0;
                            
                            if (remainingMinutes === 0) {
                                // Exact hour appointments (90min = 1.5 slots, 120min = 2 slots)
                                blockWidth = `calc(${fullSlots * 100}% + ${(fullSlots - 1)}px)`;
                            } else {
                                // Appointments with partial minutes (90min, 150min, etc.)
                                blockWidth = `calc(${(fullSlots * 100) + remainingPercentage}% + ${fullSlots}px)`;
                            }
                        }
                        
                        timeSlot.innerHTML = `
                            <div class="appointment-block" style="width: ${blockWidth}; z-index: 10; position: absolute; top: 2px; left: 2px; height: calc(100% - 4px);">
                                <div class="appointment-client">${appointment.clientName}</div>
                                <div class="appointment-service">${appointment.service}</div>
                                <div class="appointment-time" style="font-size: 10px; opacity: 0.9; font-weight: 600;">${appointment.startTime} - ${appointment.endTime}</div>
                                <div class="appointment-duration" style="font-size: 9px; opacity: 0.8;">${durationText}</div>
                            </div>
                        `;
                        
                        // Mark the time slot as having a starting appointment
                        timeSlot.dataset.hasAppointment = 'start';
                        
                    } else if (ongoingAppointment && !appointment) {
                        // This slot is part of an ongoing appointment - make it invisible but blocked
                        timeSlot.innerHTML = `
                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: transparent; cursor: not-allowed;"></div>
                        `;
                        timeSlot.dataset.hasAppointment = 'ongoing';
                        timeSlot.style.background = '#f8f9fa';
                        timeSlot.style.borderTop = 'none';
                        
                    } else if (breakItem) {
                        // Calculate break duration for spanning
                        const brkStartHour = parseInt(breakItem.startTime.split(':')[0]);
                        const brkStartMinute = parseInt(breakItem.startTime.split(':')[1]);
                        const brkEndHour = parseInt(breakItem.endTime.split(':')[0]);
                        const brkEndMinute = parseInt(breakItem.endTime.split(':')[1]);
                        
                        const brkStartTime = brkStartHour * 60 + brkStartMinute;
                        const brkEndTime = brkEndHour * 60 + brkEndMinute;
                        const breakDuration = brkEndTime - brkStartTime;
                        
                        // Calculate the actual width based on exact break duration in minutes
                        let breakWidth = '100%';
                        
                        if (breakDuration <= 60) {
                            // For breaks 60 minutes or less, calculate percentage of current slot
                            const widthPercentage = (breakDuration / 60) * 100;
                            breakWidth = `${widthPercentage}%`;
                        } else {
                            // For breaks longer than 60 minutes, span multiple slots
                            const fullSlots = Math.floor(breakDuration / 60);
                            const remainingMinutes = breakDuration % 60;
                            const remainingPercentage = remainingMinutes > 0 ? (remainingMinutes / 60) * 100 : 0;
                            
                            if (remainingMinutes === 0) {
                                // Exact hour breaks
                                breakWidth = `calc(${fullSlots * 100}% + ${(fullSlots - 1)}px)`;
                            } else {
                                // Breaks with partial minutes
                                breakWidth = `calc(${(fullSlots * 100) + remainingPercentage}% + ${fullSlots}px)`;
                            }
                        }
                        
                        timeSlot.innerHTML = `
                            <div class="break-block" style="width: ${breakWidth}; z-index: 10; position: absolute; top: 2px; left: 2px; height: calc(100% - 4px);">
                                <div><i class="fas fa-coffee me-1"></i>Break</div>
                                <div class="break-time" style="font-size: 9px; opacity: 0.9; margin-top: 2px;">${breakItem.startTime} - ${breakItem.endTime}</div>
                            </div>
                        `;
                        timeSlot.dataset.hasBreak = 'start';
                        
                    } else if (ongoingBreak && !breakItem) {
                        // This slot is part of an ongoing break - make it invisible but blocked
                        timeSlot.innerHTML = `
                            <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: transparent; cursor: not-allowed;"></div>
                        `;
                        timeSlot.dataset.hasBreak = 'ongoing';
                        timeSlot.style.background = '#fff3cd';
                        timeSlot.style.borderTop = 'none';
                    }
                    
                    grid.appendChild(timeSlot);
                });
            });

            setupDragHandlers();
        }

        function setupDragHandlers() {
            const timeSlots = document.querySelectorAll('.time-slot');
            
            timeSlots.forEach(slot => {
                slot.addEventListener('mousedown', handleMouseDown);
                slot.addEventListener('mouseenter', handleMouseEnter);
                slot.addEventListener('mouseup', handleMouseUp);
            });
        }

        function handleMouseDown(e) {
            if (e.target.closest('.appointment-block, .break-block')) return;
            
            isDragging = true;
            dragStart = {
                staffId: parseInt(e.currentTarget.dataset.staffId),
                time: e.currentTarget.dataset.time,
                element: e.currentTarget
            };
            
            e.currentTarget.style.background = 'rgba(37, 99, 235, 0.1)';
        }

        function handleMouseEnter(e) {
            if (!isDragging) return;
            
            const currentStaffId = parseInt(e.currentTarget.dataset.staffId);
            if (currentStaffId !== dragStart.staffId) return;
            
            // Highlight selection
            e.currentTarget.style.background = 'rgba(37, 99, 235, 0.1)';
        }

        function handleMouseUp(e) {
            if (!isDragging) return;
            
            isDragging = false;
            
            const endTime = e.currentTarget.dataset.time;
            const staffId = dragStart.staffId;
            
            // Clear highlights
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.style.background = '';
            });
            
            if (staffId && dragStart.time && endTime) {
                openBookingModal(staffId, dragStart.time, endTime);
            }
        }

        function openBookingModal(staffId, startTime, endTime) {
            const staff = scheduleData.staff.find(s => s.id === staffId);
            if (!staff) return;

            document.getElementById('startTime').value = startTime;
            document.getElementById('endTime').value = endTime;
            
            // Populate staff select
            const staffSelect = document.getElementById('staffSelect');
            staffSelect.innerHTML = '';
            scheduleData.staff.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `${s.name} (${s.role})`;
                option.selected = s.id === staffId;
                staffSelect.appendChild(option);
            });

            const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
            modal.show();
        }

        function updateEndTime() {
            const startTime = document.getElementById('startTime').value;
            const duration = parseInt(document.getElementById('appointmentDuration').value);
            
            if (startTime) {
                const [hours, minutes] = startTime.split(':').map(Number);
                const startMinutes = hours * 60 + minutes;
                const endMinutes = startMinutes + duration;
                
                const endHours = Math.floor(endMinutes / 60);
                const endMins = endMinutes % 60;
                
                const endTime = `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;
                document.getElementById('endTime').value = endTime;
            }
        }

        function bookAppointment() {
            const form = document.getElementById('bookingForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const duration = parseInt(document.getElementById('appointmentDuration').value);
            
            const newAppointment = {
                id: Date.now(),
                staffId: parseInt(document.getElementById('staffSelect').value),
                clientName: document.getElementById('clientName').value,
                service: document.getElementById('serviceType').value,
                startTime: document.getElementById('startTime').value,
                endTime: document.getElementById('endTime').value,
                duration: duration,
                phone: document.getElementById('clientPhone').value,
                notes: document.getElementById('appointmentNotes').value
            };

            scheduleData.appointments.push(newAppointment);
            localStorage.setItem(`schedule-${currentDate}`, JSON.stringify(scheduleData));
            
            // Clear form
            form.reset();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('bookingModal'));
            modal.hide();
            
            renderSchedule();
            updateStats();
        }

        function updateStats() {
            document.getElementById('totalAppointments').textContent = scheduleData.appointments.length;
            document.getElementById('activeStaff').textContent = scheduleData.staff.length;
            
            const totalSlots = scheduleData.staff.length * 8; // 8 time slots per staff
            const bookedSlots = scheduleData.appointments.length + scheduleData.breaks.length;
            const availableSlots = Math.max(0, totalSlots - bookedSlots);
            const utilization = totalSlots > 0 ? Math.round((bookedSlots / totalSlots) * 100) : 0;
            
            document.getElementById('availableSlots').textContent = availableSlots;
            document.getElementById('utilizationRate').textContent = utilization + '%';
        }

        function refreshSchedule() {
            loadScheduleForDate();
        }

        // Global mouse up handler to stop dragging
        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                document.querySelectorAll('.time-slot').forEach(slot => {
                    slot.style.background = '';
                });
            }
        });
    </script>
</body>
</html>
