{% extends "base.html" %}

{% block title %}Shift Scheduler - Management Suite{% endblock %}

{% block extra_head %}
<link href="{{ url_for('static', filename='css/shift_scheduler.css') }}" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="shift-scheduler-container">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-calendar-check me-2"></i>
                        Staff Shift Scheduler
                    </h2>
                    <p class="text-muted mb-0">
                        Manage staff schedules and shift assignments
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('shift_scheduler.add_shift_scheduler') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add Assign Shift
                    </a>
                </div>
            </div>
        </div>

        <!-- Clean Page 1: Shift Management View (as per wireframe) -->

        <!-- Schedule Management Table -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3><i class="fas fa-calendar-check me-2"></i>Schedule Management</h3>
            <div class="d-flex gap-2">
                <a href="{{ url_for('shift_scheduler.out_of_office_management') }}" class="btn btn-warning btn-sm">
                    <i class="fas fa-briefcase me-1"></i>Manage Out of Office
                </a>
                <button type="button" class="btn btn-secondary btn-sm" id="refreshSchedulesBtn">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-container" style="margin: 20px 0; padding: 0 20px;">
            <div class="input-group" style="max-width: 400px;">
                <span class="input-group-text" style="background: white; border-right: none;">
                    <i class="fas fa-search text-muted"></i>
                </span>
                <input
                    type="text"
                    id="staffSearchInput"
                    class="form-control"
                    placeholder="Search by staff name, schedule, or dates..."
                    style="border-left: none; padding-left: 0;"
                    onkeyup="filterSchedules()"
                />
                <button class="btn btn-outline-secondary" onclick="clearStaffSearch()" style="margin-left: 10px;">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>

        <!-- Schedule Management Table -->
        <div class="spa-table-container">
            <table class="spa-table" id="scheduleTable">
                <thead>
                    <tr>
                        <th width="5%" class="text-center">#</th>
                        <th width="18%">Staff Member</th>
                        <th width="12%">From Date</th>
                        <th width="12%">To Date</th>
                        <th width="13%">Office Days</th>
                        <th width="18%">Shift Times</th>
                        <th width="10%">Status</th>
                        <th width="12%" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="scheduleTableBody">
                    <!-- Dynamic rows will be inserted here -->
                </tbody>
            </table>
            <div class="text-center py-5" id="noSchedules" style="display: none;">
                <div class="text-muted">
                    <i class="fas fa-calendar-times fa-4x mb-4 text-secondary"></i>
                    <h5 class="text-secondary">No Schedules Found</h5>
                    <p class="mb-4">Get started by creating your first staff schedule</p>
                    <a href="{{ url_for('shift_scheduler.add_shift_scheduler') }}" class="btn btn-primary btn-lg hover-lift">
                        <i class="fas fa-plus-circle me-2"></i>Create Your First Schedule
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>




<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h6 class="mb-0">Processing your request...</h6>
                <small class="text-muted" id="loadingMessage">Please wait</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include the shift scheduler JavaScript -->
<script src="{{ url_for('static', filename='js/shift_scheduler.js') }}?v=3"></script>

<!-- Initialize the scheduler -->
<script>
$(document).ready(function() {
    console.log('New Shift Scheduler initialized');

    // Initialize date inputs with defaults
    const today = new Date();
    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

    $('#fromDate').val(today.toISOString().split('T')[0]);
    $('#toDate').val(nextWeek.toISOString().split('T')[0]);

    // Load existing schedules
    loadSchedules();

    // View database records
    function viewDatabase() {
        window.location.href = '/shift_scheduler/database';
    }

    // Filter schedules based on search input
    window.filterSchedules = function() {
        const searchInput = document.getElementById('staffSearchInput');
        if (!searchInput) {
            console.warn('Search input not found');
            return;
        }
        
        const filter = searchInput.value.toLowerCase().trim();
        const scheduleRows = document.querySelectorAll('#scheduleTableBody tr.schedule-row');

        scheduleRows.forEach(row => {
            const staffName = row.querySelector('td:nth-child(2) strong')?.textContent.toLowerCase() || '';
            const scheduleName = row.querySelector('td:nth-child(2) small')?.textContent.toLowerCase() || '';
            const fromDate = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
            const toDate = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
            const officeDays = row.querySelector('td:nth-child(5)')?.textContent.toLowerCase() || '';

            const matchesSearch = staffName.includes(filter) ||
                                 scheduleName.includes(filter) ||
                                 fromDate.includes(filter) ||
                                 toDate.includes(filter) ||
                                 officeDays.includes(filter);

            row.style.display = matchesSearch ? '' : 'none';
        });

        // Show "no results" message if no schedules match
        const visibleRows = Array.from(scheduleRows).filter(row => row.style.display !== 'none');
        const tbody = document.getElementById('scheduleTableBody');

        // Remove existing "no results" message
        const existingMessage = document.getElementById('noResultsMessage');
        if (existingMessage) {
            existingMessage.remove();
        }

        if (visibleRows.length === 0 && filter !== '') {
            const noResultsRow = document.createElement('tr');
            noResultsRow.id = 'noResultsMessage';
            noResultsRow.innerHTML = `
                <td colspan="8" class="text-center text-muted" style="padding: 40px 20px;">
                    <i class="fas fa-search fa-3x mb-3 d-block"></i>
                    <h5>No schedules found</h5>
                    <p>No schedules match your search "${filter}"</p>
                </td>
            `;
            tbody.appendChild(noResultsRow);
        }
    }

    // Clear search input and show all schedules
    window.clearStaffSearch = function() {
        const searchInput = document.getElementById('staffSearchInput');
        if (searchInput) {
            searchInput.value = '';
            filterSchedules();
        }
    }
});
</script>
{% endblock %}