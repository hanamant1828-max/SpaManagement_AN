{% extends "base.html" %}

{% block title %}Shift Scheduler - Management Suite{% endblock %}

{% block extra_head %}
<link href="{{ url_for('static', filename='css/shift_scheduler.css') }}" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="shift-scheduler-container">
    <div class="container-fluid">
        <!-- Enhanced Page Header -->
        <div class="page-header">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="mb-2">
                            <i class="fas fa-calendar-check me-3"></i>
                            Staff Shift Scheduler
                        </h1>
                        <p class="mb-0">
                            Professional scheduling management with streamlined add, edit, and view operations
                        </p>
                    </div>
                    <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                        <button type="button" class="btn btn-light btn-lg hover-lift" id="addShiftBtn">
                            <i class="fas fa-plus-circle me-2"></i>Add Assign Shift
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inline Shift Form Section (Hidden by default) -->
        <div class="card mb-4 fade-in" id="shiftFormSection" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center" id="formHeader">
                <h5 class="mb-0 d-flex align-items-center" id="formTitle">
                    <div class="bg-white bg-opacity-20 rounded-circle p-2 me-3">
                        <i class="fas fa-plus" id="formIcon"></i>
                    </div>
                    <span id="formTitleText">Add Shift</span>
                </h5>
                <button type="button" class="btn btn-outline-light btn-sm hover-lift" id="cancelFormBtn">
                    <i class="fas fa-times me-1"></i>Cancel
                </button>
            </div>
            <div class="card-body">
                <form id="shiftForm">
                    <!-- Hidden field for edit mode -->
                    <input type="hidden" id="editIndex" value="">
                    <input type="hidden" id="formMode" value="add">

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label for="staffSelect" class="form-label fw-bold">
                                <i class="fas fa-user me-1"></i>Staff Member
                            </label>
                            <select class="form-select" id="staffSelect" name="staff_member" required>
                                <option value="">Choose staff member...</option>
                                {% for staff in staff_members %}
                                    <option value="{{ staff.id }}" data-name="{{ staff.full_name }}">
                                        {{ staff.full_name }} - {{ staff.role }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label for="fromDate" class="form-label fw-bold">
                                <i class="fas fa-calendar me-1"></i>From Date
                            </label>
                            <input type="date" class="form-control" id="fromDate" name="from_date" required>
                        </div>

                        <div class="col-md-3">
                            <label for="toDate" class="form-label fw-bold">
                                <i class="fas fa-calendar me-1"></i>To Date
                            </label>
                            <input type="date" class="form-control" id="toDate" name="to_date" required>
                        </div>

                        <div class="col-md-4">
                            <label for="officeDays" class="form-label fw-bold">
                                <i class="fas fa-calendar-days me-1"></i>Office Days
                            </label>
                            <select class="form-select" id="officeDays" name="office_days" required>
                                <option value="">Select working days...</option>
                                <option value="Mon-Fri">Monday to Friday</option>
                                <option value="All">All Days</option>
                                <option value="Weekends">Weekends Only</option>
                                <option value="Custom">Custom Selection</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="startTime" class="form-label fw-bold">
                                <i class="fas fa-clock me-1"></i>Shift Start Time
                            </label>
                            <input type="time" class="form-control" id="startTime" name="start_time" value="09:00" required>
                        </div>

                        <div class="col-md-4">
                            <label for="endTime" class="form-label fw-bold">
                                <i class="fas fa-clock me-1"></i>Shift End Time
                            </label>
                            <input type="time" class="form-control" id="endTime" name="end_time" value="17:00" required>
                        </div>

                        <!-- Custom Days Selection (Hidden by default) -->
                        <div class="col-12" id="customDaysSection" style="display: none;">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar-week me-1"></i>Select Working Days
                            </label>
                            <div class="working-days-container">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="monday" name="working_days" value="monday">
                                    <label class="form-check-label" for="monday">Monday</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="tuesday" name="working_days" value="tuesday">
                                    <label class="form-check-label" for="tuesday">Tuesday</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="wednesday" name="working_days" value="wednesday">
                                    <label class="form-check-label" for="wednesday">Wednesday</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="thursday" name="working_days" value="thursday">
                                    <label class="form-check-label" for="thursday">Thursday</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="friday" name="working_days" value="friday">
                                    <label class="form-check-label" for="friday">Friday</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="saturday" name="working_days" value="saturday">
                                    <label class="form-check-label" for="saturday">Saturday</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="sunday" name="working_days" value="sunday">
                                    <label class="form-check-label" for="sunday">Sunday</label>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="breakTime" class="form-label fw-bold">
                                <i class="fas fa-coffee me-1"></i>Break Time
                            </label>
                            <input type="text" class="form-control" id="breakTime" name="break_time" 
                                   placeholder="e.g. 1 hr lunch" value="1 hour lunch">
                        </div>

                        <div class="col-md-6">
                            <label for="priority" class="form-label fw-bold">
                                <i class="fas fa-flag me-1"></i>Priority
                            </label>
                            <select class="form-select" id="priority" name="priority">
                                <option value="1">Normal</option>
                                <option value="2">High</option>
                                <option value="3">Critical</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <label for="description" class="form-label fw-bold">
                                <i class="fas fa-sticky-note me-1"></i>Description
                            </label>
                            <textarea class="form-control" id="description" name="description" rows="3" 
                                      placeholder="Optional notes about this shift schedule..."></textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-end gap-2 mt-4" id="formActions">
                        <button type="button" class="btn btn-secondary" id="cancelBtn">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="submit" class="btn btn-success" id="saveBtn">
                            <i class="fas fa-save me-2"></i>Save
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Schedule Management Table -->
        <div class="card slide-in" id="scheduleTableSection">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="bg-white bg-opacity-20 rounded-circle p-2 me-3">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">Schedule Management</h6>
                        <small class="text-white-50">
                            <span id="scheduleCount" class="count-badge">0</span>
                            schedules currently managed
                        </small>
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-light btn-sm hover-lift" id="refreshSchedulesBtn">
                        <i class="fas fa-sync-alt me-2"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0" id="scheduleTable">
                        <thead>
                            <tr>
                                <th width="5%" class="text-center">#</th>
                                <th width="20%">
                                    <i class="fas fa-user-tie me-2"></i>Staff Member
                                </th>
                                <th width="12%">
                                    <i class="fas fa-calendar-plus me-2"></i>From Date
                                </th>
                                <th width="12%">
                                    <i class="fas fa-calendar-minus me-2"></i>To Date
                                </th>
                                <th width="15%">
                                    <i class="fas fa-business-time me-2"></i>Office Days
                                </th>
                                <th width="15%">
                                    <i class="fas fa-clock me-2"></i>Shift Times
                                </th>
                                <th width="21%" class="text-center">
                                    <i class="fas fa-tools me-2"></i>Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                            <!-- Dynamic rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <div class="text-center py-5" id="noSchedules" style="display: none;">
                    <div class="text-muted">
                        <i class="fas fa-calendar-times fa-4x mb-4 text-secondary"></i>
                        <h5 class="text-secondary">No Schedules Found</h5>
                        <p class="mb-4">Get started by creating your first staff schedule</p>
                        <button type="button" class="btn btn-primary btn-lg hover-lift" onclick="openForm('add')">
                            <i class="fas fa-plus-circle me-2"></i>Create Your First Schedule
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h6 class="mb-0">Processing your request...</h6>
                <small class="text-muted" id="loadingMessage">Please wait</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Include the shift scheduler JavaScript -->
<script src="{{ url_for('static', filename='js/shift_scheduler.js') }}?v=3"></script>

<!-- Initialize the scheduler -->
<script>
$(document).ready(function() {
    console.log('New Shift Scheduler initialized');

    // Initialize date inputs with defaults
    const today = new Date();
    const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

    $('#fromDate').val(today.toISOString().split('T')[0]);
    $('#toDate').val(nextWeek.toISOString().split('T')[0]);

    // Load existing schedules
    loadSchedules();
});
</script>
{% endblock %}