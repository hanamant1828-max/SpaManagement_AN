
{% extends "base.html" %}

{% block title %}Customer Packages - Management Suite{% endblock %}

{% block extra_head %}
<link href="{{ url_for('static', filename='css/packages.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-gift text-primary me-2"></i>Customer Packages
                    </h1>
                    <p class="text-muted mb-0">Assign packages to customers, track usage, and manage remaining balance</p>
                </div>
                <button type="button" class="btn btn-primary" onclick="openAssignModal()">
                    <i class="fas fa-plus me-2"></i>Assign Package
                </button>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Search -->
                        <div class="col-md-4">
                            <label for="searchInput" class="form-label">Search</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="searchInput" 
                                       placeholder="Search by customer name or package...">
                            </div>
                        </div>
                        
                        <!-- Status Filter -->
                        <div class="col-md-2">
                            <label for="statusFilter" class="form-label">Status</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="expired">Expired</option>
                                <option value="paused">Paused</option>
                            </select>
                        </div>
                        
                        <!-- Date Range -->
                        <div class="col-md-2">
                            <label for="dateFrom" class="form-label">From Date</label>
                            <input type="date" class="form-control" id="dateFrom">
                        </div>
                        <div class="col-md-2">
                            <label for="dateTo" class="form-label">To Date</label>
                            <input type="date" class="form-control" id="dateTo">
                        </div>
                        
                        <!-- Actions -->
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="clearFilters()">
                                <i class="fas fa-times"></i>
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="applyFilters()">
                                <i class="fas fa-filter me-1"></i>Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Packages Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Customer</th>
                                    <th>Package</th>
                                    <th>Assigned/Expires</th>
                                    <th>Total</th>
                                    <th>Used</th>
                                    <th>Remaining</th>
                                    <th>Progress</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="packagesTableBody">
                                <!-- Dynamic content will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="paginationInfo" class="text-muted">
                            <!-- Pagination info will be displayed here -->
                        </div>
                        <nav>
                            <ul class="pagination mb-0" id="paginationControls">
                                <!-- Pagination controls will be displayed here -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assign Package Modal -->
<div class="modal fade" id="assignPackageModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-gift text-primary me-2"></i>Assign Package to Customer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignPackageForm">
                    <div class="row g-3">
                        <!-- Customer Selection -->
                        <div class="col-md-6">
                            <label for="assignCustomer" class="form-label">Customer *</label>
                            <select class="form-select" id="assignCustomer" required>
                                <option value="">Select customer...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a customer.
                            </div>
                        </div>
                        
                        <!-- Package Template -->
                        <div class="col-md-6">
                            <label for="assignPackage" class="form-label">Package Template *</label>
                            <select class="form-select" id="assignPackage" required>
                                <option value="">Select package...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a package template.
                            </div>
                        </div>
                        
                        <!-- Price Paid -->
                        <div class="col-md-4">
                            <label for="assignPrice" class="form-label">Price Paid *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="assignPrice" 
                                       step="0.01" min="0" required>
                            </div>
                            <div class="invalid-feedback">
                                Please enter a valid price.
                            </div>
                        </div>
                        
                        <!-- Discount -->
                        <div class="col-md-4">
                            <label for="assignDiscount" class="form-label">Discount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="assignDiscount" 
                                       step="0.01" min="0" value="0">
                            </div>
                        </div>
                        
                        <!-- Expires On -->
                        <div class="col-md-4">
                            <label for="assignExpires" class="form-label">Expires On</label>
                            <input type="date" class="form-control" id="assignExpires">
                            <div class="form-text">Leave blank for no expiry</div>
                        </div>
                        
                        <!-- Notes -->
                        <div class="col-12">
                            <label for="assignNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="assignNotes" rows="3" 
                                      placeholder="Additional notes about this package assignment..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Package Preview -->
                    <div id="packagePreview" class="mt-4" style="display: none;">
                        <h6 class="text-muted">Package Components:</h6>
                        <div id="packageItems" class="row g-2">
                            <!-- Package items will be displayed here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAssignPackage" disabled>
                    <i class="fas fa-save me-2"></i>Save Assignment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Package Details Modal -->
<div class="modal fade" id="packageDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle text-primary me-2"></i>Package Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Header Summary -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <strong>Customer:</strong><br>
                                        <span id="detailCustomerName"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Package:</strong><br>
                                        <span id="detailPackageName"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Price Paid:</strong><br>
                                        ₹<span id="detailPrice"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Status:</strong><br>
                                        <span id="detailStatus" class="badge"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Assigned:</strong><br>
                                        <span id="detailAssigned"></span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <strong>Expires:</strong> <span id="detailExpires"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Per-Service Items -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Service Breakdown:</h6>
                        <div id="serviceItems" class="row g-2">
                            <!-- Service items will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Recent Usage -->
                <div class="row">
                    <div class="col-12">
                        <h6>Recent Usage:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Service</th>
                                        <th>Qty</th>
                                        <th>Type</th>
                                        <th>Staff</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="recentUsageTable">
                                    <!-- Recent usage will be displayed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="openUseModal()">
                    <i class="fas fa-play me-2"></i>Record Usage
                </button>
                <button type="button" class="btn btn-warning" onclick="openAdjustModal()">
                    <i class="fas fa-edit me-2"></i>Adjust/Refund
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Record Usage Modal -->
<div class="modal fade" id="recordUsageModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-play text-success me-2"></i>Record Usage
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="recordUsageForm">
                    <div class="row g-3">
                        <!-- Service -->
                        <div class="col-12">
                            <label for="usageService" class="form-label">Service *</label>
                            <select class="form-select" id="usageService" required>
                                <option value="">Select service...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a service.
                            </div>
                        </div>
                        
                        <!-- Quantity -->
                        <div class="col-md-6">
                            <label for="usageQuantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="usageQuantity" 
                                   min="1" required>
                            <div class="invalid-feedback">
                                Please enter a valid quantity.
                            </div>
                        </div>
                        
                        <!-- Date/Time -->
                        <div class="col-md-6">
                            <label for="usageDateTime" class="form-label">Date/Time</label>
                            <input type="datetime-local" class="form-control" id="usageDateTime">
                        </div>
                        
                        <!-- Staff -->
                        <div class="col-12">
                            <label for="usageStaff" class="form-label">Staff Member</label>
                            <select class="form-select" id="usageStaff">
                                <option value="">Select staff member...</option>
                            </select>
                        </div>
                        
                        <!-- Notes -->
                        <div class="col-12">
                            <label for="usageNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="usageNotes" rows="2" 
                                      placeholder="Additional notes about this usage..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Live Hint -->
                    <div class="mt-3">
                        <div class="alert alert-info" id="usageHint" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="usageHintText"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="saveUsage" disabled>
                    <i class="fas fa-save me-2"></i>Record Usage
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Adjust/Refund Modal -->
<div class="modal fade" id="adjustRefundModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-warning me-2"></i>Adjust/Refund Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adjustRefundForm">
                    <div class="row g-3">
                        <!-- Mode Selection -->
                        <div class="col-12">
                            <label class="form-label">Adjustment Type *</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="adjustMode" id="refundMode" value="refund" checked>
                                <label class="btn btn-outline-warning" for="refundMode">
                                    <i class="fas fa-undo me-2"></i>Refund
                                </label>
                                <input type="radio" class="btn-check" name="adjustMode" id="adjustMode" value="adjust">
                                <label class="btn btn-outline-info" for="adjustMode">
                                    <i class="fas fa-edit me-2"></i>Adjust
                                </label>
                            </div>
                        </div>
                        
                        <!-- Service -->
                        <div class="col-12">
                            <label for="adjustService" class="form-label">Service *</label>
                            <select class="form-select" id="adjustService" required>
                                <option value="">Select service...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a service.
                            </div>
                        </div>
                        
                        <!-- Quantity -->
                        <div class="col-md-6">
                            <label for="adjustQuantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="adjustQuantity" 
                                   min="1" required>
                            <div class="invalid-feedback">
                                Please enter a valid quantity.
                            </div>
                        </div>
                        
                        <!-- Reason -->
                        <div class="col-md-6">
                            <label for="adjustReason" class="form-label">Reason *</label>
                            <select class="form-select" id="adjustReason" required>
                                <option value="">Select reason...</option>
                                <option value="customer_request">Customer Request</option>
                                <option value="service_issue">Service Issue</option>
                                <option value="billing_error">Billing Error</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <!-- Notes -->
                        <div class="col-12">
                            <label for="adjustNotes" class="form-label">Notes *</label>
                            <textarea class="form-control" id="adjustNotes" rows="3" 
                                      placeholder="Please explain the reason for this adjustment..." required></textarea>
                            <div class="invalid-feedback">
                                Please provide a detailed explanation.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Live Hint -->
                    <div class="mt-3">
                        <div class="alert alert-warning" id="adjustHint" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="adjustHintText"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="saveAdjustment" disabled>
                    <i class="fas fa-save me-2"></i>Save Adjustment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include JavaScript -->
<script src="{{ url_for('static', filename='js/packages.js') }}"></script>

<script>
// Package management page JavaScript is loaded from packages.js
console.log('Customer packages template loaded');
</script>
{% endblock %}
