{% extends "base.html" %}

{% block title %}Customer Package Assignment - Management Suite{% endblock %}

{% block extra_head %}
<link href="{{ url_for('static', filename='css/packages.css') }}" rel="stylesheet">
<style>
.package-type-tabs .nav-link {
    border-radius: 10px 10px 0 0;
    margin-right: 5px;
    font-weight: 600;
}

.package-type-tabs .nav-link.active {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-color: #007bff;
}

.package-card {
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
    cursor: pointer;
}

.package-card:hover {
    border-color: #007bff;
    box-shadow: 0 4px 12px rgba(0,123,255,0.15);
    transform: translateY(-2px);
}

.package-card.selected {
    border-color: #28a745;
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
}

.badge-large {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
}

.package-stats {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    border: 1px solid #dee2e6;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-gift text-primary me-2"></i>Customer Package Assignment
                    </h1>
                    <p class="text-muted mb-0">Assign packages to customers and track their usage</p>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('packages') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-cog me-2"></i>Manage Packages
                    </a>
                    <button type="button" class="btn btn-primary" onclick="openQuickAssignModal()">
                        <i class="fas fa-plus me-2"></i>Quick Assign
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Package Type Navigation Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <ul class="nav nav-tabs package-type-tabs" id="packageTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="all-packages-tab" data-bs-toggle="tab" 
                                    data-bs-target="#all-packages" type="button" role="tab">
                                <i class="fas fa-th-large me-2"></i>All Assigned Packages
                                <span class="badge bg-light text-dark ms-2" id="all-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-prepaid-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-prepaid" type="button" role="tab">
                                <i class="fas fa-credit-card me-2"></i>Assign Prepaid
                                <span class="badge bg-success ms-2" id="prepaid-available">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-service-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-service" type="button" role="tab">
                                <i class="fas fa-spa me-2"></i>Assign Service
                                <span class="badge bg-info ms-2" id="service-available">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-membership-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-membership" type="button" role="tab">
                                <i class="fas fa-id-card me-2"></i>Assign Membership
                                <span class="badge bg-warning text-dark ms-2" id="membership-available">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-student-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-student" type="button" role="tab">
                                <i class="fas fa-graduation-cap me-2"></i>Assign Student Offer
                                <span class="badge bg-secondary ms-2" id="student-available">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-yearly-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-yearly" type="button" role="tab">
                                <i class="fas fa-calendar-alt me-2"></i>Assign Yearly
                                <span class="badge bg-dark ms-2" id="yearly-available">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-kitty-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-kitty" type="button" role="tab">
                                <i class="fas fa-users me-2"></i>Assign Kitty Party
                                <span class="badge bg-danger ms-2" id="kitty-available">0</span>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="row">
        <div class="col-12">
            <div class="tab-content" id="packageTypeTabContent">

                <!-- All Assigned Packages Tab -->
                <div class="tab-pane fade show active" id="all-packages" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-list me-2"></i>All Customer Package Assignments
                                </h5>
                                <button type="button" class="btn btn-primary" onclick="openAssignModal()">
                                    <i class="fas fa-plus me-2"></i>Assign Package
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filters and Search -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="searchInput" class="form-label">Search</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="searchInput" 
                                               placeholder="Search by customer name...">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label for="statusFilter" class="form-label">Status</label>
                                    <select class="form-select" id="statusFilter">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="completed">Completed</option>
                                        <option value="expired">Expired</option>
                                        <option value="paused">Paused</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="dateFrom" class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="dateFrom">
                                </div>
                                <div class="col-md-2">
                                    <label for="dateTo" class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="dateTo">
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="clearFilters()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="applyFilters()">
                                        <i class="fas fa-filter me-1"></i>Filter
                                    </button>
                                </div>
                            </div>

                            <!-- Packages Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Customer</th>
                                            <th>Package</th>
                                            <th>Assigned/Expires</th>
                                            <th>Total</th>
                                            <th>Used</th>
                                            <th>Remaining</th>
                                            <th>Progress</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="packagesTableBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Package Assignment Summary -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="fas fa-chart-bar me-2"></i>Package Assignment Summary
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row" id="packageSummaryCards">
                                                <!-- Summary cards will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pagination -->
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div id="paginationInfo" class="text-muted">
                                    <!-- Pagination info will be displayed here -->
                                </div>
                                <nav>
                                    <ul class="pagination mb-0" id="paginationControls">
                                        <!-- Pagination controls will be displayed here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Prepaid Packages Tab -->
                <div class="tab-pane fade" id="assign-prepaid" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-credit-card me-2"></i>Assign Prepaid Packages to Customers
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="prepaidCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="prepaidCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Prepaid Packages</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="prepaid-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row" id="prepaidPackagesContainer">
                                <!-- Prepaid packages will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Service Packages Tab -->
                <div class="tab-pane fade" id="assign-service" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-spa me-2"></i>Assign Service Packages to Customers
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="serviceCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="serviceCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Service Packages</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="service-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row" id="servicePackagesContainer">
                                <!-- Service packages will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Membership Tab -->
                <div class="tab-pane fade" id="assign-membership" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="fas fa-id-card me-2"></i>Assign Memberships to Customers
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="membershipCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="membershipCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Memberships</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="membership-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Memberships Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tblMemberships">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Package Name</th>
                                            <th>Price</th>
                                            <th>Validity</th>
                                            <th>Description</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Membership packages will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Student Offers Tab -->
                <div class="tab-pane fade" id="assign-student" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-graduation-cap me-2"></i>Student Offers Management
                                </h5>
                                <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addStudentOfferModal">
                                    <i class="fas fa-plus me-2"></i>Add Student Offer
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="studentCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="studentCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Student Offers</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="student-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Student Offers Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tblStudentOffers">
                                    <thead class="table-secondary">
                                        <tr>
                                            <th>Discount %</th>
                                            <th>Services</th>
                                            <th>Valid Days</th>
                                            <th>Valid From–To</th>
                                            <th>Conditions</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Student offers will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Yearly Membership Tab -->
                <div class="tab-pane fade" id="assign-yearly" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-calendar-alt me-2"></i>Assign Yearly Memberships to Customers
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="yearlyCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="yearlyCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Yearly Memberships</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="yearly-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Yearly Memberships Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tblYearlyMemberships">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Package Name</th>
                                            <th>Price</th>
                                            <th>Validity</th>
                                            <th>Discount</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Yearly memberships will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Kitty Party Tab -->
                <div class="tab-pane fade" id="assign-kitty" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>Assign Kitty Parties to Customers
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="kittyCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="kittyCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Kitty Parties</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="kitty-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Kitty Parties Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tblKittyPackages">
                                    <thead class="table-danger">
                                        <tr>
                                            <th>Package Name</th>
                                            <th>Price</th>
                                            <th>Min Guests</th>
                                            <th>Description</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Kitty parties will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Include all original modals -->
<!-- Assign Package Modal -->
<div class="modal fade" id="assignPackageModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-gift text-primary me-2"></i>Assign Package to Customer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignPackageForm">
                    <div class="row g-3">
                        <!-- Customer Selection -->
                        <div class="col-md-6">
                            <label for="assignCustomer" class="form-label">Customer *</label>
                            <select class="form-select" id="assignCustomer" required>
                                <option value="">Select customer...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a customer.
                            </div>
                        </div>

                        <!-- Package Template -->
                        <div class="col-md-6">
                            <label for="assignPackage" class="form-label">Package Template *</label>
                            <select class="form-select" id="assignPackage" required>
                                <option value="">Select package...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a package template.
                            </div>
                        </div>

                        <!-- Price Paid -->
                        <div class="col-md-4">
                            <label for="assignPrice" class="form-label">Price Paid *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="assignPrice" 
                                       step="0.01" min="0" required>
                            </div>
                            <div class="invalid-feedback">
                                Please enter a valid price.
                            </div>
                        </div>

                        <!-- Discount -->
                        <div class="col-md-4">
                            <label for="assignDiscount" class="form-label">Discount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="assignDiscount" 
                                       step="0.01" min="0" value="0">
                            </div>
                        </div>

                        <!-- Expires On -->
                        <div class="col-md-4">
                            <label for="assignExpires" class="form-label">Expires On</label>
                            <input type="date" class="form-control" id="assignExpires">
                            <div class="form-text">Leave blank for no expiry</div>
                        </div>

                        <!-- Notes -->
                        <div class="col-12">
                            <label for="assignNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="assignNotes" rows="3" 
                                      placeholder="Additional notes about this package assignment..."></textarea>
                        </div>
                    </div>

                    <!-- Package Preview -->
                    <div id="packagePreview" class="mt-4" style="display: none;">
                        <h6 class="text-muted">Package Components:</h6>
                        <div id="packageItems" class="row g-2">
                            <!-- Package items will be displayed here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAssignPackage" disabled>
                    <i class="fas fa-save me-2"></i>Save Assignment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Package Details Modal -->
<div class="modal fade" id="packageDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle text-primary me-2"></i>Package Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Header Summary -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <strong>Customer:</strong><br>
                                        <span id="detailCustomerName"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Package:</strong><br>
                                        <span id="detailPackageName"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Price Paid:</strong><br>
                                        ₹<span id="detailPrice"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Status:</strong><br>
                                        <span id="detailStatus" class="badge"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Assigned:</strong><br>
                                        <span id="detailAssigned"></span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <strong>Expires:</strong> <span id="detailExpires"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Per-Service Items -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Service Breakdown:</h6>
                        <div id="serviceItems" class="row g-2">
                            <!-- Service items will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Recent Usage -->
                <div class="row">
                    <div class="col-12">
                        <h6>Recent Usage:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Service</th>
                                        <th>Qty</th>
                                        <th>Type</th>
                                        <th>Staff</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="recentUsageTable">
                                    <!-- Recent usage will be displayed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="openUseModal()">
                    <i class="fas fa-play me-2"></i>Record Usage
                </button>
                <button type="button" class="btn btn-warning" onclick="openAdjustModal()">
                    <i class="fas fa-edit me-2"></i>Adjust/Refund
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Record Usage Modal -->
<div class="modal fade" id="recordUsageModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-play text-success me-2"></i>Record Usage
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="recordUsageForm">
                    <div class="row g-3">
                        <!-- Service -->
                        <div class="col-12">
                            <label for="usageService" class="form-label">Service *</label>
                            <select class="form-select" id="usageService" required>
                                <option value="">Select service...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a service.
                            </div>
                        </div>

                        <!-- Quantity -->
                        <div class="col-md-6">
                            <label for="usageQuantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="usageQuantity" 
                                   min="1" required>
                            <div class="invalid-feedback">
                                Please enter a valid quantity.
                            </div>
                        </div>

                        <!-- Date/Time -->
                        <div class="col-md-6">
                            <label for="usageDateTime" class="form-label">Date/Time</label>
                            <input type="datetime-local" class="form-control" id="usageDateTime">
                        </div>

                        <!-- Staff -->
                        <div class="col-12">
                            <label for="usageStaff" class="form-label">Staff Member</label>
                            <select class="form-select" id="usageStaff">
                                <option value="">Select staff member...</option>
                            </select>
                        </div>

                        <!-- Notes -->
                        <div class="col-12">
                            <label for="usageNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="usageNotes" rows="2" 
                                      placeholder="Additional notes about this usage..."></textarea>
                        </div>
                    </div>

                    <!-- Live Hint -->
                    <div class="mt-3">
                        <div class="alert alert-info" id="usageHint" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="usageHintText"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="saveUsage" disabled>
                    <i class="fas fa-save me-2"></i>Record Usage
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Adjust/Refund Modal -->
<div class="modal fade" id="adjustRefundModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-warning me-2"></i>Adjust/Refund Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adjustRefundForm">
                    <div class="row g-3">
                        <!-- Mode Selection -->
                        <div class="col-12">
                            <label class="form-label">Adjustment Type *</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="adjustMode" id="refundMode" value="refund" checked>
                                <label class="btn btn-outline-warning" for="refundMode">
                                    <i class="fas fa-undo me-2"></i>Refund
                                </label>
                                <input type="radio" class="btn-check" name="adjustMode" id="adjustMode" value="adjust">
                                <label class="btn btn-outline-info" for="adjustMode">
                                    <i class="fas fa-edit me-2"></i>Adjust
                                </label>
                            </div>
                        </div>

                        <!-- Service -->
                        <div class="col-12">
                            <label for="adjustService" class="form-label">Service *</label>
                            <select class="form-select" id="adjustService" required>
                                <option value="">Select service...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a service.
                            </div>
                        </div>

                        <!-- Quantity -->
                        <div class="col-md-6">
                            <label for="adjustQuantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="adjustQuantity" 
                                   min="1" required>
                            <div class="invalid-feedback">
                                Please enter a valid quantity.
                            </div>
                        </div>

                        <!-- Reason -->
                        <div class="col-md-6">
                            <label for="adjustReason" class="form-label">Reason *</label>
                            <select class="form-select" id="adjustReason" required>
                                <option value="">Select reason...</option>
                                <option value="customer_request">Customer Request</option>
                                <option value="service_issue">Service Issue</option>
                                <option value="billing_error">Billing Error</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <!-- Notes -->
                        <div class="col-12">
                            <label for="adjustNotes" class="form-label">Notes *</label>
                            <textarea class="form-control" id="adjustNotes" rows="3" 
                                      placeholder="Please explain the reason for this adjustment..." required></textarea>
                            <div class="invalid-feedback">
                                Please provide a detailed explanation.
                            </div>
                        </div>
                    </div>

                    <!-- Live Hint -->
                    <div class="mt-3">
                        <div class="alert alert-warning" id="adjustHint" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="adjustHintText"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="saveAdjustment" disabled>
                    <i class="fas fa-save me-2"></i>Save Adjustment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Package Assignment Modal for each type -->
<div class="modal fade" id="packageAssignmentModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignmentModalTitle">
                    <i class="fas fa-gift text-primary me-2"></i>Assign Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="packageAssignmentForm">
                    <input type="hidden" id="selectedPackageId" name="package_id">
                    <input type="hidden" id="selectedPackageType" name="package_type">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="assignmentCustomer" class="form-label">Customer *</label>
                            <select class="form-select" id="assignmentCustomer" name="customer_id" required>
                                <option value="">Select customer...</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="assignmentPrice" class="form-label">Price Paid *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="assignmentPrice" 
                                       name="price_paid" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="assignmentDiscount" class="form-label">Discount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="assignmentDiscount" 
                                       name="discount" step="0.01" min="0" value="0">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="assignmentExpires" class="form-label">Expires On</label>
                            <input type="date" class="form-control" id="assignmentExpires" name="expires_on">
                        </div>

                        <div class="col-12">
                            <label for="assignmentNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="assignmentNotes" name="notes" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Package Details Preview -->
                    <div class="mt-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="mb-3">Package Details:</h6>
                                <div id="selectedPackageDetails">
                                    <!-- Package details will be shown here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="savePackageAssignment">
                    <i class="fas fa-save me-2"></i>Assign Package
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Minimal Assign Modal -->
<div class="modal fade" id="assignSimpleModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus text-primary me-2"></i>Assign Package to Customer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignSimpleForm">
                    <div class="mb-3">
                        <label for="asTemplateName" class="form-label">Package</label>
                        <input type="text" class="form-control" id="asTemplateName" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="asCustomer" class="form-label">Customer *</label>
                        <select class="form-select" id="asCustomer" required>
                            <option value="">Select customer...</option>
                        </select>
                        <div class="invalid-feedback">
                            Please select a customer.
                        </div>
                    </div>

                    <!-- Hidden fields -->
                    <input type="hidden" id="asTemplateId">
                    <input type="hidden" id="asPackageType">
                    <input type="hidden" id="asPricePaid">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="asSave" disabled>
                    <i class="fas fa-user-plus me-2"></i>Assign
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assigned Customers Modal -->
<div class="modal fade" id="assignedCustomersModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignedCustomersModalTitle">
                    <i class="fas fa-users text-primary me-2"></i>Customers Assigned to Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Package Info -->
                <div class="alert alert-info mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Package Name:</strong> <span id="assignedPackageName"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>Package Type:</strong> <span id="assignedPackageType" class="badge bg-secondary"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>Total Assigned:</strong> <span id="assignedCustomersCount" class="badge bg-primary">0</span>
                        </div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="assignedCustomersSearch" 
                               placeholder="Search customers...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="assignedStatusFilter">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="clearAssignedFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="filterAssignedCustomers()">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                    </div>
                </div>

                <!-- Customers Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Assigned Date</th>
                                <th>Expires</th>
                                <th>Price Paid</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assignedCustomersTableBody">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- No customers message -->
                <div id="noAssignedCustomers" class="text-center py-4" style="display: none;">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Customers Assigned</h5>
                    <p class="text-muted">This package has not been assigned to any customers yet.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="openAssignToPackage()">
                    <i class="fas fa-user-plus me-2"></i>Assign More Customers
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Student Offer Modal -->
<div class="modal fade" id="addStudentOfferModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-graduation-cap text-secondary me-2"></i>Add Student Offer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStudentOfferForm">
                    <div class="row g-3">
                        <!-- Services Selection -->
                        <div class="col-12">
                            <label for="studentOfferServices" class="form-label">Select Services *</label>
                            <select multiple class="form-select" id="studentOfferServices" name="service_ids" required style="height: 120px;">
                                <!-- Services will be loaded here -->
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple services</div>
                            <div class="invalid-feedback">
                                Please select at least one service.
                            </div>
                        </div>

                        <!-- Discount Percentage -->
                        <div class="col-md-6">
                            <label for="studentDiscountPercentage" class="form-label">Discount Percentage *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="studentDiscountPercentage" 
                                       name="discount_percentage" min="1" max="100" step="0.1" required>
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="invalid-feedback">
                                Please enter a discount between 1-100%.
                            </div>
                        </div>

                        <!-- Valid Days -->
                        <div class="col-md-6">
                            <label for="studentValidDays" class="form-label">Valid Days</label>
                            <select class="form-select" id="studentValidDays" name="valid_days">
                                <option value="Mon-Fri" selected>Monday - Friday</option>
                                <option value="Mon-Sat">Monday - Saturday</option>
                                <option value="All Days">All Days</option>
                                <option value="Weekends">Weekends Only</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>

                        <!-- Custom Valid Days (hidden by default) -->
                        <div class="col-12" id="customValidDaysDiv" style="display: none;">
                            <label for="customValidDays" class="form-label">Custom Valid Days</label>
                            <input type="text" class="form-control" id="customValidDays" 
                                   placeholder="e.g., Mon, Wed, Fri">
                            <div class="form-text">Enter specific days when this offer is valid</div>
                        </div>

                        <!-- Valid From Date -->
                        <div class="col-md-6">
                            <label for="studentValidFrom" class="form-label">Valid From *</label>
                            <input type="date" class="form-control" id="studentValidFrom" 
                                   name="valid_from" required>
                            <div class="invalid-feedback">
                                Please select a valid from date.
                            </div>
                        </div>

                        <!-- Valid To Date -->
                        <div class="col-md-6">
                            <label for="studentValidTo" class="form-label">Valid To *</label>
                            <input type="date" class="form-control" id="studentValidTo" 
                                   name="valid_to" required>
                            <div class="invalid-feedback">
                                Please select a valid to date.
                            </div>
                        </div>

                        <!-- Conditions -->
                        <div class="col-12">
                            <label for="studentConditions" class="form-label">Conditions</label>
                            <textarea class="form-control" id="studentConditions" name="conditions" 
                                      rows="3">Valid with Student ID</textarea>
                            <div class="form-text">Terms and conditions for this student offer</div>
                        </div>

                        <!-- Preview Section -->
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="mb-3">Offer Preview:</h6>
                                    <div id="studentOfferPreview">
                                        <p class="text-muted">Select services and discount to see preview</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveStudentOffer" disabled>
                    <i class="fas fa-save me-2"></i>Save Student Offer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Student Offer Modal -->
<div class="modal fade" id="editStudentOfferModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-warning me-2"></i>Edit Student Offer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editStudentOfferForm">
                    <input type="hidden" id="editOfferId" name="offer_id">
                    <div class="row g-3">
                        <!-- Services Selection -->
                        <div class="col-12">
                            <label for="editStudentOfferServices" class="form-label">Select Services *</label>
                            <select multiple class="form-select" id="editStudentOfferServices" name="service_ids" required style="height: 120px;">
                                <!-- Services will be loaded here -->
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple services</div>
                        </div>

                        <!-- Discount Percentage -->
                        <div class="col-md-6">
                            <label for="editStudentDiscountPercentage" class="form-label">Discount Percentage *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editStudentDiscountPercentage" 
                                       name="discount_percentage" min="1" max="100" step="0.1" required>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>

                        <!-- Valid Days -->
                        <div class="col-md-6">
                            <label for="editStudentValidDays" class="form-label">Valid Days</label>
                            <select class="form-select" id="editStudentValidDays" name="valid_days">
                                <option value="Mon-Fri">Monday - Friday</option>
                                <option value="Mon-Sat">Monday - Saturday</option>
                                <option value="All Days">All Days</option>
                                <option value="Weekends">Weekends Only</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>

                        <!-- Custom Valid Days (hidden by default) -->
                        <div class="col-12" id="editCustomValidDaysDiv" style="display: none;">
                            <label for="editCustomValidDays" class="form-label">Custom Valid Days</label>
                            <input type="text" class="form-control" id="editCustomValidDays" 
                                   placeholder="e.g., Mon, Wed, Fri">
                        </div>

                        <!-- Valid From Date -->
                        <div class="col-md-6">
                            <label for="editStudentValidFrom" class="form-label">Valid From *</label>
                            <input type="date" class="form-control" id="editStudentValidFrom" 
                                   name="valid_from" required>
                        </div>

                        <!-- Valid To Date -->
                        <div class="col-md-6">
                            <label for="editStudentValidTo" class="form-label">Valid To *</label>
                            <input type="date" class="form-control" id="editStudentValidTo" 
                                   name="valid_to" required>
                        </div>

                        <!-- Conditions -->
                        <div class="col-12">
                            <label for="editStudentConditions" class="form-label">Conditions</label>
                            <textarea class="form-control" id="editStudentConditions" name="conditions" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="updateStudentOffer">
                    <i class="fas fa-save me-2"></i>Update Student Offer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Kitty Party Modal -->
<div class="modal fade" id="addKittyPartyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-birthday-cake me-2"></i>Add Kitty Party Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addKittyPartyForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Party Name *</label>
                            <input type="text" id="kittyPartyName" name="name" class="form-control" required placeholder="e.g., Birthday Bash Package">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" id="kittyPrice" name="price" class="form-control" required step="0.01" min="0" placeholder="5000">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">After Value</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" id="kittyAfterValue" name="after_value" class="form-control" step="0.01" min="0" placeholder="6000">
                            </div>
                            <small class="text-muted">Value after package discount</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Minimum Guests *</label>
                            <input type="number" id="kittyMinGuests" name="min_guests" class="form-control" required min="1" placeholder="10">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Valid From</label>
                            <input type="date" id="kittyValidFrom" name="valid_from" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Valid To</label>
                            <input type="date" id="kittyValidTo" name="valid_to" class="form-control">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Services Included *</label>
                        <select id="kittyPartyServices" name="service_ids" class="form-select" multiple required size="6">
                            <!-- Services will be loaded dynamically -->
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple services</div>
                        <div class="invalid-feedback">Please select at least one service for this kitty party</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Conditions</label>
                        <textarea id="kittyConditions" name="conditions" class="form-control" rows="3" placeholder="e.g., Applicable only on weekdays, requires 24-hour advance booking"></textarea>
                        <small class="text-muted">Optional terms and conditions</small>
                    </div>

                    <!-- Preview Section -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading mb-2">
                            <i class="fas fa-eye me-2"></i>Package Preview
                        </h6>
                        <div id="kittyPartyPreview">
                            <p class="text-muted">Fill in party details to see preview</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveKittyParty" disabled>Save Kitty Party</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Kitty Party Modal -->
<div class="modal fade" id="editKittyPartyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Kitty Party Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editKittyPartyForm">
                    <input type="hidden" id="editPartyId" name="party_id">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Party Name *</label>
                            <input type="text" id="editKittyPartyName" name="name" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" id="editKittyPrice" name="price" class="form-control" required step="0.01" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">After Value</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" id="editKittyAfterValue" name="after_value" class="form-control" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Minimum Guests *</label>
                            <input type="number" id="editKittyMinGuests" name="min_guests" class="form-control" required min="1">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Valid From</label>
                            <input type="date" id="editKittyValidFrom" name="valid_from" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Valid To</label>
                            <input type="date" id="editKittyValidTo" name="valid_to" class="form-control">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Services Included *</label>
                        <select id="editKittyPartyServices" name="service_ids" class="form-select" multiple required size="6">
                            <!-- Services will be loaded dynamically -->
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple services</div>
                        <div class="invalid-feedback">Please select at least one service for this kitty party</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Conditions</label>
                        <textarea id="editKittyConditions" name="conditions" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateKittyParty">Update Kitty Party</button>
            </div>
        </div>
    </div>
</div>

<!-- Include JavaScript -->
<script src="{{ url_for('static', filename='js/packages.js') }}"></script>

<script>
// Enhanced Package Assignment System JavaScript
let allPackageTypes = {};
let selectedCustomerForAssignment = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('Customer packages page loaded');

    // Load initial data
    loadPackages();
    loadCustomers();
    loadServices();

    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Add tab event listeners to ensure correct data loading and clear other tabs
    document.getElementById('assign-membership-tab').addEventListener('shown.bs.tab', function() {
        console.log('Membership tab shown - loading membership packages only');
        // Clear other tab tables to prevent cross-contamination
        clearOtherTabTables('membership');
        loadMembershipPackages();
    });

    document.getElementById('assign-student-tab').addEventListener('shown.bs.tab', function() {
        console.log('Student tab shown - loading student packages only');
        clearOtherTabTables('student');
        loadStudentPackages();
    });

    document.getElementById('assign-yearly-tab').addEventListener('shown.bs.tab', function() {
        console.log('Yearly tab shown - loading yearly packages only');
        clearOtherTabTables('yearly');
        loadYearlyPackages();
    });

    document.getElementById('assign-kitty-tab').addEventListener('shown.bs.tab', function() {
        console.log('Kitty tab shown - loading kitty packages only');
        clearOtherTabTables('kitty');
        loadKittyPackages();
    });

    document.getElementById('assign-prepaid-tab').addEventListener('shown.bs.tab', function() {
        console.log('Prepaid tab shown - clearing membership table');
        clearOtherTabTables('prepaid');
    });

    document.getElementById('assign-service-tab').addEventListener('shown.bs.tab', function() {
        console.log('Service tab shown - clearing membership table');
        clearOtherTabTables('service');
    });
}

// Function to clear other tab tables to prevent cross-contamination
function clearOtherTabTables(activeTabType) {
    const tablesToClear = {
        'tblMemberships': 'membership',
        'tblStudentOffers': 'student', 
        'tblYearlyMemberships': 'yearly',
        'tblKittyPackages': 'kitty'
    };

    Object.keys(tablesToClear).forEach(tableId => {
        if (tablesToClear[tableId] !== activeTabType) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            if (tableBody) {
                tableBody.innerHTML = '';
                console.log(`Cleared ${tableId} table`);
            }
        }
    });
});

async function loadPackages() {
    try {
        // This function might be responsible for loading all package types initially
        // and populating the 'All Assigned Packages' tab.
        // The specific logic for this function would depend on your backend API.
        console.log("loadPackages called - this should load all assignments for the main table.");
        await loadAllPackageAssignments(); // Ensure this is called
    } catch (error) {
        console.error("Error in loadPackages:", error);
    }
}

// Placeholder function for loading customer data
async function loadCustomers() {
    console.log("loadCustomers called");
    await loadCustomersForAllTabs(); // Use the existing function
}

// Placeholder function for loading service data
async function loadServices() {
    console.log("loadServices called");
    // This function would typically fetch available services to populate dropdowns
    // in modals like 'Record Usage' or 'Adjust/Refund'.
    // For now, it's a placeholder.
}

// Placeholder for loadMembershipPackages
async function loadMembershipPackages() {
    console.log("loadMembershipPackages called");
    // This function should fetch and display membership packages in the #tblMemberships table
    if (allPackageTypes['membership'] && allPackageTypes['membership'].length > 0 && document.querySelector('#assign-membership tbody').innerHTML.trim() === '') {
        const tableBody = document.querySelector('#assign-membership tbody');
        tableBody.innerHTML = allPackageTypes['membership'].map(pkg => `
            <tr>
                <td>${pkg.name}</td>
                <td>₹${pkg.price}</td>
                <td>${pkg.validity_months} months</td>
                <td>${pkg.description || 'N/A'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="selectPackageForAssignment('${pkg.id}', 'membership', ${JSON.stringify(pkg).replace(/"/g, '&quot;')})">
                        <i class="fas fa-plus"></i> Assign
                    </button>
                </td>
            </tr>
        `).join('');
    } else if (!allPackageTypes['membership'] || allPackageTypes['membership'].length === 0) {
        console.log("No Membership Packages loaded or available.");
    }
}

// Placeholder for loadStudentPackages
async function loadStudentPackages() {
    console.log("loadStudentPackages called");
    // This function should fetch and display student offer packages
    const container = document.getElementById('studentPackagesContainer');
    if (!container) return;

    if (allPackageTypes['student'] && allPackageTypes['student'].length > 0 && container.innerHTML.trim() === '') {
        container.innerHTML = allPackageTypes['student'].map(pkg => createPackageCard(pkg, 'student')).join('');
    } else if (!allPackageTypes['student'] || allPackageTypes['student'].length === 0) {
        console.log("No Student Offers loaded or available.");
    }
}

// Placeholder for loadYearlyPackages
async function loadYearlyPackages() {
    console.log("loadYearlyPackages called");
    // This function should fetch and display yearly membership packages
    const container = document.getElementById('yearlyPackagesContainer');
    if (!container) return;

    if (allPackageTypes['yearly'] && allPackageTypes['yearly'].length > 0 && container.innerHTML.trim() === '') {
        container.innerHTML = allPackageTypes['yearly'].map(pkg => createPackageCard(pkg, 'yearly')).join('');
    } else if (!allPackageTypes['yearly'] || allPackageTypes['yearly'].length === 0) {
        console.log("No Yearly Memberships loaded or available.");
    }
}

// Placeholder for loadKittyPackages
async function loadKittyPackages() {
    console.log("loadKittyPackages called");
    // This function should fetch and display kitty party packages
    const container = document.getElementById('kittyPackagesContainer');
    if (!container) return;

    if (allPackageTypes['kitty'] && allPackageTypes['kitty'].length > 0 && container.innerHTML.trim() === '') {
        container.innerHTML = allPackageTypes['kitty'].map(pkg => createPackageCard(pkg, 'kitty')).join('');
    } else if (!allPackageTypes['kitty'] || allPackageTypes['kitty'].length === 0) {
        console.log("No Kitty Parties loaded or available.");
    }
}

// Function to open the general assignment modal
function openAssignModal() {
    const modal = new bootstrap.Modal(document.getElementById('packageAssignmentModal'));
    // Optionally clear form fields or set defaults here
    document.getElementById('packageAssignmentForm').reset();
    document.getElementById('selectedPackageId').value = '';
    document.getElementById('selectedPackageType').value = '';
    document.getElementById('selectedPackageDetails').innerHTML = '';
    document.getElementById('assignmentModalTitle').innerHTML = '<i class="fas fa-gift text-primary me-2"></i>Assign Package';
    modal.show();
}

// Placeholder for viewAssignmentDetails
function viewAssignmentDetails(assignmentId) {
    console.log(`Viewing details for assignment ID: ${assignmentId}`);
    // Implement logic to fetch and display assignment details in packageDetailsModal
    const modal = new bootstrap.Modal(document.getElementById('packageDetailsModal'));
    modal.show();
}

// Placeholder for viewCustomerDetails
function viewCustomerDetails(customerId) {
    console.log(`Viewing details for customer ID: ${customerId}`);
    // Implement logic to fetch and display customer details
}

// Placeholder for openUseModal
function openUseModal() {
    console.log("Opening Record Usage Modal");
    const modal = new bootstrap.Modal(document.getElementById('recordUsageModal'));
    modal.show();
}

// Placeholder for openAdjustModal
function openAdjustModal() {
    console.log("Opening Adjust/Refund Modal");
    const modal = new bootstrap.Modal(document.getElementById('adjustRefundModal'));
    modal.show();
}

// Placeholder for clearFilters
function clearFilters() {
    console.log("Clearing filters");
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    applyFilters(); // Re-apply filters to refresh the table
}

// Placeholder for applyFilters
function applyFilters() {
    console.log("Applying filters");
    // Implement logic to filter the packagesTableBody based on current filter values
    // This will likely involve fetching filtered data or client-side filtering
}

// Function to show toast messages
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer') || createToastContainer();
    const toastId = `toast-${Date.now()}`;
    const toast = document.createElement('div');
    toast.className = `toast show bg-${type} text-white`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('data-bs-autohide', 'true');
    toast.setAttribute('data-bs-delay', '5000');
    toast.id = toastId;
    toast.innerHTML = `
        <div class="toast-header bg-${type} text-white">
            <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    toastContainer.appendChild(toast);

    // Initialize the toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    // Remove toast from DOM after it's hidden
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toastContainer';
    container.style.position = 'fixed';
    container.style.top = '10px';
    container.style.right = '10px';
    container.style.zIndex = '1050'; // Ensure it's above other elements
    document.body.appendChild(container);
    return container;
}

console.log('Enhanced customer package assignment system loaded');
</script>

{% endblock %}