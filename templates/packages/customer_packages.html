{% extends "base.html" %}

{% block title %}Customer Package Assignment - Management Suite{% endblock %}

{% block extra_head %}
<link href="{{ url_for('static', filename='css/packages.css') }}" rel="stylesheet">
<style>
.package-type-tabs .nav-link {
    border-radius: 10px 10px 0 0;
    margin-right: 5px;
    font-weight: 600;
}

.package-type-tabs .nav-link.active {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-color: #007bff;
}

.package-card {
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
    cursor: pointer;
}

.package-card:hover {
    border-color: #007bff;
    box-shadow: 0 4px 12px rgba(0,123,255,0.15);
    transform: translateY(-2px);
}

.package-card.selected {
    border-color: #28a745;
    background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
}

.badge-large {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
}

.package-stats {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    border: 1px solid #dee2e6;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-gift text-primary me-2"></i>Customer Package Assignment
                    </h1>
                    <p class="text-muted mb-0">Assign packages to customers and track their usage</p>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('packages') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-cog me-2"></i>Manage Packages
                    </a>
                    <button type="button" class="btn btn-primary" onclick="openQuickAssignModal()">
                        <i class="fas fa-plus me-2"></i>Quick Assign
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Package Type Navigation Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <ul class="nav nav-tabs package-type-tabs" id="packageTypeTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="all-packages-tab" data-bs-toggle="tab" 
                                    data-bs-target="#all-packages" type="button" role="tab">
                                <i class="fas fa-th-large me-2"></i>All Assigned Packages
                                <span class="badge bg-light text-dark ms-2" id="all-count">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-prepaid-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-prepaid" type="button" role="tab">
                                <i class="fas fa-credit-card me-2"></i>Assign Prepaid
                                <span class="badge bg-success ms-2" id="prepaid-available">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-service-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-service" type="button" role="tab">
                                <i class="fas fa-spa me-2"></i>Assign Service
                                <span class="badge bg-info ms-2" id="service-available">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-membership-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-membership" type="button" role="tab"
                                    onclick="loadMembershipPackages()">
                                <i class="fas fa-id-card me-2"></i>Assign Membership
                                <span class="badge bg-warning text-dark ms-2" id="membership-available">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-student-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-student" type="button" role="tab"
                                    onclick="loadStudentPackages()">
                                <i class="fas fa-graduation-cap me-2"></i>Assign Student Offer
                                <span class="badge bg-secondary ms-2" id="student-available">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-yearly-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-yearly" type="button" role="tab"
                                    onclick="loadYearlyPackages()">
                                <i class="fas fa-calendar-alt me-2"></i>Assign Yearly
                                <span class="badge bg-dark ms-2" id="yearly-available">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="assign-kitty-tab" data-bs-toggle="tab" 
                                    data-bs-target="#assign-kitty" type="button" role="tab"
                                    onclick="loadKittyPackages()">
                                <i class="fas fa-users me-2"></i>Assign Kitty Party
                                <span class="badge bg-danger ms-2" id="kitty-available">0</span>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="row">
        <div class="col-12">
            <div class="tab-content" id="packageTypeTabContent">

                <!-- All Assigned Packages Tab -->
                <div class="tab-pane fade show active" id="all-packages" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-list me-2"></i>All Customer Package Assignments
                                </h5>
                                <button type="button" class="btn btn-primary" onclick="openAssignModal()">
                                    <i class="fas fa-plus me-2"></i>Assign Package
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Filters and Search -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="searchInput" class="form-label">Search</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control" id="searchInput" 
                                               placeholder="Search by customer name...">
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label for="statusFilter" class="form-label">Status</label>
                                    <select class="form-select" id="statusFilter">
                                        <option value="">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="completed">Completed</option>
                                        <option value="expired">Expired</option>
                                        <option value="paused">Paused</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label for="dateFrom" class="form-label">From Date</label>
                                    <input type="date" class="form-control" id="dateFrom">
                                </div>
                                <div class="col-md-2">
                                    <label for="dateTo" class="form-label">To Date</label>
                                    <input type="date" class="form-control" id="dateTo">
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="clearFilters()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="applyFilters()">
                                        <i class="fas fa-filter me-1"></i>Filter
                                    </button>
                                </div>
                            </div>

                            <!-- Packages Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Customer</th>
                                            <th>Package</th>
                                            <th>Assigned/Expires</th>
                                            <th>Total</th>
                                            <th>Used</th>
                                            <th>Remaining</th>
                                            <th>Progress</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="packagesTableBody">
                                        <!-- Dynamic content will be loaded here -->
                                    </tbody>
                                </table>
                            </div>

                            <!-- Package Assignment Summary -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="fas fa-chart-bar me-2"></i>Package Assignment Summary
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row" id="packageSummaryCards">
                                                <!-- Summary cards will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Pagination -->
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div id="paginationInfo" class="text-muted">
                                    <!-- Pagination info will be displayed here -->
                                </div>
                                <nav>
                                    <ul class="pagination mb-0" id="paginationControls">
                                        <!-- Pagination controls will be displayed here -->
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Prepaid Packages Tab -->
                <div class="tab-pane fade" id="assign-prepaid" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-credit-card me-2"></i>Assign Prepaid Packages to Customers
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="prepaidCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="prepaidCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Prepaid Packages</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="prepaid-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row" id="prepaidPackagesContainer">
                                <!-- Prepaid packages will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Service Packages Tab -->
                <div class="tab-pane fade" id="assign-service" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-spa me-2"></i>Assign Service Packages to Customers
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="serviceCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="serviceCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Service Packages</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="service-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row" id="servicePackagesContainer">
                                <!-- Service packages will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Membership Tab -->
                <div class="tab-pane fade" id="assign-membership" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="fas fa-id-card me-2"></i>Assign Memberships to Customers
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="membershipCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="membershipCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Memberships</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="membership-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Memberships Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tblMemberships">
                                    <thead class="table-warning">
                                        <tr>
                                            <th>Package Name</th>
                                            <th>Price</th>
                                            <th>Validity</th>
                                            <th>Description</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Membership packages will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Student Offers Tab -->
                <div class="tab-pane fade" id="assign-student" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-secondary text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-graduation-cap me-2"></i>Student Offers Management
                                </h5>
                                <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addStudentOfferModal">
                                    <i class="fas fa-plus me-2"></i>Add Student Offer
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="studentCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="studentCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Student Offers</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="student-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Student Offers Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tblStudentOffers">
                                    <thead class="table-secondary">
                                        <tr>
                                            <th>Discount %</th>
                                            <th>Services</th>
                                            <th>Valid Days</th>
                                            <th>Valid From–To</th>
                                            <th>Conditions</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Student offers will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Yearly Membership Tab -->
                <div class="tab-pane fade" id="assign-yearly" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-calendar-alt me-2"></i>Assign Yearly Memberships to Customers
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="yearlyCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="yearlyCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Yearly Memberships</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="yearly-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Yearly Memberships Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tblYearlyMemberships">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Package Name</th>
                                            <th>Price</th>
                                            <th>Validity</th>
                                            <th>Discount</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Yearly memberships will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assign Kitty Party Tab -->
                <div class="tab-pane fade" id="assign-kitty" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>Assign Kitty Parties to Customers
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="kittyCustomerSelect" class="form-label fw-bold">Select Customer</label>
                                    <select class="form-select form-select-lg" id="kittyCustomerSelect">
                                        <option value="">Choose customer...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="package-stats p-3">
                                        <h6 class="mb-2">Available Kitty Parties</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Total Available:</span>
                                            <span class="fw-bold" id="kitty-total-count">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Kitty Parties Table -->
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tblKittyPackages">
                                    <thead class="table-danger">
                                        <tr>
                                            <th>Package Name</th>
                                            <th>Price</th>
                                            <th>Min Guests</th>
                                            <th>Description</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Kitty parties will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Include all original modals -->
<!-- Assign Package Modal -->
<div class="modal fade" id="assignPackageModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-gift text-primary me-2"></i>Assign Package to Customer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignPackageForm">
                    <div class="row g-3">
                        <!-- Customer Selection -->
                        <div class="col-md-6">
                            <label for="assignCustomer" class="form-label">Customer *</label>
                            <select class="form-select" id="assignCustomer" required>
                                <option value="">Select customer...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a customer.
                            </div>
                        </div>

                        <!-- Package Template -->
                        <div class="col-md-6">
                            <label for="assignPackage" class="form-label">Package Template *</label>
                            <select class="form-select" id="assignPackage" required>
                                <option value="">Select package...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a package template.
                            </div>
                        </div>

                        <!-- Price Paid -->
                        <div class="col-md-4">
                            <label for="assignPrice" class="form-label">Price Paid *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="assignPrice" 
                                       step="0.01" min="0" required>
                            </div>
                            <div class="invalid-feedback">
                                Please enter a valid price.
                            </div>
                        </div>

                        <!-- Discount -->
                        <div class="col-md-4">
                            <label for="assignDiscount" class="form-label">Discount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="assignDiscount" 
                                       step="0.01" min="0" value="0">
                            </div>
                        </div>

                        <!-- Expires On -->
                        <div class="col-md-4">
                            <label for="assignExpires" class="form-label">Expires On</label>
                            <input type="date" class="form-control" id="assignExpires">
                            <div class="form-text">Leave blank for no expiry</div>
                        </div>

                        <!-- Notes -->
                        <div class="col-12">
                            <label for="assignNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="assignNotes" rows="3" 
                                      placeholder="Additional notes about this package assignment..."></textarea>
                        </div>
                    </div>

                    <!-- Package Preview -->
                    <div id="packagePreview" class="mt-4" style="display: none;">
                        <h6 class="text-muted">Package Components:</h6>
                        <div id="packageItems" class="row g-2">
                            <!-- Package items will be displayed here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveAssignPackage" disabled>
                    <i class="fas fa-save me-2"></i>Save Assignment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Package Details Modal -->
<div class="modal fade" id="packageDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle text-primary me-2"></i>Package Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Header Summary -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row g-3">
                                    <div class="col-md-3">
                                        <strong>Customer:</strong><br>
                                        <span id="detailCustomerName"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Package:</strong><br>
                                        <span id="detailPackageName"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Price Paid:</strong><br>
                                        ₹<span id="detailPrice"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Status:</strong><br>
                                        <span id="detailStatus" class="badge"></span>
                                    </div>
                                    <div class="col-md-2">
                                        <strong>Assigned:</strong><br>
                                        <span id="detailAssigned"></span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <strong>Expires:</strong> <span id="detailExpires"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Per-Service Items -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>Service Breakdown:</h6>
                        <div id="serviceItems" class="row g-2">
                            <!-- Service items will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Recent Usage -->
                <div class="row">
                    <div class="col-12">
                        <h6>Recent Usage:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Service</th>
                                        <th>Qty</th>
                                        <th>Type</th>
                                        <th>Staff</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="recentUsageTable">
                                    <!-- Recent usage will be displayed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="openUseModal()">
                    <i class="fas fa-play me-2"></i>Record Usage
                </button>
                <button type="button" class="btn btn-warning" onclick="openAdjustModal()">
                    <i class="fas fa-edit me-2"></i>Adjust/Refund
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Record Usage Modal -->
<div class="modal fade" id="recordUsageModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-play text-success me-2"></i>Record Usage
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="recordUsageForm">
                    <div class="row g-3">
                        <!-- Service -->
                        <div class="col-12">
                            <label for="usageService" class="form-label">Service *</label>
                            <select class="form-select" id="usageService" required>
                                <option value="">Select service...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a service.
                            </div>
                        </div>

                        <!-- Quantity -->
                        <div class="col-md-6">
                            <label for="usageQuantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="usageQuantity" 
                                   min="1" required>
                            <div class="invalid-feedback">
                                Please enter a valid quantity.
                            </div>
                        </div>

                        <!-- Date/Time -->
                        <div class="col-md-6">
                            <label for="usageDateTime" class="form-label">Date/Time</label>
                            <input type="datetime-local" class="form-control" id="usageDateTime">
                        </div>

                        <!-- Staff -->
                        <div class="col-12">
                            <label for="usageStaff" class="form-label">Staff Member</label>
                            <select class="form-select" id="usageStaff">
                                <option value="">Select staff member...</option>
                            </select>
                        </div>

                        <!-- Notes -->
                        <div class="col-12">
                            <label for="usageNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="usageNotes" rows="2" 
                                      placeholder="Additional notes about this usage..."></textarea>
                        </div>
                    </div>

                    <!-- Live Hint -->
                    <div class="mt-3">
                        <div class="alert alert-info" id="usageHint" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="usageHintText"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="saveUsage" disabled>
                    <i class="fas fa-save me-2"></i>Record Usage
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Adjust/Refund Modal -->
<div class="modal fade" id="adjustRefundModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-warning me-2"></i>Adjust/Refund Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adjustRefundForm">
                    <div class="row g-3">
                        <!-- Mode Selection -->
                        <div class="col-12">
                            <label class="form-label">Adjustment Type *</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="adjustMode" id="refundMode" value="refund" checked>
                                <label class="btn btn-outline-warning" for="refundMode">
                                    <i class="fas fa-undo me-2"></i>Refund
                                </label>
                                <input type="radio" class="btn-check" name="adjustMode" id="adjustMode" value="adjust">
                                <label class="btn btn-outline-info" for="adjustMode">
                                    <i class="fas fa-edit me-2"></i>Adjust
                                </label>
                            </div>
                        </div>

                        <!-- Service -->
                        <div class="col-12">
                            <label for="adjustService" class="form-label">Service *</label>
                            <select class="form-select" id="adjustService" required>
                                <option value="">Select service...</option>
                            </select>
                            <div class="invalid-feedback">
                                Please select a service.
                            </div>
                        </div>

                        <!-- Quantity -->
                        <div class="col-md-6">
                            <label for="adjustQuantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="adjustQuantity" 
                                   min="1" required>
                            <div class="invalid-feedback">
                                Please enter a valid quantity.
                            </div>
                        </div>

                        <!-- Reason -->
                        <div class="col-md-6">
                            <label for="adjustReason" class="form-label">Reason *</label>
                            <select class="form-select" id="adjustReason" required>
                                <option value="">Select reason...</option>
                                <option value="customer_request">Customer Request</option>
                                <option value="service_issue">Service Issue</option>
                                <option value="billing_error">Billing Error</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <!-- Notes -->
                        <div class="col-12">
                            <label for="adjustNotes" class="form-label">Notes *</label>
                            <textarea class="form-control" id="adjustNotes" rows="3" 
                                      placeholder="Please explain the reason for this adjustment..." required></textarea>
                            <div class="invalid-feedback">
                                Please provide a detailed explanation.
                            </div>
                        </div>
                    </div>

                    <!-- Live Hint -->
                    <div class="mt-3">
                        <div class="alert alert-warning" id="adjustHint" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span id="adjustHintText"></span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="saveAdjustment" disabled>
                    <i class="fas fa-save me-2"></i>Save Adjustment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Package Assignment Modal for each type -->
<div class="modal fade" id="packageAssignmentModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignmentModalTitle">
                    <i class="fas fa-gift text-primary me-2"></i>Assign Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="packageAssignmentForm">
                    <input type="hidden" id="selectedPackageId" name="package_id">
                    <input type="hidden" id="selectedPackageType" name="package_type">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="assignmentCustomer" class="form-label">Customer *</label>
                            <select class="form-select" id="assignmentCustomer" name="customer_id" required>
                                <option value="">Select customer...</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="assignmentPrice" class="form-label">Price Paid *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="assignmentPrice" 
                                       name="price_paid" step="0.01" min="0" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="assignmentDiscount" class="form-label">Discount</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" class="form-control" id="assignmentDiscount" 
                                       name="discount" step="0.01" min="0" value="0">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="assignmentExpires" class="form-label">Expires On</label>
                            <input type="date" class="form-control" id="assignmentExpires" name="expires_on">
                        </div>

                        <div class="col-12">
                            <label for="assignmentNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="assignmentNotes" name="notes" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- Package Details Preview -->
                    <div class="mt-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="mb-3">Package Details:</h6>
                                <div id="selectedPackageDetails">
                                    <!-- Package details will be shown here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="savePackageAssignment">
                    <i class="fas fa-save me-2"></i>Assign Package
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Minimal Assign Modal -->
<div class="modal fade" id="assignSimpleModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus text-primary me-2"></i>Assign Package to Customer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignSimpleForm">
                    <div class="mb-3">
                        <label for="asTemplateName" class="form-label">Package</label>
                        <input type="text" class="form-control" id="asTemplateName" readonly>
                    </div>

                    <div class="mb-3">
                        <label for="asCustomer" class="form-label">Customer *</label>
                        <select class="form-select" id="asCustomer" required>
                            <option value="">Select customer...</option>
                        </select>
                        <div class="invalid-feedback">
                            Please select a customer.
                        </div>
                    </div>

                    <!-- Hidden fields -->
                    <input type="hidden" id="asTemplateId">
                    <input type="hidden" id="asPackageType">
                    <input type="hidden" id="asPricePaid">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="asSave" disabled>
                    <i class="fas fa-user-plus me-2"></i>Assign
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assigned Customers Modal -->
<div class="modal fade" id="assignedCustomersModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignedCustomersModalTitle">
                    <i class="fas fa-users text-primary me-2"></i>Customers Assigned to Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Package Info -->
                <div class="alert alert-info mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Package Name:</strong> <span id="assignedPackageName"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>Package Type:</strong> <span id="assignedPackageType" class="badge bg-secondary"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>Total Assigned:</strong> <span id="assignedCustomersCount" class="badge bg-primary">0</span>
                        </div>
                    </div>
                </div>

                <!-- Search and Filters -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="assignedCustomersSearch" 
                               placeholder="Search customers...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="assignedStatusFilter">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    <div class="col-md-5">
                        <button type="button" class="btn btn-outline-secondary me-2" onclick="clearAssignedFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="filterAssignedCustomers()">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                    </div>
                </div>

                <!-- Customers Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Assigned Date</th>
                                <th>Expires</th>
                                <th>Price Paid</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="assignedCustomersTableBody">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- No customers message -->
                <div id="noAssignedCustomers" class="text-center py-4" style="display: none;">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Customers Assigned</h5>
                    <p class="text-muted">This package has not been assigned to any customers yet.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="openAssignToPackage()">
                    <i class="fas fa-user-plus me-2"></i>Assign More Customers
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Student Offer Modal -->
<div class="modal fade" id="addStudentOfferModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-graduation-cap text-secondary me-2"></i>Add Student Offer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStudentOfferForm">
                    <div class="row g-3">
                        <!-- Services Selection -->
                        <div class="col-12">
                            <label for="studentOfferServices" class="form-label">Select Services *</label>
                            <select multiple class="form-select" id="studentOfferServices" name="service_ids" required style="height: 120px;">
                                <!-- Services will be loaded here -->
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple services</div>
                            <div class="invalid-feedback">
                                Please select at least one service.
                            </div>
                        </div>

                        <!-- Discount Percentage -->
                        <div class="col-md-6">
                            <label for="studentDiscountPercentage" class="form-label">Discount Percentage *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="studentDiscountPercentage" 
                                       name="discount_percentage" min="1" max="100" step="0.1" required>
                                <span class="input-group-text">%</span>
                            </div>
                            <div class="invalid-feedback">
                                Please enter a discount between 1-100%.
                            </div>
                        </div>

                        <!-- Valid Days -->
                        <div class="col-md-6">
                            <label for="studentValidDays" class="form-label">Valid Days</label>
                            <select class="form-select" id="studentValidDays" name="valid_days">
                                <option value="Mon-Fri" selected>Monday - Friday</option>
                                <option value="Mon-Sat">Monday - Saturday</option>
                                <option value="All Days">All Days</option>
                                <option value="Weekends">Weekends Only</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>

                        <!-- Custom Valid Days (hidden by default) -->
                        <div class="col-12" id="customValidDaysDiv" style="display: none;">
                            <label for="customValidDays" class="form-label">Custom Valid Days</label>
                            <input type="text" class="form-control" id="customValidDays" 
                                   placeholder="e.g., Mon, Wed, Fri">
                            <div class="form-text">Enter specific days when this offer is valid</div>
                        </div>

                        <!-- Valid From Date -->
                        <div class="col-md-6">
                            <label for="studentValidFrom" class="form-label">Valid From *</label>
                            <input type="date" class="form-control" id="studentValidFrom" 
                                   name="valid_from" required>
                            <div class="invalid-feedback">
                                Please select a valid from date.
                            </div>
                        </div>

                        <!-- Valid To Date -->
                        <div class="col-md-6">
                            <label for="studentValidTo" class="form-label">Valid To *</label>
                            <input type="date" class="form-control" id="studentValidTo" 
                                   name="valid_to" required>
                            <div class="invalid-feedback">
                                Please select a valid to date.
                            </div>
                        </div>

                        <!-- Conditions -->
                        <div class="col-12">
                            <label for="studentConditions" class="form-label">Conditions</label>
                            <textarea class="form-control" id="studentConditions" name="conditions" 
                                      rows="3">Valid with Student ID</textarea>
                            <div class="form-text">Terms and conditions for this student offer</div>
                        </div>

                        <!-- Preview Section -->
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="mb-3">Offer Preview:</h6>
                                    <div id="studentOfferPreview">
                                        <p class="text-muted">Select services and discount to see preview</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveStudentOffer" disabled>
                    <i class="fas fa-save me-2"></i>Save Student Offer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Student Offer Modal -->
<div class="modal fade" id="editStudentOfferModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-warning me-2"></i>Edit Student Offer
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editStudentOfferForm">
                    <input type="hidden" id="editOfferId" name="offer_id">
                    <div class="row g-3">
                        <!-- Services Selection -->
                        <div class="col-12">
                            <label for="editStudentOfferServices" class="form-label">Select Services *</label>
                            <select multiple class="form-select" id="editStudentOfferServices" name="service_ids" required style="height: 120px;">
                                <!-- Services will be loaded here -->
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple services</div>
                        </div>

                        <!-- Discount Percentage -->
                        <div class="col-md-6">
                            <label for="editStudentDiscountPercentage" class="form-label">Discount Percentage *</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editStudentDiscountPercentage" 
                                       name="discount_percentage" min="1" max="100" step="0.1" required>
                                <span class="input-group-text">%</span>
                            </div>
                        </div>

                        <!-- Valid Days -->
                        <div class="col-md-6">
                            <label for="editStudentValidDays" class="form-label">Valid Days</label>
                            <select class="form-select" id="editStudentValidDays" name="valid_days">
                                <option value="Mon-Fri">Monday - Friday</option>
                                <option value="Mon-Sat">Monday - Saturday</option>
                                <option value="All Days">All Days</option>
                                <option value="Weekends">Weekends Only</option>
                                <option value="Custom">Custom</option>
                            </select>
                        </div>

                        <!-- Custom Valid Days (hidden by default) -->
                        <div class="col-12" id="editCustomValidDaysDiv" style="display: none;">
                            <label for="editCustomValidDays" class="form-label">Custom Valid Days</label>
                            <input type="text" class="form-control" id="editCustomValidDays" 
                                   placeholder="e.g., Mon, Wed, Fri">
                        </div>

                        <!-- Valid From Date -->
                        <div class="col-md-6">
                            <label for="editStudentValidFrom" class="form-label">Valid From *</label>
                            <input type="date" class="form-control" id="editStudentValidFrom" 
                                   name="valid_from" required>
                        </div>

                        <!-- Valid To Date -->
                        <div class="col-md-6">
                            <label for="editStudentValidTo" class="form-label">Valid To *</label>
                            <input type="date" class="form-control" id="editStudentValidTo" 
                                   name="valid_to" required>
                        </div>

                        <!-- Conditions -->
                        <div class="col-12">
                            <label for="editStudentConditions" class="form-label">Conditions</label>
                            <textarea class="form-control" id="editStudentConditions" name="conditions" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="updateStudentOffer">
                    <i class="fas fa-save me-2"></i>Update Student Offer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Kitty Party Modal -->
<div class="modal fade" id="addKittyPartyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-birthday-cake me-2"></i>Add Kitty Party Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addKittyPartyForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Party Name *</label>
                            <input type="text" id="kittyPartyName" name="name" class="form-control" required placeholder="e.g., Birthday Bash Package">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" id="kittyPrice" name="price" class="form-control" required step="0.01" min="0" placeholder="5000">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">After Value</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" id="kittyAfterValue" name="after_value" class="form-control" step="0.01" min="0" placeholder="6000">
                            </div>
                            <small class="text-muted">Value after package discount</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Minimum Guests *</label>
                            <input type="number" id="kittyMinGuests" name="min_guests" class="form-control" required min="1" placeholder="10">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Valid From</label>
                            <input type="date" id="kittyValidFrom" name="valid_from" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Valid To</label>
                            <input type="date" id="kittyValidTo" name="valid_to" class="form-control">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Services Included *</label>
                        <select id="kittyPartyServices" name="service_ids" class="form-select" multiple required size="6">
                            <!-- Services will be loaded dynamically -->
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple services</div>
                        <div class="invalid-feedback">Please select at least one service for this kitty party</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Conditions</label>
                        <textarea id="kittyConditions" name="conditions" class="form-control" rows="3" placeholder="e.g., Applicable only on weekdays, requires 24-hour advance booking"></textarea>
                        <small class="text-muted">Optional terms and conditions</small>
                    </div>

                    <!-- Preview Section -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading mb-2">
                            <i class="fas fa-eye me-2"></i>Package Preview
                        </h6>
                        <div id="kittyPartyPreview">
                            <p class="text-muted">Fill in party details to see preview</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveKittyParty" disabled>Save Kitty Party</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Kitty Party Modal -->
<div class="modal fade" id="editKittyPartyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Kitty Party Package
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editKittyPartyForm">
                    <input type="hidden" id="editPartyId" name="party_id">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Party Name *</label>
                            <input type="text" id="editKittyPartyName" name="name" class="form-control" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price *</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" id="editKittyPrice" name="price" class="form-control" required step="0.01" min="0">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">After Value</label>
                            <div class="input-group">
                                <span class="input-group-text">₹</span>
                                <input type="number" id="editKittyAfterValue" name="after_value" class="form-control" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Minimum Guests *</label>
                            <input type="number" id="editKittyMinGuests" name="min_guests" class="form-control" required min="1">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Valid From</label>
                            <input type="date" id="editKittyValidFrom" name="valid_from" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Valid To</label>
                            <input type="date" id="editKittyValidTo" name="valid_to" class="form-control">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Services Included *</label>
                        <select id="editKittyPartyServices" name="service_ids" class="form-select" multiple required size="6">
                            <!-- Services will be loaded dynamically -->
                        </select>
                        <div class="form-text">Hold Ctrl/Cmd to select multiple services</div>
                        <div class="invalid-feedback">Please select at least one service for this kitty party</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Conditions</label>
                        <textarea id="editKittyConditions" name="conditions" class="form-control" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="updateKittyParty">Update Kitty Party</button>
            </div>
        </div>
    </div>
</div>

<!-- Include JavaScript -->
<script src="{{ url_for('static', filename='js/packages.js') }}"></script>

<script>
// Enhanced Package Assignment System JavaScript
let allPackageTypes = {};
let selectedCustomerForAssignment = null;

document.addEventListener('DOMContentLoaded', function() {
    initializeEnhancedPackages();
});

async function initializeEnhancedPackages() {
    try {
        // Load all package types and customers
        await Promise.all([
            loadAllPackageTypes(),
            loadCustomersForAllTabs(),
            loadAllPackageAssignments() // Load existing assignments
        ]);

        console.log('Enhanced package assignment system initialized');
    } catch (error) {
        console.error('Error initializing enhanced packages:', error);
    }
}

async function loadAllPackageAssignments() {
    try {
        const response = await fetch('/packages/api/all-assignments');
        const data = await response.json();

        if (data.success) {
            const tableBody = document.getElementById('packagesTableBody');
            document.getElementById('all-count').textContent = data.total_assignments;

            if (data.assignments.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="fas fa-gift fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Package Assignments Found</h5>
                            <p class="text-muted">Start assigning packages to customers to see them here.</p>
                        </td>
                    </tr>
                `;
            } else {
                tableBody.innerHTML = data.assignments.map(assignment => {
                    const statusBadge = getStatusBadge(assignment.status);

                    let totalInfo, usedInfo, remainingInfo, progressBar;

                    if (assignment.package_type === 'service_package') {
                        totalInfo = `${assignment.total_sessions} sessions`;
                        usedInfo = `${assignment.used_sessions} sessions`;
                        remainingInfo = `${assignment.remaining_sessions} sessions`;
                        const progress = assignment.total_sessions > 0 ? (assignment.used_sessions / assignment.total_sessions) * 100 : 0;
                        progressBar = `
                            <div class="progress mb-1" style="height: 20px;">
                                <div class="progress-bar" style="width: ${progress}%">${Math.round(progress)}%</div>
                            </div>
                        `;
                    } else if (assignment.package_type === 'prepaid') {
                        totalInfo = `₹${assignment.credit_amount}`;
                        usedInfo = `₹${assignment.used_credit}`;
                        remainingInfo = `₹${assignment.remaining_credit}`;
                        const progress = assignment.credit_amount > 0 ? (assignment.used_credit / assignment.credit_amount) * 100 : 0;
                        progressBar = `
                            <div class="progress mb-1" style="height: 20px;">
                                <div class="progress-bar" style="width: ${progress}%">${Math.round(progress)}%</div>
                            </div>
                        `;
                    } else {
                        totalInfo = 'Membership';
                        usedInfo = '-';
                        remainingInfo = 'Active';
                        progressBar = '<span class="text-muted">Membership</span>';
                    }

                    return `
                        <tr>
                            <td>
                                <strong>${assignment.customer_name}</strong><br>
                                <small class="text-muted">${assignment.customer_phone}</small>
                            </td>
                            <td>
                                <strong>${assignment.package_name}</strong><br>
                                <span class="badge bg-secondary">${assignment.package_type.replace('_', ' ').toUpperCase()}</span>
                            </td>
                            <td>
                                <strong>Assigned:</strong> ${assignment.assigned_on}<br>
                                <strong>Expires:</strong> ${assignment.expires_on}
                            </td>
                            <td>${totalInfo}</td>
                            <td>${usedInfo}</td>
                            <td>${remainingInfo}</td>
                            <td>${progressBar}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="window.viewAssignmentDetails(${assignment.assignment_id})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="window.viewCustomerDetails(${assignment.customer_id})" title="View Customer">
                                        <i class="fas fa-user"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Update assignment counts in package cards
            await updatePackageAssignmentCounts();
        }
    } catch (error) {
        console.error('Error loading package assignments:', error);
        document.getElementById('packagesTableBody').innerHTML = `
            <tr>
                <td colspan="9" class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <h5>Error Loading Assignments</h5>
                    <p>Please refresh the page to try again.</p>
                </td>
            </tr>
        `;
    }
}

async function updatePackageAssignmentCounts() {
    // Update the "View Assigned" button counts for each package card
    try {
        const packageTypes = ['prepaid', 'service', 'membership', 'student', 'yearly', 'kitty'];

        for (const type of packageTypes) {
            if (allPackageTypes[type]) {
                for (const pkg of allPackageTypes[type]) {
                    try {
                        const response = await fetch(`/packages/api/assigned-customers/${type === 'service' ? 'service_package' : type}/${pkg.id}`);
                        const data = await response.json();

                        if (data.success) {
                            // Update the count in the button
                            const button = document.querySelector(`button[onclick*="viewAssignedCustomers('${pkg.id}', '${type === 'service' ? 'service_package' : type}'"]`);
                            if (button) {
                                button.innerHTML = `<i class="fas fa-users me-2"></i>View Assigned (${data.total_assignments})`;
                            }
                        }
                    } catch (error) {
                        console.error(`Error loading count for ${type} package ${pkg.id}:`, error);
                    }
                }
            }
        }
    } catch (error) {
        console.error('Error updating package assignment counts:', error);
    }
}

async function loadAllPackageTypes() {
    try {
        // Load all package types
        const endpoints = [
            { key: 'prepaid', url: '/api/prepaid-packages' },
            { key: 'service', url: '/api/service-packages' },
            { key: 'membership', url: '/api/memberships' },
            { key: 'student', url: '/api/student-offers' },
            { key: 'yearly', url: '/api/yearly-memberships' },
            { key: 'kitty', url: '/api/kitty-parties' }
        ];

        for (const endpoint of endpoints) {
            const response = await fetch(endpoint.url);
            const data = await response.json();
            allPackageTypes[endpoint.key] = data.success ? data[endpoint.key] || data.packages || data.memberships || data.offers || data.parties || [] : [];

            // Update counts
            const countElement = document.getElementById(`${endpoint.key}-available`);
            if (countElement) {
                countElement.textContent = allPackageTypes[endpoint.key].length;
            }

            const totalCountElement = document.getElementById(`${endpoint.key}-total-count`);
            if (totalCountElement) {
                totalCountElement.textContent = allPackageTypes[endpoint.key].length;
            }
        }

        // Render package cards for each type
        renderPackageCards();

    } catch (error) {
        console.error('Error loading package types:', error);
    }
}

async function loadCustomersForAllTabs() {
    try {
        const response = await fetch('/packages/api/customers');
        const data = await response.json();

        if (data.success) {
            const customers = data.customers;

            // Populate all customer dropdowns
            const customerSelects = [
                'prepaidCustomerSelect', 'serviceCustomerSelect', 'membershipCustomerSelect',
                'studentCustomerSelect', 'yearlyCustomerSelect', 'kittyCustomerSelect',
                'assignmentCustomer'
            ];

            customerSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Choose customer...</option>';
                    customers.forEach(customer => {
                        const option = document.createElement('option');
                        option.value = customer.id;
                        option.textContent = `${customer.name} - ${customer.phone}`;
                        select.appendChild(option);
                    });
                }
            });
        }
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

function renderPackageCards() {
    const packageTypes = ['prepaid', 'service', 'membership', 'student', 'yearly', 'kitty'];

    packageTypes.forEach(type => {
        const container = document.getElementById(`${type}PackagesContainer`);
        if (!container || !allPackageTypes[type]) return;

        container.innerHTML = allPackageTypes[type].map(pkg => createPackageCard(pkg, type)).join('');
    });
}

function createPackageCard(pkg, type) {
    const typeConfig = {
        prepaid: { 
            icon: 'fas fa-credit-card', 
            color: 'success',
            priceField: 'actual_price',
            valueField: 'after_value'
        },
        service: { 
            icon: 'fas fa-spa', 
            color: 'info',
            priceField: 'pay_for',
            valueField: 'total_services'
        },
        membership: { 
            icon: 'fas fa-id-card', 
            color: 'warning',
            priceField: 'price',
            valueField: 'validity_months'
        },
        student: { 
            icon: 'fas fa-graduation-cap', 
            color: 'secondary',
            priceField: 'actual_price',
            valueField: 'after_price'
        },
        yearly: { 
            icon: 'fas fa-calendar-alt', 
            color: 'dark',
            priceField: 'price',
            valueField: 'validity_months'
        },
        kitty: { 
            icon: 'fas fa-users', 
            color: 'danger',
            priceField: 'price',
            valueField: 'min_guests'
        }
    };

    const config = typeConfig[type];
    const price = pkg[config.priceField] || 0;
    const value = pkg[config.valueField] || 0;

    return `
        <div class="col-md-6 mb-3">
            <div class="card package-card" onclick="selectPackageForAssignment('${pkg.id}', '${type}', ${JSON.stringify(pkg).replace(/"/g, '&quot;')})">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h5 class="card-title">
                            <i class="${config.icon} text-${config.color} me-2"></i>
                            ${pkg.name}
                        </h5>
                        <span class="badge bg-${config.color} badge-large">₹${price}</span>
                    </div>

                    <div class="row g-2 mb-3">
                        ${type === 'prepaid' ? `
                            <div class="col-6">
                                <small class="text-muted">Pay Amount</small>
                                <div class="fw-bold">₹${pkg.actual_price}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Get Value</small>
                                <div class="fw-bold text-success">₹${pkg.after_value}</div>
                            </div>
                        ` : type === 'service' ? `
                            <div class="col-6">
                                <small class="text-muted">Pay For</small>
                                <div class="fw-bold">${pkg.pay_for} services</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Total Get</small>
                                <div class="fw-bold text-success">${pkg.total_services} services</div>
                            </div>
                        ` : type === 'membership' ? `
                            <div class="col-6">
                                <small class="text-muted">Price</small>
                                <div class="fw-bold">₹${pkg.price}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Validity</small>
                                <div class="fw-bold">${pkg.validity_months} months</div>
                            </div>
                        ` : type === 'student' ? `
                            <div class="col-6">
                                <small class="text-muted">Actual Price</small>
                                <div class="fw-bold">₹${pkg.actual_price}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">After Discount</small>
                                <div class="fw-bold text-success">₹${pkg.after_price}</div>
                            </div>
                        ` : type === 'yearly' ? `
                            <div class="col-6">
                                <small class="text-muted">Price</small>
                                <div class="fw-bold">₹${pkg.price}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Discount</small>
                                <div class="fw-bold text-success">${pkg.discount_percent}%</div>
                            </div>
                        ` : `
                            <div class="col-6">
                                <small class="text-muted">Price</small>
                                <div class="fw-bold">₹${pkg.price}</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Min Guests</small>
                                <div class="fw-bold">${pkg.min_guests}</div>
                            </div>
                        `}
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-${config.color}">
                            <i class="fas fa-user-plus me-2"></i>Assign to Customer
                        </button>
                        <button type="button" class="btn btn-outline-${config.color} btn-sm" 
                                onclick="viewAssignedCustomers('${pkg.id}', '${type}', '${pkg.name}')">
                            <i class="fas fa-users me-2"></i>View Assigned (0)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function selectPackageForAssignment(packageId, packageType, packageData) {
    // Show the assignment modal
    const modal = new bootstrap.Modal(document.getElementById('packageAssignmentModal'));

    // Update modal title
    const modalTitle = document.getElementById('assignmentModalTitle');
    modalTitle.innerHTML = `<i class="fas fa-gift text-primary me-2"></i>Assign ${packageData.name}`;

    // Set hidden fields
    document.getElementById('selectedPackageId').value = packageId;
    document.getElementById('selectedPackageType').value = packageType;

    // Set default price
    const priceField = document.getElementById('assignmentPrice');
    const price = packageData.price || packageData.actual_price || packageData.after_price || 0;
    priceField.value = price;

    // Show package details
    const detailsContainer = document.getElementById('selectedPackageDetails');
    detailsContainer.innerHTML = createPackageDetailsPreview(packageData, packageType);

    // Pre-select customer if one is selected in the tab
    const activeTab = document.querySelector('.tab-pane.active');
    if (activeTab) {
        const customerSelect = activeTab.querySelector('select[id$="CustomerSelect"]');
        if (customerSelect && customerSelect.value) {
            document.getElementById('assignmentCustomer').value = customerSelect.value;
        }
    }

    modal.show();
}

function createPackageDetailsPreview(pkg, type) {
    return `
        <div class="row g-3">
            <div class="col-md-6">
                <strong>Package Name:</strong><br>
                <span class="text-primary">${pkg.name}</span>
            </div>
            <div class="col-md-6">
                <strong>Package Type:</strong><br>
                <span class="badge bg-secondary">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
            </div>
            ${type === 'prepaid' ? `
                <div class="col-md-4">
                    <strong>Pay Amount:</strong><br>
                    ₹${pkg.actual_price}
                </div>
                <div class="col-md-4">
                    <strong>Get Value:</strong><br>
                    <span class="text-success">₹${pkg.after_value}</span>
                </div>
                <div class="col-md-4">
                    <strong>Savings:</strong><br>
                    <span class="text-success">₹${pkg.money_saved || 0}</span>
                </div>
            ` : type === 'service' ? `
                <div class="col-md-4">
                    <strong>Pay For:</strong><br>
                    ${pkg.pay_for} services
                </div>
                <div class="col-md-4">
                    <strong>Total Get:</strong><br>
                    <span class="text-success">${pkg.total_services} services</span>
                </div>
                <div class="col-md-4">
                    <strong>Free Services:</strong><br>
                    <span class="text-success">${pkg.free_services || 0}</span>
                </div>
            ` : `
                <div class="col-12">
                    <strong>Description:</strong><br>
                    <span class="text-muted">${pkg.description || pkg.services_included || 'No description available'}</span>
                </div>
            `}
        </div>
    `;
}

// Save package assignment
document.getElementById('savePackageAssignment').addEventListener('click', async function() {
    const form = document.getElementById('packageAssignmentForm');
    const formData = new FormData(form);

    const data = {
        package_id: formData.get('package_id'),
        package_type: formData.get('package_type'),
        customer_id: parseInt(formData.get('customer_id')),
        price_paid: parseFloat(formData.get('price_paid')),
        discount: parseFloat(formData.get('discount')) || 0,
        notes: formData.get('notes')
    };

    if (formData.get('expires_on')) {
        data.expires_on = formData.get('expires_on') + 'T23:59:59';
    }

    try {
        const response = await fetch('/packages/api/assign', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            showToast('Package assigned successfully!', 'success');

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('packageAssignmentModal'));
            modal.hide();

            // Reload the assignments
            await loadPackages();

            // Update counts
            updateAssignmentCounts();

        } else {
            showToast(result.error || 'Error assigning package', 'error');
        }
    } catch (error) {
        console.error('Error assigning package:', error);
        showToast('Error assigning package', 'error');
    }
});

// Function to view assigned customers for a specific package
async function viewAssignedCustomers(packageId, packageType, packageName) {
    try {
        const response = await fetch(`/packages/api/assigned-customers/${packageType}/${packageId}`);
        const data = await response.json();

        if (data.success) {
            // Update modal title and package info
            document.getElementById('assignedCustomersModalTitle').innerHTML = 
                `<i class="fas fa-users text-primary me-2"></i>Customers Assigned to "${packageName}"`;
            document.getElementById('assignedPackageName').textContent = data.package_name;
            document.getElementById('assignedPackageType').textContent = packageType.charAt(0).toUpperCase() + packageType.slice(1);
            document.getElementById('assignedCustomersCount').textContent = data.total_assignments;

            const tableBody = document.getElementById('assignedCustomersTableBody');
            const noCustomersDiv = document.getElementById('noAssignedCustomers');

            if (data.customers.length === 0) {
                tableBody.innerHTML = '';
                noCustomersDiv.style.display = 'block';
            } else {
                noCustomersDiv.style.display = 'none';

                tableBody.innerHTML = data.customers.map(customer => {
                    let progressInfo = '';
                    if (customer.remaining_sessions !== null) {
                        const totalSessions = customer.remaining_sessions + (customer.used_sessions || 0);
                        const progress = totalSessions > 0 ? ((customer.used_sessions || 0) / totalSessions) * 100 : 0;
                        progressInfo = `
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" style="width: ${progress}%">${Math.round(progress)}%</div>
                            </div>
                            <small class="text-muted">${customer.used_sessions || 0}/${totalSessions} sessions</small>
                        `;
                    } else if (customer.remaining_credit !== null) {
                        const totalCredit = customer.remaining_credit + (customer.used_credit || 0);
                        const progress = totalCredit > 0 ? ((customer.used_credit || 0) / totalCredit) * 100 : 0;
                        progressInfo = `
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar" style="width: ${progress}%">${Math.round(progress)}%</div>
                            </div>
                            <small class="text-muted">₹${customer.used_credit || 0}/₹${totalCredit} used</small>
                        `;
                    } else {
                        progressInfo = '<span class="text-muted">Membership</span>';
                    }

                    const statusBadge = getStatusBadge(customer.status);

                    return `
                        <tr>
                            <td>
                                <strong>${customer.customer_name}</strong><br>
                                <small class="text-muted">ID: ${customer.customer_id}</small>
                            </td>
                            <td>${customer.customer_phone}</td>
                            <td>${customer.assigned_on}</td>
                            <td>${customer.expires_on}</td>
                            <td>₹${customer.price_paid}${customer.discount > 0 ? `<br><small class="text-success">-₹${customer.discount} discount</small>` : ''}</td>
                            <td>${progressInfo}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="window.viewCustomerDetails(${customer.customer_id})" title="View Customer">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="window.viewAssignmentDetails(${customer.assignment_id})" title="View Assignment">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('assignedCustomersModal'));
            modal.show();

        } else {
            showToast(data.error || 'Error loading assigned customers', 'error');
        }
    } catch (error) {
        console.error('Error loading assigned customers:', error);
        showToast('Error loading assigned customers', 'error');
    }
}

function getStatusBadge(status) {
    const statusMap = {
        'active': 'bg-success',
        'completed': 'bg-primary',
        'expired': 'bg-warning text-dark',
        'cancelled': 'bg-danger',
        'paused': 'bg-secondary'
    };

    const badgeClass = statusMap[status] || 'bg-secondary';
    return `<span class="badge ${badgeClass}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;
}

function clearAssignedFilters() {
    document.getElementById('assignedCustomersSearch').value = '';
    document.getElementById('assignedStatusFilter').value = '';
    // Reload the table without filters
    // This would need to be implemented based on current modal state
}

function filterAssignedCustomers() {
    // Implement client-side filtering of the displayed table
    const searchTerm = document.getElementById('assignedCustomersSearch').value.toLowerCase();
    const statusFilter = document.getElementById('assignedStatusFilter').value;

    const rows = document.querySelectorAll('#assignedCustomersTableBody tr');
    rows.forEach(row => {
        const customerName = row.cells[0].textContent.toLowerCase();
        const customerPhone = row.cells[1].textContent.toLowerCase();
        const status = row.cells[6].textContent.toLowerCase();

        const matchesSearch = !searchTerm || customerName.includes(searchTerm) || customerPhone.includes(searchTerm);
        const matchesStatus = !statusFilter || status.includes(statusFilter.toLowerCase());

        if (matchesSearch && matchesStatus) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function openAssignToPackage() {
    // Close current modal and open assignment modal
    const currentModal = bootstrap.Modal.getInstance(document.getElementById('assignedCustomersModal'));
    currentModal.hide();

    // Open assignment modal with current package pre-selected
    openAssignModal();
}

function updateAssignmentCounts() {
    // This function would update the counts of assigned packages
    // Implementation depends on your backend API structure
}

// Quick assign modal function
function openQuickAssignModal() {
    openAssignModal();
}

// Placeholder for loadKittyPackages function
function loadKittyPackages() {
    // Implement logic to fetch and display kitty party packages if not already loaded
    // This might involve populating the #kittyPackagesContainer
    if (allPackageTypes['kitty'] && allPackageTypes['kitty'].length > 0 && !document.getElementById('kittyPackagesContainer').innerHTML.trim()) {
        renderPackageCards(); // Ensure cards are rendered if not already
    } else if (!allPackageTypes['kitty'] || allPackageTypes['kitty'].length === 0) {
        console.log("No Kitty Parties loaded or available.");
    }
}

console.log('Enhanced customer package assignment system loaded');
</script>

{% endblock %}