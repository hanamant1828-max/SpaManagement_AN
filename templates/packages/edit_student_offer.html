
{% extends "base.html" %}

{% block title %}Edit Student Offer - Spa & Salon Suite{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-gray-800">
                        <i class="fas fa-graduation-cap text-primary me-2"></i>Edit Student Offer
                    </h1>
                    <p class="text-muted mb-0">Modify student discount offer details</p>
                </div>
                <div>
                    <a href="{{ url_for('packages') }}#assign-student" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Packages
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Student Offer Details</h5>
                </div>
                <div class="card-body">
                    <form id="editStudentOfferForm" novalidate>
                        <input type="hidden" id="offerId" name="offer_id" value="{{ offer.id }}">

                        <!-- Basic Details Section -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="offerName" class="form-label">Offer Name *</label>
                                <input type="text" class="form-control" id="offerName" 
                                       name="offer_name" placeholder="e.g., Student Special Discount"
                                       value="{{ offer.name or '' }}" required>
                                <div id="offerNameError" class="invalid-feedback"></div>
                            </div>

                            <div class="col-md-6">
                                <label for="validityDays" class="form-label">Valid Days</label>
                                <select class="form-select" id="validityDays" name="valid_days">
                                    <option value="Mon-Fri" {% if offer.valid_days == 'Mon-Fri' %}selected{% endif %}>Monday to Friday</option>
                                    <option value="Mon-Sat" {% if offer.valid_days == 'Mon-Sat' %}selected{% endif %}>Monday to Saturday</option>
                                    <option value="All Days" {% if offer.valid_days == 'All Days' %}selected{% endif %}>All Days</option>
                                    <option value="Weekends" {% if offer.valid_days == 'Weekends' %}selected{% endif %}>Weekends Only</option>
                                </select>
                            </div>
                        </div>

                        <!-- Price and Discount Section -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="packagePrice" class="form-label">Package Price (₹) *</label>
                                <input type="number" class="form-control" id="packagePrice" 
                                       name="price" required min="0" step="0.01"
                                       value="{{ offer.price or 0 }}" placeholder="500">
                                <div id="priceError" class="invalid-feedback"></div>
                            </div>

                            <div class="col-md-6">
                                <label for="discountPercentage" class="form-label">Discount Percentage *</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="discountPercentage" 
                                           name="discount_percentage" required min="1" max="100" step="0.1"
                                           value="{{ offer.discount_percentage }}" placeholder="25">
                                    <span class="input-group-text">%</span>
                                </div>
                                <div id="discountError" class="invalid-feedback"></div>
                            </div>
                        </div>

                        <!-- Validity Period Section -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label for="validFrom" class="form-label">Valid From *</label>
                                <input type="date" class="form-control" id="validFrom" 
                                       name="valid_from" required 
                                       value="{{ offer.valid_from.strftime('%Y-%m-%d') if offer.valid_from else '' }}">
                                <div id="validFromError" class="invalid-feedback"></div>
                            </div>

                            <div class="col-md-6">
                                <label for="validTo" class="form-label">Valid Until *</label>
                                <input type="date" class="form-control" id="validTo" 
                                       name="valid_to" required
                                       value="{{ offer.valid_to.strftime('%Y-%m-%d') if offer.valid_to else '' }}">
                                <div id="validToError" class="invalid-feedback"></div>
                            </div>
                        </div>

                        <!-- Active Status -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActive" 
                                       name="is_active" {% if offer.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="isActive">
                                    <strong>Active Offer</strong>
                                    <br><small class="text-muted">Available for new bookings</small>
                                </label>
                            </div>
                        </div>

                        <!-- Description Section -->
                        <div class="mb-4">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="3" placeholder="Describe the offer benefits and terms...">{{ offer.conditions or 'Valid with Student ID only. Cannot be combined with other offers.' }}</textarea>
                            <div class="form-text">Optional description for this student offer</div>
                        </div>

                        <!-- Services Summary Section -->
                        <div class="mb-4">
                            <label class="form-label">Services Summary</label>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div id="servicesSummary" class="text-muted">
                                        {% if offer.student_offer_services %}
                                            {{ offer.student_offer_services|map(attribute='service.name')|join(', ') }}
                                        {% else %}
                                            No services selected yet
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Included Services Section -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-check-circle text-success me-2"></i>Included Services *
                                <small class="text-muted">(Select specific services covered by this offer)</small>
                            </label>
                            <div class="card">
                                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                    <div id="servicesContainer">
                                        {% for service in services %}
                                        <div class="form-check mb-2">
                                            <input class="form-check-input service-checkbox" type="checkbox" 
                                                   value="{{ service.id }}" id="service_{{ service.id }}" 
                                                   name="service_ids"
                                                   {% if service.id in offer.student_offer_services|map(attribute='service_id')|list %}checked{% endif %}>
                                            <label class="form-check-label" for="service_{{ service.id }}">
                                                <strong>{{ service.name }}</strong> - ₹{{ service.price }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div id="servicesError" class="invalid-feedback"></div>
                            <div class="form-text mt-2">Select at least one service for this offer</div>
                        </div>

                        <!-- Form Error Display -->
                        <div id="editStudentOfferFormError" class="alert alert-danger" style="display: none;"></div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('packages') }}#assign-student" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-primary" id="updateStudentOfferBtn">
                                <i class="fas fa-save me-2"></i>Update Student Offer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('editStudentOfferForm');
    const updateBtn = document.getElementById('updateStudentOfferBtn');
    
    // Update services summary on checkbox change
    document.querySelectorAll('.service-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateServicesSummary);
    });
    
    function updateServicesSummary() {
        const selectedServices = [];
        document.querySelectorAll('.service-checkbox:checked').forEach(cb => {
            const label = document.querySelector(`label[for="${cb.id}"]`);
            if (label) {
                selectedServices.push(label.textContent.trim().split(' - ')[0]);
            }
        });
        
        const summaryDiv = document.getElementById('servicesSummary');
        if (selectedServices.length > 0) {
            summaryDiv.textContent = selectedServices.join(', ');
            summaryDiv.classList.remove('text-muted');
        } else {
            summaryDiv.textContent = 'No services selected yet';
            summaryDiv.classList.add('text-muted');
        }
    }
    
    // Form validation
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Clear previous errors
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
        document.getElementById('editStudentOfferFormError').style.display = 'none';
        
        // Validate
        let isValid = true;
        const errors = [];
        
        const offerName = document.getElementById('offerName');
        const packagePrice = document.getElementById('packagePrice');
        const discountPercentage = document.getElementById('discountPercentage');
        const validFrom = document.getElementById('validFrom');
        const validTo = document.getElementById('validTo');
        const selectedServices = document.querySelectorAll('.service-checkbox:checked');
        
        if (!offerName.value.trim()) {
            offerName.classList.add('is-invalid');
            errors.push('Offer name is required');
            isValid = false;
        }
        
        if (!packagePrice.value || parseFloat(packagePrice.value) < 0) {
            packagePrice.classList.add('is-invalid');
            errors.push('Valid package price is required');
            isValid = false;
        }
        
        if (!discountPercentage.value || parseFloat(discountPercentage.value) < 1 || parseFloat(discountPercentage.value) > 100) {
            discountPercentage.classList.add('is-invalid');
            errors.push('Discount percentage must be between 1 and 100');
            isValid = false;
        }
        
        if (!validFrom.value) {
            validFrom.classList.add('is-invalid');
            errors.push('Valid From date is required');
            isValid = false;
        }
        
        if (!validTo.value) {
            validTo.classList.add('is-invalid');
            errors.push('Valid Until date is required');
            isValid = false;
        }
        
        if (validFrom.value && validTo.value && new Date(validTo.value) < new Date(validFrom.value)) {
            validTo.classList.add('is-invalid');
            errors.push('Valid Until must be after Valid From');
            isValid = false;
        }
        
        if (selectedServices.length === 0) {
            document.getElementById('servicesError').textContent = 'Select at least one service';
            document.getElementById('servicesError').style.display = 'block';
            errors.push('At least one service must be selected');
            isValid = false;
        }
        
        if (!isValid) {
            const errorDiv = document.getElementById('editStudentOfferFormError');
            errorDiv.innerHTML = errors.join('<br>');
            errorDiv.style.display = 'block';
            return;
        }
        
        // Submit form
        updateBtn.disabled = true;
        updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
        
        try {
            const formData = new FormData(form);
            
            // Get the package price - ensure it's a valid number
            const price = parseFloat(formData.get('price'));
            if (isNaN(price) || price < 0) {
                throw new Error('Please enter a valid package price');
            }
            
            const data = {
                name: formData.get('offer_name'),
                price: price,
                discount_percentage: parseFloat(formData.get('discount_percentage')),
                valid_from: formData.get('valid_from'),
                valid_to: formData.get('valid_to'),
                valid_days: formData.get('valid_days'),
                conditions: formData.get('description'),
                is_active: formData.get('is_active') === 'on',
                service_ids: Array.from(selectedServices).map(cb => parseInt(cb.value))
            };
            
            console.log('Sending update data:', data);
            
            const offerId = document.getElementById('offerId').value;
            const response = await fetch(`/packages/api/student-offers/${offerId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            console.log('Response status:', response.status);
            
            // Handle non-JSON responses
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                console.error('Non-JSON response:', text);
                throw new Error('Server returned an invalid response. Please check the console for details.');
            }
            
            const result = await response.json();
            console.log('Update result:', result);
            
            if (result.success || response.ok) {
                alert('Student offer updated successfully!');
                window.location.href = "{{ url_for('packages') }}#assign-student";
            } else {
                throw new Error(result.error || 'Failed to update student offer');
            }
        } catch (error) {
            console.error('Error updating student offer:', error);
            const errorDiv = document.getElementById('editStudentOfferFormError');
            errorDiv.textContent = 'Error updating student offer: ' + error.message;
            errorDiv.style.display = 'block';
        } finally {
            updateBtn.disabled = false;
            updateBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Student Offer';
        }
    });
});
</script>
{% endblock %}
