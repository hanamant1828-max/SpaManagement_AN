{% extends "base.html" %}

{% block title %}Create Package - Step 4: Review & Save{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Progress Steps -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="step-progress">
                                <div class="step-progress-item completed">
                                    <div class="step-progress-icon">✓</div>
                                    <div class="step-progress-text">Basic Info</div>
                                </div>
                                <div class="step-progress-item completed">
                                    <div class="step-progress-icon">✓</div>
                                    <div class="step-progress-text">Select Services</div>
                                </div>
                                <div class="step-progress-item completed">
                                    <div class="step-progress-icon">✓</div>
                                    <div class="step-progress-text">Pricing</div>
                                </div>
                                <div class="step-progress-item active">
                                    <div class="step-progress-icon">4</div>
                                    <div class="step-progress-text">Review & Save</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4 Review -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title mb-0">
                                <i class="fas fa-check-circle text-primary"></i>
                                Step 4: Review & Save Package
                            </h4>
                            <p class="card-subtitle text-muted mt-2">Review all details before creating your package</p>
                        </div>
                        <div class="card-body">
                            
                            <!-- Package Summary -->
                            <div class="row mb-4">
                                <div class="col-lg-8">
                                    <div class="card bg-light">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">Package Summary</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <strong>Package Name:</strong>
                                                    <p class="mb-0">{{ creation_data.get('name', 'N/A') }}</p>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Package Type:</strong>
                                                    <span class="badge bg-primary">{{ creation_data.get('package_type', 'regular').replace('_', ' ').title() }}</span>
                                                </div>
                                            </div>
                                            
                                            {% if creation_data.get('description') %}
                                            <div class="mb-3">
                                                <strong>Description:</strong>
                                                <p class="mb-0">{{ creation_data.get('description') }}</p>
                                            </div>
                                            {% endif %}

                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Validity:</strong>
                                                    <p class="mb-0">{{ creation_data.get('validity_days', 90) }} days 
                                                        <small class="text-muted">({{ (creation_data.get('validity_days', 90) / 30)|round(1) }} months)</small>
                                                    </p>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Total Sessions:</strong>
                                                    <p class="mb-0">{{ total_sessions }} sessions</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-4">
                                    <div class="card bg-primary text-white">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0 text-white">Pricing Details</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Original Price:</span>
                                                <span>₹{{ total_original_price|round(2) }}</span>
                                            </div>
                                            {% if creation_data.get('discount_percentage', 0) > 0 %}
                                            <div class="d-flex justify-content-between mb-2">
                                                <span>Package Discount:</span>
                                                <span>{{ creation_data.get('discount_percentage') }}%</span>
                                            </div>
                                            {% endif %}
                                            <hr class="my-2" style="border-color: rgba(255,255,255,0.3);">
                                            <div class="d-flex justify-content-between">
                                                <strong>Final Price:</strong>
                                                <strong>₹{{ creation_data.get('total_price', 0)|round(2) }}</strong>
                                            </div>
                                            {% if total_original_price > creation_data.get('total_price', 0) %}
                                            <div class="text-center mt-2">
                                                <small>You save ₹{{ (total_original_price - creation_data.get('total_price', 0))|round(2) }}</small>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Services Breakdown -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">Services Included</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Service Name</th>
                                                            <th>Sessions</th>
                                                            <th>Price per Session</th>
                                                            <th>Discount</th>
                                                            <th>Total</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for service_detail in service_details %}
                                                        <tr>
                                                            <td>
                                                                <strong>{{ service_detail.service.name }}</strong>
                                                                {% if service_detail.service.description %}
                                                                <br><small class="text-muted">{{ service_detail.service.description[:60] }}...</small>
                                                                {% endif %}
                                                            </td>
                                                            <td>{{ service_detail.sessions }}</td>
                                                            <td>₹{{ service_detail.service.price }}</td>
                                                            <td>
                                                                {% if service_detail.discount > 0 %}
                                                                <span class="badge bg-success">{{ service_detail.discount }}% OFF</span>
                                                                {% else %}
                                                                <span class="text-muted">No discount</span>
                                                                {% endif %}
                                                            </td>
                                                            <td>
                                                                {% if service_detail.discount > 0 %}
                                                                <del class="text-muted">₹{{ service_detail.original_price|round(2) }}</del>
                                                                <br>
                                                                {% endif %}
                                                                <strong>₹{{ service_detail.discounted_price|round(2) }}</strong>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Package Settings -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">Package Settings</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <strong>Status:</strong>
                                                    {% if creation_data.get('is_active', True) %}
                                                    <span class="badge bg-success">Active</span>
                                                    {% else %}
                                                    <span class="badge bg-secondary">Inactive</span>
                                                    {% endif %}
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>Created By:</strong>
                                                    <span>{{ "test"first_name }} {{ "test"last_name }}</span>
                                                </div>
                                                <div class="col-md-4">
                                                    <strong>Creation Date:</strong>
                                                    <span>{{ moment().format('MMM D, YYYY') }}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Confirmation and Actions -->
                            <div class="row">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-info-circle"></i> Ready to Create Package
                                        </h6>
                                        <p class="mb-2">Please review all the details above. Once you create this package, it will be available for booking by clients.</p>
                                        <ul class="mb-0">
                                            <li>Package will be immediately available if set to "Active"</li>
                                            <li>You can edit package details later from the packages management page</li>
                                            <li>Service sessions will be tracked when clients book appointments</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <form method="POST" action="{{ url_for('package_creation_step_submit', step=4) }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <a href="{{ url_for('package_creation_step_back', step=4) }}" class="btn btn-secondary me-2">
                                            <i class="fas fa-arrow-left"></i> Back: Pricing
                                        </a>
                                        <a href="{{ url_for('package_creation_cancel') }}" class="btn btn-outline-danger">
                                            <i class="fas fa-times"></i> Cancel
                                        </a>
                                    </div>
                                    <div>
                                        <button type="submit" class="btn btn-success btn-lg">
                                            <i class="fas fa-save"></i> Create Package
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.step-progress {
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.step-progress::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 2px;
    background-color: #198754;
    z-index: 1;
}

.step-progress-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    z-index: 2;
}

.step-progress-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 8px;
}

.step-progress-item.active .step-progress-icon {
    background-color: #0d6efd;
    color: white;
}

.step-progress-item.completed .step-progress-icon {
    background-color: #198754;
    color: white;
}

.step-progress-text {
    font-size: 0.875rem;
    text-align: center;
    color: #6c757d;
}

.step-progress-item.active .step-progress-text,
.step-progress-item.completed .step-progress-text {
    color: #0d6efd;
    font-weight: 600;
}
</style>
{% endblock %}