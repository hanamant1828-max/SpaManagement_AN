got it ‚Äî you want your **Assign Package & Collect Payment** page to also include a **tabbed ‚ÄúAssigned Packages‚Äù view** (status-wise) right inside the same page.

Below is a **paste-ready prompt for Replit Assistance**. It wraps your existing assign form into **Tab 1**, and adds **Tab 2: Assigned Packages** with status tabs (All, Active, Expiring, Completed, Expired, Paused, Pending), a smart table, and a usage-history modal. It lazy-loads data only when that tab is opened.

---

## PROMPT FOR REPLIT ASSISTANCE

**Task:** On the `/assign-packages` page, add Bootstrap tabs:

* **Tab 1:** ‚ÄúAssign & Collect Payment‚Äù (contains the current form exactly as is)
* **Tab 2:** ‚ÄúAssigned Packages‚Äù (status tabs + table + usage modal)

Use existing APIs (or add if missing):

* `GET /packages/api/assignments?q=&status=&expiring_in=&page=&per_page=`
* `GET /packages/api/assignments/<id>/usage`

### 1) Template update (wrap current page in tabs)

In `templates/assign_packages.html`, replace the current page wrapper with the snippet below.
üëâ IMPORTANT: **Paste your existing ‚ÄúAssign Package & Collect Payment‚Äù form into the `<!-- TAB 1: PUT YOUR EXISTING FORM HERE -->` spot**.

```html
{% extends "base.html" %}
{% block title %}Assign Packages{% endblock %}

{% block extra_js %}
  <!-- keep your current js includes here (if any) -->
{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Top Tabs -->
  <ul class="nav nav-tabs" id="assignTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-assign-tab" data-bs-toggle="tab" data-bs-target="#tab-assign" type="button" role="tab">
        <i class="fas fa-receipt me-1"></i> Assign & Collect Payment
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-assigned-tab" data-bs-toggle="tab" data-bs-target="#tab-assigned" type="button" role="tab">
        <i class="fas fa-clipboard-list me-1"></i> Assigned Packages
      </button>
    </li>
  </ul>

  <div class="tab-content mt-3">
    <!-- TAB 1 -->
    <div class="tab-pane fade show active" id="tab-assign" role="tabpanel" aria-labelledby="tab-assign-tab">
      <!-- TAB 1: PUT YOUR EXISTING FORM HERE -->
      <!-- Keep ALL your current "Assign Package & Collect Payment" markup exactly as it is -->
    </div>

    <!-- TAB 2 -->
    <div class="tab-pane fade" id="tab-assigned" role="tabpanel" aria-labelledby="tab-assigned-tab">
      <div class="card">
        <div class="card-header">
          <div class="d-flex flex-wrap align-items-center justify-content-between">
            <h5 class="mb-2 mb-md-0"><i class="fas fa-clipboard-list me-2"></i>Assigned Packages</h5>
            <div class="input-group" style="max-width:360px;">
              <span class="input-group-text"><i class="fas fa-search"></i></span>
              <input id="apSearch" class="form-control" placeholder="Search customer / phone / package">
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- Status tabs -->
          <ul class="nav nav-pills mb-3" id="statusPills">
            <li class="nav-item"><button class="nav-link active" data-status="">All</button></li>
            <li class="nav-item"><button class="nav-link" data-status="active">Active</button></li>
            <li class="nav-item"><button class="nav-link" data-status="expiring" data-expiring="30">Expiring (30d)</button></li>
            <li class="nav-item"><button class="nav-link" data-status="completed">Completed</button></li>
            <li class="nav-item"><button class="nav-link" data-status="expired">Expired</button></li>
            <li class="nav-item"><button class="nav-link" data-status="paused">Paused</button></li>
            <li class="nav-item"><button class="nav-link" data-status="pending">Pending</button></li>
          </ul>

          <div class="table-responsive">
            <table class="table table-hover align-middle" id="apTable">
              <thead class="table-light">
                <tr>
                  <th>Customer</th>
                  <th>Package</th>
                  <th>Assigned</th>
                  <th>Expires</th>
                  <th>Status</th>
                  <th>Balance</th>
                  <th>Paid / Savings</th>
                  <th>Last Used</th>
                  <th style="width:140px;">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <div id="apInfo" class="small text-muted"></div>
            <nav><ul class="pagination pagination-sm mb-0" id="apPager"></ul></nav>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Usage History Modal -->
<div class="modal fade" id="apUsageModal" tabindex="-1">
  <div class="modal-dialog modal-lg"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="fas fa-history me-2"></i>Usage History</h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <div id="apUsageSummary" class="mb-3"></div>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr>
            <th>Date</th><th>Service</th><th>Type</th><th>Sessions</th><th>Amount</th><th>Invoice</th><th>User</th><th>Notes</th>
          </tr></thead>
          <tbody id="apUsageRows"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <a id="apExportUsage" target="_blank" class="btn btn-outline-secondary btn-sm">Export CSV</a>
      <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    </div>
  </div></div>
</div>
{% endblock %}
```

### 2) Page JS (inline or file)

Add this `<script>` at the **bottom** of the same template (inside `{% block content %}` after the modal) **or** place it into `static/js/assign_packages_tabview.js` and include it. It lazy-loads assignments when Tab 2 is shown and supports status tabs + search + pagination + usage modal.

```html
<script>
(() => {
  const S = { loaded:false, page:1, per:20, q:'', status:'', expiring:'', sort:'expires_on:asc' };

  const $ = (id) => document.getElementById(id);
  const fmtMoney = n => '‚Çπ' + (n||0).toLocaleString(undefined,{maximumFractionDigits:0});
  const fmtDate = s => { if(!s) return '‚Äî'; const d=new Date(s); return d.toLocaleDateString()+' '+d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); };
  const badge = (t,c) => `<span class="badge ${c}">${t}</span>`;
  const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms);} };

  document.addEventListener('shown.bs.tab', (e)=>{
    if(e.target.id === 'tab-assigned-tab' && !S.loaded){
      S.loaded = true;
      hookAssignedUI();
      fetchAssignments();
    }
  });

  function hookAssignedUI(){
    // status pills
    document.querySelectorAll('#statusPills .nav-link').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('#statusPills .nav-link').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        S.page=1; S.q=''; S.expiring=''; S.status='';
        const st = btn.getAttribute('data-status')||'';
        const ex = btn.getAttribute('data-expiring')||'';
        if(st==='expiring') { S.expiring = ex||'30'; } else { S.status = st; }
        fetchAssignments();
      });
    });
    // search
    $('apSearch').addEventListener('input', debounce(()=>{
      S.q = $('apSearch').value.trim(); S.page=1; fetchAssignments();
    }, 350));
  }

  function fetchAssignments(){
    const p = new URLSearchParams({
      q: S.q, status: (S.status==='expiring'?'':S.status), expiring_in: S.expiring,
      page: S.page, per_page: S.per, sort: S.sort
    }).toString();
    fetch(`/packages/api/assignments?${p}`)
      .then(r=>r.json())
      .then(j=>{
        if(!j.success){ alert(j.error||'Failed to load assignments'); return; }
        renderRows(j.items||[]);
        renderPager(j.page, j.per_page, j.total);
      })
      .catch(()=>alert('Error loading assignments'));
  }

  function renderRows(items){
    const tb = document.querySelector('#apTable tbody');
    tb.innerHTML = '';
    if(!items.length){ tb.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-4">No assignments</td></tr>`; return; }

    items.forEach(x=>{
      const statusCls = {
        active:'bg-success', pending:'bg-warning', paused:'bg-secondary',
        completed:'bg-primary', expired:'bg-danger'
      }[x.status] || 'bg-light text-dark';

      let balanceHtml = '';
      if(x.package.type==='service_package' && x.sessions){
        const pct = Math.min(100, Math.round((x.sessions.used / Math.max(1,x.sessions.total))*100));
        balanceHtml = `
          <div class="small">${x.sessions.used}/${x.sessions.total} used</div>
          <div class="progress" style="height:6px;"><div class="progress-bar" style="width:${pct}%"></div></div>
          <div class="small text-muted">${x.sessions.remaining} left</div>`;
      } else if(x.package.type==='prepaid' && x.credit){
        balanceHtml = `<div class="small">${fmtMoney(x.credit.remaining)} / ${fmtMoney(x.credit.total)}</div>`;
      } else {
        balanceHtml = `<span class="text-muted">Unlimited</span>`;
      }

      const expChip = x.expires_on
        ? (x.expiring_in_days<0 ? badge('Expired','bg-danger') : badge(`${x.expiring_in_days} days`,'bg-info'))
        : '<span class="text-muted">‚Äî</span>';

      const savings = (x.savings_to_date && x.savings_to_date>0) ? `<div class="small text-success">Saved ${fmtMoney(x.savings_to_date)}</div>` : '';

      tb.insertAdjacentHTML('beforeend', `
        <tr>
          <td><strong>${x.customer.name}</strong><br><small class="text-muted">${x.customer.phone||''}</small></td>
          <td>
            ${x.package.name} <span class="badge bg-light text-dark ms-1">${x.package.type}</span>
            ${x.package.service_name ? `<div class="small text-muted">Service: ${x.package.service_name}</div>`:''}
          </td>
          <td>${fmtDate(x.assigned_on)}</td>
          <td>${x.expires_on||'‚Äî'}<br>${expChip}</td>
          <td>${badge(x.status, statusCls)}</td>
          <td>${balanceHtml}</td>
          <td>${fmtMoney(x.price_paid||0)}${savings}</td>
          <td>${fmtDate(x.last_used_at)||'‚Äî'}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" title="Usage" onclick="AP_openUsage(${x.id})"><i class="fas fa-history"></i></button>
              <a class="btn btn-outline-secondary" title="Receipt" href="/billing/receipt?assignment_id=${x.id}" target="_blank">
                <i class="fas fa-file-invoice"></i>
              </a>
            </div>
          </td>
        </tr>
      `);
    });
  }

  function renderPager(page, per, total){
    const pg = $('apPager'); const info = $('apInfo');
    info.textContent = total ? `Showing ${(page-1)*per+1}‚Äì${Math.min(page*per,total)} of ${total}` : 'No results';
    pg.innerHTML = '';
    const pages = Math.max(1, Math.ceil(total/per));
    const mk = (p,txt,dis=false,act=false)=>`<li class="page-item ${dis?'disabled':''} ${act?'active':''}">
      <a class="page-link" href="#" onclick="AP_goto(${p});return false;">${txt}</a></li>`;
    pg.insertAdjacentHTML('beforeend', mk(Math.max(1,page-1),'¬´', page<=1));
    for(let i=Math.max(1,page-2); i<=Math.min(pages,page+2); i++) pg.insertAdjacentHTML('beforeend', mk(i, i, false, i===page));
    pg.insertAdjacentHTML('beforeend', mk(Math.min(pages,page+1),'¬ª', page>=pages));
  }

  // expose minimal globals for pager/usage buttons
  window.AP_goto = (p)=>{ S.page=p; fetchAssignments(); };
  window.AP_openUsage = (assignmentId)=>{
    fetch(`/packages/api/assignments/${assignmentId}/usage`)
      .then(r=>r.json()).then(j=>{
        if(!j.success){ alert('Failed to load usage'); return; }
        const s = j.summary||{};
        $('apUsageSummary').innerHTML = `
          <div class="row g-2">
            <div class="col"><div class="card card-body py-2">Sessions Used: <strong>${s.sessions_used||0}</strong></div></div>
            <div class="col"><div class="card card-body py-2">Sessions Left: <strong>${s.sessions_remaining||0}</strong></div></div>
            <div class="col"><div class="card card-body py-2">Credit Spent: <strong>${fmtMoney(s.credit_spent||0)}</strong></div></div>
            <div class="col"><div class="card card-body py-2">Credit Left: <strong>${fmtMoney(s.credit_remaining||0)}</strong></div></div>
          </div>`;
        const tb = $('apUsageRows'); tb.innerHTML='';
        (j.items||[]).forEach(u=>{
          tb.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${fmtDate(u.date)}</td>
              <td>${u.service_name||'‚Äî'}</td>
              <td>${u.usage_type}</td>
              <td>${u.qty_sessions||'‚Äî'}</td>
              <td>${u.amount?fmtMoney(u.amount):'‚Äî'}</td>
              <td>${u.invoice_id?('#'+u.invoice_id):'‚Äî'}</td>
              <td>${u.clerk||'‚Äî'}</td>
              <td><small>${u.notes||''}</small></td>
            </tr>`);
        });
        $('apExportUsage').href = `/packages/api/assignments/${assignmentId}/usage/export.csv`;
        new bootstrap.Modal(document.getElementById('apUsageModal')).show();
      });
  };

})();
</script>
```

### 3) Notes

* This keeps your **current assignment/payment flow untouched** (Tab 1).
* Tab 2 loads only when clicked, so there‚Äôs **no extra load** on initial render.
* ‚ÄúExpiring (30d)‚Äù is handled by sending `expiring_in=30`. If your list API doesn‚Äôt support that yet, add a filter: `WHERE expires_on BETWEEN TODAY AND TODAY + 30 days`.

---

That‚Äôs it. Paste this into your page, drop your existing form into **Tab 1**, and the **state tab view** (status-wise assigned packages) will appear as **Tab 2** on the same screen.
