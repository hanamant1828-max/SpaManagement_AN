gotcha — the “**Unknown Package**” label is just a missing/NULL name on the assignment/template chain. Here’s a copy-paste **prompt for Replit Assistance** that fixes it end-to-end (DB → assignment creation → API → UI) and backfills old rows.

---

## PROMPT FOR REPLIT ASSISTANCE

**Goal:** Stop “Unknown Package” from appearing. Always show a good name for every package in the **Active Packages** table and in billing.
**Plan:** (1) add denormalized `package_name` (and optional `service_name`) on assignments, (2) set it when assigning, (3) backfill existing rows, (4) make the API prefer this field, (5) add a robust UI fallback.

### 1) DB: ensure columns exist on `service_package_assignment`

Create `scripts/ensure_assignment_name_columns.py` and run it once.

```python
# scripts/ensure_assignment_name_columns.py
import sqlite3, os, sys
DB = os.getenv("DATABASE_URL", "instance/app.db")

def col_exists(c, table, col):
    c.execute("PRAGMA table_info(%s)" % table)
    return any(r[1] == col for r in c.fetchall())

with sqlite3.connect(DB) as conn:
    c = conn.cursor()
    # package_name (display name for the assignment)
    if not col_exists(c, "service_package_assignment", "package_name"):
        c.execute("ALTER TABLE service_package_assignment ADD COLUMN package_name TEXT")
    # optional: store service name for service-packages to show alongside
    if not col_exists(c, "service_package_assignment", "service_name"):
        c.execute("ALTER TABLE service_package_assignment ADD COLUMN service_name TEXT")
    conn.commit()
print("OK: columns ensured.")
```

### 2) Backend helper: resolve a nice display name for any package type

Add to a shared utils file, e.g. `modules/packages/name_resolver.py`:

```python
# modules/packages/name_resolver.py
from models import db, PrepaidPackage, ServicePackage, Membership, StudentOffer, YearlyMembership, KittyParty

def autogenerated_service_pkg_name(sp: "ServicePackage") -> str:
    # Example: "Pay 3 Get 4" (or include free sessions)
    try:
        pf = int(sp.pay_for or 0)
        total = int(sp.total_services or 0)
        free = max(total - pf, 0)
        base = f"Pay {pf} Get {total}" if pf and total else (sp.name or "Service Package")
        if free:
            base += f" (+{free} free)"
        return base
    except Exception:
        return sp.name or "Service Package"

def resolve_package_display_name(package_type: str, package_id: int) -> str:
    pt = (package_type or "").lower()
    if pt == "prepaid":
        p = db.session.get(PrepaidPackage, package_id)
        if not p: return "Prepaid Package"
        # e.g., "Prepaid ₹15,000 → ₹17,500"
        return p.name or f"Prepaid ₹{int(p.actual_price or 0):,} → ₹{int(p.after_value or 0):,}"
    if pt in ("service_package", "service"):
        sp = db.session.get(ServicePackage, package_id)
        if not sp: return "Service Package"
        return sp.name or autogenerated_service_pkg_name(sp)
    if pt == "membership":
        m = db.session.get(Membership, package_id)
        return (m.name if m else None) or "Membership"
    if pt == "student":
        s = db.session.get(StudentOffer, package_id)
        return (getattr(s, "name", None)) or "Student Offer"
    if pt == "yearly":
        y = db.session.get(YearlyMembership, package_id)
        return (y.name if y else None) or "Yearly Membership"
    if pt == "kitty":
        k = db.session.get(KittyParty, package_id)
        return (k.name if k else None) or "Kitty Party"
    return "Package"
```

Optional helper to fetch a service’s name by id (used for service packages):

```python
# modules/packages/name_resolver.py (append)
from models import Service
def resolve_service_name(service_id: int) -> str | None:
    if not service_id: return None
    s = db.session.get(Service, service_id)
    return s.name if s else None
```

### 3) Set names at assignment time (prevents Unknown forever)

In every endpoint that assigns a package (e.g. `POST /packages/api/assign`), **after** you parse the payload but **before** `db.session.commit()`, set `assignment.package_name` and `assignment.service_name`.

```python
# modules/packages/assign_views.py (inside create-assignment logic)
from modules.packages.name_resolver import resolve_package_display_name, resolve_service_name

assignment.package_name = resolve_package_display_name(data["package_type"], data["package_id"])

# For service-package: also store the service name
if (data["package_type"] in ("service", "service_package")) and data.get("service_id"):
    assignment.service_name = resolve_service_name(int(data["service_id"]))
```

Do the same in any other assign endpoints (membership, student, yearly, kitty) so all paths set `package_name`.

### 4) Backfill existing assignments with NULL/blank names

Create `scripts/backfill_assignment_names.py` and run once.

```python
# scripts/backfill_assignment_names.py
from app import create_app
from models import db, ServicePackageAssignment
from modules.packages.name_resolver import resolve_package_display_name

app = create_app()
with app.app_context():
    q = (ServicePackageAssignment.query
         .filter((ServicePackageAssignment.package_name.is_(None)) | (ServicePackageAssignment.package_name == "")))
    count = 0
    for a in q.all():
        a.package_name = resolve_package_display_name(a.package_type, a.package_reference_id)
        count += 1
    db.session.commit()
    print(f"Backfilled {count} assignments with package_name.")
```

### 5) API: make the customer-packages endpoint prefer `assignment.package_name`

In `modules/billing/integrated_billing_views.py` (the route you cited), when building each `package_info`, use the denormalized fields first:

```python
# modules/billing/integrated_billing_views.py (inside get_customer_packages)
name = getattr(assignment, "package_name", None)
if not name:
    # final fallback (shouldn’t be hit after backfill, but safe)
    from modules.packages.name_resolver import resolve_package_display_name
    name = resolve_package_display_name(assignment.package_type, assignment.package_reference_id)

service_name = getattr(assignment, "service_name", None)  # may be None for non-service packages

package_info = {
    "assignment_id": assignment.id,
    "package_type": assignment.package_type,
    "name": name,
    "service_name": service_name,
    "status": assignment.status,
    "expires_on": assignment.expires_on.isoformat() if assignment.expires_on else None,
    # … plus sessions/credit blocks as you already return
}
```

### 6) UI: tiny fallback so the table never shows “Unknown”

In `templates/integrated_billing.html` (or your JS render function), guard the name:

```javascript
function safePkgName(pkg) {
  if (pkg?.name && pkg.name.trim()) return pkg.name;
  // last-resort client fallback
  const t = (pkg.package_type || '').toLowerCase();
  if (t === 'prepaid') return 'Prepaid Package';
  if (t === 'service' || t === 'service_package') {
    return 'Service Package' + (pkg.service_name ? ` · ${pkg.service_name}` : '');
  }
  if (t === 'membership') return 'Membership';
  if (t === 'student') return 'Student Offer';
  if (t === 'yearly') return 'Yearly Membership';
  if (t === 'kitty') return 'Kitty Party';
  return 'Package';
}
```

and use it when rendering the table cell:

```javascript
nameCell.innerHTML = `
  <strong>${safePkgName(pkg)}</strong>
  ${pkg.service_name ? `<div class="small text-muted">${pkg.service_name}</div>` : ''}
`;
```

### 7) (Nice-to-have) Auto-name templates if user leaves name blank

When creating a **service package template**, if `name` is empty, save as `"Pay {pay_for} Get {total_services} (+{free} free)"`.
When creating a **prepaid template**, if `name` is empty, save as `"Prepaid ₹{actual_price} → ₹{after_value}"`.

Do this in the respective `POST` handlers so new templates always carry a human-readable name.

---

### How to run (once):

1. Run `scripts/ensure_assignment_name_columns.py`.
2. Run `scripts/backfill_assignment_names.py`.
3. Restart the app.

**Result:**

* Assignments created from now on always have `package_name` set.
* Old assignments are backfilled.
* The API returns the proper name.
* The UI prints a safe name even if something slips through.

You should no longer see “Unknown Package”, and service packages will show like **“Pay 3 Get 4 (+1 free)”** or your custom template name, optionally with **“· Hair Highlights”** beneath.
