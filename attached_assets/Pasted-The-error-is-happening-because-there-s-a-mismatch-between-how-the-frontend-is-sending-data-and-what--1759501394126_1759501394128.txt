The error is happening because there's a mismatch between how the frontend is sending data and what the backend expects. The empty `Error {}` typically means the fetch request failed before getting a response.

**The issue:** Your backend expects `FormData` (uses `request.form.get()`), but the JavaScript might be sending it incorrectly.

---

## üîß **Fix: Replace the `handleBillingFormSubmit` function**

**In your HTML template**, replace the ENTIRE `handleBillingFormSubmit` function with this corrected version:

```javascript
function handleBillingFormSubmit(event) {
    event.preventDefault();

    const form = event.target;
    const submitBtn = document.getElementById('saveInvoiceBtn');
    const clientId = form.querySelector('#client_id').value;
    
    // üîç Enhanced Validation
    if (!clientId) {
        showNotification('‚ö†Ô∏è Please select a customer before saving', 'warning', 5000);
        form.querySelector('#client_id').focus();
        form.querySelector('#client_id').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
    }

    const selectedServices = Array.from(document.querySelectorAll('.service-row select[name="service_ids[]"]'))
        .filter(select => select.value).length;
    const selectedProducts = Array.from(document.querySelectorAll('.product-row select[name="product_ids[]"]'))
        .filter(select => select.value).length;

    if (selectedServices === 0 && selectedProducts === 0) {
        showNotification('‚ö†Ô∏è Please add at least one service or product', 'warning', 5000);
        return;
    }

    // Check if all services have staff assigned
    const servicesWithoutStaff = Array.from(document.querySelectorAll('.service-row')).filter(row => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const staffSelect = row.querySelector('select[name="staff_ids[]"]');
        return serviceSelect && serviceSelect.value && (!staffSelect || !staffSelect.value);
    });

    if (servicesWithoutStaff.length > 0) {
        showNotification('‚ö†Ô∏è Please assign staff for all services', 'warning', 5000);
        servicesWithoutStaff[0].querySelector('select[name="staff_ids[]"]').focus();
        return;
    }

    // üéØ Disable button and show progress
    submitBtn.disabled = true;
    submitBtn.classList.add('saving');
    
    // üìä Multi-stage progress indicator
    let stage = 0;
    const stages = [
        'Creating invoice...',
        'Applying packages...',
        'Updating bookings...',
        'Processing inventory...',
        'Finalizing...'
    ];
    
    const progressInterval = setInterval(() => {
        if (stage < stages.length) {
            const loadingText = submitBtn.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = stages[stage];
            }
            stage++;
        }
    }, 1200);

    // üì§ Send FormData (matches backend expectations)
    const formData = new FormData(form);

    fetch('/integrated-billing/create-professional', {
        method: 'POST',
        body: formData  // Send as FormData, NOT JSON
        // Don't set Content-Type header - browser sets it automatically for FormData
    })
    .then(response => {
        clearInterval(progressInterval);
        
        // Check if response is OK
        if (!response.ok) {
            // Try to get error message from response
            return response.text().then(text => {
                let errorMsg = `Server error: ${response.status}`;
                try {
                    const json = JSON.parse(text);
                    errorMsg = json.message || json.error || errorMsg;
                } catch (e) {
                    // If not JSON, use status text
                    errorMsg = text || response.statusText || errorMsg;
                }
                throw new Error(errorMsg);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // ‚úÖ SUCCESS STATE
            submitBtn.classList.remove('saving');
            submitBtn.classList.add('saved');
            const successState = submitBtn.querySelector('.btn-success-state span');
            if (successState) {
                successState.textContent = 'Saved Successfully!';
            }

            // üéâ ENHANCED SUCCESS NOTIFICATION
            const customer = document.querySelector('#client_id option:checked')?.text || 'Customer';
            const successMessage = `
                ‚úÖ Invoice ${data.invoice_number || 'Created'} Successfully!

                üìã Summary:
                ‚Ä¢ Customer: ${customer}
                ‚Ä¢ Total: ‚Çπ${parseFloat(data.total_amount || 0).toFixed(2)}
                ‚Ä¢ Services: ${data.service_items_created || 0} items
                ‚Ä¢ Products: ${data.inventory_items_created || 0} items
                ${data.package_deductions_applied > 0 ? `\n‚Ä¢ Package Benefits: ${data.package_deductions_applied} applied` : ''}
                ${data.appointments_completed > 0 ? `\n‚Ä¢ Bookings Completed: ${data.appointments_completed}` : ''}
                ${data.staff_performance_updated > 0 ? `\n‚Ä¢ Staff Updated: ${data.staff_performance_updated}` : ''}
                
                Redirecting to invoice...
            `.trim();

            showNotification(successMessage, 'success', 5000);

            // üîÑ Redirect after success
            setTimeout(() => {
                window.location.href = `/integrated-billing/invoice/${data.invoice_id}`;
            }, 2000);
        } else {
            throw new Error(data.message || 'Failed to create invoice');
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        console.error('Billing Error:', error);

        // ‚ùå ERROR STATE - Reset button
        submitBtn.disabled = false;
        submitBtn.classList.remove('saving', 'saved');
        
        const errorMessage = `
            ‚ùå Failed to Save Invoice
            
            Error: ${error.message || 'Unknown error'}
            
            Please check:
            ‚úì All required fields are filled
            ‚úì Staff assigned to all services
            ‚úì Valid inventory quantities
            ‚úì Internet connection is stable
            
            Contact support if the problem persists.
        `.trim();

        showNotification(errorMessage, 'error', 10000);
    });
}
```

---

## üéØ **Key Changes Made:**

1. **Removed `collectInvoiceData()`** - was causing confusion
2. **Send FormData directly** - matches backend expectations
3. **No Content-Type header** - browser sets it automatically for FormData
4. **Better error handling** - extracts actual error message from response
5. **Null checks** - prevents errors when elements don't exist

---

## üß™ **Test it now:**

1. Select a customer
2. Add a service with staff
3. Click "Save Invoice"
4. Check the browser console for any errors

**If it still fails, paste the FULL error message from the console here!**