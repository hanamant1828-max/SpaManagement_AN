{% extends "base.html" %}

{% block title %}Professional Invoice Management{% endblock %}

{% block extra_head %}
<style>
/* ==========================================
   PROFESSIONAL BILLING SYSTEM STYLES
   ========================================== */

:root {
    /* Brand Colors */
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --primary-light: #818cf8;

    /* Status Colors */
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #06b6d4;

    /* Neutral Palette */
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-500: #6b7280;
    --gray-700: #374151;
    --gray-900: #111827;

    /* Shadows */
    --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-sm: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);

    /* Gradients */
    --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --gradient-info: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);

    /* Spacing */
    --space-unit: 8px;
    --border-radius: 12px;

    /* Transitions */
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ==========================================
   GLOBAL STYLES
   ========================================== */

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--gray-50);
    color: var(--gray-900);
    line-height: 1.6;
}

/* ==========================================
   PAGE HEADER
   ========================================== */

.billing-page-header {
    background: white;
    border-bottom: 1px solid var(--gray-200);
    padding: calc(var(--space-unit) * 3) calc(var(--space-unit) * 4);
    margin-bottom: calc(var(--space-unit) * 4);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-sm);
}

.page-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--gray-900);
    margin: 0;
    display: flex;
    align-items: center;
    gap: calc(var(--space-unit) * 2);
}

.page-title i {
    color: var(--primary);
}

.page-subtitle {
    color: var(--gray-500);
    font-size: 0.95rem;
    margin-top: calc(var(--space-unit));
}

/* ==========================================
   CARDS & SECTIONS
   ========================================== */

.billing-card {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    transition: var(--transition);
    margin-bottom: calc(var(--space-unit) * 3);
}

.billing-card:hover {
    box-shadow: var(--shadow-lg);
}

.card-header-custom {
    background: var(--gradient-primary);
    color: white;
    padding: calc(var(--space-unit) * 3);
    border-bottom: none;
}

.card-header-custom h5 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: calc(var(--space-unit) * 2);
}

.card-body-custom {
    padding: calc(var(--space-unit) * 4);
}

.section-divider {
    background: white;
    border-radius: var(--border-radius);
    padding: calc(var(--space-unit) * 3);
    margin-bottom: calc(var(--space-unit) * 3);
    border: 1px solid var(--gray-200);
    transition: var(--transition);
}

.section-divider:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-sm);
}

.section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--gray-900);
    margin-bottom: calc(var(--space-unit) * 2);
    padding-bottom: calc(var(--space-unit) * 2);
    border-bottom: 2px solid var(--primary);
    display: flex;
    align-items: center;
    gap: calc(var(--space-unit) * 2);
}

.section-title i {
    color: var(--primary);
    font-size: 1.2rem;
}

/* ==========================================
   FORM CONTROLS
   ========================================== */

.form-label-custom {
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.875rem;
    margin-bottom: calc(var(--space-unit));
    display: flex;
    align-items: center;
    gap: calc(var(--space-unit));
}

.form-control-custom,
.form-select-custom {
    border: 2px solid var(--gray-200);
    border-radius: 10px;
    padding: calc(var(--space-unit) * 1.5) calc(var(--space-unit) * 2);
    font-size: 0.95rem;
    transition: var(--transition);
    width: 100%;
    background: white;
}

.form-control-custom:focus,
.form-select-custom:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-control-custom:hover,
.form-select-custom:hover {
    border-color: var(--primary-light);
}

/* ==========================================
   BUTTONS
   ========================================== */

.btn-custom {
    border-radius: 10px;
    padding: calc(var(--space-unit) * 1.5) calc(var(--space-unit) * 3);
    font-weight: 600;
    font-size: 0.95rem;
    transition: var(--transition);
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: calc(var(--space-unit));
    text-decoration: none;
}

.btn-primary-custom {
    background: var(--gradient-primary);
    color: white;
    box-shadow: var(--shadow-md);
}

.btn-primary-custom:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-success-custom {
    background: var(--gradient-success);
    color: white;
    box-shadow: var(--shadow-md);
}

.btn-success-custom:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-info-custom {
    background: var(--gradient-info);
    color: white;
    box-shadow: var(--shadow-md);
}

.btn-info-custom:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.btn-custom:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.btn-sm-custom {
    padding: calc(var(--space-unit)) calc(var(--space-unit) * 2);
    font-size: 0.875rem;
}

.btn-lg-custom {
    padding: calc(var(--space-unit) * 2) calc(var(--space-unit) * 4);
    font-size: 1.1rem;
}

/* ==========================================
   ITEM ROWS (Services & Products)
   ========================================== */

.item-row {
    background: white;
    border: 2px solid var(--gray-200);
    border-radius: var(--border-radius);
    padding: calc(var(--space-unit) * 3);
    margin-bottom: calc(var(--space-unit) * 2);
    transition: var(--transition);
}

.item-row:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-sm);
    transform: translateX(4px);
}

.package-benefit-badge {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    padding: calc(var(--space-unit) * 1.5);
    border-radius: 8px;
    margin-top: calc(var(--space-unit) * 2);
    border-left: 4px solid var(--success);
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ==========================================
   BATCH INFO
   ========================================== */

.batch-info-display {
    background: var(--gray-50);
    border-left: 3px solid var(--info);
    padding: calc(var(--space-unit) * 1.5);
    border-radius: 6px;
    font-size: 0.85rem;
    margin-top: calc(var(--space-unit));
    color: var(--gray-700);
}

/* ==========================================
   CALCULATION SUMMARY
   ========================================== */

.calculation-summary {
    background: var(--gradient-primary);
    color: white;
    border-radius: var(--border-radius);
    padding: calc(var(--space-unit) * 4);
    position: sticky;
    top: calc(var(--space-unit) * 2);
    box-shadow: var(--shadow-xl);
}

.summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: calc(var(--space-unit) * 1.5) 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.summary-row:last-child {
    border-bottom: none;
}

.summary-label {
    font-weight: 500;
    opacity: 0.9;
}

.summary-value {
    font-weight: 700;
    font-size: 1.1rem;
}

.grand-total-display {
    font-size: 2.5rem;
    font-weight: 800;
    text-align: center;
    margin: calc(var(--space-unit) * 3) 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

/* ==========================================
   SAVE BUTTON STATES
   ========================================== */

.btn-save-invoice {
    position: relative;
    overflow: hidden;
}

.btn-save-invoice.saving {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    animation: pulse 1.5s ease-in-out infinite;
}

.btn-save-invoice.saved {
    background: var(--gradient-success);
    transform: scale(1.05);
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.85; }
}

.loading-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* ==========================================
   ALERTS & NOTIFICATIONS
   ========================================== */

.alert-custom {
    border-radius: var(--border-radius);
    padding: calc(var(--space-unit) * 2);
    border: none;
    box-shadow: var(--shadow-sm);
    margin-bottom: calc(var(--space-unit) * 2);
}

.alert-success-custom {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
}

.alert-info-custom {
    background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
    color: #075985;
}

.alert-warning-custom {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
}

/* ==========================================
   RESPONSIVE DESIGN
   ========================================== */

@media (max-width: 768px) {
    .billing-page-header {
        padding: calc(var(--space-unit) * 2);
    }

    .page-title {
        font-size: 1.5rem;
    }

    .card-body-custom,
    .section-divider {
        padding: calc(var(--space-unit) * 2);
    }

    .btn-custom {
        width: 100%;
        justify-content: center;
    }

    .grand-total-display {
        font-size: 2rem;
    }
}

/* ==========================================
   CUSTOM UTILITIES
   ========================================== */

.text-muted-custom {
    color: var(--gray-500);
}

.badge-custom {
    padding: calc(var(--space-unit) * 0.75) calc(var(--space-unit) * 1.5);
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.8rem;
    display: inline-flex;
    align-items: center;
    gap: calc(var(--space-unit) * 0.5);
}

.badge-success-custom {
    background: var(--gradient-success);
    color: white;
}

.badge-info-custom {
    background: var(--gradient-info);
    color: white;
}

.required-field::after {
    content: '*';
    color: var(--danger);
    margin-left: 4px;
}

/* ==========================================
   FLOATING ACTION PANEL
   ========================================== */

.floating-summary-panel {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
    padding: calc(var(--space-unit) * 2) calc(var(--space-unit) * 3);
    z-index: 1000;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-top: 3px solid var(--primary);
}

@media (min-width: 769px) {
    .floating-summary-panel {
        display: none;
    }
}

/* Custom styles for validation feedback */
.is-invalid {
    border-color: #dc3545 !important;
}
.invalid-feedback {
    display: none; /* Hidden by default, shown by JS */
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875em;
    color: #dc3545;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4">
    <!-- Page Header -->
    <div class="billing-page-header">
        <h1 class="page-title">
            <i class="fas fa-file-invoice-dollar"></i>
            Create Professional Invoice
        </h1>
        <p class="page-subtitle">
            <i class="fas fa-info-circle me-2"></i>
            Comprehensive billing with package benefits, inventory tracking, and staff management
        </p>
    </div>

    <!-- Main Billing Form -->
    <form id="billingForm" method="POST" action="/integrated-billing/create-professional">
        <div class="row">
            <!-- Left Column: Form Inputs -->
            <div class="col-lg-8">
                <!-- Customer Selection -->
                <div class="section-divider">
                    <h6 class="section-title">
                        <i class="fas fa-user-circle"></i>
                        Customer Information
                    </h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label-custom required-field">
                                <i class="fas fa-user"></i>
                                Select Customer
                            </label>
                            <select class="form-select form-select-custom" id="client_id" name="client_id" required>
                                <option value="">Choose customer...</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}" {{ 'selected' if selected_customer and customer.id == selected_customer.id else '' }}>
                                    {{ customer.full_name }} - {{ customer.phone }}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label-custom">
                                <i class="fas fa-gift"></i>
                                Active Packages
                            </label>
                            <div id="customerPackages" class="alert alert-info-custom" style="max-height: 200px; overflow-y: auto;">
                                <small><i class="fas fa-info-circle me-1"></i>Select customer to view packages</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Services Section -->
                <div class="section-divider">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="section-title mb-0">
                            <i class="fas fa-spa"></i>
                            Services
                        </h6>
                        <button type="button" class="btn btn-sm btn-primary-custom btn-sm-custom" onclick="addServiceRow()">
                            <i class="fas fa-plus"></i>
                            Add Service
                        </button>
                    </div>
                    <div id="servicesContainer">
                        <div class="item-row service-row">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label-custom">Service</label>
                                    <select class="form-select form-select-custom" name="service_ids[]" onchange="handleServiceSelection(this); updateCalculations();">
                                        <option value="">Select Service</option>
                                        {% for service in services %}
                                        <option value="{{ service.id }}" data-price="{{ service.price|float }}">
                                            {{ service.name }} - ‚Çπ{{ "{:,.2f}".format(service.price) }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label-custom required-field">Staff</label>
                                    <select class="form-select form-select-custom" name="staff_ids[]">
                                        <option value="">Select Staff</option>
                                        {% for staff in staff_members %}
                                        <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-custom">Qty</label>
                                    <input type="number" class="form-control form-control-custom" name="service_quantities[]" value="1" min="0.5" step="0.5" oninput="updateCalculations()">
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-custom">Apt ID</label>
                                    <input type="number" class="form-control form-control-custom" name="appointment_ids[]" placeholder="Optional">
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger btn-sm-custom w-100" onclick="removeRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <div class="section-divider">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="section-title mb-0">
                            <i class="fas fa-box"></i>
                            Products & Inventory
                        </h6>
                        <button type="button" class="btn btn-sm btn-primary-custom btn-sm-custom" onclick="addProductRow()">
                            <i class="fas fa-plus"></i>
                            Add Product
                        </button>
                    </div>
                    <div id="productsContainer">
                        <div class="item-row product-row">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label-custom">Product</label>
                                    <select class="form-select form-select-custom product-select" name="product_ids[]" onchange="loadBatchesForProduct(this); updateCalculations();">
                                        <option value="">Select Product</option>
                                        {% for product in inventory_items %}
                                        <option value="{{ product.id }}">{{ product.name }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-custom">Batch</label>
                                    <select class="form-select form-select-custom batch-select" name="batch_ids[]" disabled>
                                        <option value="">Select Product First</option>
                                    </select>
                                    <div class="batch-info-display"></div>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-custom required-field">Staff</label>
                                    <select class="form-select form-select-custom" name="product_staff_ids[]">
                                        <option value="">Select Staff</option>
                                        {% for staff in staff_members %}
                                        <option value="{{ staff.id }}">{{ staff.full_name }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-custom">Qty</label>
                                    <input type="number" class="form-control form-control-custom" name="product_quantities[]" value="1" min="0.01" step="0.01" oninput="updateCalculations()">
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label-custom">Price</label>
                                    <input type="number" class="form-control form-control-custom" name="product_prices[]" placeholder="‚Çπ0.00" min="0" step="0.01" oninput="updateCalculations()">
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger btn-sm-custom w-100" onclick="removeRow(this)" style="display:none;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="section-divider">
                    <h6 class="section-title">
                        <i class="fas fa-credit-card"></i>
                        Payment & Tax Details
                    </h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label-custom required-field">Payment Method</label>
                            <select class="form-select form-select-custom" name="payment_method">
                                <option value="">Select Method</option>
                                <option value="cash">Cash</option>
                                <option value="card">Card</option>
                                <option value="upi">UPI</option>
                                <option value="bank_transfer">Bank Transfer</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label-custom required-field">Payment Status</label>
                            <select class="form-select form-select-custom" name="payment_status">
                                <option value="paid">Paid</option>
                                <option value="partial">Partially Paid</option>
                                <option value="pending">Pending</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label-custom">Discount (%)</label>
                            <input type="number" class="form-control form-control-custom" name="discount_percentage" value="0" min="0" max="100" step="0.01" oninput="updateCalculations()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-custom">
                                <input type="checkbox" id="gstEnabled" name="gst_enabled" onchange="updateCalculations()" class="form-check-input me-2">
                                Enable GST
                            </label>
                            <input type="number" class="form-control form-control-custom" id="gstPercentage" name="gst_percentage" placeholder="GST %" value="18" min="0" max="100" step="0.01" disabled oninput="updateCalculations()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label-custom">Notes</label>
                            <textarea class="form-control form-control-custom" name="notes" rows="3" placeholder="Add notes..."></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Calculation Summary -->
            <div class="col-lg-4">
                <div class="calculation-summary">
                    <h5 class="text-center mb-4" style="font-size: 1.3rem; font-weight: 700;">
                        <i class="fas fa-calculator me-2"></i>
                        Bill Summary
                    </h5>

                    <div class="summary-row">
                        <span class="summary-label">Services:</span>
                        <span class="summary-value" id="servicesSubtotal">‚Çπ0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">Products:</span>
                        <span class="summary-value" id="productsSubtotal">‚Çπ0.00</span>
                    </div>

                    <div class="summary-row text-success">
                        <span class="summary-label">Package Benefits:</span>
                        <span class="summary-value" id="packageDeductions">-‚Çπ0.00</span>
                    </div>

                    <div class="summary-row text-warning">
                        <span class="summary-label">Discount:</span>
                        <span class="summary-value" id="discountAmount">-‚Çπ0.00</span>
                    </div>

                    <div class="summary-row">
                        <span class="summary-label">GST (<span id="gstRate">0</span>%):</span>
                        <span class="summary-value" id="gstAmount">‚Çπ0.00</span>
                    </div>

                    <hr style="border-color: rgba(255, 255, 255, 0.3); margin: 20px 0;">

                    <div class="grand-total-display" id="grandTotal">‚Çπ0.00</div>

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-success-custom btn-lg-custom btn-save-invoice" id="saveInvoiceBtn">
                            <span class="btn-content">
                                <i class="fas fa-check-circle"></i>
                                Save Invoice
                            </span>
                            <span class="btn-loading d-none">
                                <i class="fas fa-spinner loading-spinner"></i>
                                <span class="loading-text">Saving...</span>
                            </span>
                            <span class="btn-success-state d-none">
                                <i class="fas fa-check-double"></i>
                                Saved!
                            </span>
                        </button>

                        <button type="button" class="btn btn-info-custom btn-lg-custom" onclick="saveAndPrintInvoice()">
                            <i class="fas fa-print"></i>
                            Save & Print
                        </button>

                        <button type="button" class="btn btn-primary-custom" onclick="previewInvoice()">
                            <i class="fas fa-eye"></i>
                            Preview
                        </button>
                    </div>

                    <div class="text-center mt-3 text-white-50 small">
                        <i class="fas fa-shield-alt me-1"></i>
                        Secure & Encrypted
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://kit.fontawesome.com/a076d05399.js"></script>

<script>
// ==========================================
// GLOBAL VARIABLES
// ==========================================
let customerPackageData = null;
let availableBatches = [];
let formSubmitting = false;

// ==========================================
// INITIALIZATION
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ Billing system initialized');

    // Load batch data
    loadAvailableBatches();

    // Setup customer selector
    const clientSelect = document.getElementById('client_id');
    if (clientSelect) {
        clientSelect.addEventListener('change', function() {
            const clientId = this.value;
            if (clientId) {
                loadCustomerPackages(clientId);
            } else {
                document.getElementById('customerPackages').innerHTML = '<small>Select customer to view packages</small>';
                customerPackageData = null;
            }
            updateCalculations(); // Recalculate in case package changes affect totals
        });
    }

    // Setup GST toggle
    const gstCheckbox = document.getElementById('gstEnabled');
    const gstInput = document.getElementById('gstPercentage');
    if (gstCheckbox && gstInput) {
        gstCheckbox.addEventListener('change', function() {
            gstInput.disabled = !this.checked;
            updateCalculations();
        });
    }

    // Setup form submission
    const form = document.getElementById('billingForm');
    if (form) {
        form.addEventListener('submit', handleFormSubmit);
    }

    // Initial calculation
    updateCalculations();

    {% if selected_customer %}
    loadCustomerPackages({{ selected_customer.id }});
    {% endif %}

    // Setup validation listeners for dynamic error clearing
    setupValidationListeners();
});

// ==========================================
// FORM SUBMISSION
// ==========================================
function handleFormSubmit(event) {
    // CRITICAL: Prevent default form submission first
    event.preventDefault();
    event.stopPropagation();

    const form = event.target;

    // Perform validation before submission
    if (!validateBillingForm()) {
        console.log('‚ùå Validation failed, submission aborted.');
        return; // Stop submission if validation fails
    }

    // Prevent double submission
    if (formSubmitting) {
        console.log('‚ö†Ô∏è Already submitting, ignoring...');
        return;
    }

    const submitBtn = document.getElementById('saveInvoiceBtn');
    const clientId = form.querySelector('#client_id').value;

    console.log('üìù Form submission started for client:', clientId);

    // Set submitting flag
    formSubmitting = true;

    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.classList.add('saving');
    submitBtn.querySelector('.btn-content').classList.add('d-none');
    submitBtn.querySelector('.btn-loading').classList.remove('d-none');

    // Progress stages
    let stage = 0;
    const stages = ['Creating invoice...', 'Applying packages...', 'Updating records...', 'Finalizing...'];

    const progressInterval = setInterval(() => {
        if (stage < stages.length) {
            const loadingText = submitBtn.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = stages[stage];
            }
            stage++;
        }
    }, 1000);

    // Submit form data using fetch API for better control
    const formData = new FormData(form);

    fetch('/integrated-billing/create-professional', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        clearInterval(progressInterval);
        if (!response.ok) {
            return response.text().then(text => {
                let errorMsg = `Server error: ${response.status}`;
                try {
                    const json = JSON.parse(text);
                    errorMsg = json.message || errorMsg;
                } catch (e) {
                    errorMsg = text || response.statusText || errorMsg;
                }
                throw new Error(errorMsg);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Success state
            submitBtn.classList.remove('saving');
            submitBtn.classList.add('saved');
            submitBtn.querySelector('.btn-loading').classList.add('d-none');
            submitBtn.querySelector('.btn-success-state').classList.remove('d-none');

            const successMsg = `‚úÖ Invoice Created Successfully!\n\nInvoice #${data.invoice_number}\nTotal: ‚Çπ${parseFloat(data.total_amount).toFixed(2)}\n\n${window.printAfterSave ? 'Opening print...' : 'Redirecting...'}`;
            showNotification(successMsg, 'success');

            setTimeout(() => {
                if (window.printAfterSave) {
                    // Open print page in new window
                    window.open(`/integrated-billing/print-invoice/${data.invoice_id}`, '_blank');
                    // Reset flag
                    window.printAfterSave = false;
                    // Still redirect to invoice detail
                    setTimeout(() => {
                        window.location.href = `/integrated-billing/invoice/${data.invoice_id}`;
                    }, 1000);
                } else {
                    window.location.href = `/integrated-billing/invoice/${data.invoice_id}`;
                }
            }, 2000);
        } else {
            throw new Error(data.message || 'Failed to create invoice');
        }
    })
    .catch(error => {
        clearInterval(progressInterval);
        console.error('‚ùå Billing Error:', error);

        // Reset button
        formSubmitting = false;
        submitBtn.disabled = false;
        submitBtn.classList.remove('saving', 'saved');
        submitBtn.querySelector('.btn-loading').classList.add('d-none');
        submitBtn.querySelector('.btn-content').classList.remove('d-none');

        const errorMsg = `‚ùå Failed to Save Invoice\n\n${error.message}\n\nPlease check:\n‚úì All fields are filled\n‚úì Staff assigned to all items\n‚úì Valid quantities`;
        showNotification(errorMsg, 'error', 10000);
    });
}

// ==========================================
// ADD/REMOVE ROWS
// ==========================================
function addServiceRow() {
    const container = document.getElementById('servicesContainer');
    const newRow = container.children[0].cloneNode(true);

    // Reset inputs
    newRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
        clearError(input); // Clear any residual validation errors
    });

    // Show delete button
    const deleteBtn = newRow.querySelector('button[onclick*="removeRow"]');
    if (deleteBtn) deleteBtn.style.display = 'block';

    // Remove package benefit display
    const benefit = newRow.querySelector('.package-benefit-badge');
    if (benefit) benefit.remove();

    container.appendChild(newRow);
    setupValidationListeners(); // Re-setup listeners for new row elements
}

function addProductRow() {
    const container = document.getElementById('productsContainer');
    const newRow = container.children[0].cloneNode(true);

    // Reset inputs
    newRow.querySelectorAll('select, input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.name.includes('quantities') ? '1' : '';
        } else {
            input.value = '';
        }
        clearError(input); // Clear any residual validation errors
    });

    // Reset batch selector
    const batchSelect = newRow.querySelector('.batch-select');
    if (batchSelect) {
        batchSelect.innerHTML = '<option value="">Select Product First</option>';
        batchSelect.disabled = true;
    }

    // Clear batch info
    const batchInfo = newRow.querySelector('.batch-info-display');
    if (batchInfo) batchInfo.innerHTML = '';

    // Show delete button
    const deleteBtn = newRow.querySelector('button[onclick*="removeRow"]');
    if (deleteBtn) deleteBtn.style.display = 'block';

    container.appendChild(newRow);
    setupValidationListeners(); // Re-setup listeners for new row elements
}

function removeRow(button) {
    button.closest('.item-row').remove();
    updateCalculations();
}

// ==========================================
// PACKAGE HANDLING
// ==========================================
// Load customer packages
function loadCustomerPackages(customerId) {
    if (!customerId) {
        document.getElementById('customerPackages').innerHTML = '<small>Select customer to view packages</small>';
        customerPackageData = null;
        updateCalculations();
        return;
    }

    const packagesDiv = document.getElementById('customerPackages');
    packagesDiv.innerHTML = '<small><i class="fas fa-spinner fa-spin"></i> Loading packages...</small>';

    fetch(`/integrated-billing/customer-packages/${customerId}`)
        .then(response => response.json())
        .then(data => {
            console.log('Package data received:', data);
            customerPackageData = data;

            if (data.packages && data.packages.length > 0) {
                let html = '<div class="p-2"><strong class="text-success"><i class="fas fa-check-circle"></i> Active Packages Found:</strong><br><br>';
                
                data.packages.forEach(pkg => {
                    let packageTypeIcon = pkg.package_type === 'service_package' ? 'fa-spa' : 
                                         pkg.package_type === 'prepaid' ? 'fa-wallet' : 
                                         pkg.package_type === 'membership' ? 'fa-crown' : 'fa-gift';
                    
                    html += `<div class="mb-2 p-2" style="background: #f0f9ff; border-left: 3px solid #0891b2; border-radius: 4px;">`;
                    html += `<strong><i class="fas ${packageTypeIcon}"></i> ${pkg.package_name}</strong><br>`;
                    html += `<small class="text-muted">Type: ${pkg.package_type.replace('_', ' ').toUpperCase()}</small><br>`;
                    
                    if (pkg.package_type === 'service_package') {
                        html += `<small class="text-success"><i class="fas fa-check"></i> ${pkg.remaining_sessions || 0} sessions remaining</small>`;
                    } else if (pkg.package_type === 'prepaid') {
                        html += `<small class="text-success"><i class="fas fa-check"></i> ‚Çπ${pkg.remaining_credit || 0} credit remaining</small>`;
                    } else if (pkg.package_type === 'membership') {
                        html += `<small class="text-info"><i class="fas fa-infinity"></i> Active membership</small>`;
                    }
                    
                    html += `</div>`;
                });
                html += '</div>';
                packagesDiv.innerHTML = html;
            } else {
                packagesDiv.innerHTML = '<small class="text-muted-custom"><i class="fas fa-info-circle"></i> No active packages</small>';
            }

            updateCalculations(); // Recalculate totals after packages are loaded
        })
        .catch(error => {
            console.error('Error loading packages:', error);
            packagesDiv.innerHTML = '<small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error loading packages</small>';
            customerPackageData = null;
        });
}


// Display customer packages (This function seems to be unused or redundant with loadCustomerPackages)
function displayCustomerPackages(packages) {
    let html = '<div class="alert alert-success mb-3"><i class="fas fa-check-circle me-2"></i><strong>Active Packages for Customer:</strong></div>';
    html += '<div class="row">';

    packages.forEach(function(pkg) {
        let badgeClass = pkg.status === 'active' ? 'bg-success' : 'bg-secondary';
        let progressPercent = 0;
        let progressBar = '';

        // Calculate progress for different package types
        if (pkg.package_type === 'service_package' && pkg.total_sessions > 0) {
            progressPercent = ((pkg.total_sessions - pkg.remaining_sessions) / pkg.total_sessions) * 100;
            progressBar = `
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: ${progressPercent}%"
                         aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            `;
        } else if (pkg.package_type === 'prepaid' && pkg.credit_amount > 0) {
            progressPercent = ((pkg.credit_amount - pkg.remaining_credit) / pkg.credit_amount) * 100;
            progressBar = `
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar bg-info" role="progressbar" style="width: ${progressPercent}%"
                         aria-valuenow="${progressPercent}" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            `;
        }

        let packageCard = `
            <div class="col-md-6 mb-3">
                <div class="card border-primary shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${pkg.package_name}</h6>
                            <span class="badge ${badgeClass}">${pkg.status}</span>
                        </div>
                        <p class="card-text small mb-2">
                            <strong><i class="fas fa-tag me-1"></i>Type:</strong> ${pkg.package_type.replace('_', ' ').toUpperCase()}<br>
        `;

        // Add type-specific details with icons
        if (pkg.package_type === 'service_package') {
            packageCard += `
                            <strong><i class="fas fa-spa me-1"></i>Service:</strong> ${pkg.service_name || 'Any Service'}<br>
                            <strong><i class="fas fa-calendar-check me-1"></i>Sessions:</strong>
                            <span class="text-success fw-bold">${pkg.remaining_sessions || 0}</span> / ${pkg.total_sessions || 0} remaining
                            ${progressBar}
            `;
        } else if (pkg.package_type === 'prepaid') {
            packageCard += `
                            <strong><i class="fas fa-wallet me-1"></i>Balance:</strong>
                            <span class="text-success fw-bold">‚Çπ${pkg.remaining_credit || 0}</span> / ‚Çπ${pkg.credit_amount || 0} remaining
                            ${progressBar}
            `;
        } else if (pkg.package_type === 'membership') {
            let servicesList = (pkg.services || []).map(s => s.service_name).join(', ') || 'None specified';
            packageCard += `
                            <strong><i class="fas fa-list-check me-1"></i>Services:</strong> ${servicesList}<br>
                            ${pkg.description ? `<strong><i class="fas fa-info-circle me-1"></i>Details:</strong> ${pkg.description}` : ''}
            `;
        }

        packageCard += `
                        </p>
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>Valid: ${pkg.assigned_date} to ${pkg.expires_on || 'No expiry'}
                        </small>
                    </div>
                </div>
            </div>
        `;

        html += packageCard;
    });

    html += '</div>';
    html += '<div class="alert alert-info mt-2"><i class="fas fa-lightbulb me-2"></i><strong>Note:</strong> Package benefits will be automatically applied when you add services covered by these packages.</div>';

    document.getElementById('customerPackages').innerHTML = html;
}

// ==========================================
// BATCH HANDLING
// ==========================================
function loadAvailableBatches() {
    fetch('/api/inventory/batches/for-consumption')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.batches) {
                availableBatches = data.batches;
                console.log('‚úÖ Loaded', availableBatches.length, 'batches');
            }
        })
        .catch(error => console.error('Error loading batches:', error));
}

function loadBatchesForProduct(productSelect) {
    const row = productSelect.closest('.item-row');
    const batchSelect = row.querySelector('.batch-select');
    const batchInfo = row.querySelector('.batch-info-display');
    const priceInput = row.querySelector('input[name="product_prices[]"]');

    const productId = parseInt(productSelect.value);

    if (!productId) {
        batchSelect.innerHTML = '<option value="">Select Product First</option>';
        batchSelect.disabled = true;
        batchInfo.innerHTML = '';
        clearError(productSelect);
        clearError(batchSelect);
        return;
    }

    const productBatches = availableBatches.filter(b => b.product_id === productId && b.qty_available > 0);

    // Sort by expiry (FIFO)
    productBatches.sort((a, b) => {
        if (!a.expiry_date) return 1;
        if (!b.expiry_date) return -1;
        return new Date(a.expiry_date) - new Date(b.expiry_date);
    });

    // Populate batch dropdown
    batchSelect.innerHTML = ''; // Clear previous options
    if (productBatches.length === 0) {
        batchSelect.innerHTML = '<option value="">No stock available</option>';
        batchInfo.innerHTML = '<span class="text-danger">‚ö†Ô∏è Out of stock</span>';
        batchSelect.disabled = true;
        clearError(productSelect);
        highlightError(batchSelect, 'No stock available for this product.');
    } else {
        productBatches.forEach((batch, index) => {
            const option = document.createElement('option');
            option.value = batch.id;
            option.textContent = `${batch.batch_name} - ${batch.qty_available} available`;
            if (index === 0) option.selected = true;
            batchSelect.appendChild(option);
        });
        batchSelect.disabled = false;

        // Show first batch info
        const firstBatch = productBatches[0];
        const expiryText = firstBatch.expiry_date ?
            `Exp: ${new Date(firstBatch.expiry_date).toLocaleDateString()}` : 'No expiry';
        batchInfo.innerHTML = `<strong>FIFO:</strong> ${firstBatch.batch_name}<br><strong>Avail:</strong> ${firstBatch.qty_available}<br>${expiryText}`;
        clearError(batchSelect);
    }


    // Set price based on the first batch if available
    if (priceInput && productBatches.length > 0 && productBatches[0].selling_price) {
        priceInput.value = parseFloat(productBatches[0].selling_price).toFixed(2);
    } else if (priceInput) {
        priceInput.value = ''; // Clear price if no batch or selling price
    }
    updateCalculations();
}

// ==========================================
// CALCULATIONS
// ==========================================
function handleServiceSelection(selectElement) {
    const row = selectElement.closest('.service-row');
    const option = selectElement.options[selectElement.selectedIndex];
    const price = parseFloat(option.dataset.price) || 0;
    const qtyInput = row.querySelector('input[name="service_quantities[]"]');
    const qty = parseFloat(qtyInput.value) || 1;

    // Update calculations immediately if a service is selected
    updateCalculations();

    // Clear errors on selection change
    clearError(selectElement);
}

function updateCalculations() {
    // Calculate services subtotal (GST-INCLUSIVE prices)
    let servicesSubtotal = 0;
    let packageDeductions = 0; // Placeholder for applying package benefits

    document.querySelectorAll('.service-row').forEach(row => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const qtyInput = row.querySelector('input[name="service_quantities[]"]');

        if (serviceSelect && serviceSelect.value && qtyInput && qtyInput.value) {
            const option = serviceSelect.options[serviceSelect.selectedIndex];
            const price = parseFloat(option.dataset.price) || 0;
            const qty = parseFloat(qtyInput.value) || 1;
            servicesSubtotal += price * qty;
        }
    });

    // Calculate products subtotal (GST-EXCLUSIVE prices)
    let productsSubtotal = 0;

    document.querySelectorAll('.product-row').forEach(row => {
        const qtyInput = row.querySelector('input[name="product_quantities[]"]');
        const priceInput = row.querySelector('input[name="product_prices[]"]');

        if (qtyInput && qtyInput.value && priceInput && priceInput.value) {
            const qty = parseFloat(qtyInput.value) || 0;
            const price = parseFloat(priceInput.value) || 0;
            productsSubtotal += qty * price;
        }
    });

    // Get GST rate
    const gstEnabled = document.getElementById('gstEnabled')?.checked || false;
    const gstInput = document.getElementById('gstPercentage');
    const gstPercentage = gstEnabled ? (parseFloat(gstInput?.value) || 0) : 0;
    const gstRate = gstPercentage / 100;

    // Extract base amounts
    // For services (GST-inclusive): base = price / (1 + gst_rate)
    const serviceBaseAmount = gstRate > 0 ? servicesSubtotal / (1 + gstRate) : servicesSubtotal;
    const serviceGstAmount = servicesSubtotal - serviceBaseAmount;

    // For products (GST-exclusive): base = price, gst = price * gst_rate
    const productBaseAmount = productsSubtotal;
    const productGstAmount = productsSubtotal * gstRate;

    // Total base amount
    const totalBaseAmount = serviceBaseAmount + productBaseAmount;
    const totalGstBeforeDiscount = serviceGstAmount + productGstAmount;

    // Calculate discount on base amount only
    const discountPercentage = parseFloat(document.querySelector('input[name="discount_percentage"]')?.value) || 0;
    const discountAmount = (totalBaseAmount * discountPercentage) / 100;

    // Net base after discount
    const netBaseAmount = Math.max(0, totalBaseAmount - discountAmount);

    // Recalculate GST proportionally after discount
    let finalGstAmount = 0;
    if (totalBaseAmount > 0 && gstRate > 0) {
        const discountFactor = netBaseAmount / totalBaseAmount;
        finalGstAmount = totalGstBeforeDiscount * discountFactor;
    }

    // Grand total = base + GST
    const grandTotal = netBaseAmount + finalGstAmount;

    // Update display - ensure all values are numbers before calling toFixed
    document.getElementById('servicesSubtotal').textContent = `‚Çπ${(servicesSubtotal || 0).toFixed(2)}`;
    document.getElementById('productsSubtotal').textContent = `‚Çπ${(productsSubtotal || 0).toFixed(2)}`;
    document.getElementById('packageDeductions').textContent = `-‚Çπ${(packageDeductions || 0).toFixed(2)}`; // Placeholder
    document.getElementById('discountAmount').textContent = `-‚Çπ${(discountAmount || 0).toFixed(2)}`;
    document.getElementById('gstRate').textContent = (gstPercentage || 0).toFixed(0);
    document.getElementById('gstAmount').textContent = `‚Çπ${(finalGstAmount || 0).toFixed(2)}`;
    document.getElementById('grandTotal').textContent = `‚Çπ${(grandTotal || 0).toFixed(2)}`;

    console.log('üí∞ Calculations updated - Grand Total:', grandTotal.toFixed(2));
}

// ==========================================
// PREVIEW WITH VALIDATION
// ==========================================
function previewInvoice() {
    // Validate form first
    if (!validateBillingForm()) {
        console.log('‚ùå Validation failed for preview');
        return false;
    }

    // Show preview notification
    showNotification('‚úÖ Validation passed! Generating preview...', 'info', 3000);

    // Generate preview data
    const formData = gatherFormData();
    
    // Display preview modal or new window
    displayPreviewModal(formData);
}

function displayPreviewModal(formData) {
    // Create preview HTML
    let previewHTML = `
        <div class="preview-container">
            <h3 class="text-center mb-4">Invoice Preview</h3>
            
            <div class="row mb-3">
                <div class="col-6">
                    <strong>Customer:</strong> ${formData.customerName || 'Not Selected'}
                </div>
                <div class="col-6 text-end">
                    <strong>Date:</strong> ${new Date().toLocaleDateString()}
                </div>
            </div>

            <h5 class="mt-4">Services</h5>
            <table class="table table-sm">
                <thead><tr><th>Service</th><th>Staff</th><th>Qty</th><th>Amount</th></tr></thead>
                <tbody>
    `;

    formData.services.forEach(service => {
        previewHTML += `
            <tr>
                <td>${service.name}</td>
                <td>${service.staffName}</td>
                <td>${service.quantity}</td>
                <td>‚Çπ${service.amount.toFixed(2)}</td>
            </tr>
        `;
    });

    previewHTML += `</tbody></table>`;

    if (formData.products.length > 0) {
        previewHTML += `
            <h5 class="mt-4">Products</h5>
            <table class="table table-sm">
                <thead><tr><th>Product</th><th>Batch</th><th>Staff</th><th>Qty</th><th>Amount</th></tr></thead>
                <tbody>
        `;

        formData.products.forEach(product => {
            previewHTML += `
                <tr>
                    <td>${product.name}</td>
                    <td>${product.batchName}</td>
                    <td>${product.staffName}</td>
                    <td>${product.quantity}</td>
                    <td>‚Çπ${product.amount.toFixed(2)}</td>
                </tr>
            `;
        });

        previewHTML += `</tbody></table>`;
    }

    previewHTML += `
            <div class="row mt-4">
                <div class="col-6 offset-6">
                    <table class="table table-sm">
                        <tr><td>Subtotal:</td><td class="text-end">‚Çπ${formData.subtotal.toFixed(2)}</td></tr>
                        <tr><td>Discount:</td><td class="text-end text-success">-‚Çπ${formData.discount.toFixed(2)}</td></tr>
                        <tr><td>GST (${formData.gstRate}%):</td><td class="text-end">‚Çπ${formData.gst.toFixed(2)}</td></tr>
                        <tr class="fw-bold"><td>Total:</td><td class="text-end">‚Çπ${formData.total.toFixed(2)}</td></tr>
                    </table>
                </div>
            </div>
        </div>
    `;

    // Show in modal
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Invoice Preview</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    ${previewHTML}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    modal.addEventListener('hidden.bs.modal', () => {
        modal.remove();
    });
}

// ==========================================
// SAVE AND PRINT WITH VALIDATION
// ==========================================
function saveAndPrintInvoice() {
    // Validate form first
    if (!validateBillingForm()) {
        console.log('‚ùå Validation failed for save & print');
        return false;
    }

    // Show confirmation
    if (!confirm('‚úÖ Validation passed!\n\nProceed to save and print invoice?')) {
        return false;
    }

    // Set a flag to print after successful save
    window.printAfterSave = true;

    // Submit the form
    document.getElementById('billingForm').submit();
}

// ==========================================
// GATHER FORM DATA FOR PREVIEW
// ==========================================
function gatherFormData() {
    const form = document.getElementById('billingForm');
    const clientSelect = document.getElementById('client_id');
    const customerName = clientSelect.options[clientSelect.selectedIndex]?.text || 'Not Selected';

    const data = {
        customerName: customerName,
        services: [],
        products: [],
        subtotal: 0,
        discount: 0,
        gst: 0,
        gstRate: 0,
        total: 0
    };

    // Gather services
    document.querySelectorAll('.service-row').forEach(row => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const staffSelect = row.querySelector('select[name="staff_ids[]"]');
        const qtyInput = row.querySelector('input[name="service_quantities[]"]');

        if (serviceSelect && serviceSelect.value && staffSelect && staffSelect.value) {
            const option = serviceSelect.options[serviceSelect.selectedIndex];
            const price = parseFloat(option.dataset.price) || 0;
            const qty = parseFloat(qtyInput.value) || 1;
            const amount = price * qty;

            data.services.push({
                name: option.text.split(' - ')[0],
                staffName: staffSelect.options[staffSelect.selectedIndex].text,
                quantity: qty,
                price: price,
                amount: amount
            });

            data.subtotal += amount;
        }
    });

    // Gather products
    document.querySelectorAll('.product-row').forEach(row => {
        const productSelect = row.querySelector('select[name="product_ids[]"]');
        const batchSelect = row.querySelector('select[name="batch_ids[]"]');
        const staffSelect = row.querySelector('select[name="product_staff_ids[]"]');
        const qtyInput = row.querySelector('input[name="product_quantities[]"]');
        const priceInput = row.querySelector('input[name="product_prices[]"]');

        if (productSelect && productSelect.value && batchSelect && batchSelect.value) {
            const price = parseFloat(priceInput.value) || 0;
            const qty = parseFloat(qtyInput.value) || 1;
            const amount = price * qty;

            data.products.push({
                name: productSelect.options[productSelect.selectedIndex].text,
                batchName: batchSelect.options[batchSelect.selectedIndex].text,
                staffName: staffSelect.options[staffSelect.selectedIndex].text,
                quantity: qty,
                price: price,
                amount: amount
            });

            data.subtotal += amount;
        }
    });

    // Calculate discount
    const discountPercentage = parseFloat(form.querySelector('input[name="discount_percentage"]')?.value) || 0;
    data.discount = (data.subtotal * discountPercentage) / 100;

    // Calculate GST
    const gstEnabled = document.getElementById('gstEnabled')?.checked || false;
    const gstInput = document.getElementById('gstPercentage');
    data.gstRate = gstEnabled ? (parseFloat(gstInput?.value) || 0) : 0;
    
    const subtotalAfterDiscount = data.subtotal - data.discount;
    data.gst = (subtotalAfterDiscount * data.gstRate) / 100;

    // Calculate total
    data.total = subtotalAfterDiscount + data.gst;

    return data;
}

// ==========================================
// NOTIFICATIONS
// ==========================================
function showNotification(message, type = 'info', duration = 5000) {
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'info': 'alert-info'
    }[type] || 'alert-info';

    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show`;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px; white-space: pre-wrap;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, duration);
}

// ==========================================
// EDIT CUSTOMER FORM SUBMISSION
// ==========================================
// Handle edit customer form submission
function handleEditCustomerSubmit(event) {
    event.preventDefault();

    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');

    // Prevent double submission
    if (submitBtn.disabled) {
        return;
    }

    const customerId = form.dataset.customerId || window.currentCustomerId;

    if (!customerId) {
        showNotification('Error: Customer ID not found.', 'error');
        return;
    }

    // Show loading and disable button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';

    // Validate form action is set
    if (!form.action || form.action.endsWith('/clients')) {
        form.action = `/clients/update/${customerId}`;
    }

    // Submit form normally - let Flask handle it with proper redirect and flash messages
    form.submit();
}

// ==========================================
// COMPREHENSIVE BILLING VALIDATION
// ==========================================
function validateBillingForm() {
    const form = document.getElementById('billingForm');
    const errors = [];
    const missingFields = []; // Stores elements and messages for scrolling/focus

    // 1. Validate Customer Selection
    const clientSelect = document.getElementById('client_id');
    if (!clientSelect || !clientSelect.value) {
        errors.push('Customer selection is required.');
        missingFields.push({ element: clientSelect, message: 'Please select a customer' });
        highlightError(clientSelect, 'Please select a customer');
    } else {
        clearError(clientSelect);
    }

    // 2. Validate Services
    const serviceRows = document.querySelectorAll('.service-row');
    let hasValidService = false;

    serviceRows.forEach((row, index) => {
        const serviceSelect = row.querySelector('select[name="service_ids[]"]');
        const staffSelect = row.querySelector('select[name="staff_ids[]"]');
        const qtyInput = row.querySelector('input[name="service_quantities[]"]');

        // Only validate if a service is actually selected
        if (serviceSelect && serviceSelect.value) {
            hasValidService = true;

            // Validate staff for this service
            if (!staffSelect || !staffSelect.value) {
                errors.push(`Service #${index + 1}: Staff assignment is required.`);
                missingFields.push({ element: staffSelect, message: `Staff required for service #${index + 1}` });
                highlightError(staffSelect, 'Staff is required');
            } else {
                clearError(staffSelect);
            }

            // Validate quantity
            if (!qtyInput || !qtyInput.value || parseFloat(qtyInput.value) <= 0) {
                errors.push(`Service #${index + 1}: Valid quantity is required.`);
                missingFields.push({ element: qtyInput, message: 'Quantity must be greater than 0' });
                highlightError(qtyInput, 'Quantity required');
            } else {
                clearError(qtyInput);
            }
        } else {
            // If no service is selected, clear any potential errors from other fields in this row
            clearError(staffSelect);
            clearError(qtyInput);
        }
    });

    // 3. Validate Products
    const productRows = document.querySelectorAll('.product-row');
    let hasValidProduct = false;

    productRows.forEach((row, index) => {
        const productSelect = row.querySelector('select[name="product_ids[]"]');
        const batchSelect = row.querySelector('select[name="batch_ids[]"]');
        const staffSelect = row.querySelector('select[name="product_staff_ids[]"]');
        const qtyInput = row.querySelector('input[name="product_quantities[]"]');
        const priceInput = row.querySelector('input[name="product_prices[]"]');

        // Only validate if a product is actually selected
        if (productSelect && productSelect.value) {
            hasValidProduct = true;

            // Validate batch selection
            if (!batchSelect || !batchSelect.value) {
                errors.push(`Product #${index + 1}: Batch selection is required.`);
                missingFields.push({ element: batchSelect, message: 'Batch is required' });
                highlightError(batchSelect, 'Batch required');
            } else {
                clearError(batchSelect);
            }

            // Validate staff for this product
            if (!staffSelect || !staffSelect.value) {
                errors.push(`Product #${index + 1}: Staff assignment is required.`);
                missingFields.push({ element: staffSelect, message: `Staff required for product #${index + 1}` });
                highlightError(staffSelect, 'Staff is required');
            } else {
                clearError(staffSelect);
            }

            // Validate quantity
            if (!qtyInput || !qtyInput.value || parseFloat(qtyInput.value) <= 0) {
                errors.push(`Product #${index + 1}: Valid quantity is required.`);
                missingFields.push({ element: qtyInput, message: 'Quantity must be greater than 0' });
                highlightError(qtyInput, 'Quantity required');
            } else {
                clearError(qtyInput);
            }

            // Validate price
            if (!priceInput || !priceInput.value || parseFloat(priceInput.value) <= 0) {
                errors.push(`Product #${index + 1}: Valid price is required.`);
                missingFields.push({ element: priceInput, message: 'Price must be greater than 0' });
                highlightError(priceInput, 'Price required');
            } else {
                clearError(priceInput);
            }
        } else {
            // If no product is selected, clear potential errors
            clearError(batchSelect);
            clearError(staffSelect);
            clearError(qtyInput);
            clearError(priceInput);
        }
    });

    // 4. Check if at least one service or product is added
    if (!hasValidService && !hasValidProduct) {
        errors.push('At least one service or product must be added.');
        showNotification('‚ö†Ô∏è Please add at least one service or product to the invoice', 'warning', 5000);
    }

    // 5. Validate Payment Method
    const paymentMethod = form.querySelector('select[name="payment_method"]');
    if (!paymentMethod || !paymentMethod.value) {
        errors.push('Payment method is required.');
        missingFields.push({ element: paymentMethod, message: 'Payment method is required' });
        highlightError(paymentMethod, 'Payment method required');
    } else {
        clearError(paymentMethod);
    }

    // 6. Display validation results
    if (errors.length > 0) {
        const errorMessage = `
‚ö†Ô∏è Please fix the following issues before saving:

${errors.join('\n')}
        `.trim();

        showNotification(errorMessage, 'error', 10000);

        // Scroll to the first error element and focus it
        if (missingFields.length > 0 && missingFields[0].element) {
            missingFields[0].element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            missingFields[0].element.focus();
        }

        return false; // Indicate validation failure
    }

    return true; // Indicate validation success
}

// Visual error highlighting and feedback
function highlightError(element, message) {
    if (!element) return;

    element.classList.add('is-invalid');
    // Ensure custom styles don't conflict with bootstrap's .is-invalid
    element.style.borderColor = '#dc3545';
    element.style.boxShadow = '0 0 0 0.2rem rgba(220, 53, 69, 0.25)';

    // Add or update the error message div
    let errorDiv = element.parentElement.querySelector('.invalid-feedback');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.className = 'invalid-feedback';
        errorDiv.style.display = 'block'; // Make it visible
        element.parentElement.appendChild(errorDiv);
    }
    errorDiv.textContent = message;
}

function clearError(element) {
    if (!element) return;

    element.classList.remove('is-invalid');
    // Reset styles to default or their original values
    element.style.borderColor = '';
    element.style.boxShadow = '';

    // Remove the error message div if it exists
    const errorDiv = element.parentElement.querySelector('.invalid-feedback');
    if (errorDiv) {
        errorDiv.remove();
    }
}

// Clear errors dynamically as user corrects input
function setupValidationListeners() {
    const form = document.getElementById('billingForm');
    if (!form) return;

    // Listen for changes on select elements
    form.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', () => clearError(select));
    });

    // Listen for input events on number and text inputs
    form.querySelectorAll('input[type="number"], input[type="text"], textarea').forEach(input => {
        input.addEventListener('input', () => clearError(input));
    });

    // Special handling for dynamic rows (services and products)
    // Use event delegation on the container
    const servicesContainer = document.getElementById('servicesContainer');
    if (servicesContainer) {
        servicesContainer.addEventListener('change', (e) => {
            if (e.target.matches('select[name="service_ids[]"], select[name="staff_ids[]"], input[name="service_quantities[]"]')) {
                clearError(e.target);
            }
        });
        servicesContainer.addEventListener('input', (e) => {
             if (e.target.matches('input[name="service_quantities[]"]')) {
                clearError(e.target);
            }
        });
    }

    const productsContainer = document.getElementById('productsContainer');
    if (productsContainer) {
        productsContainer.addEventListener('change', (e) => {
            if (e.target.matches('select[name="product_ids[]"], select[name="batch_ids[]"], select[name="product_staff_ids[]"], input[name="product_quantities[]"], input[name="product_prices[]"]')) {
                clearError(e.target);
            }
        });
         productsContainer.addEventListener('input', (e) => {
             if (e.target.matches('input[name="product_quantities[]"], input[name="product_prices[]"]')) {
                clearError(e.target);
            }
        });
    }
}
</script>
{% endblock %}