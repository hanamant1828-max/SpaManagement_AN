🏗 System Plan

1. Database Integration

InvoiceItem model must include:

product_id (FK → InventoryProduct)

batch_id (FK → InventoryBatch)

quantity

unit_price

total_price

Ensure stock reduction always happens at batch level (never directly on product).

If required quantity > available in one batch, implement auto batch allocation (FIFO by expiry date).

2. Business Logic

When adding a product in billing:

Fetch all active batches of that product with stock > 0.

Auto-select the oldest (nearest expiry) batch for fast checkout.

If multiple batches needed, split consumption automatically.

Deduct quantity from selected batch(es).

Log consumption in InventoryConsumption table with invoice_id.

3. UI / Wireframe (integrated_billing.html)

+-------------------------------------------------------------+
|                CREATE INVOICE (with Batches)                |
+-------------------------------------------------------------+
| Customer: [ Dropdown v ]    Date: [ 2025-09-14 ]            |
|-------------------------------------------------------------|
| Services Section:                                            |
|  [ + Add Service ]                                          |
|                                                             |
| Products & Inventory Section:                               |
|  ---------------------------------------------------------  |
|  | Product       | Batch        | Expiry   | Qty | Price |  |
|  ---------------------------------------------------------  |
|  | Shampoo 200ml | B123 (FIFO) | 12/2025  | [2] |  ₹500 |  |
|  | Serum 50ml    | B201        | 03/2026  | [1] |  ₹800 |  |
|  ---------------------------------------------------------  |
|  [ + Add Product Row ]                                      |
|-------------------------------------------------------------|
| Subtotal: ₹1800   Tax: ₹324   Discount: ₹0   Total: ₹2124   |
|-------------------------------------------------------------|
| Payment: [Cash] [Card] [Split]                             |
|-------------------------------------------------------------|
| [ SAVE INVOICE ]                                            |
+-------------------------------------------------------------+


UI Notes

Product dropdown → fetches product list

Auto-load batch (FIFO by expiry) → show expiry + available stock inline

Quantity entry reduces stock in real-time

Invoice saves both product_id and batch_id

4. API Endpoints

/integrated-billing/create → Accepts service + product + batch info

/api/inventory/batches/<product_id> → Returns active batches with stock & expiry

/integrated-billing/invoice/<id> → Shows invoice with product + batch details

5. Reporting

Revenue per batch

Stock usage per batch

Expired batch prevention (don’t allow selection of expired batch)

✅ Deliverables

Update InvoiceItem model with batch_id.

Update invoice creation logic to deduct stock from batches.

Update UI (wireframe given above).

Ensure real-time validation (don’t allow billing from expired or empty batch).

Add batch info to invoice display + reports.

👉 Goal: Make billing and inventory fully integrated at batch level, with fast auto-selection (FIFO), clean UI, and accurate reporting.