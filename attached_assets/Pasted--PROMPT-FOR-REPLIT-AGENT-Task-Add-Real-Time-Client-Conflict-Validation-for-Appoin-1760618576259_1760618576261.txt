# üìã PROMPT FOR REPLIT AGENT:

---

## Task: Add Real-Time Client Conflict Validation for Appointments

### What needs to happen:
When a user fills out the appointment booking form and changes the **Start Time**, **End Time**, **Date**, or **Client**, the system should IMMEDIATELY check if that client already has another appointment at the same time and show a warning.

### Which appointments should be checked for conflicts:
1. ‚úÖ All **scheduled** appointments (future or past)
2. ‚úÖ All **confirmed** appointments (future or past)
3. ‚úÖ All **in_progress** appointments
4. ‚úÖ ALL **unpaid** appointments (payment_status = 'pending' or 'partial') - even if they are old/past dates
5. ‚ùå IGNORE cancelled appointments
6. ‚ùå IGNORE no_show appointments
7. ‚ùå IGNORE completed appointments that are already paid

### When to trigger the check:
- User changes the **Start Time** dropdown ‚Üí wait 300ms ‚Üí check for conflicts
- User changes the **End Time** dropdown ‚Üí wait 300ms ‚Üí check for conflicts
- User changes the **Date** picker ‚Üí wait 300ms ‚Üí check for conflicts
- User changes the **Client** dropdown ‚Üí wait 300ms ‚Üí check for conflicts

### What to check BEFORE making API call:
1. First check: Is the client selected? Is date filled? Is start time filled? Is end time filled?
   - If ANY field is empty ‚Üí don't check, just clear any errors
2. Second check: Is end time AFTER start time?
   - If NO ‚Üí show error "End time must be after start time" immediately, don't call API

### Backend API needed:
Create endpoint: `POST /api/unaki/check-client-conflicts`

**Receives:**
- client_id (number)
- appointment_date (string like "2025-10-20")
- start_time (string like "14:30")
- end_time (string like "15:30")

**Logic:**
1. Find all appointments in database WHERE:
   - client_id matches
   - appointment_date matches
   - Time overlaps (appointment.start_time < new.end_time AND appointment.end_time > new.start_time)
   - AND EITHER:
     - status is 'scheduled' OR 'confirmed' OR 'in_progress'
     - OR payment_status is 'pending' OR 'partial'
   - BUT NOT cancelled or no_show

2. If found conflicts ‚Üí return them
3. If no conflicts ‚Üí return success

**Returns when conflict found:**
```
{
  "success": true,
  "has_conflict": true,
  "conflicts": [
    {
      "appointment_id": 123,
      "service_name": "Massage",
      "staff_name": "John Doe",
      "start_time": "14:00",
      "end_time": "15:00",
      "payment_status": "pending",
      "service_price": 500
    }
  ]
}
```

**Returns when no conflict:**
```
{
  "success": true,
  "has_conflict": false
}
```

### Frontend behavior needed:

**While checking (loading state):**
- Show small spinner with text "Checking availability..."
- Show in blue/info color

**When conflict found:**
- Show red error message in the appointment card that says:
  - "‚ö†Ô∏è [Client Name] already has [Service Name] from [Start Time] to [End Time] with [Staff Name]"
  - If appointment is UNPAID, add text: "[UNPAID - ‚Çπ500]" in red
- Change border color of Date, Start Time, and End Time fields to RED
- Add a class "has-conflict" to the appointment card
- DISABLE the "Book All Appointments" button
- Change button text to "Resolve Conflicts First"

**When no conflict (success):**
- Hide the error message
- Change border color of Date, Start Time, and End Time fields to GREEN
- Remove "has-conflict" class from appointment card
- ENABLE the "Book All Appointments" button (if all other validations pass)

**When fields are empty:**
- Clear any error messages
- Reset border colors to default gray
- Remove "has-conflict" class

### Where to add this:
1. Create the new API endpoint in the backend routes file
2. Add the validation JavaScript function to the existing `<script>` section in the HTML
3. Hook it into the existing event listeners for the time/date/client dropdown changes
4. Update the `updateSubmitButton()` function to check for "has-conflict" class

### Important notes:
- Wait 300 milliseconds after user stops typing/selecting before making the API call (debouncing)
- Check conflicts for PAST unpaid appointments too, not just future appointments
- If multiple appointments conflict, show the first one
- The validation should work for each appointment card in multi-appointment booking
- Don't block the user from typing/selecting, just show warnings

### Test scenarios to verify:
1. Client has unpaid appointment at 2:00 PM ‚Üí Try booking same client at 2:00 PM ‚Üí Should show red error
2. Client has unpaid appointment at 2:00 PM ‚Üí Try booking same client at 3:00 PM ‚Üí Should show green success
3. Change start time from 9:00 AM to 2:00 PM (where conflict exists) ‚Üí Error should appear after 300ms
4. Change client from "John" to "Sarah" ‚Üí Should re-check conflicts for Sarah

---

**Instructions for Replit Agent:**
Read all the requirements above and implement this feature. Create the backend API endpoint and add the frontend validation logic to check for client conflicts in real-time, including past unpaid appointments.