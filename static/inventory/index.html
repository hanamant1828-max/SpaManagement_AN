
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .tab-content {
            min-height: 600px;
        }
        .loading-spinner {
            text-align: center;
            padding: 50px;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1055;
        }
        .nav-pills .nav-link {
            color: #6c757d;
            border-radius: 8px;
            margin: 2px;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-warehouse me-2"></i>Inventory Management</h2>
            <a href="/dashboard" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
            </a>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-pills mb-4" id="inventoryTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="fas fa-chart-dashboard me-1"></i>Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="products-tab" data-bs-toggle="pill" data-bs-target="#products" type="button" role="tab">
                    <i class="fas fa-box me-1"></i>Product Master
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="categories-tab" data-bs-toggle="pill" data-bs-target="#categories" type="button" role="tab">
                    <i class="fas fa-tags me-1"></i>Categories
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="locations-tab" data-bs-toggle="pill" data-bs-target="#locations" type="button" role="tab">
                    <i class="fas fa-map-marker-alt me-1"></i>Locations
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="adjustments-tab" data-bs-toggle="pill" data-bs-target="#adjustments" type="button" role="tab">
                    <i class="fas fa-plus-circle me-1"></i>Add Inventory
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="consumption-tab" data-bs-toggle="pill" data-bs-target="#consumption" type="button" role="tab">
                    <i class="fas fa-minus-circle me-1"></i>Consumption
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="transfers-tab" data-bs-toggle="pill" data-bs-target="#transfers" type="button" role="tab">
                    <i class="fas fa-exchange-alt me-1"></i>Stock Transfers
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="inventoryTabContent">
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading dashboard...</p>
                </div>
            </div>
            <div class="tab-pane fade" id="products" role="tabpanel">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading products...</p>
                </div>
            </div>
            <div class="tab-pane fade" id="categories" role="tabpanel">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading categories...</p>
                </div>
            </div>
            <div class="tab-pane fade" id="locations" role="tabpanel">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading locations...</p>
                </div>
            </div>
            <div class="tab-pane fade" id="adjustments" role="tabpanel">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading adjustments...</p>
                </div>
            </div>
            <div class="tab-pane fade" id="consumption" role="tabpanel">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading consumption...</p>
                </div>
            </div>
            <div class="tab-pane fade" id="transfers" role="tabpanel">
                <div class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading transfers...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables and functions
        window.inventoryGlobals = {
            loadedTabs: new Set(),
            activeScripts: new Map()
        };

        // Enhanced tab loading system
        function loadTab(tabName) {
            const tabPane = document.getElementById(tabName);
            if (!tabPane) return;

            // Prevent duplicate loading
            if (window.inventoryGlobals.loadedTabs.has(tabName)) {
                return;
            }

            console.log(`Loading ${tabName} tab...`);
            
            fetch(`/static/inventory/${tabName}.html`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to load ${tabName}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(html => {
                    // Clean up any existing scripts for this tab
                    if (window.inventoryGlobals.activeScripts.has(tabName)) {
                        const oldScripts = window.inventoryGlobals.activeScripts.get(tabName);
                        oldScripts.forEach(script => {
                            if (script.parentNode) {
                                script.parentNode.removeChild(script);
                            }
                        });
                    }

                    // Parse HTML and separate content from scripts
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    // Extract content (everything except scripts)
                    const contentElement = doc.body || doc.documentElement;
                    const scripts = Array.from(contentElement.getElementsByTagName('script'));
                    
                    // Remove scripts from content
                    scripts.forEach(script => script.remove());
                    
                    // Set the content
                    tabPane.innerHTML = contentElement.innerHTML;

                    // Execute scripts in isolated context
                    const newScripts = [];
                    scripts.forEach((originalScript, index) => {
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        
                        // Get script content
                        const scriptContent = originalScript.textContent || originalScript.innerText;
                        if (scriptContent.trim()) {
                            // Simply execute the script content directly to avoid scope issues
                            script.textContent = scriptContent;
                            document.head.appendChild(script);
                            newScripts.push(script);
                        }
                    });

                    // Store script references for cleanup
                    window.inventoryGlobals.activeScripts.set(tabName, newScripts);
                    
                    // Mark as loaded
                    window.inventoryGlobals.loadedTabs.add(tabName);
                    
                    console.log(`${tabName} tab loaded successfully`);
                })
                .catch(error => {
                    console.error(`Error loading ${tabName}:`, error);
                    tabPane.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <h4 class="alert-heading">Error Loading ${tabName}</h4>
                            <p>Failed to load the ${tabName} content. Please try refreshing the page.</p>
                            <hr>
                            <p class="mb-0">Error: ${error.message}</p>
                        </div>
                    `;
                });
        }

        // Global toast function
        window.showToast = function(message, type = 'success') {
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1055';
                document.body.appendChild(toastContainer);
            }

            const toastId = 'toast-' + Date.now();
            const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';

            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
            toast.show();

            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        };

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Bootstrap loaded successfully');
            
            // Initialize Bootstrap components
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            console.log('Bootstrap components initialized successfully');

            // Load dashboard tab initially
            loadTab('dashboard');

            // Handle tab changes
            const tabElements = document.querySelectorAll('#inventoryTabs button[data-bs-toggle="pill"]');
            tabElements.forEach(tabElement => {
                tabElement.addEventListener('shown.bs.tab', function(event) {
                    const targetId = event.target.getAttribute('data-bs-target').substring(1);
                    loadTab(targetId);
                });
            });
        });
    </script>
</body>
</html>
