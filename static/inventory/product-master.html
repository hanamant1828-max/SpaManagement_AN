<div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="fas fa-box me-2"></i>Product Master</h3>
        <button id="btnAddProduct" class="btn btn-primary" type="button">
            <i class="fas fa-plus me-1"></i>Add Product
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="productSearch" placeholder="Search products...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="in_stock">In Stock</option>
                        <option value="low_stock">Low Stock</option>
                        <option value="out_of_stock">Out of Stock</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" onclick="clearFilters()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="productTable">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Current Stock</th>
                            <th>Status</th>
                            <th>Locations</th>
                            <th>Cost Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <tr>
                            <td colspan="8" class="text-center text-muted">Loading products...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productSku" class="form-label">SKU <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productSku" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productName" class="form-label">Product Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="productName" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productCategory" class="form-label">Category</label>
                                <select class="form-select" id="productCategory">
                                    <option value="">Select category</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productUnit" class="form-label">Unit of Measure</label>
                                <select class="form-select" id="productUnit">
                                    <option value="pcs">Pieces</option>
                                    <option value="ml">Milliliters</option>
                                    <option value="l">Liters</option>
                                    <option value="g">Grams</option>
                                    <option value="kg">Kilograms</option>
                                    <option value="oz">Ounces</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productStock" class="form-label">Current Stock</label>
                                <input type="number" class="form-control" id="productStock" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productMinStock" class="form-label">Min Stock Level</label>
                                <input type="number" class="form-control" id="productMinStock" min="0" step="0.01" value="10">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productReorderLevel" class="form-label">Reorder Level</label>
                                <input type="number" class="form-control" id="productReorderLevel" min="0" step="0.01" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productCostPrice" class="form-label">Cost Price</label>
                                <input type="number" class="form-control" id="productCostPrice" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productLocation" class="form-label">Primary Location</label>
                                <select class="form-select" id="productLocation">
                                    <option value="">Select location</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="productDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="productDescription" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productBarcode" class="form-label">Barcode</label>
                                <input type="text" class="form-control" id="productBarcode">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check mt-4">
                                    <input class="form-check-input" type="checkbox" id="productTrackBatches">
                                    <label class="form-check-label" for="productTrackBatches">
                                        Track Batches
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="productTrackSerials">
                                    <label class="form-check-label" for="productTrackSerials">
                                        Track Serial Numbers
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveProductBtn" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    console.log('ðŸš€ Product Master Script Loading - START');
    console.log('ðŸš€ Current URL:', window.location.href);
    console.log('ðŸš€ DOM Ready State:', document.readyState);
    console.log('ðŸš€ Bootstrap available:', typeof bootstrap !== 'undefined');

    // Isolated scope for product master tab
    let editingProductId = null;
    let productModal = null;

    // Utility function to calculate total stock across all locations
    function calculateTotalStock(product) {
        if (product.locationStock) {
            return Object.values(product.locationStock).reduce((total, stock) => total + (stock || 0), 0);
        }
        return product.currentStock || product.stock || 0;
    }

    function loadProducts() {
        console.log('Loading products from API...');

        // Show loading state
        const tbody = document.getElementById('productTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Loading products...</td></tr>';
        }

        // Try to load from API first
        fetch('/api/inventory/products/master')
            .then(response => {
                if (!response.ok) {
                    throw new Error('API not available');
                }
                return response.json();
            })
            .then(products => {
                console.log('Products loaded from API:', products.length);
                displayProducts(products);
            })
            .catch(error => {
                console.error('Failed to load products from API:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load products from database</td></tr>';
            });
    }

    function displayProducts(products) {
        const tbody = document.getElementById('productTableBody');
        if (!tbody) return;

        let productsHTML = '';

        if (products.length > 0) {
            const searchTerm = document.getElementById('productSearch')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';

            // Apply filters
            const filteredProducts = products.filter(product => {
                const matchesSearch = !searchTerm || 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.sku.toLowerCase().includes(searchTerm);

                const matchesCategory = !categoryFilter || 
                    product.categoryId === categoryFilter || 
                    product.category_id === categoryFilter;

                const matchesStatus = !statusFilter || product.status === statusFilter;

                return matchesSearch && matchesCategory && matchesStatus;
            });

            filteredProducts.forEach(product => {
                const stock = calculateTotalStock(product);
                const statusBadge = getStatusBadge(product.status || 'in_stock');
                const categoryBadge = product.category ? 
                    `<span class="badge" style="background-color: ${product.category_color || '#6c757d'}">${product.category}</span>` : 
                    '<span class="text-muted">â€”</span>';

                productsHTML += `
                    <tr>
                        <td><strong>${product.sku}</strong></td>
                        <td>${product.name}</td>
                        <td>${categoryBadge}</td>
                        <td>
                            <strong>${stock}</strong> ${product.unit_of_measure || product.unit || 'pcs'}
                        </td>
                        <td>${statusBadge}</td>
                        <td>${product.location || product.primaryLocation || 'â€”'}</td>
                        <td>$${(product.cost_price || product.costPrice || 0).toFixed(2)}</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="editProduct('${product.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="adjustStock('${product.id}')" title="Adjust Stock">
                                    <i class="fas fa-plus-minus"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteProduct('${product.id}')" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        if (productsHTML === '') {
            productsHTML = '<tr><td colspan="8" class="text-center text-muted">No products found</td></tr>';
        }

        tbody.innerHTML = productsHTML;
    }

    function getStatusBadge(status) {
        const statusMap = {
            'in_stock': '<span class="badge bg-success">In Stock</span>',
            'low_stock': '<span class="badge bg-warning">Low Stock</span>',
            'out_of_stock': '<span class="badge bg-danger">Out of Stock</span>',
            'reorder_needed': '<span class="badge bg-info">Reorder</span>'
        };
        return statusMap[status] || '<span class="badge bg-secondary">Unknown</span>';
    }

    function loadCategories() {
        console.log('Loading categories from database...');

        fetch('/api/inventory/categories')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Categories API not available');
                }
                return response.json();
            })
            .then(data => {
                // Handle both array and object responses
                const categories = Array.isArray(data) ? data : (data.categories || []);
                populateCategoryDropdowns(categories);
            })
            .catch(error => {
                console.error('Categories API failed:', error);
                // Create empty dropdown if API fails
                populateCategoryDropdowns([]);
            });
    }

    function populateCategoryDropdowns(categories) {
        const categoryFilter = document.getElementById('categoryFilter');
        const productCategory = document.getElementById('productCategory');

        if (categoryFilter) {
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            categories.filter(cat => cat.is_active !== false).forEach(category => {
                categoryFilter.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }

        if (productCategory) {
            productCategory.innerHTML = '<option value="">Select category</option>';
            categories.filter(cat => cat.is_active !== false).forEach(category => {
                productCategory.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }

        console.log('Categories loaded successfully:', categories.length);
    }

    function loadLocations() {
        console.log('Loading locations from database...');

        fetch('/api/inventory/locations')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Locations API not available');
                }
                return response.json();
            })
            .then(data => {
                // Handle both array and object responses
                const locations = Array.isArray(data) ? data : (data.locations || []);
                populateLocationDropdowns(locations);
            })
            .catch(error => {
                console.error('Locations API failed:', error);
                // Create empty dropdown if API fails
                populateLocationDropdowns([]);
            });
    }

    function populateLocationDropdowns(locations) {
        const productLocation = document.getElementById('productLocation');

        if (productLocation) {
            productLocation.innerHTML = '<option value="">Select location</option>';
            locations.filter(loc => loc.status === 'active').forEach(location => {
                productLocation.innerHTML += `<option value="${location.id}">${location.name}</option>`;
            });
        }

        console.log('Locations loaded successfully:', locations.length);
    }

    function showAddProductModal() {
        console.log('ðŸ”§ Opening Add Product modal...');

        // Reset form
        document.getElementById('productModalTitle').textContent = 'Add Product';
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        editingProductId = null;

        // Set default values
        document.getElementById('productStock').value = '0';
        document.getElementById('productMinStock').value = '10';
        document.getElementById('productReorderLevel').value = '0';
        document.getElementById('productCostPrice').value = '0';
        document.getElementById('productUnit').value = 'pcs';

        // Show modal
        if (!productModal) {
            productModal = new bootstrap.Modal(document.getElementById('productModal'));
        }
        productModal.show();

        console.log('ðŸ”§ Add Product modal opened successfully');
    }

    function populateProductDropdowns(categoryId, locationId) {
        // Set category selection if provided
        if (categoryId) {
            const categorySelect = document.getElementById('productCategory');
            if (categorySelect) {
                categorySelect.value = categoryId;
            }
        }

        // Set location selection if provided  
        if (locationId) {
            const locationSelect = document.getElementById('productLocation');
            if (locationSelect) {
                locationSelect.value = locationId;
            }
        }
    }

    // Global functions for onclick handlers
    window.editProduct = function(productId) {
        // Fetch product data from API, fallback to localStorage if API fails
        fetch(`/api/inventory/products/${productId}`)
            .then(response => {
                if (!response.ok) throw new Error('API not available');
                return response.json();
            })
            .then(product => {
                populateEditForm(product);
            })
            .catch(error => {
                console.error('Failed to load product from API:', error);
                alert('Failed to load product data from database');
            });

        function populateEditForm(product) {
            editingProductId = productId;

            // Set modal title and populate form
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('productSku').value = product.sku;
            document.getElementById('productName').value = product.name;

            // Populate form fields
            document.getElementById('productUnit').value = product.unit || 'pcs';
            document.getElementById('productStock').value = calculateTotalStock(product);
            document.getElementById('productMinStock').value = product.minStock || 10;
            document.getElementById('productReorderLevel').value = product.reorderLevel || 0;
            document.getElementById('productCostPrice').value = product.costPrice || 0;
            document.getElementById('productTrackBatches').checked = product.trackBatches || false;
            document.getElementById('productTrackSerials').checked = product.trackSerials || false;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productLocation').value = product.primaryLocation || '';
            document.getElementById('productBarcode').value = product.barcode || '';

            // Populate dropdowns with selected values
            populateProductDropdowns(product.categoryId, product.primaryLocation);

            if (!productModal) {
                productModal = new bootstrap.Modal(document.getElementById('productModal'));
            }
            productModal.show();
        }
    }

    window.saveProduct = function() {
        console.log('ðŸ”§ Saving product...');

        const saveBtn = document.getElementById('saveProductBtn');
        const originalText = saveBtn.innerHTML;

        try {
            // Get form data
            const productData = {
                id: editingProductId || 'prod_' + Date.now(),
                sku: document.getElementById('productSku').value.trim(),
                name: document.getElementById('productName').value.trim(),
                categoryId: document.getElementById('productCategory').value,
                unit: document.getElementById('productUnit').value,
                stock: parseFloat(document.getElementById('productStock').value) || 0,
                minStock: parseFloat(document.getElementById('productMinStock').value) || 10,
                reorderLevel: parseFloat(document.getElementById('productReorderLevel').value) || 0,
                costPrice: parseFloat(document.getElementById('productCostPrice').value) || 0,
                primaryLocation: document.getElementById('productLocation').value,
                description: document.getElementById('productDescription').value.trim(),
                barcode: document.getElementById('productBarcode').value.trim(),
                trackBatches: document.getElementById('productTrackBatches').checked,
                trackSerials: document.getElementById('productTrackSerials').checked
            };

            // Validation
            if (!productData.sku.trim()) {
                showToast('SKU is required', 'danger');
                return;
            }
            if (!productData.name.trim()) {
                showToast('Product name is required', 'danger');
                return;
            }
            if (!productData.categoryId) {
                showToast('Please select a category. If no categories are available, please create one first.', 'danger');
                return;
            }
            if (!productData.primaryLocation) {
                showToast('Please select a location. If no locations are available, please create one first.', 'danger');
                return;
            }
            if (!productData.unit.trim()) {
                showToast('Unit of measure is required', 'danger');
                return;
            }

            // Show saving state
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

            // Try API first, fallback to localStorage
            const isEdit = !!editingProductId;
            const apiUrl = isEdit ? `/api/inventory/products/${editingProductId}` : '/api/inventory/products';
            const method = isEdit ? 'PUT' : 'POST';

            fetch(apiUrl, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(productData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || 'API save failed') });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('Product saved via API');
                    if (productModal) {
                        productModal.hide();
                    }
                    loadProducts();
                    showToast(data.message || 'Product saved successfully!', 'success');
                } else {
                    throw new Error(data.error || 'API save failed');
                }
            })
            .catch(error => {
                console.error('Failed to save product via API:', error);
                showToast(`Database Error: ${error.message}`, 'danger');
            })
            .finally(() => {
                // Reset button state
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            });

        } catch (error) {
            console.error('Error saving product:', error);
            showToast('Error saving product. Please try again.', 'danger');
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    }

    window.deleteProduct = function(productId) {
        if (confirm('Are you sure you want to delete this product?')) {
            // Try API first, fallback to localStorage
            fetch(`/api/inventory/products/${productId}`, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.error || 'API delete failed') });
                    }
                    return response.json();
                })
                .then(data => {
                    showToast(data.message || 'Product deleted successfully!', 'success');
                    loadProducts();
                })
                .catch(error => {
                    console.error('Failed to delete product via API:', error);
                    showToast(`Database Error: ${error.message}`, 'danger');
                });
        }
    }

    window.clearFilters = function() {
        document.getElementById('productSearch').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('statusFilter').value = '';
        loadProducts();
    }

    window.adjustStock = function(productId) {
        alert(`Stock adjustment for product ${productId} will open the adjustments modal in the next update.`);
    }

    // Toast notification function
    function showToast(message, type = 'info') {
        const toastContainer = document.getElementById('toastContainer') || createToastContainer();
        const toastId = `toast_${Date.now()}`;
        const toastHtml = `
            <div id="${toastId}" class="toast fade show align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        toastContainer.innerHTML += toastHtml;

        const toastElement = document.getElementById(toastId);
        const bsToast = new bootstrap.Toast(toastElement);
        bsToast.show();

        // Remove toast from DOM after it's hidden
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.id = 'toastContainer';
        container.style.position = 'fixed';
        container.style.top = '10px';
        container.style.right = '10px';
        container.style.zIndex = '1050'; // Ensure it's above most elements
        document.body.appendChild(container);
        return container;
    }

    // Event listeners setup
    function setupEventListeners() {
        console.log('ðŸ”§ Setting up Product Master event listeners...');

        const btnAddProduct = document.getElementById('btnAddProduct');
        const productSearch = document.getElementById('productSearch');
        const categoryFilter = document.getElementById('categoryFilter');
        const statusFilter = document.getElementById('statusFilter');

        console.log('ðŸ”§ Add Product Button Element:', btnAddProduct);

        if (btnAddProduct) {
            console.log('ðŸ”§ Attaching click event listener to Add Product button...');
            btnAddProduct.addEventListener('click', function(e) {
                console.log('ðŸ”§ Add Product button clicked!');
                e.preventDefault();
                showAddProductModal();
            });
            console.log('ðŸ”§ Add Product button event listener attached successfully');
        } else {
            console.error('ðŸ”§ Add Product button not found!');
        }

        // Search and filter event listeners
        if (productSearch) {
            productSearch.addEventListener('input', function() {
                loadProducts();
            });
        }

        if (categoryFilter) {
            categoryFilter.addEventListener('change', function() {
                loadProducts();
            });
        }

        if (statusFilter) {
            statusFilter.addEventListener('change', function() {
                loadProducts();
            });
        }

        console.log('ðŸ”§ All event listeners set up successfully');
    }

    // Initialize everything when DOM is ready
    function initializeProductMaster() {
        console.log('ðŸ”§ Initializing Product Master...');

        // Ensure DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setupEventListeners();
                loadCategories();
                loadLocations();
                loadProducts();
            });
        } else {
            // DOM is already ready
            setTimeout(() => {
                setupEventListeners();
                loadCategories();
                loadLocations();
                loadProducts();
            }, 100);
        }

        console.log('ðŸ”§ Product Master initialization complete');
    }

    // Initialize
    initializeProductMaster();

    console.log('ðŸš€ Product Master Script Loading - END');
})();
</script>