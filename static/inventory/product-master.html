<div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="fas fa-box me-2"></i>Product Master</h3>
        <button id="btnAddProduct" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Add Product
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="productSearch" placeholder="Search products...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="in_stock">In Stock</option>
                        <option value="low_stock">Low Stock</option>
                        <option value="out_of_stock">Out of Stock</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" onclick="clearFilters()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="productTable">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Current Stock</th>
                            <th>Status</th>
                            <th>Locations</th>
                            <th>Cost Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">SKU *</label>
                            <input type="text" class="form-control" id="productSku" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="productCategory">
                                <option value="">Select category</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Unit</label>
                            <select class="form-select" id="productUnit">
                                <option value="pcs">Pieces</option>
                                <option value="kg">Kilograms</option>
                                <option value="g">Grams</option>
                                <option value="l">Liters</option>
                                <option value="ml">Milliliters</option>
                                <option value="box">Boxes</option>
                                <option value="bottle">Bottles</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Current Stock</label>
                            <input type="number" class="form-control" id="productStock" value="0" step="0.01" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Min Stock Level</label>
                            <input type="number" class="form-control" id="productMinStock" value="10" step="0.01" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Reorder Level</label>
                            <input type="number" class="form-control" id="productReorderLevel" value="0" step="0.01" min="0" placeholder="Alert threshold">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Cost Price</label>
                            <input type="number" class="form-control" id="productCostPrice" value="0" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="productTrackBatches">
                                <label class="form-check-label" for="productTrackBatches">
                                    <i class="fas fa-calendar-alt me-1"></i>Track by Batches/Expiry
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="productTrackSerials">
                                <label class="form-check-label" for="productTrackSerials">
                                    <i class="fas fa-barcode me-1"></i>Track by Serial Numbers
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Primary Location</label>
                            <select class="form-select" id="productPrimaryLocation">
                                <option value="">Select primary location</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="2"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="productLocation" placeholder="e.g., Room A, Shelf 1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Barcode</label>
                            <input type="text" class="form-control" id="productBarcode">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    console.log('ðŸš€ Product Master Script Loading - START');
    console.log('ðŸš€ Current URL:', window.location.href);
    console.log('ðŸš€ DOM Ready State:', document.readyState);
    console.log('ðŸš€ Bootstrap available:', typeof bootstrap !== 'undefined');
    
    // Isolated scope for product master tab
    let editingProductId = null;

    // Utility function to calculate total stock across all locations
    function calculateTotalStock(product) {
        if (product.locationStock) {
            return Object.values(product.locationStock).reduce((total, stock) => total + (stock || 0), 0);
        }
        return product.currentStock || product.stock || 0;
    }

    function loadProducts() {
        console.log('Loading products from API...');
        
        // Show loading state
        const tbody = document.getElementById('productTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading products...</td></tr>';
        }
        
        // Fetch products from API
        fetch('/api/inventory/products')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(products => {
                console.log('Products loaded from API:', products.length);
                renderProductsTable(products);
            })
            .catch(error => {
                console.error('Error loading products:', error);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading products. Please refresh the page.</td></tr>';
                }
            });
    }
    
    function renderProductsTable(products) {
        const tbody = document.getElementById('productTableBody');
        if (!tbody) return;
        
        // Apply filters
        const searchTerm = document.getElementById('productSearch') ? document.getElementById('productSearch').value.toLowerCase() : '';
        const categoryFilter = document.getElementById('categoryFilter') ? document.getElementById('categoryFilter').value : '';
        const statusFilter = document.getElementById('statusFilter') ? document.getElementById('statusFilter').value : '';
        
        let filteredProducts = products.filter(product => {
            const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                product.sku.toLowerCase().includes(searchTerm);
            const matchesCategory = !categoryFilter || product.categoryId == categoryFilter;
            
            let matchesStatus = true;
            if (statusFilter) {
                const stock = product.current_stock || 0;
                const reorderLevel = product.reorder_level || 10;
                if (statusFilter === 'out_of_stock') matchesStatus = stock <= 0;
                else if (statusFilter === 'low_stock') matchesStatus = stock > 0 && stock <= reorderLevel;
                else if (statusFilter === 'in_stock') matchesStatus = stock > reorderLevel;
            }
            
            return matchesSearch && matchesCategory && matchesStatus;
        });
        
        tbody.innerHTML = '';
        filteredProducts.forEach(product => {
            const stock = product.current_stock || 0;
            const reorderLevel = product.reorder_level || 10;
            
            let statusBadge = 'success';
            let statusText = 'In Stock';
            let warningIcons = '';
            
            if (stock <= 0) {
                statusBadge = 'danger';
                statusText = 'Out of Stock';
                warningIcons = '<i class="fas fa-times-circle text-danger me-1" title="Out of Stock"></i>';
            } else if (stock <= reorderLevel) {
                statusBadge = 'warning';
                statusText = 'Low Stock';
                warningIcons = '<i class="fas fa-exclamation-triangle text-warning me-1" title="Low Stock Alert"></i>';
            }
            
            tbody.innerHTML += `
                <tr>
                    <td><strong>${product.sku}</strong></td>
                    <td>
                        ${warningIcons}${product.name}
                    </td>
                    <td>${product.category || '-'}</td>
                    <td><strong>${stock}</strong> ${product.unit || 'pcs'}</td>
                    <td><span class="badge bg-${statusBadge}">${statusText}</span></td>
                    <td><small>${product.location || '-'}</small></td>
                    <td>$${(product.cost_price || 0).toFixed(2)}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editProduct('${product.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${product.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
        
        if (filteredProducts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No products found</td></tr>';
        }
    }

    function loadCategories() {
        console.log('Loading categories for product master...');
        
        // Initialize default categories if none exist
        let categories = JSON.parse(localStorage.getItem('inventory.categories') || '[]');
        if (categories.length === 0) {
            categories = [
                { id: 'cat1', name: 'Skincare Products', description: 'Facial and body care products', color_code: '#ff6b6b', is_active: true },
                { id: 'cat2', name: 'Hair Care Products', description: 'Shampoos, conditioners, and styling products', color_code: '#4ecdc4', is_active: true },
                { id: 'cat3', name: 'Spa Supplies', description: 'Towels, robes, and spa accessories', color_code: '#45b7d1', is_active: true },
                { id: 'cat4', name: 'Wellness Products', description: 'Essential oils, aromatherapy products', color_code: '#f9ca24', is_active: true }
            ];
            localStorage.setItem('inventory.categories', JSON.stringify(categories));
        }
        
        // Try to load from API and update if available
        fetch('/api/inventory/categories')
            .then(response => response.json())
            .then(data => {
                if (data.categories && data.categories.length > 0) {
                    categories = data.categories;
                    localStorage.setItem('inventory.categories', JSON.stringify(categories));
                }
                populateCategoryDropdowns(categories);
            })
            .catch(error => {
                console.warn('API failed, using localStorage:', error);
                populateCategoryDropdowns(categories);
            });
    }

    function populateCategoryDropdowns(categories) {
        const categoryFilter = document.getElementById('categoryFilter');
        const productCategory = document.getElementById('productCategory');
        
        if (categoryFilter) {
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            categories.filter(cat => cat.is_active !== false).forEach(category => {
                categoryFilter.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }
        
        if (productCategory) {
            productCategory.innerHTML = '<option value="">Select category</option>';
            categories.filter(cat => cat.is_active !== false).forEach(category => {
                productCategory.innerHTML += `<option value="${category.id}">${category.name}</option>`;
            });
        }
        
        console.log('Categories loaded successfully:', categories.length);
    }

    function loadLocations() {
        console.log('Loading locations for product master...');
        
        // Initialize default locations if none exist
        let locations = JSON.parse(localStorage.getItem('inventory.locations') || '[]');
        if (locations.length === 0) {
            locations = [
                { id: 'loc1', name: 'Main Store', type: 'branch', status: 'active', address: 'Main location' },
                { id: 'loc2', name: 'Storage Room', type: 'warehouse', status: 'active', address: 'Back storage area' },
                { id: 'loc3', name: 'Treatment Room A', type: 'room', status: 'active', address: 'First treatment room' }
            ];
            localStorage.setItem('inventory.locations', JSON.stringify(locations));
        }
        
        // Try to load from API and update if available
        fetch('/api/inventory/locations')
            .then(response => response.json())
            .then(data => {
                if (data.locations && data.locations.length > 0) {
                    locations = data.locations;
                    localStorage.setItem('inventory.locations', JSON.stringify(locations));
                }
                populateLocationDropdowns(locations);
            })
            .catch(error => {
                console.warn('API failed, using localStorage:', error);
                populateLocationDropdowns(locations);
            });
    }

    function populateLocationDropdowns(locations) {
        const productLocation = document.getElementById('productPrimaryLocation');
        
        if (productLocation) {
            productLocation.innerHTML = '<option value="">Select primary location</option>';
            locations.filter(loc => loc.status === 'active').forEach(location => {
                productLocation.innerHTML += `<option value="${location.id}">${location.name}</option>`;
            });
        }
        
        console.log('Locations loaded successfully:', locations.length);
    }

    // Utility functions for dropdown loading
    function loadCategoriesIntoDropdown(dropdownId, selectedId = null) {
        let categories = JSON.parse(localStorage.getItem('inventory.categories') || '[]');
        
        // Initialize default categories if none exist
        if (categories.length === 0) {
            categories = [
                { id: 'cat1', name: 'Skincare Products', description: 'Facial and body care products', color_code: '#ff6b6b', is_active: true },
                { id: 'cat2', name: 'Hair Care Products', description: 'Shampoos, conditioners, and styling products', color_code: '#4ecdc4', is_active: true },
                { id: 'cat3', name: 'Spa Supplies', description: 'Towels, robes, and spa accessories', color_code: '#45b7d1', is_active: true },
                { id: 'cat4', name: 'Wellness Products', description: 'Essential oils, aromatherapy products', color_code: '#f9ca24', is_active: true }
            ];
            localStorage.setItem('inventory.categories', JSON.stringify(categories));
        }
        
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) {
            console.warn('Category dropdown not found:', dropdownId);
            return;
        }
        
        dropdown.innerHTML = '<option value="">Select category</option>';
        
        // Handle both old and new data formats
        categories.filter(cat => {
            return cat.is_active !== false && cat.isActive !== false;
        }).forEach(category => {
            const selected = (category.id == selectedId) ? 'selected' : '';
            dropdown.innerHTML += `<option value="${category.id}" ${selected}>${category.name}</option>`;
        });
        
        console.log(`Categories loaded into ${dropdownId}:`, categories.length);
    }

    function loadLocationsIntoDropdown(dropdownId, selectedId = null) {
        let locations = JSON.parse(localStorage.getItem('inventory.locations') || '[]');
        
        // Initialize default locations if none exist
        if (locations.length === 0) {
            locations = [
                { id: 'loc1', name: 'Main Store', type: 'branch', status: 'active', address: 'Main location' },
                { id: 'loc2', name: 'Storage Room', type: 'warehouse', status: 'active', address: 'Back storage area' },
                { id: 'loc3', name: 'Treatment Room A', type: 'room', status: 'active', address: 'First treatment room' }
            ];
            localStorage.setItem('inventory.locations', JSON.stringify(locations));
        }
        
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) {
            console.warn('Location dropdown not found:', dropdownId);
            return;
        }
        
        dropdown.innerHTML = '<option value="">Select location</option>';
        
        locations.filter(loc => loc.status === 'active').forEach(location => {
            const selected = (location.id == selectedId) ? 'selected' : '';
            dropdown.innerHTML += `<option value="${location.id}" ${selected}>${location.name}</option>`;
        });
        
        console.log(`Locations loaded into ${dropdownId}:`, locations.length);
    }

    // Comprehensive function to populate all product modal dropdowns
    function populateProductDropdowns(selectedCategoryId = null, selectedLocationId = null) {
        console.log('Populating product modal dropdowns...');
        
        // Load categories from API
        fetch('/api/inventory/categories')
            .then(response => response.json())
            .then(data => {
                const categories = data.categories || [];
                const categoryDropdown = document.getElementById('productCategory');
                if (categoryDropdown) {
                    categoryDropdown.innerHTML = '<option value="">Select category</option>';
                    const activeCategories = categories.filter(cat => cat.is_active !== false);
                    activeCategories.forEach(category => {
                        const selected = (category.id == selectedCategoryId) ? 'selected' : '';
                        categoryDropdown.innerHTML += `<option value="${category.id}" ${selected}>${category.name}</option>`;
                    });
                    console.log(`Categories populated: ${activeCategories.length} active categories`);
                }
            })
            .catch(error => {
                console.error('Error loading categories:', error);
                // Fallback to default categories
                const categoryDropdown = document.getElementById('productCategory');
                if (categoryDropdown) {
                    categoryDropdown.innerHTML = '<option value="">Select category</option>';
                    const defaultCategories = [
                        { id: '1', name: 'Skincare Products' },
                        { id: '2', name: 'Hair Care Products' },
                        { id: '3', name: 'Spa Supplies' },
                        { id: '4', name: 'Wellness Products' }
                    ];
                    defaultCategories.forEach(category => {
                        const selected = (category.id == selectedCategoryId) ? 'selected' : '';
                        categoryDropdown.innerHTML += `<option value="${category.id}" ${selected}>${category.name}</option>`;
                    });
                }
            });
        
        // Load locations from API
        fetch('/api/inventory/locations')
            .then(response => response.json())
            .then(data => {
                const locations = data.locations || [];
                const locationDropdown = document.getElementById('productPrimaryLocation');
                if (locationDropdown) {
                    locationDropdown.innerHTML = '<option value="">Select primary location</option>';
                    const activeLocations = locations.filter(loc => loc.status === 'active');
                    activeLocations.forEach(location => {
                        const selected = (location.id == selectedLocationId) ? 'selected' : '';
                        locationDropdown.innerHTML += `<option value="${location.id}" ${selected}>${location.name}</option>`;
                    });
                    console.log(`Locations populated: ${activeLocations.length} active locations`);
                }
            })
            .catch(error => {
                console.error('Error loading locations:', error);
                // Fallback to default locations
                const locationDropdown = document.getElementById('productPrimaryLocation');
                if (locationDropdown) {
                    locationDropdown.innerHTML = '<option value="">Select primary location</option>';
                    const defaultLocations = [
                        { id: 'main-branch', name: 'Main Branch' },
                        { id: 'storage-room', name: 'Storage Room' }
                    ];
                    defaultLocations.forEach(location => {
                        const selected = (location.id == selectedLocationId) ? 'selected' : '';
                        locationDropdown.innerHTML += `<option value="${location.id}" ${selected}>${location.name}</option>`;
                    });
                }
            });
    }

    function addProduct() {
        console.log('ðŸ”µ Add Product function called - START');
        console.log('ðŸ”µ Current time:', new Date().toISOString());
        
        try {
            // Reset editing state
            console.log('ðŸ”µ Resetting editing state...');
            editingProductId = null;
            
            // Check if modal exists
            console.log('ðŸ”µ Checking for modal element...');
            const modalElement = document.getElementById('productModal');
            if (!modalElement) {
                console.error('âŒ CRITICAL: Modal element #productModal not found in DOM');
                alert('Error: Product form not found. Please refresh the page.');
                return;
            }
            console.log('âœ… Modal element found:', modalElement);
            
            // Set modal title
            console.log('ðŸ”µ Setting modal title...');
            const titleElement = document.getElementById('productModalTitle');
            if (titleElement) {
                titleElement.textContent = 'Add Product';
                console.log('âœ… Modal title set successfully');
            } else {
                console.warn('âš ï¸ Modal title element not found');
            }
            
            // Reset form
            console.log('ðŸ”µ Resetting form...');
            const formElement = document.getElementById('productForm');
            if (formElement) {
                formElement.reset();
                console.log('âœ… Form reset successfully');
            } else {
                console.warn('âš ï¸ Form element not found');
            }
            
            // Clear product ID
            const productIdField = document.getElementById('productId');
            if (productIdField) {
                productIdField.value = '';
                console.log('âœ… Product ID cleared');
            }
            
            // Set default values for new product
            console.log('ðŸ”µ Setting default values...');
            const defaultValues = [
                { id: 'productStock', value: '0' },
                { id: 'productMinStock', value: '10' },
                { id: 'productReorderLevel', value: '0' },
                { id: 'productCostPrice', value: '0' },
                { id: 'productUnit', value: 'pcs' }
            ];
            
            defaultValues.forEach(item => {
                const element = document.getElementById(item.id);
                if (element) {
                    element.value = item.value;
                    console.log(`âœ… ${item.id} set to: ${item.value}`);
                } else {
                    console.warn(`âš ï¸ Element ${item.id} not found`);
                }
            });
            
            // Enable SKU field for new product
            console.log('ðŸ”µ Enabling SKU field...');
            const skuField = document.getElementById('productSku');
            if (skuField) {
                skuField.readOnly = false;
                console.log('âœ… SKU field enabled');
            } else {
                console.warn('âš ï¸ SKU field not found');
            }
            
            // Populate dropdowns with fresh data
            console.log('ðŸ”µ Populating dropdowns...');
            populateProductDropdowns();
            
            // Show modal
            console.log('ðŸ”µ Opening modal...');
            try {
                if (typeof bootstrap === 'undefined') {
                    console.error('âŒ CRITICAL: Bootstrap is not loaded');
                    alert('Error: Bootstrap not loaded. Please refresh the page.');
                    return;
                }
                
                const modal = new bootstrap.Modal(modalElement);
                console.log('âœ… Bootstrap Modal instance created:', modal);
                
                modal.show();
                console.log('âœ… Modal.show() called successfully');
                
                // Check if modal is actually visible after a delay
                setTimeout(() => {
                    const isVisible = modalElement.classList.contains('show');
                    console.log('ðŸ”µ Modal visibility check after 500ms:', isVisible);
                    if (!isVisible) {
                        console.error('âŒ Modal is not visible after show() call');
                    }
                }, 500);
                
            } catch (modalError) {
                console.error('âŒ Error creating/showing modal:', modalError);
                console.error('âŒ Modal error stack:', modalError.stack);
                alert('Error opening product form: ' + modalError.message);
                return;
            }
            
        } catch (error) {
            console.error('âŒ CRITICAL ERROR in addProduct function:', error);
            console.error('âŒ Error stack:', error.stack);
            alert('Critical error in Add Product function. Check console for details.');
        }
        
        console.log('ðŸ”µ Add Product function - END');
    }

    window.editProduct = function(productId) {
        const products = JSON.parse(localStorage.getItem('inventory.products') || '[]');
        const product = products.find(p => p.id === productId);
        
        if (product) {
            // Validation first - check if categories and locations exist
            const categories = JSON.parse(localStorage.getItem('inventory.categories') || '[]');
            const locations = JSON.parse(localStorage.getItem('inventory.locations') || '[]');
            
            const activeCategories = categories.filter(cat => cat.is_active !== false);
            const activeLocations = locations.filter(loc => loc.status === 'active');
            
            if (activeCategories.length === 0) {
                alert('Please create at least one category before editing products.');
                return;
            }
            
            if (activeLocations.length === 0) {
                alert('Please create at least one location before editing products.');
                return;
            }
            
            editingProductId = productId;
            document.getElementById('productModalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('productSku').value = product.sku;
            document.getElementById('productName').value = product.name;
            
            // Populate form fields
            document.getElementById('productUnit').value = product.unit || 'pcs';
            document.getElementById('productStock').value = calculateTotalStock(product);
            document.getElementById('productMinStock').value = product.minStock || 10;
            document.getElementById('productReorderLevel').value = product.reorderLevel || 0;
            document.getElementById('productCostPrice').value = product.costPrice || 0;
            document.getElementById('productTrackBatches').checked = product.trackBatches || false;
            document.getElementById('productTrackSerials').checked = product.trackSerials || false;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productLocation').value = product.location || '';
            document.getElementById('productBarcode').value = product.barcode || '';
            
            // Populate dropdowns with selected values immediately
            populateProductDropdowns(product.categoryId, product.primaryLocation);
            
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }
    }

    window.saveProduct = function() {
        console.log('Save Product function called');
        
        try {
            // Form validation
            const sku = document.getElementById('productSku').value.trim();
            const name = document.getElementById('productName').value.trim();
            const categoryId = document.getElementById('productCategory').value;
            const primaryLocation = document.getElementById('productPrimaryLocation').value;
            const unit = document.getElementById('productUnit').value;
            
            // Validate required fields
            if (!sku) {
                alert('SKU is required');
                document.getElementById('productSku').focus();
                return;
            }
            
            if (!name) {
                alert('Product name is required');
                document.getElementById('productName').focus();
                return;
            }
            
            if (!categoryId) {
                alert('Please select a category');
                document.getElementById('productCategory').focus();
                return;
            }
            
            if (!primaryLocation) {
                alert('Please select a primary location');
                document.getElementById('productPrimaryLocation').focus();
                return;
            }
            
            if (!unit) {
                alert('Please select a unit of measure');
                document.getElementById('productUnit').focus();
                return;
            }
            
            // Create product data object
            const productData = {
                sku: sku,
                name: name,
                categoryId: categoryId,
                unit: unit,
                stock: parseFloat(document.getElementById('productStock').value) || 0,
                minStock: parseFloat(document.getElementById('productMinStock').value) || 10,
                reorderLevel: parseFloat(document.getElementById('productReorderLevel').value) || 0,
                costPrice: parseFloat(document.getElementById('productCostPrice').value) || 0,
                trackBatches: document.getElementById('productTrackBatches').checked || false,
                trackSerials: document.getElementById('productTrackSerials').checked || false,
                primaryLocation: primaryLocation,
                description: document.getElementById('productDescription').value || '',
                location: document.getElementById('productLocation').value || '',
                barcode: document.getElementById('productBarcode').value || ''
            };
            
            console.log('Sending product data to API:', productData);
            
            // Show loading state
            const saveBtn = document.querySelector('#productModal .btn-primary');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
            }
            
            // Send to API
            const url = editingProductId ? `/api/inventory/products/${editingProductId}` : '/api/inventory/products';
            const method = editingProductId ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    const modalElement = document.getElementById('productModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Refresh the products table
                    loadProducts();
                    
                    // Show success message
                    alert(data.message);
                    
                    // Reset editing state
                    editingProductId = null;
                } else {
                    alert(data.error || 'Error saving product');
                }
            })
            .catch(error => {
                console.error('Error saving product:', error);
                alert('Error saving product. Please try again.');
            })
            .finally(() => {
                // Reset button state
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = 'Save Product';
                }
            });
            
        } catch (error) {
            console.error('Error saving product:', error);
            alert('Error saving product. Please try again.');
        }
    }

    window.deleteProduct = function(productId) {
        if (confirm('Are you sure you want to delete this product?')) {
            const products = JSON.parse(localStorage.getItem('inventory.products') || '[]');
            const filteredProducts = products.filter(p => p.id !== productId);
            localStorage.setItem('inventory.products', JSON.stringify(filteredProducts));
            loadProducts();
        }
    }

    window.clearFilters = function() {
        document.getElementById('productSearch').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('statusFilter').value = '';
        loadProducts();
    }

    // Batch management function
    window.manageBatches = function(productId) {
        const products = JSON.parse(localStorage.getItem('inventory.products') || '[]');
        const product = products.find(p => p.id === productId);
        
        if (!product) {
            alert('Product not found');
            return;
        }
        
        if (!product.trackBatches) {
            alert('Batch tracking is not enabled for this product. Edit the product to enable batch tracking first.');
            return;
        }
        
        // This would open a batch management modal - placeholder for now
        alert(`Batch management for ${product.name} will be implemented in the next update.`);
    }

    // Show stock alert notifications when stock levels change
    function checkStockAlerts(product) {
        const currentStock = calculateTotalStock(product);
        const reorderLevel = product.reorderLevel || product.minStock || 10;
        
        if (currentStock <= 0) {
            window.showStockToast && window.showStockToast(`âš ï¸ ${product.name} (${product.sku}) is out of stock!`, 'error');
        } else if (currentStock <= reorderLevel) {
            window.showStockToast && window.showStockToast(`âš ï¸ ${product.name} (${product.sku}) is below reorder level (${currentStock} left)`, 'warning');
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const btnAddProduct = document.getElementById('btnAddProduct');
        const productSearch = document.getElementById('productSearch');
        const categoryFilter = document.getElementById('categoryFilter');
        const statusFilter = document.getElementById('statusFilter');
        const productModal = document.getElementById('productModal');
        
        console.log('ðŸ”§ Event listeners setup starting...');
        console.log('ðŸ”§ Add Product Button Element:', btnAddProduct);
        
        if (btnAddProduct) {
            console.log('ðŸ”§ Attaching click event listener to Add Product button...');
            btnAddProduct.addEventListener('click', function(event) {
                event.preventDefault();
                console.log('ðŸŽ¯ ADD PRODUCT BUTTON CLICKED!');
                addProduct();
            });
            console.log('âœ… Event listener attached successfully');
        } else {
            console.error('âŒ CRITICAL: Add Product button not found!');
        }

        // Global click handler for the add product button
        document.addEventListener('click', function(event) {
            if (event.target && event.target.id === 'btnAddProduct') {
                event.preventDefault();
                console.log('ðŸŽ¯ Global handler: ADD PRODUCT BUTTON CLICKED!');
                addProduct();
            }
        });
        if (productSearch) productSearch.addEventListener('input', loadProducts);
        if (categoryFilter) categoryFilter.addEventListener('change', loadProducts);
        if (statusFilter) statusFilter.addEventListener('change', loadProducts);
        
        // Ensure dropdowns are populated whenever modal is shown
        if (productModal) {
            productModal.addEventListener('show.bs.modal', function () {
                // Small delay to ensure modal is fully rendered
                setTimeout(() => {
                    if (!editingProductId) {
                        // For add product, populate with no selection
                        populateProductDropdowns();
                    }
                    // For edit product, populateProductDropdowns is called in editProduct function
                }, 50);
            });
        }
        
        // Initialize
        console.log('ðŸ”§ Initializing product master components...');
        loadCategories();
        loadLocations();
        loadProducts();
        
        // Final status check
        setTimeout(() => {
            console.log('ðŸ”§ Post-initialization status check:');
            console.log('ðŸ”§ Add Product button after init:', document.getElementById('btnAddProduct'));
            console.log('ðŸ”§ Modal element after init:', document.getElementById('productModal'));
        }, 1000);
    });
    
    console.log('ðŸš€ Product Master Script Loading - END');
})();
</script>