<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Batch Management</h2>
            <p class="text-muted mb-0">Manage product batches with expiry tracking</p>
        </div>
        <button class="btn btn-primary" onclick="openAddBatchModal()">
            <i class="fas fa-plus"></i> Add Batch
        </button>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="filterStatus" onchange="filterBatches()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="expired">Expired</option>
                        <option value="blocked">Blocked</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchBatch" placeholder="Search batch name..." onkeyup="filterBatches()">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Assignment Status</label>
                    <select class="form-select" id="filterAssignment" onchange="filterBatches()">
                        <option value="">All Batches</option>
                        <option value="assigned">Assigned to Product</option>
                        <option value="unassigned">Not Assigned</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Batches Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Batch Inventory</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="batchesTable">
                    <thead>
                        <tr>
                            <th>Batch Name</th>
                            <th>Product</th>
                            <th>Location</th>
                            <th>Qty Available</th>
                            <th>Created Date</th>
                            <th>Mfg Date</th>
                            <th>Expiry Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="batchesTableBody">
                        <tr><td colspan="9" class="text-center text-muted">Loading batches...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Batch Modal -->
<div class="modal fade" id="batchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchModalTitle">Add Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="batchForm" onsubmit="saveBatch(event)">
                <div class="modal-body">
                    <input type="hidden" id="batchId">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Product</label>
                            <select class="form-select" id="batchProduct">
                                <option value="">Select Product (Optional)</option>
                            </select>
                            <div class="form-text">Product can be assigned later</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Location</label>
                            <select class="form-select" id="batchLocation">
                                <option value="">Select Location (Optional)</option>
                            </select>
                            <div class="form-text">Location can be assigned later</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Batch Name *</label>
                            <input type="text" class="form-control" id="batchName" required 
                                   placeholder="Enter unique batch identifier">
                            <div class="form-text">Must be globally unique</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Created Date</label>
                            <input type="date" class="form-control" id="batchCreatedDate">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Manufacturing Date *</label>
                            <input type="date" class="form-control" id="batchMfgDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Expiry Date *</label>
                            <input type="date" class="form-control" id="batchExpiryDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unit Cost</label>
                            <input type="number" class="form-control" id="batchUnitCost" step="0.01" min="0" value="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Selling Price</label>
                            <input type="number" class="form-control" id="batchSellingPrice" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Batch</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Batch Details Modal -->
<div class="modal fade" id="viewBatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Batch Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="batchDetailsContent">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variables
let allBatches = [];
let allProducts = [];
let allLocations = [];
let batchModal = null;

// Initialize batch management system
function initializeBatchManagement() {
    console.log('üîß Initializing Batch Management System...');

    // Initialize modal
    const modalElement = document.getElementById('batchModal');
    if (modalElement) {
        batchModal = new bootstrap.Modal(modalElement);
    }

    // Load all data
    Promise.all([
        loadProducts(),
        loadLocations(),
        loadBatches()
    ]).then(() => {
        console.log('‚úÖ Batch Management System initialized successfully');
        console.log(`üìä Loaded: ${allProducts.length} products, ${allLocations.length} locations, ${allBatches.length} batches`);
    }).catch(error => {
        console.error('‚ùå Error initializing Batch Management:', error);
        showToast('Error loading data. Please refresh the page.', 'danger');
    });
}

// Load products from API
async function loadProducts() {
    try {
        console.log('üì¶ Loading products...');
        const response = await fetch('/api/inventory/products');

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        allProducts = Array.isArray(data) ? data : (data.products || []);

        populateProductDropdown();
        console.log(`‚úÖ Loaded ${allProducts.length} products`);
        return allProducts;
    } catch (error) {
        console.error('‚ùå Error loading products:', error);
        allProducts = [];
        populateProductDropdown();
        throw error;
    }
}

// Load locations from API
async function loadLocations() {
    try {
        console.log('üìç Loading locations...');
        const response = await fetch('/api/inventory/locations');

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        allLocations = data.locations || [];

        populateLocationDropdown();
        console.log(`‚úÖ Loaded ${allLocations.length} locations`);
        return allLocations;
    } catch (error) {
        console.error('‚ùå Error loading locations:', error);
        allLocations = [];
        populateLocationDropdown();
        throw error;
    }
}

// Load batches from API
async function loadBatches() {
    try {
        console.log('üìã Loading batches...');
        const response = await fetch('/api/inventory/batches');

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        allBatches = data.batches || [];

        renderBatchesTable();
        console.log(`‚úÖ Loaded ${allBatches.length} batches`);
        return allBatches;
    } catch (error) {
        console.error('‚ùå Error loading batches:', error);
        const tbody = document.getElementById('batchesTableBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading batches. Please refresh.</td></tr>';
        }
        throw error;
    }
}

// Populate product dropdown
function populateProductDropdown() {
    const dropdown = document.getElementById('batchProduct');
    if (!dropdown) return;

    dropdown.innerHTML = '<option value="">Select Product (Optional)</option>';

    allProducts.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.name}${product.sku ? ` (${product.sku})` : ''}`;
        dropdown.appendChild(option);
    });

    console.log(`üì¶ Product dropdown populated with ${allProducts.length} products`);
}

// Populate location dropdown
function populateLocationDropdown() {
    const dropdown = document.getElementById('batchLocation');
    if (!dropdown) return;

    dropdown.innerHTML = '<option value="">Select Location (Optional)</option>';

    allLocations.filter(loc => loc.status === 'active').forEach(location => {
        const option = document.createElement('option');
        option.value = location.id;
        option.textContent = location.name;
        dropdown.appendChild(option);
    });

    console.log(`üìç Location dropdown populated with ${allLocations.length} locations`);
}

// Render batches table
function renderBatchesTable() {
    const tbody = document.getElementById('batchesTableBody');
    if (!tbody) return;

    const filteredBatches = getFilteredBatches();

    if (filteredBatches.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No batches found</td></tr>';
        return;
    }

    let tableHTML = '';
    filteredBatches.forEach(batch => {
        const statusClass = getStatusBadgeClass(batch.status, batch.is_expired);
        const product = allProducts.find(p => p.id === batch.product_id);
        const unitOfMeasure = product ? product.unit_of_measure : 'pcs';

        tableHTML += `
            <tr>
                <td><strong>${batch.batch_name}</strong></td>
                <td>${batch.product_name}</td>
                <td>${batch.location_name}</td>
                <td>${batch.qty_available} ${unitOfMeasure}</td>
                <td>${formatDate(batch.created_date)}</td>
                <td>${formatDate(batch.mfg_date)}</td>
                <td>${formatDate(batch.expiry_date)}</td>
                <td><span class="badge ${statusClass}">${batch.status}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="viewBatch(${batch.id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="editBatch(${batch.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteBatch(${batch.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = tableHTML;
}

// Get status badge class
function getStatusBadgeClass(status, isExpired) {
    if (isExpired) return 'bg-danger';
    switch (status) {
        case 'active': return 'bg-success';
        case 'blocked': return 'bg-warning';
        case 'expired': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

// Get filtered batches
function getFilteredBatches() {
    let filtered = [...allBatches];

    const statusFilter = document.getElementById('filterStatus')?.value;
    const assignmentFilter = document.getElementById('filterAssignment')?.value;
    const searchTerm = document.getElementById('searchBatch')?.value?.toLowerCase();

    if (statusFilter) {
        filtered = filtered.filter(batch => batch.status === statusFilter);
    }

    if (assignmentFilter === 'assigned') {
        filtered = filtered.filter(batch => batch.product_id !== null && batch.product_id !== undefined);
    } else if (assignmentFilter === 'unassigned') {
        filtered = filtered.filter(batch => batch.product_id === null || batch.product_id === undefined);
    }

    if (searchTerm) {
        filtered = filtered.filter(batch => 
            batch.batch_name.toLowerCase().includes(searchTerm)
        );
    }

    return filtered;
}

// Filter batches
function filterBatches() {
    renderBatchesTable();
}

// Open add batch modal
function openAddBatchModal() {
    console.log('‚ûï Opening Add Batch modal...');

    // Reset form
    document.getElementById('batchModalTitle').textContent = 'Add Batch';
    document.getElementById('batchForm').reset();
    document.getElementById('batchId').value = '';

    // Set default created date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('batchCreatedDate').value = today;

    // Show modal
    if (batchModal) {
        batchModal.show();
    }
}

// Edit batch
async function editBatch(batchId) {
    console.log(`‚úèÔ∏è Editing batch: ${batchId}`);

    const batch = allBatches.find(b => b.id === batchId);
    if (!batch) {
        showToast('Batch not found', 'danger');
        return;
    }

    // Set modal title and populate form
    document.getElementById('batchModalTitle').textContent = 'Edit Batch';
    document.getElementById('batchId').value = batch.id;

    // Populate form fields
    document.getElementById('batchName').value = batch.batch_name || '';
    document.getElementById('batchCreatedDate').value = batch.created_date || '';
    document.getElementById('batchMfgDate').value = batch.mfg_date || '';
    document.getElementById('batchExpiryDate').value = batch.expiry_date || '';
    document.getElementById('batchUnitCost').value = batch.unit_cost || 0;
    document.getElementById('batchSellingPrice').value = batch.selling_price || '';

    // Set dropdown values
    if (batch.product_id) {
        document.getElementById('batchProduct').value = batch.product_id;
    }
    if (batch.location_id) {
        document.getElementById('batchLocation').value = batch.location_id;
    }

    // Show modal
    if (batchModal) {
        batchModal.show();
    }
}

// Save batch
function saveBatch(event) {
    event.preventDefault();
    console.log('üíæ Saving batch...');

    const batchId = document.getElementById('batchId').value;
    const isEdit = !!batchId;

    const batchData = {
        product_id: parseInt(document.getElementById('batchProduct').value) || null,
        location_id: document.getElementById('batchLocation').value || null,
        batch_name: document.getElementById('batchName').value.trim(),
        created_date: document.getElementById('batchCreatedDate').value || null,
        mfg_date: document.getElementById('batchMfgDate').value || null,
        expiry_date: document.getElementById('batchExpiryDate').value || null,
        unit_cost: parseFloat(document.getElementById('batchUnitCost').value) || 0,
        selling_price: parseFloat(document.getElementById('batchSellingPrice').value) || null,
        status: 'active'
    };

    // Validation
    if (!batchData.batch_name) {
        showToast('Please enter a batch name', 'danger');
        return;
    }

    if (!batchData.mfg_date) {
        showToast('Please enter manufacturing date', 'danger');
        return;
    }

    if (!batchData.expiry_date) {
        showToast('Please enter expiry date', 'danger');
        return;
    }

    // Date validation
    if (batchData.mfg_date && batchData.expiry_date && batchData.expiry_date <= batchData.mfg_date) {
        showToast('Expiry date must be later than manufacturing date', 'danger');
        return;
    }

    const url = isEdit ? `/api/inventory/batches/${batchId}` : '/api/inventory/batches';
    const method = isEdit ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(batchData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Batch saved successfully!', 'success');
            if (batchModal) {
                batchModal.hide();
            }
            loadBatches(); // Reload data
        } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving batch:', error);
        showToast('Error saving batch. Please try again.', 'danger');
    });
}

// View batch details
function viewBatch(batchId) {
    console.log(`üëÅÔ∏è Viewing batch: ${batchId}`);

    const batch = allBatches.find(b => b.id === batchId);
    if (!batch) {
        showToast('Batch not found', 'danger');
        return;
    }

    const product = allProducts.find(p => p.id === batch.product_id);
    const unitOfMeasure = product ? product.unit_of_measure : 'pcs';

    const content = document.getElementById('batchDetailsContent');
    content.innerHTML = `
        <div class="row g-3">
            <div class="col-md-6">
                <strong>Product:</strong><br>
                ${batch.product_name} ${product && product.sku ? `(${product.sku})` : ''}
            </div>
            <div class="col-md-6">
                <strong>Batch Name:</strong><br>
                ${batch.batch_name}
            </div>
            <div class="col-md-6">
                <strong>Location:</strong><br>
                ${batch.location_name}
            </div>
            <div class="col-md-6">
                <strong>Quantity Available:</strong><br>
                ${batch.qty_available} ${unitOfMeasure}
            </div>
            <div class="col-md-6">
                <strong>Created Date:</strong><br>
                ${formatDate(batch.created_date)}
            </div>
            <div class="col-md-6">
                <strong>Manufacturing Date:</strong><br>
                ${formatDate(batch.mfg_date)}
            </div>
            <div class="col-md-6">
                <strong>Expiry Date:</strong><br>
                ${formatDate(batch.expiry_date)}
            </div>
            <div class="col-md-6">
                <strong>Unit Cost:</strong><br>
                $${parseFloat(batch.unit_cost || 0).toFixed(2)}
            </div>
            <div class="col-md-6">
                <strong>Status:</strong><br>
                <span class="badge ${getStatusBadgeClass(batch.status, batch.is_expired)}">${batch.status}</span>
            </div>
            <div class="col-md-6">
                <strong>Days to Expiry:</strong><br>
                ${batch.days_to_expiry !== null ? batch.days_to_expiry + ' days' : 'No expiry set'}
            </div>
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('viewBatchModal'));
    modal.show();
}

// Delete batch
function deleteBatch(batchId) {
    console.log(`üóëÔ∏è Deleting batch: ${batchId}`);

    const batch = allBatches.find(b => b.id === batchId);
    if (!batch) {
        showToast('Batch not found', 'danger');
        return;
    }

    if (!confirm(`Are you sure you want to delete batch "${batch.batch_name}"?`)) {
        return;
    }

    fetch(`/api/inventory/batches/${batchId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message || 'Batch deleted successfully!', 'success');
            loadBatches(); // Reload data
        } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting batch:', error);
        showToast('Error deleting batch. Please try again.', 'danger');
    });
}

// Format date for display
function formatDate(dateString) {
    if (!dateString) return '-';
    try {
        return new Date(dateString).toLocaleDateString('en-GB');
    } catch (error) {
        return '-';
    }
}

// Toast notification system
function showToast(message, type = 'info') {
    const toastContainer = getOrCreateToastContainer();
    const toastId = `toast_${Date.now()}`;

    const toastHTML = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;

    toastContainer.insertAdjacentHTML('beforeend', toastHTML);

    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();

    // Remove from DOM after hiding
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}

function getOrCreateToastContainer() {
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1055';
        document.body.appendChild(container);
    }
    return container;
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeBatchManagement);
} else {
    initializeBatchManagement();
}

// Export for dashboard.js
window.initializeBatchManagement = initializeBatchManagement;
</script>