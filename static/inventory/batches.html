<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">Batch Management</h2>
            <p class="text-muted mb-0">Manage product batches with expiry tracking</p>
        </div>
        <button class="btn btn-primary" onclick="openAddBatchModal()">
            <i class="fas fa-plus"></i> Add Batch
        </button>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="filterStatus" onchange="filterBatches()">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="expired">Expired</option>
                        <option value="blocked">Blocked</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchBatch" placeholder="Search batch name..." onkeyup="filterBatches()">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Assignment Status</label>
                    <select class="form-select" id="filterAssignment" onchange="filterBatches()">
                        <option value="">All Batches</option>
                        <option value="assigned">Assigned to Product</option>
                        <option value="unassigned">Not Assigned</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Batches Table -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Batch Inventory</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="batchesTable">
                    <thead>
                        <tr>
                            <th>Batch Name</th>
                            <th>Product</th>
                            <th>Location</th>
                            <th>Qty Available</th>
                            <th>Created Date</th>
                            <th>Mfg Date</th>
                            <th>Expiry Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="batchesTableBody">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Batch Modal -->
<div class="modal fade" id="batchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchModalTitle">Add Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="batchForm" onsubmit="saveBatch(event)">
                <div class="modal-body">
                    <input type="hidden" id="batchId">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Product *</label>
                            <select class="form-select" id="batchProduct" required>
                                <option value="">Select Product</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Location *</label>
                            <select class="form-select" id="batchLocation" required>
                                <option value="">Select Location</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Batch Name *</label>
                            <input type="text" class="form-control" id="batchName" required 
                                   placeholder="Enter unique batch identifier">
                            <div class="form-text">Must be unique for this product</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Created Date</label>
                            <input type="date" class="form-control" id="batchCreatedDate">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Manufacturing Date *</label>
                            <input type="date" class="form-control" id="batchMfgDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Expiry Date *</label>
                            <input type="date" class="form-control" id="batchExpiryDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unit Cost</label>
                            <input type="number" class="form-control" id="batchUnitCost" step="0.01" min="0" value="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Selling Price</label>
                            <input type="number" class="form-control" id="batchSellingPrice" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Batch</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Batch Details Modal -->
<div class="modal fade" id="viewBatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Batch Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="batchDetailsContent">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Batch Modal -->
<div class="modal fade" id="addBatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addBatchForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Product</label>
                            <select class="form-select" id="addBatchProduct" name="product_id">
                                <option value="">Select Product (Optional)</option>
                            </select>
                            <div class="form-text">Product can be assigned later during adjustments</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Location</label>
                            <select class="form-select" id="addBatchLocation" name="location_id">
                                <option value="">Select Location (Optional)</option>
                            </select>
                            <div class="form-text">Location can be assigned later during adjustments</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Batch Name *</label>
                            <input type="text" class="form-control" id="batchName" name="batch_name" required 
                                   placeholder="Enter unique batch identifier">
                            <div class="form-text">Must be globally unique</div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Created Date</label>
                            <input type="date" class="form-control" id="batchCreatedDate" name="created_date">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Manufacturing Date *</label>
                            <input type="date" class="form-control" id="batchMfgDate" name="mfg_date" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Expiry Date *</label>
                            <input type="date" class="form-control" id="batchExpiryDate" name="expiry_date" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unit Cost</label>
                            <input type="number" class="form-control" id="batchUnitCost" name="unit_cost" 
                                   step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Selling Price</label>
                            <input type="number" class="form-control" id="batchSellingPrice" name="selling_price" 
                                   step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveNewBatch()">Save Batch</button>
            </div>
        </div>
    </div>
</div>

<script>
let allBatches = [];
let allProducts = [];
let allLocations = [];

// Initialize batch management
function initializeBatchManagement() {
    console.log('🔧 Initializing Batch Management...');
    loadProducts();
    loadLocations();
    loadBatches();
}

// Initialize immediately if DOM is ready, or wait for DOMContentLoaded
if (document.readyState !== 'loading') {
    console.log('🔧 DOM ready, initializing batch management immediately...');
    initializeBatchManagement();
} else {
    console.log('🔧 DOM not ready, waiting for DOMContentLoaded...');
    document.addEventListener('DOMContentLoaded', initializeBatchManagement);
}

// Export to window so dashboard.js can call it after dynamic loading
window.initializeBatchManagement = initializeBatchManagement;

// Load products for dropdowns
function loadProducts() {
    fetch('/api/inventory/products')
        .then(response => response.json())
        .then(data => {
            console.log('Products API response:', data);
            allProducts = data; // data is already an array
            populateProductDropdowns();
        })
        .catch(error => console.error('Error loading products:', error));
}

// Load locations for dropdowns
function loadLocations() {
    fetch('/api/inventory/locations')
        .then(response => response.json())
        .then(data => {
            allLocations = data.locations || [];
            populateLocationDropdowns();
        })
        .catch(error => console.error('Error loading locations:', error));
}

// Load all batches
function loadBatches() {
    fetch('/api/inventory/batches')
        .then(response => response.json())
        .then(data => {
            allBatches = data.batches || [];
            renderBatchesTable();
            console.log('Batches loaded:', allBatches.length);
        })
        .catch(error => console.error('Error loading batches:', error));
}

// Populate product dropdowns
function populateProductDropdowns() {
    const dropdowns = ['filterProduct', 'batchProduct', 'addBatchProduct'];

    dropdowns.forEach(dropdownId => {
        const dropdown = document.getElementById(dropdownId);
        if (dropdown) {
            console.log(`Populating dropdown: ${dropdownId}`, allProducts);
            // Keep first option for filter dropdown
            if (dropdownId === 'filterProduct') {
                dropdown.innerHTML = '<option value="">All Products</option>';
            } else {
                dropdown.innerHTML = '<option value="">Select Product</option>';
            }

            allProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name}${product.sku ? ` (${product.sku})` : ''}`;
                dropdown.appendChild(option);
            });
            console.log(`Dropdown ${dropdownId} populated with ${allProducts.length} products`);
        } else {
            console.warn(`Dropdown element not found: ${dropdownId}`);
        }
    });
}

// Populate location dropdowns
function populateLocationDropdowns() {
    const dropdowns = ['filterLocation', 'batchLocation', 'addBatchLocation'];

    dropdowns.forEach(dropdownId => {
        const dropdown = document.getElementById(dropdownId);
        if (dropdown) {
            console.log(`Populating location dropdown: ${dropdownId}`, allLocations);
            // Keep first option for filter dropdown
            if (dropdownId === 'filterLocation') {
                dropdown.innerHTML = '<option value="">All Locations</option>';
            } else {
                dropdown.innerHTML = '<option value="">Select Location</option>';
            }

            allLocations.forEach(location => {
                const option = document.createElement('option');
                option.value = location.id;
                option.textContent = location.name;
                dropdown.appendChild(option);
            });
            console.log(`Location dropdown ${dropdownId} populated with ${allLocations.length} locations`);
        } else {
            console.warn(`Location dropdown element not found: ${dropdownId}`);
        }
    });
}

// Render batches table
function renderBatchesTable() {
    const tbody = document.getElementById('batchesTableBody');
    if (!tbody) return;

    tbody.innerHTML = '';

    const filteredBatches = getFilteredBatches();

    if (filteredBatches.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No batches found</td></tr>';
        return;
    }

    filteredBatches.forEach(batch => {
        const row = document.createElement('tr');

        // Get product and location names
        const product = allProducts.find(p => p.id === batch.product_id);
        const location = allLocations.find(l => l.id === batch.location_id);

        // Status badge class
        const statusClass = getStatusBadgeClass(batch.status, batch.is_expired);

        row.innerHTML = `
            <td><strong>${batch.batch_name}</strong></td>
            <td>${product ? product.name : 'Unknown'}</td>
            <td>${location ? location.name : 'Unknown'}</td>
            <td>${batch.qty_available} ${product ? product.unit_of_measure : 'pcs'}</td>
            <td>${batch.created_date ? formatDate(batch.created_date) : '-'}</td>
            <td>${batch.mfg_date ? formatDate(batch.mfg_date) : '-'}</td>
            <td>${batch.expiry_date ? formatDate(batch.expiry_date) : '-'}</td>
            <td><span class="badge ${statusClass}">${batch.status}</span></td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewBatch(${batch.id})" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-warning" onclick="editBatch(${batch.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteBatch(${batch.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;

        tbody.appendChild(row);
    });
}

// Get status badge class
function getStatusBadgeClass(status, isExpired) {
    if (isExpired) return 'bg-danger';
    switch (status) {
        case 'active': return 'bg-success';
        case 'blocked': return 'bg-warning';
        case 'expired': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

// Get filtered batches
function getFilteredBatches() {
    let filtered = [...allBatches];

    const productFilter = document.getElementById('filterProduct')?.value;
    const locationFilter = document.getElementById('filterLocation')?.value;
    const statusFilter = document.getElementById('filterStatus')?.value;
    const assignmentFilter = document.getElementById('filterAssignment')?.value;
    const searchTerm = document.getElementById('searchBatch')?.value?.toLowerCase();

    // Product and location filters are removed as per requirements

    if (statusFilter) {
        filtered = filtered.filter(batch => batch.status === statusFilter);
    }

    if (assignmentFilter === 'assigned') {
        filtered = filtered.filter(batch => batch.product_id !== null && batch.product_id !== undefined);
    } else if (assignmentFilter === 'unassigned') {
        filtered = filtered.filter(batch => batch.product_id === null || batch.product_id === undefined);
    }

    if (searchTerm) {
        filtered = filtered.filter(batch => 
            batch.batch_name.toLowerCase().includes(searchTerm)
        );
    }

    return filtered;
}

// Filter batches
function filterBatches() {
    renderBatchesTable();
}

// Open add batch modal
function openAddBatchModal() {
    document.getElementById('batchModalTitle').textContent = 'Add Batch';
    document.getElementById('batchForm').reset();
    document.getElementById('batchId').value = '';

    // Set default created date to today
    document.getElementById('batchCreatedDate').value = new Date().toISOString().split('T')[0];

    const modal = new bootstrap.Modal(document.getElementById('batchModal'));
    modal.show();
}

// Edit batch
function editBatch(batchId) {
    const batch = allBatches.find(b => b.id === batchId);
    if (!batch) return;

    document.getElementById('batchModalTitle').textContent = 'Edit Batch';
    document.getElementById('batchId').value = batch.id;
    document.getElementById('batchProduct').value = batch.product_id;
    document.getElementById('batchLocation').value = batch.location_id;
    document.getElementById('batchName').value = batch.batch_name;
    document.getElementById('batchCreatedDate').value = batch.created_date || '';
    document.getElementById('batchMfgDate').value = batch.mfg_date || '';
    document.getElementById('batchExpiryDate').value = batch.expiry_date || '';
    document.getElementById('batchUnitCost').value = batch.unit_cost || 0;
    document.getElementById('batchSellingPrice').value = batch.selling_price || '';

    const modal = new bootstrap.Modal(document.getElementById('batchModal'));
    modal.show();
}

// Save batch
function saveBatch(event) {
    event.preventDefault();

    const batchId = document.getElementById('batchId').value;
    const isEdit = !!batchId;

    // Determine which form we're using based on modal
    const isAddModal = document.getElementById('addBatchModal').style.display !== 'none';
    const productSelect = isAddModal ? 'addBatchProduct' : 'batchProduct';
    const locationSelect = isAddModal ? 'addBatchLocation' : 'batchLocation';

    const batchData = {
        product_id: parseInt(document.getElementById(productSelect).value) || null, // Set to null if not selected
        location_id: document.getElementById(locationSelect).value || null, // Set to null if not selected
        batch_name: document.getElementById('batchName').value.trim(),
        created_date: document.getElementById('batchCreatedDate').value || null,
        mfg_date: document.getElementById('batchMfgDate').value || null,
        expiry_date: document.getElementById('batchExpiryDate').value || null,
        unit_cost: parseFloat(document.getElementById('batchUnitCost').value) || 0,
        selling_price: parseFloat(document.getElementById('batchSellingPrice').value) || null,
        status: 'active'
    };

    // Validation
    if (!batchData.batch_name) {
        alert('Please enter a batch name');
        return;
    }

    if (!batchData.mfg_date) {
        alert('Please enter manufacturing date');
        return;
    }

    if (!batchData.expiry_date) {
        alert('Please enter expiry date');
        return;
    }

    // Validation: Expiry must be later than Mfg Date
    if (batchData.mfg_date && batchData.expiry_date && batchData.expiry_date <= batchData.mfg_date) {
        alert('Expiry date must be later than manufacturing date.');
        return;
    }

    // If product_id and location_id are not selected, set them to null
    if (!batchData.product_id) batchData.product_id = null;
    if (!batchData.location_id) batchData.location_id = null;


    const url = isEdit ? `/api/inventory/batches/${batchId}` : '/api/inventory/batches';
    const method = isEdit ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(batchData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('batchModal')).hide();
            loadBatches(); // Reload data
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving batch:', error);
        alert('Error saving batch');
    });
}

// View batch details
function viewBatch(batchId) {
    const batch = allBatches.find(b => b.id === batchId);
    if (!batch) return;

    const product = allProducts.find(p => p.id === batch.product_id);
    const location = allLocations.find(l => l.id === batch.location_id);

    const content = document.getElementById('batchDetailsContent');
    content.innerHTML = `
        <div class="row g-3">
            <div class="col-md-6">
                <strong>Product:</strong><br>
                ${product ? product.name : 'Not Assigned'} (${product ? product.sku : 'N/A'})
            </div>
            <div class="col-md-6">
                <strong>Batch Name:</strong><br>
                ${batch.batch_name}
            </div>
            <div class="col-md-6">
                <strong>Location:</strong><br>
                ${location ? location.name : 'Not Assigned'}
            </div>
            <div class="col-md-6">
                <strong>Quantity Available:</strong><br>
                ${batch.qty_available} ${product ? product.unit_of_measure : 'pcs'}
            </div>
            <div class="col-md-6">
                <strong>Created Date:</strong><br>
                ${batch.created_date ? formatDate(batch.created_date) : 'Not specified'}
            </div>
            <div class="col-md-6">
                <strong>Manufacturing Date:</strong><br>
                ${batch.mfg_date ? formatDate(batch.mfg_date) : 'Not specified'}
            </div>
            <div class="col-md-6">
                <strong>Expiry Date:</strong><br>
                ${batch.expiry_date ? formatDate(batch.expiry_date) : 'Not specified'}
            </div>
            <div class="col-md-6">
                <strong>Unit Cost:</strong><br>
                $${parseFloat(batch.unit_cost || 0).toFixed(2)}
            </div>
            <div class="col-md-6">
                <strong>Status:</strong><br>
                <span class="badge ${getStatusBadgeClass(batch.status, batch.is_expired)}">${batch.status}</span>
            </div>
            <div class="col-md-6">
                <strong>Days to Expiry:</strong><br>
                ${batch.days_to_expiry !== null ? batch.days_to_expiry + ' days' : 'No expiry set'}
            </div>
        </div>
    `;

    const modal = new bootstrap.Modal(document.getElementById('viewBatchModal'));
    modal.show();
}

// Delete batch
function deleteBatch(batchId) {
    if (!confirm('Are you sure you want to delete this batch?')) return;

    fetch(`/api/inventory/batches/${batchId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            loadBatches(); // Reload data
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error deleting batch:', error);
        alert('Error deleting batch');
    });
}

// Format date for display
function formatDate(dateString) {
    if (!dateString) return '-';
    return new Date(dateString).toLocaleDateString('en-GB');
}

// Save new batch from Add Batch modal
function saveNewBatch() {
    const batchData = {
        product_id: parseInt(document.getElementById('addBatchProduct').value) || null,
        location_id: document.getElementById('addBatchLocation').value || null,
        batch_name: document.getElementById('batchName').value.trim(),
        created_date: document.getElementById('batchCreatedDate').value || null,
        mfg_date: document.getElementById('batchMfgDate').value || null,
        expiry_date: document.getElementById('batchExpiryDate').value || null,
        unit_cost: parseFloat(document.getElementById('batchUnitCost').value) || 0,
        selling_price: parseFloat(document.getElementById('batchSellingPrice').value) || null,
        status: 'active'
    };

    // Validation
    if (!batchData.batch_name) {
        alert('Please enter a batch name');
        return;
    }

    if (!batchData.mfg_date) {
        alert('Please enter manufacturing date');
        return;
    }

    if (!batchData.expiry_date) {
        alert('Please enter expiry date');
        return;
    }

    // Validation: Expiry must be later than Mfg Date
    if (batchData.mfg_date && batchData.expiry_date && batchData.expiry_date <= batchData.mfg_date) {
        alert('Expiry date must be later than manufacturing date.');
        return;
    }

    fetch('/api/inventory/batches', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(batchData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            bootstrap.Modal.getInstance(document.getElementById('addBatchModal')).hide();
            loadBatches(); // Reload data
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error saving batch:', error);
        alert('Error saving batch');
    });
}

// Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🔧 Batch Management DOM loaded');
        initializeBatchManagement();
    });

    // Filter batches function (placeholder)
    function filterBatches() {
        console.log('Filtering batches...');
        // Implementation for filtering will be added
    }
</script>