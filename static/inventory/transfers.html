<div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="fas fa-exchange-alt me-2"></i>Stock Transfers</h3>
        <button id="btnAddTransfer" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>New Transfer
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" id="transferSearch" placeholder="Search transfers...">
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" class="form-control" id="dateFrom" placeholder="From Date">
                </div>
                <div class="col-md-2">
                    <input type="date" class="form-control" id="dateTo" placeholder="To Date">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" onclick="clearTransferFilters()">Clear</button>
                </div>
                <div class="col-md-1">
                    <button class="btn btn-success w-100" onclick="exportTransfers()" title="Export to Excel">
                        <i class="fas fa-file-excel"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfers Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="transferTable">
                    <thead>
                        <tr>
                            <th>Transfer ID</th>
                            <th>Date</th>
                            <th>From Location</th>
                            <th>To Location</th>
                            <th>Items</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transferTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transferModalTitle">New Stock Transfer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="transferForm">
                    <input type="hidden" id="transferId">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">From Location *</label>
                            <select class="form-select" id="fromLocation" required>
                                <option value="">Select Source Location</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">To Location *</label>
                            <select class="form-select" id="toLocation" required>
                                <option value="">Select Destination Location</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Reference/Notes</label>
                        <input type="text" class="form-control" id="transferReference" placeholder="Optional reference or notes">
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Transfer Items</h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addTransferItem()">
                            <i class="fas fa-plus me-1"></i>Add Item
                        </button>
                    </div>

                    <div id="transferItems">
                        <!-- Transfer items will be added here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTransfer()">Create Transfer</button>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Details Modal -->
<div class="modal fade" id="transferDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transfer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transferDetailsBody">
                <!-- Transfer details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <div id="transferActions">
                    <!-- Action buttons will be added here based on transfer status -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Transfer Modal -->
<div class="modal fade" id="editTransferModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Transfer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editTransferForm">
                    <input type="hidden" id="editTransferId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Transfer Date *</label>
                            <input type="date" class="form-control" id="editTransferDate" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Reference</label>
                            <input type="text" class="form-control" id="editTransferReference" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">From Location *</label>
                            <select class="form-select" id="editFromLocation" required>
                                <option value="">Select Source Location</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">To Location *</label>
                            <select class="form-select" id="editToLocation" required>
                                <option value="">Select Destination Location</option>
                            </select>
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Reason/Notes</label>
                            <textarea class="form-control" id="editTransferReason" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <h6>Transfer Items</h6>
                            <div id="editTransferItems">
                                <!-- Items will be loaded here -->
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEditedTransfer()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // Isolated scope for transfers tab
    let editingTransferId = null;
    let transferItemCounter = 0;

    function loadTransfers() {
        const transfers = JSON.parse(localStorage.getItem('inventory.transfers') || '[]');
        const locations = JSON.parse(localStorage.getItem('inventory.locations') || '[]');
        const search = document.getElementById('transferSearch').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;

        let filteredTransfers = transfers.filter(transfer => {
            const matchesSearch = transfer.id.toLowerCase().includes(search) ||
                                transfer.reference?.toLowerCase().includes(search);
            const matchesStatus = !statusFilter || transfer.status === statusFilter;

            let matchesDate = true;
            if (dateFrom || dateTo) {
                const transferDate = new Date(transfer.date).toISOString().split('T')[0];
                if (dateFrom && transferDate < dateFrom) matchesDate = false;
                if (dateTo && transferDate > dateTo) matchesDate = false;
            }

            return matchesSearch && matchesStatus && matchesDate;
        });

        // Sort by date (newest first)
        filteredTransfers.sort((a, b) => new Date(b.date) - new Date(a.date));

        const tbody = document.getElementById('transferTableBody');
        tbody.innerHTML = '';

        if (filteredTransfers.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No transfers found</td></tr>';
            return;
        }

        filteredTransfers.forEach(transfer => {
            const fromLocation = locations.find(l => l.id === transfer.fromLocation)?.name || 'Unknown';
            const toLocation = locations.find(l => l.id === transfer.toLocation)?.name || 'Unknown';
            const statusBadge = getStatusBadge(transfer.status);
            const itemsCount = transfer.items.length;

            tbody.innerHTML += `
                <tr>
                    <td><strong>${transfer.id}</strong></td>
                    <td>${new Date(transfer.date).toLocaleDateString()}</td>
                    <td>${fromLocation}</td>
                    <td>${toLocation}</td>
                    <td>${itemsCount} item${itemsCount !== 1 ? 's' : ''}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-info btn-sm" onclick="viewTransfer('${transfer.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${transfer.status === 'pending' ? `
                                <button class="btn btn-outline-primary btn-sm" onclick="editTransfer('${transfer.id}')" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="completeTransfer('${transfer.id}')" title="Complete">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="cancelTransfer('${transfer.id}')" title="Cancel">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteTransfer('${transfer.id}')" title="Delete" ${transfer.status === 'completed' ? '' : 'style="display:none;"'}>
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    function getStatusBadge(status) {
        const badges = {
            'pending': '<span class="badge bg-warning">Pending</span>',
            'completed': '<span class="badge bg-success">Completed</span>',
            'cancelled': '<span class="badge bg-danger">Cancelled</span>'
        };
        return badges[status] || '<span class="badge bg-secondary">Unknown</span>';
    }

    function loadLocations() {
        const locations = JSON.parse(localStorage.getItem('inventory.locations') || '[]');
        const activeLocations = locations.filter(l => l.status === 'active');

        const fromSelect = document.getElementById('fromLocation');
        const toSelect = document.getElementById('toLocation');

        fromSelect.innerHTML = '<option value="">Select Source Location</option>';
        toSelect.innerHTML = '<option value="">Select Destination Location</option>';

        activeLocations.forEach(location => {
            const option = `<option value="${location.id}">${location.name}</option>`;
            fromSelect.innerHTML += option;
            toSelect.innerHTML += option;
        });
    }

    // Add event listener for add transfer button
    document.getElementById('btnAddTransfer').addEventListener('click', function() {
        editingTransferId = null;
        transferItemCounter = 0;
        document.getElementById('transferModalTitle').textContent = 'New Stock Transfer';
        document.getElementById('transferForm').reset();
        document.getElementById('transferItems').innerHTML = '';

        loadLocations();
        addTransferItem(); // Add one item by default

        const modal = new bootstrap.Modal(document.getElementById('transferModal'));
        modal.show();
    });

    window.addTransferItem = function() {
        const batches = JSON.parse(localStorage.getItem('inventory.batches') || '[]');
        const fromLocationId = document.getElementById('fromLocation').value;

        transferItemCounter++;
        const itemHtml = `
            <div class="card mb-2" id="transferItem${transferItemCounter}">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Source Batch *</label>
                            <select class="form-select batch-select" name="source_batch_id" data-item="${transferItemCounter}" required>
                                <option value="">Select Source Batch</option>
                                ${batches.map(b => {
                                    const product = JSON.parse(localStorage.getItem('inventory.products') || '[]').find(p => p.id === b.productId) || {};
                                    const expiryDate = b.expiryDate ? new Date(b.expiryDate).toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';
                                    const qtyAvailable = b.locationStock?.[fromLocationId] || 0;
                                    return `<option value="${b.id}" data-product-name="${product.name || 'Unknown'}" data-expiry="${expiryDate}" data-stock="${qtyAvailable}">${b.batchName} (${product.name || 'Unknown'}, Exp: ${expiryDate}, Qty: ${qtyAvailable})</option>`;
                                }).join('')}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control transfer-qty" id="transferQty${transferItemCounter}" min="1" required>
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-danger w-100" onclick="removeTransferItem(${transferItemCounter})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('transferItems').insertAdjacentHTML('beforeend', itemHtml);

        // Add event listener for batch selection
        document.querySelector(`[data-item="${transferItemCounter}"]`).addEventListener('change', function() {
            updateStockInfo(transferItemCounter, this.value);
        });
    }

    function updateStockInfo(itemCounter, batchId) {
        const fromLocationId = document.getElementById('fromLocation').value;
        const batches = JSON.parse(localStorage.getItem('inventory.batches') || '[]');
        const batch = batches.find(b => b.id === batchId);

        if (batch && fromLocationId) {
            const stock = batch.locationStock?.[fromLocationId] || 0;
            document.getElementById(`transferQty${itemCounter}`).max = stock;
            // Displaying batch info in a more readable way, could be a dedicated field or tooltip
            const selectElement = document.querySelector(`[data-item="${itemCounter}"]`);
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const productName = selectedOption.getAttribute('data-product-name');
            const expiryDate = selectedOption.getAttribute('data-expiry');
            // Optional: Update a specific display field if you add one, e.g., document.getElementById(`batchInfo${itemCounter}`).textContent = `${productName}, Exp: ${expiryDate}`;
        } else {
            document.getElementById(`transferQty${itemCounter}`).max = '';
        }
    }

    window.removeTransferItem = function(itemCounter) {
        document.getElementById(`transferItem${itemCounter}`).remove();
    }

    // Update stock info when from location changes
    document.getElementById('fromLocation').addEventListener('change', function() {
        document.querySelectorAll('.batch-select').forEach((select, index) => {
            if (select.value) {
                updateStockInfo(select.dataset.item, select.value);
            }
        });
    });

    window.saveTransfer = function() {
        const transferData = {
            id: 'TXN-' + Date.now(),
            date: new Date().toISOString(),
            fromLocation: document.getElementById('fromLocation').value,
            toLocation: document.getElementById('toLocation').value,
            reference: document.getElementById('transferReference').value,
            status: 'pending',
            items: [],
            createdAt: new Date().toISOString()
        };

        // Validation
        if (!transferData.fromLocation || !transferData.toLocation) {
            alert('Please select both source and destination locations.');
            return;
        }

        if (transferData.fromLocation === transferData.toLocation) {
            alert('Source and destination locations cannot be the same.');
            return;
        }

        // Collect transfer items
        const transferItems = document.querySelectorAll('.batch-select');
        for (let i = 0; i < transferItems.length; i++) {
            const select = transferItems[i];
            const itemCounter = select.dataset.item;
            const batchId = select.value;
            const qty = parseInt(document.getElementById(`transferQty${itemCounter}`).value);

            if (batchId && qty > 0) {
                transferData.items.push({
                    batchId: batchId,
                    quantity: qty
                });
            }
        }

        if (transferData.items.length === 0) {
            alert('Please add at least one item to transfer.');
            return;
        }

        // Validate stock availability
        const batches = JSON.parse(localStorage.getItem('inventory.batches') || '[]');
        for (const item of transferData.items) {
            const batch = batches.find(b => b.id === item.batchId);
            const availableStock = batch?.locationStock?.[transferData.fromLocation] || 0;

            if (item.quantity > availableStock) {
                const batchName = batch?.batchName || 'Unknown Batch';
                alert(`Insufficient stock for batch ${batchName}. Available: ${availableStock}, Requested: ${item.quantity}`);
                return;
            }
        }

        // Save transfer
        const transfers = JSON.parse(localStorage.getItem('inventory.transfers') || '[]');
        transfers.push(transferData);
        localStorage.setItem('inventory.transfers', JSON.stringify(transfers));

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('transferModal'));
        modal.hide();

        loadTransfers();
        showToast('Transfer created successfully!', 'success');
    }

    // Edit transfer function
    window.editTransfer = function(transferId) {
        console.log('Editing transfer:', transferId);

        const transfers = JSON.parse(localStorage.getItem('inventory.transfers') || '[]');
        const transfer = transfers.find(t => t.id === transferId);

        if (!transfer) {
            alert('Transfer not found');
            return;
        }

        if (transfer.status !== 'pending') {
            alert('Only pending transfers can be edited');
            return;
        }

        // Load locations for dropdowns
        loadLocationsForEdit();

        // Populate edit modal with data
        document.getElementById('editTransferId').value = transferId;
        document.getElementById('editTransferDate').value = transfer.date ? transfer.date.split('T')[0] : '';
        document.getElementById('editTransferReference').value = transfer.id || '';
        document.getElementById('editTransferReason').value = transfer.reason || '';

        // Set location selections
        setTimeout(() => {
            document.getElementById('editFromLocation').value = transfer.fromLocation || '';
            document.getElementById('editToLocation').value = transfer.toLocation || '';
        }, 100);

        // Load transfer items
        loadTransferItemsForEdit(transfer.items || []);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editTransferModal'));
        modal.show();
    }

    // Delete transfer function
    window.deleteTransfer = function(transferId) {
        if (!confirm('Are you sure you want to delete this transfer? This action cannot be undone.')) {
            return;
        }

        const transfers = JSON.parse(localStorage.getItem('inventory.transfers') || '[]');
        const filteredTransfers = transfers.filter(t => t.id !== transferId);
        localStorage.setItem('inventory.transfers', JSON.stringify(filteredTransfers));

        loadTransfers();
        showToast('Transfer deleted successfully!', 'success');
    }

    // Save edited transfer function
    window.saveEditedTransfer = function() {
        const transferId = document.getElementById('editTransferId').value;
        const formData = {
            date: document.getElementById('editTransferDate').value,
            fromLocation: document.getElementById('editFromLocation').value,
            toLocation: document.getElementById('editToLocation').value,
            reason: document.getElementById('editTransferReason').value
        };

        // Validate required fields
        if (!formData.date) {
            alert('Please select a transfer date.');
            return;
        }

        if (!formData.fromLocation) {
            alert('Please select a source location.');
            return;
        }

        if (!formData.toLocation) {
            alert('Please select a destination location.');
            return;
        }

        if (formData.fromLocation === formData.toLocation) {
            alert('Source and destination locations cannot be the same.');
            return;
        }

        // Update transfer in localStorage
        const transfers = JSON.parse(localStorage.getItem('inventory.transfers') || '[]');
        const transferIndex = transfers.findIndex(t => t.id === transferId);

        if (transferIndex !== -1) {
            transfers[transferIndex] = {
                ...transfers[transferIndex],
                ...formData,
                updatedDate: new Date().toISOString()
            };

            localStorage.setItem('inventory.transfers', JSON.stringify(transfers));

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTransferModal'));
            modal.hide();

            // Reload transfers
            loadTransfers();
            showToast('Transfer updated successfully!', 'success');
        } else {
            alert('Error: Transfer not found');
        }
    }

    function loadLocationsForEdit() {
        const locations = JSON.parse(localStorage.getItem('inventory.locations') || '[]');
        const activeLocations = locations.filter(l => l.status === 'active');

        const fromSelect = document.getElementById('editFromLocation');
        const toSelect = document.getElementById('editToLocation');

        fromSelect.innerHTML = '<option value="">Select Source Location</option>';
        toSelect.innerHTML = '<option value="">Select Destination Location</option>';

        activeLocations.forEach(location => {
            fromSelect.innerHTML += `<option value="${location.id}">${location.name}</option>`;
            toSelect.innerHTML += `<option value="${location.id}">${location.name}</option>`;
        });
    }

    function loadTransferItemsForEdit(items) {
        const container = document.getElementById('editTransferItems');
        const batches = JSON.parse(localStorage.getItem('inventory.batches') || '[]');
        const products = JSON.parse(localStorage.getItem('inventory.products') || '[]');

        container.innerHTML = '';

        items.forEach(item => {
            const batch = batches.find(b => b.id === item.batchId);
            const product = products.find(p => p.id === batch?.productId);
            const productName = product ? product.name : 'Unknown Product';

            container.innerHTML += `
                <div class="card mb-2">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Batch: ${batch?.batchName || 'Unknown Batch'}</strong> (${productName})<br>
                                <small class="text-muted">Quantity: ${item.quantity} ${product?.unit || 'pcs'}</small>
                            </div>
                            <div>
                                <span class="badge bg-info">Transfer Item</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        if (items.length === 0) {
            container.innerHTML = '<p class="text-muted">No items in this transfer</p>';
        }
    }

    window.viewTransfer = function(transferId) {
        const transfers = JSON.parse(localStorage.getItem('inventory.transfers') || '[]');
        const transfer = transfers.find(t => t.id === transferId);
        const locations = JSON.parse(localStorage.getItem('inventory.locations') || '[]');
        const batches = JSON.parse(localStorage.getItem('inventory.batches') || '[]');
        const products = JSON.parse(localStorage.getItem('inventory.products') || '[]');

        if (!transfer) return;

        const fromLocation = locations.find(l => l.id === transfer.fromLocation)?.name || 'Unknown';
        const toLocation = locations.find(l => l.id === transfer.toLocation)?.name || 'Unknown';

        let itemsHtml = transfer.items.map(item => {
            const batch = batches.find(b => b.id === item.batchId);
            const product = products.find(p => p.id === batch?.productId);
            return `
                <tr>
                    <td>${batch?.batchName || 'Unknown Batch'}</td>
                    <td>${product?.name || 'Unknown Product'}</td>
                    <td>${item.quantity}</td>
                </tr>
            `;
        }).join('');

        const detailsHtml = `
            <div class="row mb-3">
                <div class="col-md-6"><strong>Transfer ID:</strong> ${transfer.id}</div>
                <div class="col-md-6"><strong>Status:</strong> ${getStatusBadge(transfer.status)}</div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6"><strong>From Location:</strong> ${fromLocation}</div>
                <div class="col-md-6"><strong>To Location:</strong> ${toLocation}</div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6"><strong>Date:</strong> ${new Date(transfer.date).toLocaleString()}</div>
                <div class="col-md-6"><strong>Reference:</strong> ${transfer.reference || '-'}</div>
            </div>

            <h6>Items to Transfer:</h6>
            <table class="table table-sm">
                <thead>
                    <tr><th>Batch Name</th><th>Product Name</th><th>Quantity</th></tr>
                </thead>
                <tbody>${itemsHtml}</tbody>
            </table>
        `;

        document.getElementById('transferDetailsBody').innerHTML = detailsHtml;

        // Add action buttons
        const actionsHtml = transfer.status === 'pending' ? `
            <button class="btn btn-success me-2" onclick="completeTransfer('${transfer.id}')">Complete Transfer</button>
            <button class="btn btn-danger" onclick="cancelTransfer('${transfer.id}')">Cancel Transfer</button>
        ` : '';

        document.getElementById('transferActions').innerHTML = actionsHtml;

        const modal = new bootstrap.Modal(document.getElementById('transferDetailsModal'));
        modal.show();
    }

    window.completeTransfer = function(transferId) {
        if (!confirm('Are you sure you want to complete this transfer? This action cannot be undone.')) {
            return;
        }

        const transfers = JSON.parse(localStorage.getItem('inventory.transfers') || '[]');
        const transfer = transfers.find(t => t.id === transferId);
        const batches = JSON.parse(localStorage.getItem('inventory.batches') || '[]');

        if (!transfer || transfer.status !== 'pending') {
            alert('Transfer not found or already processed.');
            return;
        }

        // Update stock levels
        transfer.items.forEach(item => {
            const batchIndex = batches.findIndex(b => b.id === item.batchId);
            if (batchIndex !== -1) {
                const batch = batches[batchIndex];

                // Initialize locationStock if not exists
                if (!batch.locationStock) {
                    batch.locationStock = {};
                }

                // Deduct from source location
                batch.locationStock[transfer.fromLocation] = (batch.locationStock[transfer.fromLocation] || 0) - item.quantity;

                // Add to destination location
                batch.locationStock[transfer.toLocation] = (batch.locationStock[transfer.toLocation] || 0) + item.quantity;

                // Update total stock for the batch (optional, as it's location-specific)
                // batch.currentStock = Object.values(batch.locationStock).reduce((sum, stock) => sum + stock, 0);
            }
        });

        // Update transfer status
        transfer.status = 'completed';
        transfer.completedAt = new Date().toISOString();

        localStorage.setItem('inventory.transfers', JSON.stringify(transfers));
        localStorage.setItem('inventory.batches', JSON.stringify(batches)); // Save updated batches

        // Close details modal if open
        const detailsModal = bootstrap.Modal.getInstance(document.getElementById('transferDetailsModal'));
        if (detailsModal) detailsModal.hide();

        loadTransfers();
        showToast('Transfer completed successfully!', 'success');
    }

    window.cancelTransfer = function(transferId) {
        if (!confirm('Are you sure you want to cancel this transfer?')) {
            return;
        }

        const transfers = JSON.parse(localStorage.getItem('inventory.transfers') || '[]');
        const transferIndex = transfers.findIndex(t => t.id === transferId);

        if (transferIndex !== -1) {
            transfers[transferIndex].status = 'cancelled';
            transfers[transferIndex].cancelledAt = new Date().toISOString();
            localStorage.setItem('inventory.transfers', JSON.stringify(transfers));

            // Close details modal if open
            const detailsModal = bootstrap.Modal.getInstance(document.getElementById('transferDetailsModal'));
            if (detailsModal) detailsModal.hide();

            loadTransfers();
            showToast('Transfer cancelled successfully!', 'success');
        }
    }

    window.clearTransferFilters = function() {
        document.getElementById('transferSearch').value = '';
        document.getElementById('statusFilter').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        loadTransfers();
    }

    window.exportTransfers = function() {
        // This would implement Excel export - placeholder for now
        alert('Excel export functionality will be implemented.');
    }

    function showToast(message, type = 'success') {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }

        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';

        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();

        // Remove toast element after it's hidden
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }

    // Add event listeners
    document.getElementById('transferSearch').addEventListener('input', loadTransfers);
    document.getElementById('statusFilter').addEventListener('change', loadTransfers);
    document.getElementById('dateFrom').addEventListener('change', loadTransfers);
    document.getElementById('dateTo').addEventListener('change', loadTransfers);

    // Initialize
    loadTransfers();
})();
</script>
<div>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-exchange-alt me-2"></i>Stock Transfers</h3>
        <button class="btn btn-primary" id="btnNewTransfer">
            <i class="fas fa-plus"></i> New Transfer
        </button>
    </div>

    <!-- Transfers Filter Bar -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">From Date</label>
                    <input type="date" class="form-control" id="transfers-from-date">
                </div>
                <div class="col-md-2">
                    <label class="form-label">To Date</label>
                    <input type="date" class="form-control" id="transfers-to-date">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-control" id="transfers-status">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in_transit">In Transit</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Search</label>
                    <input type="text" class="form-control" id="transfers-search" placeholder="Search transfer ID, notes">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary btn-sm" id="resetTransfersFilters">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="btn btn-success btn-sm" id="exportTransfers">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transfers Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="transfersTable">
                    <thead>
                        <tr>
                            <th>Transfer ID</th>
                            <th>Date</th>
                            <th>From Location</th>
                            <th>To Location</th>
                            <th>Items</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transfersTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div id="transfersTableInfo" class="entries-info"></div>
        <nav>
            <ul class="pagination" id="transfersPagination"></ul>
        </nav>
    </div>
</div>

<!-- New Transfer Modal -->
<div class="modal fade" id="newTransferModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Stock Transfer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="transferForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Transfer ID</label>
                            <input type="text" class="form-control" id="transferId" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Transfer Date *</label>
                            <input type="date" class="form-control" id="transferDate" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">From Location *</label>
                            <select class="form-select" id="fromLocation" required>
                                <option value="">Select Location</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">To Location *</label>
                            <select class="form-select" id="toLocation" required>
                                <option value="">Select Location</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="transferNotes" rows="2"></textarea>
                    </div>

                    <hr>
                    <h6>Transfer Items</h6>
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-success" onclick="addTransferItem()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm" id="transferItemsTable">
                            <thead>
                                <tr>
                                    <th>Batch</th>
                                    <th>Product</th>
                                    <th>Available Qty</th>
                                    <th>Transfer Qty *</th>
                                    <th>Unit</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="transferItemsBody">
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveTransfer()">Create Transfer</button>
            </div>
        </div>
    </div>
</div>

<!-- View Transfer Modal -->
<div class="modal fade" id="viewTransferModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Transfer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><strong>Transfer ID</strong></label>
                        <p id="viewTransferId" class="form-control-plaintext border rounded p-2 bg-light"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>Date</strong></label>
                        <p id="viewTransferDate" class="form-control-plaintext border rounded p-2 bg-light"></p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label"><strong>From Location</strong></label>
                        <p id="viewFromLocation" class="form-control-plaintext border rounded p-2 bg-light"></p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label"><strong>To Location</strong></label>
                        <p id="viewToLocation" class="form-control-plaintext border rounded p-2 bg-light"></p>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Status</strong></label>
                    <p id="viewTransferStatus" class="form-control-plaintext border rounded p-2 bg-light"></p>
                </div>
                <div class="mb-3">
                    <label class="form-label"><strong>Notes</strong></label>
                    <p id="viewTransferNotes" class="form-control-plaintext border rounded p-2 bg-light"></p>
                </div>
                <hr>
                <h6>Transfer Items</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Batch</th>
                                <th>Product</th>
                                <th>Quantity</th>
                            </tr>
                        </thead>
                        <tbody id="viewTransferItems">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    let currentPage = 1;
    let pageSize = 25;
    let transferItemCounter = 0;
    let availableBatches = [];

    function escapeHtml(text) {
        if (text === null || text === undefined) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    function loadTransfers() {
        const fromDate = document.getElementById('transfers-from-date')?.value || '';
        const toDate = document.getElementById('transfers-to-date')?.value || '';
        const status = document.getElementById('transfers-status')?.value || '';
        const search = document.getElementById('transfers-search')?.value || '';

        const params = new URLSearchParams();
        if (fromDate) params.append('from_date', fromDate);
        if (toDate) params.append('to_date', toDate);
        if (status) params.append('status', status);
        if (search) params.append('search', search);
        params.append('page', currentPage);
        params.append('page_size', pageSize);

        fetch(`/api/inventory/transfers?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayTransfers(data.transfers || []);
                    updatePagination(data.total_pages || 1, data.current_page || 1);
                    updateEntryCount(data.total || 0);
                } else {
                    console.error('Error loading transfers:', data.error);
                    displayTransfers([]);
                }
            })
            .catch(error => {
                console.error('Error loading transfers:', error);
                displayTransfers([]);
            });
    }

    function displayTransfers(transfers) {
        const tbody = document.getElementById('transfersTableBody');
        if (!tbody) return;

        tbody.innerHTML = '';

        if (!transfers || transfers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <i class="bi bi-inbox" style="font-size: 2rem; color: #6c757d;"></i>
                        <p class="mt-2 text-muted">No transfers found</p>
                    </td>
                </tr>
            `;
            return;
        }

        transfers.forEach(transfer => {
            const statusClass = {
                'pending': 'warning',
                'in_transit': 'info',
                'completed': 'success',
                'cancelled': 'danger'
            }[transfer.status] || 'secondary';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${escapeHtml(transfer.transfer_id)}</strong></td>
                <td>${escapeHtml(transfer.transfer_date)}</td>
                <td>${escapeHtml(transfer.from_location_name)}</td>
                <td>${escapeHtml(transfer.to_location_name)}</td>
                <td>${transfer.item_count} item(s)</td>
                <td><span class="badge bg-${statusClass}">${escapeHtml(transfer.status).toUpperCase()}</span></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-info" onclick="viewTransfer(${transfer.id})" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${transfer.status === 'pending' ? `
                        <button class="btn btn-outline-success" onclick="completeTransfer(${transfer.id})" title="Complete">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="cancelTransfer(${transfer.id})" title="Cancel">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function updatePagination(totalPages, currentPageNum) {
        const pagination = document.getElementById('transfersPagination');
        if (!pagination) return;

        pagination.innerHTML = '';

        if (totalPages <= 1) return;

        // Previous button
        pagination.innerHTML += `
            <li class="page-item ${currentPageNum === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changeTransferPage(${currentPageNum - 1})">Previous</a>
            </li>
        `;

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPageNum - 2 && i <= currentPageNum + 2)) {
                pagination.innerHTML += `
                    <li class="page-item ${i === currentPageNum ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changeTransferPage(${i})">${i}</a>
                    </li>
                `;
            } else if (i === currentPageNum - 3 || i === currentPageNum + 3) {
                pagination.innerHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        // Next button
        pagination.innerHTML += `
            <li class="page-item ${currentPageNum === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changeTransferPage(${currentPageNum + 1})">Next</a>
            </li>
        `;
    }

    function updateEntryCount(total) {
        const countElement = document.getElementById('transfersTableInfo');
        if (countElement) {
            const start = (currentPage - 1) * pageSize + 1;
            const end = Math.min(currentPage * pageSize, total);
            countElement.textContent = total === 0 ? 'Showing 0 to 0 of 0 entries' : `Showing ${start} to ${end} of ${total} entries`;
        }
    }

    window.changeTransferPage = function(page) {
        currentPage = page;
        loadTransfers();
    }

    function generateTransferId() {
        const today = new Date();
        const dateStr = today.getFullYear().toString() +
                       (today.getMonth() + 1).toString().padStart(2, '0') +
                       today.getDate().toString().padStart(2, '0');
        const timeStr = today.getHours().toString().padStart(2, '0') +
                       today.getMinutes().toString().padStart(2, '0');
        return `TRF-${dateStr}-${timeStr}`;
    }

    function loadLocations() {
        fetch('/api/inventory/locations')
            .then(response => response.json())
            .then(data => {
                const fromSelect = document.getElementById('fromLocation');
                const toSelect = document.getElementById('toLocation');
                
                fromSelect.innerHTML = '<option value="">Select Location</option>';
                toSelect.innerHTML = '<option value="">Select Location</option>';

                if (data.locations) {
                    data.locations.forEach(loc => {
                        fromSelect.innerHTML += `<option value="${loc.id}">${escapeHtml(loc.name)}</option>`;
                        toSelect.innerHTML += `<option value="${loc.id}">${escapeHtml(loc.name)}</option>`;
                    });
                }
            });
    }

    function loadBatchesForTransfer(fromLocationId) {
        if (!fromLocationId) {
            availableBatches = [];
            return;
        }

        fetch(`/api/inventory/batches?location_id=${fromLocationId}`)
            .then(response => response.json())
            .then(data => {
                if (data.batches) {
                    availableBatches = data.batches.filter(b => b.qty_available > 0);
                }
            });
    }

    window.addTransferItem = function() {
        const tbody = document.getElementById('transferItemsBody');
        const row = document.createElement('tr');
        row.id = `transfer-item-${transferItemCounter}`;
        
        row.innerHTML = `
            <td>
                <select class="form-select form-select-sm" id="batch-${transferItemCounter}" onchange="updateTransferItemInfo(${transferItemCounter})" required>
                    <option value="">Select Batch</option>
                    ${availableBatches.map(b => `
                        <option value="${b.id}" data-product="${escapeHtml(b.product_name)}" data-available="${b.qty_available}" data-unit="${escapeHtml(b.unit || 'pcs')}">
                            ${escapeHtml(b.batch_name)} - ${escapeHtml(b.product_name)} (${b.qty_available})
                        </option>
                    `).join('')}
                </select>
            </td>
            <td id="product-${transferItemCounter}">-</td>
            <td id="available-${transferItemCounter}">-</td>
            <td>
                <input type="number" class="form-control form-control-sm" id="quantity-${transferItemCounter}" min="0.01" step="0.01" required>
            </td>
            <td id="unit-${transferItemCounter}">pcs</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeTransferItem(${transferItemCounter})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        transferItemCounter++;
    }

    window.updateTransferItemInfo = function(index) {
        const select = document.getElementById(`batch-${index}`);
        const option = select.options[select.selectedIndex];
        
        if (option.value) {
            document.getElementById(`product-${index}`).textContent = option.dataset.product;
            document.getElementById(`available-${index}`).textContent = option.dataset.available;
            document.getElementById(`unit-${index}`).textContent = option.dataset.unit;
            document.getElementById(`quantity-${index}`).max = option.dataset.available;
        } else {
            document.getElementById(`product-${index}`).textContent = '-';
            document.getElementById(`available-${index}`).textContent = '-';
            document.getElementById(`unit-${index}`).textContent = 'pcs';
        }
    }

    window.removeTransferItem = function(index) {
        const row = document.getElementById(`transfer-item-${index}`);
        if (row) row.remove();
    }

    window.saveTransfer = function() {
        const fromLocation = document.getElementById('fromLocation').value;
        const toLocation = document.getElementById('toLocation').value;

        if (!fromLocation || !toLocation) {
            alert('Please select both From and To locations');
            return;
        }

        if (fromLocation === toLocation) {
            alert('From and To locations must be different');
            return;
        }

        const items = [];
        const tbody = document.getElementById('transferItemsBody');
        const rows = tbody.querySelectorAll('tr');

        if (rows.length === 0) {
            alert('Please add at least one item to transfer');
            return;
        }

        for (let row of rows) {
            const id = row.id.split('-')[2];
            const batchId = document.getElementById(`batch-${id}`).value;
            const quantity = parseFloat(document.getElementById(`quantity-${id}`).value);

            if (!batchId || !quantity || quantity <= 0) {
                alert('Please fill all item details correctly');
                return;
            }

            items.push({ batch_id: parseInt(batchId), quantity });
        }

        const transferData = {
            transfer_date: document.getElementById('transferDate').value,
            from_location_id: fromLocation,
            to_location_id: toLocation,
            notes: document.getElementById('transferNotes').value,
            items: items
        };

        fetch('/api/inventory/transfers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(transferData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Transfer created successfully!');
                const modal = bootstrap.Modal.getInstance(document.getElementById('newTransferModal'));
                modal.hide();
                loadTransfers();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error saving transfer:', error);
            alert('Error saving transfer');
        });
    }

    window.viewTransfer = function(transferId) {
        fetch(`/api/inventory/transfers/${transferId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const transfer = data.transfer;
                    document.getElementById('viewTransferId').textContent = transfer.transfer_id;
                    document.getElementById('viewTransferDate').textContent = transfer.transfer_date;
                    document.getElementById('viewFromLocation').textContent = transfer.from_location_name;
                    document.getElementById('viewToLocation').textContent = transfer.to_location_name;
                    document.getElementById('viewTransferStatus').textContent = transfer.status.toUpperCase();
                    document.getElementById('viewTransferNotes').textContent = transfer.notes || '-';

                    const itemsBody = document.getElementById('viewTransferItems');
                    itemsBody.innerHTML = transfer.items.map(item => `
                        <tr>
                            <td>${escapeHtml(item.batch_name)}</td>
                            <td>${escapeHtml(item.product_name)}</td>
                            <td>${item.quantity} ${escapeHtml(item.unit || 'pcs')}</td>
                        </tr>
                    `).join('');

                    const modal = new bootstrap.Modal(document.getElementById('viewTransferModal'));
                    modal.show();
                }
            });
    }

    window.completeTransfer = function(transferId) {
        if (!confirm('Mark this transfer as completed?')) return;

        fetch(`/api/inventory/transfers/${transferId}/complete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Transfer completed successfully!');
                loadTransfers();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        });
    }

    window.cancelTransfer = function(transferId) {
        if (!confirm('Cancel this transfer?')) return;

        fetch(`/api/inventory/transfers/${transferId}/cancel`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Transfer cancelled successfully!');
                loadTransfers();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        });
    }

    // Event listeners
    document.getElementById('btnNewTransfer').addEventListener('click', function() {
        document.getElementById('transferForm').reset();
        document.getElementById('transferId').value = generateTransferId();
        document.getElementById('transferDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('transferItemsBody').innerHTML = '';
        transferItemCounter = 0;
        loadLocations();
        
        const modal = new bootstrap.Modal(document.getElementById('newTransferModal'));
        modal.show();
    });

    document.getElementById('fromLocation').addEventListener('change', function() {
        loadBatchesForTransfer(this.value);
    });

    document.getElementById('resetTransfersFilters').addEventListener('click', function() {
        document.getElementById('transfers-from-date').value = '';
        document.getElementById('transfers-to-date').value = '';
        document.getElementById('transfers-status').value = '';
        document.getElementById('transfers-search').value = '';
        currentPage = 1;
        loadTransfers();
    });

    document.getElementById('transfers-from-date').addEventListener('change', () => { currentPage = 1; loadTransfers(); });
    document.getElementById('transfers-to-date').addEventListener('change', () => { currentPage = 1; loadTransfers(); });
    document.getElementById('transfers-status').addEventListener('change', () => { currentPage = 1; loadTransfers(); });
    document.getElementById('transfers-search').addEventListener('input', () => { currentPage = 1; loadTransfers(); });

    // Initialize
    loadTransfers();
})();
</script>
