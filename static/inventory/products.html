
<div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="fas fa-box me-2"></i>Product Master</h3>
        <button id="btnAddProduct" class="btn btn-primary" onclick="addProduct()">
            <i class="fas fa-plus me-1"></i>Add Product
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="productSearch" placeholder="Search products...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="categoryFilter">
                        <option value="">All Categories</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="in_stock">In Stock</option>
                        <option value="low_stock">Low Stock</option>
                        <option value="out_of_stock">Out of Stock</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" onclick="clearFilters()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="productTable">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Current Stock</th>
                            <th>Status</th>
                            <th>Location</th>
                            <th>Cost Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading products...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">SKU *</label>
                            <input type="text" class="form-control" id="productSku" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="productCategory">
                                <option value="">Select category</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Unit</label>
                            <select class="form-select" id="productUnit">
                                <option value="pcs">Pieces</option>
                                <option value="kg">Kilograms</option>
                                <option value="g">Grams</option>
                                <option value="l">Liters</option>
                                <option value="ml">Milliliters</option>
                                <option value="box">Boxes</option>
                                <option value="bottle">Bottles</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Current Stock</label>
                            <input type="number" class="form-control" id="productStock" value="0" step="0.01" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Min Stock Level</label>
                            <input type="number" class="form-control" id="productMinStock" value="10" step="0.01" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Reorder Level</label>
                            <input type="number" class="form-control" id="productReorderLevel" value="20" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cost Price</label>
                            <input type="number" class="form-control" id="productCostPrice" value="0" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Selling Price</label>
                            <input type="number" class="form-control" id="productSellingPrice" value="0" step="0.01" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" id="productLocation" placeholder="e.g., Room A, Shelf 1">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Barcode</label>
                            <input type="text" class="form-control" id="productBarcode">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    'use strict';
    
    let products = [];
    let categories = [];
    let editingProductId = null;

    // Load products from API
    function loadProducts() {
        fetch('/api/inventory/products/master')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                products = data;
                renderProducts();
            })
            .catch(error => {
                console.error('Error loading products:', error);
                document.getElementById('productTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading products: ${error.message}
                            <br><button class="btn btn-sm btn-outline-primary mt-2" onclick="loadProducts()">Retry</button>
                        </td>
                    </tr>
                `;
            });
    }

    // Load categories
    function loadCategories() {
        fetch('/api/inventory/categories')
            .then(response => response.json())
            .then(data => {
                categories = data.categories || [];
                updateCategoryDropdowns();
            })
            .catch(error => {
                console.error('Error loading categories:', error);
            });
    }

    function updateCategoryDropdowns() {
        const categoryFilter = document.getElementById('categoryFilter');
        const productCategory = document.getElementById('productCategory');
        
        // Update filter dropdown
        categoryFilter.innerHTML = '<option value="">All Categories</option>';
        productCategory.innerHTML = '<option value="">Select category</option>';
        
        categories.forEach(category => {
            const option1 = `<option value="${category.id}">${category.name}</option>`;
            const option2 = `<option value="${category.id}">${category.name}</option>`;
            categoryFilter.innerHTML += option1;
            productCategory.innerHTML += option2;
        });
    }

    function renderProducts() {
        const tbody = document.getElementById('productTableBody');
        const searchTerm = document.getElementById('productSearch').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;
        
        // Apply filters
        let filteredProducts = products.filter(product => {
            const matchesSearch = !searchTerm || 
                product.name.toLowerCase().includes(searchTerm) || 
                product.sku.toLowerCase().includes(searchTerm);
                
            const matchesCategory = !categoryFilter || product.category_id == categoryFilter;
            
            let matchesStatus = true;
            if (statusFilter) {
                const stock = product.current_stock || 0;
                const reorderLevel = product.reorder_level || 10;
                if (statusFilter === 'out_of_stock') matchesStatus = stock <= 0;
                else if (statusFilter === 'low_stock') matchesStatus = stock > 0 && stock <= reorderLevel;
                else if (statusFilter === 'in_stock') matchesStatus = stock > reorderLevel;
            }
            
            return matchesSearch && matchesCategory && matchesStatus;
        });
        
        if (filteredProducts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No products found</td></tr>';
            return;
        }
        
        tbody.innerHTML = '';
        filteredProducts.forEach(product => {
            const category = categories.find(c => c.id == product.category_id);
            const stock = product.current_stock || 0;
            const reorderLevel = product.reorder_level || 10;
            
            let statusBadge = 'success';
            let statusText = 'In Stock';
            
            if (stock <= 0) {
                statusBadge = 'danger';
                statusText = 'Out of Stock';
            } else if (stock <= reorderLevel) {
                statusBadge = 'warning';
                statusText = 'Low Stock';
            }
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${product.sku || 'N/A'}</strong></td>
                <td>${product.name}</td>
                <td>
                    ${category ? 
                        `<span class="badge" style="background-color: ${category.color_code || '#007bff'}">${category.name}</span>` : 
                        '<span class="text-muted">-</span>'
                    }
                </td>
                <td><strong>${stock}</strong> ${product.unit_of_measure || 'pcs'}</td>
                <td><span class="badge bg-${statusBadge}">${statusText}</span></td>
                <td>${product.location || '-'}</td>
                <td>$${(product.cost_price || 0).toFixed(2)}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${product.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    window.addProduct = function() {
        editingProductId = null;
        document.getElementById('productModalTitle').textContent = 'Add Product';
        document.getElementById('productForm').reset();
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
    };

    window.editProduct = function(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        editingProductId = productId;
        document.getElementById('productModalTitle').textContent = 'Edit Product';
        document.getElementById('productId').value = product.id;
        document.getElementById('productSku').value = product.sku || '';
        document.getElementById('productName').value = product.name || '';
        document.getElementById('productCategory').value = product.category_id || '';
        document.getElementById('productUnit').value = product.unit_of_measure || 'pcs';
        document.getElementById('productStock').value = product.current_stock || 0;
        document.getElementById('productMinStock').value = product.min_stock_level || 10;
        document.getElementById('productReorderLevel').value = product.reorder_level || 20;
        document.getElementById('productCostPrice').value = product.cost_price || 0;
        document.getElementById('productSellingPrice').value = product.selling_price || 0;
        document.getElementById('productLocation').value = product.location || '';
        document.getElementById('productBarcode').value = product.barcode || '';
        document.getElementById('productDescription').value = product.description || '';
        
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
    };

    window.saveProduct = function() {
        const formData = new FormData();
        formData.append('sku', document.getElementById('productSku').value);
        formData.append('name', document.getElementById('productName').value);
        formData.append('category_id', document.getElementById('productCategory').value);
        formData.append('unit_of_measure', document.getElementById('productUnit').value);
        formData.append('current_stock', document.getElementById('productStock').value);
        formData.append('min_stock_level', document.getElementById('productMinStock').value);
        formData.append('reorder_point', document.getElementById('productReorderLevel').value);
        formData.append('cost_price', document.getElementById('productCostPrice').value);
        formData.append('selling_price', document.getElementById('productSellingPrice').value);
        formData.append('location', document.getElementById('productLocation').value);
        formData.append('barcode', document.getElementById('productBarcode').value);
        formData.append('description', document.getElementById('productDescription').value);

        const url = editingProductId ? 
            `/inventory/products/${editingProductId}/edit` : 
            '/inventory/products/add';

        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.showToast(data.message, 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                modal.hide();
                loadProducts();
            } else {
                window.showToast(data.error || 'Error saving product', 'error');
            }
        })
        .catch(error => {
            console.error('Error saving product:', error);
            window.showToast('Error saving product', 'error');
        });
    };

    window.deleteProduct = function(productId) {
        if (!confirm('Are you sure you want to delete this product?')) return;
        
        fetch(`/api/inventory/products/${productId}/delete`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.showToast(data.message, 'success');
                loadProducts();
            } else {
                window.showToast(data.error || 'Error deleting product', 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting product:', error);
            window.showToast('Error deleting product', 'error');
        });
    };

    window.clearFilters = function() {
        document.getElementById('productSearch').value = '';
        document.getElementById('categoryFilter').value = '';
        document.getElementById('statusFilter').value = '';
        renderProducts();
    };

    // Event listeners
    document.getElementById('productSearch').addEventListener('input', renderProducts);
    document.getElementById('categoryFilter').addEventListener('change', renderProducts);
    document.getElementById('statusFilter').addEventListener('change', renderProducts);

    // Initialize
    loadCategories();
    loadProducts();
})();
</script>
