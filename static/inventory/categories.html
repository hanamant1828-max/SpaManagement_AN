<div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="fas fa-tags me-2"></i>Categories</h3>
        <button id="btnAddCategory" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Add Category
        </button>
    </div>

    <!-- Categories Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Color</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Products Count</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">Add Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    <div class="mb-3">
                        <label class="form-label">Category Name *</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <div class="d-flex align-items-center">
                            <input type="color" class="form-control form-control-color me-2" id="categoryColor" value="#6f42c1">
                            <input type="text" class="form-control" id="categoryColorText" value="#6f42c1" style="max-width: 100px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="categoryActive" checked>
                            <label class="form-check-label" for="categoryActive">
                                Active
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">Save Category</button>
            </div>
        </div>
    </div>
</div>

<!-- View Category Modal -->
<div class="modal fade" id="viewCategoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Category Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12 mb-3">
                        <label class="form-label"><strong>Category Name</strong></label>
                        <p id="viewCategoryName" class="form-control-plaintext border rounded p-2 bg-light"></p>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label"><strong>Description</strong></label>
                        <p id="viewCategoryDescription" class="form-control-plaintext border rounded p-2 bg-light" style="min-height: 80px;"></p>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label"><strong>Color</strong></label>
                        <div class="d-flex align-items-center">
                            <span id="viewCategoryColorBadge" class="badge rounded-pill me-2" style="width: 30px; height: 30px;">&nbsp;</span>
                            <span id="viewCategoryColorCode" class="text-muted"></span>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label"><strong>Status</strong></label>
                        <p id="viewCategoryStatus" class="form-control-plaintext border rounded p-2 bg-light"></p>
                    </div>
                    <div class="col-12 mb-3">
                        <label class="form-label"><strong>Products in Category</strong></label>
                        <p id="viewCategoryProductCount" class="form-control-plaintext border rounded p-2 bg-light"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // Isolated scope for categories tab
    let editingCategoryId = null;

    // Function to escape HTML special characters
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    // Fetch categories from the API
    async function loadCategories() {
        const tbody = document.getElementById('categoriesTableBody');
        tbody.innerHTML = ''; // Clear existing rows

        try {
            const response = await fetch('/api/inventory/categories'); // Fetch from API
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const categories = await response.json();

            // Fetch products to count them per category
            const productsResponse = await fetch('/api/products'); // Fetch from API
            if (!productsResponse.ok) {
                throw new Error(`HTTP error! status: ${productsResponse.status}`);
            }
            const products = await productsResponse.json();

            // Handle both array and object responses
            const categoriesArray = Array.isArray(categories) ? categories : (categories.categories || []);

            categoriesArray.forEach(category => {
                // This part is now handled by the backend in the API response itself
                // const productCount = products.filter(p => p.categoryId === category.id).length;

                const statusBadge = category.is_active ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-secondary">Inactive</span>';

                let categoriesHTML = `
                        <tr>
                            <td>
                                <div style="width: 30px; height: 30px; background-color: ${escapeHtml(category.color_code)}; border-radius: 4px; display: inline-block;"></div>
                            </td>
                            <td><strong>${escapeHtml(category.name)}</strong></td>
                            <td>${escapeHtml(category.description || '')}</td>
                            <td>${category.product_count || 0} products</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewCategory('${category.id}')" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" onclick="editCategory('${category.id}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="deleteCategory('${category.id}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                tbody.innerHTML += categoriesHTML;
            });

            if (categoriesArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No categories found</td></tr>';
            }
        } catch (error) {
            console.error('Error loading categories:', error);
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load categories</td></tr>';
        }
    }

    function addCategory() {
        editingCategoryId = null;
        document.getElementById('categoryModalTitle').textContent = 'Add Category';
        document.getElementById('categoryForm').reset();
        document.getElementById('categoryId').value = '';
        document.getElementById('categoryColor').value = '#6f42c1';
        document.getElementById('categoryColorText').value = '#6f42c1';
        document.getElementById('categoryActive').checked = true;
        const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
        modal.show();
    }

    // View category function
    window.viewCategory = async function(categoryId) {
        try {
            // Fetch category data from API
            const response = await fetch(`/api/inventory/categories/${categoryId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const category = await response.json();

            // Fetch products to count them for this category
            const productsResponse = await fetch('/api/inventory/products');
            if (!productsResponse.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const products = await productsResponse.json();
            const productCount = products.filter(p => p.category_id === categoryId).length;

            // Populate view modal with data
            document.getElementById('viewCategoryName').textContent = category.name || '-';
            document.getElementById('viewCategoryDescription').textContent = category.description || 'No description available';
            document.getElementById('viewCategoryColorBadge').style.backgroundColor = category.color_code || '#6c757d';
            document.getElementById('viewCategoryColorCode').textContent = category.color_code || '#6c757d';
            document.getElementById('viewCategoryStatus').innerHTML = `<span class="badge bg-${category.is_active ? 'success' : 'secondary'}">${category.is_active ? 'Active' : 'Inactive'}</span>`;
            document.getElementById('viewCategoryProductCount').textContent = `${productCount} products assigned to this category`;

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('viewCategoryModal'));
            modal.show();
        } catch (error) {
            console.error('Error loading category details:', error);
            alert('Error loading category details. Please try again.');
        }
    }

    window.editCategory = async function(categoryId) {
        try {
            const response = await fetch(`/api/inventory/categories/${categoryId}`); // Fetch from API
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const category = await response.json();

            editingCategoryId = categoryId;
            document.getElementById('categoryModalTitle').textContent = 'Edit Category';
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryDescription').value = category.description || '';
            document.getElementById('categoryColor').value = category.color_code;
            document.getElementById('categoryColorText').value = category.color_code;
            document.getElementById('categoryActive').checked = category.is_active !== false;

            const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            modal.show();
        } catch (error) {
            console.error('Error fetching category:', error);
            alert('Failed to load category data.');
        }
    }

    window.saveCategory = async function() {
        const categoryId = document.getElementById('categoryId').value;
        const categoryData = {
            name: document.getElementById('categoryName').value,
            description: document.getElementById('categoryDescription').value,
            color_code: document.getElementById('categoryColor').value,
            is_active: document.getElementById('categoryActive').checked,
        };

        try {
            const url = categoryId ? `/api/inventory/categories/${categoryId}` : '/api/inventory/categories';
            const method = categoryId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(categoryData),
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            const modal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
            modal.hide();
            loadCategories(); // Reload categories after saving
        } catch (error) {
            console.error('Error saving category:', error);
            alert('Failed to save category: ' + error.message);
        }
    }

    window.deleteCategory = async function(categoryId) {
        // Check for associated products before deleting
        try {
            const productsResponse = await fetch('/api/inventory/products');
            if (!productsResponse.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const products = await productsResponse.json();
            const productCount = products.filter(p => p.category_id === categoryId).length;

            if (productCount > 0) {
                alert('Cannot delete category with associated products. Please remove or reassign products first.');
                return;
            }

            if (confirm('Are you sure you want to delete this category?')) {
                const response = await fetch(`/api/inventory/categories/${categoryId}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                loadCategories(); // Reload categories after deleting
            }
        } catch (error) {
            console.error('Error deleting category:', error);
            alert('Failed to delete category: ' + error.message);
        }
    }

    // Color picker sync
    document.addEventListener('DOMContentLoaded', function() {
        const colorPicker = document.getElementById('categoryColor');
        const colorText = document.getElementById('categoryColorText');

        if (colorPicker && colorText) {
            colorPicker.addEventListener('input', function() {
                colorText.value = this.value;
            });

            colorText.addEventListener('input', function() {
                if (/^#[0-9A-F]{6}$/i.test(this.value)) {
                    colorPicker.value = this.value;
                }
            });
        }
    });

    // Event listeners
    document.getElementById('btnAddCategory').addEventListener('click', addCategory);

    // Initialize
    loadCategories(); // Load categories when the page loads
})();
</script>