<div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="fas fa-tags me-2"></i>Categories</h3>
        <button id="btnAddCategory" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Add Category
        </button>
    </div>

    <!-- Categories Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Color</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Products Count</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="categoriesTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Category Modal -->
<div class="modal fade" id="categoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="categoryModalTitle">Add Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="categoryForm">
                    <input type="hidden" id="categoryId">
                    <div class="mb-3">
                        <label class="form-label">Category Name *</label>
                        <input type="text" class="form-control" id="categoryName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <div class="d-flex align-items-center">
                            <input type="color" class="form-control form-control-color me-2" id="categoryColor" value="#6f42c1">
                            <input type="text" class="form-control" id="categoryColorText" value="#6f42c1" style="max-width: 100px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="categoryActive" checked>
                            <label class="form-check-label" for="categoryActive">
                                Active
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCategory()">Save Category</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // Isolated scope for categories tab
    let editingCategoryId = null;

    function loadCategories() {
        const categories = JSON.parse(localStorage.getItem('inventory.categories') || '[]');
        const products = JSON.parse(localStorage.getItem('inventory.products') || '[]');
        const tbody = document.getElementById('categoriesTableBody');
        
        tbody.innerHTML = '';
        categories.forEach(category => {
            const productCount = products.filter(p => p.categoryId === category.id).length;
            
            tbody.innerHTML += `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="badge rounded-pill me-2" 
                                  style="background-color: ${category.color}; width: 20px; height: 20px;">&nbsp;</span>
                            <small class="text-muted">${category.color}</small>
                        </div>
                    </td>
                    <td>
                        <div class="fw-medium">${category.name}</div>
                    </td>
                    <td>
                        <span class="text-muted">${category.description || 'No description'}</span>
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">${productCount} products</span>
                    </td>
                    <td>
                        <span class="badge bg-${category.isActive ? 'success' : 'secondary'}">
                            ${category.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editCategory('${category.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory('${category.id}')" title="Delete" 
                                ${productCount > 0 ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        if (categories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No categories found</td></tr>';
        }
    }

    function addCategory() {
        editingCategoryId = null;
        document.getElementById('categoryModalTitle').textContent = 'Add Category';
        document.getElementById('categoryForm').reset();
        document.getElementById('categoryId').value = '';
        document.getElementById('categoryColor').value = '#6f42c1';
        document.getElementById('categoryColorText').value = '#6f42c1';
        document.getElementById('categoryActive').checked = true;
        const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
        modal.show();
    }

    window.editCategory = function(categoryId) {
        const categories = JSON.parse(localStorage.getItem('inventory.categories') || '[]');
        const category = categories.find(c => c.id === categoryId);
        
        if (category) {
            editingCategoryId = categoryId;
            document.getElementById('categoryModalTitle').textContent = 'Edit Category';
            document.getElementById('categoryId').value = category.id;
            document.getElementById('categoryName').value = category.name;
            document.getElementById('categoryDescription').value = category.description || '';
            document.getElementById('categoryColor').value = category.color;
            document.getElementById('categoryColorText').value = category.color;
            document.getElementById('categoryActive').checked = category.isActive !== false;
            
            const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            modal.show();
        }
    }

    window.saveCategory = function() {
        const categories = JSON.parse(localStorage.getItem('inventory.categories') || '[]');
        
        const categoryData = {
            id: editingCategoryId || Date.now().toString(),
            name: document.getElementById('categoryName').value,
            description: document.getElementById('categoryDescription').value,
            color: document.getElementById('categoryColor').value,
            isActive: document.getElementById('categoryActive').checked,
            createdAt: editingCategoryId ? undefined : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        if (editingCategoryId) {
            const index = categories.findIndex(c => c.id === editingCategoryId);
            if (index !== -1) {
                categories[index] = { ...categories[index], ...categoryData };
            }
        } else {
            categories.push(categoryData);
        }
        
        localStorage.setItem('inventory.categories', JSON.stringify(categories));
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('categoryModal'));
        modal.hide();
        
        loadCategories();
    }

    window.deleteCategory = function(categoryId) {
        const products = JSON.parse(localStorage.getItem('inventory.products') || '[]');
        const productCount = products.filter(p => p.categoryId === categoryId).length;
        
        if (productCount > 0) {
            alert('Cannot delete category with associated products. Please remove or reassign products first.');
            return;
        }
        
        if (confirm('Are you sure you want to delete this category?')) {
            const categories = JSON.parse(localStorage.getItem('inventory.categories') || '[]');
            const filteredCategories = categories.filter(c => c.id !== categoryId);
            localStorage.setItem('inventory.categories', JSON.stringify(filteredCategories));
            loadCategories();
        }
    }

    // Color picker sync
    document.addEventListener('DOMContentLoaded', function() {
        const colorPicker = document.getElementById('categoryColor');
        const colorText = document.getElementById('categoryColorText');
        
        if (colorPicker && colorText) {
            colorPicker.addEventListener('input', function() {
                colorText.value = this.value;
            });
            
            colorText.addEventListener('input', function() {
                colorPicker.value = this.value;
            });
        }
    });

    // Event listeners
    document.getElementById('btnAddCategory').addEventListener('click', addCategory);

    // Initialize default categories if none exist
    function initializeDefaultCategories() {
        const categories = JSON.parse(localStorage.getItem('inventory.categories') || '[]');
        if (categories.length === 0) {
            const defaultCategories = [
                { id: 'cat1', name: 'Skincare Products', description: 'Facial and body care products', color: '#ff6b6b', isActive: true, createdAt: new Date().toISOString() },
                { id: 'cat2', name: 'Hair Care Products', description: 'Shampoos, conditioners, and styling products', color: '#4ecdc4', isActive: true, createdAt: new Date().toISOString() },
                { id: 'cat3', name: 'Spa Supplies', description: 'Towels, robes, and spa accessories', color: '#45b7d1', isActive: true, createdAt: new Date().toISOString() },
                { id: 'cat4', name: 'Wellness Products', description: 'Essential oils, aromatherapy products', color: '#f9ca24', isActive: true, createdAt: new Date().toISOString() }
            ];
            localStorage.setItem('inventory.categories', JSON.stringify(defaultCategories));
        }
    }

    // Initialize
    initializeDefaultCategories();
    loadCategories();
})();
</script>