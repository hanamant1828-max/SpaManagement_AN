
<div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="fas fa-map-marker-alt me-2"></i>Location Management</h3>
        <button id="btnAddLocation" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Add Location
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="locationSearch" placeholder="Search locations...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="branch">Branch</option>
                        <option value="warehouse">Warehouse</option>
                        <option value="room">Room</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" onclick="clearLocationFilters()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Locations Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="locationTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Address</th>
                            <th>Contact</th>
                            <th>Products Count</th>
                            <th>Total Stock Value</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="locationTableBody">
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                Loading locations...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Location Modal -->
<div class="modal fade" id="locationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="locationModalTitle">Add Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="locationForm">
                    <input type="hidden" id="locationId">
                    <div class="mb-3">
                        <label class="form-label">Location Name *</label>
                        <input type="text" class="form-control" id="locationName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type *</label>
                        <select class="form-select" id="locationType" required>
                            <option value="">Select Type</option>
                            <option value="branch">Branch</option>
                            <option value="warehouse">Warehouse</option>
                            <option value="room">Room/Section</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="locationAddress" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contact Person</label>
                        <input type="text" class="form-control" id="locationContact">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="locationPhone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status *</label>
                        <select class="form-select" id="locationStatus" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveLocation()">Save Location</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // Isolated scope for locations tab to prevent variable conflicts
    let editingLocationId = null;
    let locationsCache = [];

    function loadLocations() {
        const tbody = document.getElementById('locationTableBody');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div> Loading locations...</td></tr>';
        
        fetch('/api/inventory/locations')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                locationsCache = data.locations || [];
                displayLocations();
                console.log('Locations loaded from database:', locationsCache.length);
            })
            .catch(error => {
                console.error('Error loading locations from database:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Failed to load locations from database. Please check your network connection.</td></tr>';
                locationsCache = []; // Clear cache instead of using localStorage fallback
            });
    }

    function displayLocations() {
        const search = document.getElementById('locationSearch').value.toLowerCase();
        const typeFilter = document.getElementById('typeFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;

        let filteredLocations = locationsCache.filter(location => {
            const matchesSearch = (location.name.toLowerCase().includes(search) ||
                                (location.address && location.address.toLowerCase().includes(search)) ||
                                (location.contact_person && location.contact_person.toLowerCase().includes(search)));
            const matchesType = !typeFilter || location.type === typeFilter;
            const matchesStatus = !statusFilter || location.status === statusFilter;

            return matchesSearch && matchesType && matchesStatus;
        });

        const tbody = document.getElementById('locationTableBody');
        tbody.innerHTML = '';

        if (filteredLocations.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No locations found</td></tr>';
            return;
        }

        filteredLocations.forEach(location => {
            const statusBadge = location.status === 'active'
                ? '<span class="badge bg-success">Active</span>'
                : '<span class="badge bg-secondary">Inactive</span>';

            const typeBadge = getTypeBadge(location.type);
            const contactInfo = location.contact_person || location.phone ? 
                `${location.contact_person || 'N/A'}<br><small class="text-muted">${location.phone || ''}</small>` : 
                '-';

            tbody.innerHTML += `
                <tr>
                    <td><strong>${location.name}</strong></td>
                    <td>${typeBadge}</td>
                    <td>${location.address || '-'}</td>
                    <td>${contactInfo}</td>
                    <td><span class="badge bg-info">${location.total_products || 0}</span></td>
                    <td>$${(location.total_stock_value || 0).toFixed(2)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editLocation('${location.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteLocation('${location.id}', '${location.name}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    function getTypeBadge(type) {
        const badges = {
            'branch': '<span class="badge bg-primary">Branch</span>',
            'warehouse': '<span class="badge bg-info">Warehouse</span>',
            'room': '<span class="badge bg-secondary">Room</span>'
        };
        return badges[type] || '<span class="badge bg-light text-dark">Unknown</span>';
    }

    function showLocationModal(isEdit = false, locationData = null) {
        editingLocationId = locationData ? locationData.id : null;
        document.getElementById('locationModalTitle').textContent = isEdit ? 'Edit Location' : 'Add Location';
        
        // Reset form
        document.getElementById('locationForm').reset();
        document.getElementById('locationId').value = editingLocationId || '';
        
        if (locationData) {
            document.getElementById('locationName').value = locationData.name || '';
            document.getElementById('locationType').value = locationData.type || '';
            document.getElementById('locationAddress').value = locationData.address || '';
            document.getElementById('locationContact').value = locationData.contact_person || '';
            document.getElementById('locationPhone').value = locationData.phone || '';
            document.getElementById('locationStatus').value = locationData.status || 'active';
        } else {
            document.getElementById('locationStatus').value = 'active';
        }

        const modal = new bootstrap.Modal(document.getElementById('locationModal'));
        modal.show();
    }

    // Global functions
    window.editLocation = function(locationId) {
        // First try from cache
        let location = locationsCache.find(loc => loc.id === locationId);
        
        if (location) {
            showLocationModal(true, location);
        } else {
            // Fetch from API if not in cache
            fetch(`/api/inventory/locations/${locationId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    showLocationModal(true, data);
                })
                .catch(error => {
                    console.error('Error loading location:', error);
                    showToast(`Error loading location: ${error.message}`, 'error');
                });
        }
    }

    window.saveLocation = function() {
        const form = document.getElementById('locationForm');
        
        // Basic form validation
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const locationData = {
            name: document.getElementById('locationName').value.trim(),
            type: document.getElementById('locationType').value.trim(),
            address: document.getElementById('locationAddress').value.trim(),
            contact_person: document.getElementById('locationContact').value.trim(),
            phone: document.getElementById('locationPhone').value.trim(),
            status: document.getElementById('locationStatus').value
        };

        // Additional validation
        if (!locationData.name || !locationData.type) {
            showToast('Location Name and Type are required.', 'error');
            return;
        }

        const url = editingLocationId ? `/api/inventory/locations/${editingLocationId}` : '/api/inventory/locations';
        const method = editingLocationId ? 'PUT' : 'POST';

        // Disable save button during request
        const saveBtn = document.querySelector('#locationModal .btn-primary');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(locationData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('locationModal'));
                modal.hide();
                loadLocations(); // Reload to get fresh data
                showToast(data.message, 'success');
            } else {
                showToast(data.error || 'Failed to save location. Please check your input.', 'error');
            }
        })
        .catch(error => {
            console.error('Error saving location:', error);
            showToast('Error saving location. Please try again.', 'error');
        })
        .finally(() => {
            // Re-enable save button
            saveBtn.disabled = false;
            saveBtn.textContent = originalText;
        });
    }

    window.deleteLocation = function(locationId, locationName) {
        if (!confirm(`Are you sure you want to delete location "${locationName}"?\n\nThis action cannot be undone.`)) {
            return;
        }

        fetch(`/api/inventory/locations/${locationId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok || response.status === 204) {
                return { success: true, message: `Location "${locationName}" deleted successfully!` };
            }
            return response.json().then(data => {
                if (data && data.error) {
                    throw new Error(data.error);
                }
                throw new Error('Unknown error deleting location.');
            });
        })
        .then(data => {
            if (data.success) {
                loadLocations(); // Reload the list
                showToast(data.message, 'success');
            }
        })
        .catch(error => {
            console.error('Error deleting location:', error);
            showToast(`Error deleting location: ${error.message}`, 'error');
        });
    }

    window.clearLocationFilters = function() {
        document.getElementById('locationSearch').value = '';
        document.getElementById('typeFilter').value = '';
        document.getElementById('statusFilter').value = '';
        displayLocations(); // Just filter the cached data
    }

    function showToast(message, type = 'success') {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '1055';
            document.body.appendChild(toastContainer);
        }

        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';

        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
        toast.show();

        // Remove toast element after it's hidden
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }

    // Initialize event listeners immediately
    function initializeLocationHandlers() {
        // Add location button
        const addBtn = document.getElementById('btnAddLocation');
        if (addBtn) {
            addBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Add location button clicked');
                showLocationModal(false);
            });
        }

        // Filter event listeners
        const searchInput = document.getElementById('locationSearch');
        const typeFilter = document.getElementById('typeFilter');
        const statusFilter = document.getElementById('statusFilter');

        if (searchInput) searchInput.addEventListener('input', displayLocations);
        if (typeFilter) typeFilter.addEventListener('change', displayLocations);
        if (statusFilter) statusFilter.addEventListener('change', displayLocations);
    }

    // Initialize when content is loaded
    setTimeout(() => {
        initializeLocationHandlers();
        loadLocations();
    }, 100);

})();
</script>
