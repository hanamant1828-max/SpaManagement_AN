<div>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3><i class="fas fa-map-marker-alt me-2"></i>Location Management</h3>
        <button id="btnAddLocation" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Add Location
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="locationSearch" placeholder="Search locations...">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="typeFilter">
                        <option value="">All Types</option>
                        <option value="branch">Branch</option>
                        <option value="warehouse">Warehouse</option>
                        <option value="room">Room</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-secondary w-100" onclick="clearLocationFilters()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Locations Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="locationTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Address</th>
                            <th>Products Count</th>
                            <th>Total Stock Value</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="locationTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Location Modal -->
<div class="modal fade" id="locationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="locationModalTitle">Add Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="locationForm">
                    <input type="hidden" id="locationId">
                    <div class="mb-3">
                        <label class="form-label">Location Name *</label>
                        <input type="text" class="form-control" id="locationName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type *</label>
                        <select class="form-select" id="locationType" required>
                            <option value="">Select Type</option>
                            <option value="branch">Branch</option>
                            <option value="warehouse">Warehouse</option>
                            <option value="room">Room/Section</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="locationAddress" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Contact Person</label>
                        <input type="text" class="form-control" id="locationContact">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="locationPhone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status *</label>
                        <select class="form-select" id="locationStatus" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveLocation()">Save Location</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    // Isolated scope for locations tab
    let editingLocationId = null;

    function loadLocations() {
        fetch('/api/inventory/locations')
            .then(response => response.json())
            .then(data => {
                const locations = data.locations || [];
                const products = JSON.parse(localStorage.getItem('inventory.products') || '[]');
                const search = document.getElementById('locationSearch').value.toLowerCase();
                const typeFilter = document.getElementById('typeFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;

                let filteredLocations = locations.filter(location => {
                    const matchesSearch = (location.name.toLowerCase().includes(search) ||
                                        (location.address && location.address.toLowerCase().includes(search)));
                    const matchesType = !typeFilter || location.type === typeFilter;
                    const matchesStatus = !statusFilter || location.status === statusFilter;

                    return matchesSearch && matchesType && matchesStatus;
                });

                const tbody = document.getElementById('locationTableBody');
                tbody.innerHTML = '';

                if (filteredLocations.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No locations found</td></tr>';
                    return;
                }

                filteredLocations.forEach(location => {
                    // Calculate product count and total value for this location
                    const locationProducts = products.filter(p => p.locationStock && p.locationStock[location.id]);
                    const productCount = locationProducts.length;
                    let totalValue = 0;

                    locationProducts.forEach(product => {
                        const stock = product.locationStock[location.id] || 0;
                        totalValue += stock * (product.costPrice || 0);
                    });

                    const statusBadge = location.status === 'active'
                        ? '<span class="badge bg-success">Active</span>'
                        : '<span class="badge bg-secondary">Inactive</span>';

                    const typeBadge = getTypeBadge(location.type);

                    tbody.innerHTML += `
                        <tr>
                            <td><strong>${location.name}</strong></td>
                            <td>${typeBadge}</td>
                            <td>${location.address || '-'}</td>
                            <td>${productCount} products</td>
                            <td>$${totalValue.toFixed(2)}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editLocation('${location.id}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteLocation('${location.id}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            })
            .catch(error => {
                console.error('Error loading locations:', error);
                const tbody = document.getElementById('locationTableBody');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Failed to load locations</td></tr>';
            });
    }

    function getTypeBadge(type) {
        const badges = {
            'branch': '<span class="badge bg-primary">Branch</span>',
            'warehouse': '<span class="badge bg-info">Warehouse</span>',
            'room': '<span class="badge bg-secondary">Room</span>'
        };
        return badges[type] || '<span class="badge bg-light text-dark">Unknown</span>';
    }

    function initializeDefaultLocations() {
        // This function might be used to seed data if the API doesn't return anything initially
        // For now, we rely on the backend to manage initial data.
    }

    // Add event listener for add location button
    document.getElementById('btnAddLocation').addEventListener('click', function() {
        editingLocationId = null;
        document.getElementById('locationModalTitle').textContent = 'Add Location';
        document.getElementById('locationForm').reset();
        document.getElementById('locationStatus').value = 'active'; // Default to active

        const modal = new bootstrap.Modal(document.getElementById('locationModal'));
        modal.show();
    });

    window.editLocation = function(locationId) {
        fetch(`/api/inventory/locations/${locationId}`)
            .then(response => response.json())
            .then(location => {
                if (location.error) {
                    throw new Error(location.error);
                }

                editingLocationId = locationId;
                document.getElementById('locationModalTitle').textContent = 'Edit Location';
                document.getElementById('locationName').value = location.name;
                document.getElementById('locationType').value = location.type;
                document.getElementById('locationAddress').value = location.address || '';
                document.getElementById('locationContact').value = location.contact_person || '';
                document.getElementById('locationPhone').value = location.phone || '';
                document.getElementById('locationStatus').value = location.status;

                const modal = new bootstrap.Modal(document.getElementById('locationModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error loading location:', error);
                showToast(`Error loading location: ${error.message}`, 'error');
            });
    }

    window.saveLocation = function() {
        const locationId = editingLocationId;
        const locationData = {
            name: document.getElementById('locationName').value.trim(),
            type: document.getElementById('locationType').value.trim(),
            address: document.getElementById('locationAddress').value.trim(),
            contact_person: document.getElementById('locationContact').value.trim(),
            phone: document.getElementById('locationPhone').value.trim(),
            status: document.getElementById('locationStatus').value
        };

        // Basic Validation
        if (!locationData.name || !locationData.type) {
            alert('Location Name and Type are required.');
            return;
        }

        const url = locationId ? `/api/inventory/locations/${locationId}` : '/api/inventory/locations';
        const method = locationId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(locationData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('locationModal'));
                modal.hide();
                loadLocations();
                showToast(data.message, 'success');
            } else {
                alert(data.error || 'Failed to save location. Please check your input.');
            }
        })
        .catch(error => {
            console.error('Error saving location:', error);
            showToast('Error saving location. Please try again.', 'error');
        });
    }ontent-Type': 'application/json',
            },
            body: JSON.stringify(locationData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('locationModal'));
                modal.hide();
                loadLocations();
                showToast(data.message, 'success');
            } else {
                alert(data.error || 'Failed to save location. Please check your input.');
            }
        })
        .catch(error => {
            console.error('Error saving location:', error);
            showToast('Error saving location. Please try again.', 'error');
        });
    }

    window.deleteLocation = function(locationId) {
        if (confirm('Are you sure you want to delete this location?')) {
            fetch(`/api/inventory/locations/${locationId}`, {
                method: 'DELETE'
            })
            .then(response => {
                // Check if the response is OK. If it's a 204 No Content, it's successful deletion without returning JSON.
                if (response.ok || response.status === 204) {
                    return { success: true, message: 'Location deleted successfully!' };
                }
                // If not OK, try to parse JSON for error message
                return response.json().then(data => {
                    if (data && data.error) {
                        throw new Error(data.error);
                    }
                    throw new Error('Unknown error deleting location.');
                });
            })
            .then(data => {
                if (data.success) {
                    loadLocations();
                    showToast(data.message, 'success');
                } else {
                    // This path might not be reached if an error is thrown above, but as a fallback:
                    alert(data.message || 'Error deleting location');
                }
            })
            .catch(error => {
                console.error('Error deleting location:', error);
                alert(`Error deleting location: ${error.message}`);
                showToast(`Error deleting location: ${error.message}`, 'error');
            });
        }
    }

    window.clearLocationFilters = function() {
        document.getElementById('locationSearch').value = '';
        document.getElementById('typeFilter').value = '';
        document.getElementById('statusFilter').value = '';
        loadLocations();
    }

    function showToast(message, type = 'success') {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
            toastContainer.style.zIndex = '1055'; // Ensure toast is above modals
            document.body.appendChild(toastContainer);
        }

        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';

        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();

        // Remove toast element after it's hidden
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }

    // Initialize event listeners
    document.getElementById('btnAddLocation').addEventListener('click', function() {
        editingLocationId = null;
        document.getElementById('locationId').value = ''; // Clear hidden ID for new location
        document.getElementById('locationModalTitle').textContent = 'Add Location';
        document.getElementById('locationForm').reset();
        document.getElementById('locationStatus').value = 'active'; // Set default status
        const modal = new bootstrap.Modal(document.getElementById('locationModal'));
        modal.show();
    });

    document.getElementById('locationSearch').addEventListener('input', loadLocations);
    document.getElementById('typeFilter').addEventListener('change', loadLocations);
    document.getElementById('statusFilter').addEventListener('change', loadLocations);

    // Initial load of locations
    loadLocations();
})();
</script>